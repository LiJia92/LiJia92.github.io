{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":1,"renderable":0},{"_id":"source/README.md","path":"README.md","modified":1,"renderable":0},{"_id":"themes/yilia/source/avatar.jpg","path":"avatar.jpg","modified":1,"renderable":1},{"_id":"themes/yilia/source/favicon.png","path":"favicon.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/main.js","path":"main.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/style.js","path":"style.js","modified":1,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"9cc253b4f578318faf08326e4d2d3599e0afc2dc","modified":1460011639847},{"_id":"source/README.md","hash":"4589189904eb6a17c983afbd919ad4dcc8c1cb7f","modified":1459159710774},{"_id":"themes/yilia/.editorconfig","hash":"daaa8757fac18f8735fadd0a37a42c06f421ca14","modified":1474885648208},{"_id":"themes/yilia/.gitignore","hash":"d5fc575329853ff620b50fc62ad4b18fa09a308a","modified":1474885648208},{"_id":"themes/yilia/README.md","hash":"dd311f8e8696bd89cf1790328d12b49d0e6b36da","modified":1474885648208},{"_id":"themes/yilia/_config.yml","hash":"d5d0a17b427c81beb54ed49d4e33747930d962c6","modified":1479460556296},{"_id":"themes/yilia/package.json","hash":"f9f700b5cee8fa7d0571a41a8e0c6166ba78c377","modified":1474885648224},{"_id":"themes/yilia/webpack.config.js","hash":"924bbc926e4b36b945362cc5c5e77308b52f922c","modified":1474885648255},{"_id":"source/_posts/OS-X.md","hash":"9e1268bd6634c6ac0252359c0f5087671daf967a","modified":1480326926151},{"_id":"source/_posts/about-screen.md","hash":"f861da84cbd69daa7f0ec89c3ce7cf809874c005","modified":1479722426433},{"_id":"source/_posts/alarm.md","hash":"5aa4f85ef4e02d95a3f90957dabd5ed46b0d73cc","modified":1479722429021},{"_id":"source/_posts/alipay.md","hash":"3e404bdf3525510409b47875124f6f8e685c66cb","modified":1479722208698},{"_id":"source/_posts/android-adapter.md","hash":"fde9b1df29fb6d18dfaa311457fd6b231f5bf13a","modified":1479722211745},{"_id":"source/_posts/android-scroll.md","hash":"805a9eb4756501b6d4c2baa88231e632a6051475","modified":1479722214808},{"_id":"source/_posts/blog-move.md","hash":"b0cc00da7ab9229851b11f980ba27f0b2be7e344","modified":1479722221929},{"_id":"source/_posts/baidu-loc.md","hash":"e1d06362bc367ca01dccc69e7d809e561a3547d0","modified":1479722218225},{"_id":"source/_posts/blur.md","hash":"6acdf2c43bebeee629e89be30c2a2aba4c9878a1","modified":1479722443099},{"_id":"source/_posts/change-title.md","hash":"dbd4ce49bbd8a3de18fe9906a4384aaa5ffaa4db","modified":1479722229751},{"_id":"source/_posts/cross-platform.md","hash":"5b1bbd57e1ed5593f8c8c9c366c6612ae8248a12","modified":1479722446907},{"_id":"source/_posts/custom-attr.md","hash":"b6848424ea2f655675bf812e443ef9b01274c4c7","modified":1479722346901},{"_id":"source/_posts/ddms-logcat.md","hash":"eeef72d44d9c9b4654fb67f2dd22e9f31cdc95fe","modified":1479722353127},{"_id":"source/_posts/dashboard.md","hash":"c023b3697e55848782967639dc73369176f01358","modified":1479722350023},{"_id":"source/_posts/domain.md","hash":"ed9c80478e4b3ca15beb2a16afbcdf7a4809e319","modified":1479722358720},{"_id":"source/_posts/gradle-pack.md","hash":"1de550393049f3d93d63b5078d3153402a413705","modified":1479722365965},{"_id":"source/_posts/genymotion.md","hash":"b0b3b25ab0b1afea690557a9a60b6dd21b2aaa47","modified":1479722362702},{"_id":"source/_posts/hexo-blog.md","hash":"74f8098105558af323893d6661d7bcadc9a5f9d1","modified":1479722369271},{"_id":"source/_posts/hexo-tips.md","hash":"4f00d075db19aa842b83f436542a8019281eb7d8","modified":1479722372863},{"_id":"source/_posts/hexo-tools.md","hash":"20f036afe40cbfe777eef30477cd5ad3f36fe7dd","modified":1479722376665},{"_id":"source/_posts/hybrid-introduction.md","hash":"7e7d5ed644f7103cc443884d5148022d5cfc7756","modified":1479722461373},{"_id":"source/_posts/hybrid-practice.md","hash":"e1e4f1d95660898e66e808713e2fb262de649fff","modified":1479722401880},{"_id":"source/_posts/ios.md","hash":"8d657fdb764d60df8c607c072550ab665b6659a9","modified":1479804204130},{"_id":"source/_posts/jcenter.md","hash":"a7d4c969bc00af3c906048b4662435da9d40b0ef","modified":1479722486097},{"_id":"source/_posts/jpush.md","hash":"4921908f0054a07b8c6fb33da6ea2352867bb831","modified":1479722417154},{"_id":"source/_posts/live-audio.md","hash":"ae17d5fe3ac9ad1642c2516a39889569c916e450","modified":1479722424238},{"_id":"source/_posts/live-capture-video.md","hash":"e4c52bdfff7923a6ebad182c9246e88104836341","modified":1479722494329},{"_id":"source/_posts/live-code-video.md","hash":"e750533bf35ccd0598da13da7aee2ef4b27cd2ff","modified":1479722498574},{"_id":"source/_posts/live.md","hash":"3d0471881284e2b895793fface2367753d3deceb","modified":1480322387298},{"_id":"source/_posts/make-wheel.md","hash":"160398e795b65366a1eeeb76137518905f918855","modified":1479722510288},{"_id":"source/_posts/material-design.md","hash":"51c8f01e6e75782db92bc3aec1cc7e7238975f15","modified":1479722514257},{"_id":"source/_posts/mvp.md","hash":"f32b924c58ea987a6e56cc8f9fcb7538380fdf1c","modified":1479722519894},{"_id":"source/_posts/new-seekbar.md","hash":"56d7ef5b3fe328db442100dd204f0a24878db049","modified":1479722523995},{"_id":"source/_posts/nine-patch.md","hash":"c8c9b66d3dd8be5372d779991532d14fcc9183aa","modified":1479722528900},{"_id":"source/_posts/notification.md","hash":"ecf630ead6b8f56770df40654ac9e6b0dd540ad6","modified":1479722533972},{"_id":"source/_posts/photo-wall.md","hash":"8bf2eb663eee03b50c5c58ee2be4d3ca6e1ee2e9","modified":1479722537917},{"_id":"source/_posts/picture-view.md","hash":"ed7272892570b155bbdb4361ca5bd56bb089333c","modified":1479722541704},{"_id":"source/_posts/react-native-tips.md","hash":"b90f1eec4745dfa8f94ae64f2fce63437806a91b","modified":1479722558256},{"_id":"source/_posts/popupwindow.md","hash":"e417f9e2b00d2e14ae75423bbcfe3cbbb8c4736d","modified":1479722547476},{"_id":"source/_posts/react-native.md","hash":"482170915b0345a55e2d41081f6a4dacfb87b3a5","modified":1479722561588},{"_id":"source/_posts/reflect-interface.md","hash":"8f5cdf3d02375a99617e254ce6717dbb139ad673","modified":1479722565020},{"_id":"source/_posts/refresh-listview.md","hash":"5f0525b977b870ca8abfdafcc431b9ed24c3028c","modified":1479722568543},{"_id":"source/_posts/seekbar.md","hash":"b42b07c6f92e7941780adb90742447de965e28f9","modified":1479722575908},{"_id":"source/_posts/retrofit.md","hash":"73bd6fa3278f795ed1d626f07e4545e1d8a93abb","modified":1479722572349},{"_id":"source/_posts/single-thread-queue.md","hash":"7e917e3403b7077dbafb939fb25b98a8df5efc02","modified":1479722580117},{"_id":"source/_posts/socket.md","hash":"1c2aa67eebf6c2b4774687e85e57c8efe22b5af2","modified":1479722602225},{"_id":"source/_posts/statusbar.md","hash":"51d18356af72eaf6ab0e0fd3676c5595a8de7e18","modified":1479722606623},{"_id":"source/_posts/system-ui.md","hash":"3e229e10315536a68a76cebdecf0fcb09d52f678","modified":1479722616225},{"_id":"source/_posts/swipe-listview.md","hash":"5973d5eaa79ea0ad9a8f4b039e477bfe3c595106","modified":1479722610785},{"_id":"source/_posts/task-queue.md","hash":"e73b4e6d2a95808f76634f4e1e7bb6ef28520674","modified":1479722621202},{"_id":"source/_posts/textview.md","hash":"4b6e19b55f62d7026fcbe26af3a8346c70148d66","modified":1479722625102},{"_id":"source/_posts/touch-event.md","hash":"d2af63eade7fcab75542610540ae83cd17ce26d4","modified":1479722628677},{"_id":"source/_posts/touchevent.md","hash":"bd126d0d160381e40e80ba44d86bb01983eb21ff","modified":1479722633303},{"_id":"source/_posts/video-view.md","hash":"deb04b8fbe8b1f8c6031818f745f944c82050ccc","modified":1479722638079},{"_id":"source/_posts/wechat-sdk.md","hash":"2362b6340c870cf82ac6fadfee29a2e275fea2ae","modified":1479722642702},{"_id":"source/categories/index.md","hash":"05529cf806233bf998958f29fa84f6839d8cdd1c","modified":1458177544615},{"_id":"source/tags/index.md","hash":"a1249149ce542e4054b0a671a5846394ea3ba1a4","modified":1458177687474},{"_id":"source/something/index.md","hash":"b0bb238bef1b4eddfa8df7cff403e64324ee4ec6","modified":1480055317516},{"_id":"themes/yilia/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1474885648193},{"_id":"themes/yilia/.git/config","hash":"24300cece9d72967ea63724bdb2a8e3c2ac2cc52","modified":1474885648193},{"_id":"themes/yilia/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1474885558096},{"_id":"themes/yilia/.git/index","hash":"73d6684ec2cb822872f1c7a1d9688e4b5b6d88c7","modified":1474885648255},{"_id":"themes/yilia/.git/packed-refs","hash":"da91538826ece2ebda53cb5a4a634ce558cc28c1","modified":1474885648193},{"_id":"themes/yilia/languages/default.yml","hash":"f26a34a7983d4bc17c65c7f0f14da598e62ce66d","modified":1474885648208},{"_id":"themes/yilia/languages/fr.yml","hash":"b4be1c1592a72012e48df2b3ec41cc9685573e50","modified":1474885648208},{"_id":"themes/yilia/languages/nl.yml","hash":"3d82ec703d0b3287739d7cb4750a715ae83bfcb3","modified":1474885648208},{"_id":"themes/yilia/languages/no.yml","hash":"ddf2035e920a5ecb9076138c184257d9f51896a7","modified":1474885648208},{"_id":"themes/yilia/languages/ru.yml","hash":"2a476b4c6e04900914c81378941640ac5d58a1f0","modified":1474885648208},{"_id":"themes/yilia/languages/zh-CN.yml","hash":"b057f389c6713010f97d461e48ec959b0b6f3b44","modified":1474885648208},{"_id":"themes/yilia/languages/zh-tw.yml","hash":"f5f0ca88185da7a8457760d84bf221781473bd7c","modified":1474885648208},{"_id":"themes/yilia/layout/archive.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1474885648224},{"_id":"themes/yilia/layout/category.ejs","hash":"765426a9c8236828dc34759e604cc2c52292835a","modified":1474885648224},{"_id":"themes/yilia/layout/index.ejs","hash":"ec498c6c0606acde997ce195dad97b267418d980","modified":1474885648224},{"_id":"themes/yilia/layout/layout.ejs","hash":"6759bdc3646d6c03f9dbc7abffcb2b5e4522c724","modified":1474885648224},{"_id":"themes/yilia/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1474885648224},{"_id":"themes/yilia/layout/post.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1474885648224},{"_id":"themes/yilia/layout/tag.ejs","hash":"eaa7b4ccb2ca7befb90142e4e68995fb1ea68b2e","modified":1474885648224},{"_id":"themes/yilia/source/avatar.jpg","hash":"c89e75d4f75f2f5aa7dd7ceccf4998fa8afe6624","modified":1479458782384},{"_id":"themes/yilia/source/favicon.png","hash":"3427752b6a8a8fe2ea37783a11cbeb68d69986ef","modified":1479458953724},{"_id":"themes/yilia/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1474885558106},{"_id":"themes/yilia/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1474885558128},{"_id":"themes/yilia/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1474885558128},{"_id":"themes/yilia/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1474885558129},{"_id":"themes/yilia/.git/hooks/pre-commit.sample","hash":"36aed8976dcc08b5076844f0ec645b18bc37758f","modified":1474885558129},{"_id":"themes/yilia/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1474885558130},{"_id":"themes/yilia/.git/hooks/pre-rebase.sample","hash":"5885a56ab4fca8075a05a562d005e922cde9853b","modified":1474885558135},{"_id":"themes/yilia/.git/hooks/prepare-commit-msg.sample","hash":"2b6275eda365cad50d167fe3a387c9bc9fedd54f","modified":1474885558136},{"_id":"themes/yilia/.git/hooks/update.sample","hash":"39355a075977d05708ef74e1b66d09a36e486df1","modified":1474885558136},{"_id":"themes/yilia/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1474885558137},{"_id":"themes/yilia/.git/logs/HEAD","hash":"354340164ffe775c8ec30f7b6bf0e3fc54e3204d","modified":1474885648193},{"_id":"themes/yilia/layout/_partial/after-footer.ejs","hash":"525846ee5afc53b424b6c3466c8eec5febadd7bc","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/archive-post.ejs","hash":"edc0154b30a4127acda10297bec6aacf754b4ac4","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/archive.ejs","hash":"a4eacc2bc1278095a0ef99f904b0634c78f980eb","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/article.ejs","hash":"bc052b949fe04c8e90d49c3dd50f700cb31c9b47","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/footer.ejs","hash":"871f81cacd5d41cb2eb001cd56254217a857dc2f","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/google-analytics.ejs","hash":"1ccc627d7697e68fddc367c73ac09920457e5b35","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/head.ejs","hash":"ce1d2ca17e05c67cc0cb8c07cf05e6f8236a3e31","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/header.ejs","hash":"63d53c26f6ef7d2b4d96de3a2d3d7bd385f8dfda","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/left-col.ejs","hash":"5b4597ddf03486fc15fd6ae77fd05582cbfdff13","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/mathjax.ejs","hash":"11550a418921d330e6553be0569a94ab5a217967","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/mobile-nav.ejs","hash":"5f040ce3efed03adc5a0725187522bca800460f4","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/tools.ejs","hash":"fe0fd2f17b14d3fedfef43b6acadead38183b2a2","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/viewer.ejs","hash":"0b4af12ecd49e8009ad5eeb60e2da2bf57f5c67f","modified":1474885648208},{"_id":"themes/yilia/source/main.js","hash":"3c8e9775059dce1540dca30ba5df4271e4bb76a3","modified":1474885648255},{"_id":"themes/yilia/source/style.js","hash":"d29770217643f35a764b219ba9bf7aef77c0d53c","modified":1474885648255},{"_id":"themes/yilia/source-src/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/jquery.fancybox.js","hash":"2c62901b59f10e90f432ee34926c90c9d3ded983","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/jquery.fancybox.pack.js","hash":"2da892a02778236b64076e5e8802ef0566e1d9e8","modified":1474885648240},{"_id":"themes/yilia/source-src/css/_core.scss","hash":"29ba600e98ed55f7af4ade8038272c84cba21188","modified":1474885648224},{"_id":"themes/yilia/source-src/fancybox/jquery.fancybox.scss","hash":"96138eaddfbd305160ddcb98a5f08555ca6cb4ee","modified":1474885648240},{"_id":"themes/yilia/source-src/css/_function.scss","hash":"ce227b6f5a9af194fd5d455200630f32c05e151f","modified":1474885648224},{"_id":"themes/yilia/source-src/css/archive-inner.scss","hash":"3b384a11226a0f0c7b407c80e8224d99a4c6e7b8","modified":1474885648224},{"_id":"themes/yilia/source-src/css/archive.scss","hash":"8a0ae8ee6af8df3f215f1cd4ecc10145a5b92cf0","modified":1474885648224},{"_id":"themes/yilia/source-src/css/article-inner.scss","hash":"75f07aa38b0e56c7279c96d4d1a5061c3ba97a96","modified":1474885648224},{"_id":"themes/yilia/source-src/css/article-main.scss","hash":"ed5940f0881e36a75235ff8fbd024c8ee7b3cd46","modified":1474885648224},{"_id":"themes/yilia/source-src/css/article-nav.scss","hash":"58c055d54cf1c9551c8b71e9d8cbe1715593bebb","modified":1474885648224},{"_id":"themes/yilia/source-src/css/article.scss","hash":"1af257c2de4a13464196e875fe18fefe7d2d4cd9","modified":1474885648224},{"_id":"themes/yilia/source-src/css/duoshuo.scss","hash":"7d2e6d6ce87732fe5b3799a6e9e1f737a79ed736","modified":1474885648224},{"_id":"themes/yilia/source-src/css/footer.scss","hash":"7ca837a4cc34db1c35f01baec85eb10ccc64ea86","modified":1474885648224},{"_id":"themes/yilia/source-src/css/fonts.scss","hash":"1c79e1cd8b00d6d89cca00c2a101e6639c378a9b","modified":1474885648224},{"_id":"themes/yilia/source-src/css/global.scss","hash":"b4cb4f45a55d4250cd9056f76dab2a3c0dabcec4","modified":1474885648224},{"_id":"themes/yilia/source-src/css/grid.scss","hash":"9b660a5a820caf394ae497f262e80f9ed35bf219","modified":1474885648224},{"_id":"themes/yilia/source-src/css/highlight.scss","hash":"0267e2febaef284cf319235435643232fdeee0c9","modified":1474885648224},{"_id":"themes/yilia/source-src/css/left.scss","hash":"0940b74a29101c97573efd8e492ee39cef5e2dc8","modified":1474885648224},{"_id":"themes/yilia/source-src/css/mobile-slider.scss","hash":"facd3d41bc9b2d2c6134fc0fbd379a3b0c18476b","modified":1474885648224},{"_id":"themes/yilia/source-src/css/main.scss","hash":"bdd600d274233c001a0fb89f7f89af66bb04a147","modified":1474885648224},{"_id":"themes/yilia/source-src/css/mobile.scss","hash":"0ca3752966fdce7919442174a7a4cb769a3bec74","modified":1474885648224},{"_id":"themes/yilia/source-src/css/page.scss","hash":"244c4d75c375978ff9edb74acc68825e63c6b235","modified":1474885648224},{"_id":"themes/yilia/source-src/css/scroll.scss","hash":"2495f7e4e3b055735c531f944b5f40a118a351ec","modified":1474885648224},{"_id":"themes/yilia/source-src/css/social.scss","hash":"ccb2c214d2c0efae41066fa85afb4d7288e55cbf","modified":1474885648224},{"_id":"themes/yilia/source-src/css/style.js","hash":"6c4cb072d0d5cbbb5291aa255dee31c7b13cfe66","modified":1474885648224},{"_id":"themes/yilia/source-src/css/switch.scss","hash":"a4c1872aff9509441f4d723801a9b3f7db161a41","modified":1474885648224},{"_id":"themes/yilia/source-src/css/tags-cloud.scss","hash":"399744e98e7c67939ed9b23c2670d8baad044eda","modified":1474885648224},{"_id":"themes/yilia/source-src/css/tags.scss","hash":"eed50d74e5f272af5dc5f7f335ded2c95bb5359f","modified":1474885648224},{"_id":"themes/yilia/source-src/css/tools.scss","hash":"0882c3b2cf3d9228bd74d91c37fb531b735d732a","modified":1474885648224},{"_id":"themes/yilia/source-src/js/archive-inner.js","hash":"7a80e2fe52212adc5a45aaae07d397fe93460fad","modified":1474885648240},{"_id":"themes/yilia/source-src/js/browser.js","hash":"bb2e9a1ddcb34372e6cbdd9e9ecfd3dc87623451","modified":1474885648240},{"_id":"themes/yilia/source-src/js/fix-page.js","hash":"940b580d6243461788c28bdd09b8049642a90e13","modified":1474885648240},{"_id":"themes/yilia/source-src/js/main.js","hash":"8fc971ac4912c38c7a0ec0cb4c9b0935655db056","modified":1474885648240},{"_id":"themes/yilia/source-src/js/mobile.js","hash":"481ecf50b72197fa6e52d92e8368e4fe2749230f","modified":1474885648240},{"_id":"themes/yilia/source-src/js/tools.js","hash":"eb36f563b76e9431dc109856a78383ed11763a84","modified":1474885648240},{"_id":"themes/yilia/source-src/js/tags.js","hash":"a8da9d6e3031c960f9859ef519233ad3ab65d0ef","modified":1474885648240},{"_id":"themes/yilia/source-src/js/util.js","hash":"cf91a9c9c973e2ee05d50a24a11c411c36264238","modified":1474885648240},{"_id":"themes/yilia/source-src/js/viewer.js","hash":"c470a96b30159285d7c8ef1c8e8dd4c818933747","modified":1474885648240},{"_id":"themes/yilia/source-src/photoSwipe/photoswipe-ui-default.js","hash":"05fa305ec449deb59b04e2ae118a8e3ec5250e1b","modified":1474885648240},{"_id":"themes/yilia/source-src/photoSwipe/photoswipe-ui-default.min.js","hash":"852a1fcdaacf66754090fc6d432013c5c657ab80","modified":1474885648240},{"_id":"themes/yilia/source-src/photoSwipe/photoswipe.min.js","hash":"39806b9989eaecbc3e032da8de77f69e0c9ff779","modified":1474885648240},{"_id":"themes/yilia/source-src/photoSwipe/photoswipe.scss","hash":"b80bb4efe9ac36a566f037fb6984af8b486a9d5c","modified":1474885648240},{"_id":"themes/yilia/source-src/photoSwipe/photoswipe.js","hash":"b616337e586eaa5afcf5bb77c927bd1b09a25524","modified":1474885648240},{"_id":"themes/yilia/.git/objects/pack/pack-cef498d93376744b07ed935af574e726980bcb27.idx","hash":"a041c49088d36e843c48c57a362375311c1597ef","modified":1474885648040},{"_id":"themes/yilia/.git/refs/heads/master","hash":"d923501cd4ac613bf93ba1a42daf6ea20c5edebc","modified":1474885648193},{"_id":"themes/yilia/layout/_partial/post/category.ejs","hash":"2fd6338379fd50ea8282f065ffadc838f94e6015","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/post/date.ejs","hash":"d5c0e472dd9e8b036f977745ff50056813f6b1b0","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/post/duoshuo.ejs","hash":"f6b4c4eaafb5ac386273354b5f64a26139b7a3b0","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/post/nav.ejs","hash":"b6a97043f9ec37e571aacacfedcda1d4d75e3c7c","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/post/share_addthis.ejs","hash":"5b3583114f45a3f8017a6ff900d1b72ddea2a6df","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/post/share_jia.ejs","hash":"f6204220060a2b77a609fcaaa81f639d0b02e3af","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/post/tag.ejs","hash":"e6edf173da77fb851fc067a481a897ad934cc4ca","modified":1474885648208},{"_id":"themes/yilia/layout/_partial/post/title.ejs","hash":"d4a460a35e2112d0c7414fd5e19b3a16093f1caf","modified":1474885648208},{"_id":"themes/yilia/source-src/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/helpers/jquery.fancybox-buttons.js","hash":"4c9c395d705d22af7da06870d18f434e2a2eeaf9","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/helpers/jquery.fancybox-buttons.css","hash":"6394c48092085788a8c0ef72670b0652006231a1","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/helpers/jquery.fancybox-media.js","hash":"e14c32cc6823b81b2f758512f13ed8eb9ef2b454","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"b88b589f5f1aa1b3d87cc7eef34c281ff749b1ae","modified":1474885648240},{"_id":"themes/yilia/source-src/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"83cdfea43632b613771691a11f56f99d85fb6dbd","modified":1474885648240},{"_id":"themes/yilia/source-src/css/core/_animation.scss","hash":"8381a373d85daee53cc3247467ffa4db58ae1b88","modified":1474885648224},{"_id":"themes/yilia/source-src/css/core/_media-queries.scss","hash":"262ffcd88775080b7f511db37f58d2bcb1b2bfc7","modified":1474885648224},{"_id":"themes/yilia/source-src/css/core/_mixin.scss","hash":"4dd97aa8aa0ffb312a7d3c6e0f82b85642f7f2e7","modified":1474885648224},{"_id":"themes/yilia/source-src/css/core/_reset.scss","hash":"398a49913b4a47d928103562b1ce94520be4026a","modified":1474885648224},{"_id":"themes/yilia/source-src/css/core/_variables.scss","hash":"6e75bdaa46de83094ba0873099c6e7d656a22453","modified":1474885648224},{"_id":"themes/yilia/source-src/css/fonts/icomoon.eot","hash":"9a661069e1255d10032926a8ef87502f445f4e20","modified":1474885648224},{"_id":"themes/yilia/source-src/css/fonts/icomoon.svg","hash":"2f9c8a34e40173ab8b6e3f0f761ece4d2b7a8f68","modified":1474885648224},{"_id":"themes/yilia/source-src/css/fonts/icomoon.woff","hash":"a5c2eb785800a3a0aeaf2284d191d69df1893d6d","modified":1474885648224},{"_id":"themes/yilia/source-src/css/fonts/icomoon.ttf","hash":"9f1e824fc076dbfedf186609a2664558d5e3e986","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/checkered-pattern.png","hash":"049262fa0886989d750637b264bed34ab51c23c8","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/coderwall.png","hash":"fa84676c4d654e040e51fd34bfcd9f9348cd5331","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/black-scales.png","hash":"243ea748d016704922ccfc0b6c18d97472c27bff","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/douban.png","hash":"e2ade003ffadd5826ee66ec23901c2d6e8607e4e","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/facebook.png","hash":"d19ad7a0903daf26817afd8753cd97e0cc714f54","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/github.png","hash":"b84d03b32fa388dcbf149296ebd16dce6223d48d","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/google.png","hash":"61a21fec7346fa3400b747ac9a201cf3d5bc013d","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/linkedin.png","hash":"e203138fb53c257cb214e97f4e30091b9c568d2c","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/mail.png","hash":"fca8199cc77fdbd700a45bf56d091c82f4a67fe7","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/pinboard.png","hash":"0891fbb6d092fa012bf936019923383d84c6aeb0","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/pinterest.png","hash":"9c72917f8779c083157c6ce7a5d62ed4874f0630","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/rss.png","hash":"430fd47340e75214c081abd05cd7410cf7c71b86","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/scrollbar_arrow.png","hash":"d64a33c4ddfbdb89deeb6f4e3d36eb84dc4777c0","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/stackoverflow.png","hash":"da5dfe9043055c95e479d49c78cd3b020de608f2","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/twitter.png","hash":"14dbb8e62d056525253bc0de13acd1723da7a934","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/weibo.png","hash":"280dae3fd38086158b4a1b57edb94c06b1a5014b","modified":1474885648224},{"_id":"themes/yilia/source-src/css/img/zhihu.png","hash":"a6d6ef65e9ac82e613a311810391ebb90d9b1c1d","modified":1474885648224},{"_id":"themes/yilia/source-src/photoSwipe/default-skin/default-skin.png","hash":"ed95a8e40a2c3478c5915376acb8e5f33677f24d","modified":1474885648240},{"_id":"themes/yilia/source-src/photoSwipe/default-skin/default-skin.scss","hash":"3f8f8062d24cce2158d3c02bdfc56c000f1a1f9b","modified":1474885648240},{"_id":"themes/yilia/source-src/photoSwipe/default-skin/default-skin.svg","hash":"2ac727c9e092331d35cce95af209ccfac6d4c7c7","modified":1474885648240},{"_id":"themes/yilia/source-src/photoSwipe/default-skin/preloader.gif","hash":"6342367c93c82da1b9c620e97c84a389cc43d96d","modified":1474885648240},{"_id":"themes/yilia/source-src/css/img/black-paper.png","hash":"a180d3109a5cb6b9b9aa60d81730446ebe275473","modified":1474885648224},{"_id":"themes/yilia/.git/logs/refs/heads/master","hash":"354340164ffe775c8ec30f7b6bf0e3fc54e3204d","modified":1474885648193},{"_id":"themes/yilia/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1474885648193},{"_id":"themes/yilia/source-src/js/jquery.js","hash":"aa6ccf721c4e76921abda46c120772d364e5b285","modified":1474885648240},{"_id":"themes/yilia/.git/logs/refs/remotes/origin/HEAD","hash":"354340164ffe775c8ec30f7b6bf0e3fc54e3204d","modified":1474885648193},{"_id":"themes/yilia/.git/objects/pack/pack-cef498d93376744b07ed935af574e726980bcb27.pack","hash":"78b64af2f0841f5c7e6dcc28281881efdf73af6e","modified":1474885648056},{"_id":"public/categories/index.html","hash":"afa9f00026966cf8961d6e23253485f1dc2543ae","modified":1480417248285},{"_id":"public/tags/index.html","hash":"a8dd50f6ecaa081dc339799b15919eb005289fff","modified":1480417248285},{"_id":"public/archives/page/6/index.html","hash":"fec5607b9b2738a529734b38cac7c33def57e5eb","modified":1480417248286},{"_id":"public/archives/2015/10/index.html","hash":"4c1e5748611bf9001410d86f7cf912d2f93e3c0a","modified":1480417248286},{"_id":"public/archives/2015/11/index.html","hash":"ae81fd85b11a877717e18227a7227dec0d4e7a4b","modified":1480417248286},{"_id":"public/archives/2015/12/index.html","hash":"14565fc0929780bd1b0ca635bb9a4fa0032344e6","modified":1480417248286},{"_id":"public/archives/2016/page/5/index.html","hash":"3ae8b7923d3e4feb9449cf3ec04339f34846d252","modified":1480417248286},{"_id":"public/archives/2016/01/index.html","hash":"589aa1df4281d6423ad8210625b9e53cde04615b","modified":1480417248286},{"_id":"public/archives/2016/02/index.html","hash":"814cb8ebc14693bb5e3dc79d51a2048ce70c0ada","modified":1480417248286},{"_id":"public/archives/2016/05/index.html","hash":"8d3d383309e417f5a1514af6103512065eced0e9","modified":1480417248286},{"_id":"public/archives/2016/06/index.html","hash":"3eed0148adc1e7954ec5ed85ddcd29e4bcdf4970","modified":1480417248286},{"_id":"public/archives/2016/07/index.html","hash":"5ff509b34fe2d8f0926f01f6fda3a4148c502740","modified":1480417248286},{"_id":"public/archives/2016/08/index.html","hash":"0cec2e661176e929bb1c445d014adc9282f0eaba","modified":1480417248286},{"_id":"public/archives/2016/09/index.html","hash":"74122fc60337c85568d8ef4cbc6fd142d5df5f2d","modified":1480417248286},{"_id":"public/archives/2016/10/index.html","hash":"9b9ff4e8d3d324d2c9ddc7280c768c57fbf6b7e1","modified":1480417248286},{"_id":"public/archives/2016/11/index.html","hash":"a3f6c5bd523a5a72e336076614a7817c67a76068","modified":1480417248286},{"_id":"public/tags/iOS/index.html","hash":"3ffcf9038e678be437377513d1ad70636ed93479","modified":1480417248286},{"_id":"public/tags/sdk/index.html","hash":"ab12ba11794e49bc98bc35551aa9cc5a3d0ebf80","modified":1480417248287},{"_id":"public/tags/blog/index.html","hash":"1f6f085a2bd4aaf50ebd637b1cf72f616592063c","modified":1480417248287},{"_id":"public/tags/直播/index.html","hash":"66fb43d7bbf70d89ed355535ccc2e29b61964450","modified":1480417248287},{"_id":"public/tags/android-studio/index.html","hash":"0bb31385a00d57811bc1cab23e687ecbeeab3426","modified":1480417248287},{"_id":"public/tags/hybrid开发/index.html","hash":"85e95558f94f37843d5ef5d9fb3d2994dc4eb505","modified":1480417248287},{"_id":"public/tags/杂谈/index.html","hash":"013f371a711bab1f3850760a97251415875c7cb2","modified":1480417248287},{"_id":"public/tags/设计模式/index.html","hash":"10f69269d1fdc04eab7b5be1757d5cd8d44aede9","modified":1480417248287},{"_id":"public/tags/java/index.html","hash":"abe7273dcaf37de9ac4c45c2d8d1b425b5e83b55","modified":1480417248287},{"_id":"public/tags/事件分发/index.html","hash":"31722e251f6e7e08471f434a15a33ee9b56d3479","modified":1480417248288},{"_id":"public/something/index.html","hash":"7dde6f21ab8020f376abf64a186951e76dff9e5b","modified":1480417248288},{"_id":"public/2016/11/28/OS-X/index.html","hash":"5715f7500f2bf46e837f980e8b0e876509d2bd01","modified":1480417248288},{"_id":"public/2016/11/21/ios/index.html","hash":"27798d49ead158e76ab8353cff76f2f101d5b8a7","modified":1480417248288},{"_id":"public/2016/11/16/socket/index.html","hash":"260a0ec1cadd9059189ae5d7391a403b6223b5c1","modified":1480417248288},{"_id":"public/2016/10/28/cross-platform/index.html","hash":"1da49d3abe1859454c8609f684ac3ce59d6c4896","modified":1480417248288},{"_id":"public/2016/10/22/live-audio/index.html","hash":"97a7208d4bfd84c7de952a9b7370abee98695555","modified":1480417248288},{"_id":"public/2016/10/20/live-code-video/index.html","hash":"d6d2168e0b46255bb1432e50c1c42132cfceb210","modified":1480417248288},{"_id":"public/2016/10/20/live-capture-video/index.html","hash":"414404393ab1e29c83b0ce18076cdf18e8503729","modified":1480417248288},{"_id":"public/2016/10/19/live/index.html","hash":"5e4d44a51e72c99254ec41a0029ed3b06a517439","modified":1480417248288},{"_id":"public/2016/09/20/system-ui/index.html","hash":"31992a55d40a0495c2627eda00476d0bda4d1b7e","modified":1480417248289},{"_id":"public/2016/09/12/jcenter/index.html","hash":"1af9a38a1a7c1d309d4dfdb812e83e225bf699bd","modified":1480417248289},{"_id":"public/2016/08/18/alarm/index.html","hash":"828e43742d3c66b78a01195ef4aba8c5d7b59578","modified":1480417248289},{"_id":"public/2016/09/12/make-wheel/index.html","hash":"16a9e7aa5d20ea10b7a544991a71e4d7128737f0","modified":1480417248289},{"_id":"public/2016/08/05/touchevent/index.html","hash":"32ed62bab644162617de84bbe1a8531e3ec37ca4","modified":1480417248289},{"_id":"public/2016/08/04/statusbar/index.html","hash":"08cd84d45ba53229aff34e57499b6dde819a3d9e","modified":1480417248289},{"_id":"public/2016/07/26/textview/index.html","hash":"23d90a82d0fed537ffc601bd816205ee2a1cac50","modified":1480417248289},{"_id":"public/2016/07/21/blur/index.html","hash":"89d973856e5dccf033239bd2f067fe2bcc20d7a4","modified":1480417248289},{"_id":"public/2016/07/21/android-adapter/index.html","hash":"2832c11f2478d7565e845d8a9d05518eea9d00ba","modified":1480417248289},{"_id":"public/2016/07/01/about-screen/index.html","hash":"bcb5bda7f8e384698342e7109ad371329c8473c7","modified":1480417248289},{"_id":"public/2016/06/23/retrofit/index.html","hash":"bea2bd7c3df15db0bafd4d4e49dd5afb4fa9874c","modified":1480417248289},{"_id":"public/2016/06/27/mvp/index.html","hash":"1482df2b7f99155b6b5b7859d3d1ace8869d3c7b","modified":1480417248289},{"_id":"public/2016/06/02/popupwindow/index.html","hash":"18aac80b99ae865330a5e15ad1b9ecb103bd5e42","modified":1480417248289},{"_id":"public/2016/05/27/task-queue/index.html","hash":"c9f4fe0500a9ac74afa1368807df493b2166aa7b","modified":1480417248289},{"_id":"public/2016/05/18/alipay/index.html","hash":"c714111bb98f10020dd15ba29cf5b70fc05f30d6","modified":1480417248289},{"_id":"public/2016/05/16/dashboard/index.html","hash":"544bbf4a02b4ba61ee8d880c080da3d33200ddb7","modified":1480417248289},{"_id":"public/2016/05/10/custom-attr/index.html","hash":"836bd9700fdc9ee34ec06ca7c4544c1025bffff2","modified":1480417248289},{"_id":"public/2016/04/28/new-seekbar/index.html","hash":"830aee5b5e6999b4d2138d6573ccaf37cf6446f9","modified":1480417248289},{"_id":"public/2016/04/27/seekbar/index.html","hash":"cb1380767cf33a9b3ccca935ba01ac3ff12bfd61","modified":1480417248290},{"_id":"public/2016/04/22/android-scroll/index.html","hash":"9c21f2ee3858bb7635aea2da841c43de1c2819eb","modified":1480417248290},{"_id":"public/2016/04/18/refresh-listview/index.html","hash":"39c909fe8d35415be3f47f16aec1a20e00a8e422","modified":1480417248290},{"_id":"public/2016/04/05/jpush/index.html","hash":"1ee1d6e3b700583fa4b885aad7d772dca6006fce","modified":1480417248290},{"_id":"public/2016/04/07/domain/index.html","hash":"cce29a9071f432e7b97723b63e53836761ca60d5","modified":1480417248290},{"_id":"public/2016/04/01/video-view/index.html","hash":"f54a080a07592c9655f42e625e106b5772e4cf32","modified":1480417248290},{"_id":"public/2016/03/25/blog-move/index.html","hash":"2d7877cba30d7ee9642efca8f5247e17050bbc28","modified":1480417248290},{"_id":"public/2016/03/18/wechat-sdk/index.html","hash":"43ae4e542c0750178b22f6886996a767e7051802","modified":1480417248290},{"_id":"public/2016/03/17/hexo-tools/index.html","hash":"1daf6d57d9e60d911a7f757db3e5ab3083cd935e","modified":1480417248290},{"_id":"public/2016/03/17/hexo-tips/index.html","hash":"335a93a92d7ceb44bf2f70cbd1f4b621246682b5","modified":1480417248290},{"_id":"public/2016/03/17/hexo-blog/index.html","hash":"c6438076f6c63663c347065f068b94877befcbfe","modified":1480417248290},{"_id":"public/2016/03/09/gradle-pack/index.html","hash":"899ad64d4e9fe977d7ea2f2fe32062524705e047","modified":1480417248290},{"_id":"public/2016/03/02/change-title/index.html","hash":"ecd61f96128b004007494a1a69012ae131253c99","modified":1480417248290},{"_id":"public/2016/02/23/single-thread-queue/index.html","hash":"70d06046faaf41f9568449b58ca9adb7792d32b3","modified":1480417248290},{"_id":"public/2016/02/17/photo-wall/index.html","hash":"02f8ed6391acda87949d36f15d1f4f5f5d04f1af","modified":1480417248290},{"_id":"public/2016/02/17/material-design/index.html","hash":"057ae71d7dddd9fb83ddaf09e6b482eae893736e","modified":1480417248290},{"_id":"public/2016/01/19/react-native-tips/index.html","hash":"1716d7c2ac472c4a0603aa3e2ba80b6c8ec1c14e","modified":1480417248290},{"_id":"public/2016/01/15/react-native/index.html","hash":"8e00e5b281be8b96f90a565df5b8c3f3d1ce28e7","modified":1480417248290},{"_id":"public/2016/01/14/hybrid-practice/index.html","hash":"676056307008fc7458cefda3178e362b5af0fe5f","modified":1480417248291},{"_id":"public/2016/01/11/notification/index.html","hash":"af0ce4b8438231257fbe2fa3fd9e1a067dd9e0a4","modified":1480417248291},{"_id":"public/2015/12/25/hybrid-introduction/index.html","hash":"5229351c3c8951090fc5a024dc442f71f6ef8bb5","modified":1480417248291},{"_id":"public/2015/12/08/picture-view/index.html","hash":"d32c07a1eaa7bb848a9ad176b5d38d4b02f1edcc","modified":1480417248291},{"_id":"public/2015/11/23/nine-patch/index.html","hash":"6b87382b683faee686f5ab7542200db25efaaf7d","modified":1480417248291},{"_id":"public/2015/11/14/swipe-listview/index.html","hash":"1b86fb2de6066b4d6c11683a5f3a1b1bea2b3984","modified":1480417248291},{"_id":"public/2015/11/14/touch-event/index.html","hash":"b2ae871eb78d127b94209679f06abfadd8f24475","modified":1480417248291},{"_id":"public/2015/11/05/genymotion/index.html","hash":"7aa8c0ad062099b21892f26c306a8cd6a45bb6e9","modified":1480417248291},{"_id":"public/2015/10/28/reflect-interface/index.html","hash":"f1c0619a441599a46e6f8155281fb1a36397a6ab","modified":1480417248291},{"_id":"public/2015/10/24/baidu-loc/index.html","hash":"c4ee0bf003201c59f93d6b13d27ddfc2e628ad6d","modified":1480417248291},{"_id":"public/2015/10/24/ddms-logcat/index.html","hash":"7f24ca2ce1709d6f08e48e07baeaad6cf33d7ddf","modified":1480417248291},{"_id":"public/archives/index.html","hash":"3ffd06f63239166418a7eda1f9724cce93ae0429","modified":1480417248291},{"_id":"public/archives/page/2/index.html","hash":"62710f3e5c9f13988ea2aaa67001238e5dcc1481","modified":1480417248291},{"_id":"public/archives/page/3/index.html","hash":"b612b12753929db839c4c0a0f5cffb1a2d074f05","modified":1480417248291},{"_id":"public/archives/page/4/index.html","hash":"63ae58fb99d85b5e56d89bbb4c771cc6365153a6","modified":1480417248291},{"_id":"public/archives/page/5/index.html","hash":"d9c5800d79eab4a24bf70eed9979ecfbed836a30","modified":1480417248291},{"_id":"public/archives/2015/index.html","hash":"a92ec8d4500be58d5373601e23a37dfd9c73a39a","modified":1480417248291},{"_id":"public/archives/2016/index.html","hash":"e86a199f5016e444760bc579bd2541091b473c4e","modified":1480417248291},{"_id":"public/archives/2016/page/2/index.html","hash":"ca3fa8435ce85ff00d4d5efa4de296e5612d2e45","modified":1480417248291},{"_id":"public/archives/2016/page/3/index.html","hash":"fe033a0e26553fac08bb773d2d86dec4e047cb5b","modified":1480417248292},{"_id":"public/archives/2016/page/4/index.html","hash":"a4952a56b40238b9eb34d205440dc5ebfeb46b81","modified":1480417248292},{"_id":"public/archives/2016/03/index.html","hash":"32053a218e8c2b2d1318156ff09416fd2663d3a5","modified":1480417248292},{"_id":"public/archives/2016/04/index.html","hash":"df092a47f4a4b12554f570b355bafb64572c6226","modified":1480417248292},{"_id":"public/index.html","hash":"7204b9b43494c65d97d24954a3dd8fc3681fdc10","modified":1480417248292},{"_id":"public/page/2/index.html","hash":"2ab35981de85ed57e76657c44dd4077660c71d37","modified":1480417248292},{"_id":"public/page/3/index.html","hash":"36da3449b51adaab6a002c466ffbc43127369d12","modified":1480417248292},{"_id":"public/page/4/index.html","hash":"49516db77f86dfb7dce39f891f8a12b7c08c23ce","modified":1480417248292},{"_id":"public/page/5/index.html","hash":"e7eb2ad879614981c62a052524ab7dc0aa670cd3","modified":1480417248292},{"_id":"public/page/6/index.html","hash":"d411ccc39802d22d72850e3a693f2ad132fd38ae","modified":1480417248292},{"_id":"public/tags/日常开发/index.html","hash":"ad91f94a3ca9601050b3b87e220e64dadbee2ca3","modified":1480417248292},{"_id":"public/tags/日常开发/page/2/index.html","hash":"2c908413d22fb8130d7125b392a1c91a9873e53d","modified":1480417248292},{"_id":"public/tags/自定义View/index.html","hash":"c3aeeb2027bbf935af6709d5cdff615fa2b433b5","modified":1480417248292},{"_id":"public/CNAME","hash":"9cc253b4f578318faf08326e4d2d3599e0afc2dc","modified":1480417248308},{"_id":"public/README.md","hash":"4589189904eb6a17c983afbd919ad4dcc8c1cb7f","modified":1480417248308},{"_id":"public/avatar.jpg","hash":"c89e75d4f75f2f5aa7dd7ceccf4998fa8afe6624","modified":1480417248308},{"_id":"public/favicon.png","hash":"3427752b6a8a8fe2ea37783a11cbeb68d69986ef","modified":1480417248308},{"_id":"public/main.js","hash":"9564ebaff9fb17e4911ba30cb1da63be8a1a64e9","modified":1480417248323},{"_id":"public/style.js","hash":"3ffa5ca74d270754f874160463874d85b6a3d5d2","modified":1480417248323}],"Category":[],"Data":[],"Page":[{"title":"categories","date":"2016-03-16T07:33:56.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2016-03-16 15:33:56\ntype: \"categories\"\n---","updated":"2016-03-17T01:19:04.615Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ciw3e757p00011cb84ylqm8s5","content":"","excerpt":"","more":""},{"title":"tags","date":"2016-03-16T07:33:44.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2016-03-16 15:33:44\ntype: \"tags\"\n---\n","updated":"2016-03-17T01:21:27.474Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ciw3e757s00031cb89pwm51tk","content":"","excerpt":"","more":""},{"title":"干货","date":"2016-03-28T09:55:33.000Z","_content":"\n在这个版块中，主要放一些自己觉得不错的文章，方便后面回顾。\n\n会不定期更新。\n\n## Android Studio\n1. [倍数提高工作效率的Android Studio奇技](http://zlv.me/posts/2015/07/13/14_android-studio-tips/)\n2. [如何使用Android Studio把自己的Android library分发到jCenter和Maven Central](http://www.open-open.com/lib/view/open1435109824278.html)\n3. [如何选择 compileSdkVersion, minSdkVersion 和 targetSdkVersion](http://chinagdg.org/2016/01/picking-your-compilesdkversion-minsdkversion-targetsdkversion/)\n4. [Android Studio插件整理](https://ydmmocoo.github.io/2016/06/28/Android-Studio%E6%8F%92%E4%BB%B6%E6%95%B4%E7%90%86/)\n5. [基于Android Studio的内存泄漏检测与解决全攻略](http://wetest.qq.com/lab/view/?id=99)\n6. [Android Studio相见恨晚的操作锦集](http://www.jianshu.com/p/bc8f6bfe12c6)\n7. [50个Android Studio秘诀、技巧和资源](http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&mid=2651112873&idx=1&sn=667188f0f320a4c0550340138783aae3)\n\n## 日常开发\n1. [Android 开发绕不过的坑：你的 Bitmap 究竟占多大内存？](http://bugly.qq.com/bbs/forum.php?mod=viewthread&tid=498&extra=page%3D1)\n2. [Android 中Parcelable接口用法](http://www.cnblogs.com/renqingping/archive/2012/10/25/Parcelable.html)\n3. [那些你应该知道却不一定知道的——View坐标分析汇总](http://blog.csdn.net/mr_immortalz/article/details/51168278)\n4. [那些值得你去细细研究的Drawable适配](http://blog.csdn.net/wrg_20100512/article/details/51295317)\n5. [Android屏幕适配全攻略(最权威的官方适配指导)](http://blog.csdn.net/zhaokaiqiang1992/article/details/45419023)\n6. [安卓开发技术：监听软键盘的显示与隐藏](http://toughcoder.net/blog/2015/10/09/android-trick-detect-soft-keyboard-show-slash-hide/)\n7. [Activity 横竖屏切换](http://www.cnblogs.com/yishujun/p/5395266.html)\n8. [Android 横竖屏切换小结](http://www.cnblogs.com/franksunny/p/3714442.html)\n9. [LeakCanary 中文使用说明](http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/)\n10. [Android 基础 VideoView](http://www.jianshu.com/p/2d3b221a2ee7)\n11. [Android 单元测试之Mockito浅析](http://hlong.xyz/2016/06/16/Android%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B9%8BMockito%E6%B5%85%E6%9E%90/)\n12. [关于Adapter的The content of the adapter has changed问题分析](http://www.cnblogs.com/monodin/p/3874147.html)\n13. [Android状态栏微技巧，带你真正理解沉浸式模式](http://blog.csdn.net/guolin_blog/article/details/51763825)\n14. [Java中的自动装箱与拆箱](http://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/)\n15. [掌握 Android 中的 tools 命名空间](http://android.jobbole.com/83207/)\n16. [两分钟理解Android中SP与DP的区别](http://droidyue.com/blog/2016/09/05/dp-vs-sp-in-android/)\n17. [Android 6.0 运行时权限管理最佳实践](http://blog.csdn.net/yanzhenjie1003/article/details/52503533)\n18. [Android ListView与RecyclerView对比浅析--缓存机制](http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=2649286405&idx=1&sn=414e2d2eb577884ccee5c9076e8b8357&chksm=8334c387b4434a9124f5acd93f331968a44256b8374eeafb4b1857671072b3b6364e5ec38485&scene=0#rd)\n19. [Android 开发之 App 启动时间统计](http://www.jianshu.com/p/c967653a9468?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)\n20. [单播，组播(多播)，广播以及任播](http://colobu.com/2014/10/21/udp-and-unicast-multicast-broadcast-anycast/)\n21. [Android 爬坑之旅：软键盘挡住输入框问题的终极解决方案](http://www.diycode.cc/topics/383)\n22. [写给Android开发者的混淆使用手册](http://www.jianshu.com/p/158aa484da13)\n23. [Android 内存泄漏分析心得](http://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&mid=2649796884&idx=1&sn=92b4e344060362128e4a86d6132c3736)\n\n## 框架设计\n1. [Android MVP 详解（上）](http://www.jianshu.com/p/9a6845b26856)\n2. [Android MVP 详解（下）](http://www.jianshu.com/p/0590f530c617)\n3. [Android App的设计架构：MVC,MVP,MVVM与架构经验谈](https://www.sdk.cn/news/2501)\n4. [Android 编码规范](http://www.jianshu.com/p/0a984f999592)\n5. [一步一步实现Android的MVP框架](http://dev.qq.com/topic/5799d7844bef22a823b3ad44)\n\n## 技术学习\n1. [Android Vector曲折的兼容之路](http://www.jianshu.com/p/e3614e7abc03)\n2. [关于 Android 进程保活，你所需要知道的一切](http://www.jianshu.com/p/63aafe3c12af#)\n3. [Android 应用性能剖析全攻略](http://toughcoder.net/blog/2015/09/11/android-performance-profiling-made-easy/)\n4. [Android 客户端性能优化](http://blog.tingyun.com/web/article/detail/155)\n5. [开发第三方库最佳实践](http://www.jianshu.com/p/0aacd419cb7e)\n6. [Android 自动清理无用资源工具](http://blog.csdn.net/honjane/article/details/41351183)\n7. [Android 内存泄漏的八种可能](http://www.jianshu.com/p/ac00e370f83d?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)\n8. [阿里Weex框架Android平台初体验](http://smilevenus.com/2016/07/03/%E9%98%BF%E9%87%8CWeex%E6%A1%86%E6%9E%B6Android%E5%B9%B3%E5%8F%B0%E5%88%9D%E4%BD%93%E9%AA%8C/)\n9. [与 .so 有关的一个长年大坑](https://zhuanlan.zhihu.com/p/213599847)\n10. [WebSocket 是什么原理？为什么可以实现持久连接？](https://www.zhihu.com/question/20215561/answer/40316953)\n11. [Android 消息处理机制(Handler、Looper、MessageQueue与Message)](http://www.cnblogs.com/angeldevil/p/3340644.html)\n12. [Android 应用进程启动流程](http://www.woaitqs.cc/android/2016/06/21/activity-service.html)\n13. [Android 内存优化之OOM](http://hukai.me/android-performance-oom/)\n14. [PathMeasure之迷径追踪](http://blog.csdn.net/eclipsexys/article/details/51992473)\n15. [Android App国际化](https://mp.weixin.qq.com/s?__biz=MzI1NjEwMTM4OA==&mid=2651232086&idx=1&sn=8894da8393bac3c50c3a93b9bd7f4102&scene=1&srcid=0822olNZUAyrHj8taaARWJFl&key=8dcebf9e179c9f3a14dfaaf49e391fe1723547d2fdd2d25769b9e06df5b19e8356b7533efd7e6c12ba895531f23fdf20&ascene=0&uin=Mjc3OTU3Nzk1&devicetype=iMac+MacBookPro10%2C1+OSX+OSX+10.10.5+build%2814F1909%29&version=11020201&pass_ticket=93ppXY%2FQxuOZivwZLgIhWpNIrGPcMB69uUsPDLQROrzXxXQP47pjLwNhXgvIcZH9)\n16. [Atlas：手淘Native容器化框架和思考](http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&mid=2651112809&idx=1&sn=8d45d8960acde6128b121fb10a6d7bb7&chksm=844c6cb4b33be5a24cd462aa2fa96ce206877e0a87959df9aba03826d6be045dcaf6b9748739&scene=0#rd)\n17. [Android热修复技术选型——三大流派解析](http://mp.weixin.qq.com/s?__biz=MzA4MjA0MTc4NQ==&mid=2651574060&idx=1&sn=5978a774a6f74535497b2643e92fd124&chksm=8474a1fab30328ec012795809482d286d63da557c0efcae066bb0bee62b43a8a2f1dc372ed2b&scene=0#rd)\n18. [Android 深入理解Loader机制 让APP轻装上阵](http://www.jianshu.com/p/385327e35711)\n19. [给 Android 开发者的 RxJava 详解](http://gank.io/post/560e15be2dca930e00da1083)\n20. [大幅提高Android开发效率之Android项目模板化（上）](http://www.jianshu.com/p/e8ac0c284601/comments/5435137#comment-5435137)\n21. [ReactiveX/RxJava文档中文版](https://mcxiaoke.gitbooks.io/rxdocs/content/)\n22. [RxJava系列1(简介)](https://zhuanlan.zhihu.com/p/20687178)\n\n## 音视频专题\n1. [雷霄骅(leixiaohua1020)的专栏](http://blog.csdn.net/leixiaohua1020?viewmode=contents)\n2. [Jhuster的专栏](https://zhuanlan.zhihu.com/jhuster)\n3. [移动直播技术秒开优化经验](http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=2653547042&idx=1&sn=26d8728548a6b5b657079eeab121e283&scene=1&srcid=0428msEitG9LJ3JaKGaRCEjg&from=groupmessage&isappinstalled=0#wechat_redirect)\n4. [Android 视频播放总结](http://blog.qiji.tech/archives/7908)\n\n## 鸡汤\n1. [专业程序员必习：最牛B的编码套路](http://www.cocoachina.com/programmer/20151125/14365.html)\n2. [编程的智慧](http://www.yinwang.org/blog-cn/2015/11/21/programming-philosophy)\n3. [分享一些自己的学习历程和学习建议](http://mp.weixin.qq.com/s?__biz=MzA3MDQ2OTQ3Mw==&mid=2652591829&idx=1&sn=defd4cfb64adc6dfbf0b8c63c7420768&scene=0#wechat_redirect)\n\n## 其他\n1. [音乐随机播放算法](http://blog.csdn.net/asce1885/article/details/7582735)\n2. [GitHub 排名前 100 的安卓、iOS项目简介](http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0524/4297.html)\n3. [一个随机播放的算法](http://www.jianshu.com/p/472fed76690a)\n4. [程序员不可不知的版权协议](http://www.gcssloop.com/tips/choose-license)\n5. [张小龙最新内部演讲：警惕KPI和流程，支持内部轮岗](http://mp.weixin.qq.com/s?__biz=Mjc1NjM3MjY2MA==&mid=2691313899&idx=1&sn=afc65a6b6ca228c7738fd184c9b1c17c&chksm=a9eb8f309e9c062673e47591e8512fee2d3919d60526881c30ae8bf517e41c4e1d47df7e0a10&mpshare=1&scene=1&srcid=1029PNbtw3LymhIHAXZKtrJo#rd)\n","source":"something/index.md","raw":"---\ntitle: 干货\ndate: 2016-03-28 17:55:33\n---\n\n在这个版块中，主要放一些自己觉得不错的文章，方便后面回顾。\n\n会不定期更新。\n\n## Android Studio\n1. [倍数提高工作效率的Android Studio奇技](http://zlv.me/posts/2015/07/13/14_android-studio-tips/)\n2. [如何使用Android Studio把自己的Android library分发到jCenter和Maven Central](http://www.open-open.com/lib/view/open1435109824278.html)\n3. [如何选择 compileSdkVersion, minSdkVersion 和 targetSdkVersion](http://chinagdg.org/2016/01/picking-your-compilesdkversion-minsdkversion-targetsdkversion/)\n4. [Android Studio插件整理](https://ydmmocoo.github.io/2016/06/28/Android-Studio%E6%8F%92%E4%BB%B6%E6%95%B4%E7%90%86/)\n5. [基于Android Studio的内存泄漏检测与解决全攻略](http://wetest.qq.com/lab/view/?id=99)\n6. [Android Studio相见恨晚的操作锦集](http://www.jianshu.com/p/bc8f6bfe12c6)\n7. [50个Android Studio秘诀、技巧和资源](http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&mid=2651112873&idx=1&sn=667188f0f320a4c0550340138783aae3)\n\n## 日常开发\n1. [Android 开发绕不过的坑：你的 Bitmap 究竟占多大内存？](http://bugly.qq.com/bbs/forum.php?mod=viewthread&tid=498&extra=page%3D1)\n2. [Android 中Parcelable接口用法](http://www.cnblogs.com/renqingping/archive/2012/10/25/Parcelable.html)\n3. [那些你应该知道却不一定知道的——View坐标分析汇总](http://blog.csdn.net/mr_immortalz/article/details/51168278)\n4. [那些值得你去细细研究的Drawable适配](http://blog.csdn.net/wrg_20100512/article/details/51295317)\n5. [Android屏幕适配全攻略(最权威的官方适配指导)](http://blog.csdn.net/zhaokaiqiang1992/article/details/45419023)\n6. [安卓开发技术：监听软键盘的显示与隐藏](http://toughcoder.net/blog/2015/10/09/android-trick-detect-soft-keyboard-show-slash-hide/)\n7. [Activity 横竖屏切换](http://www.cnblogs.com/yishujun/p/5395266.html)\n8. [Android 横竖屏切换小结](http://www.cnblogs.com/franksunny/p/3714442.html)\n9. [LeakCanary 中文使用说明](http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/)\n10. [Android 基础 VideoView](http://www.jianshu.com/p/2d3b221a2ee7)\n11. [Android 单元测试之Mockito浅析](http://hlong.xyz/2016/06/16/Android%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B9%8BMockito%E6%B5%85%E6%9E%90/)\n12. [关于Adapter的The content of the adapter has changed问题分析](http://www.cnblogs.com/monodin/p/3874147.html)\n13. [Android状态栏微技巧，带你真正理解沉浸式模式](http://blog.csdn.net/guolin_blog/article/details/51763825)\n14. [Java中的自动装箱与拆箱](http://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/)\n15. [掌握 Android 中的 tools 命名空间](http://android.jobbole.com/83207/)\n16. [两分钟理解Android中SP与DP的区别](http://droidyue.com/blog/2016/09/05/dp-vs-sp-in-android/)\n17. [Android 6.0 运行时权限管理最佳实践](http://blog.csdn.net/yanzhenjie1003/article/details/52503533)\n18. [Android ListView与RecyclerView对比浅析--缓存机制](http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=2649286405&idx=1&sn=414e2d2eb577884ccee5c9076e8b8357&chksm=8334c387b4434a9124f5acd93f331968a44256b8374eeafb4b1857671072b3b6364e5ec38485&scene=0#rd)\n19. [Android 开发之 App 启动时间统计](http://www.jianshu.com/p/c967653a9468?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)\n20. [单播，组播(多播)，广播以及任播](http://colobu.com/2014/10/21/udp-and-unicast-multicast-broadcast-anycast/)\n21. [Android 爬坑之旅：软键盘挡住输入框问题的终极解决方案](http://www.diycode.cc/topics/383)\n22. [写给Android开发者的混淆使用手册](http://www.jianshu.com/p/158aa484da13)\n23. [Android 内存泄漏分析心得](http://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&mid=2649796884&idx=1&sn=92b4e344060362128e4a86d6132c3736)\n\n## 框架设计\n1. [Android MVP 详解（上）](http://www.jianshu.com/p/9a6845b26856)\n2. [Android MVP 详解（下）](http://www.jianshu.com/p/0590f530c617)\n3. [Android App的设计架构：MVC,MVP,MVVM与架构经验谈](https://www.sdk.cn/news/2501)\n4. [Android 编码规范](http://www.jianshu.com/p/0a984f999592)\n5. [一步一步实现Android的MVP框架](http://dev.qq.com/topic/5799d7844bef22a823b3ad44)\n\n## 技术学习\n1. [Android Vector曲折的兼容之路](http://www.jianshu.com/p/e3614e7abc03)\n2. [关于 Android 进程保活，你所需要知道的一切](http://www.jianshu.com/p/63aafe3c12af#)\n3. [Android 应用性能剖析全攻略](http://toughcoder.net/blog/2015/09/11/android-performance-profiling-made-easy/)\n4. [Android 客户端性能优化](http://blog.tingyun.com/web/article/detail/155)\n5. [开发第三方库最佳实践](http://www.jianshu.com/p/0aacd419cb7e)\n6. [Android 自动清理无用资源工具](http://blog.csdn.net/honjane/article/details/41351183)\n7. [Android 内存泄漏的八种可能](http://www.jianshu.com/p/ac00e370f83d?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)\n8. [阿里Weex框架Android平台初体验](http://smilevenus.com/2016/07/03/%E9%98%BF%E9%87%8CWeex%E6%A1%86%E6%9E%B6Android%E5%B9%B3%E5%8F%B0%E5%88%9D%E4%BD%93%E9%AA%8C/)\n9. [与 .so 有关的一个长年大坑](https://zhuanlan.zhihu.com/p/213599847)\n10. [WebSocket 是什么原理？为什么可以实现持久连接？](https://www.zhihu.com/question/20215561/answer/40316953)\n11. [Android 消息处理机制(Handler、Looper、MessageQueue与Message)](http://www.cnblogs.com/angeldevil/p/3340644.html)\n12. [Android 应用进程启动流程](http://www.woaitqs.cc/android/2016/06/21/activity-service.html)\n13. [Android 内存优化之OOM](http://hukai.me/android-performance-oom/)\n14. [PathMeasure之迷径追踪](http://blog.csdn.net/eclipsexys/article/details/51992473)\n15. [Android App国际化](https://mp.weixin.qq.com/s?__biz=MzI1NjEwMTM4OA==&mid=2651232086&idx=1&sn=8894da8393bac3c50c3a93b9bd7f4102&scene=1&srcid=0822olNZUAyrHj8taaARWJFl&key=8dcebf9e179c9f3a14dfaaf49e391fe1723547d2fdd2d25769b9e06df5b19e8356b7533efd7e6c12ba895531f23fdf20&ascene=0&uin=Mjc3OTU3Nzk1&devicetype=iMac+MacBookPro10%2C1+OSX+OSX+10.10.5+build%2814F1909%29&version=11020201&pass_ticket=93ppXY%2FQxuOZivwZLgIhWpNIrGPcMB69uUsPDLQROrzXxXQP47pjLwNhXgvIcZH9)\n16. [Atlas：手淘Native容器化框架和思考](http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&mid=2651112809&idx=1&sn=8d45d8960acde6128b121fb10a6d7bb7&chksm=844c6cb4b33be5a24cd462aa2fa96ce206877e0a87959df9aba03826d6be045dcaf6b9748739&scene=0#rd)\n17. [Android热修复技术选型——三大流派解析](http://mp.weixin.qq.com/s?__biz=MzA4MjA0MTc4NQ==&mid=2651574060&idx=1&sn=5978a774a6f74535497b2643e92fd124&chksm=8474a1fab30328ec012795809482d286d63da557c0efcae066bb0bee62b43a8a2f1dc372ed2b&scene=0#rd)\n18. [Android 深入理解Loader机制 让APP轻装上阵](http://www.jianshu.com/p/385327e35711)\n19. [给 Android 开发者的 RxJava 详解](http://gank.io/post/560e15be2dca930e00da1083)\n20. [大幅提高Android开发效率之Android项目模板化（上）](http://www.jianshu.com/p/e8ac0c284601/comments/5435137#comment-5435137)\n21. [ReactiveX/RxJava文档中文版](https://mcxiaoke.gitbooks.io/rxdocs/content/)\n22. [RxJava系列1(简介)](https://zhuanlan.zhihu.com/p/20687178)\n\n## 音视频专题\n1. [雷霄骅(leixiaohua1020)的专栏](http://blog.csdn.net/leixiaohua1020?viewmode=contents)\n2. [Jhuster的专栏](https://zhuanlan.zhihu.com/jhuster)\n3. [移动直播技术秒开优化经验](http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=2653547042&idx=1&sn=26d8728548a6b5b657079eeab121e283&scene=1&srcid=0428msEitG9LJ3JaKGaRCEjg&from=groupmessage&isappinstalled=0#wechat_redirect)\n4. [Android 视频播放总结](http://blog.qiji.tech/archives/7908)\n\n## 鸡汤\n1. [专业程序员必习：最牛B的编码套路](http://www.cocoachina.com/programmer/20151125/14365.html)\n2. [编程的智慧](http://www.yinwang.org/blog-cn/2015/11/21/programming-philosophy)\n3. [分享一些自己的学习历程和学习建议](http://mp.weixin.qq.com/s?__biz=MzA3MDQ2OTQ3Mw==&mid=2652591829&idx=1&sn=defd4cfb64adc6dfbf0b8c63c7420768&scene=0#wechat_redirect)\n\n## 其他\n1. [音乐随机播放算法](http://blog.csdn.net/asce1885/article/details/7582735)\n2. [GitHub 排名前 100 的安卓、iOS项目简介](http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0524/4297.html)\n3. [一个随机播放的算法](http://www.jianshu.com/p/472fed76690a)\n4. [程序员不可不知的版权协议](http://www.gcssloop.com/tips/choose-license)\n5. [张小龙最新内部演讲：警惕KPI和流程，支持内部轮岗](http://mp.weixin.qq.com/s?__biz=Mjc1NjM3MjY2MA==&mid=2691313899&idx=1&sn=afc65a6b6ca228c7738fd184c9b1c17c&chksm=a9eb8f309e9c062673e47591e8512fee2d3919d60526881c30ae8bf517e41c4e1d47df7e0a10&mpshare=1&scene=1&srcid=1029PNbtw3LymhIHAXZKtrJo#rd)\n","updated":"2016-11-25T06:28:37.516Z","path":"something/index.html","comments":1,"layout":"page","_id":"ciw3e757z00061cb8wme25q6e","content":"<p>在这个版块中，主要放一些自己觉得不错的文章，方便后面回顾。</p>\n<p>会不定期更新。</p>\n<h2 id=\"Android-Studio\"><a href=\"#Android-Studio\" class=\"headerlink\" title=\"Android Studio\"></a>Android Studio</h2><ol>\n<li><a href=\"http://zlv.me/posts/2015/07/13/14_android-studio-tips/\" target=\"_blank\" rel=\"external\">倍数提高工作效率的Android Studio奇技</a></li>\n<li><a href=\"http://www.open-open.com/lib/view/open1435109824278.html\" target=\"_blank\" rel=\"external\">如何使用Android Studio把自己的Android library分发到jCenter和Maven Central</a></li>\n<li><a href=\"http://chinagdg.org/2016/01/picking-your-compilesdkversion-minsdkversion-targetsdkversion/\" target=\"_blank\" rel=\"external\">如何选择 compileSdkVersion, minSdkVersion 和 targetSdkVersion</a></li>\n<li><a href=\"https://ydmmocoo.github.io/2016/06/28/Android-Studio%E6%8F%92%E4%BB%B6%E6%95%B4%E7%90%86/\" target=\"_blank\" rel=\"external\">Android Studio插件整理</a></li>\n<li><a href=\"http://wetest.qq.com/lab/view/?id=99\" target=\"_blank\" rel=\"external\">基于Android Studio的内存泄漏检测与解决全攻略</a></li>\n<li><a href=\"http://www.jianshu.com/p/bc8f6bfe12c6\" target=\"_blank\" rel=\"external\">Android Studio相见恨晚的操作锦集</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&amp;mid=2651112873&amp;idx=1&amp;sn=667188f0f320a4c0550340138783aae3\" target=\"_blank\" rel=\"external\">50个Android Studio秘诀、技巧和资源</a></li>\n</ol>\n<h2 id=\"日常开发\"><a href=\"#日常开发\" class=\"headerlink\" title=\"日常开发\"></a>日常开发</h2><ol>\n<li><a href=\"http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=498&amp;extra=page%3D1\" target=\"_blank\" rel=\"external\">Android 开发绕不过的坑：你的 Bitmap 究竟占多大内存？</a></li>\n<li><a href=\"http://www.cnblogs.com/renqingping/archive/2012/10/25/Parcelable.html\" target=\"_blank\" rel=\"external\">Android 中Parcelable接口用法</a></li>\n<li><a href=\"http://blog.csdn.net/mr_immortalz/article/details/51168278\" target=\"_blank\" rel=\"external\">那些你应该知道却不一定知道的——View坐标分析汇总</a></li>\n<li><a href=\"http://blog.csdn.net/wrg_20100512/article/details/51295317\" target=\"_blank\" rel=\"external\">那些值得你去细细研究的Drawable适配</a></li>\n<li><a href=\"http://blog.csdn.net/zhaokaiqiang1992/article/details/45419023\" target=\"_blank\" rel=\"external\">Android屏幕适配全攻略(最权威的官方适配指导)</a></li>\n<li><a href=\"http://toughcoder.net/blog/2015/10/09/android-trick-detect-soft-keyboard-show-slash-hide/\" target=\"_blank\" rel=\"external\">安卓开发技术：监听软键盘的显示与隐藏</a></li>\n<li><a href=\"http://www.cnblogs.com/yishujun/p/5395266.html\" target=\"_blank\" rel=\"external\">Activity 横竖屏切换</a></li>\n<li><a href=\"http://www.cnblogs.com/franksunny/p/3714442.html\" target=\"_blank\" rel=\"external\">Android 横竖屏切换小结</a></li>\n<li><a href=\"http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/\" target=\"_blank\" rel=\"external\">LeakCanary 中文使用说明</a></li>\n<li><a href=\"http://www.jianshu.com/p/2d3b221a2ee7\" target=\"_blank\" rel=\"external\">Android 基础 VideoView</a></li>\n<li><a href=\"http://hlong.xyz/2016/06/16/Android%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B9%8BMockito%E6%B5%85%E6%9E%90/\" target=\"_blank\" rel=\"external\">Android 单元测试之Mockito浅析</a></li>\n<li><a href=\"http://www.cnblogs.com/monodin/p/3874147.html\" target=\"_blank\" rel=\"external\">关于Adapter的The content of the adapter has changed问题分析</a></li>\n<li><a href=\"http://blog.csdn.net/guolin_blog/article/details/51763825\" target=\"_blank\" rel=\"external\">Android状态栏微技巧，带你真正理解沉浸式模式</a></li>\n<li><a href=\"http://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/\" target=\"_blank\" rel=\"external\">Java中的自动装箱与拆箱</a></li>\n<li><a href=\"http://android.jobbole.com/83207/\" target=\"_blank\" rel=\"external\">掌握 Android 中的 tools 命名空间</a></li>\n<li><a href=\"http://droidyue.com/blog/2016/09/05/dp-vs-sp-in-android/\" target=\"_blank\" rel=\"external\">两分钟理解Android中SP与DP的区别</a></li>\n<li><a href=\"http://blog.csdn.net/yanzhenjie1003/article/details/52503533\" target=\"_blank\" rel=\"external\">Android 6.0 运行时权限管理最佳实践</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286405&amp;idx=1&amp;sn=414e2d2eb577884ccee5c9076e8b8357&amp;chksm=8334c387b4434a9124f5acd93f331968a44256b8374eeafb4b1857671072b3b6364e5ec38485&amp;scene=0#rd\" target=\"_blank\" rel=\"external\">Android ListView与RecyclerView对比浅析–缓存机制</a></li>\n<li><a href=\"http://www.jianshu.com/p/c967653a9468?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\" target=\"_blank\" rel=\"external\">Android 开发之 App 启动时间统计</a></li>\n<li><a href=\"http://colobu.com/2014/10/21/udp-and-unicast-multicast-broadcast-anycast/\" target=\"_blank\" rel=\"external\">单播，组播(多播)，广播以及任播</a></li>\n<li><a href=\"http://www.diycode.cc/topics/383\" target=\"_blank\" rel=\"external\">Android 爬坑之旅：软键盘挡住输入框问题的终极解决方案</a></li>\n<li><a href=\"http://www.jianshu.com/p/158aa484da13\" target=\"_blank\" rel=\"external\">写给Android开发者的混淆使用手册</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=2649796884&amp;idx=1&amp;sn=92b4e344060362128e4a86d6132c3736\" target=\"_blank\" rel=\"external\">Android 内存泄漏分析心得</a></li>\n</ol>\n<h2 id=\"框架设计\"><a href=\"#框架设计\" class=\"headerlink\" title=\"框架设计\"></a>框架设计</h2><ol>\n<li><a href=\"http://www.jianshu.com/p/9a6845b26856\" target=\"_blank\" rel=\"external\">Android MVP 详解（上）</a></li>\n<li><a href=\"http://www.jianshu.com/p/0590f530c617\" target=\"_blank\" rel=\"external\">Android MVP 详解（下）</a></li>\n<li><a href=\"https://www.sdk.cn/news/2501\" target=\"_blank\" rel=\"external\">Android App的设计架构：MVC,MVP,MVVM与架构经验谈</a></li>\n<li><a href=\"http://www.jianshu.com/p/0a984f999592\" target=\"_blank\" rel=\"external\">Android 编码规范</a></li>\n<li><a href=\"http://dev.qq.com/topic/5799d7844bef22a823b3ad44\" target=\"_blank\" rel=\"external\">一步一步实现Android的MVP框架</a></li>\n</ol>\n<h2 id=\"技术学习\"><a href=\"#技术学习\" class=\"headerlink\" title=\"技术学习\"></a>技术学习</h2><ol>\n<li><a href=\"http://www.jianshu.com/p/e3614e7abc03\" target=\"_blank\" rel=\"external\">Android Vector曲折的兼容之路</a></li>\n<li><a href=\"http://www.jianshu.com/p/63aafe3c12af#\" target=\"_blank\" rel=\"external\">关于 Android 进程保活，你所需要知道的一切</a></li>\n<li><a href=\"http://toughcoder.net/blog/2015/09/11/android-performance-profiling-made-easy/\" target=\"_blank\" rel=\"external\">Android 应用性能剖析全攻略</a></li>\n<li><a href=\"http://blog.tingyun.com/web/article/detail/155\" target=\"_blank\" rel=\"external\">Android 客户端性能优化</a></li>\n<li><a href=\"http://www.jianshu.com/p/0aacd419cb7e\" target=\"_blank\" rel=\"external\">开发第三方库最佳实践</a></li>\n<li><a href=\"http://blog.csdn.net/honjane/article/details/41351183\" target=\"_blank\" rel=\"external\">Android 自动清理无用资源工具</a></li>\n<li><a href=\"http://www.jianshu.com/p/ac00e370f83d?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\" target=\"_blank\" rel=\"external\">Android 内存泄漏的八种可能</a></li>\n<li><a href=\"http://smilevenus.com/2016/07/03/%E9%98%BF%E9%87%8CWeex%E6%A1%86%E6%9E%B6Android%E5%B9%B3%E5%8F%B0%E5%88%9D%E4%BD%93%E9%AA%8C/\" target=\"_blank\" rel=\"external\">阿里Weex框架Android平台初体验</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/213599847\" target=\"_blank\" rel=\"external\">与 .so 有关的一个长年大坑</a></li>\n<li><a href=\"https://www.zhihu.com/question/20215561/answer/40316953\" target=\"_blank\" rel=\"external\">WebSocket 是什么原理？为什么可以实现持久连接？</a></li>\n<li><a href=\"http://www.cnblogs.com/angeldevil/p/3340644.html\" target=\"_blank\" rel=\"external\">Android 消息处理机制(Handler、Looper、MessageQueue与Message)</a></li>\n<li><a href=\"http://www.woaitqs.cc/android/2016/06/21/activity-service.html\" target=\"_blank\" rel=\"external\">Android 应用进程启动流程</a></li>\n<li><a href=\"http://hukai.me/android-performance-oom/\" target=\"_blank\" rel=\"external\">Android 内存优化之OOM</a></li>\n<li><a href=\"http://blog.csdn.net/eclipsexys/article/details/51992473\" target=\"_blank\" rel=\"external\">PathMeasure之迷径追踪</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI1NjEwMTM4OA==&amp;mid=2651232086&amp;idx=1&amp;sn=8894da8393bac3c50c3a93b9bd7f4102&amp;scene=1&amp;srcid=0822olNZUAyrHj8taaARWJFl&amp;key=8dcebf9e179c9f3a14dfaaf49e391fe1723547d2fdd2d25769b9e06df5b19e8356b7533efd7e6c12ba895531f23fdf20&amp;ascene=0&amp;uin=Mjc3OTU3Nzk1&amp;devicetype=iMac+MacBookPro10%2C1+OSX+OSX+10.10.5+build%2814F1909%29&amp;version=11020201&amp;pass_ticket=93ppXY%2FQxuOZivwZLgIhWpNIrGPcMB69uUsPDLQROrzXxXQP47pjLwNhXgvIcZH9\" target=\"_blank\" rel=\"external\">Android App国际化</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&amp;mid=2651112809&amp;idx=1&amp;sn=8d45d8960acde6128b121fb10a6d7bb7&amp;chksm=844c6cb4b33be5a24cd462aa2fa96ce206877e0a87959df9aba03826d6be045dcaf6b9748739&amp;scene=0#rd\" target=\"_blank\" rel=\"external\">Atlas：手淘Native容器化框架和思考</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzA4MjA0MTc4NQ==&amp;mid=2651574060&amp;idx=1&amp;sn=5978a774a6f74535497b2643e92fd124&amp;chksm=8474a1fab30328ec012795809482d286d63da557c0efcae066bb0bee62b43a8a2f1dc372ed2b&amp;scene=0#rd\" target=\"_blank\" rel=\"external\">Android热修复技术选型——三大流派解析</a></li>\n<li><a href=\"http://www.jianshu.com/p/385327e35711\" target=\"_blank\" rel=\"external\">Android 深入理解Loader机制 让APP轻装上阵</a></li>\n<li><a href=\"http://gank.io/post/560e15be2dca930e00da1083\" target=\"_blank\" rel=\"external\">给 Android 开发者的 RxJava 详解</a></li>\n<li><a href=\"http://www.jianshu.com/p/e8ac0c284601/comments/5435137#comment-5435137\" target=\"_blank\" rel=\"external\">大幅提高Android开发效率之Android项目模板化（上）</a></li>\n<li><a href=\"https://mcxiaoke.gitbooks.io/rxdocs/content/\" target=\"_blank\" rel=\"external\">ReactiveX/RxJava文档中文版</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/20687178\" target=\"_blank\" rel=\"external\">RxJava系列1(简介)</a></li>\n</ol>\n<h2 id=\"音视频专题\"><a href=\"#音视频专题\" class=\"headerlink\" title=\"音视频专题\"></a>音视频专题</h2><ol>\n<li><a href=\"http://blog.csdn.net/leixiaohua1020?viewmode=contents\" target=\"_blank\" rel=\"external\">雷霄骅(leixiaohua1020)的专栏</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/jhuster\" target=\"_blank\" rel=\"external\">Jhuster的专栏</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653547042&amp;idx=1&amp;sn=26d8728548a6b5b657079eeab121e283&amp;scene=1&amp;srcid=0428msEitG9LJ3JaKGaRCEjg&amp;from=groupmessage&amp;isappinstalled=0#wechat_redirect\" target=\"_blank\" rel=\"external\">移动直播技术秒开优化经验</a></li>\n<li><a href=\"http://blog.qiji.tech/archives/7908\" target=\"_blank\" rel=\"external\">Android 视频播放总结</a></li>\n</ol>\n<h2 id=\"鸡汤\"><a href=\"#鸡汤\" class=\"headerlink\" title=\"鸡汤\"></a>鸡汤</h2><ol>\n<li><a href=\"http://www.cocoachina.com/programmer/20151125/14365.html\" target=\"_blank\" rel=\"external\">专业程序员必习：最牛B的编码套路</a></li>\n<li><a href=\"http://www.yinwang.org/blog-cn/2015/11/21/programming-philosophy\" target=\"_blank\" rel=\"external\">编程的智慧</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzA3MDQ2OTQ3Mw==&amp;mid=2652591829&amp;idx=1&amp;sn=defd4cfb64adc6dfbf0b8c63c7420768&amp;scene=0#wechat_redirect\" target=\"_blank\" rel=\"external\">分享一些自己的学习历程和学习建议</a></li>\n</ol>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><ol>\n<li><a href=\"http://blog.csdn.net/asce1885/article/details/7582735\" target=\"_blank\" rel=\"external\">音乐随机播放算法</a></li>\n<li><a href=\"http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0524/4297.html\" target=\"_blank\" rel=\"external\">GitHub 排名前 100 的安卓、iOS项目简介</a></li>\n<li><a href=\"http://www.jianshu.com/p/472fed76690a\" target=\"_blank\" rel=\"external\">一个随机播放的算法</a></li>\n<li><a href=\"http://www.gcssloop.com/tips/choose-license\" target=\"_blank\" rel=\"external\">程序员不可不知的版权协议</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=Mjc1NjM3MjY2MA==&amp;mid=2691313899&amp;idx=1&amp;sn=afc65a6b6ca228c7738fd184c9b1c17c&amp;chksm=a9eb8f309e9c062673e47591e8512fee2d3919d60526881c30ae8bf517e41c4e1d47df7e0a10&amp;mpshare=1&amp;scene=1&amp;srcid=1029PNbtw3LymhIHAXZKtrJo#rd\" target=\"_blank\" rel=\"external\">张小龙最新内部演讲：警惕KPI和流程，支持内部轮岗</a></li>\n</ol>\n","excerpt":"","more":"<p>在这个版块中，主要放一些自己觉得不错的文章，方便后面回顾。</p>\n<p>会不定期更新。</p>\n<h2 id=\"Android-Studio\"><a href=\"#Android-Studio\" class=\"headerlink\" title=\"Android Studio\"></a>Android Studio</h2><ol>\n<li><a href=\"http://zlv.me/posts/2015/07/13/14_android-studio-tips/\">倍数提高工作效率的Android Studio奇技</a></li>\n<li><a href=\"http://www.open-open.com/lib/view/open1435109824278.html\">如何使用Android Studio把自己的Android library分发到jCenter和Maven Central</a></li>\n<li><a href=\"http://chinagdg.org/2016/01/picking-your-compilesdkversion-minsdkversion-targetsdkversion/\">如何选择 compileSdkVersion, minSdkVersion 和 targetSdkVersion</a></li>\n<li><a href=\"https://ydmmocoo.github.io/2016/06/28/Android-Studio%E6%8F%92%E4%BB%B6%E6%95%B4%E7%90%86/\">Android Studio插件整理</a></li>\n<li><a href=\"http://wetest.qq.com/lab/view/?id=99\">基于Android Studio的内存泄漏检测与解决全攻略</a></li>\n<li><a href=\"http://www.jianshu.com/p/bc8f6bfe12c6\">Android Studio相见恨晚的操作锦集</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&amp;mid=2651112873&amp;idx=1&amp;sn=667188f0f320a4c0550340138783aae3\">50个Android Studio秘诀、技巧和资源</a></li>\n</ol>\n<h2 id=\"日常开发\"><a href=\"#日常开发\" class=\"headerlink\" title=\"日常开发\"></a>日常开发</h2><ol>\n<li><a href=\"http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=498&amp;extra=page%3D1\">Android 开发绕不过的坑：你的 Bitmap 究竟占多大内存？</a></li>\n<li><a href=\"http://www.cnblogs.com/renqingping/archive/2012/10/25/Parcelable.html\">Android 中Parcelable接口用法</a></li>\n<li><a href=\"http://blog.csdn.net/mr_immortalz/article/details/51168278\">那些你应该知道却不一定知道的——View坐标分析汇总</a></li>\n<li><a href=\"http://blog.csdn.net/wrg_20100512/article/details/51295317\">那些值得你去细细研究的Drawable适配</a></li>\n<li><a href=\"http://blog.csdn.net/zhaokaiqiang1992/article/details/45419023\">Android屏幕适配全攻略(最权威的官方适配指导)</a></li>\n<li><a href=\"http://toughcoder.net/blog/2015/10/09/android-trick-detect-soft-keyboard-show-slash-hide/\">安卓开发技术：监听软键盘的显示与隐藏</a></li>\n<li><a href=\"http://www.cnblogs.com/yishujun/p/5395266.html\">Activity 横竖屏切换</a></li>\n<li><a href=\"http://www.cnblogs.com/franksunny/p/3714442.html\">Android 横竖屏切换小结</a></li>\n<li><a href=\"http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/\">LeakCanary 中文使用说明</a></li>\n<li><a href=\"http://www.jianshu.com/p/2d3b221a2ee7\">Android 基础 VideoView</a></li>\n<li><a href=\"http://hlong.xyz/2016/06/16/Android%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B9%8BMockito%E6%B5%85%E6%9E%90/\">Android 单元测试之Mockito浅析</a></li>\n<li><a href=\"http://www.cnblogs.com/monodin/p/3874147.html\">关于Adapter的The content of the adapter has changed问题分析</a></li>\n<li><a href=\"http://blog.csdn.net/guolin_blog/article/details/51763825\">Android状态栏微技巧，带你真正理解沉浸式模式</a></li>\n<li><a href=\"http://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/\">Java中的自动装箱与拆箱</a></li>\n<li><a href=\"http://android.jobbole.com/83207/\">掌握 Android 中的 tools 命名空间</a></li>\n<li><a href=\"http://droidyue.com/blog/2016/09/05/dp-vs-sp-in-android/\">两分钟理解Android中SP与DP的区别</a></li>\n<li><a href=\"http://blog.csdn.net/yanzhenjie1003/article/details/52503533\">Android 6.0 运行时权限管理最佳实践</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286405&amp;idx=1&amp;sn=414e2d2eb577884ccee5c9076e8b8357&amp;chksm=8334c387b4434a9124f5acd93f331968a44256b8374eeafb4b1857671072b3b6364e5ec38485&amp;scene=0#rd\">Android ListView与RecyclerView对比浅析–缓存机制</a></li>\n<li><a href=\"http://www.jianshu.com/p/c967653a9468?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\">Android 开发之 App 启动时间统计</a></li>\n<li><a href=\"http://colobu.com/2014/10/21/udp-and-unicast-multicast-broadcast-anycast/\">单播，组播(多播)，广播以及任播</a></li>\n<li><a href=\"http://www.diycode.cc/topics/383\">Android 爬坑之旅：软键盘挡住输入框问题的终极解决方案</a></li>\n<li><a href=\"http://www.jianshu.com/p/158aa484da13\">写给Android开发者的混淆使用手册</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&amp;mid=2649796884&amp;idx=1&amp;sn=92b4e344060362128e4a86d6132c3736\">Android 内存泄漏分析心得</a></li>\n</ol>\n<h2 id=\"框架设计\"><a href=\"#框架设计\" class=\"headerlink\" title=\"框架设计\"></a>框架设计</h2><ol>\n<li><a href=\"http://www.jianshu.com/p/9a6845b26856\">Android MVP 详解（上）</a></li>\n<li><a href=\"http://www.jianshu.com/p/0590f530c617\">Android MVP 详解（下）</a></li>\n<li><a href=\"https://www.sdk.cn/news/2501\">Android App的设计架构：MVC,MVP,MVVM与架构经验谈</a></li>\n<li><a href=\"http://www.jianshu.com/p/0a984f999592\">Android 编码规范</a></li>\n<li><a href=\"http://dev.qq.com/topic/5799d7844bef22a823b3ad44\">一步一步实现Android的MVP框架</a></li>\n</ol>\n<h2 id=\"技术学习\"><a href=\"#技术学习\" class=\"headerlink\" title=\"技术学习\"></a>技术学习</h2><ol>\n<li><a href=\"http://www.jianshu.com/p/e3614e7abc03\">Android Vector曲折的兼容之路</a></li>\n<li><a href=\"http://www.jianshu.com/p/63aafe3c12af#\">关于 Android 进程保活，你所需要知道的一切</a></li>\n<li><a href=\"http://toughcoder.net/blog/2015/09/11/android-performance-profiling-made-easy/\">Android 应用性能剖析全攻略</a></li>\n<li><a href=\"http://blog.tingyun.com/web/article/detail/155\">Android 客户端性能优化</a></li>\n<li><a href=\"http://www.jianshu.com/p/0aacd419cb7e\">开发第三方库最佳实践</a></li>\n<li><a href=\"http://blog.csdn.net/honjane/article/details/41351183\">Android 自动清理无用资源工具</a></li>\n<li><a href=\"http://www.jianshu.com/p/ac00e370f83d?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io\">Android 内存泄漏的八种可能</a></li>\n<li><a href=\"http://smilevenus.com/2016/07/03/%E9%98%BF%E9%87%8CWeex%E6%A1%86%E6%9E%B6Android%E5%B9%B3%E5%8F%B0%E5%88%9D%E4%BD%93%E9%AA%8C/\">阿里Weex框架Android平台初体验</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/213599847\">与 .so 有关的一个长年大坑</a></li>\n<li><a href=\"https://www.zhihu.com/question/20215561/answer/40316953\">WebSocket 是什么原理？为什么可以实现持久连接？</a></li>\n<li><a href=\"http://www.cnblogs.com/angeldevil/p/3340644.html\">Android 消息处理机制(Handler、Looper、MessageQueue与Message)</a></li>\n<li><a href=\"http://www.woaitqs.cc/android/2016/06/21/activity-service.html\">Android 应用进程启动流程</a></li>\n<li><a href=\"http://hukai.me/android-performance-oom/\">Android 内存优化之OOM</a></li>\n<li><a href=\"http://blog.csdn.net/eclipsexys/article/details/51992473\">PathMeasure之迷径追踪</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=MzI1NjEwMTM4OA==&amp;mid=2651232086&amp;idx=1&amp;sn=8894da8393bac3c50c3a93b9bd7f4102&amp;scene=1&amp;srcid=0822olNZUAyrHj8taaARWJFl&amp;key=8dcebf9e179c9f3a14dfaaf49e391fe1723547d2fdd2d25769b9e06df5b19e8356b7533efd7e6c12ba895531f23fdf20&amp;ascene=0&amp;uin=Mjc3OTU3Nzk1&amp;devicetype=iMac+MacBookPro10%2C1+OSX+OSX+10.10.5+build%2814F1909%29&amp;version=11020201&amp;pass_ticket=93ppXY%2FQxuOZivwZLgIhWpNIrGPcMB69uUsPDLQROrzXxXQP47pjLwNhXgvIcZH9\">Android App国际化</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&amp;mid=2651112809&amp;idx=1&amp;sn=8d45d8960acde6128b121fb10a6d7bb7&amp;chksm=844c6cb4b33be5a24cd462aa2fa96ce206877e0a87959df9aba03826d6be045dcaf6b9748739&amp;scene=0#rd\">Atlas：手淘Native容器化框架和思考</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzA4MjA0MTc4NQ==&amp;mid=2651574060&amp;idx=1&amp;sn=5978a774a6f74535497b2643e92fd124&amp;chksm=8474a1fab30328ec012795809482d286d63da557c0efcae066bb0bee62b43a8a2f1dc372ed2b&amp;scene=0#rd\">Android热修复技术选型——三大流派解析</a></li>\n<li><a href=\"http://www.jianshu.com/p/385327e35711\">Android 深入理解Loader机制 让APP轻装上阵</a></li>\n<li><a href=\"http://gank.io/post/560e15be2dca930e00da1083\">给 Android 开发者的 RxJava 详解</a></li>\n<li><a href=\"http://www.jianshu.com/p/e8ac0c284601/comments/5435137#comment-5435137\">大幅提高Android开发效率之Android项目模板化（上）</a></li>\n<li><a href=\"https://mcxiaoke.gitbooks.io/rxdocs/content/\">ReactiveX/RxJava文档中文版</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/20687178\">RxJava系列1(简介)</a></li>\n</ol>\n<h2 id=\"音视频专题\"><a href=\"#音视频专题\" class=\"headerlink\" title=\"音视频专题\"></a>音视频专题</h2><ol>\n<li><a href=\"http://blog.csdn.net/leixiaohua1020?viewmode=contents\">雷霄骅(leixiaohua1020)的专栏</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/jhuster\">Jhuster的专栏</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653547042&amp;idx=1&amp;sn=26d8728548a6b5b657079eeab121e283&amp;scene=1&amp;srcid=0428msEitG9LJ3JaKGaRCEjg&amp;from=groupmessage&amp;isappinstalled=0#wechat_redirect\">移动直播技术秒开优化经验</a></li>\n<li><a href=\"http://blog.qiji.tech/archives/7908\">Android 视频播放总结</a></li>\n</ol>\n<h2 id=\"鸡汤\"><a href=\"#鸡汤\" class=\"headerlink\" title=\"鸡汤\"></a>鸡汤</h2><ol>\n<li><a href=\"http://www.cocoachina.com/programmer/20151125/14365.html\">专业程序员必习：最牛B的编码套路</a></li>\n<li><a href=\"http://www.yinwang.org/blog-cn/2015/11/21/programming-philosophy\">编程的智慧</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=MzA3MDQ2OTQ3Mw==&amp;mid=2652591829&amp;idx=1&amp;sn=defd4cfb64adc6dfbf0b8c63c7420768&amp;scene=0#wechat_redirect\">分享一些自己的学习历程和学习建议</a></li>\n</ol>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><ol>\n<li><a href=\"http://blog.csdn.net/asce1885/article/details/7582735\">音乐随机播放算法</a></li>\n<li><a href=\"http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0524/4297.html\">GitHub 排名前 100 的安卓、iOS项目简介</a></li>\n<li><a href=\"http://www.jianshu.com/p/472fed76690a\">一个随机播放的算法</a></li>\n<li><a href=\"http://www.gcssloop.com/tips/choose-license\">程序员不可不知的版权协议</a></li>\n<li><a href=\"http://mp.weixin.qq.com/s?__biz=Mjc1NjM3MjY2MA==&amp;mid=2691313899&amp;idx=1&amp;sn=afc65a6b6ca228c7738fd184c9b1c17c&amp;chksm=a9eb8f309e9c062673e47591e8512fee2d3919d60526881c30ae8bf517e41c4e1d47df7e0a10&amp;mpshare=1&amp;scene=1&amp;srcid=1029PNbtw3LymhIHAXZKtrJo#rd\">张小龙最新内部演讲：警惕KPI和流程，支持内部轮岗</a></li>\n</ol>\n"}],"Post":[{"title":"熟悉OS X系统","date":"2016-11-28T08:01:18.000Z","_content":"\n等了一个星期，公司配备的iMac总算是到了，今天装上后体验了一下，有很多地方还是很不习惯，后面需要慢慢适应，这里列几点感悟。\n\n<!-- more -->\n\n## Finder\nFinder便是类似Windows中的文件管理器了吧，只不过OS X不分什么C、D、E、F盘什么的，感觉就是只有简单的几个分类：应用程序、下载、桌面、文稿。同事说有什么东西全部往桌面丢就行了，也不知是真是假。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx1.jpg)\n\n## 鼠标\n打开系统偏好设置，选择鼠标项，会有一些设置，还有一些手势，在你打钩后边能生效，也是类似Mackbook的一些手势，方便做一些操作。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx2.jpg)\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx3.jpg)\n\n## Mission Control\nMission Control会提供一个所有已打开的窗口、桌面空间、全屏应用和Split View空间的鸟瞰图，让你能轻松在它们之间进行切换。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx5.png)\n\n## 触摸角\n打开系统偏好设置，选择Mission Control项，左下角会有触摸角的设置。当把鼠标移到屏幕的角落的时候可以触发一些操作，4个角可以设置4个操作。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx4.jpg)\n\n## App Store\n这个就是苹果软件商店了，没什么好说的。需要安装QQ、微信、Xcode等软件直接在里面搜索后购买就行了。购买的时候是需要绑定Apple ID的，这个直接绑定就好了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx7.jpg)\n\n## 终端\n后续的日常开发肯定离不开终端，例如查看Git版本。按下``Command + Space``可以出现``spotlight``搜索，输入``terminal``回车即可运行终端。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx6.jpg)\n\n## 常用快捷键\n首先了解下符号与按键的对应关系\n1. Command ⌘\n2. Shift ⇧\n3. Option ⌥\n4. Control ⌃\n5. Caps Lock ⇪\n6. Fn\n\n\n| 快捷键     | 描述 |\n| ------------ | ------------ |\n|Command-X|\t剪切：删除所选项并将其拷贝到剪贴板。|\n|Command-C|\t将所选项拷贝到剪贴板。这同样适用于 Finder 中的文件。|\n|Command-V|\t将剪贴板的内容粘贴到当前文稿或 app 中。这同样适用于 Finder 中的文件。|\n|Command-Z|\t撤销前一个命令。随后您可以按 Command-Shift-Z 来重做，从而反向执行撤销命令。在某些 app 中，您可以撤销和重做多个命令。|\n|Command-A|\t全选各项。|\n|Command-F|\t查找：打开“查找”窗口，或在文稿中查找项目。|\n|Command-G|\t再次查找：查找之前所找到项目出现的下一个位置。要查找出现的上一个位置，请按 Command-Shift-G。|\n|Command-H|\t隐藏最前面的 app 的窗口。要查看最前面的 app 但隐藏所有其他 app，请按 Command-Option-H。|\n|Command-M|\t将最前面的窗口最小化至 Dock。要最小化最前面的 app 的所有窗口，请按 Command-Option-M。|\n|Command-N|\t新建：打开一个新文稿或窗口。|\n|Command-O|\t打开所选项，或打开一个对话框以选择要打开的文件。|\n|Command-P|\t打印当前文稿。|\n|Command-S|\t存储当前文稿。|\n|Command-W|\t关闭最前面的窗口。要关闭该 app 的所有窗口，请按 Command-Option-W。|\n|Command-Q|\t退出 app。|\n|Option-Command-Esc|\t强制退出：选择要强制退出的 app。或者，按住 Command-Shift-Option-Esc 3 秒钟来仅强制最前面的 app 退出。|\n|Command–空格键|\tSpotlight：显示或隐藏 Spotlight 搜索栏。要从 Finder 窗口执行 Spotlight 搜索，请按 Command–Option–空格键。如果您使用多个输入源以便用不同的语言键入内容，这些快捷键会更改输入源而非显示 Spotlight。|\n|空格键|\t快速查看：使用快速查看预览所选项。|\n|Command-Tab|\t切换 app：在打开的 app 中切换到下一个最近使用的 app。|\n|Shift-Command-波浪号 (~)|\t切换窗口：切换到最前端应用中下一个最近使用的窗口。|\n|Shift-Command-3|\t屏幕快照：拍摄整个屏幕的屏幕快照。了解更多屏幕快照快捷键。|\n|Command-逗号 (,)|\t偏好设置：打开最前面的 app 的偏好设置。|\n更多快捷键参见[官方文档](https://support.apple.com/zh-cn/HT201236)。\n\n## 最后\n感觉就是各种手势，各种简单的操作定义复杂的操作，极大的节省时间，而且高逼格，以后我也要走上装逼的道路了！\n","source":"_posts/OS-X.md","raw":"---\ntitle: 熟悉OS X系统\ndate: 2016-11-28 16:01:18\ntags:\n - iOS\n---\n\n等了一个星期，公司配备的iMac总算是到了，今天装上后体验了一下，有很多地方还是很不习惯，后面需要慢慢适应，这里列几点感悟。\n\n<!-- more -->\n\n## Finder\nFinder便是类似Windows中的文件管理器了吧，只不过OS X不分什么C、D、E、F盘什么的，感觉就是只有简单的几个分类：应用程序、下载、桌面、文稿。同事说有什么东西全部往桌面丢就行了，也不知是真是假。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx1.jpg)\n\n## 鼠标\n打开系统偏好设置，选择鼠标项，会有一些设置，还有一些手势，在你打钩后边能生效，也是类似Mackbook的一些手势，方便做一些操作。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx2.jpg)\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx3.jpg)\n\n## Mission Control\nMission Control会提供一个所有已打开的窗口、桌面空间、全屏应用和Split View空间的鸟瞰图，让你能轻松在它们之间进行切换。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx5.png)\n\n## 触摸角\n打开系统偏好设置，选择Mission Control项，左下角会有触摸角的设置。当把鼠标移到屏幕的角落的时候可以触发一些操作，4个角可以设置4个操作。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx4.jpg)\n\n## App Store\n这个就是苹果软件商店了，没什么好说的。需要安装QQ、微信、Xcode等软件直接在里面搜索后购买就行了。购买的时候是需要绑定Apple ID的，这个直接绑定就好了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx7.jpg)\n\n## 终端\n后续的日常开发肯定离不开终端，例如查看Git版本。按下``Command + Space``可以出现``spotlight``搜索，输入``terminal``回车即可运行终端。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx6.jpg)\n\n## 常用快捷键\n首先了解下符号与按键的对应关系\n1. Command ⌘\n2. Shift ⇧\n3. Option ⌥\n4. Control ⌃\n5. Caps Lock ⇪\n6. Fn\n\n\n| 快捷键     | 描述 |\n| ------------ | ------------ |\n|Command-X|\t剪切：删除所选项并将其拷贝到剪贴板。|\n|Command-C|\t将所选项拷贝到剪贴板。这同样适用于 Finder 中的文件。|\n|Command-V|\t将剪贴板的内容粘贴到当前文稿或 app 中。这同样适用于 Finder 中的文件。|\n|Command-Z|\t撤销前一个命令。随后您可以按 Command-Shift-Z 来重做，从而反向执行撤销命令。在某些 app 中，您可以撤销和重做多个命令。|\n|Command-A|\t全选各项。|\n|Command-F|\t查找：打开“查找”窗口，或在文稿中查找项目。|\n|Command-G|\t再次查找：查找之前所找到项目出现的下一个位置。要查找出现的上一个位置，请按 Command-Shift-G。|\n|Command-H|\t隐藏最前面的 app 的窗口。要查看最前面的 app 但隐藏所有其他 app，请按 Command-Option-H。|\n|Command-M|\t将最前面的窗口最小化至 Dock。要最小化最前面的 app 的所有窗口，请按 Command-Option-M。|\n|Command-N|\t新建：打开一个新文稿或窗口。|\n|Command-O|\t打开所选项，或打开一个对话框以选择要打开的文件。|\n|Command-P|\t打印当前文稿。|\n|Command-S|\t存储当前文稿。|\n|Command-W|\t关闭最前面的窗口。要关闭该 app 的所有窗口，请按 Command-Option-W。|\n|Command-Q|\t退出 app。|\n|Option-Command-Esc|\t强制退出：选择要强制退出的 app。或者，按住 Command-Shift-Option-Esc 3 秒钟来仅强制最前面的 app 退出。|\n|Command–空格键|\tSpotlight：显示或隐藏 Spotlight 搜索栏。要从 Finder 窗口执行 Spotlight 搜索，请按 Command–Option–空格键。如果您使用多个输入源以便用不同的语言键入内容，这些快捷键会更改输入源而非显示 Spotlight。|\n|空格键|\t快速查看：使用快速查看预览所选项。|\n|Command-Tab|\t切换 app：在打开的 app 中切换到下一个最近使用的 app。|\n|Shift-Command-波浪号 (~)|\t切换窗口：切换到最前端应用中下一个最近使用的窗口。|\n|Shift-Command-3|\t屏幕快照：拍摄整个屏幕的屏幕快照。了解更多屏幕快照快捷键。|\n|Command-逗号 (,)|\t偏好设置：打开最前面的 app 的偏好设置。|\n更多快捷键参见[官方文档](https://support.apple.com/zh-cn/HT201236)。\n\n## 最后\n感觉就是各种手势，各种简单的操作定义复杂的操作，极大的节省时间，而且高逼格，以后我也要走上装逼的道路了！\n","slug":"OS-X","published":1,"updated":"2016-11-28T09:55:26.151Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e757l00001cb8qntg5ypa","content":"<p>等了一个星期，公司配备的iMac总算是到了，今天装上后体验了一下，有很多地方还是很不习惯，后面需要慢慢适应，这里列几点感悟。</p>\n<a id=\"more\"></a>\n<h2 id=\"Finder\"><a href=\"#Finder\" class=\"headerlink\" title=\"Finder\"></a>Finder</h2><p>Finder便是类似Windows中的文件管理器了吧，只不过OS X不分什么C、D、E、F盘什么的，感觉就是只有简单的几个分类：应用程序、下载、桌面、文稿。同事说有什么东西全部往桌面丢就行了，也不知是真是假。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx1.jpg\" alt=\"\"></p>\n<h2 id=\"鼠标\"><a href=\"#鼠标\" class=\"headerlink\" title=\"鼠标\"></a>鼠标</h2><p>打开系统偏好设置，选择鼠标项，会有一些设置，还有一些手势，在你打钩后边能生效，也是类似Mackbook的一些手势，方便做一些操作。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx2.jpg\" alt=\"\"></p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx3.jpg\" alt=\"\"></p>\n<h2 id=\"Mission-Control\"><a href=\"#Mission-Control\" class=\"headerlink\" title=\"Mission Control\"></a>Mission Control</h2><p>Mission Control会提供一个所有已打开的窗口、桌面空间、全屏应用和Split View空间的鸟瞰图，让你能轻松在它们之间进行切换。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx5.png\" alt=\"\"></p>\n<h2 id=\"触摸角\"><a href=\"#触摸角\" class=\"headerlink\" title=\"触摸角\"></a>触摸角</h2><p>打开系统偏好设置，选择Mission Control项，左下角会有触摸角的设置。当把鼠标移到屏幕的角落的时候可以触发一些操作，4个角可以设置4个操作。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx4.jpg\" alt=\"\"></p>\n<h2 id=\"App-Store\"><a href=\"#App-Store\" class=\"headerlink\" title=\"App Store\"></a>App Store</h2><p>这个就是苹果软件商店了，没什么好说的。需要安装QQ、微信、Xcode等软件直接在里面搜索后购买就行了。购买的时候是需要绑定Apple ID的，这个直接绑定就好了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx7.jpg\" alt=\"\"></p>\n<h2 id=\"终端\"><a href=\"#终端\" class=\"headerlink\" title=\"终端\"></a>终端</h2><p>后续的日常开发肯定离不开终端，例如查看Git版本。按下<code>Command + Space</code>可以出现<code>spotlight</code>搜索，输入<code>terminal</code>回车即可运行终端。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx6.jpg\" alt=\"\"></p>\n<h2 id=\"常用快捷键\"><a href=\"#常用快捷键\" class=\"headerlink\" title=\"常用快捷键\"></a>常用快捷键</h2><p>首先了解下符号与按键的对应关系</p>\n<ol>\n<li>Command ⌘</li>\n<li>Shift ⇧</li>\n<li>Option ⌥</li>\n<li>Control ⌃</li>\n<li>Caps Lock ⇪</li>\n<li>Fn</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>快捷键</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Command-X</td>\n<td>剪切：删除所选项并将其拷贝到剪贴板。</td>\n</tr>\n<tr>\n<td>Command-C</td>\n<td>将所选项拷贝到剪贴板。这同样适用于 Finder 中的文件。</td>\n</tr>\n<tr>\n<td>Command-V</td>\n<td>将剪贴板的内容粘贴到当前文稿或 app 中。这同样适用于 Finder 中的文件。</td>\n</tr>\n<tr>\n<td>Command-Z</td>\n<td>撤销前一个命令。随后您可以按 Command-Shift-Z 来重做，从而反向执行撤销命令。在某些 app 中，您可以撤销和重做多个命令。</td>\n</tr>\n<tr>\n<td>Command-A</td>\n<td>全选各项。</td>\n</tr>\n<tr>\n<td>Command-F</td>\n<td>查找：打开“查找”窗口，或在文稿中查找项目。</td>\n</tr>\n<tr>\n<td>Command-G</td>\n<td>再次查找：查找之前所找到项目出现的下一个位置。要查找出现的上一个位置，请按 Command-Shift-G。</td>\n</tr>\n<tr>\n<td>Command-H</td>\n<td>隐藏最前面的 app 的窗口。要查看最前面的 app 但隐藏所有其他 app，请按 Command-Option-H。</td>\n</tr>\n<tr>\n<td>Command-M</td>\n<td>将最前面的窗口最小化至 Dock。要最小化最前面的 app 的所有窗口，请按 Command-Option-M。</td>\n</tr>\n<tr>\n<td>Command-N</td>\n<td>新建：打开一个新文稿或窗口。</td>\n</tr>\n<tr>\n<td>Command-O</td>\n<td>打开所选项，或打开一个对话框以选择要打开的文件。</td>\n</tr>\n<tr>\n<td>Command-P</td>\n<td>打印当前文稿。</td>\n</tr>\n<tr>\n<td>Command-S</td>\n<td>存储当前文稿。</td>\n</tr>\n<tr>\n<td>Command-W</td>\n<td>关闭最前面的窗口。要关闭该 app 的所有窗口，请按 Command-Option-W。</td>\n</tr>\n<tr>\n<td>Command-Q</td>\n<td>退出 app。</td>\n</tr>\n<tr>\n<td>Option-Command-Esc</td>\n<td>强制退出：选择要强制退出的 app。或者，按住 Command-Shift-Option-Esc 3 秒钟来仅强制最前面的 app 退出。</td>\n</tr>\n<tr>\n<td>Command–空格键</td>\n<td>Spotlight：显示或隐藏 Spotlight 搜索栏。要从 Finder 窗口执行 Spotlight 搜索，请按 Command–Option–空格键。如果您使用多个输入源以便用不同的语言键入内容，这些快捷键会更改输入源而非显示 Spotlight。</td>\n</tr>\n<tr>\n<td>空格键</td>\n<td>快速查看：使用快速查看预览所选项。</td>\n</tr>\n<tr>\n<td>Command-Tab</td>\n<td>切换 app：在打开的 app 中切换到下一个最近使用的 app。</td>\n</tr>\n<tr>\n<td>Shift-Command-波浪号 (~)</td>\n<td>切换窗口：切换到最前端应用中下一个最近使用的窗口。</td>\n</tr>\n<tr>\n<td>Shift-Command-3</td>\n<td>屏幕快照：拍摄整个屏幕的屏幕快照。了解更多屏幕快照快捷键。</td>\n</tr>\n<tr>\n<td>Command-逗号 (,)</td>\n<td>偏好设置：打开最前面的 app 的偏好设置。</td>\n</tr>\n</tbody>\n</table>\n<p>更多快捷键参见<a href=\"https://support.apple.com/zh-cn/HT201236\" target=\"_blank\" rel=\"external\">官方文档</a>。</p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>感觉就是各种手势，各种简单的操作定义复杂的操作，极大的节省时间，而且高逼格，以后我也要走上装逼的道路了！</p>\n","excerpt":"<p>等了一个星期，公司配备的iMac总算是到了，今天装上后体验了一下，有很多地方还是很不习惯，后面需要慢慢适应，这里列几点感悟。</p>","more":"<h2 id=\"Finder\"><a href=\"#Finder\" class=\"headerlink\" title=\"Finder\"></a>Finder</h2><p>Finder便是类似Windows中的文件管理器了吧，只不过OS X不分什么C、D、E、F盘什么的，感觉就是只有简单的几个分类：应用程序、下载、桌面、文稿。同事说有什么东西全部往桌面丢就行了，也不知是真是假。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx1.jpg\" alt=\"\"></p>\n<h2 id=\"鼠标\"><a href=\"#鼠标\" class=\"headerlink\" title=\"鼠标\"></a>鼠标</h2><p>打开系统偏好设置，选择鼠标项，会有一些设置，还有一些手势，在你打钩后边能生效，也是类似Mackbook的一些手势，方便做一些操作。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx2.jpg\" alt=\"\"></p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx3.jpg\" alt=\"\"></p>\n<h2 id=\"Mission-Control\"><a href=\"#Mission-Control\" class=\"headerlink\" title=\"Mission Control\"></a>Mission Control</h2><p>Mission Control会提供一个所有已打开的窗口、桌面空间、全屏应用和Split View空间的鸟瞰图，让你能轻松在它们之间进行切换。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx5.png\" alt=\"\"></p>\n<h2 id=\"触摸角\"><a href=\"#触摸角\" class=\"headerlink\" title=\"触摸角\"></a>触摸角</h2><p>打开系统偏好设置，选择Mission Control项，左下角会有触摸角的设置。当把鼠标移到屏幕的角落的时候可以触发一些操作，4个角可以设置4个操作。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx4.jpg\" alt=\"\"></p>\n<h2 id=\"App-Store\"><a href=\"#App-Store\" class=\"headerlink\" title=\"App Store\"></a>App Store</h2><p>这个就是苹果软件商店了，没什么好说的。需要安装QQ、微信、Xcode等软件直接在里面搜索后购买就行了。购买的时候是需要绑定Apple ID的，这个直接绑定就好了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx7.jpg\" alt=\"\"></p>\n<h2 id=\"终端\"><a href=\"#终端\" class=\"headerlink\" title=\"终端\"></a>终端</h2><p>后续的日常开发肯定离不开终端，例如查看Git版本。按下<code>Command + Space</code>可以出现<code>spotlight</code>搜索，输入<code>terminal</code>回车即可运行终端。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/11/osx6.jpg\" alt=\"\"></p>\n<h2 id=\"常用快捷键\"><a href=\"#常用快捷键\" class=\"headerlink\" title=\"常用快捷键\"></a>常用快捷键</h2><p>首先了解下符号与按键的对应关系</p>\n<ol>\n<li>Command ⌘</li>\n<li>Shift ⇧</li>\n<li>Option ⌥</li>\n<li>Control ⌃</li>\n<li>Caps Lock ⇪</li>\n<li>Fn</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>快捷键</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Command-X</td>\n<td>剪切：删除所选项并将其拷贝到剪贴板。</td>\n</tr>\n<tr>\n<td>Command-C</td>\n<td>将所选项拷贝到剪贴板。这同样适用于 Finder 中的文件。</td>\n</tr>\n<tr>\n<td>Command-V</td>\n<td>将剪贴板的内容粘贴到当前文稿或 app 中。这同样适用于 Finder 中的文件。</td>\n</tr>\n<tr>\n<td>Command-Z</td>\n<td>撤销前一个命令。随后您可以按 Command-Shift-Z 来重做，从而反向执行撤销命令。在某些 app 中，您可以撤销和重做多个命令。</td>\n</tr>\n<tr>\n<td>Command-A</td>\n<td>全选各项。</td>\n</tr>\n<tr>\n<td>Command-F</td>\n<td>查找：打开“查找”窗口，或在文稿中查找项目。</td>\n</tr>\n<tr>\n<td>Command-G</td>\n<td>再次查找：查找之前所找到项目出现的下一个位置。要查找出现的上一个位置，请按 Command-Shift-G。</td>\n</tr>\n<tr>\n<td>Command-H</td>\n<td>隐藏最前面的 app 的窗口。要查看最前面的 app 但隐藏所有其他 app，请按 Command-Option-H。</td>\n</tr>\n<tr>\n<td>Command-M</td>\n<td>将最前面的窗口最小化至 Dock。要最小化最前面的 app 的所有窗口，请按 Command-Option-M。</td>\n</tr>\n<tr>\n<td>Command-N</td>\n<td>新建：打开一个新文稿或窗口。</td>\n</tr>\n<tr>\n<td>Command-O</td>\n<td>打开所选项，或打开一个对话框以选择要打开的文件。</td>\n</tr>\n<tr>\n<td>Command-P</td>\n<td>打印当前文稿。</td>\n</tr>\n<tr>\n<td>Command-S</td>\n<td>存储当前文稿。</td>\n</tr>\n<tr>\n<td>Command-W</td>\n<td>关闭最前面的窗口。要关闭该 app 的所有窗口，请按 Command-Option-W。</td>\n</tr>\n<tr>\n<td>Command-Q</td>\n<td>退出 app。</td>\n</tr>\n<tr>\n<td>Option-Command-Esc</td>\n<td>强制退出：选择要强制退出的 app。或者，按住 Command-Shift-Option-Esc 3 秒钟来仅强制最前面的 app 退出。</td>\n</tr>\n<tr>\n<td>Command–空格键</td>\n<td>Spotlight：显示或隐藏 Spotlight 搜索栏。要从 Finder 窗口执行 Spotlight 搜索，请按 Command–Option–空格键。如果您使用多个输入源以便用不同的语言键入内容，这些快捷键会更改输入源而非显示 Spotlight。</td>\n</tr>\n<tr>\n<td>空格键</td>\n<td>快速查看：使用快速查看预览所选项。</td>\n</tr>\n<tr>\n<td>Command-Tab</td>\n<td>切换 app：在打开的 app 中切换到下一个最近使用的 app。</td>\n</tr>\n<tr>\n<td>Shift-Command-波浪号 (~)</td>\n<td>切换窗口：切换到最前端应用中下一个最近使用的窗口。</td>\n</tr>\n<tr>\n<td>Shift-Command-3</td>\n<td>屏幕快照：拍摄整个屏幕的屏幕快照。了解更多屏幕快照快捷键。</td>\n</tr>\n<tr>\n<td>Command-逗号 (,)</td>\n<td>偏好设置：打开最前面的 app 的偏好设置。</td>\n</tr>\n</tbody>\n</table>\n<p>更多快捷键参见<a href=\"https://support.apple.com/zh-cn/HT201236\">官方文档</a>。</p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>感觉就是各种手势，各种简单的操作定义复杂的操作，极大的节省时间，而且高逼格，以后我也要走上装逼的道路了！</p>"},{"title":"Android AlarmManager使用小记","date":"2016-08-18T08:20:03.000Z","_content":"\n现在应用大多数都会使用一些三方推送的服务，例如极光、个推等，但是其到达率并不是很高，尤其是Android机型，各大手机厂商定制rom，系统拦截。那么要如何提高消息达到率呢？\n\nAndroid中提供了``AlarmManager``可以用来做这个事情。顾名思义，它是一个闹钟管理类，它向系统注册一个事件，时间到了之后，便会触发事件，然后我们便能做一些事情了。\n\n<!-- more -->\n\n## 定义接收器\n首先定义一个BroadcastReceiver，在收到消息后，在onReceive里弹出一个Notification，示例代码如下：\n```\npublic class OneShotAlarm extends BroadcastReceiver {\n\n    private final static int NOTIFICATION_ID = 1001;\n\n    @Override\n    public void onReceive(Context context, Intent intent) {\n        NotificationCompat.Builder mBuilder = new NotificationCompat.Builder(context)\n                .setSmallIcon(R.mipmap.ic_launcher)\n                .setContentTitle(\"title\")\n                .setContentText(\"context\");\n        NotificationManager mNotifyMgr = (NotificationManager) context.getSystemService(Activity.NOTIFICATION_SERVICE);\n        mNotifyMgr.notify(NOTIFICATION_ID, mBuilder.build());\n        Toast.makeText(context, \"OneShotAlarm onReceive\", Toast.LENGTH_SHORT).show();\n        Log.e(\"TAG\", \"OneShotAlarm onReceive\");\n    }\n}\n```\n记得在AndroidManifest.xml中注册：\n```\n<receiver\n    android:name=\".OneShotAlarm\"\n    android:process=\":remote\" />\n<receiver\n```\n在此讨论一下process属性，它规定了组件(activity, service, receiver等)所在的进程。\n通常情况下，没有指定这个属性，一个应用所有的组件都运行在应用的默认进程中，进程的名字和应用的包名一致，比如manifest的package=\"com.example.helloalarm\"，则默认进程名就是com.example.helloalarm。\nprocess属性可以为全部的组件设置一个不同的默认进程，组件可以override这个默认的进程设置，这样你的应用就可以是多进程的。\n如果你的process属性以一个冒号开头，进程名会在原来的进程名之后附加冒号之后的字符串作为新的进程名。当组件需要时，会自动创建这个进程，这个进程是应用私有的进程。\n如果process属性以小写字母开头，将会直接以属性中的这个名字作为进程名，这是一个全局进程，这样的进程可以被多个不同应用中的组件共享。\n\n## 开启闹钟\n```\npublic class MainActivity extends AppCompatActivity {\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n\n        Intent intent = new Intent(MainActivity.this, OneShotAlarm.class);\n        PendingIntent sender = PendingIntent.getBroadcast(\n                MainActivity.this, 0, intent, 0);\n\n        // We want the alarm to go off 10 seconds from now.\n        Calendar calendar = Calendar.getInstance();\n        calendar.setTimeInMillis(System.currentTimeMillis());\n        calendar.add(Calendar.SECOND, 30);\n\n        AlarmManager am = (AlarmManager) getSystemService(ALARM_SERVICE);\n        am.set(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), sender);\n    }\n}\n```\n启动Activity之后30秒我们便能看到Toast，以及打出的Log和Notification了。\n通过这种方式，我们可以定时的发送通知，这样应该能改善推送到达率低的问题。\n\n## AlarmManager\n常用方法有三个：\n1. set(int type，long startTime，PendingIntent pi)；\n该方法用于设置一次性闹钟，第一个参数表示闹钟类型，第二个参数表示闹钟执行时间，第三个参数表示闹钟响应动作。\n2. setRepeating(int type，long startTime，long intervalTime，PendingIntent pi)；\n该方法用于设置重复闹钟，第一个参数表示闹钟类型，第二个参数表示闹钟首次执行时间，第三个参数表示闹钟两次执行的间隔时间，第三个参数表示闹钟响应动作。\n3. setInexactRepeating（int type，long startTime，long intervalTime，PendingIntent pi）；\n该方法也用于设置重复闹钟，与第二个方法相似，不过其两个闹钟执行的间隔时间不是固定的而已。\n\n三个方法中都有type、PendingIntent参数，type分为以下几类：\n1. AlarmManager.ELAPSED_REALTIME：表示闹钟在手机睡眠状态下不可用，该状态下闹钟使用相对时间（相对于系统启动开始），状态值为3\n2. AlarmManager.ELAPSED_REALTIME_WAKEUP：表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟也使用相对时间，状态值为2\n3. AlarmManager.RTC：表示闹钟在睡眠状态下不可用，该状态下闹钟使用绝对时间，即当前系统时间，状态值为1\n4. AlarmManager.RTC_WAKEUP：表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟使用绝对时间，状态值为0\n5. AlarmManager.POWER_OFF_WAKEUP：表示闹钟在手机关机状态下也能正常进行提示功能，所以是5个状态中用的最多的状态之一，该状态下闹钟也是用绝对时间，状态值为4；不过本状态好像受SDK版本影响，某些版本并不支持\n\nPendingIntent为设置接收消息类的参数，一般通过如下代码生成：\n```\nPendingIntent sender = PendingIntent.getBroadcast(MainActivity.this, 0, intent, 0);\n```\n注意第二个参数为``requestCode``，该参数是闹钟的标识，如果不停设置闹钟，这个参数都一样，那么后设置的闹钟会覆盖之前的闹钟。所以如果需要多个闹钟，则需要将这个参数设为唯一。\n\n若要取消闹钟，则直接调用cancel即可，官方是这样说的：\n\n>void cancel (PendingIntent operation)\nRemove any alarms with a matching Intent. Any alarm, of any type, whose Intent matches this one (as defined by filterEquals(Intent)), will be canceled.\n\n只有符合filterEquals的intent才会被取消。\n```\npublic boolean filterEquals(Intent other) {\n    if (other == null) {\n        return false;\n    }\n    if (!Objects.equals(this.mAction, other.mAction)) return false;\n    if (!Objects.equals(this.mData, other.mData)) return false;\n    if (!Objects.equals(this.mType, other.mType)) return false;\n    if (!Objects.equals(this.mPackage, other.mPackage)) return false;\n    if (!Objects.equals(this.mComponent, other.mComponent)) return false;\n    if (!Objects.equals(this.mCategories, other.mCategories)) return false;\n\n    return true;\n}\n```\n\n## 问题\n对于即时性比较强的应用，比如直播类，闹钟定的时间要与正在直播的推送分开，不然用户就有可能收到2次通知了，所以闹钟就要定提前一点：XXX即将开始直播，类似这样。那么就会有一个问题：用户看到闹钟的这个通知后，进入应用，但是XXX是没有直播的（即将开始直播），所以对于用户当前是没有正确信息来显示的，这种体验可能不太好。如果将闹钟设置退后，XXX已经开始直播，又会显得非常怪异。\n我的心情：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar3.jpg)\n求同学们支招~\n","source":"_posts/alarm.md","raw":"---\ntitle: Android AlarmManager使用小记\ndate: 2016-08-18 16:20:03\ntags:\n - 日常开发\n---\n\n现在应用大多数都会使用一些三方推送的服务，例如极光、个推等，但是其到达率并不是很高，尤其是Android机型，各大手机厂商定制rom，系统拦截。那么要如何提高消息达到率呢？\n\nAndroid中提供了``AlarmManager``可以用来做这个事情。顾名思义，它是一个闹钟管理类，它向系统注册一个事件，时间到了之后，便会触发事件，然后我们便能做一些事情了。\n\n<!-- more -->\n\n## 定义接收器\n首先定义一个BroadcastReceiver，在收到消息后，在onReceive里弹出一个Notification，示例代码如下：\n```\npublic class OneShotAlarm extends BroadcastReceiver {\n\n    private final static int NOTIFICATION_ID = 1001;\n\n    @Override\n    public void onReceive(Context context, Intent intent) {\n        NotificationCompat.Builder mBuilder = new NotificationCompat.Builder(context)\n                .setSmallIcon(R.mipmap.ic_launcher)\n                .setContentTitle(\"title\")\n                .setContentText(\"context\");\n        NotificationManager mNotifyMgr = (NotificationManager) context.getSystemService(Activity.NOTIFICATION_SERVICE);\n        mNotifyMgr.notify(NOTIFICATION_ID, mBuilder.build());\n        Toast.makeText(context, \"OneShotAlarm onReceive\", Toast.LENGTH_SHORT).show();\n        Log.e(\"TAG\", \"OneShotAlarm onReceive\");\n    }\n}\n```\n记得在AndroidManifest.xml中注册：\n```\n<receiver\n    android:name=\".OneShotAlarm\"\n    android:process=\":remote\" />\n<receiver\n```\n在此讨论一下process属性，它规定了组件(activity, service, receiver等)所在的进程。\n通常情况下，没有指定这个属性，一个应用所有的组件都运行在应用的默认进程中，进程的名字和应用的包名一致，比如manifest的package=\"com.example.helloalarm\"，则默认进程名就是com.example.helloalarm。\nprocess属性可以为全部的组件设置一个不同的默认进程，组件可以override这个默认的进程设置，这样你的应用就可以是多进程的。\n如果你的process属性以一个冒号开头，进程名会在原来的进程名之后附加冒号之后的字符串作为新的进程名。当组件需要时，会自动创建这个进程，这个进程是应用私有的进程。\n如果process属性以小写字母开头，将会直接以属性中的这个名字作为进程名，这是一个全局进程，这样的进程可以被多个不同应用中的组件共享。\n\n## 开启闹钟\n```\npublic class MainActivity extends AppCompatActivity {\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n\n        Intent intent = new Intent(MainActivity.this, OneShotAlarm.class);\n        PendingIntent sender = PendingIntent.getBroadcast(\n                MainActivity.this, 0, intent, 0);\n\n        // We want the alarm to go off 10 seconds from now.\n        Calendar calendar = Calendar.getInstance();\n        calendar.setTimeInMillis(System.currentTimeMillis());\n        calendar.add(Calendar.SECOND, 30);\n\n        AlarmManager am = (AlarmManager) getSystemService(ALARM_SERVICE);\n        am.set(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(), sender);\n    }\n}\n```\n启动Activity之后30秒我们便能看到Toast，以及打出的Log和Notification了。\n通过这种方式，我们可以定时的发送通知，这样应该能改善推送到达率低的问题。\n\n## AlarmManager\n常用方法有三个：\n1. set(int type，long startTime，PendingIntent pi)；\n该方法用于设置一次性闹钟，第一个参数表示闹钟类型，第二个参数表示闹钟执行时间，第三个参数表示闹钟响应动作。\n2. setRepeating(int type，long startTime，long intervalTime，PendingIntent pi)；\n该方法用于设置重复闹钟，第一个参数表示闹钟类型，第二个参数表示闹钟首次执行时间，第三个参数表示闹钟两次执行的间隔时间，第三个参数表示闹钟响应动作。\n3. setInexactRepeating（int type，long startTime，long intervalTime，PendingIntent pi）；\n该方法也用于设置重复闹钟，与第二个方法相似，不过其两个闹钟执行的间隔时间不是固定的而已。\n\n三个方法中都有type、PendingIntent参数，type分为以下几类：\n1. AlarmManager.ELAPSED_REALTIME：表示闹钟在手机睡眠状态下不可用，该状态下闹钟使用相对时间（相对于系统启动开始），状态值为3\n2. AlarmManager.ELAPSED_REALTIME_WAKEUP：表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟也使用相对时间，状态值为2\n3. AlarmManager.RTC：表示闹钟在睡眠状态下不可用，该状态下闹钟使用绝对时间，即当前系统时间，状态值为1\n4. AlarmManager.RTC_WAKEUP：表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟使用绝对时间，状态值为0\n5. AlarmManager.POWER_OFF_WAKEUP：表示闹钟在手机关机状态下也能正常进行提示功能，所以是5个状态中用的最多的状态之一，该状态下闹钟也是用绝对时间，状态值为4；不过本状态好像受SDK版本影响，某些版本并不支持\n\nPendingIntent为设置接收消息类的参数，一般通过如下代码生成：\n```\nPendingIntent sender = PendingIntent.getBroadcast(MainActivity.this, 0, intent, 0);\n```\n注意第二个参数为``requestCode``，该参数是闹钟的标识，如果不停设置闹钟，这个参数都一样，那么后设置的闹钟会覆盖之前的闹钟。所以如果需要多个闹钟，则需要将这个参数设为唯一。\n\n若要取消闹钟，则直接调用cancel即可，官方是这样说的：\n\n>void cancel (PendingIntent operation)\nRemove any alarms with a matching Intent. Any alarm, of any type, whose Intent matches this one (as defined by filterEquals(Intent)), will be canceled.\n\n只有符合filterEquals的intent才会被取消。\n```\npublic boolean filterEquals(Intent other) {\n    if (other == null) {\n        return false;\n    }\n    if (!Objects.equals(this.mAction, other.mAction)) return false;\n    if (!Objects.equals(this.mData, other.mData)) return false;\n    if (!Objects.equals(this.mType, other.mType)) return false;\n    if (!Objects.equals(this.mPackage, other.mPackage)) return false;\n    if (!Objects.equals(this.mComponent, other.mComponent)) return false;\n    if (!Objects.equals(this.mCategories, other.mCategories)) return false;\n\n    return true;\n}\n```\n\n## 问题\n对于即时性比较强的应用，比如直播类，闹钟定的时间要与正在直播的推送分开，不然用户就有可能收到2次通知了，所以闹钟就要定提前一点：XXX即将开始直播，类似这样。那么就会有一个问题：用户看到闹钟的这个通知后，进入应用，但是XXX是没有直播的（即将开始直播），所以对于用户当前是没有正确信息来显示的，这种体验可能不太好。如果将闹钟设置退后，XXX已经开始直播，又会显得非常怪异。\n我的心情：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar3.jpg)\n求同学们支招~\n","slug":"alarm","published":1,"updated":"2016-11-21T10:00:29.021Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e757q00021cb8b458v6xj","content":"<p>现在应用大多数都会使用一些三方推送的服务，例如极光、个推等，但是其到达率并不是很高，尤其是Android机型，各大手机厂商定制rom，系统拦截。那么要如何提高消息达到率呢？</p>\n<p>Android中提供了<code>AlarmManager</code>可以用来做这个事情。顾名思义，它是一个闹钟管理类，它向系统注册一个事件，时间到了之后，便会触发事件，然后我们便能做一些事情了。</p>\n<a id=\"more\"></a>\n<h2 id=\"定义接收器\"><a href=\"#定义接收器\" class=\"headerlink\" title=\"定义接收器\"></a>定义接收器</h2><p>首先定义一个BroadcastReceiver，在收到消息后，在onReceive里弹出一个Notification，示例代码如下：<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OneShotAlarm</span> <span class=\"keyword\">extends</span> <span class=\"title\">BroadcastReceiver</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> static int <span class=\"type\">NOTIFICATION_ID</span> = <span class=\"number\">1001</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    public void onReceive(<span class=\"type\">Context</span> context, <span class=\"type\">Intent</span> intent) &#123;</div><div class=\"line\">        <span class=\"type\">NotificationCompat</span>.<span class=\"type\">Builder</span> mBuilder = <span class=\"keyword\">new</span> <span class=\"type\">NotificationCompat</span>.<span class=\"type\">Builder</span>(context)</div><div class=\"line\">                .setSmallIcon(<span class=\"type\">R</span>.mipmap.ic_launcher)</div><div class=\"line\">                .setContentTitle(<span class=\"string\">\"title\"</span>)</div><div class=\"line\">                .setContentText(<span class=\"string\">\"context\"</span>);</div><div class=\"line\">        <span class=\"type\">NotificationManager</span> mNotifyMgr = (<span class=\"type\">NotificationManager</span>) context.getSystemService(<span class=\"type\">Activity</span>.<span class=\"type\">NOTIFICATION_SERVICE</span>);</div><div class=\"line\">        mNotifyMgr.notify(<span class=\"type\">NOTIFICATION_ID</span>, mBuilder.build());</div><div class=\"line\">        <span class=\"type\">Toast</span>.makeText(context, <span class=\"string\">\"OneShotAlarm onReceive\"</span>, <span class=\"type\">Toast</span>.<span class=\"type\">LENGTH_SHORT</span>).show();</div><div class=\"line\">        <span class=\"type\">Log</span>.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"OneShotAlarm onReceive\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>记得在AndroidManifest.xml中注册：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;receiver</div><div class=\"line\">    android:<span class=\"built_in\">name</span>=<span class=\"string\">\".OneShotAlarm\"</span></div><div class=\"line\">    android:process=<span class=\"string\">\":remote\"</span> /&gt;</div><div class=\"line\">&lt;receiver</div></pre></td></tr></table></figure></p>\n<p>在此讨论一下process属性，它规定了组件(activity, service, receiver等)所在的进程。<br>通常情况下，没有指定这个属性，一个应用所有的组件都运行在应用的默认进程中，进程的名字和应用的包名一致，比如manifest的package=”com.example.helloalarm”，则默认进程名就是com.example.helloalarm。<br>process属性可以为全部的组件设置一个不同的默认进程，组件可以override这个默认的进程设置，这样你的应用就可以是多进程的。<br>如果你的process属性以一个冒号开头，进程名会在原来的进程名之后附加冒号之后的字符串作为新的进程名。当组件需要时，会自动创建这个进程，这个进程是应用私有的进程。<br>如果process属性以小写字母开头，将会直接以属性中的这个名字作为进程名，这是一个全局进程，这样的进程可以被多个不同应用中的组件共享。</p>\n<h2 id=\"开启闹钟\"><a href=\"#开启闹钟\" class=\"headerlink\" title=\"开启闹钟\"></a>开启闹钟</h2><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onCreate(<span class=\"type\">Bundle</span> savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(<span class=\"type\">R</span>.layout.activity_main);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"type\">Intent</span> intent = <span class=\"keyword\">new</span> <span class=\"type\">Intent</span>(<span class=\"type\">MainActivity</span>.<span class=\"keyword\">this</span>, <span class=\"type\">OneShotAlarm</span>.<span class=\"keyword\">class</span>);</div><div class=\"line\">        <span class=\"type\">PendingIntent</span> sender = <span class=\"type\">PendingIntent</span>.getBroadcast(</div><div class=\"line\">                <span class=\"type\">MainActivity</span>.<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, intent, <span class=\"number\">0</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// We want the alarm to go off 10 seconds from now.</span></div><div class=\"line\">        <span class=\"type\">Calendar</span> calendar = <span class=\"type\">Calendar</span>.getInstance();</div><div class=\"line\">        calendar.setTimeInMillis(<span class=\"type\">System</span>.currentTimeMillis());</div><div class=\"line\">        calendar.add(<span class=\"type\">Calendar</span>.<span class=\"type\">SECOND</span>, <span class=\"number\">30</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"type\">AlarmManager</span> am = (<span class=\"type\">AlarmManager</span>) getSystemService(<span class=\"type\">ALARM_SERVICE</span>);</div><div class=\"line\">        am.set(<span class=\"type\">AlarmManager</span>.<span class=\"type\">RTC_WAKEUP</span>, calendar.getTimeInMillis(), sender);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>启动Activity之后30秒我们便能看到Toast，以及打出的Log和Notification了。<br>通过这种方式，我们可以定时的发送通知，这样应该能改善推送到达率低的问题。</p>\n<h2 id=\"AlarmManager\"><a href=\"#AlarmManager\" class=\"headerlink\" title=\"AlarmManager\"></a>AlarmManager</h2><p>常用方法有三个：</p>\n<ol>\n<li>set(int type，long startTime，PendingIntent pi)；<br>该方法用于设置一次性闹钟，第一个参数表示闹钟类型，第二个参数表示闹钟执行时间，第三个参数表示闹钟响应动作。</li>\n<li>setRepeating(int type，long startTime，long intervalTime，PendingIntent pi)；<br>该方法用于设置重复闹钟，第一个参数表示闹钟类型，第二个参数表示闹钟首次执行时间，第三个参数表示闹钟两次执行的间隔时间，第三个参数表示闹钟响应动作。</li>\n<li>setInexactRepeating（int type，long startTime，long intervalTime，PendingIntent pi）；<br>该方法也用于设置重复闹钟，与第二个方法相似，不过其两个闹钟执行的间隔时间不是固定的而已。</li>\n</ol>\n<p>三个方法中都有type、PendingIntent参数，type分为以下几类：</p>\n<ol>\n<li>AlarmManager.ELAPSED_REALTIME：表示闹钟在手机睡眠状态下不可用，该状态下闹钟使用相对时间（相对于系统启动开始），状态值为3</li>\n<li>AlarmManager.ELAPSED_REALTIME_WAKEUP：表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟也使用相对时间，状态值为2</li>\n<li>AlarmManager.RTC：表示闹钟在睡眠状态下不可用，该状态下闹钟使用绝对时间，即当前系统时间，状态值为1</li>\n<li>AlarmManager.RTC_WAKEUP：表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟使用绝对时间，状态值为0</li>\n<li>AlarmManager.POWER_OFF_WAKEUP：表示闹钟在手机关机状态下也能正常进行提示功能，所以是5个状态中用的最多的状态之一，该状态下闹钟也是用绝对时间，状态值为4；不过本状态好像受SDK版本影响，某些版本并不支持</li>\n</ol>\n<p>PendingIntent为设置接收消息类的参数，一般通过如下代码生成：<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">PendingIntent sender</span> = PendingIntent.getBroadcast(MainActivity.this, 0, intent, 0);</div></pre></td></tr></table></figure></p>\n<p>注意第二个参数为<code>requestCode</code>，该参数是闹钟的标识，如果不停设置闹钟，这个参数都一样，那么后设置的闹钟会覆盖之前的闹钟。所以如果需要多个闹钟，则需要将这个参数设为唯一。</p>\n<p>若要取消闹钟，则直接调用cancel即可，官方是这样说的：</p>\n<blockquote>\n<p>void cancel (PendingIntent operation)<br>Remove any alarms with a matching Intent. Any alarm, of any type, whose Intent matches this one (as defined by filterEquals(Intent)), will be canceled.</p>\n</blockquote>\n<p>只有符合filterEquals的intent才会被取消。<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> boolean filterEquals(Intent other) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (other == <span class=\"literal\">null</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mAction, other.mAction)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mData, other.mData)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mType, other.mType)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mPackage, other.mPackage)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mComponent, other.mComponent)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mCategories, other.mCategories)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>对于即时性比较强的应用，比如直播类，闹钟定的时间要与正在直播的推送分开，不然用户就有可能收到2次通知了，所以闹钟就要定提前一点：XXX即将开始直播，类似这样。那么就会有一个问题：用户看到闹钟的这个通知后，进入应用，但是XXX是没有直播的（即将开始直播），所以对于用户当前是没有正确信息来显示的，这种体验可能不太好。如果将闹钟设置退后，XXX已经开始直播，又会显得非常怪异。<br>我的心情：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar3.jpg\" alt=\"\"><br>求同学们支招~</p>\n","excerpt":"<p>现在应用大多数都会使用一些三方推送的服务，例如极光、个推等，但是其到达率并不是很高，尤其是Android机型，各大手机厂商定制rom，系统拦截。那么要如何提高消息达到率呢？</p>\n<p>Android中提供了<code>AlarmManager</code>可以用来做这个事情。顾名思义，它是一个闹钟管理类，它向系统注册一个事件，时间到了之后，便会触发事件，然后我们便能做一些事情了。</p>","more":"<h2 id=\"定义接收器\"><a href=\"#定义接收器\" class=\"headerlink\" title=\"定义接收器\"></a>定义接收器</h2><p>首先定义一个BroadcastReceiver，在收到消息后，在onReceive里弹出一个Notification，示例代码如下：<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OneShotAlarm</span> <span class=\"keyword\">extends</span> <span class=\"title\">BroadcastReceiver</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> static int <span class=\"type\">NOTIFICATION_ID</span> = <span class=\"number\">1001</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    public void onReceive(<span class=\"type\">Context</span> context, <span class=\"type\">Intent</span> intent) &#123;</div><div class=\"line\">        <span class=\"type\">NotificationCompat</span>.<span class=\"type\">Builder</span> mBuilder = <span class=\"keyword\">new</span> <span class=\"type\">NotificationCompat</span>.<span class=\"type\">Builder</span>(context)</div><div class=\"line\">                .setSmallIcon(<span class=\"type\">R</span>.mipmap.ic_launcher)</div><div class=\"line\">                .setContentTitle(<span class=\"string\">\"title\"</span>)</div><div class=\"line\">                .setContentText(<span class=\"string\">\"context\"</span>);</div><div class=\"line\">        <span class=\"type\">NotificationManager</span> mNotifyMgr = (<span class=\"type\">NotificationManager</span>) context.getSystemService(<span class=\"type\">Activity</span>.<span class=\"type\">NOTIFICATION_SERVICE</span>);</div><div class=\"line\">        mNotifyMgr.notify(<span class=\"type\">NOTIFICATION_ID</span>, mBuilder.build());</div><div class=\"line\">        <span class=\"type\">Toast</span>.makeText(context, <span class=\"string\">\"OneShotAlarm onReceive\"</span>, <span class=\"type\">Toast</span>.<span class=\"type\">LENGTH_SHORT</span>).show();</div><div class=\"line\">        <span class=\"type\">Log</span>.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"OneShotAlarm onReceive\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>记得在AndroidManifest.xml中注册：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;receiver</div><div class=\"line\">    android:<span class=\"built_in\">name</span>=<span class=\"string\">\".OneShotAlarm\"</span></div><div class=\"line\">    android:process=<span class=\"string\">\":remote\"</span> /&gt;</div><div class=\"line\">&lt;receiver</div></pre></td></tr></table></figure></p>\n<p>在此讨论一下process属性，它规定了组件(activity, service, receiver等)所在的进程。<br>通常情况下，没有指定这个属性，一个应用所有的组件都运行在应用的默认进程中，进程的名字和应用的包名一致，比如manifest的package=”com.example.helloalarm”，则默认进程名就是com.example.helloalarm。<br>process属性可以为全部的组件设置一个不同的默认进程，组件可以override这个默认的进程设置，这样你的应用就可以是多进程的。<br>如果你的process属性以一个冒号开头，进程名会在原来的进程名之后附加冒号之后的字符串作为新的进程名。当组件需要时，会自动创建这个进程，这个进程是应用私有的进程。<br>如果process属性以小写字母开头，将会直接以属性中的这个名字作为进程名，这是一个全局进程，这样的进程可以被多个不同应用中的组件共享。</p>\n<h2 id=\"开启闹钟\"><a href=\"#开启闹钟\" class=\"headerlink\" title=\"开启闹钟\"></a>开启闹钟</h2><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onCreate(<span class=\"type\">Bundle</span> savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(<span class=\"type\">R</span>.layout.activity_main);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"type\">Intent</span> intent = <span class=\"keyword\">new</span> <span class=\"type\">Intent</span>(<span class=\"type\">MainActivity</span>.<span class=\"keyword\">this</span>, <span class=\"type\">OneShotAlarm</span>.<span class=\"keyword\">class</span>);</div><div class=\"line\">        <span class=\"type\">PendingIntent</span> sender = <span class=\"type\">PendingIntent</span>.getBroadcast(</div><div class=\"line\">                <span class=\"type\">MainActivity</span>.<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, intent, <span class=\"number\">0</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// We want the alarm to go off 10 seconds from now.</span></div><div class=\"line\">        <span class=\"type\">Calendar</span> calendar = <span class=\"type\">Calendar</span>.getInstance();</div><div class=\"line\">        calendar.setTimeInMillis(<span class=\"type\">System</span>.currentTimeMillis());</div><div class=\"line\">        calendar.add(<span class=\"type\">Calendar</span>.<span class=\"type\">SECOND</span>, <span class=\"number\">30</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"type\">AlarmManager</span> am = (<span class=\"type\">AlarmManager</span>) getSystemService(<span class=\"type\">ALARM_SERVICE</span>);</div><div class=\"line\">        am.set(<span class=\"type\">AlarmManager</span>.<span class=\"type\">RTC_WAKEUP</span>, calendar.getTimeInMillis(), sender);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>启动Activity之后30秒我们便能看到Toast，以及打出的Log和Notification了。<br>通过这种方式，我们可以定时的发送通知，这样应该能改善推送到达率低的问题。</p>\n<h2 id=\"AlarmManager\"><a href=\"#AlarmManager\" class=\"headerlink\" title=\"AlarmManager\"></a>AlarmManager</h2><p>常用方法有三个：</p>\n<ol>\n<li>set(int type，long startTime，PendingIntent pi)；<br>该方法用于设置一次性闹钟，第一个参数表示闹钟类型，第二个参数表示闹钟执行时间，第三个参数表示闹钟响应动作。</li>\n<li>setRepeating(int type，long startTime，long intervalTime，PendingIntent pi)；<br>该方法用于设置重复闹钟，第一个参数表示闹钟类型，第二个参数表示闹钟首次执行时间，第三个参数表示闹钟两次执行的间隔时间，第三个参数表示闹钟响应动作。</li>\n<li>setInexactRepeating（int type，long startTime，long intervalTime，PendingIntent pi）；<br>该方法也用于设置重复闹钟，与第二个方法相似，不过其两个闹钟执行的间隔时间不是固定的而已。</li>\n</ol>\n<p>三个方法中都有type、PendingIntent参数，type分为以下几类：</p>\n<ol>\n<li>AlarmManager.ELAPSED_REALTIME：表示闹钟在手机睡眠状态下不可用，该状态下闹钟使用相对时间（相对于系统启动开始），状态值为3</li>\n<li>AlarmManager.ELAPSED_REALTIME_WAKEUP：表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟也使用相对时间，状态值为2</li>\n<li>AlarmManager.RTC：表示闹钟在睡眠状态下不可用，该状态下闹钟使用绝对时间，即当前系统时间，状态值为1</li>\n<li>AlarmManager.RTC_WAKEUP：表示闹钟在睡眠状态下会唤醒系统并执行提示功能，该状态下闹钟使用绝对时间，状态值为0</li>\n<li>AlarmManager.POWER_OFF_WAKEUP：表示闹钟在手机关机状态下也能正常进行提示功能，所以是5个状态中用的最多的状态之一，该状态下闹钟也是用绝对时间，状态值为4；不过本状态好像受SDK版本影响，某些版本并不支持</li>\n</ol>\n<p>PendingIntent为设置接收消息类的参数，一般通过如下代码生成：<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">PendingIntent sender</span> = PendingIntent.getBroadcast(MainActivity.this, 0, intent, 0);</div></pre></td></tr></table></figure></p>\n<p>注意第二个参数为<code>requestCode</code>，该参数是闹钟的标识，如果不停设置闹钟，这个参数都一样，那么后设置的闹钟会覆盖之前的闹钟。所以如果需要多个闹钟，则需要将这个参数设为唯一。</p>\n<p>若要取消闹钟，则直接调用cancel即可，官方是这样说的：</p>\n<blockquote>\n<p>void cancel (PendingIntent operation)<br>Remove any alarms with a matching Intent. Any alarm, of any type, whose Intent matches this one (as defined by filterEquals(Intent)), will be canceled.</p>\n</blockquote>\n<p>只有符合filterEquals的intent才会被取消。<br><figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> boolean filterEquals(Intent other) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (other == <span class=\"literal\">null</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mAction, other.mAction)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mData, other.mData)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mType, other.mType)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mPackage, other.mPackage)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mComponent, other.mComponent)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!Objects.equals(<span class=\"keyword\">this</span>.mCategories, other.mCategories)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>对于即时性比较强的应用，比如直播类，闹钟定的时间要与正在直播的推送分开，不然用户就有可能收到2次通知了，所以闹钟就要定提前一点：XXX即将开始直播，类似这样。那么就会有一个问题：用户看到闹钟的这个通知后，进入应用，但是XXX是没有直播的（即将开始直播），所以对于用户当前是没有正确信息来显示的，这种体验可能不太好。如果将闹钟设置退后，XXX已经开始直播，又会显得非常怪异。<br>我的心情：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar3.jpg\" alt=\"\"><br>求同学们支招~</p>"},{"title":"Android屏幕横竖屏切换小记","date":"2016-07-01T09:22:25.000Z","_content":"\n最后做的项目中，有用到横竖屏切换，碰到个小坑，在这里记录一下。\n\n背景：用户在进入直播页面（姑且称之为RoomActivity），进入页面的时候会传入横竖屏的参数，在RoomActivity中拿到参数通过``setRequestedOrientation``来进行设置横竖屏。\n\n众所周知，android在横竖屏切换的时候，会销毁当前的页面，然后重建，导致的便是activity的生命周期会执行2次，那么写在其中的方法也会执行2次。在onStart()中我写了进入直播间的方法(enterRoom())，在onStop()中写了离开直播间的方法(exitRoom())，那么在切换屏幕的时候，会调用2次enterRoom，1次exitRoom，因为都是网络请求，不能保证后请求的一定后完成，那么就有可能导致2次enterRoom执行完成之后，exitRoom才执行完成，即用户发了2次进入直播间的请求，1次离开直播间的请求，离开的请求是最后完成，导致的最终结果便是用户不在直播间了，但他依然能看到画面，只不过看不到弹幕相关的一些东西了。\n\n这显然是个问题，需要解决。\n\n<!-- more -->\n\n方案一：\n起初，我的想法是在切换的时候保存状态，在新建的时候取出状态，根据状态来判断要不要执行第二次方法，这种想法应该是可行的，但是我找不到保存状态的方法。网上查的是``onSaveInstanceState()``方法可用来保存，但是它只会在activity意外关闭的时候才会调用，何为意外就不得知了，有点不可控，所以我便放弃了这种做法。\n\n\n方案二：\n设置activty参数，避免销毁当前页面重建。在设置``configChanges``参数后，在切换横竖屏时候便不会重建页面了，那么当前页面或得到的业务数据也自然就还在，只是要强调一点：切换横竖屏后，``所有的View需要重新进行初始化``。\n在``AndroidManifest.xml``中给activity设置如下``configChanges``参数：\n```\n<activity\n    android:name=\".RoomActivity\"\n    android:screenOrientation=\"portrait\"\n    android:keepScreenOn=\"true\"\n    android:configChanges=\"orientation|screenSize\"\n    android:windowSoftInputMode=\"adjustNothing\"/>\n```\n然后在activity的``onConfigurationChanged``中进行view的初始化。\n```\n@Override\npublic void onConfigurationChanged(Configuration newConfig) {\n    setContentView(R.layout.activity_room);\n    initViewHolder();\n    initBarrageView();\n    super.onConfigurationChanged(newConfig);\n}\n```\n之所以会重新调用``setContentView(R.layout.activity_room);``是因为我的RoomActivity有横、竖两套布局，需要重新设置一下（布局名称名字一样，横屏的布局文件写在land文件下即可）。\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/screent1.png)\n\n如此便解决了横竖屏切换导致的问题了，特此小记一下。\n\n补充：\nAndroid横屏切换可能有2种：90度和270度。这两种都是横屏。现在做直播产品，需要设置摄像头的角度，所以不仅仅需要知道横竖屏，也需要知道横屏是90度的那种还是270度的那种。如果仅仅依靠重力感应，部分安卓手机会不支持180度转屏，以致于从90度转到270度或者从270度转到90度时，系统认为界面没有发生变化，所以没有合适的机会来设置摄像头的角度。采用DisplayManager.DisplayListener可以达到目的，但是必须是Android 17以上，这就需要依据项目情况来做些取舍了。\n```\nprivate void initDisplayListener() {\n\t/**\n\t * 部分安卓手机不支持180度转屏，以致于从90度转到270度或者从270度转到90度时，系统认为界面没有发生变化\n\t * Android 17及以上可以通过DisplayManager.DisplayListener来监听手机旋转，以解决这个问题\n\t */\n\tif (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {\n\t\tmDisplayListener = new DisplayManager.DisplayListener() {\n\t\t\t@Override\n\t\t\tpublic void onDisplayAdded(int displayId) {\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tpublic void onDisplayChanged(int displayId) {\n\t\t\t\tchangeRotation();\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tpublic void onDisplayRemoved(int displayId) {\n\t\t\t}\n\t\t};\n\t\tDisplayManager displayManager = (DisplayManager) getSystemService(Context.DISPLAY_SERVICE);\n\t\tdisplayManager.registerDisplayListener(mDisplayListener, null);\n\t}\n}\n\nprivate void changeRotation() {\n\tswitch (getWindowManager().getDefaultDisplay().getRotation()) {\n\t\tcase Surface.ROTATION_0:\n\t\t\t// 0度\n\t\t\tbreak;\n\t\tcase Surface.ROTATION_90:\n\t\t\t// 90度\n\t\t\tbreak;\n\t\tcase Surface.ROTATION_180:\n\t\t\t// 180度\n\t\t\tbreak;\n\t\tcase Surface.ROTATION_270:\n\t\t\t// 270度\n\t\t\tbreak;\n\t}\n}\n```\n\n参考：\n1. [Activity 横竖屏切换](http://www.cnblogs.com/yishujun/p/5395266.html)\n2. [Android 横竖屏切换小结](http://www.cnblogs.com/franksunny/p/3714442.html)\n","source":"_posts/about-screen.md","raw":"---\ntitle: Android屏幕横竖屏切换小记\ndate: 2016-07-01 17:22:25\ntags:\n - 日常开发\n---\n\n最后做的项目中，有用到横竖屏切换，碰到个小坑，在这里记录一下。\n\n背景：用户在进入直播页面（姑且称之为RoomActivity），进入页面的时候会传入横竖屏的参数，在RoomActivity中拿到参数通过``setRequestedOrientation``来进行设置横竖屏。\n\n众所周知，android在横竖屏切换的时候，会销毁当前的页面，然后重建，导致的便是activity的生命周期会执行2次，那么写在其中的方法也会执行2次。在onStart()中我写了进入直播间的方法(enterRoom())，在onStop()中写了离开直播间的方法(exitRoom())，那么在切换屏幕的时候，会调用2次enterRoom，1次exitRoom，因为都是网络请求，不能保证后请求的一定后完成，那么就有可能导致2次enterRoom执行完成之后，exitRoom才执行完成，即用户发了2次进入直播间的请求，1次离开直播间的请求，离开的请求是最后完成，导致的最终结果便是用户不在直播间了，但他依然能看到画面，只不过看不到弹幕相关的一些东西了。\n\n这显然是个问题，需要解决。\n\n<!-- more -->\n\n方案一：\n起初，我的想法是在切换的时候保存状态，在新建的时候取出状态，根据状态来判断要不要执行第二次方法，这种想法应该是可行的，但是我找不到保存状态的方法。网上查的是``onSaveInstanceState()``方法可用来保存，但是它只会在activity意外关闭的时候才会调用，何为意外就不得知了，有点不可控，所以我便放弃了这种做法。\n\n\n方案二：\n设置activty参数，避免销毁当前页面重建。在设置``configChanges``参数后，在切换横竖屏时候便不会重建页面了，那么当前页面或得到的业务数据也自然就还在，只是要强调一点：切换横竖屏后，``所有的View需要重新进行初始化``。\n在``AndroidManifest.xml``中给activity设置如下``configChanges``参数：\n```\n<activity\n    android:name=\".RoomActivity\"\n    android:screenOrientation=\"portrait\"\n    android:keepScreenOn=\"true\"\n    android:configChanges=\"orientation|screenSize\"\n    android:windowSoftInputMode=\"adjustNothing\"/>\n```\n然后在activity的``onConfigurationChanged``中进行view的初始化。\n```\n@Override\npublic void onConfigurationChanged(Configuration newConfig) {\n    setContentView(R.layout.activity_room);\n    initViewHolder();\n    initBarrageView();\n    super.onConfigurationChanged(newConfig);\n}\n```\n之所以会重新调用``setContentView(R.layout.activity_room);``是因为我的RoomActivity有横、竖两套布局，需要重新设置一下（布局名称名字一样，横屏的布局文件写在land文件下即可）。\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/screent1.png)\n\n如此便解决了横竖屏切换导致的问题了，特此小记一下。\n\n补充：\nAndroid横屏切换可能有2种：90度和270度。这两种都是横屏。现在做直播产品，需要设置摄像头的角度，所以不仅仅需要知道横竖屏，也需要知道横屏是90度的那种还是270度的那种。如果仅仅依靠重力感应，部分安卓手机会不支持180度转屏，以致于从90度转到270度或者从270度转到90度时，系统认为界面没有发生变化，所以没有合适的机会来设置摄像头的角度。采用DisplayManager.DisplayListener可以达到目的，但是必须是Android 17以上，这就需要依据项目情况来做些取舍了。\n```\nprivate void initDisplayListener() {\n\t/**\n\t * 部分安卓手机不支持180度转屏，以致于从90度转到270度或者从270度转到90度时，系统认为界面没有发生变化\n\t * Android 17及以上可以通过DisplayManager.DisplayListener来监听手机旋转，以解决这个问题\n\t */\n\tif (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {\n\t\tmDisplayListener = new DisplayManager.DisplayListener() {\n\t\t\t@Override\n\t\t\tpublic void onDisplayAdded(int displayId) {\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tpublic void onDisplayChanged(int displayId) {\n\t\t\t\tchangeRotation();\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tpublic void onDisplayRemoved(int displayId) {\n\t\t\t}\n\t\t};\n\t\tDisplayManager displayManager = (DisplayManager) getSystemService(Context.DISPLAY_SERVICE);\n\t\tdisplayManager.registerDisplayListener(mDisplayListener, null);\n\t}\n}\n\nprivate void changeRotation() {\n\tswitch (getWindowManager().getDefaultDisplay().getRotation()) {\n\t\tcase Surface.ROTATION_0:\n\t\t\t// 0度\n\t\t\tbreak;\n\t\tcase Surface.ROTATION_90:\n\t\t\t// 90度\n\t\t\tbreak;\n\t\tcase Surface.ROTATION_180:\n\t\t\t// 180度\n\t\t\tbreak;\n\t\tcase Surface.ROTATION_270:\n\t\t\t// 270度\n\t\t\tbreak;\n\t}\n}\n```\n\n参考：\n1. [Activity 横竖屏切换](http://www.cnblogs.com/yishujun/p/5395266.html)\n2. [Android 横竖屏切换小结](http://www.cnblogs.com/franksunny/p/3714442.html)\n","slug":"about-screen","published":1,"updated":"2016-11-21T10:00:26.433Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e757w00051cb86ygeg01w","content":"<p>最后做的项目中，有用到横竖屏切换，碰到个小坑，在这里记录一下。</p>\n<p>背景：用户在进入直播页面（姑且称之为RoomActivity），进入页面的时候会传入横竖屏的参数，在RoomActivity中拿到参数通过<code>setRequestedOrientation</code>来进行设置横竖屏。</p>\n<p>众所周知，android在横竖屏切换的时候，会销毁当前的页面，然后重建，导致的便是activity的生命周期会执行2次，那么写在其中的方法也会执行2次。在onStart()中我写了进入直播间的方法(enterRoom())，在onStop()中写了离开直播间的方法(exitRoom())，那么在切换屏幕的时候，会调用2次enterRoom，1次exitRoom，因为都是网络请求，不能保证后请求的一定后完成，那么就有可能导致2次enterRoom执行完成之后，exitRoom才执行完成，即用户发了2次进入直播间的请求，1次离开直播间的请求，离开的请求是最后完成，导致的最终结果便是用户不在直播间了，但他依然能看到画面，只不过看不到弹幕相关的一些东西了。</p>\n<p>这显然是个问题，需要解决。</p>\n<a id=\"more\"></a>\n<p>方案一：<br>起初，我的想法是在切换的时候保存状态，在新建的时候取出状态，根据状态来判断要不要执行第二次方法，这种想法应该是可行的，但是我找不到保存状态的方法。网上查的是<code>onSaveInstanceState()</code>方法可用来保存，但是它只会在activity意外关闭的时候才会调用，何为意外就不得知了，有点不可控，所以我便放弃了这种做法。</p>\n<p>方案二：<br>设置activty参数，避免销毁当前页面重建。在设置<code>configChanges</code>参数后，在切换横竖屏时候便不会重建页面了，那么当前页面或得到的业务数据也自然就还在，只是要强调一点：切换横竖屏后，<code>所有的View需要重新进行初始化</code>。<br>在<code>AndroidManifest.xml</code>中给activity设置如下<code>configChanges</code>参数：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;activity</div><div class=\"line\">    android:<span class=\"built_in\">name</span>=<span class=\"string\">\".RoomActivity\"</span></div><div class=\"line\">    android:screenOrientation=<span class=\"string\">\"portrait\"</span></div><div class=\"line\">    android:keepScreenOn=<span class=\"string\">\"true\"</span></div><div class=\"line\">    android:configChanges=<span class=\"string\">\"orientation|screenSize\"</span></div><div class=\"line\">    android:windowSoftInputMode=<span class=\"string\">\"adjustNothing\"</span>/&gt;</div></pre></td></tr></table></figure></p>\n<p>然后在activity的<code>onConfigurationChanged</code>中进行view的初始化。<br><figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">@Override</div><div class=\"line\"><span class=\"keyword\">public</span> void onConfigurationChanged(Configuration <span class=\"keyword\">new</span><span class=\"type\">Config</span>) &#123;</div><div class=\"line\">    setContentView(R.layout.activity_room);</div><div class=\"line\">    initViewHolder();</div><div class=\"line\">    initBarrageView();</div><div class=\"line\">    <span class=\"keyword\">super</span>.onConfigurationChanged(<span class=\"keyword\">new</span><span class=\"type\">Config</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>之所以会重新调用<code>setContentView(R.layout.activity_room);</code>是因为我的RoomActivity有横、竖两套布局，需要重新设置一下（布局名称名字一样，横屏的布局文件写在land文件下即可）。</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/screent1.png\" alt=\"\"></p>\n<p>如此便解决了横竖屏切换导致的问题了，特此小记一下。</p>\n<p>补充：<br>Android横屏切换可能有2种：90度和270度。这两种都是横屏。现在做直播产品，需要设置摄像头的角度，所以不仅仅需要知道横竖屏，也需要知道横屏是90度的那种还是270度的那种。如果仅仅依靠重力感应，部分安卓手机会不支持180度转屏，以致于从90度转到270度或者从270度转到90度时，系统认为界面没有发生变化，所以没有合适的机会来设置摄像头的角度。采用DisplayManager.DisplayListener可以达到目的，但是必须是Android 17以上，这就需要依据项目情况来做些取舍了。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initDisplayListener</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t<span class=\"comment\">/**</span></div><div class=\"line\">\t * 部分安卓手机不支持180度转屏，以致于从90度转到270度或者从270度转到90度时，系统认为界面没有发生变化</div><div class=\"line\">\t * Android 17及以上可以通过DisplayManager.DisplayListener来监听手机旋转，以解决这个问题</div><div class=\"line\">\t */</div><div class=\"line\">\t<span class=\"keyword\">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</div><div class=\"line\">\t\tmDisplayListener = <span class=\"keyword\">new</span> DisplayManager.DisplayListener() &#123;</div><div class=\"line\">\t\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDisplayAdded</span><span class=\"params\">(<span class=\"keyword\">int</span> displayId)</span> </span>&#123;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDisplayChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> displayId)</span> </span>&#123;</div><div class=\"line\">\t\t\t\tchangeRotation();</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDisplayRemoved</span><span class=\"params\">(<span class=\"keyword\">int</span> displayId)</span> </span>&#123;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;;</div><div class=\"line\">\t\tDisplayManager displayManager = (DisplayManager) getSystemService(Context.DISPLAY_SERVICE);</div><div class=\"line\">\t\tdisplayManager.registerDisplayListener(mDisplayListener, <span class=\"keyword\">null</span>);</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">changeRotation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">switch</span> (getWindowManager().getDefaultDisplay().getRotation()) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">case</span> Surface.ROTATION_0:</div><div class=\"line\">\t\t\t<span class=\"comment\">// 0度</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">case</span> Surface.ROTATION_90:</div><div class=\"line\">\t\t\t<span class=\"comment\">// 90度</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">case</span> Surface.ROTATION_180:</div><div class=\"line\">\t\t\t<span class=\"comment\">// 180度</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">case</span> Surface.ROTATION_270:</div><div class=\"line\">\t\t\t<span class=\"comment\">// 270度</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>参考：</p>\n<ol>\n<li><a href=\"http://www.cnblogs.com/yishujun/p/5395266.html\" target=\"_blank\" rel=\"external\">Activity 横竖屏切换</a></li>\n<li><a href=\"http://www.cnblogs.com/franksunny/p/3714442.html\" target=\"_blank\" rel=\"external\">Android 横竖屏切换小结</a></li>\n</ol>\n","excerpt":"<p>最后做的项目中，有用到横竖屏切换，碰到个小坑，在这里记录一下。</p>\n<p>背景：用户在进入直播页面（姑且称之为RoomActivity），进入页面的时候会传入横竖屏的参数，在RoomActivity中拿到参数通过<code>setRequestedOrientation</code>来进行设置横竖屏。</p>\n<p>众所周知，android在横竖屏切换的时候，会销毁当前的页面，然后重建，导致的便是activity的生命周期会执行2次，那么写在其中的方法也会执行2次。在onStart()中我写了进入直播间的方法(enterRoom())，在onStop()中写了离开直播间的方法(exitRoom())，那么在切换屏幕的时候，会调用2次enterRoom，1次exitRoom，因为都是网络请求，不能保证后请求的一定后完成，那么就有可能导致2次enterRoom执行完成之后，exitRoom才执行完成，即用户发了2次进入直播间的请求，1次离开直播间的请求，离开的请求是最后完成，导致的最终结果便是用户不在直播间了，但他依然能看到画面，只不过看不到弹幕相关的一些东西了。</p>\n<p>这显然是个问题，需要解决。</p>","more":"<p>方案一：<br>起初，我的想法是在切换的时候保存状态，在新建的时候取出状态，根据状态来判断要不要执行第二次方法，这种想法应该是可行的，但是我找不到保存状态的方法。网上查的是<code>onSaveInstanceState()</code>方法可用来保存，但是它只会在activity意外关闭的时候才会调用，何为意外就不得知了，有点不可控，所以我便放弃了这种做法。</p>\n<p>方案二：<br>设置activty参数，避免销毁当前页面重建。在设置<code>configChanges</code>参数后，在切换横竖屏时候便不会重建页面了，那么当前页面或得到的业务数据也自然就还在，只是要强调一点：切换横竖屏后，<code>所有的View需要重新进行初始化</code>。<br>在<code>AndroidManifest.xml</code>中给activity设置如下<code>configChanges</code>参数：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;activity</div><div class=\"line\">    android:<span class=\"built_in\">name</span>=<span class=\"string\">\".RoomActivity\"</span></div><div class=\"line\">    android:screenOrientation=<span class=\"string\">\"portrait\"</span></div><div class=\"line\">    android:keepScreenOn=<span class=\"string\">\"true\"</span></div><div class=\"line\">    android:configChanges=<span class=\"string\">\"orientation|screenSize\"</span></div><div class=\"line\">    android:windowSoftInputMode=<span class=\"string\">\"adjustNothing\"</span>/&gt;</div></pre></td></tr></table></figure></p>\n<p>然后在activity的<code>onConfigurationChanged</code>中进行view的初始化。<br><figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">@Override</div><div class=\"line\"><span class=\"keyword\">public</span> void onConfigurationChanged(Configuration <span class=\"keyword\">new</span><span class=\"type\">Config</span>) &#123;</div><div class=\"line\">    setContentView(R.layout.activity_room);</div><div class=\"line\">    initViewHolder();</div><div class=\"line\">    initBarrageView();</div><div class=\"line\">    <span class=\"keyword\">super</span>.onConfigurationChanged(<span class=\"keyword\">new</span><span class=\"type\">Config</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>之所以会重新调用<code>setContentView(R.layout.activity_room);</code>是因为我的RoomActivity有横、竖两套布局，需要重新设置一下（布局名称名字一样，横屏的布局文件写在land文件下即可）。</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/screent1.png\" alt=\"\"></p>\n<p>如此便解决了横竖屏切换导致的问题了，特此小记一下。</p>\n<p>补充：<br>Android横屏切换可能有2种：90度和270度。这两种都是横屏。现在做直播产品，需要设置摄像头的角度，所以不仅仅需要知道横竖屏，也需要知道横屏是90度的那种还是270度的那种。如果仅仅依靠重力感应，部分安卓手机会不支持180度转屏，以致于从90度转到270度或者从270度转到90度时，系统认为界面没有发生变化，所以没有合适的机会来设置摄像头的角度。采用DisplayManager.DisplayListener可以达到目的，但是必须是Android 17以上，这就需要依据项目情况来做些取舍了。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initDisplayListener</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t<span class=\"comment\">/**</div><div class=\"line\">\t * 部分安卓手机不支持180度转屏，以致于从90度转到270度或者从270度转到90度时，系统认为界面没有发生变化</div><div class=\"line\">\t * Android 17及以上可以通过DisplayManager.DisplayListener来监听手机旋转，以解决这个问题</div><div class=\"line\">\t */</span></div><div class=\"line\">\t<span class=\"keyword\">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</div><div class=\"line\">\t\tmDisplayListener = <span class=\"keyword\">new</span> DisplayManager.DisplayListener() &#123;</div><div class=\"line\">\t\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDisplayAdded</span><span class=\"params\">(<span class=\"keyword\">int</span> displayId)</span> </span>&#123;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDisplayChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> displayId)</span> </span>&#123;</div><div class=\"line\">\t\t\t\tchangeRotation();</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDisplayRemoved</span><span class=\"params\">(<span class=\"keyword\">int</span> displayId)</span> </span>&#123;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;;</div><div class=\"line\">\t\tDisplayManager displayManager = (DisplayManager) getSystemService(Context.DISPLAY_SERVICE);</div><div class=\"line\">\t\tdisplayManager.registerDisplayListener(mDisplayListener, <span class=\"keyword\">null</span>);</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">changeRotation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">switch</span> (getWindowManager().getDefaultDisplay().getRotation()) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">case</span> Surface.ROTATION_0:</div><div class=\"line\">\t\t\t<span class=\"comment\">// 0度</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">case</span> Surface.ROTATION_90:</div><div class=\"line\">\t\t\t<span class=\"comment\">// 90度</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">case</span> Surface.ROTATION_180:</div><div class=\"line\">\t\t\t<span class=\"comment\">// 180度</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">case</span> Surface.ROTATION_270:</div><div class=\"line\">\t\t\t<span class=\"comment\">// 270度</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>参考：</p>\n<ol>\n<li><a href=\"http://www.cnblogs.com/yishujun/p/5395266.html\">Activity 横竖屏切换</a></li>\n<li><a href=\"http://www.cnblogs.com/franksunny/p/3714442.html\">Android 横竖屏切换小结</a></li>\n</ol>"},{"title":"Andoird开发中适配小记","date":"2016-07-21T01:59:06.000Z","_content":"\nAndroid也做了一段时间了，做的项目也经历过大大小小的测试，这里把一些适配的实际情形写下来，方便日后查阅，后面会持续更新。\n主要记录一些适配的实际情形，至于使用.9图、dp单位这类适配就不说了。\n\n<!-- more -->\n\n## 适配虚拟按键\n部分手机会有虚拟按键，会占用屏幕的一定空间，当我们的界面布局存在“硬编码”的时候（固定写死多少dp），就可能导致界面显示出问题。\n可以通过如下方法来判断是否有虚拟按键：\n```\n/**\n * 是否有虚拟按键\n *\n * @return\n */\npublic static boolean checkDeviceHasNavigationBar(Context context) {\n    boolean hasNavigationBar = false;\n    Resources rs = context.getResources();\n    int id = rs.getIdentifier(\"config_showNavigationBar\", \"bool\", \"android\");\n    if (id > 0) {\n        hasNavigationBar = rs.getBoolean(id);\n    }\n    try {\n        Class systemPropertiesClass = Class.forName(\"android.os.SystemProperties\");\n        Method m = systemPropertiesClass.getMethod(\"get\", String.class);\n        String navBarOverride = (String) m.invoke(systemPropertiesClass, \"qemu.hw.mainkeys\");\n        if (\"1\".equals(navBarOverride)) {\n            hasNavigationBar = false;\n        } else if (\"0\".equals(navBarOverride)) {\n            hasNavigationBar = true;\n        }\n    } catch (Exception e) {\n\n    }\n    return hasNavigationBar;\n}\n```\n然后通过如下方法获取虚拟按键的高度：\n```\n/**\n * 获取虚拟按键的高度\n *\n * @return\n */\npublic int getNavigationBarHeight() {\n    Resources resources = context.getResources();\n    int resourceId = resources.getIdentifier(\"navigation_bar_height\", \"dimen\", \"android\");\n    if (resourceId > 0) {\n        return resources.getDimensionPixelSize(resourceId);\n    }\n    return 0;\n}\n```\n获得到高度之后，便能代码控制之前的“硬编码”了，依情况减去或者加上虚拟按键的高度便可以解决这类问题的适配的。示例如下：\n```\n// 如果有虚拟按键，则加上虚拟按键的高度\nif (checkDeviceHasNavigationBar(context)) {\n    int navigationBarHeight = getNavigationBarHeight();\n    RecyclerView.LayoutParams params = (RecyclerView.LayoutParams) holder.root.getLayoutParams();\n    params.bottomMargin = (int) (context.getResources().getDimension(R.dimen.minus_living_card_height) - navigationBarHeight);\n    holder.root.setLayoutParams(params);\n}\n```\n当然你也可以简单粗暴的隐藏掉虚拟按键。代码如下：\n```\nView decorView = getWindow().getDecorView();\ndecorView.setSystemUiVisibility(\n           View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n           | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n           | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n           | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION // hide nav bar\n           | View.SYSTEM_UI_FLAG_FULLSCREEN // hide status bar\n           | View.SYSTEM_UI_FLAG_IMMERSIVE);\n```\n\n## Android4.4横屏弹出的对话框顶部被状态栏遮盖\n效果就像这样：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter1.png)\n初步感觉是Android4.4的一个BUG，可以在Dialog创建的时候，添加如下代码来解决问题：\n```\n/**\n * 针对Android 4.4在横屏下顶部被状态栏遮挡的问题\n * 暂没有4.4以下的手机进行测试\n */\nif (Build.VERSION.SDK_INT == 19) {\n    mWindow.setFlags(\n            WindowManager.LayoutParams.FLAG_FULLSCREEN,\n            WindowManager.LayoutParams.FLAG_FULLSCREEN);\n}\n```\n\n## 联想K3 Note中GridView自带分隔线\n效果就像这样：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter2.png)\n在GridViewz中添加``horizontalSpacing``、``verticalSpacing``2条属性来解决问题：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<CustomGridView xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"wrap_content\"\n    android:horizontalSpacing=\"0dp\"\n    android:listSelector=\"@color/transparent\"\n    android:numColumns=\"3\"\n    android:scrollbars=\"none\"\n    android:verticalSpacing=\"0dp\" />\n```\n\n## VideoView切换横竖屏\nVideoView在切换横竖屏，如果是Activity跳转，那么就会重新加载，导致切换前后不连贯。\n所以我的做法是：只有一个Activity，点击全屏按钮将其置为横屏状态，每次切换的时候，显示一套布局，隐藏一套布局。配置activity的``android:configChanges=\"orientation|screenSize\"``，这样在切换的时候就不会重新布局，然后在``onConfigurationChanged``中进行相关操作：\n```\n@Override\npublic void onConfigurationChanged(Configuration newConfig) {\n    /**\n     * 适配部分机型在旋转的时候，视频尺寸没有自适应的问题\n     */\n    videoView.getHolder().setFixedSize(videoView.getWidth(), videoView.getHeight());\n    if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {\n        // 横屏时隐藏竖屏布局\n    } else {\n        // 竖屏时隐藏横屏布局\n    }\n    super.onConfigurationChanged(newConfig);\n}\n```\n但是在部分机型会导致切换后视屏尺寸没有自适应，如图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter3.gif)\n利用如上代码``videoView.getHolder().setFixedSize(videoView.getWidth(), videoView.getHeight());``即可解决问题。\n","source":"_posts/android-adapter.md","raw":"---\ntitle: Andoird开发中适配小记\ndate: 2016-07-21 09:59:06\ntags:\n - 日常开发\n---\n\nAndroid也做了一段时间了，做的项目也经历过大大小小的测试，这里把一些适配的实际情形写下来，方便日后查阅，后面会持续更新。\n主要记录一些适配的实际情形，至于使用.9图、dp单位这类适配就不说了。\n\n<!-- more -->\n\n## 适配虚拟按键\n部分手机会有虚拟按键，会占用屏幕的一定空间，当我们的界面布局存在“硬编码”的时候（固定写死多少dp），就可能导致界面显示出问题。\n可以通过如下方法来判断是否有虚拟按键：\n```\n/**\n * 是否有虚拟按键\n *\n * @return\n */\npublic static boolean checkDeviceHasNavigationBar(Context context) {\n    boolean hasNavigationBar = false;\n    Resources rs = context.getResources();\n    int id = rs.getIdentifier(\"config_showNavigationBar\", \"bool\", \"android\");\n    if (id > 0) {\n        hasNavigationBar = rs.getBoolean(id);\n    }\n    try {\n        Class systemPropertiesClass = Class.forName(\"android.os.SystemProperties\");\n        Method m = systemPropertiesClass.getMethod(\"get\", String.class);\n        String navBarOverride = (String) m.invoke(systemPropertiesClass, \"qemu.hw.mainkeys\");\n        if (\"1\".equals(navBarOverride)) {\n            hasNavigationBar = false;\n        } else if (\"0\".equals(navBarOverride)) {\n            hasNavigationBar = true;\n        }\n    } catch (Exception e) {\n\n    }\n    return hasNavigationBar;\n}\n```\n然后通过如下方法获取虚拟按键的高度：\n```\n/**\n * 获取虚拟按键的高度\n *\n * @return\n */\npublic int getNavigationBarHeight() {\n    Resources resources = context.getResources();\n    int resourceId = resources.getIdentifier(\"navigation_bar_height\", \"dimen\", \"android\");\n    if (resourceId > 0) {\n        return resources.getDimensionPixelSize(resourceId);\n    }\n    return 0;\n}\n```\n获得到高度之后，便能代码控制之前的“硬编码”了，依情况减去或者加上虚拟按键的高度便可以解决这类问题的适配的。示例如下：\n```\n// 如果有虚拟按键，则加上虚拟按键的高度\nif (checkDeviceHasNavigationBar(context)) {\n    int navigationBarHeight = getNavigationBarHeight();\n    RecyclerView.LayoutParams params = (RecyclerView.LayoutParams) holder.root.getLayoutParams();\n    params.bottomMargin = (int) (context.getResources().getDimension(R.dimen.minus_living_card_height) - navigationBarHeight);\n    holder.root.setLayoutParams(params);\n}\n```\n当然你也可以简单粗暴的隐藏掉虚拟按键。代码如下：\n```\nView decorView = getWindow().getDecorView();\ndecorView.setSystemUiVisibility(\n           View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n           | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n           | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n           | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION // hide nav bar\n           | View.SYSTEM_UI_FLAG_FULLSCREEN // hide status bar\n           | View.SYSTEM_UI_FLAG_IMMERSIVE);\n```\n\n## Android4.4横屏弹出的对话框顶部被状态栏遮盖\n效果就像这样：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter1.png)\n初步感觉是Android4.4的一个BUG，可以在Dialog创建的时候，添加如下代码来解决问题：\n```\n/**\n * 针对Android 4.4在横屏下顶部被状态栏遮挡的问题\n * 暂没有4.4以下的手机进行测试\n */\nif (Build.VERSION.SDK_INT == 19) {\n    mWindow.setFlags(\n            WindowManager.LayoutParams.FLAG_FULLSCREEN,\n            WindowManager.LayoutParams.FLAG_FULLSCREEN);\n}\n```\n\n## 联想K3 Note中GridView自带分隔线\n效果就像这样：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter2.png)\n在GridViewz中添加``horizontalSpacing``、``verticalSpacing``2条属性来解决问题：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<CustomGridView xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"wrap_content\"\n    android:horizontalSpacing=\"0dp\"\n    android:listSelector=\"@color/transparent\"\n    android:numColumns=\"3\"\n    android:scrollbars=\"none\"\n    android:verticalSpacing=\"0dp\" />\n```\n\n## VideoView切换横竖屏\nVideoView在切换横竖屏，如果是Activity跳转，那么就会重新加载，导致切换前后不连贯。\n所以我的做法是：只有一个Activity，点击全屏按钮将其置为横屏状态，每次切换的时候，显示一套布局，隐藏一套布局。配置activity的``android:configChanges=\"orientation|screenSize\"``，这样在切换的时候就不会重新布局，然后在``onConfigurationChanged``中进行相关操作：\n```\n@Override\npublic void onConfigurationChanged(Configuration newConfig) {\n    /**\n     * 适配部分机型在旋转的时候，视频尺寸没有自适应的问题\n     */\n    videoView.getHolder().setFixedSize(videoView.getWidth(), videoView.getHeight());\n    if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {\n        // 横屏时隐藏竖屏布局\n    } else {\n        // 竖屏时隐藏横屏布局\n    }\n    super.onConfigurationChanged(newConfig);\n}\n```\n但是在部分机型会导致切换后视屏尺寸没有自适应，如图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter3.gif)\n利用如上代码``videoView.getHolder().setFixedSize(videoView.getWidth(), videoView.getHeight());``即可解决问题。\n","slug":"android-adapter","published":1,"updated":"2016-11-21T09:56:51.745Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758100071cb8bzwrkr44","content":"<p>Android也做了一段时间了，做的项目也经历过大大小小的测试，这里把一些适配的实际情形写下来，方便日后查阅，后面会持续更新。<br>主要记录一些适配的实际情形，至于使用.9图、dp单位这类适配就不说了。</p>\n<a id=\"more\"></a>\n<h2 id=\"适配虚拟按键\"><a href=\"#适配虚拟按键\" class=\"headerlink\" title=\"适配虚拟按键\"></a>适配虚拟按键</h2><p>部分手机会有虚拟按键，会占用屏幕的一定空间，当我们的界面布局存在“硬编码”的时候（固定写死多少dp），就可能导致界面显示出问题。<br>可以通过如下方法来判断是否有虚拟按键：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 是否有虚拟按键</div><div class=\"line\"> *</div><div class=\"line\"> * @return</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> checkDeviceHasNavigationBar(Context context) &#123;</div><div class=\"line\">    <span class=\"keyword\">boolean</span> hasNavigationBar = <span class=\"keyword\">false</span>;</div><div class=\"line\">    Resources rs = context.getResources();</div><div class=\"line\">    <span class=\"keyword\">int</span> id = rs.getIdentifier(<span class=\"string\">\"config_showNavigationBar\"</span>, <span class=\"string\">\"bool\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (id &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        hasNavigationBar = rs.getBoolean(id);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">Class</span> systemPropertiesClass = <span class=\"keyword\">Class</span>.forName(<span class=\"string\">\"android.os.SystemProperties\"</span>);</div><div class=\"line\">        Method m = systemPropertiesClass.getMethod(<span class=\"string\">\"get\"</span>, String.<span class=\"keyword\">class</span>);</div><div class=\"line\">        String navBarOverride = (String) m.invoke(systemPropertiesClass, <span class=\"string\">\"qemu.hw.mainkeys\"</span>);</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"string\">\"1\"</span>.equals(navBarOverride)) &#123;</div><div class=\"line\">            hasNavigationBar = <span class=\"keyword\">false</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"string\">\"0\"</span>.equals(navBarOverride)) &#123;</div><div class=\"line\">            hasNavigationBar = <span class=\"keyword\">true</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> hasNavigationBar;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后通过如下方法获取虚拟按键的高度：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 获取虚拟按键的高度</div><div class=\"line\"> *</div><div class=\"line\"> * <span class=\"doctag\">@return</span></div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getNavigationBarHeight</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    Resources resources = context.getResources();</div><div class=\"line\">    <span class=\"keyword\">int</span> resourceId = resources.getIdentifier(<span class=\"string\">\"navigation_bar_height\"</span>, <span class=\"string\">\"dimen\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (resourceId &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> resources.<span class=\"title\">getDimensionPixelSize</span><span class=\"params\">(resourceId)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>获得到高度之后，便能代码控制之前的“硬编码”了，依情况减去或者加上虚拟按键的高度便可以解决这类问题的适配的。示例如下：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 如果有虚拟按键，则加上虚拟按键的高度</span></div><div class=\"line\"><span class=\"keyword\">if</span> (checkDeviceHasNavigationBar(context)) &#123;</div><div class=\"line\">    <span class=\"keyword\">int</span> navigationBarHeight = getNavigationBarHeight();</div><div class=\"line\">    RecyclerView.LayoutParams <span class=\"keyword\">params</span> = (RecyclerView.LayoutParams) holder.root.getLayoutParams();</div><div class=\"line\">    <span class=\"keyword\">params</span>.bottomMargin = (<span class=\"keyword\">int</span>) (context.getResources().getDimension(R.dimen.minus_living_card_height) - navigationBarHeight);</div><div class=\"line\">    holder.root.setLayoutParams(<span class=\"keyword\">params</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>当然你也可以简单粗暴的隐藏掉虚拟按键。代码如下：<br><figure class=\"highlight cos\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">View</span> decorView = getWindow().getDecorView()<span class=\"comment\">;</span></div><div class=\"line\">decorView.setSystemUiVisibility(</div><div class=\"line\">           <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_HIDE_NAVIGATION <span class=\"comment\">// hide nav bar</span></div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_FULLSCREEN <span class=\"comment\">// hide status bar</span></div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_IMMERSIVE)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"Android4-4横屏弹出的对话框顶部被状态栏遮盖\"><a href=\"#Android4-4横屏弹出的对话框顶部被状态栏遮盖\" class=\"headerlink\" title=\"Android4.4横屏弹出的对话框顶部被状态栏遮盖\"></a>Android4.4横屏弹出的对话框顶部被状态栏遮盖</h2><p>效果就像这样：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter1.png\" alt=\"\"><br>初步感觉是Android4.4的一个BUG，可以在Dialog创建的时候，添加如下代码来解决问题：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 针对Android 4.4在横屏下顶部被状态栏遮挡的问题</div><div class=\"line\"> * 暂没有4.4以下的手机进行测试</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"selector-tag\">if</span> (Build.VERSION.SDK_INT == <span class=\"number\">19</span>) &#123;</div><div class=\"line\">    <span class=\"selector-tag\">mWindow</span><span class=\"selector-class\">.setFlags</span>(</div><div class=\"line\">            WindowManager.LayoutParams.FLAG_FULLSCREEN,</div><div class=\"line\">            WindowManager.LayoutParams.FLAG_FULLSCREEN);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"联想K3-Note中GridView自带分隔线\"><a href=\"#联想K3-Note中GridView自带分隔线\" class=\"headerlink\" title=\"联想K3 Note中GridView自带分隔线\"></a>联想K3 Note中GridView自带分隔线</h2><p>效果就像这样：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter2.png\" alt=\"\"><br>在GridViewz中添加<code>horizontalSpacing</code>、<code>verticalSpacing</code>2条属性来解决问题：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">CustomGridView</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">    <span class=\"attr\">android:horizontalSpacing</span>=<span class=\"string\">\"0dp\"</span></div><div class=\"line\">    <span class=\"attr\">android:listSelector</span>=<span class=\"string\">\"@color/transparent\"</span></div><div class=\"line\">    <span class=\"attr\">android:numColumns</span>=<span class=\"string\">\"3\"</span></div><div class=\"line\">    <span class=\"attr\">android:scrollbars</span>=<span class=\"string\">\"none\"</span></div><div class=\"line\">    <span class=\"attr\">android:verticalSpacing</span>=<span class=\"string\">\"0dp\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<h2 id=\"VideoView切换横竖屏\"><a href=\"#VideoView切换横竖屏\" class=\"headerlink\" title=\"VideoView切换横竖屏\"></a>VideoView切换横竖屏</h2><p>VideoView在切换横竖屏，如果是Activity跳转，那么就会重新加载，导致切换前后不连贯。<br>所以我的做法是：只有一个Activity，点击全屏按钮将其置为横屏状态，每次切换的时候，显示一套布局，隐藏一套布局。配置activity的<code>android:configChanges=&quot;orientation|screenSize&quot;</code>，这样在切换的时候就不会重新布局，然后在<code>onConfigurationChanged</code>中进行相关操作：<br><figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">@Override</div><div class=\"line\"><span class=\"keyword\">public</span> void onConfigurationChanged(Configuration <span class=\"keyword\">new</span><span class=\"type\">Config</span>) &#123;</div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 适配部分机型在旋转的时候，视频尺寸没有自适应的问题</div><div class=\"line\">     */</div><div class=\"line\">    videoView.getHolder().setFixedSize(videoView.getWidth(), videoView.getHeight());</div><div class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">new</span><span class=\"type\">Config</span>.orientation == Configuration.ORIENTATION_LANDSCAPE) &#123;</div><div class=\"line\">        <span class=\"comment\">// 横屏时隐藏竖屏布局</span></div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        <span class=\"comment\">// 竖屏时隐藏横屏布局</span></div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">super</span>.onConfigurationChanged(<span class=\"keyword\">new</span><span class=\"type\">Config</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>但是在部分机型会导致切换后视屏尺寸没有自适应，如图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter3.gif\" alt=\"\"><br>利用如上代码<code>videoView.getHolder().setFixedSize(videoView.getWidth(), videoView.getHeight());</code>即可解决问题。</p>\n","excerpt":"<p>Android也做了一段时间了，做的项目也经历过大大小小的测试，这里把一些适配的实际情形写下来，方便日后查阅，后面会持续更新。<br>主要记录一些适配的实际情形，至于使用.9图、dp单位这类适配就不说了。</p>","more":"<h2 id=\"适配虚拟按键\"><a href=\"#适配虚拟按键\" class=\"headerlink\" title=\"适配虚拟按键\"></a>适配虚拟按键</h2><p>部分手机会有虚拟按键，会占用屏幕的一定空间，当我们的界面布局存在“硬编码”的时候（固定写死多少dp），就可能导致界面显示出问题。<br>可以通过如下方法来判断是否有虚拟按键：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 是否有虚拟按键</div><div class=\"line\"> *</div><div class=\"line\"> * @return</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> checkDeviceHasNavigationBar(Context context) &#123;</div><div class=\"line\">    <span class=\"keyword\">boolean</span> hasNavigationBar = <span class=\"keyword\">false</span>;</div><div class=\"line\">    Resources rs = context.getResources();</div><div class=\"line\">    <span class=\"keyword\">int</span> id = rs.getIdentifier(<span class=\"string\">\"config_showNavigationBar\"</span>, <span class=\"string\">\"bool\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (id &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        hasNavigationBar = rs.getBoolean(id);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">Class</span> systemPropertiesClass = <span class=\"keyword\">Class</span>.forName(<span class=\"string\">\"android.os.SystemProperties\"</span>);</div><div class=\"line\">        Method m = systemPropertiesClass.getMethod(<span class=\"string\">\"get\"</span>, String.<span class=\"keyword\">class</span>);</div><div class=\"line\">        String navBarOverride = (String) m.invoke(systemPropertiesClass, <span class=\"string\">\"qemu.hw.mainkeys\"</span>);</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"string\">\"1\"</span>.equals(navBarOverride)) &#123;</div><div class=\"line\">            hasNavigationBar = <span class=\"keyword\">false</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"string\">\"0\"</span>.equals(navBarOverride)) &#123;</div><div class=\"line\">            hasNavigationBar = <span class=\"keyword\">true</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> hasNavigationBar;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后通过如下方法获取虚拟按键的高度：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 获取虚拟按键的高度</div><div class=\"line\"> *</div><div class=\"line\"> * <span class=\"doctag\">@return</span></div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getNavigationBarHeight</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    Resources resources = context.getResources();</div><div class=\"line\">    <span class=\"keyword\">int</span> resourceId = resources.getIdentifier(<span class=\"string\">\"navigation_bar_height\"</span>, <span class=\"string\">\"dimen\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (resourceId &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> resources.<span class=\"title\">getDimensionPixelSize</span><span class=\"params\">(resourceId)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>获得到高度之后，便能代码控制之前的“硬编码”了，依情况减去或者加上虚拟按键的高度便可以解决这类问题的适配的。示例如下：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 如果有虚拟按键，则加上虚拟按键的高度</span></div><div class=\"line\"><span class=\"keyword\">if</span> (checkDeviceHasNavigationBar(context)) &#123;</div><div class=\"line\">    <span class=\"keyword\">int</span> navigationBarHeight = getNavigationBarHeight();</div><div class=\"line\">    RecyclerView.LayoutParams <span class=\"keyword\">params</span> = (RecyclerView.LayoutParams) holder.root.getLayoutParams();</div><div class=\"line\">    <span class=\"keyword\">params</span>.bottomMargin = (<span class=\"keyword\">int</span>) (context.getResources().getDimension(R.dimen.minus_living_card_height) - navigationBarHeight);</div><div class=\"line\">    holder.root.setLayoutParams(<span class=\"keyword\">params</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>当然你也可以简单粗暴的隐藏掉虚拟按键。代码如下：<br><figure class=\"highlight cos\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">View</span> decorView = getWindow().getDecorView()<span class=\"comment\">;</span></div><div class=\"line\">decorView.setSystemUiVisibility(</div><div class=\"line\">           <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_HIDE_NAVIGATION <span class=\"comment\">// hide nav bar</span></div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_FULLSCREEN <span class=\"comment\">// hide status bar</span></div><div class=\"line\">           | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_IMMERSIVE)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"Android4-4横屏弹出的对话框顶部被状态栏遮盖\"><a href=\"#Android4-4横屏弹出的对话框顶部被状态栏遮盖\" class=\"headerlink\" title=\"Android4.4横屏弹出的对话框顶部被状态栏遮盖\"></a>Android4.4横屏弹出的对话框顶部被状态栏遮盖</h2><p>效果就像这样：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter1.png\" alt=\"\"><br>初步感觉是Android4.4的一个BUG，可以在Dialog创建的时候，添加如下代码来解决问题：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 针对Android 4.4在横屏下顶部被状态栏遮挡的问题</div><div class=\"line\"> * 暂没有4.4以下的手机进行测试</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"selector-tag\">if</span> (Build.VERSION.SDK_INT == <span class=\"number\">19</span>) &#123;</div><div class=\"line\">    <span class=\"selector-tag\">mWindow</span><span class=\"selector-class\">.setFlags</span>(</div><div class=\"line\">            WindowManager.LayoutParams.FLAG_FULLSCREEN,</div><div class=\"line\">            WindowManager.LayoutParams.FLAG_FULLSCREEN);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"联想K3-Note中GridView自带分隔线\"><a href=\"#联想K3-Note中GridView自带分隔线\" class=\"headerlink\" title=\"联想K3 Note中GridView自带分隔线\"></a>联想K3 Note中GridView自带分隔线</h2><p>效果就像这样：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter2.png\" alt=\"\"><br>在GridViewz中添加<code>horizontalSpacing</code>、<code>verticalSpacing</code>2条属性来解决问题：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">CustomGridView</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">    <span class=\"attr\">android:horizontalSpacing</span>=<span class=\"string\">\"0dp\"</span></div><div class=\"line\">    <span class=\"attr\">android:listSelector</span>=<span class=\"string\">\"@color/transparent\"</span></div><div class=\"line\">    <span class=\"attr\">android:numColumns</span>=<span class=\"string\">\"3\"</span></div><div class=\"line\">    <span class=\"attr\">android:scrollbars</span>=<span class=\"string\">\"none\"</span></div><div class=\"line\">    <span class=\"attr\">android:verticalSpacing</span>=<span class=\"string\">\"0dp\"</span> /&gt;</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"VideoView切换横竖屏\"><a href=\"#VideoView切换横竖屏\" class=\"headerlink\" title=\"VideoView切换横竖屏\"></a>VideoView切换横竖屏</h2><p>VideoView在切换横竖屏，如果是Activity跳转，那么就会重新加载，导致切换前后不连贯。<br>所以我的做法是：只有一个Activity，点击全屏按钮将其置为横屏状态，每次切换的时候，显示一套布局，隐藏一套布局。配置activity的<code>android:configChanges=&quot;orientation|screenSize&quot;</code>，这样在切换的时候就不会重新布局，然后在<code>onConfigurationChanged</code>中进行相关操作：<br><figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">@Override</div><div class=\"line\"><span class=\"keyword\">public</span> void onConfigurationChanged(Configuration <span class=\"keyword\">new</span><span class=\"type\">Config</span>) &#123;</div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 适配部分机型在旋转的时候，视频尺寸没有自适应的问题</div><div class=\"line\">     */</span></div><div class=\"line\">    videoView.getHolder().setFixedSize(videoView.getWidth(), videoView.getHeight());</div><div class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">new</span><span class=\"type\">Config</span>.orientation == Configuration.ORIENTATION_LANDSCAPE) &#123;</div><div class=\"line\">        <span class=\"comment\">// 横屏时隐藏竖屏布局</span></div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        <span class=\"comment\">// 竖屏时隐藏横屏布局</span></div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">super</span>.onConfigurationChanged(<span class=\"keyword\">new</span><span class=\"type\">Config</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>但是在部分机型会导致切换后视屏尺寸没有自适应，如图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/07/adapter3.gif\" alt=\"\"><br>利用如上代码<code>videoView.getHolder().setFixedSize(videoView.getWidth(), videoView.getHeight());</code>即可解决问题。</p>"},{"title":"Android接入支付宝移动支付","date":"2016-05-18T07:01:25.000Z","_content":"\n项目组支付宝商户审核通过，要准备接入支付宝移动支付的能力，本文主要讲述一下android接入支付宝移动支付SDK的步骤。\n## 前期准备\n1. [支付宝商户网站](https://b.alipay.com/newIndex.htm)注册支付宝商户账号。\n2. 签约``移动支付``产品，等到审核通过。\n3. 秘钥的生成与上传。\n注册和签约没什么好说的，由公司相关部门或人员进行操作就好了。这里重点讲一下密钥。\n\n<!-- more -->\n\n秘钥的生成：\n下载SDK资源压缩包，解压后，里面会有openssl的文件夹，里面有个``openssl.exe``，双击运行。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay1.png)\n输入如下指令生成私钥:\n```\ngenrsa -out rsa_private_key.pem 1024\n```\n``java开发者``（否则跳过此步骤）需要转换成PKCS8格式，再输入如下指令进行转换：\n```\npkcs8 -topk8 -inform PEM -in rsa_private_key.pem -outform PEM -nocrypt\n```\n可以看到下面的界面：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay2.png)\n``右键点击openssl窗口上边边缘，选择“编辑→标记”，选中要复制的文字``，将PKCS8格式私钥复制下来，保存到一个文本中，后面会用到。\n继续执行指令：\n```\nrsa -in rsa_private_key.pem -pubout -out rsa_public_key.pem\n```\n会得到公钥文本。\n\n秘钥的上传：\n登录支付宝商户账户，进入到``我的商家服务``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay3.png)\n点击``查询PID、KEY``，输入支付密码，进入到下面的页面：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay4.png)\n记录下``PID``。\n点击RSA加密后面的``添加密码``，这里我已经添加过，所以显示的查看秘钥。将生成步骤中生成的公钥文本粘贴进编辑框，点击保存，若显示``上传成功``则代表成功。\n\n## 接入SDK\n1. 将``alipaySDK-20160223.jar``jar包添加至项目中。\n2. 修改AndroidManifest.xml：\n```\n<!-- 权限 -->\n<uses-permission android:name=\"android.permission.INTERNET\" />\n<uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\" />\n<uses-permission android:name=\"android.permission.ACCESS_WIFI_STATE\" />\n<uses-permission android:name=\"android.permission.READ_PHONE_STATE\" />\n<uses-permission android:name=\"android.permission.WRITE_EXTERNAL_STORAGE\" />\n\n<!-- 当用户手机没有安装支付宝App时，会调用H5的页面进行支付，若不进行声明，则直接返回支付失败 -->\n<activity\n            android:name=\"com.alipay.sdk.app.H5PayActivity\"\n            android:configChanges=\"orientation|keyboardHidden|navigation\"\n            android:exported=\"false\"\n            android:screenOrientation=\"behind\" >\n</activity>\n<activity\n            android:name=\"com.alipay.sdk.auth.AuthActivity\"\n            android:configChanges=\"orientation|keyboardHidden|navigation\"\n            android:exported=\"false\"\n            android:screenOrientation=\"behind\" >\n </activity>\n```\n至此，SDK接入已完成。\n\n## 调用支付\n在支付宝Demo中，已经有了很详细的说明了。我们只需要填入3个字段：``PARTNER``、``SELLER``、``RSA_PRIVATE``。\n``PARTNER``就是上面步骤记录的``PID``，``SELLER``即是支付宝账号，``RSA_PRIVATE``就是记录的PKCS8格式私钥。\n这里贴一下Demo代码吧：\n```\npublic class PayDemoActivity extends FragmentActivity {\n\n    // 商户PID\n    public static final String PARTNER = \"\";\n    // 商户收款账号\n    public static final String SELLER = \"\";\n    // 商户私钥，pkcs8格式\n    public static final String RSA_PRIVATE = \"\";\n    // 支付宝公钥\n    public static final String RSA_PUBLIC = \"\";\n    private static final int SDK_PAY_FLAG = 1;\n\n    @SuppressLint(\"HandlerLeak\")\n    private Handler mHandler = new Handler() {\n        @SuppressWarnings(\"unused\")\n        public void handleMessage(Message msg) {\n            switch (msg.what) {\n                case SDK_PAY_FLAG: {\n                    PayResult payResult = new PayResult((String) msg.obj);\n                    /**\n                     * 同步返回的结果必须放置到服务端进行验证（验证的规则请看https://doc.open.alipay.com/doc2/\n                     * detail.htm?spm=0.0.0.0.xdvAU6&treeId=59&articleId=103665&\n                     * docType=1) 建议商户依赖异步通知\n                     */\n                    String resultInfo = payResult.getResult();// 同步返回需要验证的信息\n\n                    String resultStatus = payResult.getResultStatus();\n                    // 判断resultStatus 为“9000”则代表支付成功，具体状态码代表含义可参考接口文档\n                    if (TextUtils.equals(resultStatus, \"9000\")) {\n                        Toast.makeText(PayDemoActivity.this, \"支付成功\", Toast.LENGTH_SHORT).show();\n                    } else {\n                        // 判断resultStatus 为非\"9000\"则代表可能支付失败\n                        // \"8000\"代表支付结果因为支付渠道原因或者系统原因还在等待支付结果确认，最终交易是否成功以服务端异步通知为准（小概率状态）\n                        if (TextUtils.equals(resultStatus, \"8000\")) {\n                            Toast.makeText(PayDemoActivity.this, \"支付结果确认中\", Toast.LENGTH_SHORT).show();\n\n                        } else {\n                            // 其他值就可以判断为支付失败，包括用户主动取消支付，或者系统返回的错误\n                            Toast.makeText(PayDemoActivity.this, \"支付失败\", Toast.LENGTH_SHORT).show();\n\n                        }\n                    }\n                    break;\n                }\n                default:\n                    break;\n            }\n        }\n\n        ;\n    };\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.pay_main);\n    }\n\n    /**\n     * call alipay sdk pay. 调用SDK支付\n     */\n    public void pay(View v) {\n        if (TextUtils.isEmpty(PARTNER) || TextUtils.isEmpty(RSA_PRIVATE) || TextUtils.isEmpty(SELLER)) {\n            new AlertDialog.Builder(this).setTitle(\"警告\").setMessage(\"需要配置PARTNER | RSA_PRIVATE| SELLER\")\n                    .setPositiveButton(\"确定\", new DialogInterface.OnClickListener() {\n                        public void onClick(DialogInterface dialoginterface, int i) {\n                            //\n                            finish();\n                        }\n                    }).show();\n            return;\n        }\n        String orderInfo = getOrderInfo(\"测试的商品\", \"该测试商品的详细描述\", \"0.01\");\n\n        /**\n         * 特别注意，这里的签名逻辑需要放在服务端，切勿将私钥泄露在代码中！\n         */\n        String sign = sign(orderInfo);\n        try {\n            /**\n             * 仅需对sign 做URL编码\n             */\n            sign = URLEncoder.encode(sign, \"UTF-8\");\n        } catch (UnsupportedEncodingException e) {\n            e.printStackTrace();\n        }\n\n        /**\n         * 完整的符合支付宝参数规范的订单信息\n         */\n        final String payInfo = orderInfo + \"&sign=\\\"\" + sign + \"\\\"&\" + getSignType();\n\n        Runnable payRunnable = new Runnable() {\n\n            @Override\n            public void run() {\n                // 构造PayTask 对象\n                PayTask alipay = new PayTask(PayDemoActivity.this);\n                // 调用支付接口，获取支付结果\n                String result = alipay.pay(payInfo, true);\n\n                Message msg = new Message();\n                msg.what = SDK_PAY_FLAG;\n                msg.obj = result;\n                mHandler.sendMessage(msg);\n            }\n        };\n\n        // 必须异步调用\n        Thread payThread = new Thread(payRunnable);\n        payThread.start();\n    }\n\n    /**\n     * get the sdk version. 获取SDK版本号\n     */\n    public void getSDKVersion() {\n        PayTask payTask = new PayTask(this);\n        String version = payTask.getVersion();\n        Toast.makeText(this, version, Toast.LENGTH_SHORT).show();\n    }\n\n    /**\n     * 原生的H5（手机网页版支付切natvie支付） 【对应页面网页支付按钮】\n     *\n     * @param v\n     */\n    public void h5Pay(View v) {\n        Intent intent = new Intent(this, H5PayDemoActivity.class);\n        Bundle extras = new Bundle();\n        /**\n         * url是测试的网站，在app内部打开页面是基于webview打开的，demo中的webview是H5PayDemoActivity，\n         * demo中拦截url进行支付的逻辑是在H5PayDemoActivity中shouldOverrideUrlLoading方法实现，\n         * 商户可以根据自己的需求来实现\n         */\n        String url = \"http://m.meituan.com\";\n        // url可以是一号店或者美团等第三方的购物wap站点，在该网站的支付过程中，支付宝sdk完成拦截支付\n        extras.putString(\"url\", url);\n        intent.putExtras(extras);\n        startActivity(intent);\n\n    }\n\n    /**\n     * create the order info. 创建订单信息\n     */\n    private String getOrderInfo(String subject, String body, String price) {\n\n        // 签约合作者身份ID\n        String orderInfo = \"partner=\" + \"\\\"\" + PARTNER + \"\\\"\";\n\n        // 签约卖家支付宝账号\n        orderInfo += \"&seller_id=\" + \"\\\"\" + SELLER + \"\\\"\";\n\n        // 商户网站唯一订单号\n        orderInfo += \"&out_trade_no=\" + \"\\\"\" + getOutTradeNo() + \"\\\"\";\n\n        // 商品名称\n        orderInfo += \"&subject=\" + \"\\\"\" + subject + \"\\\"\";\n\n        // 商品详情\n        orderInfo += \"&body=\" + \"\\\"\" + body + \"\\\"\";\n\n        // 商品金额\n        orderInfo += \"&total_fee=\" + \"\\\"\" + price + \"\\\"\";\n\n        // 服务器异步通知页面路径\n        orderInfo += \"&notify_url=\" + \"\\\"\" + \"http://notify.msp.hk/notify.htm\" + \"\\\"\";\n\n        // 服务接口名称， 固定值\n        orderInfo += \"&service=\\\"mobile.securitypay.pay\\\"\";\n\n        // 支付类型， 固定值\n        orderInfo += \"&payment_type=\\\"1\\\"\";\n\n        // 参数编码， 固定值\n        orderInfo += \"&_input_charset=\\\"utf-8\\\"\";\n\n        // 设置未付款交易的超时时间\n        // 默认30分钟，一旦超时，该笔交易就会自动被关闭。\n        // 取值范围：1m～15d。\n        // m-分钟，h-小时，d-天，1c-当天（无论交易何时创建，都在0点关闭）。\n        // 该参数数值不接受小数点，如1.5h，可转换为90m。\n        orderInfo += \"&it_b_pay=\\\"30m\\\"\";\n\n        // extern_token为经过快登授权获取到的alipay_open_id,带上此参数用户将使用授权的账户进行支付\n        // orderInfo += \"&extern_token=\" + \"\\\"\" + extern_token + \"\\\"\";\n\n        // 支付宝处理完请求后，当前页面跳转到商户指定页面的路径，可空\n        orderInfo += \"&return_url=\\\"m.alipay.com\\\"\";\n\n        // 调用银行卡支付，需配置此参数，参与签名， 固定值 （需要签约《无线银行卡快捷支付》才能使用）\n        // orderInfo += \"&paymethod=\\\"expressGateway\\\"\";\n\n        return orderInfo;\n    }\n\n    /**\n     * get the out_trade_no for an order. 生成商户订单号，该值在商户端应保持唯一（可自定义格式规范）\n     */\n    private String getOutTradeNo() {\n        SimpleDateFormat format = new SimpleDateFormat(\"MMddHHmmss\", Locale.getDefault());\n        Date date = new Date();\n        String key = format.format(date);\n\n        Random r = new Random();\n        key = key + r.nextInt();\n        key = key.substring(0, 15);\n        return key;\n    }\n\n    /**\n     * sign the order info. 对订单信息进行签名\n     *\n     * @param content 待签名订单信息\n     */\n    private String sign(String content) {\n        return SignUtils.sign(content, RSA_PRIVATE);\n    }\n\n    /**\n     * get the sign type we use. 获取签名方式\n     */\n    private String getSignType() {\n        return \"sign_type=\\\"RSA\\\"\";\n    }\n\n}\n\n```\n代码中有个注释需要特别注意：``特别注意，这里的签名逻辑需要放在服务端，切勿将私钥泄露在代码中！``\n\n至此，整个集成就已经结束了，不得不说，支付宝的官方文档比微信好多了，哈哈~\n\n## 补充\n正式项目中需要将签名逻辑放在服务端，在我与服务端进行联调时，出现了很多问题，这里说几点：\n1. 服务端若是使用的是java，则使用PKCS8格式的秘钥，否则使用非PKCS8格式的秘钥。\n2. 请求参数可以无序，但是必须保证请求的参数与待签名参数的顺序一致。（非常坑，花了半天时间跟服务端联调才找到这个问题）\n","source":"_posts/alipay.md","raw":"---\ntitle: Android接入支付宝移动支付\ndate: 2016-05-18 15:01:25\ntags:\n - sdk\n---\n\n项目组支付宝商户审核通过，要准备接入支付宝移动支付的能力，本文主要讲述一下android接入支付宝移动支付SDK的步骤。\n## 前期准备\n1. [支付宝商户网站](https://b.alipay.com/newIndex.htm)注册支付宝商户账号。\n2. 签约``移动支付``产品，等到审核通过。\n3. 秘钥的生成与上传。\n注册和签约没什么好说的，由公司相关部门或人员进行操作就好了。这里重点讲一下密钥。\n\n<!-- more -->\n\n秘钥的生成：\n下载SDK资源压缩包，解压后，里面会有openssl的文件夹，里面有个``openssl.exe``，双击运行。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay1.png)\n输入如下指令生成私钥:\n```\ngenrsa -out rsa_private_key.pem 1024\n```\n``java开发者``（否则跳过此步骤）需要转换成PKCS8格式，再输入如下指令进行转换：\n```\npkcs8 -topk8 -inform PEM -in rsa_private_key.pem -outform PEM -nocrypt\n```\n可以看到下面的界面：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay2.png)\n``右键点击openssl窗口上边边缘，选择“编辑→标记”，选中要复制的文字``，将PKCS8格式私钥复制下来，保存到一个文本中，后面会用到。\n继续执行指令：\n```\nrsa -in rsa_private_key.pem -pubout -out rsa_public_key.pem\n```\n会得到公钥文本。\n\n秘钥的上传：\n登录支付宝商户账户，进入到``我的商家服务``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay3.png)\n点击``查询PID、KEY``，输入支付密码，进入到下面的页面：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay4.png)\n记录下``PID``。\n点击RSA加密后面的``添加密码``，这里我已经添加过，所以显示的查看秘钥。将生成步骤中生成的公钥文本粘贴进编辑框，点击保存，若显示``上传成功``则代表成功。\n\n## 接入SDK\n1. 将``alipaySDK-20160223.jar``jar包添加至项目中。\n2. 修改AndroidManifest.xml：\n```\n<!-- 权限 -->\n<uses-permission android:name=\"android.permission.INTERNET\" />\n<uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\" />\n<uses-permission android:name=\"android.permission.ACCESS_WIFI_STATE\" />\n<uses-permission android:name=\"android.permission.READ_PHONE_STATE\" />\n<uses-permission android:name=\"android.permission.WRITE_EXTERNAL_STORAGE\" />\n\n<!-- 当用户手机没有安装支付宝App时，会调用H5的页面进行支付，若不进行声明，则直接返回支付失败 -->\n<activity\n            android:name=\"com.alipay.sdk.app.H5PayActivity\"\n            android:configChanges=\"orientation|keyboardHidden|navigation\"\n            android:exported=\"false\"\n            android:screenOrientation=\"behind\" >\n</activity>\n<activity\n            android:name=\"com.alipay.sdk.auth.AuthActivity\"\n            android:configChanges=\"orientation|keyboardHidden|navigation\"\n            android:exported=\"false\"\n            android:screenOrientation=\"behind\" >\n </activity>\n```\n至此，SDK接入已完成。\n\n## 调用支付\n在支付宝Demo中，已经有了很详细的说明了。我们只需要填入3个字段：``PARTNER``、``SELLER``、``RSA_PRIVATE``。\n``PARTNER``就是上面步骤记录的``PID``，``SELLER``即是支付宝账号，``RSA_PRIVATE``就是记录的PKCS8格式私钥。\n这里贴一下Demo代码吧：\n```\npublic class PayDemoActivity extends FragmentActivity {\n\n    // 商户PID\n    public static final String PARTNER = \"\";\n    // 商户收款账号\n    public static final String SELLER = \"\";\n    // 商户私钥，pkcs8格式\n    public static final String RSA_PRIVATE = \"\";\n    // 支付宝公钥\n    public static final String RSA_PUBLIC = \"\";\n    private static final int SDK_PAY_FLAG = 1;\n\n    @SuppressLint(\"HandlerLeak\")\n    private Handler mHandler = new Handler() {\n        @SuppressWarnings(\"unused\")\n        public void handleMessage(Message msg) {\n            switch (msg.what) {\n                case SDK_PAY_FLAG: {\n                    PayResult payResult = new PayResult((String) msg.obj);\n                    /**\n                     * 同步返回的结果必须放置到服务端进行验证（验证的规则请看https://doc.open.alipay.com/doc2/\n                     * detail.htm?spm=0.0.0.0.xdvAU6&treeId=59&articleId=103665&\n                     * docType=1) 建议商户依赖异步通知\n                     */\n                    String resultInfo = payResult.getResult();// 同步返回需要验证的信息\n\n                    String resultStatus = payResult.getResultStatus();\n                    // 判断resultStatus 为“9000”则代表支付成功，具体状态码代表含义可参考接口文档\n                    if (TextUtils.equals(resultStatus, \"9000\")) {\n                        Toast.makeText(PayDemoActivity.this, \"支付成功\", Toast.LENGTH_SHORT).show();\n                    } else {\n                        // 判断resultStatus 为非\"9000\"则代表可能支付失败\n                        // \"8000\"代表支付结果因为支付渠道原因或者系统原因还在等待支付结果确认，最终交易是否成功以服务端异步通知为准（小概率状态）\n                        if (TextUtils.equals(resultStatus, \"8000\")) {\n                            Toast.makeText(PayDemoActivity.this, \"支付结果确认中\", Toast.LENGTH_SHORT).show();\n\n                        } else {\n                            // 其他值就可以判断为支付失败，包括用户主动取消支付，或者系统返回的错误\n                            Toast.makeText(PayDemoActivity.this, \"支付失败\", Toast.LENGTH_SHORT).show();\n\n                        }\n                    }\n                    break;\n                }\n                default:\n                    break;\n            }\n        }\n\n        ;\n    };\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.pay_main);\n    }\n\n    /**\n     * call alipay sdk pay. 调用SDK支付\n     */\n    public void pay(View v) {\n        if (TextUtils.isEmpty(PARTNER) || TextUtils.isEmpty(RSA_PRIVATE) || TextUtils.isEmpty(SELLER)) {\n            new AlertDialog.Builder(this).setTitle(\"警告\").setMessage(\"需要配置PARTNER | RSA_PRIVATE| SELLER\")\n                    .setPositiveButton(\"确定\", new DialogInterface.OnClickListener() {\n                        public void onClick(DialogInterface dialoginterface, int i) {\n                            //\n                            finish();\n                        }\n                    }).show();\n            return;\n        }\n        String orderInfo = getOrderInfo(\"测试的商品\", \"该测试商品的详细描述\", \"0.01\");\n\n        /**\n         * 特别注意，这里的签名逻辑需要放在服务端，切勿将私钥泄露在代码中！\n         */\n        String sign = sign(orderInfo);\n        try {\n            /**\n             * 仅需对sign 做URL编码\n             */\n            sign = URLEncoder.encode(sign, \"UTF-8\");\n        } catch (UnsupportedEncodingException e) {\n            e.printStackTrace();\n        }\n\n        /**\n         * 完整的符合支付宝参数规范的订单信息\n         */\n        final String payInfo = orderInfo + \"&sign=\\\"\" + sign + \"\\\"&\" + getSignType();\n\n        Runnable payRunnable = new Runnable() {\n\n            @Override\n            public void run() {\n                // 构造PayTask 对象\n                PayTask alipay = new PayTask(PayDemoActivity.this);\n                // 调用支付接口，获取支付结果\n                String result = alipay.pay(payInfo, true);\n\n                Message msg = new Message();\n                msg.what = SDK_PAY_FLAG;\n                msg.obj = result;\n                mHandler.sendMessage(msg);\n            }\n        };\n\n        // 必须异步调用\n        Thread payThread = new Thread(payRunnable);\n        payThread.start();\n    }\n\n    /**\n     * get the sdk version. 获取SDK版本号\n     */\n    public void getSDKVersion() {\n        PayTask payTask = new PayTask(this);\n        String version = payTask.getVersion();\n        Toast.makeText(this, version, Toast.LENGTH_SHORT).show();\n    }\n\n    /**\n     * 原生的H5（手机网页版支付切natvie支付） 【对应页面网页支付按钮】\n     *\n     * @param v\n     */\n    public void h5Pay(View v) {\n        Intent intent = new Intent(this, H5PayDemoActivity.class);\n        Bundle extras = new Bundle();\n        /**\n         * url是测试的网站，在app内部打开页面是基于webview打开的，demo中的webview是H5PayDemoActivity，\n         * demo中拦截url进行支付的逻辑是在H5PayDemoActivity中shouldOverrideUrlLoading方法实现，\n         * 商户可以根据自己的需求来实现\n         */\n        String url = \"http://m.meituan.com\";\n        // url可以是一号店或者美团等第三方的购物wap站点，在该网站的支付过程中，支付宝sdk完成拦截支付\n        extras.putString(\"url\", url);\n        intent.putExtras(extras);\n        startActivity(intent);\n\n    }\n\n    /**\n     * create the order info. 创建订单信息\n     */\n    private String getOrderInfo(String subject, String body, String price) {\n\n        // 签约合作者身份ID\n        String orderInfo = \"partner=\" + \"\\\"\" + PARTNER + \"\\\"\";\n\n        // 签约卖家支付宝账号\n        orderInfo += \"&seller_id=\" + \"\\\"\" + SELLER + \"\\\"\";\n\n        // 商户网站唯一订单号\n        orderInfo += \"&out_trade_no=\" + \"\\\"\" + getOutTradeNo() + \"\\\"\";\n\n        // 商品名称\n        orderInfo += \"&subject=\" + \"\\\"\" + subject + \"\\\"\";\n\n        // 商品详情\n        orderInfo += \"&body=\" + \"\\\"\" + body + \"\\\"\";\n\n        // 商品金额\n        orderInfo += \"&total_fee=\" + \"\\\"\" + price + \"\\\"\";\n\n        // 服务器异步通知页面路径\n        orderInfo += \"&notify_url=\" + \"\\\"\" + \"http://notify.msp.hk/notify.htm\" + \"\\\"\";\n\n        // 服务接口名称， 固定值\n        orderInfo += \"&service=\\\"mobile.securitypay.pay\\\"\";\n\n        // 支付类型， 固定值\n        orderInfo += \"&payment_type=\\\"1\\\"\";\n\n        // 参数编码， 固定值\n        orderInfo += \"&_input_charset=\\\"utf-8\\\"\";\n\n        // 设置未付款交易的超时时间\n        // 默认30分钟，一旦超时，该笔交易就会自动被关闭。\n        // 取值范围：1m～15d。\n        // m-分钟，h-小时，d-天，1c-当天（无论交易何时创建，都在0点关闭）。\n        // 该参数数值不接受小数点，如1.5h，可转换为90m。\n        orderInfo += \"&it_b_pay=\\\"30m\\\"\";\n\n        // extern_token为经过快登授权获取到的alipay_open_id,带上此参数用户将使用授权的账户进行支付\n        // orderInfo += \"&extern_token=\" + \"\\\"\" + extern_token + \"\\\"\";\n\n        // 支付宝处理完请求后，当前页面跳转到商户指定页面的路径，可空\n        orderInfo += \"&return_url=\\\"m.alipay.com\\\"\";\n\n        // 调用银行卡支付，需配置此参数，参与签名， 固定值 （需要签约《无线银行卡快捷支付》才能使用）\n        // orderInfo += \"&paymethod=\\\"expressGateway\\\"\";\n\n        return orderInfo;\n    }\n\n    /**\n     * get the out_trade_no for an order. 生成商户订单号，该值在商户端应保持唯一（可自定义格式规范）\n     */\n    private String getOutTradeNo() {\n        SimpleDateFormat format = new SimpleDateFormat(\"MMddHHmmss\", Locale.getDefault());\n        Date date = new Date();\n        String key = format.format(date);\n\n        Random r = new Random();\n        key = key + r.nextInt();\n        key = key.substring(0, 15);\n        return key;\n    }\n\n    /**\n     * sign the order info. 对订单信息进行签名\n     *\n     * @param content 待签名订单信息\n     */\n    private String sign(String content) {\n        return SignUtils.sign(content, RSA_PRIVATE);\n    }\n\n    /**\n     * get the sign type we use. 获取签名方式\n     */\n    private String getSignType() {\n        return \"sign_type=\\\"RSA\\\"\";\n    }\n\n}\n\n```\n代码中有个注释需要特别注意：``特别注意，这里的签名逻辑需要放在服务端，切勿将私钥泄露在代码中！``\n\n至此，整个集成就已经结束了，不得不说，支付宝的官方文档比微信好多了，哈哈~\n\n## 补充\n正式项目中需要将签名逻辑放在服务端，在我与服务端进行联调时，出现了很多问题，这里说几点：\n1. 服务端若是使用的是java，则使用PKCS8格式的秘钥，否则使用非PKCS8格式的秘钥。\n2. 请求参数可以无序，但是必须保证请求的参数与待签名参数的顺序一致。（非常坑，花了半天时间跟服务端联调才找到这个问题）\n","slug":"alipay","published":1,"updated":"2016-11-21T09:56:48.698Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758300081cb8z0w0jw7u","content":"<p>项目组支付宝商户审核通过，要准备接入支付宝移动支付的能力，本文主要讲述一下android接入支付宝移动支付SDK的步骤。</p>\n<h2 id=\"前期准备\"><a href=\"#前期准备\" class=\"headerlink\" title=\"前期准备\"></a>前期准备</h2><ol>\n<li><a href=\"https://b.alipay.com/newIndex.htm\" target=\"_blank\" rel=\"external\">支付宝商户网站</a>注册支付宝商户账号。</li>\n<li>签约<code>移动支付</code>产品，等到审核通过。</li>\n<li>秘钥的生成与上传。<br>注册和签约没什么好说的，由公司相关部门或人员进行操作就好了。这里重点讲一下密钥。</li>\n</ol>\n<a id=\"more\"></a>\n<p>秘钥的生成：<br>下载SDK资源压缩包，解压后，里面会有openssl的文件夹，里面有个<code>openssl.exe</code>，双击运行。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay1.png\" alt=\"\"><br>输入如下指令生成私钥:<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">genrsa -out rsa_private_key<span class=\"selector-class\">.pem</span> <span class=\"number\">1024</span></div></pre></td></tr></table></figure></p>\n<p><code>java开发者</code>（否则跳过此步骤）需要转换成PKCS8格式，再输入如下指令进行转换：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pkcs8 -topk8 -inform PEM -<span class=\"keyword\">in</span> rsa_private_key<span class=\"selector-class\">.pem</span> -outform PEM -nocrypt</div></pre></td></tr></table></figure></p>\n<p>可以看到下面的界面：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay2.png\" alt=\"\"><br><code>右键点击openssl窗口上边边缘，选择“编辑→标记”，选中要复制的文字</code>，将PKCS8格式私钥复制下来，保存到一个文本中，后面会用到。<br>继续执行指令：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsa -<span class=\"keyword\">in</span> rsa_private_key<span class=\"selector-class\">.pem</span> -pubout -out rsa_public_key.pem</div></pre></td></tr></table></figure></p>\n<p>会得到公钥文本。</p>\n<p>秘钥的上传：<br>登录支付宝商户账户，进入到<code>我的商家服务</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay3.png\" alt=\"\"><br>点击<code>查询PID、KEY</code>，输入支付密码，进入到下面的页面：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay4.png\" alt=\"\"><br>记录下<code>PID</code>。<br>点击RSA加密后面的<code>添加密码</code>，这里我已经添加过，所以显示的查看秘钥。将生成步骤中生成的公钥文本粘贴进编辑框，点击保存，若显示<code>上传成功</code>则代表成功。</p>\n<h2 id=\"接入SDK\"><a href=\"#接入SDK\" class=\"headerlink\" title=\"接入SDK\"></a>接入SDK</h2><ol>\n<li>将<code>alipaySDK-20160223.jar</code>jar包添加至项目中。</li>\n<li>修改AndroidManifest.xml：<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">&lt;!-- 权限 --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.INTERNET\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.ACCESS_NETWORK_STATE\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.ACCESS_WIFI_STATE\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.READ_PHONE_STATE\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.WRITE_EXTERNAL_STORAGE\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">&lt;!-- 当用户手机没有安装支付宝App时，会调用H5的页面进行支付，若不进行声明，则直接返回支付失败 --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span></span></div><div class=\"line\">            <span class=\"attr\">android:name</span>=<span class=\"string\">\"com.alipay.sdk.app.H5PayActivity\"</span></div><div class=\"line\">            <span class=\"attr\">android:configChanges</span>=<span class=\"string\">\"orientation|keyboardHidden|navigation\"</span></div><div class=\"line\">            <span class=\"attr\">android:exported</span>=<span class=\"string\">\"false\"</span></div><div class=\"line\">            <span class=\"attr\">android:screenOrientation</span>=<span class=\"string\">\"behind\"</span> &gt;</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span></span></div><div class=\"line\">            <span class=\"attr\">android:name</span>=<span class=\"string\">\"com.alipay.sdk.auth.AuthActivity\"</span></div><div class=\"line\">            <span class=\"attr\">android:configChanges</span>=<span class=\"string\">\"orientation|keyboardHidden|navigation\"</span></div><div class=\"line\">            <span class=\"attr\">android:exported</span>=<span class=\"string\">\"false\"</span></div><div class=\"line\">            <span class=\"attr\">android:screenOrientation</span>=<span class=\"string\">\"behind\"</span> &gt;</div><div class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>至此，SDK接入已完成。</p>\n<h2 id=\"调用支付\"><a href=\"#调用支付\" class=\"headerlink\" title=\"调用支付\"></a>调用支付</h2><p>在支付宝Demo中，已经有了很详细的说明了。我们只需要填入3个字段：<code>PARTNER</code>、<code>SELLER</code>、<code>RSA_PRIVATE</code>。<br><code>PARTNER</code>就是上面步骤记录的<code>PID</code>，<code>SELLER</code>即是支付宝账号，<code>RSA_PRIVATE</code>就是记录的PKCS8格式私钥。<br>这里贴一下Demo代码吧：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> class PayDemoActivity extends FragmentActivity &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// 商户PID</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> PARTNER = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    <span class=\"comment\">// 商户收款账号</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> SELLER = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    <span class=\"comment\">// 商户私钥，pkcs8格式</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> RSA_PRIVATE = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    <span class=\"comment\">// 支付宝公钥</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> RSA_PUBLIC = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> SDK_PAY_FLAG = <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">    @SuppressLint(<span class=\"string\">\"HandlerLeak\"</span>)</div><div class=\"line\">    <span class=\"keyword\">private</span> Handler mHandler = <span class=\"keyword\">new</span> Handler() &#123;</div><div class=\"line\">        @SuppressWarnings(<span class=\"string\">\"unused\"</span>)</div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> handleMessage(Message msg) &#123;</div><div class=\"line\">            <span class=\"keyword\">switch</span> (msg.what) &#123;</div><div class=\"line\">                <span class=\"keyword\">case</span> SDK_PAY_FLAG: &#123;</div><div class=\"line\">                    PayResult payResult = <span class=\"keyword\">new</span> PayResult((<span class=\"keyword\">String</span>) msg.obj);</div><div class=\"line\">                    <span class=\"comment\">/**</span></div><div class=\"line\">                     * 同步返回的结果必须放置到服务端进行验证（验证的规则请看https://doc.open.alipay.com/doc2/</div><div class=\"line\">                     * detail.htm?spm=0.0.0.0.xdvAU6&amp;treeId=59&amp;articleId=103665&amp;</div><div class=\"line\">                     * docType=1) 建议商户依赖异步通知</div><div class=\"line\">                     */</div><div class=\"line\">                    <span class=\"keyword\">String</span> resultInfo = payResult.getResult();<span class=\"comment\">// 同步返回需要验证的信息</span></div><div class=\"line\"></div><div class=\"line\">                    <span class=\"keyword\">String</span> resultStatus = payResult.getResultStatus();</div><div class=\"line\">                    <span class=\"comment\">// 判断resultStatus 为“9000”则代表支付成功，具体状态码代表含义可参考接口文档</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (TextUtils.equals(resultStatus, <span class=\"string\">\"9000\"</span>)) &#123;</div><div class=\"line\">                        Toast.makeText(PayDemoActivity.<span class=\"keyword\">this</span>, <span class=\"string\">\"支付成功\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                        <span class=\"comment\">// 判断resultStatus 为非\"9000\"则代表可能支付失败</span></div><div class=\"line\">                        <span class=\"comment\">// \"8000\"代表支付结果因为支付渠道原因或者系统原因还在等待支付结果确认，最终交易是否成功以服务端异步通知为准（小概率状态）</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (TextUtils.equals(resultStatus, <span class=\"string\">\"8000\"</span>)) &#123;</div><div class=\"line\">                            Toast.makeText(PayDemoActivity.<span class=\"keyword\">this</span>, <span class=\"string\">\"支付结果确认中\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\"></div><div class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                            <span class=\"comment\">// 其他值就可以判断为支付失败，包括用户主动取消支付，或者系统返回的错误</span></div><div class=\"line\">                            Toast.makeText(PayDemoActivity.<span class=\"keyword\">this</span>, <span class=\"string\">\"支付失败\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\"></div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">default</span>:</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        ;</div><div class=\"line\">    &#125;;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onCreate(Bundle savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(R.layout.pay_main);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * call alipay sdk pay. 调用SDK支付</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> pay(View v) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (TextUtils.isEmpty(PARTNER) || TextUtils.isEmpty(RSA_PRIVATE) || TextUtils.isEmpty(SELLER)) &#123;</div><div class=\"line\">            <span class=\"keyword\">new</span> AlertDialog.Builder(<span class=\"keyword\">this</span>).setTitle(<span class=\"string\">\"警告\"</span>).setMessage(<span class=\"string\">\"需要配置PARTNER | RSA_PRIVATE| SELLER\"</span>)</div><div class=\"line\">                    .setPositiveButton(<span class=\"string\">\"确定\"</span>, <span class=\"keyword\">new</span> DialogInterface.OnClickListener() &#123;</div><div class=\"line\">                        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> onClick(DialogInterface dialoginterface, <span class=\"built_in\">int</span> i) &#123;</div><div class=\"line\">                            <span class=\"comment\">//</span></div><div class=\"line\">                            finish();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;).show();</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">String</span> orderInfo = getOrderInfo(<span class=\"string\">\"测试的商品\"</span>, <span class=\"string\">\"该测试商品的详细描述\"</span>, <span class=\"string\">\"0.01\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * 特别注意，这里的签名逻辑需要放在服务端，切勿将私钥泄露在代码中！</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">String</span> sign = sign(orderInfo);</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            <span class=\"comment\">/**</span></div><div class=\"line\">             * 仅需对sign 做URL编码</div><div class=\"line\">             */</div><div class=\"line\">            sign = URLEncoder.encode(sign, <span class=\"string\">\"UTF-8\"</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (UnsupportedEncodingException e) &#123;</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * 完整的符合支付宝参数规范的订单信息</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> payInfo = orderInfo + <span class=\"string\">\"&amp;sign=\\\"\"</span> + sign + <span class=\"string\">\"\\\"&amp;\"</span> + getSignType();</div><div class=\"line\"></div><div class=\"line\">        Runnable payRunnable = <span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"></div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> run() &#123;</div><div class=\"line\">                <span class=\"comment\">// 构造PayTask 对象</span></div><div class=\"line\">                PayTask alipay = <span class=\"keyword\">new</span> PayTask(PayDemoActivity.<span class=\"keyword\">this</span>);</div><div class=\"line\">                <span class=\"comment\">// 调用支付接口，获取支付结果</span></div><div class=\"line\">                <span class=\"keyword\">String</span> result = alipay.pay(payInfo, <span class=\"keyword\">true</span>);</div><div class=\"line\"></div><div class=\"line\">                Message msg = <span class=\"keyword\">new</span> Message();</div><div class=\"line\">                msg.what = SDK_PAY_FLAG;</div><div class=\"line\">                msg.obj = result;</div><div class=\"line\">                mHandler.sendMessage(msg);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 必须异步调用</span></div><div class=\"line\">        Thread payThread = <span class=\"keyword\">new</span> Thread(payRunnable);</div><div class=\"line\">        payThread.start();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * get the sdk version. 获取SDK版本号</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> getSDKVersion() &#123;</div><div class=\"line\">        PayTask payTask = <span class=\"keyword\">new</span> PayTask(<span class=\"keyword\">this</span>);</div><div class=\"line\">        <span class=\"keyword\">String</span> version = payTask.getVersion();</div><div class=\"line\">        Toast.makeText(<span class=\"keyword\">this</span>, version, Toast.LENGTH_SHORT).show();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 原生的H5（手机网页版支付切natvie支付） 【对应页面网页支付按钮】</div><div class=\"line\">     *</div><div class=\"line\">     * @param v</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> h5Pay(View v) &#123;</div><div class=\"line\">        Intent intent = <span class=\"keyword\">new</span> Intent(<span class=\"keyword\">this</span>, H5PayDemoActivity.class);</div><div class=\"line\">        Bundle extras = <span class=\"keyword\">new</span> Bundle();</div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * url是测试的网站，在app内部打开页面是基于webview打开的，demo中的webview是H5PayDemoActivity，</div><div class=\"line\">         * demo中拦截url进行支付的逻辑是在H5PayDemoActivity中shouldOverrideUrlLoading方法实现，</div><div class=\"line\">         * 商户可以根据自己的需求来实现</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">String</span> url = <span class=\"string\">\"http://m.meituan.com\"</span>;</div><div class=\"line\">        <span class=\"comment\">// url可以是一号店或者美团等第三方的购物wap站点，在该网站的支付过程中，支付宝sdk完成拦截支付</span></div><div class=\"line\">        extras.putString(<span class=\"string\">\"url\"</span>, url);</div><div class=\"line\">        intent.putExtras(extras);</div><div class=\"line\">        startActivity(intent);</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * create the order info. 创建订单信息</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">String</span> getOrderInfo(<span class=\"keyword\">String</span> subject, <span class=\"keyword\">String</span> body, <span class=\"keyword\">String</span> price) &#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 签约合作者身份ID</span></div><div class=\"line\">        <span class=\"keyword\">String</span> orderInfo = <span class=\"string\">\"partner=\"</span> + <span class=\"string\">\"\\\"\"</span> + PARTNER + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 签约卖家支付宝账号</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;seller_id=\"</span> + <span class=\"string\">\"\\\"\"</span> + SELLER + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 商户网站唯一订单号</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;out_trade_no=\"</span> + <span class=\"string\">\"\\\"\"</span> + getOutTradeNo() + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 商品名称</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;subject=\"</span> + <span class=\"string\">\"\\\"\"</span> + subject + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 商品详情</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;body=\"</span> + <span class=\"string\">\"\\\"\"</span> + body + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 商品金额</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;total_fee=\"</span> + <span class=\"string\">\"\\\"\"</span> + price + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 服务器异步通知页面路径</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;notify_url=\"</span> + <span class=\"string\">\"\\\"\"</span> + <span class=\"string\">\"http://notify.msp.hk/notify.htm\"</span> + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 服务接口名称， 固定值</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;service=\\\"mobile.securitypay.pay\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 支付类型， 固定值</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;payment_type=\\\"1\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 参数编码， 固定值</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;_input_charset=\\\"utf-8\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 设置未付款交易的超时时间</span></div><div class=\"line\">        <span class=\"comment\">// 默认30分钟，一旦超时，该笔交易就会自动被关闭。</span></div><div class=\"line\">        <span class=\"comment\">// 取值范围：1m～15d。</span></div><div class=\"line\">        <span class=\"comment\">// m-分钟，h-小时，d-天，1c-当天（无论交易何时创建，都在0点关闭）。</span></div><div class=\"line\">        <span class=\"comment\">// 该参数数值不接受小数点，如1.5h，可转换为90m。</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;it_b_pay=\\\"30m\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// extern_token为经过快登授权获取到的alipay_open_id,带上此参数用户将使用授权的账户进行支付</span></div><div class=\"line\">        <span class=\"comment\">// orderInfo += \"&amp;extern_token=\" + \"\\\"\" + extern_token + \"\\\"\";</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 支付宝处理完请求后，当前页面跳转到商户指定页面的路径，可空</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;return_url=\\\"m.alipay.com\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 调用银行卡支付，需配置此参数，参与签名， 固定值 （需要签约《无线银行卡快捷支付》才能使用）</span></div><div class=\"line\">        <span class=\"comment\">// orderInfo += \"&amp;paymethod=\\\"expressGateway\\\"\";</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">return</span> orderInfo;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * get the out_trade_no for an order. 生成商户订单号，该值在商户端应保持唯一（可自定义格式规范）</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">String</span> getOutTradeNo() &#123;</div><div class=\"line\">        SimpleDateFormat format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">\"MMddHHmmss\"</span>, Locale.getDefault());</div><div class=\"line\">        Date date = <span class=\"keyword\">new</span> Date();</div><div class=\"line\">        <span class=\"keyword\">String</span> <span class=\"built_in\">key</span> = format.format(date);</div><div class=\"line\"></div><div class=\"line\">        Random r = <span class=\"keyword\">new</span> Random();</div><div class=\"line\">        <span class=\"built_in\">key</span> = <span class=\"built_in\">key</span> + r.nextInt();</div><div class=\"line\">        <span class=\"built_in\">key</span> = <span class=\"built_in\">key</span>.substring(<span class=\"number\">0</span>, <span class=\"number\">15</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">key</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * sign the order info. 对订单信息进行签名</div><div class=\"line\">     *</div><div class=\"line\">     * @param content 待签名订单信息</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">String</span> sign(<span class=\"keyword\">String</span> content) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> SignUtils.sign(content, RSA_PRIVATE);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * get the sign type we use. 获取签名方式</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">String</span> getSignType() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"sign_type=\\\"RSA\\\"\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>代码中有个注释需要特别注意：<code>特别注意，这里的签名逻辑需要放在服务端，切勿将私钥泄露在代码中！</code></p>\n<p>至此，整个集成就已经结束了，不得不说，支付宝的官方文档比微信好多了，哈哈~</p>\n<h2 id=\"补充\"><a href=\"#补充\" class=\"headerlink\" title=\"补充\"></a>补充</h2><p>正式项目中需要将签名逻辑放在服务端，在我与服务端进行联调时，出现了很多问题，这里说几点：</p>\n<ol>\n<li>服务端若是使用的是java，则使用PKCS8格式的秘钥，否则使用非PKCS8格式的秘钥。</li>\n<li>请求参数可以无序，但是必须保证请求的参数与待签名参数的顺序一致。（非常坑，花了半天时间跟服务端联调才找到这个问题）</li>\n</ol>\n","excerpt":"<p>项目组支付宝商户审核通过，要准备接入支付宝移动支付的能力，本文主要讲述一下android接入支付宝移动支付SDK的步骤。</p>\n<h2 id=\"前期准备\"><a href=\"#前期准备\" class=\"headerlink\" title=\"前期准备\"></a>前期准备</h2><ol>\n<li><a href=\"https://b.alipay.com/newIndex.htm\">支付宝商户网站</a>注册支付宝商户账号。</li>\n<li>签约<code>移动支付</code>产品，等到审核通过。</li>\n<li>秘钥的生成与上传。<br>注册和签约没什么好说的，由公司相关部门或人员进行操作就好了。这里重点讲一下密钥。</li>\n</ol>","more":"<p>秘钥的生成：<br>下载SDK资源压缩包，解压后，里面会有openssl的文件夹，里面有个<code>openssl.exe</code>，双击运行。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay1.png\" alt=\"\"><br>输入如下指令生成私钥:<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">genrsa -out rsa_private_key<span class=\"selector-class\">.pem</span> <span class=\"number\">1024</span></div></pre></td></tr></table></figure></p>\n<p><code>java开发者</code>（否则跳过此步骤）需要转换成PKCS8格式，再输入如下指令进行转换：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pkcs8 -topk8 -inform PEM -<span class=\"keyword\">in</span> rsa_private_key<span class=\"selector-class\">.pem</span> -outform PEM -nocrypt</div></pre></td></tr></table></figure></p>\n<p>可以看到下面的界面：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay2.png\" alt=\"\"><br><code>右键点击openssl窗口上边边缘，选择“编辑→标记”，选中要复制的文字</code>，将PKCS8格式私钥复制下来，保存到一个文本中，后面会用到。<br>继续执行指令：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsa -<span class=\"keyword\">in</span> rsa_private_key<span class=\"selector-class\">.pem</span> -pubout -out rsa_public_key.pem</div></pre></td></tr></table></figure></p>\n<p>会得到公钥文本。</p>\n<p>秘钥的上传：<br>登录支付宝商户账户，进入到<code>我的商家服务</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay3.png\" alt=\"\"><br>点击<code>查询PID、KEY</code>，输入支付密码，进入到下面的页面：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/alipay4.png\" alt=\"\"><br>记录下<code>PID</code>。<br>点击RSA加密后面的<code>添加密码</code>，这里我已经添加过，所以显示的查看秘钥。将生成步骤中生成的公钥文本粘贴进编辑框，点击保存，若显示<code>上传成功</code>则代表成功。</p>\n<h2 id=\"接入SDK\"><a href=\"#接入SDK\" class=\"headerlink\" title=\"接入SDK\"></a>接入SDK</h2><ol>\n<li>将<code>alipaySDK-20160223.jar</code>jar包添加至项目中。</li>\n<li>修改AndroidManifest.xml：<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">&lt;!-- 权限 --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.INTERNET\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.ACCESS_NETWORK_STATE\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.ACCESS_WIFI_STATE\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.READ_PHONE_STATE\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">uses-permission</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.permission.WRITE_EXTERNAL_STORAGE\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">&lt;!-- 当用户手机没有安装支付宝App时，会调用H5的页面进行支付，若不进行声明，则直接返回支付失败 --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span></div><div class=\"line\">            <span class=\"attr\">android:name</span>=<span class=\"string\">\"com.alipay.sdk.app.H5PayActivity\"</span></div><div class=\"line\">            <span class=\"attr\">android:configChanges</span>=<span class=\"string\">\"orientation|keyboardHidden|navigation\"</span></div><div class=\"line\">            <span class=\"attr\">android:exported</span>=<span class=\"string\">\"false\"</span></div><div class=\"line\">            <span class=\"attr\">android:screenOrientation</span>=<span class=\"string\">\"behind\"</span> &gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span></div><div class=\"line\">            <span class=\"attr\">android:name</span>=<span class=\"string\">\"com.alipay.sdk.auth.AuthActivity\"</span></div><div class=\"line\">            <span class=\"attr\">android:configChanges</span>=<span class=\"string\">\"orientation|keyboardHidden|navigation\"</span></div><div class=\"line\">            <span class=\"attr\">android:exported</span>=<span class=\"string\">\"false\"</span></div><div class=\"line\">            <span class=\"attr\">android:screenOrientation</span>=<span class=\"string\">\"behind\"</span> &gt;</span></div><div class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>至此，SDK接入已完成。</p>\n<h2 id=\"调用支付\"><a href=\"#调用支付\" class=\"headerlink\" title=\"调用支付\"></a>调用支付</h2><p>在支付宝Demo中，已经有了很详细的说明了。我们只需要填入3个字段：<code>PARTNER</code>、<code>SELLER</code>、<code>RSA_PRIVATE</code>。<br><code>PARTNER</code>就是上面步骤记录的<code>PID</code>，<code>SELLER</code>即是支付宝账号，<code>RSA_PRIVATE</code>就是记录的PKCS8格式私钥。<br>这里贴一下Demo代码吧：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> class PayDemoActivity extends FragmentActivity &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// 商户PID</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> PARTNER = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    <span class=\"comment\">// 商户收款账号</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> SELLER = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    <span class=\"comment\">// 商户私钥，pkcs8格式</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> RSA_PRIVATE = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    <span class=\"comment\">// 支付宝公钥</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> RSA_PUBLIC = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> SDK_PAY_FLAG = <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">    @SuppressLint(<span class=\"string\">\"HandlerLeak\"</span>)</div><div class=\"line\">    <span class=\"keyword\">private</span> Handler mHandler = <span class=\"keyword\">new</span> Handler() &#123;</div><div class=\"line\">        @SuppressWarnings(<span class=\"string\">\"unused\"</span>)</div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> handleMessage(Message msg) &#123;</div><div class=\"line\">            <span class=\"keyword\">switch</span> (msg.what) &#123;</div><div class=\"line\">                <span class=\"keyword\">case</span> SDK_PAY_FLAG: &#123;</div><div class=\"line\">                    PayResult payResult = <span class=\"keyword\">new</span> PayResult((<span class=\"keyword\">String</span>) msg.obj);</div><div class=\"line\">                    <span class=\"comment\">/**</div><div class=\"line\">                     * 同步返回的结果必须放置到服务端进行验证（验证的规则请看https://doc.open.alipay.com/doc2/</div><div class=\"line\">                     * detail.htm?spm=0.0.0.0.xdvAU6&amp;treeId=59&amp;articleId=103665&amp;</div><div class=\"line\">                     * docType=1) 建议商户依赖异步通知</div><div class=\"line\">                     */</span></div><div class=\"line\">                    <span class=\"keyword\">String</span> resultInfo = payResult.getResult();<span class=\"comment\">// 同步返回需要验证的信息</span></div><div class=\"line\"></div><div class=\"line\">                    <span class=\"keyword\">String</span> resultStatus = payResult.getResultStatus();</div><div class=\"line\">                    <span class=\"comment\">// 判断resultStatus 为“9000”则代表支付成功，具体状态码代表含义可参考接口文档</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (TextUtils.equals(resultStatus, <span class=\"string\">\"9000\"</span>)) &#123;</div><div class=\"line\">                        Toast.makeText(PayDemoActivity.<span class=\"keyword\">this</span>, <span class=\"string\">\"支付成功\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                        <span class=\"comment\">// 判断resultStatus 为非\"9000\"则代表可能支付失败</span></div><div class=\"line\">                        <span class=\"comment\">// \"8000\"代表支付结果因为支付渠道原因或者系统原因还在等待支付结果确认，最终交易是否成功以服务端异步通知为准（小概率状态）</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (TextUtils.equals(resultStatus, <span class=\"string\">\"8000\"</span>)) &#123;</div><div class=\"line\">                            Toast.makeText(PayDemoActivity.<span class=\"keyword\">this</span>, <span class=\"string\">\"支付结果确认中\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\"></div><div class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                            <span class=\"comment\">// 其他值就可以判断为支付失败，包括用户主动取消支付，或者系统返回的错误</span></div><div class=\"line\">                            Toast.makeText(PayDemoActivity.<span class=\"keyword\">this</span>, <span class=\"string\">\"支付失败\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\"></div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">default</span>:</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        ;</div><div class=\"line\">    &#125;;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onCreate(Bundle savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(R.layout.pay_main);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * call alipay sdk pay. 调用SDK支付</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> pay(View v) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (TextUtils.isEmpty(PARTNER) || TextUtils.isEmpty(RSA_PRIVATE) || TextUtils.isEmpty(SELLER)) &#123;</div><div class=\"line\">            <span class=\"keyword\">new</span> AlertDialog.Builder(<span class=\"keyword\">this</span>).setTitle(<span class=\"string\">\"警告\"</span>).setMessage(<span class=\"string\">\"需要配置PARTNER | RSA_PRIVATE| SELLER\"</span>)</div><div class=\"line\">                    .setPositiveButton(<span class=\"string\">\"确定\"</span>, <span class=\"keyword\">new</span> DialogInterface.OnClickListener() &#123;</div><div class=\"line\">                        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> onClick(DialogInterface dialoginterface, <span class=\"built_in\">int</span> i) &#123;</div><div class=\"line\">                            <span class=\"comment\">//</span></div><div class=\"line\">                            finish();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;).show();</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">String</span> orderInfo = getOrderInfo(<span class=\"string\">\"测试的商品\"</span>, <span class=\"string\">\"该测试商品的详细描述\"</span>, <span class=\"string\">\"0.01\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * 特别注意，这里的签名逻辑需要放在服务端，切勿将私钥泄露在代码中！</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">String</span> sign = sign(orderInfo);</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            <span class=\"comment\">/**</div><div class=\"line\">             * 仅需对sign 做URL编码</div><div class=\"line\">             */</span></div><div class=\"line\">            sign = URLEncoder.encode(sign, <span class=\"string\">\"UTF-8\"</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (UnsupportedEncodingException e) &#123;</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * 完整的符合支付宝参数规范的订单信息</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> payInfo = orderInfo + <span class=\"string\">\"&amp;sign=\\\"\"</span> + sign + <span class=\"string\">\"\\\"&amp;\"</span> + getSignType();</div><div class=\"line\"></div><div class=\"line\">        Runnable payRunnable = <span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\"></div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> run() &#123;</div><div class=\"line\">                <span class=\"comment\">// 构造PayTask 对象</span></div><div class=\"line\">                PayTask alipay = <span class=\"keyword\">new</span> PayTask(PayDemoActivity.<span class=\"keyword\">this</span>);</div><div class=\"line\">                <span class=\"comment\">// 调用支付接口，获取支付结果</span></div><div class=\"line\">                <span class=\"keyword\">String</span> result = alipay.pay(payInfo, <span class=\"keyword\">true</span>);</div><div class=\"line\"></div><div class=\"line\">                Message msg = <span class=\"keyword\">new</span> Message();</div><div class=\"line\">                msg.what = SDK_PAY_FLAG;</div><div class=\"line\">                msg.obj = result;</div><div class=\"line\">                mHandler.sendMessage(msg);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 必须异步调用</span></div><div class=\"line\">        Thread payThread = <span class=\"keyword\">new</span> Thread(payRunnable);</div><div class=\"line\">        payThread.start();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * get the sdk version. 获取SDK版本号</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> getSDKVersion() &#123;</div><div class=\"line\">        PayTask payTask = <span class=\"keyword\">new</span> PayTask(<span class=\"keyword\">this</span>);</div><div class=\"line\">        <span class=\"keyword\">String</span> version = payTask.getVersion();</div><div class=\"line\">        Toast.makeText(<span class=\"keyword\">this</span>, version, Toast.LENGTH_SHORT).show();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 原生的H5（手机网页版支付切natvie支付） 【对应页面网页支付按钮】</div><div class=\"line\">     *</div><div class=\"line\">     * @param v</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> h5Pay(View v) &#123;</div><div class=\"line\">        Intent intent = <span class=\"keyword\">new</span> Intent(<span class=\"keyword\">this</span>, H5PayDemoActivity.class);</div><div class=\"line\">        Bundle extras = <span class=\"keyword\">new</span> Bundle();</div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * url是测试的网站，在app内部打开页面是基于webview打开的，demo中的webview是H5PayDemoActivity，</div><div class=\"line\">         * demo中拦截url进行支付的逻辑是在H5PayDemoActivity中shouldOverrideUrlLoading方法实现，</div><div class=\"line\">         * 商户可以根据自己的需求来实现</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">String</span> url = <span class=\"string\">\"http://m.meituan.com\"</span>;</div><div class=\"line\">        <span class=\"comment\">// url可以是一号店或者美团等第三方的购物wap站点，在该网站的支付过程中，支付宝sdk完成拦截支付</span></div><div class=\"line\">        extras.putString(<span class=\"string\">\"url\"</span>, url);</div><div class=\"line\">        intent.putExtras(extras);</div><div class=\"line\">        startActivity(intent);</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * create the order info. 创建订单信息</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">String</span> getOrderInfo(<span class=\"keyword\">String</span> subject, <span class=\"keyword\">String</span> body, <span class=\"keyword\">String</span> price) &#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 签约合作者身份ID</span></div><div class=\"line\">        <span class=\"keyword\">String</span> orderInfo = <span class=\"string\">\"partner=\"</span> + <span class=\"string\">\"\\\"\"</span> + PARTNER + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 签约卖家支付宝账号</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;seller_id=\"</span> + <span class=\"string\">\"\\\"\"</span> + SELLER + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 商户网站唯一订单号</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;out_trade_no=\"</span> + <span class=\"string\">\"\\\"\"</span> + getOutTradeNo() + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 商品名称</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;subject=\"</span> + <span class=\"string\">\"\\\"\"</span> + subject + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 商品详情</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;body=\"</span> + <span class=\"string\">\"\\\"\"</span> + body + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 商品金额</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;total_fee=\"</span> + <span class=\"string\">\"\\\"\"</span> + price + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 服务器异步通知页面路径</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;notify_url=\"</span> + <span class=\"string\">\"\\\"\"</span> + <span class=\"string\">\"http://notify.msp.hk/notify.htm\"</span> + <span class=\"string\">\"\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 服务接口名称， 固定值</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;service=\\\"mobile.securitypay.pay\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 支付类型， 固定值</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;payment_type=\\\"1\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 参数编码， 固定值</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;_input_charset=\\\"utf-8\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 设置未付款交易的超时时间</span></div><div class=\"line\">        <span class=\"comment\">// 默认30分钟，一旦超时，该笔交易就会自动被关闭。</span></div><div class=\"line\">        <span class=\"comment\">// 取值范围：1m～15d。</span></div><div class=\"line\">        <span class=\"comment\">// m-分钟，h-小时，d-天，1c-当天（无论交易何时创建，都在0点关闭）。</span></div><div class=\"line\">        <span class=\"comment\">// 该参数数值不接受小数点，如1.5h，可转换为90m。</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;it_b_pay=\\\"30m\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// extern_token为经过快登授权获取到的alipay_open_id,带上此参数用户将使用授权的账户进行支付</span></div><div class=\"line\">        <span class=\"comment\">// orderInfo += \"&amp;extern_token=\" + \"\\\"\" + extern_token + \"\\\"\";</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 支付宝处理完请求后，当前页面跳转到商户指定页面的路径，可空</span></div><div class=\"line\">        orderInfo += <span class=\"string\">\"&amp;return_url=\\\"m.alipay.com\\\"\"</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 调用银行卡支付，需配置此参数，参与签名， 固定值 （需要签约《无线银行卡快捷支付》才能使用）</span></div><div class=\"line\">        <span class=\"comment\">// orderInfo += \"&amp;paymethod=\\\"expressGateway\\\"\";</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">return</span> orderInfo;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * get the out_trade_no for an order. 生成商户订单号，该值在商户端应保持唯一（可自定义格式规范）</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">String</span> getOutTradeNo() &#123;</div><div class=\"line\">        SimpleDateFormat format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">\"MMddHHmmss\"</span>, Locale.getDefault());</div><div class=\"line\">        Date date = <span class=\"keyword\">new</span> Date();</div><div class=\"line\">        <span class=\"keyword\">String</span> <span class=\"built_in\">key</span> = format.format(date);</div><div class=\"line\"></div><div class=\"line\">        Random r = <span class=\"keyword\">new</span> Random();</div><div class=\"line\">        <span class=\"built_in\">key</span> = <span class=\"built_in\">key</span> + r.nextInt();</div><div class=\"line\">        <span class=\"built_in\">key</span> = <span class=\"built_in\">key</span>.substring(<span class=\"number\">0</span>, <span class=\"number\">15</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">key</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * sign the order info. 对订单信息进行签名</div><div class=\"line\">     *</div><div class=\"line\">     * @param content 待签名订单信息</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">String</span> sign(<span class=\"keyword\">String</span> content) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> SignUtils.sign(content, RSA_PRIVATE);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * get the sign type we use. 获取签名方式</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">String</span> getSignType() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"sign_type=\\\"RSA\\\"\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>代码中有个注释需要特别注意：<code>特别注意，这里的签名逻辑需要放在服务端，切勿将私钥泄露在代码中！</code></p>\n<p>至此，整个集成就已经结束了，不得不说，支付宝的官方文档比微信好多了，哈哈~</p>\n<h2 id=\"补充\"><a href=\"#补充\" class=\"headerlink\" title=\"补充\"></a>补充</h2><p>正式项目中需要将签名逻辑放在服务端，在我与服务端进行联调时，出现了很多问题，这里说几点：</p>\n<ol>\n<li>服务端若是使用的是java，则使用PKCS8格式的秘钥，否则使用非PKCS8格式的秘钥。</li>\n<li>请求参数可以无序，但是必须保证请求的参数与待签名参数的顺序一致。（非常坑，花了半天时间跟服务端联调才找到这个问题）</li>\n</ol>"},{"title":"一个关于Android滑动“因缺斯厅”的想法","date":"2016-04-22T06:07:10.000Z","_content":"\n## 前言\n在项目实际开发过程中，需要实现一个这样的需求：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll1.png)\n在屏幕上进行上滑时，顶端``大图背景``不动，下面的``正在直播``、``数字专辑``等模块进行滑动，并且``大图背景``慢慢模糊。\n\n起初想着是自定义View，重写onTouchEvent来进行滑动事件的处理，如果是手指滑一点，界面跟着滑一点还好。如果还要计算加速度、阻尼效果等这些因素，就会显得非常复杂了。于是跟基友讨论了一下，有个因缺斯厅的idea，先上一下最后实现的一个效果图。\n\n<!-- more -->\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll3.gif)\n擦，好端端的妹子录Gif被录得完全看不清...\n\n## 方案\n通过FrameLayout叠加2个布局，第1个布局就是``大图背景``，第2个布局就是原生ScrollView，ScrollView顶部使用一个透明的View，与第2个布局完全重叠，因为是透明的，所以尽管是叠加上去的，``大图背景``依然能正常显示，底部的``正在直播``、``数字专辑``等模块也能正常显示。FrameLayout的特性是后面的View叠加在前面的View之上。所以ScrollView处于界面的顶端，能够全屏接收触摸事件，然后进行滑动即可。并且ScrollView是android原生用来滑动的View，滑动起来会比较流畅。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll4.jpg)\n特意整了一个示意图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll2.png)\n\n## 实现\n### 布局\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\">\n\n    <FrameLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"480dp\"\n        android:layout_marginBottom=\"8dp\"\n        android:background=\"#ffffff\"\n        android:focusable=\"true\"\n        android:focusableInTouchMode=\"true\">\n\n        <!-- 大图背景布局 -->\n\n        <!-- 大图背景中的关注按钮 -->\n        <TextView\n            android:id=\"@+id/follow_text\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"64dp\"\n            android:layout_gravity=\"right|bottom\"\n            android:gravity=\"center\"\n            android:text=\"关注\"\n            android:textColor=\"@color/white\"\n            android:textSize=\"20sp\" />\n\n    </FrameLayout>\n\n    <com.example.CustomScrollView\n        android:id=\"@+id/scroll_view\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\"\n        android:scrollbars=\"none\">\n\n        <LinearLayout\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\"\n            android:orientation=\"vertical\">\n\n            <!-- 这个FrameLayout与大图背景的属性要完全一致，才能完全覆盖，并且设置alpha为0，使其透明 -->\n            <FrameLayout\n                android:id=\"@+id/shade\"\n                android:layout_width=\"match_parent\"\n                android:layout_height=\"480dp\"\n                android:alpha=\"0\"\n                android:background=\"#000000\">\n\n                <!-- 用于覆盖大图背景中的点击事件，相对位置、大小也必须一致 -->\n                <TextView\n                    android:id=\"@+id/follow\"\n                    android:layout_width=\"80dp\"\n                    android:layout_height=\"64dp\"\n                    android:layout_gravity=\"right|bottom\"\n                    android:gravity=\"center\"\n                    android:text=\"\"\n                    android:textColor=\"@color/white\"\n                    android:textSize=\"20sp\" />\n\n            </FrameLayout>\n\n            <LinearLayout\n                android:layout_width=\"match_parent\"\n                android:layout_height=\"wrap_content\"\n                android:background=\"#000000\"\n                android:orientation=\"vertical\">\n                <!-- 布局代码 -->\n\n            </LinearLayout>\n\n        </LinearLayout>\n\n    </com.example.CustomScrollView>\n\n</FrameLayout>\n```\n这里重点说明一点，因为是覆盖上去的，所以长宽的属性必须要一致，才能完全覆盖。另外，大图背景中的点击事件，可以在ScrollView顶部布局使用相对位置一致的View来进行响应，注意相对位置，长宽也最好一致。\n\n### 监听ScrollView滑动\n上面的布局大致已经能实现滑动的功能了。接下来就是要监听ScrollView滑动，来慢慢模糊大图背景。\nAndroid SDK并没有提供能够直接监听滑动的方法，但是提供了一个``protected void onScrollChanged(int x, int y, int oldx, int oldy)``方法，是protectd的，所以不能被外界调用。因此写一个接口，然后把它暴露出去。\n```\npublic class CustomScrollView extends ScrollView {\n\n    private OnScrollListener listener;\n\n    public CustomScrollView(Context context) {\n        super(context);\n    }\n\n    public CustomScrollView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n    }\n\n    public CustomScrollView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n    }\n\n    public interface OnScrollListener {\n\n        void onScrollChanged(CustomScrollView scrollView, int x, int y, int oldx, int oldy);\n\n    }\n\n    public void setListener(OnScrollListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onScrollChanged(int x, int y, int oldx, int oldy) {\n        super.onScrollChanged(x, y, oldx, oldy);\n        if (listener != null) {\n            listener.onScrollChanged(this, x, y, oldx, oldy);\n        }\n    }\n}\n```\n然后定义自己的Listener即可。\n```\nscrollView.setListener(new CustomScrollView.OnScrollListener() {\n    @Override\n    public void onScrollChanged(CustomScrollView scrollView, int x, int y, int oldx, int oldy) {\n        int scrollY = scrollView.getScrollY();\n        if (scrollY == 0) {\n            followToggle.setClickable(true);\n        } else {\n            followToggle.setClickable(false);\n        }\n        if (scrollY > 0) {\n            if (scrollY > background.getHeight()) {\n                scrollY = background.getHeight();\n            }\n            if (bitmap != null) {\n                int radius = (int) (scrollY * 25f / background.getHeight() * 1.5f);\n                if (radius <= 0) {\n                    radius = 1;\n                } else if (radius > 25) {\n                    radius = 25;\n                }\n                if (lastRadius != radius) {\n                    lastRadius = radius;\n                    Bitmap blurBitmap = AndroidUtils.fastBlur(MainActivity.this, bitmap, radius);\n                    background.setImageBitmap(blurBitmap);\n                }\n                float alpha = (float) scrollY / background.getHeight() / 1.5f;\n                shade.setAlpha(alpha);\n            }\n        }\n    }\n});\n```\n在Listener中通过``getScrollY()``来获得滑动距离，来设置响应的模糊radius，以及alpha值，即可实现想要的效果了。\n\n## 小结\n虽然并不一定是最好的实现方法，但是这个方法我个人觉得是比较取巧，比较``因缺斯厅``的方法。其实之前就想到了这样的方法，只不过当时脑袋短路，一直纠结自定义View，导致想不清楚，后面再仔细想一想就没什么大问题了。\n","source":"_posts/android-scroll.md","raw":"---\ntitle: 一个关于Android滑动“因缺斯厅”的想法\ndate: 2016-04-22 14:07:10\ntags:\n - 日常开发\n---\n\n## 前言\n在项目实际开发过程中，需要实现一个这样的需求：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll1.png)\n在屏幕上进行上滑时，顶端``大图背景``不动，下面的``正在直播``、``数字专辑``等模块进行滑动，并且``大图背景``慢慢模糊。\n\n起初想着是自定义View，重写onTouchEvent来进行滑动事件的处理，如果是手指滑一点，界面跟着滑一点还好。如果还要计算加速度、阻尼效果等这些因素，就会显得非常复杂了。于是跟基友讨论了一下，有个因缺斯厅的idea，先上一下最后实现的一个效果图。\n\n<!-- more -->\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll3.gif)\n擦，好端端的妹子录Gif被录得完全看不清...\n\n## 方案\n通过FrameLayout叠加2个布局，第1个布局就是``大图背景``，第2个布局就是原生ScrollView，ScrollView顶部使用一个透明的View，与第2个布局完全重叠，因为是透明的，所以尽管是叠加上去的，``大图背景``依然能正常显示，底部的``正在直播``、``数字专辑``等模块也能正常显示。FrameLayout的特性是后面的View叠加在前面的View之上。所以ScrollView处于界面的顶端，能够全屏接收触摸事件，然后进行滑动即可。并且ScrollView是android原生用来滑动的View，滑动起来会比较流畅。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll4.jpg)\n特意整了一个示意图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll2.png)\n\n## 实现\n### 布局\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\">\n\n    <FrameLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"480dp\"\n        android:layout_marginBottom=\"8dp\"\n        android:background=\"#ffffff\"\n        android:focusable=\"true\"\n        android:focusableInTouchMode=\"true\">\n\n        <!-- 大图背景布局 -->\n\n        <!-- 大图背景中的关注按钮 -->\n        <TextView\n            android:id=\"@+id/follow_text\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"64dp\"\n            android:layout_gravity=\"right|bottom\"\n            android:gravity=\"center\"\n            android:text=\"关注\"\n            android:textColor=\"@color/white\"\n            android:textSize=\"20sp\" />\n\n    </FrameLayout>\n\n    <com.example.CustomScrollView\n        android:id=\"@+id/scroll_view\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\"\n        android:scrollbars=\"none\">\n\n        <LinearLayout\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\"\n            android:orientation=\"vertical\">\n\n            <!-- 这个FrameLayout与大图背景的属性要完全一致，才能完全覆盖，并且设置alpha为0，使其透明 -->\n            <FrameLayout\n                android:id=\"@+id/shade\"\n                android:layout_width=\"match_parent\"\n                android:layout_height=\"480dp\"\n                android:alpha=\"0\"\n                android:background=\"#000000\">\n\n                <!-- 用于覆盖大图背景中的点击事件，相对位置、大小也必须一致 -->\n                <TextView\n                    android:id=\"@+id/follow\"\n                    android:layout_width=\"80dp\"\n                    android:layout_height=\"64dp\"\n                    android:layout_gravity=\"right|bottom\"\n                    android:gravity=\"center\"\n                    android:text=\"\"\n                    android:textColor=\"@color/white\"\n                    android:textSize=\"20sp\" />\n\n            </FrameLayout>\n\n            <LinearLayout\n                android:layout_width=\"match_parent\"\n                android:layout_height=\"wrap_content\"\n                android:background=\"#000000\"\n                android:orientation=\"vertical\">\n                <!-- 布局代码 -->\n\n            </LinearLayout>\n\n        </LinearLayout>\n\n    </com.example.CustomScrollView>\n\n</FrameLayout>\n```\n这里重点说明一点，因为是覆盖上去的，所以长宽的属性必须要一致，才能完全覆盖。另外，大图背景中的点击事件，可以在ScrollView顶部布局使用相对位置一致的View来进行响应，注意相对位置，长宽也最好一致。\n\n### 监听ScrollView滑动\n上面的布局大致已经能实现滑动的功能了。接下来就是要监听ScrollView滑动，来慢慢模糊大图背景。\nAndroid SDK并没有提供能够直接监听滑动的方法，但是提供了一个``protected void onScrollChanged(int x, int y, int oldx, int oldy)``方法，是protectd的，所以不能被外界调用。因此写一个接口，然后把它暴露出去。\n```\npublic class CustomScrollView extends ScrollView {\n\n    private OnScrollListener listener;\n\n    public CustomScrollView(Context context) {\n        super(context);\n    }\n\n    public CustomScrollView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n    }\n\n    public CustomScrollView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n    }\n\n    public interface OnScrollListener {\n\n        void onScrollChanged(CustomScrollView scrollView, int x, int y, int oldx, int oldy);\n\n    }\n\n    public void setListener(OnScrollListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onScrollChanged(int x, int y, int oldx, int oldy) {\n        super.onScrollChanged(x, y, oldx, oldy);\n        if (listener != null) {\n            listener.onScrollChanged(this, x, y, oldx, oldy);\n        }\n    }\n}\n```\n然后定义自己的Listener即可。\n```\nscrollView.setListener(new CustomScrollView.OnScrollListener() {\n    @Override\n    public void onScrollChanged(CustomScrollView scrollView, int x, int y, int oldx, int oldy) {\n        int scrollY = scrollView.getScrollY();\n        if (scrollY == 0) {\n            followToggle.setClickable(true);\n        } else {\n            followToggle.setClickable(false);\n        }\n        if (scrollY > 0) {\n            if (scrollY > background.getHeight()) {\n                scrollY = background.getHeight();\n            }\n            if (bitmap != null) {\n                int radius = (int) (scrollY * 25f / background.getHeight() * 1.5f);\n                if (radius <= 0) {\n                    radius = 1;\n                } else if (radius > 25) {\n                    radius = 25;\n                }\n                if (lastRadius != radius) {\n                    lastRadius = radius;\n                    Bitmap blurBitmap = AndroidUtils.fastBlur(MainActivity.this, bitmap, radius);\n                    background.setImageBitmap(blurBitmap);\n                }\n                float alpha = (float) scrollY / background.getHeight() / 1.5f;\n                shade.setAlpha(alpha);\n            }\n        }\n    }\n});\n```\n在Listener中通过``getScrollY()``来获得滑动距离，来设置响应的模糊radius，以及alpha值，即可实现想要的效果了。\n\n## 小结\n虽然并不一定是最好的实现方法，但是这个方法我个人觉得是比较取巧，比较``因缺斯厅``的方法。其实之前就想到了这样的方法，只不过当时脑袋短路，一直纠结自定义View，导致想不清楚，后面再仔细想一想就没什么大问题了。\n","slug":"android-scroll","published":1,"updated":"2016-11-21T09:56:54.808Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7585000b1cb8yxnzrrd3","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在项目实际开发过程中，需要实现一个这样的需求：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll1.png\" alt=\"\"><br>在屏幕上进行上滑时，顶端<code>大图背景</code>不动，下面的<code>正在直播</code>、<code>数字专辑</code>等模块进行滑动，并且<code>大图背景</code>慢慢模糊。</p>\n<p>起初想着是自定义View，重写onTouchEvent来进行滑动事件的处理，如果是手指滑一点，界面跟着滑一点还好。如果还要计算加速度、阻尼效果等这些因素，就会显得非常复杂了。于是跟基友讨论了一下，有个因缺斯厅的idea，先上一下最后实现的一个效果图。</p>\n<a id=\"more\"></a>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll3.gif\" alt=\"\"><br>擦，好端端的妹子录Gif被录得完全看不清…</p>\n<h2 id=\"方案\"><a href=\"#方案\" class=\"headerlink\" title=\"方案\"></a>方案</h2><p>通过FrameLayout叠加2个布局，第1个布局就是<code>大图背景</code>，第2个布局就是原生ScrollView，ScrollView顶部使用一个透明的View，与第2个布局完全重叠，因为是透明的，所以尽管是叠加上去的，<code>大图背景</code>依然能正常显示，底部的<code>正在直播</code>、<code>数字专辑</code>等模块也能正常显示。FrameLayout的特性是后面的View叠加在前面的View之上。所以ScrollView处于界面的顶端，能够全屏接收触摸事件，然后进行滑动即可。并且ScrollView是android原生用来滑动的View，滑动起来会比较流畅。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll4.jpg\" alt=\"\"><br>特意整了一个示意图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll2.png\" alt=\"\"></p>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><h3 id=\"布局\"><a href=\"#布局\" class=\"headerlink\" title=\"布局\"></a>布局</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"480dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginBottom</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:background</span>=<span class=\"string\">\"#ffffff\"</span></div><div class=\"line\">        <span class=\"attr\">android:focusable</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">        <span class=\"attr\">android:focusableInTouchMode</span>=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">&lt;!-- 大图背景布局 --&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">&lt;!-- 大图背景中的关注按钮 --&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/follow_text\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"64dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"right|bottom\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"关注\"</span></div><div class=\"line\">            <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">            <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"20sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">com.example.CustomScrollView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/scroll_view\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:scrollbars</span>=<span class=\"string\">\"none\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">&lt;!-- 这个FrameLayout与大图背景的属性要完全一致，才能完全覆盖，并且设置alpha为0，使其透明 --&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/shade\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"480dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:alpha</span>=<span class=\"string\">\"0\"</span></div><div class=\"line\">                <span class=\"attr\">android:background</span>=<span class=\"string\">\"#000000\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">&lt;!-- 用于覆盖大图背景中的点击事件，相对位置、大小也必须一致 --&gt;</span></div><div class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">                    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/follow\"</span></div><div class=\"line\">                    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">                    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"64dp\"</span></div><div class=\"line\">                    <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"right|bottom\"</span></div><div class=\"line\">                    <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">                    <span class=\"attr\">android:text</span>=<span class=\"string\">\"\"</span></div><div class=\"line\">                    <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">                    <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"20sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:background</span>=<span class=\"string\">\"#000000\"</span></div><div class=\"line\">                <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\">                <span class=\"comment\">&lt;!-- 布局代码 --&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">com.example.CustomScrollView</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>这里重点说明一点，因为是覆盖上去的，所以长宽的属性必须要一致，才能完全覆盖。另外，大图背景中的点击事件，可以在ScrollView顶部布局使用相对位置一致的View来进行响应，注意相对位置，长宽也最好一致。</p>\n<h3 id=\"监听ScrollView滑动\"><a href=\"#监听ScrollView滑动\" class=\"headerlink\" title=\"监听ScrollView滑动\"></a>监听ScrollView滑动</h3><p>上面的布局大致已经能实现滑动的功能了。接下来就是要监听ScrollView滑动，来慢慢模糊大图背景。<br>Android SDK并没有提供能够直接监听滑动的方法，但是提供了一个<code>protected void onScrollChanged(int x, int y, int oldx, int oldy)</code>方法，是protectd的，所以不能被外界调用。因此写一个接口，然后把它暴露出去。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomScrollView</span> <span class=\"keyword\">extends</span> <span class=\"title\">ScrollView</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> OnScrollListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomScrollView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomScrollView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomScrollView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnScrollListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScrollChanged</span><span class=\"params\">(CustomScrollView scrollView, <span class=\"keyword\">int</span> x, <span class=\"keyword\">int</span> y, <span class=\"keyword\">int</span> oldx, <span class=\"keyword\">int</span> oldy)</span></span>;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnScrollListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onScrollChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> x, <span class=\"keyword\">int</span> y, <span class=\"keyword\">int</span> oldx, <span class=\"keyword\">int</span> oldy)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onScrollChanged(x, y, oldx, oldy);</div><div class=\"line\">        <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            listener.onScrollChanged(<span class=\"keyword\">this</span>, x, y, oldx, oldy);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后定义自己的Listener即可。<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">scrollView.setListener(<span class=\"keyword\">new</span> CustomScrollView.OnScrollListener() &#123;</div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> onScrollChanged(CustomScrollView scrollView, <span class=\"built_in\">int</span> x, <span class=\"built_in\">int</span> y, <span class=\"built_in\">int</span> oldx, <span class=\"built_in\">int</span> oldy) &#123;</div><div class=\"line\">        <span class=\"built_in\">int</span> scrollY = scrollView.getScrollY();</div><div class=\"line\">        <span class=\"keyword\">if</span> (scrollY == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            followToggle.setClickable(<span class=\"keyword\">true</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            followToggle.setClickable(<span class=\"keyword\">false</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scrollY &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (scrollY &gt; <span class=\"built_in\">background</span>.getHeight()) &#123;</div><div class=\"line\">                scrollY = <span class=\"built_in\">background</span>.getHeight();</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span> (bitmap != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                <span class=\"built_in\">int</span> radius = (<span class=\"built_in\">int</span>) (scrollY * <span class=\"number\">25</span>f / <span class=\"built_in\">background</span>.getHeight() * <span class=\"number\">1.5</span>f);</div><div class=\"line\">                <span class=\"keyword\">if</span> (radius &lt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    radius = <span class=\"number\">1</span>;</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (radius &gt; <span class=\"number\">25</span>) &#123;</div><div class=\"line\">                    radius = <span class=\"number\">25</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">if</span> (lastRadius != radius) &#123;</div><div class=\"line\">                    lastRadius = radius;</div><div class=\"line\">                    Bitmap blurBitmap = AndroidUtils.fastBlur(MainActivity.<span class=\"keyword\">this</span>, bitmap, radius);</div><div class=\"line\">                    <span class=\"built_in\">background</span>.setImageBitmap(blurBitmap);</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"built_in\">float</span> <span class=\"built_in\">alpha</span> = (<span class=\"built_in\">float</span>) scrollY / <span class=\"built_in\">background</span>.getHeight() / <span class=\"number\">1.5</span>f;</div><div class=\"line\">                shade.setAlpha(<span class=\"built_in\">alpha</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>在Listener中通过<code>getScrollY()</code>来获得滑动距离，来设置响应的模糊radius，以及alpha值，即可实现想要的效果了。</p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><p>虽然并不一定是最好的实现方法，但是这个方法我个人觉得是比较取巧，比较<code>因缺斯厅</code>的方法。其实之前就想到了这样的方法，只不过当时脑袋短路，一直纠结自定义View，导致想不清楚，后面再仔细想一想就没什么大问题了。</p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在项目实际开发过程中，需要实现一个这样的需求：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll1.png\" alt=\"\"><br>在屏幕上进行上滑时，顶端<code>大图背景</code>不动，下面的<code>正在直播</code>、<code>数字专辑</code>等模块进行滑动，并且<code>大图背景</code>慢慢模糊。</p>\n<p>起初想着是自定义View，重写onTouchEvent来进行滑动事件的处理，如果是手指滑一点，界面跟着滑一点还好。如果还要计算加速度、阻尼效果等这些因素，就会显得非常复杂了。于是跟基友讨论了一下，有个因缺斯厅的idea，先上一下最后实现的一个效果图。</p>","more":"<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll3.gif\" alt=\"\"><br>擦，好端端的妹子录Gif被录得完全看不清…</p>\n<h2 id=\"方案\"><a href=\"#方案\" class=\"headerlink\" title=\"方案\"></a>方案</h2><p>通过FrameLayout叠加2个布局，第1个布局就是<code>大图背景</code>，第2个布局就是原生ScrollView，ScrollView顶部使用一个透明的View，与第2个布局完全重叠，因为是透明的，所以尽管是叠加上去的，<code>大图背景</code>依然能正常显示，底部的<code>正在直播</code>、<code>数字专辑</code>等模块也能正常显示。FrameLayout的特性是后面的View叠加在前面的View之上。所以ScrollView处于界面的顶端，能够全屏接收触摸事件，然后进行滑动即可。并且ScrollView是android原生用来滑动的View，滑动起来会比较流畅。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll4.jpg\" alt=\"\"><br>特意整了一个示意图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/android-srcoll2.png\" alt=\"\"></p>\n<h2 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h2><h3 id=\"布局\"><a href=\"#布局\" class=\"headerlink\" title=\"布局\"></a>布局</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"480dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginBottom</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:background</span>=<span class=\"string\">\"#ffffff\"</span></div><div class=\"line\">        <span class=\"attr\">android:focusable</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">        <span class=\"attr\">android:focusableInTouchMode</span>=<span class=\"string\">\"true\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">&lt;!-- 大图背景布局 --&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">&lt;!-- 大图背景中的关注按钮 --&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/follow_text\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"64dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"right|bottom\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"关注\"</span></div><div class=\"line\">            <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">            <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"20sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">com.example.CustomScrollView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/scroll_view\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:scrollbars</span>=<span class=\"string\">\"none\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">&lt;!-- 这个FrameLayout与大图背景的属性要完全一致，才能完全覆盖，并且设置alpha为0，使其透明 --&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/shade\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"480dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:alpha</span>=<span class=\"string\">\"0\"</span></div><div class=\"line\">                <span class=\"attr\">android:background</span>=<span class=\"string\">\"#000000\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">&lt;!-- 用于覆盖大图背景中的点击事件，相对位置、大小也必须一致 --&gt;</span></div><div class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">                    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/follow\"</span></div><div class=\"line\">                    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">                    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"64dp\"</span></div><div class=\"line\">                    <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"right|bottom\"</span></div><div class=\"line\">                    <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">                    <span class=\"attr\">android:text</span>=<span class=\"string\">\"\"</span></div><div class=\"line\">                    <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">                    <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"20sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:background</span>=<span class=\"string\">\"#000000\"</span></div><div class=\"line\">                <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\">                <span class=\"comment\">&lt;!-- 布局代码 --&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">com.example.CustomScrollView</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>这里重点说明一点，因为是覆盖上去的，所以长宽的属性必须要一致，才能完全覆盖。另外，大图背景中的点击事件，可以在ScrollView顶部布局使用相对位置一致的View来进行响应，注意相对位置，长宽也最好一致。</p>\n<h3 id=\"监听ScrollView滑动\"><a href=\"#监听ScrollView滑动\" class=\"headerlink\" title=\"监听ScrollView滑动\"></a>监听ScrollView滑动</h3><p>上面的布局大致已经能实现滑动的功能了。接下来就是要监听ScrollView滑动，来慢慢模糊大图背景。<br>Android SDK并没有提供能够直接监听滑动的方法，但是提供了一个<code>protected void onScrollChanged(int x, int y, int oldx, int oldy)</code>方法，是protectd的，所以不能被外界调用。因此写一个接口，然后把它暴露出去。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomScrollView</span> <span class=\"keyword\">extends</span> <span class=\"title\">ScrollView</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> OnScrollListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomScrollView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomScrollView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomScrollView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnScrollListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScrollChanged</span><span class=\"params\">(CustomScrollView scrollView, <span class=\"keyword\">int</span> x, <span class=\"keyword\">int</span> y, <span class=\"keyword\">int</span> oldx, <span class=\"keyword\">int</span> oldy)</span></span>;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnScrollListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onScrollChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> x, <span class=\"keyword\">int</span> y, <span class=\"keyword\">int</span> oldx, <span class=\"keyword\">int</span> oldy)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onScrollChanged(x, y, oldx, oldy);</div><div class=\"line\">        <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            listener.onScrollChanged(<span class=\"keyword\">this</span>, x, y, oldx, oldy);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后定义自己的Listener即可。<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">scrollView.setListener(<span class=\"keyword\">new</span> CustomScrollView.OnScrollListener() &#123;</div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> onScrollChanged(CustomScrollView scrollView, <span class=\"built_in\">int</span> x, <span class=\"built_in\">int</span> y, <span class=\"built_in\">int</span> oldx, <span class=\"built_in\">int</span> oldy) &#123;</div><div class=\"line\">        <span class=\"built_in\">int</span> scrollY = scrollView.getScrollY();</div><div class=\"line\">        <span class=\"keyword\">if</span> (scrollY == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            followToggle.setClickable(<span class=\"keyword\">true</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            followToggle.setClickable(<span class=\"keyword\">false</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scrollY &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (scrollY &gt; <span class=\"built_in\">background</span>.getHeight()) &#123;</div><div class=\"line\">                scrollY = <span class=\"built_in\">background</span>.getHeight();</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span> (bitmap != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                <span class=\"built_in\">int</span> radius = (<span class=\"built_in\">int</span>) (scrollY * <span class=\"number\">25</span>f / <span class=\"built_in\">background</span>.getHeight() * <span class=\"number\">1.5</span>f);</div><div class=\"line\">                <span class=\"keyword\">if</span> (radius &lt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    radius = <span class=\"number\">1</span>;</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (radius &gt; <span class=\"number\">25</span>) &#123;</div><div class=\"line\">                    radius = <span class=\"number\">25</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">if</span> (lastRadius != radius) &#123;</div><div class=\"line\">                    lastRadius = radius;</div><div class=\"line\">                    Bitmap blurBitmap = AndroidUtils.fastBlur(MainActivity.<span class=\"keyword\">this</span>, bitmap, radius);</div><div class=\"line\">                    <span class=\"built_in\">background</span>.setImageBitmap(blurBitmap);</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"built_in\">float</span> <span class=\"built_in\">alpha</span> = (<span class=\"built_in\">float</span>) scrollY / <span class=\"built_in\">background</span>.getHeight() / <span class=\"number\">1.5</span>f;</div><div class=\"line\">                shade.setAlpha(<span class=\"built_in\">alpha</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>在Listener中通过<code>getScrollY()</code>来获得滑动距离，来设置响应的模糊radius，以及alpha值，即可实现想要的效果了。</p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><p>虽然并不一定是最好的实现方法，但是这个方法我个人觉得是比较取巧，比较<code>因缺斯厅</code>的方法。其实之前就想到了这样的方法，只不过当时脑袋短路，一直纠结自定义View，导致想不清楚，后面再仔细想一想就没什么大问题了。</p>"},{"title":"博客搬家","date":"2016-03-25T01:39:01.000Z","_content":"\n在2015年10月24日，正好是``程序猿节``，我开始写博客。\n\n在半年前找工作的时候，看到许多许多公司的招聘上，都会有个加分项：``拥有维护半年以上的个人博客``。\n\n其实也是一直想写博客来着，因为我学习安卓都是从许多大牛的博客中学习的，我也想朝着他们的方向努力。分享自己的知识，帮助他人。\n\n刚开始写博客的时候，还不太熟练，借用的[CSDN](http://blog.csdn.net/lastwarmth)平台，比较方便快捷的写起了博客。\n\n最近使用Hexo+Github搭建完自己的博客之后，便打算把所有的博客迁移过来，并做了些许调整。\n\n有几篇转载的，写得非常好的文章因为没有md格式的文件，暂时迁移不过来，后面再说了。\n\n<!--more-->\n\n文章列表：\n\n1. [Android Studio使用Gradle进行多渠道打包](http://lijia92.github.io/2016/03/09/gradle-pack/)\n2. [Android实现渐变title栏](http://lijia92.github.io/2016/03/02/change-title/)\n3. [Android实现简易轻量下载器：单线程任务队列](http://lijia92.github.io/2016/02/23/single-thread-queue/)\n4. [Android实现照片墙背景](http://lijia92.github.io/2016/02/17/photo-wall/)\n5. [使用Android新特性：Material Design](http://lijia92.github.io/2016/02/17/material-design/)\n6. [React Native For Android初探-问题小结](http://lijia92.github.io/2016/01/19/react-native-tips/)\n7. [React Native For Android初探](http://lijia92.github.io/2016/01/15/react-native/)\n8. [Android Hybrid开发实战之图片的交互](http://lijia92.github.io/2016/01/14/hybrid-practice/)\n9. [Android Notification使用小记](http://lijia92.github.io/2016/01/11/notification/)\n10. [Android Hybrid开发入门：原生Android与JS的交互](http://lijia92.github.io/2015/12/25/hybrid-introduction/)\n11. [Android仿QQ空间浏览图片](http://lijia92.github.io/2015/12/08/picture-view/)\n12. [Android Studio中使用.9（Nine Patch）图](http://lijia92.github.io/2015/11/23/nine-patch/)\n13. [Android仿QQ实现ListView滑动删除](http://lijia92.github.io/2015/11/14/swipe-listview/)\n14. [Android事件分发机制学习小记](http://lijia92.github.io/2015/11/14/touch-event/)\n15. [Android Studio使用Genymotion小记](http://lijia92.github.io/2015/11/05/genymotion/)\n16. [Java反射实现接口](http://lijia92.github.io/2015/10/28/reflect-interface/)\n17. [百度定位SDK无法定位](http://lijia92.github.io/2015/10/24/baidu-loc/)\n18. [Android DDMS无法输出logcat](http://lijia92.github.io/2015/10/24/ddms-logcat/)\n\n现在，我作为一个入门不久的安卓开发工程师，大牛自然是称不上的。但是在学习安卓的路上，各种各样的钉子是肯定会碰到的，我会把这些钉子分享出来，方便他人能够少走一些弯路，也记录我自己在学习之路上的点点滴滴，以及生活中的所想所感。\n","source":"_posts/blog-move.md","raw":"---\ntitle: 博客搬家\ndate: 2016-03-25 09:39:01\ntags:\n - blog\n---\n\n在2015年10月24日，正好是``程序猿节``，我开始写博客。\n\n在半年前找工作的时候，看到许多许多公司的招聘上，都会有个加分项：``拥有维护半年以上的个人博客``。\n\n其实也是一直想写博客来着，因为我学习安卓都是从许多大牛的博客中学习的，我也想朝着他们的方向努力。分享自己的知识，帮助他人。\n\n刚开始写博客的时候，还不太熟练，借用的[CSDN](http://blog.csdn.net/lastwarmth)平台，比较方便快捷的写起了博客。\n\n最近使用Hexo+Github搭建完自己的博客之后，便打算把所有的博客迁移过来，并做了些许调整。\n\n有几篇转载的，写得非常好的文章因为没有md格式的文件，暂时迁移不过来，后面再说了。\n\n<!--more-->\n\n文章列表：\n\n1. [Android Studio使用Gradle进行多渠道打包](http://lijia92.github.io/2016/03/09/gradle-pack/)\n2. [Android实现渐变title栏](http://lijia92.github.io/2016/03/02/change-title/)\n3. [Android实现简易轻量下载器：单线程任务队列](http://lijia92.github.io/2016/02/23/single-thread-queue/)\n4. [Android实现照片墙背景](http://lijia92.github.io/2016/02/17/photo-wall/)\n5. [使用Android新特性：Material Design](http://lijia92.github.io/2016/02/17/material-design/)\n6. [React Native For Android初探-问题小结](http://lijia92.github.io/2016/01/19/react-native-tips/)\n7. [React Native For Android初探](http://lijia92.github.io/2016/01/15/react-native/)\n8. [Android Hybrid开发实战之图片的交互](http://lijia92.github.io/2016/01/14/hybrid-practice/)\n9. [Android Notification使用小记](http://lijia92.github.io/2016/01/11/notification/)\n10. [Android Hybrid开发入门：原生Android与JS的交互](http://lijia92.github.io/2015/12/25/hybrid-introduction/)\n11. [Android仿QQ空间浏览图片](http://lijia92.github.io/2015/12/08/picture-view/)\n12. [Android Studio中使用.9（Nine Patch）图](http://lijia92.github.io/2015/11/23/nine-patch/)\n13. [Android仿QQ实现ListView滑动删除](http://lijia92.github.io/2015/11/14/swipe-listview/)\n14. [Android事件分发机制学习小记](http://lijia92.github.io/2015/11/14/touch-event/)\n15. [Android Studio使用Genymotion小记](http://lijia92.github.io/2015/11/05/genymotion/)\n16. [Java反射实现接口](http://lijia92.github.io/2015/10/28/reflect-interface/)\n17. [百度定位SDK无法定位](http://lijia92.github.io/2015/10/24/baidu-loc/)\n18. [Android DDMS无法输出logcat](http://lijia92.github.io/2015/10/24/ddms-logcat/)\n\n现在，我作为一个入门不久的安卓开发工程师，大牛自然是称不上的。但是在学习安卓的路上，各种各样的钉子是肯定会碰到的，我会把这些钉子分享出来，方便他人能够少走一些弯路，也记录我自己在学习之路上的点点滴滴，以及生活中的所想所感。\n","slug":"blog-move","published":1,"updated":"2016-11-21T09:57:01.929Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7586000c1cb8931q2vot","content":"<p>在2015年10月24日，正好是<code>程序猿节</code>，我开始写博客。</p>\n<p>在半年前找工作的时候，看到许多许多公司的招聘上，都会有个加分项：<code>拥有维护半年以上的个人博客</code>。</p>\n<p>其实也是一直想写博客来着，因为我学习安卓都是从许多大牛的博客中学习的，我也想朝着他们的方向努力。分享自己的知识，帮助他人。</p>\n<p>刚开始写博客的时候，还不太熟练，借用的<a href=\"http://blog.csdn.net/lastwarmth\" target=\"_blank\" rel=\"external\">CSDN</a>平台，比较方便快捷的写起了博客。</p>\n<p>最近使用Hexo+Github搭建完自己的博客之后，便打算把所有的博客迁移过来，并做了些许调整。</p>\n<p>有几篇转载的，写得非常好的文章因为没有md格式的文件，暂时迁移不过来，后面再说了。</p>\n<a id=\"more\"></a>\n<p>文章列表：</p>\n<ol>\n<li><a href=\"http://lijia92.github.io/2016/03/09/gradle-pack/\">Android Studio使用Gradle进行多渠道打包</a></li>\n<li><a href=\"http://lijia92.github.io/2016/03/02/change-title/\">Android实现渐变title栏</a></li>\n<li><a href=\"http://lijia92.github.io/2016/02/23/single-thread-queue/\">Android实现简易轻量下载器：单线程任务队列</a></li>\n<li><a href=\"http://lijia92.github.io/2016/02/17/photo-wall/\">Android实现照片墙背景</a></li>\n<li><a href=\"http://lijia92.github.io/2016/02/17/material-design/\">使用Android新特性：Material Design</a></li>\n<li><a href=\"http://lijia92.github.io/2016/01/19/react-native-tips/\">React Native For Android初探-问题小结</a></li>\n<li><a href=\"http://lijia92.github.io/2016/01/15/react-native/\">React Native For Android初探</a></li>\n<li><a href=\"http://lijia92.github.io/2016/01/14/hybrid-practice/\">Android Hybrid开发实战之图片的交互</a></li>\n<li><a href=\"http://lijia92.github.io/2016/01/11/notification/\">Android Notification使用小记</a></li>\n<li><a href=\"http://lijia92.github.io/2015/12/25/hybrid-introduction/\">Android Hybrid开发入门：原生Android与JS的交互</a></li>\n<li><a href=\"http://lijia92.github.io/2015/12/08/picture-view/\">Android仿QQ空间浏览图片</a></li>\n<li><a href=\"http://lijia92.github.io/2015/11/23/nine-patch/\">Android Studio中使用.9（Nine Patch）图</a></li>\n<li><a href=\"http://lijia92.github.io/2015/11/14/swipe-listview/\">Android仿QQ实现ListView滑动删除</a></li>\n<li><a href=\"http://lijia92.github.io/2015/11/14/touch-event/\">Android事件分发机制学习小记</a></li>\n<li><a href=\"http://lijia92.github.io/2015/11/05/genymotion/\">Android Studio使用Genymotion小记</a></li>\n<li><a href=\"http://lijia92.github.io/2015/10/28/reflect-interface/\">Java反射实现接口</a></li>\n<li><a href=\"http://lijia92.github.io/2015/10/24/baidu-loc/\">百度定位SDK无法定位</a></li>\n<li><a href=\"http://lijia92.github.io/2015/10/24/ddms-logcat/\">Android DDMS无法输出logcat</a></li>\n</ol>\n<p>现在，我作为一个入门不久的安卓开发工程师，大牛自然是称不上的。但是在学习安卓的路上，各种各样的钉子是肯定会碰到的，我会把这些钉子分享出来，方便他人能够少走一些弯路，也记录我自己在学习之路上的点点滴滴，以及生活中的所想所感。</p>\n","excerpt":"<p>在2015年10月24日，正好是<code>程序猿节</code>，我开始写博客。</p>\n<p>在半年前找工作的时候，看到许多许多公司的招聘上，都会有个加分项：<code>拥有维护半年以上的个人博客</code>。</p>\n<p>其实也是一直想写博客来着，因为我学习安卓都是从许多大牛的博客中学习的，我也想朝着他们的方向努力。分享自己的知识，帮助他人。</p>\n<p>刚开始写博客的时候，还不太熟练，借用的<a href=\"http://blog.csdn.net/lastwarmth\">CSDN</a>平台，比较方便快捷的写起了博客。</p>\n<p>最近使用Hexo+Github搭建完自己的博客之后，便打算把所有的博客迁移过来，并做了些许调整。</p>\n<p>有几篇转载的，写得非常好的文章因为没有md格式的文件，暂时迁移不过来，后面再说了。</p>","more":"<p>文章列表：</p>\n<ol>\n<li><a href=\"http://lijia92.github.io/2016/03/09/gradle-pack/\">Android Studio使用Gradle进行多渠道打包</a></li>\n<li><a href=\"http://lijia92.github.io/2016/03/02/change-title/\">Android实现渐变title栏</a></li>\n<li><a href=\"http://lijia92.github.io/2016/02/23/single-thread-queue/\">Android实现简易轻量下载器：单线程任务队列</a></li>\n<li><a href=\"http://lijia92.github.io/2016/02/17/photo-wall/\">Android实现照片墙背景</a></li>\n<li><a href=\"http://lijia92.github.io/2016/02/17/material-design/\">使用Android新特性：Material Design</a></li>\n<li><a href=\"http://lijia92.github.io/2016/01/19/react-native-tips/\">React Native For Android初探-问题小结</a></li>\n<li><a href=\"http://lijia92.github.io/2016/01/15/react-native/\">React Native For Android初探</a></li>\n<li><a href=\"http://lijia92.github.io/2016/01/14/hybrid-practice/\">Android Hybrid开发实战之图片的交互</a></li>\n<li><a href=\"http://lijia92.github.io/2016/01/11/notification/\">Android Notification使用小记</a></li>\n<li><a href=\"http://lijia92.github.io/2015/12/25/hybrid-introduction/\">Android Hybrid开发入门：原生Android与JS的交互</a></li>\n<li><a href=\"http://lijia92.github.io/2015/12/08/picture-view/\">Android仿QQ空间浏览图片</a></li>\n<li><a href=\"http://lijia92.github.io/2015/11/23/nine-patch/\">Android Studio中使用.9（Nine Patch）图</a></li>\n<li><a href=\"http://lijia92.github.io/2015/11/14/swipe-listview/\">Android仿QQ实现ListView滑动删除</a></li>\n<li><a href=\"http://lijia92.github.io/2015/11/14/touch-event/\">Android事件分发机制学习小记</a></li>\n<li><a href=\"http://lijia92.github.io/2015/11/05/genymotion/\">Android Studio使用Genymotion小记</a></li>\n<li><a href=\"http://lijia92.github.io/2015/10/28/reflect-interface/\">Java反射实现接口</a></li>\n<li><a href=\"http://lijia92.github.io/2015/10/24/baidu-loc/\">百度定位SDK无法定位</a></li>\n<li><a href=\"http://lijia92.github.io/2015/10/24/ddms-logcat/\">Android DDMS无法输出logcat</a></li>\n</ol>\n<p>现在，我作为一个入门不久的安卓开发工程师，大牛自然是称不上的。但是在学习安卓的路上，各种各样的钉子是肯定会碰到的，我会把这些钉子分享出来，方便他人能够少走一些弯路，也记录我自己在学习之路上的点点滴滴，以及生活中的所想所感。</p>"},{"title":"百度定位SDK无法定位","date":"2015-10-24T09:14:50.000Z","_content":"\n最近的项目中，有使用到百度定位SDK，在自己的debug环境安装apk，手机可以进行定位。但是发布release版本后安装，手机却无法定位。后面找到问题是百度配置的秘钥不对。\n\n百度地图SDK在申请秘钥时，需要SHA1值。此值在Eclipse中在Eclipse中，可直接看到：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/baidu-loc1.png)\n若是使用Android Studio，直接在setting中好像看不到该值。此时需要通过命令行来获取，具体操作可参考[百度开发指南](http://developer.baidu.com/map/index.php?title=androidsdk/guide/key)。\n\n<!--more-->\n\n通过上述方式获取到的SHA1值为debug版本的，若是在Android Studio中，采用自己的keystore生成的apk对应的SHA1值会与debug版本的值不一致，这就导致了在百度开放平台上申请到的key值不对（key值需要SHA1值与app包名）。\n\n此时需要获得release版本对应的SHA1值。步骤如下：\n1. 将自己的keystore拷贝一份到C:\\Users\\Administrator\\.android目录下；\n2. 命令行进入到.android文件夹，执行命令：\n```\nkeytool -list -keystore keystorefile\n```\nkeystorefile为刚刚拷贝的keystore文件。\n会提示输入秘钥库口令，输入之后回车即可获取SHA1值。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/baidu-loc2.png)\n使用该SHA1值去开放平台申请秘钥，然后替换AndroidManifest.xml中的key值。之后采用自己那个keystore进行release打包出来的apk即可正常使用百度SDK了。\n","source":"_posts/baidu-loc.md","raw":"---\ntitle: 百度定位SDK无法定位\ndate: 2015-10-24 17:14:50\ntags:\n - sdk\n---\n\n最近的项目中，有使用到百度定位SDK，在自己的debug环境安装apk，手机可以进行定位。但是发布release版本后安装，手机却无法定位。后面找到问题是百度配置的秘钥不对。\n\n百度地图SDK在申请秘钥时，需要SHA1值。此值在Eclipse中在Eclipse中，可直接看到：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/baidu-loc1.png)\n若是使用Android Studio，直接在setting中好像看不到该值。此时需要通过命令行来获取，具体操作可参考[百度开发指南](http://developer.baidu.com/map/index.php?title=androidsdk/guide/key)。\n\n<!--more-->\n\n通过上述方式获取到的SHA1值为debug版本的，若是在Android Studio中，采用自己的keystore生成的apk对应的SHA1值会与debug版本的值不一致，这就导致了在百度开放平台上申请到的key值不对（key值需要SHA1值与app包名）。\n\n此时需要获得release版本对应的SHA1值。步骤如下：\n1. 将自己的keystore拷贝一份到C:\\Users\\Administrator\\.android目录下；\n2. 命令行进入到.android文件夹，执行命令：\n```\nkeytool -list -keystore keystorefile\n```\nkeystorefile为刚刚拷贝的keystore文件。\n会提示输入秘钥库口令，输入之后回车即可获取SHA1值。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/baidu-loc2.png)\n使用该SHA1值去开放平台申请秘钥，然后替换AndroidManifest.xml中的key值。之后采用自己那个keystore进行release打包出来的apk即可正常使用百度SDK了。\n","slug":"baidu-loc","published":1,"updated":"2016-11-21T09:56:58.225Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7588000f1cb8c77wf6kg","content":"<p>最近的项目中，有使用到百度定位SDK，在自己的debug环境安装apk，手机可以进行定位。但是发布release版本后安装，手机却无法定位。后面找到问题是百度配置的秘钥不对。</p>\n<p>百度地图SDK在申请秘钥时，需要SHA1值。此值在Eclipse中在Eclipse中，可直接看到：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/baidu-loc1.png\" alt=\"这里写图片描述\"><br>若是使用Android Studio，直接在setting中好像看不到该值。此时需要通过命令行来获取，具体操作可参考<a href=\"http://developer.baidu.com/map/index.php?title=androidsdk/guide/key\" target=\"_blank\" rel=\"external\">百度开发指南</a>。</p>\n<a id=\"more\"></a>\n<p>通过上述方式获取到的SHA1值为debug版本的，若是在Android Studio中，采用自己的keystore生成的apk对应的SHA1值会与debug版本的值不一致，这就导致了在百度开放平台上申请到的key值不对（key值需要SHA1值与app包名）。</p>\n<p>此时需要获得release版本对应的SHA1值。步骤如下：</p>\n<ol>\n<li>将自己的keystore拷贝一份到C:\\Users\\Administrator.android目录下；</li>\n<li>命令行进入到.android文件夹，执行命令：<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">keytool -<span class=\"built_in\">list</span> -keystore keystorefile</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>keystorefile为刚刚拷贝的keystore文件。<br>会提示输入秘钥库口令，输入之后回车即可获取SHA1值。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/baidu-loc2.png\" alt=\"这里写图片描述\"><br>使用该SHA1值去开放平台申请秘钥，然后替换AndroidManifest.xml中的key值。之后采用自己那个keystore进行release打包出来的apk即可正常使用百度SDK了。</p>\n","excerpt":"<p>最近的项目中，有使用到百度定位SDK，在自己的debug环境安装apk，手机可以进行定位。但是发布release版本后安装，手机却无法定位。后面找到问题是百度配置的秘钥不对。</p>\n<p>百度地图SDK在申请秘钥时，需要SHA1值。此值在Eclipse中在Eclipse中，可直接看到：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/baidu-loc1.png\" alt=\"这里写图片描述\"><br>若是使用Android Studio，直接在setting中好像看不到该值。此时需要通过命令行来获取，具体操作可参考<a href=\"http://developer.baidu.com/map/index.php?title=androidsdk/guide/key\">百度开发指南</a>。</p>","more":"<p>通过上述方式获取到的SHA1值为debug版本的，若是在Android Studio中，采用自己的keystore生成的apk对应的SHA1值会与debug版本的值不一致，这就导致了在百度开放平台上申请到的key值不对（key值需要SHA1值与app包名）。</p>\n<p>此时需要获得release版本对应的SHA1值。步骤如下：</p>\n<ol>\n<li>将自己的keystore拷贝一份到C:\\Users\\Administrator.android目录下；</li>\n<li>命令行进入到.android文件夹，执行命令：<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">keytool -<span class=\"built_in\">list</span> -keystore keystorefile</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>keystorefile为刚刚拷贝的keystore文件。<br>会提示输入秘钥库口令，输入之后回车即可获取SHA1值。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/baidu-loc2.png\" alt=\"这里写图片描述\"><br>使用该SHA1值去开放平台申请秘钥，然后替换AndroidManifest.xml中的key值。之后采用自己那个keystore进行release打包出来的apk即可正常使用百度SDK了。</p>"},{"title":"Android高斯模糊","date":"2016-07-21T02:49:43.000Z","_content":"\n高斯模糊的工具类，摘录下来，免得以后找不着了。\n\n<!-- more -->\n\n```\n/**\n * 高斯模糊\n * @param context\n * @param sentBitmap\n * @param radius 0 < radius <= 25\n * @return\n */\n@SuppressLint(\"NewApi\")\npublic static Bitmap fastBlur(Context context, Bitmap sentBitmap, int radius) {\n\n\tif (Build.VERSION.SDK_INT > 16) {\n\t\tBitmap bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);\n\n\t\tfinal RenderScript rs = RenderScript.create(context);\n\t\tfinal Allocation input = Allocation.createFromBitmap(rs,\n\t\t\t\tsentBitmap, Allocation.MipmapControl.MIPMAP_NONE,\n\t\t\t\tAllocation.USAGE_SCRIPT);\n\t\tfinal Allocation output = Allocation.createTyped(rs,\n\t\t\t\tinput.getType());\n\t\tfinal ScriptIntrinsicBlur script = ScriptIntrinsicBlur.create(rs,\n\t\t\t\tElement.U8_4(rs));\n\t\tscript.setRadius(radius);\n\t\tscript.setInput(input);\n\t\tscript.forEach(output);\n\t\toutput.copyTo(bitmap);\n\t\treturn bitmap;\n\t}\n\n\t// Stack Blur v1.0 from\n\t// http://www.quasimondo.com/StackBlurForCanvas/StackBlurDemo.html\n\t//\n\t// Java Author: Mario Klingemann <mario at quasimondo.com>\n\t// http://incubator.quasimondo.com\n\t// created Feburary 29, 2004\n\t// Android port : Yahel Bouaziz <yahel at kayenko.com>\n\t// http://www.kayenko.com\n\t// ported april 5th, 2012\n\n\t// This is a compromise between Gaussian Blur and Box blur\n\t// It creates much better looking blurs than Box Blur, but is\n\t// 7x faster than my Gaussian Blur implementation.\n\t//\n\t// I called it Stack Blur because this describes best how this\n\t// filter works internally: it creates a kind of moving stack\n\t// of colors whilst scanning through the image. Thereby it\n\t// just has to add one new block of color to the right side\n\t// of the stack and remove the leftmost color. The remaining\n\t// colors on the topmost layer of the stack are either added on\n\t// or reduced by one, depending on if they are on the right or\n\t// on the left side of the stack.\n\t//\n\t// If you are using this algorithm in your code please add\n\t// the following line:\n\t//\n\t// Stack Blur Algorithm by Mario Klingemann <mario@quasimondo.com>\n\n\tBitmap bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);\n\n\tif (radius < 1) {\n\t\treturn (null);\n\t}\n\n\tint w = bitmap.getWidth();\n\tint h = bitmap.getHeight();\n\n\tint[] pix = new int[w * h];\n\tbitmap.getPixels(pix, 0, w, 0, 0, w, h);\n\n\tint wm = w - 1;\n\tint hm = h - 1;\n\tint wh = w * h;\n\tint div = radius + radius + 1;\n\n\tint r[] = new int[wh];\n\tint g[] = new int[wh];\n\tint b[] = new int[wh];\n\tint rsum, gsum, bsum, x, y, i, p, yp, yi, yw;\n\tint vmin[] = new int[Math.max(w, h)];\n\n\tint divsum = (div + 1) >> 1;\n\tdivsum *= divsum;\n\tint dv[] = new int[256 * divsum];\n\tfor (i = 0; i < 256 * divsum; i++) {\n\t\tdv[i] = (i / divsum);\n\t}\n\n\tyw = yi = 0;\n\n\tint[][] stack = new int[div][3];\n\tint stackpointer;\n\tint stackstart;\n\tint[] sir;\n\tint rbs;\n\tint r1 = radius + 1;\n\tint routsum, goutsum, boutsum;\n\tint rinsum, ginsum, binsum;\n\n\tfor (y = 0; y < h; y++) {\n\t\trinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = 0;\n\t\tfor (i = -radius; i <= radius; i++) {\n\t\t\tp = pix[yi + Math.min(wm, Math.max(i, 0))];\n\t\t\tsir = stack[i + radius];\n\t\t\tsir[0] = (p & 0xff0000) >> 16;\n\t\t\tsir[1] = (p & 0x00ff00) >> 8;\n\t\t\tsir[2] = (p & 0x0000ff);\n\t\t\trbs = r1 - Math.abs(i);\n\t\t\trsum += sir[0] * rbs;\n\t\t\tgsum += sir[1] * rbs;\n\t\t\tbsum += sir[2] * rbs;\n\t\t\tif (i > 0) {\n\t\t\t\trinsum += sir[0];\n\t\t\t\tginsum += sir[1];\n\t\t\t\tbinsum += sir[2];\n\t\t\t} else {\n\t\t\t\troutsum += sir[0];\n\t\t\t\tgoutsum += sir[1];\n\t\t\t\tboutsum += sir[2];\n\t\t\t}\n\t\t}\n\t\tstackpointer = radius;\n\n\t\tfor (x = 0; x < w; x++) {\n\n\t\t\tr[yi] = dv[rsum];\n\t\t\tg[yi] = dv[gsum];\n\t\t\tb[yi] = dv[bsum];\n\n\t\t\trsum -= routsum;\n\t\t\tgsum -= goutsum;\n\t\t\tbsum -= boutsum;\n\n\t\t\tstackstart = stackpointer - radius + div;\n\t\t\tsir = stack[stackstart % div];\n\n\t\t\troutsum -= sir[0];\n\t\t\tgoutsum -= sir[1];\n\t\t\tboutsum -= sir[2];\n\n\t\t\tif (y == 0) {\n\t\t\t\tvmin[x] = Math.min(x + radius + 1, wm);\n\t\t\t}\n\t\t\tp = pix[yw + vmin[x]];\n\n\t\t\tsir[0] = (p & 0xff0000) >> 16;\n\t\t\tsir[1] = (p & 0x00ff00) >> 8;\n\t\t\tsir[2] = (p & 0x0000ff);\n\n\t\t\trinsum += sir[0];\n\t\t\tginsum += sir[1];\n\t\t\tbinsum += sir[2];\n\n\t\t\trsum += rinsum;\n\t\t\tgsum += ginsum;\n\t\t\tbsum += binsum;\n\n\t\t\tstackpointer = (stackpointer + 1) % div;\n\t\t\tsir = stack[(stackpointer) % div];\n\n\t\t\troutsum += sir[0];\n\t\t\tgoutsum += sir[1];\n\t\t\tboutsum += sir[2];\n\n\t\t\trinsum -= sir[0];\n\t\t\tginsum -= sir[1];\n\t\t\tbinsum -= sir[2];\n\n\t\t\tyi++;\n\t\t}\n\t\tyw += w;\n\t}\n\tfor (x = 0; x < w; x++) {\n\t\trinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = 0;\n\t\typ = -radius * w;\n\t\tfor (i = -radius; i <= radius; i++) {\n\t\t\tyi = Math.max(0, yp) + x;\n\n\t\t\tsir = stack[i + radius];\n\n\t\t\tsir[0] = r[yi];\n\t\t\tsir[1] = g[yi];\n\t\t\tsir[2] = b[yi];\n\n\t\t\trbs = r1 - Math.abs(i);\n\n\t\t\trsum += r[yi] * rbs;\n\t\t\tgsum += g[yi] * rbs;\n\t\t\tbsum += b[yi] * rbs;\n\n\t\t\tif (i > 0) {\n\t\t\t\trinsum += sir[0];\n\t\t\t\tginsum += sir[1];\n\t\t\t\tbinsum += sir[2];\n\t\t\t} else {\n\t\t\t\troutsum += sir[0];\n\t\t\t\tgoutsum += sir[1];\n\t\t\t\tboutsum += sir[2];\n\t\t\t}\n\n\t\t\tif (i < hm) {\n\t\t\t\typ += w;\n\t\t\t}\n\t\t}\n\t\tyi = x;\n\t\tstackpointer = radius;\n\t\tfor (y = 0; y < h; y++) {\n\t\t\t// Preserve alpha channel: ( 0xff000000 & pix[yi] )\n\t\t\tpix[yi] = (0xff000000 & pix[yi]) | (dv[rsum] << 16)\n\t\t\t\t\t| (dv[gsum] << 8) | dv[bsum];\n\n\t\t\trsum -= routsum;\n\t\t\tgsum -= goutsum;\n\t\t\tbsum -= boutsum;\n\n\t\t\tstackstart = stackpointer - radius + div;\n\t\t\tsir = stack[stackstart % div];\n\n\t\t\troutsum -= sir[0];\n\t\t\tgoutsum -= sir[1];\n\t\t\tboutsum -= sir[2];\n\n\t\t\tif (x == 0) {\n\t\t\t\tvmin[y] = Math.min(y + r1, hm) * w;\n\t\t\t}\n\t\t\tp = x + vmin[y];\n\n\t\t\tsir[0] = r[p];\n\t\t\tsir[1] = g[p];\n\t\t\tsir[2] = b[p];\n\n\t\t\trinsum += sir[0];\n\t\t\tginsum += sir[1];\n\t\t\tbinsum += sir[2];\n\n\t\t\trsum += rinsum;\n\t\t\tgsum += ginsum;\n\t\t\tbsum += binsum;\n\n\t\t\tstackpointer = (stackpointer + 1) % div;\n\t\t\tsir = stack[stackpointer];\n\n\t\t\troutsum += sir[0];\n\t\t\tgoutsum += sir[1];\n\t\t\tboutsum += sir[2];\n\n\t\t\trinsum -= sir[0];\n\t\t\tginsum -= sir[1];\n\t\t\tbinsum -= sir[2];\n\n\t\t\tyi += w;\n\t\t}\n\t}\n\tbitmap.setPixels(pix, 0, w, 0, 0, w, h);\n\treturn (bitmap);\n}\n```\n","source":"_posts/blur.md","raw":"---\ntitle: Android高斯模糊\ndate: 2016-07-21 10:49:43\ntags:\n - 日常开发\n---\n\n高斯模糊的工具类，摘录下来，免得以后找不着了。\n\n<!-- more -->\n\n```\n/**\n * 高斯模糊\n * @param context\n * @param sentBitmap\n * @param radius 0 < radius <= 25\n * @return\n */\n@SuppressLint(\"NewApi\")\npublic static Bitmap fastBlur(Context context, Bitmap sentBitmap, int radius) {\n\n\tif (Build.VERSION.SDK_INT > 16) {\n\t\tBitmap bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);\n\n\t\tfinal RenderScript rs = RenderScript.create(context);\n\t\tfinal Allocation input = Allocation.createFromBitmap(rs,\n\t\t\t\tsentBitmap, Allocation.MipmapControl.MIPMAP_NONE,\n\t\t\t\tAllocation.USAGE_SCRIPT);\n\t\tfinal Allocation output = Allocation.createTyped(rs,\n\t\t\t\tinput.getType());\n\t\tfinal ScriptIntrinsicBlur script = ScriptIntrinsicBlur.create(rs,\n\t\t\t\tElement.U8_4(rs));\n\t\tscript.setRadius(radius);\n\t\tscript.setInput(input);\n\t\tscript.forEach(output);\n\t\toutput.copyTo(bitmap);\n\t\treturn bitmap;\n\t}\n\n\t// Stack Blur v1.0 from\n\t// http://www.quasimondo.com/StackBlurForCanvas/StackBlurDemo.html\n\t//\n\t// Java Author: Mario Klingemann <mario at quasimondo.com>\n\t// http://incubator.quasimondo.com\n\t// created Feburary 29, 2004\n\t// Android port : Yahel Bouaziz <yahel at kayenko.com>\n\t// http://www.kayenko.com\n\t// ported april 5th, 2012\n\n\t// This is a compromise between Gaussian Blur and Box blur\n\t// It creates much better looking blurs than Box Blur, but is\n\t// 7x faster than my Gaussian Blur implementation.\n\t//\n\t// I called it Stack Blur because this describes best how this\n\t// filter works internally: it creates a kind of moving stack\n\t// of colors whilst scanning through the image. Thereby it\n\t// just has to add one new block of color to the right side\n\t// of the stack and remove the leftmost color. The remaining\n\t// colors on the topmost layer of the stack are either added on\n\t// or reduced by one, depending on if they are on the right or\n\t// on the left side of the stack.\n\t//\n\t// If you are using this algorithm in your code please add\n\t// the following line:\n\t//\n\t// Stack Blur Algorithm by Mario Klingemann <mario@quasimondo.com>\n\n\tBitmap bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);\n\n\tif (radius < 1) {\n\t\treturn (null);\n\t}\n\n\tint w = bitmap.getWidth();\n\tint h = bitmap.getHeight();\n\n\tint[] pix = new int[w * h];\n\tbitmap.getPixels(pix, 0, w, 0, 0, w, h);\n\n\tint wm = w - 1;\n\tint hm = h - 1;\n\tint wh = w * h;\n\tint div = radius + radius + 1;\n\n\tint r[] = new int[wh];\n\tint g[] = new int[wh];\n\tint b[] = new int[wh];\n\tint rsum, gsum, bsum, x, y, i, p, yp, yi, yw;\n\tint vmin[] = new int[Math.max(w, h)];\n\n\tint divsum = (div + 1) >> 1;\n\tdivsum *= divsum;\n\tint dv[] = new int[256 * divsum];\n\tfor (i = 0; i < 256 * divsum; i++) {\n\t\tdv[i] = (i / divsum);\n\t}\n\n\tyw = yi = 0;\n\n\tint[][] stack = new int[div][3];\n\tint stackpointer;\n\tint stackstart;\n\tint[] sir;\n\tint rbs;\n\tint r1 = radius + 1;\n\tint routsum, goutsum, boutsum;\n\tint rinsum, ginsum, binsum;\n\n\tfor (y = 0; y < h; y++) {\n\t\trinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = 0;\n\t\tfor (i = -radius; i <= radius; i++) {\n\t\t\tp = pix[yi + Math.min(wm, Math.max(i, 0))];\n\t\t\tsir = stack[i + radius];\n\t\t\tsir[0] = (p & 0xff0000) >> 16;\n\t\t\tsir[1] = (p & 0x00ff00) >> 8;\n\t\t\tsir[2] = (p & 0x0000ff);\n\t\t\trbs = r1 - Math.abs(i);\n\t\t\trsum += sir[0] * rbs;\n\t\t\tgsum += sir[1] * rbs;\n\t\t\tbsum += sir[2] * rbs;\n\t\t\tif (i > 0) {\n\t\t\t\trinsum += sir[0];\n\t\t\t\tginsum += sir[1];\n\t\t\t\tbinsum += sir[2];\n\t\t\t} else {\n\t\t\t\troutsum += sir[0];\n\t\t\t\tgoutsum += sir[1];\n\t\t\t\tboutsum += sir[2];\n\t\t\t}\n\t\t}\n\t\tstackpointer = radius;\n\n\t\tfor (x = 0; x < w; x++) {\n\n\t\t\tr[yi] = dv[rsum];\n\t\t\tg[yi] = dv[gsum];\n\t\t\tb[yi] = dv[bsum];\n\n\t\t\trsum -= routsum;\n\t\t\tgsum -= goutsum;\n\t\t\tbsum -= boutsum;\n\n\t\t\tstackstart = stackpointer - radius + div;\n\t\t\tsir = stack[stackstart % div];\n\n\t\t\troutsum -= sir[0];\n\t\t\tgoutsum -= sir[1];\n\t\t\tboutsum -= sir[2];\n\n\t\t\tif (y == 0) {\n\t\t\t\tvmin[x] = Math.min(x + radius + 1, wm);\n\t\t\t}\n\t\t\tp = pix[yw + vmin[x]];\n\n\t\t\tsir[0] = (p & 0xff0000) >> 16;\n\t\t\tsir[1] = (p & 0x00ff00) >> 8;\n\t\t\tsir[2] = (p & 0x0000ff);\n\n\t\t\trinsum += sir[0];\n\t\t\tginsum += sir[1];\n\t\t\tbinsum += sir[2];\n\n\t\t\trsum += rinsum;\n\t\t\tgsum += ginsum;\n\t\t\tbsum += binsum;\n\n\t\t\tstackpointer = (stackpointer + 1) % div;\n\t\t\tsir = stack[(stackpointer) % div];\n\n\t\t\troutsum += sir[0];\n\t\t\tgoutsum += sir[1];\n\t\t\tboutsum += sir[2];\n\n\t\t\trinsum -= sir[0];\n\t\t\tginsum -= sir[1];\n\t\t\tbinsum -= sir[2];\n\n\t\t\tyi++;\n\t\t}\n\t\tyw += w;\n\t}\n\tfor (x = 0; x < w; x++) {\n\t\trinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = 0;\n\t\typ = -radius * w;\n\t\tfor (i = -radius; i <= radius; i++) {\n\t\t\tyi = Math.max(0, yp) + x;\n\n\t\t\tsir = stack[i + radius];\n\n\t\t\tsir[0] = r[yi];\n\t\t\tsir[1] = g[yi];\n\t\t\tsir[2] = b[yi];\n\n\t\t\trbs = r1 - Math.abs(i);\n\n\t\t\trsum += r[yi] * rbs;\n\t\t\tgsum += g[yi] * rbs;\n\t\t\tbsum += b[yi] * rbs;\n\n\t\t\tif (i > 0) {\n\t\t\t\trinsum += sir[0];\n\t\t\t\tginsum += sir[1];\n\t\t\t\tbinsum += sir[2];\n\t\t\t} else {\n\t\t\t\troutsum += sir[0];\n\t\t\t\tgoutsum += sir[1];\n\t\t\t\tboutsum += sir[2];\n\t\t\t}\n\n\t\t\tif (i < hm) {\n\t\t\t\typ += w;\n\t\t\t}\n\t\t}\n\t\tyi = x;\n\t\tstackpointer = radius;\n\t\tfor (y = 0; y < h; y++) {\n\t\t\t// Preserve alpha channel: ( 0xff000000 & pix[yi] )\n\t\t\tpix[yi] = (0xff000000 & pix[yi]) | (dv[rsum] << 16)\n\t\t\t\t\t| (dv[gsum] << 8) | dv[bsum];\n\n\t\t\trsum -= routsum;\n\t\t\tgsum -= goutsum;\n\t\t\tbsum -= boutsum;\n\n\t\t\tstackstart = stackpointer - radius + div;\n\t\t\tsir = stack[stackstart % div];\n\n\t\t\troutsum -= sir[0];\n\t\t\tgoutsum -= sir[1];\n\t\t\tboutsum -= sir[2];\n\n\t\t\tif (x == 0) {\n\t\t\t\tvmin[y] = Math.min(y + r1, hm) * w;\n\t\t\t}\n\t\t\tp = x + vmin[y];\n\n\t\t\tsir[0] = r[p];\n\t\t\tsir[1] = g[p];\n\t\t\tsir[2] = b[p];\n\n\t\t\trinsum += sir[0];\n\t\t\tginsum += sir[1];\n\t\t\tbinsum += sir[2];\n\n\t\t\trsum += rinsum;\n\t\t\tgsum += ginsum;\n\t\t\tbsum += binsum;\n\n\t\t\tstackpointer = (stackpointer + 1) % div;\n\t\t\tsir = stack[stackpointer];\n\n\t\t\troutsum += sir[0];\n\t\t\tgoutsum += sir[1];\n\t\t\tboutsum += sir[2];\n\n\t\t\trinsum -= sir[0];\n\t\t\tginsum -= sir[1];\n\t\t\tbinsum -= sir[2];\n\n\t\t\tyi += w;\n\t\t}\n\t}\n\tbitmap.setPixels(pix, 0, w, 0, 0, w, h);\n\treturn (bitmap);\n}\n```\n","slug":"blur","published":1,"updated":"2016-11-21T10:00:43.099Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7589000h1cb8eynapeu2","content":"<p>高斯模糊的工具类，摘录下来，免得以后找不着了。</p>\n<a id=\"more\"></a>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 高斯模糊</div><div class=\"line\"> * @param context</div><div class=\"line\"> * @param sentBitmap</div><div class=\"line\"> * @param radius 0 &lt; radius &lt;= 25</div><div class=\"line\"> * @return</div><div class=\"line\"> */</div><div class=\"line\">@SuppressLint(<span class=\"string\">\"NewApi\"</span>)</div><div class=\"line\">public static Bitmap fastBlur(Context context, Bitmap sentBitmap, int radius) &#123;</div><div class=\"line\"></div><div class=\"line\">\tif (Build.VERSION.SDK_INT &gt; <span class=\"number\">16</span>) &#123;</div><div class=\"line\">\t\tBitmap bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);</div><div class=\"line\"></div><div class=\"line\">\t\tfinal RenderScript rs = RenderScript.create(context);</div><div class=\"line\">\t\tfinal Allocation input = Allocation.createFromBitmap(rs,</div><div class=\"line\">\t\t\t\tsentBitmap, Allocation.MipmapControl.MIPMAP_NONE,</div><div class=\"line\">\t\t\t\tAllocation.USAGE_SCRIPT);</div><div class=\"line\">\t\tfinal Allocation output = Allocation.createTyped(rs,</div><div class=\"line\">\t\t\t\tinput.getType());</div><div class=\"line\">\t\tfinal ScriptIntrinsicBlur script = ScriptIntrinsicBlur.create(rs,</div><div class=\"line\">\t\t\t\tElement.U8_4(rs));</div><div class=\"line\">\t\tscript.setRadius(radius);</div><div class=\"line\">\t\tscript.setInput(input);</div><div class=\"line\">\t\tscript.forEach(output);</div><div class=\"line\">\t\toutput.copyTo(bitmap);</div><div class=\"line\">\t\treturn bitmap;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">// Stack Blur v1.0 from</span></div><div class=\"line\">\t<span class=\"comment\">// http://www.quasimondo.com/StackBlurForCanvas/StackBlurDemo.html</span></div><div class=\"line\">\t<span class=\"comment\">//</span></div><div class=\"line\">\t<span class=\"comment\">// Java Author: Mario Klingemann &lt;mario at quasimondo.com&gt;</span></div><div class=\"line\">\t<span class=\"comment\">// http://incubator.quasimondo.com</span></div><div class=\"line\">\t<span class=\"comment\">// created Feburary 29, 2004</span></div><div class=\"line\">\t<span class=\"comment\">// Android port : Yahel Bouaziz &lt;yahel at kayenko.com&gt;</span></div><div class=\"line\">\t<span class=\"comment\">// http://www.kayenko.com</span></div><div class=\"line\">\t<span class=\"comment\">// ported april 5th, 2012</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">// This is a compromise between Gaussian Blur and Box blur</span></div><div class=\"line\">\t<span class=\"comment\">// It creates much better looking blurs than Box Blur, but is</span></div><div class=\"line\">\t<span class=\"comment\">// 7x faster than my Gaussian Blur implementation.</span></div><div class=\"line\">\t<span class=\"comment\">//</span></div><div class=\"line\">\t<span class=\"comment\">// I called it Stack Blur because this describes best how this</span></div><div class=\"line\">\t<span class=\"comment\">// filter works internally: it creates a kind of moving stack</span></div><div class=\"line\">\t<span class=\"comment\">// of colors whilst scanning through the image. Thereby it</span></div><div class=\"line\">\t<span class=\"comment\">// just has to add one new block of color to the right side</span></div><div class=\"line\">\t<span class=\"comment\">// of the stack and remove the leftmost color. The remaining</span></div><div class=\"line\">\t<span class=\"comment\">// colors on the topmost layer of the stack are either added on</span></div><div class=\"line\">\t<span class=\"comment\">// or reduced by one, depending on if they are on the right or</span></div><div class=\"line\">\t<span class=\"comment\">// on the left side of the stack.</span></div><div class=\"line\">\t<span class=\"comment\">//</span></div><div class=\"line\">\t<span class=\"comment\">// If you are using this algorithm in your code please add</span></div><div class=\"line\">\t<span class=\"comment\">// the following line:</span></div><div class=\"line\">\t<span class=\"comment\">//</span></div><div class=\"line\">\t<span class=\"comment\">// Stack Blur Algorithm by Mario Klingemann &lt;mario@quasimondo.com&gt;</span></div><div class=\"line\"></div><div class=\"line\">\tBitmap bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);</div><div class=\"line\"></div><div class=\"line\">\tif (radius &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\">\t\treturn (null);</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tint w = bitmap.getWidth();</div><div class=\"line\">\tint h = bitmap.getHeight();</div><div class=\"line\"></div><div class=\"line\">\tint[] pix = new int[w * h];</div><div class=\"line\">\tbitmap.getPixels(pix, <span class=\"number\">0</span>, w, <span class=\"number\">0</span>, <span class=\"number\">0</span>, w, h);</div><div class=\"line\"></div><div class=\"line\">\tint wm = w - <span class=\"number\">1</span>;</div><div class=\"line\">\tint hm = h - <span class=\"number\">1</span>;</div><div class=\"line\">\tint wh = w * h;</div><div class=\"line\">\tint div = radius + radius + <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">\tint r[] = new int[wh];</div><div class=\"line\">\tint g[] = new int[wh];</div><div class=\"line\">\tint b[] = new int[wh];</div><div class=\"line\">\tint rsum, gsum, bsum, x, y, i, p, yp, yi, yw;</div><div class=\"line\">\tint vmin[] = new int[Math.max(w, h)];</div><div class=\"line\"></div><div class=\"line\">\tint divsum = (div + <span class=\"number\">1</span>) &gt;&gt; <span class=\"number\">1</span>;</div><div class=\"line\">\tdivsum *= divsum;</div><div class=\"line\">\tint dv[] = new int[<span class=\"number\">256</span> * divsum];</div><div class=\"line\">\tfor (i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">256</span> * divsum; i++) &#123;</div><div class=\"line\">\t\tdv[i] = (i / divsum);</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tyw = yi = <span class=\"number\">0</span>;</div><div class=\"line\"></div><div class=\"line\">\tint[][] stack = new int[div][<span class=\"number\">3</span>];</div><div class=\"line\">\tint stackpointer;</div><div class=\"line\">\tint stackstart;</div><div class=\"line\">\tint[] sir;</div><div class=\"line\">\tint rbs;</div><div class=\"line\">\tint r1 = radius + <span class=\"number\">1</span>;</div><div class=\"line\">\tint routsum, goutsum, boutsum;</div><div class=\"line\">\tint rinsum, ginsum, binsum;</div><div class=\"line\"></div><div class=\"line\">\tfor (y = <span class=\"number\">0</span>; y &lt; h; y++) &#123;</div><div class=\"line\">\t\trinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = <span class=\"number\">0</span>;</div><div class=\"line\">\t\tfor (i = -radius; i &lt;= radius; i++) &#123;</div><div class=\"line\">\t\t\tp = pix[yi + Math.min(wm, Math.max(i, <span class=\"number\">0</span>))];</div><div class=\"line\">\t\t\tsir = stack[i + radius];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">0</span>] = (p &amp; <span class=\"number\">0xff0000</span>) &gt;&gt; <span class=\"number\">16</span>;</div><div class=\"line\">\t\t\tsir[<span class=\"number\">1</span>] = (p &amp; <span class=\"number\">0x00ff00</span>) &gt;&gt; <span class=\"number\">8</span>;</div><div class=\"line\">\t\t\tsir[<span class=\"number\">2</span>] = (p &amp; <span class=\"number\">0x0000ff</span>);</div><div class=\"line\">\t\t\trbs = r1 - Math.abs(i);</div><div class=\"line\">\t\t\trsum += sir[<span class=\"number\">0</span>] * rbs;</div><div class=\"line\">\t\t\tgsum += sir[<span class=\"number\">1</span>] * rbs;</div><div class=\"line\">\t\t\tbsum += sir[<span class=\"number\">2</span>] * rbs;</div><div class=\"line\">\t\t\tif (i &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">\t\t\t\trinsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\t\tginsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\t\tbinsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\">\t\t\t&#125; else &#123;</div><div class=\"line\">\t\t\t\troutsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\t\tgoutsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\t\tboutsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tstackpointer = radius;</div><div class=\"line\"></div><div class=\"line\">\t\tfor (x = <span class=\"number\">0</span>; x &lt; w; x++) &#123;</div><div class=\"line\"></div><div class=\"line\">\t\t\tr[yi] = dv[rsum];</div><div class=\"line\">\t\t\tg[yi] = dv[gsum];</div><div class=\"line\">\t\t\tb[yi] = dv[bsum];</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum -= routsum;</div><div class=\"line\">\t\t\tgsum -= goutsum;</div><div class=\"line\">\t\t\tbsum -= boutsum;</div><div class=\"line\"></div><div class=\"line\">\t\t\tstackstart = stackpointer - radius + div;</div><div class=\"line\">\t\t\tsir = stack[stackstart % div];</div><div class=\"line\"></div><div class=\"line\">\t\t\troutsum -= sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tgoutsum -= sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tboutsum -= sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\tif (y == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">\t\t\t\tvmin[x] = Math.min(x + radius + <span class=\"number\">1</span>, wm);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\tp = pix[yw + vmin[x]];</div><div class=\"line\"></div><div class=\"line\">\t\t\tsir[<span class=\"number\">0</span>] = (p &amp; <span class=\"number\">0xff0000</span>) &gt;&gt; <span class=\"number\">16</span>;</div><div class=\"line\">\t\t\tsir[<span class=\"number\">1</span>] = (p &amp; <span class=\"number\">0x00ff00</span>) &gt;&gt; <span class=\"number\">8</span>;</div><div class=\"line\">\t\t\tsir[<span class=\"number\">2</span>] = (p &amp; <span class=\"number\">0x0000ff</span>);</div><div class=\"line\"></div><div class=\"line\">\t\t\trinsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tginsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tbinsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum += rinsum;</div><div class=\"line\">\t\t\tgsum += ginsum;</div><div class=\"line\">\t\t\tbsum += binsum;</div><div class=\"line\"></div><div class=\"line\">\t\t\tstackpointer = (stackpointer + <span class=\"number\">1</span>) % div;</div><div class=\"line\">\t\t\tsir = stack[(stackpointer) % div];</div><div class=\"line\"></div><div class=\"line\">\t\t\troutsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tgoutsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tboutsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\trinsum -= sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tginsum -= sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tbinsum -= sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\tyi++;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tyw += w;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tfor (x = <span class=\"number\">0</span>; x &lt; w; x++) &#123;</div><div class=\"line\">\t\trinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = <span class=\"number\">0</span>;</div><div class=\"line\">\t\typ = -radius * w;</div><div class=\"line\">\t\tfor (i = -radius; i &lt;= radius; i++) &#123;</div><div class=\"line\">\t\t\tyi = Math.max(<span class=\"number\">0</span>, yp) + x;</div><div class=\"line\"></div><div class=\"line\">\t\t\tsir = stack[i + radius];</div><div class=\"line\"></div><div class=\"line\">\t\t\tsir[<span class=\"number\">0</span>] = r[yi];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">1</span>] = g[yi];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">2</span>] = b[yi];</div><div class=\"line\"></div><div class=\"line\">\t\t\trbs = r1 - Math.abs(i);</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum += r[yi] * rbs;</div><div class=\"line\">\t\t\tgsum += g[yi] * rbs;</div><div class=\"line\">\t\t\tbsum += b[yi] * rbs;</div><div class=\"line\"></div><div class=\"line\">\t\t\tif (i &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">\t\t\t\trinsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\t\tginsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\t\tbinsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\">\t\t\t&#125; else &#123;</div><div class=\"line\">\t\t\t\troutsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\t\tgoutsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\t\tboutsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\tif (i &lt; hm) &#123;</div><div class=\"line\">\t\t\t\typ += w;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tyi = x;</div><div class=\"line\">\t\tstackpointer = radius;</div><div class=\"line\">\t\tfor (y = <span class=\"number\">0</span>; y &lt; h; y++) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// Preserve alpha channel: ( 0xff000000 &amp; pix[yi] )</span></div><div class=\"line\">\t\t\tpix[yi] = (<span class=\"number\">0xff000000</span> &amp; pix[yi]) | (dv[rsum] &lt;&lt; <span class=\"number\">16</span>)</div><div class=\"line\">\t\t\t\t\t| (dv[gsum] &lt;&lt; <span class=\"number\">8</span>) | dv[bsum];</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum -= routsum;</div><div class=\"line\">\t\t\tgsum -= goutsum;</div><div class=\"line\">\t\t\tbsum -= boutsum;</div><div class=\"line\"></div><div class=\"line\">\t\t\tstackstart = stackpointer - radius + div;</div><div class=\"line\">\t\t\tsir = stack[stackstart % div];</div><div class=\"line\"></div><div class=\"line\">\t\t\troutsum -= sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tgoutsum -= sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tboutsum -= sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\tif (x == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">\t\t\t\tvmin[y] = Math.min(y + r1, hm) * w;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\tp = x + vmin[y];</div><div class=\"line\"></div><div class=\"line\">\t\t\tsir[<span class=\"number\">0</span>] = r[p];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">1</span>] = g[p];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">2</span>] = b[p];</div><div class=\"line\"></div><div class=\"line\">\t\t\trinsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tginsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tbinsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum += rinsum;</div><div class=\"line\">\t\t\tgsum += ginsum;</div><div class=\"line\">\t\t\tbsum += binsum;</div><div class=\"line\"></div><div class=\"line\">\t\t\tstackpointer = (stackpointer + <span class=\"number\">1</span>) % div;</div><div class=\"line\">\t\t\tsir = stack[stackpointer];</div><div class=\"line\"></div><div class=\"line\">\t\t\troutsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tgoutsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tboutsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\trinsum -= sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tginsum -= sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tbinsum -= sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\tyi += w;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tbitmap.setPixels(pix, <span class=\"number\">0</span>, w, <span class=\"number\">0</span>, <span class=\"number\">0</span>, w, h);</div><div class=\"line\">\treturn (bitmap);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n","excerpt":"<p>高斯模糊的工具类，摘录下来，免得以后找不着了。</p>","more":"<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 高斯模糊</div><div class=\"line\"> * @param context</div><div class=\"line\"> * @param sentBitmap</div><div class=\"line\"> * @param radius 0 &lt; radius &lt;= 25</div><div class=\"line\"> * @return</div><div class=\"line\"> */</span></div><div class=\"line\">@SuppressLint(<span class=\"string\">\"NewApi\"</span>)</div><div class=\"line\">public static Bitmap fastBlur(Context context, Bitmap sentBitmap, int radius) &#123;</div><div class=\"line\"></div><div class=\"line\">\tif (Build.VERSION.SDK_INT &gt; <span class=\"number\">16</span>) &#123;</div><div class=\"line\">\t\tBitmap bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);</div><div class=\"line\"></div><div class=\"line\">\t\tfinal RenderScript rs = RenderScript.create(context);</div><div class=\"line\">\t\tfinal Allocation input = Allocation.createFromBitmap(rs,</div><div class=\"line\">\t\t\t\tsentBitmap, Allocation.MipmapControl.MIPMAP_NONE,</div><div class=\"line\">\t\t\t\tAllocation.USAGE_SCRIPT);</div><div class=\"line\">\t\tfinal Allocation output = Allocation.createTyped(rs,</div><div class=\"line\">\t\t\t\tinput.getType());</div><div class=\"line\">\t\tfinal ScriptIntrinsicBlur script = ScriptIntrinsicBlur.create(rs,</div><div class=\"line\">\t\t\t\tElement.U8_4(rs));</div><div class=\"line\">\t\tscript.setRadius(radius);</div><div class=\"line\">\t\tscript.setInput(input);</div><div class=\"line\">\t\tscript.forEach(output);</div><div class=\"line\">\t\toutput.copyTo(bitmap);</div><div class=\"line\">\t\treturn bitmap;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">// Stack Blur v1.0 from</span></div><div class=\"line\">\t<span class=\"comment\">// http://www.quasimondo.com/StackBlurForCanvas/StackBlurDemo.html</span></div><div class=\"line\">\t<span class=\"comment\">//</span></div><div class=\"line\">\t<span class=\"comment\">// Java Author: Mario Klingemann &lt;mario at quasimondo.com&gt;</span></div><div class=\"line\">\t<span class=\"comment\">// http://incubator.quasimondo.com</span></div><div class=\"line\">\t<span class=\"comment\">// created Feburary 29, 2004</span></div><div class=\"line\">\t<span class=\"comment\">// Android port : Yahel Bouaziz &lt;yahel at kayenko.com&gt;</span></div><div class=\"line\">\t<span class=\"comment\">// http://www.kayenko.com</span></div><div class=\"line\">\t<span class=\"comment\">// ported april 5th, 2012</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">// This is a compromise between Gaussian Blur and Box blur</span></div><div class=\"line\">\t<span class=\"comment\">// It creates much better looking blurs than Box Blur, but is</span></div><div class=\"line\">\t<span class=\"comment\">// 7x faster than my Gaussian Blur implementation.</span></div><div class=\"line\">\t<span class=\"comment\">//</span></div><div class=\"line\">\t<span class=\"comment\">// I called it Stack Blur because this describes best how this</span></div><div class=\"line\">\t<span class=\"comment\">// filter works internally: it creates a kind of moving stack</span></div><div class=\"line\">\t<span class=\"comment\">// of colors whilst scanning through the image. Thereby it</span></div><div class=\"line\">\t<span class=\"comment\">// just has to add one new block of color to the right side</span></div><div class=\"line\">\t<span class=\"comment\">// of the stack and remove the leftmost color. The remaining</span></div><div class=\"line\">\t<span class=\"comment\">// colors on the topmost layer of the stack are either added on</span></div><div class=\"line\">\t<span class=\"comment\">// or reduced by one, depending on if they are on the right or</span></div><div class=\"line\">\t<span class=\"comment\">// on the left side of the stack.</span></div><div class=\"line\">\t<span class=\"comment\">//</span></div><div class=\"line\">\t<span class=\"comment\">// If you are using this algorithm in your code please add</span></div><div class=\"line\">\t<span class=\"comment\">// the following line:</span></div><div class=\"line\">\t<span class=\"comment\">//</span></div><div class=\"line\">\t<span class=\"comment\">// Stack Blur Algorithm by Mario Klingemann &lt;mario@quasimondo.com&gt;</span></div><div class=\"line\"></div><div class=\"line\">\tBitmap bitmap = sentBitmap.copy(sentBitmap.getConfig(), true);</div><div class=\"line\"></div><div class=\"line\">\tif (radius &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\">\t\treturn (null);</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tint w = bitmap.getWidth();</div><div class=\"line\">\tint h = bitmap.getHeight();</div><div class=\"line\"></div><div class=\"line\">\tint[] pix = new int[w * h];</div><div class=\"line\">\tbitmap.getPixels(pix, <span class=\"number\">0</span>, w, <span class=\"number\">0</span>, <span class=\"number\">0</span>, w, h);</div><div class=\"line\"></div><div class=\"line\">\tint wm = w - <span class=\"number\">1</span>;</div><div class=\"line\">\tint hm = h - <span class=\"number\">1</span>;</div><div class=\"line\">\tint wh = w * h;</div><div class=\"line\">\tint div = radius + radius + <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">\tint r[] = new int[wh];</div><div class=\"line\">\tint g[] = new int[wh];</div><div class=\"line\">\tint b[] = new int[wh];</div><div class=\"line\">\tint rsum, gsum, bsum, x, y, i, p, yp, yi, yw;</div><div class=\"line\">\tint vmin[] = new int[Math.max(w, h)];</div><div class=\"line\"></div><div class=\"line\">\tint divsum = (div + <span class=\"number\">1</span>) &gt;&gt; <span class=\"number\">1</span>;</div><div class=\"line\">\tdivsum *= divsum;</div><div class=\"line\">\tint dv[] = new int[<span class=\"number\">256</span> * divsum];</div><div class=\"line\">\tfor (i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">256</span> * divsum; i++) &#123;</div><div class=\"line\">\t\tdv[i] = (i / divsum);</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tyw = yi = <span class=\"number\">0</span>;</div><div class=\"line\"></div><div class=\"line\">\tint[][] stack = new int[div][<span class=\"number\">3</span>];</div><div class=\"line\">\tint stackpointer;</div><div class=\"line\">\tint stackstart;</div><div class=\"line\">\tint[] sir;</div><div class=\"line\">\tint rbs;</div><div class=\"line\">\tint r1 = radius + <span class=\"number\">1</span>;</div><div class=\"line\">\tint routsum, goutsum, boutsum;</div><div class=\"line\">\tint rinsum, ginsum, binsum;</div><div class=\"line\"></div><div class=\"line\">\tfor (y = <span class=\"number\">0</span>; y &lt; h; y++) &#123;</div><div class=\"line\">\t\trinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = <span class=\"number\">0</span>;</div><div class=\"line\">\t\tfor (i = -radius; i &lt;= radius; i++) &#123;</div><div class=\"line\">\t\t\tp = pix[yi + Math.min(wm, Math.max(i, <span class=\"number\">0</span>))];</div><div class=\"line\">\t\t\tsir = stack[i + radius];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">0</span>] = (p &amp; <span class=\"number\">0xff0000</span>) &gt;&gt; <span class=\"number\">16</span>;</div><div class=\"line\">\t\t\tsir[<span class=\"number\">1</span>] = (p &amp; <span class=\"number\">0x00ff00</span>) &gt;&gt; <span class=\"number\">8</span>;</div><div class=\"line\">\t\t\tsir[<span class=\"number\">2</span>] = (p &amp; <span class=\"number\">0x0000ff</span>);</div><div class=\"line\">\t\t\trbs = r1 - Math.abs(i);</div><div class=\"line\">\t\t\trsum += sir[<span class=\"number\">0</span>] * rbs;</div><div class=\"line\">\t\t\tgsum += sir[<span class=\"number\">1</span>] * rbs;</div><div class=\"line\">\t\t\tbsum += sir[<span class=\"number\">2</span>] * rbs;</div><div class=\"line\">\t\t\tif (i &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">\t\t\t\trinsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\t\tginsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\t\tbinsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\">\t\t\t&#125; else &#123;</div><div class=\"line\">\t\t\t\troutsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\t\tgoutsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\t\tboutsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tstackpointer = radius;</div><div class=\"line\"></div><div class=\"line\">\t\tfor (x = <span class=\"number\">0</span>; x &lt; w; x++) &#123;</div><div class=\"line\"></div><div class=\"line\">\t\t\tr[yi] = dv[rsum];</div><div class=\"line\">\t\t\tg[yi] = dv[gsum];</div><div class=\"line\">\t\t\tb[yi] = dv[bsum];</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum -= routsum;</div><div class=\"line\">\t\t\tgsum -= goutsum;</div><div class=\"line\">\t\t\tbsum -= boutsum;</div><div class=\"line\"></div><div class=\"line\">\t\t\tstackstart = stackpointer - radius + div;</div><div class=\"line\">\t\t\tsir = stack[stackstart % div];</div><div class=\"line\"></div><div class=\"line\">\t\t\troutsum -= sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tgoutsum -= sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tboutsum -= sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\tif (y == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">\t\t\t\tvmin[x] = Math.min(x + radius + <span class=\"number\">1</span>, wm);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\tp = pix[yw + vmin[x]];</div><div class=\"line\"></div><div class=\"line\">\t\t\tsir[<span class=\"number\">0</span>] = (p &amp; <span class=\"number\">0xff0000</span>) &gt;&gt; <span class=\"number\">16</span>;</div><div class=\"line\">\t\t\tsir[<span class=\"number\">1</span>] = (p &amp; <span class=\"number\">0x00ff00</span>) &gt;&gt; <span class=\"number\">8</span>;</div><div class=\"line\">\t\t\tsir[<span class=\"number\">2</span>] = (p &amp; <span class=\"number\">0x0000ff</span>);</div><div class=\"line\"></div><div class=\"line\">\t\t\trinsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tginsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tbinsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum += rinsum;</div><div class=\"line\">\t\t\tgsum += ginsum;</div><div class=\"line\">\t\t\tbsum += binsum;</div><div class=\"line\"></div><div class=\"line\">\t\t\tstackpointer = (stackpointer + <span class=\"number\">1</span>) % div;</div><div class=\"line\">\t\t\tsir = stack[(stackpointer) % div];</div><div class=\"line\"></div><div class=\"line\">\t\t\troutsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tgoutsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tboutsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\trinsum -= sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tginsum -= sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tbinsum -= sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\tyi++;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tyw += w;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tfor (x = <span class=\"number\">0</span>; x &lt; w; x++) &#123;</div><div class=\"line\">\t\trinsum = ginsum = binsum = routsum = goutsum = boutsum = rsum = gsum = bsum = <span class=\"number\">0</span>;</div><div class=\"line\">\t\typ = -radius * w;</div><div class=\"line\">\t\tfor (i = -radius; i &lt;= radius; i++) &#123;</div><div class=\"line\">\t\t\tyi = Math.max(<span class=\"number\">0</span>, yp) + x;</div><div class=\"line\"></div><div class=\"line\">\t\t\tsir = stack[i + radius];</div><div class=\"line\"></div><div class=\"line\">\t\t\tsir[<span class=\"number\">0</span>] = r[yi];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">1</span>] = g[yi];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">2</span>] = b[yi];</div><div class=\"line\"></div><div class=\"line\">\t\t\trbs = r1 - Math.abs(i);</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum += r[yi] * rbs;</div><div class=\"line\">\t\t\tgsum += g[yi] * rbs;</div><div class=\"line\">\t\t\tbsum += b[yi] * rbs;</div><div class=\"line\"></div><div class=\"line\">\t\t\tif (i &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">\t\t\t\trinsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\t\tginsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\t\tbinsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\">\t\t\t&#125; else &#123;</div><div class=\"line\">\t\t\t\troutsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\t\tgoutsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\t\tboutsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\tif (i &lt; hm) &#123;</div><div class=\"line\">\t\t\t\typ += w;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tyi = x;</div><div class=\"line\">\t\tstackpointer = radius;</div><div class=\"line\">\t\tfor (y = <span class=\"number\">0</span>; y &lt; h; y++) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// Preserve alpha channel: ( 0xff000000 &amp; pix[yi] )</span></div><div class=\"line\">\t\t\tpix[yi] = (<span class=\"number\">0xff000000</span> &amp; pix[yi]) | (dv[rsum] &lt;&lt; <span class=\"number\">16</span>)</div><div class=\"line\">\t\t\t\t\t| (dv[gsum] &lt;&lt; <span class=\"number\">8</span>) | dv[bsum];</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum -= routsum;</div><div class=\"line\">\t\t\tgsum -= goutsum;</div><div class=\"line\">\t\t\tbsum -= boutsum;</div><div class=\"line\"></div><div class=\"line\">\t\t\tstackstart = stackpointer - radius + div;</div><div class=\"line\">\t\t\tsir = stack[stackstart % div];</div><div class=\"line\"></div><div class=\"line\">\t\t\troutsum -= sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tgoutsum -= sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tboutsum -= sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\tif (x == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">\t\t\t\tvmin[y] = Math.min(y + r1, hm) * w;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\tp = x + vmin[y];</div><div class=\"line\"></div><div class=\"line\">\t\t\tsir[<span class=\"number\">0</span>] = r[p];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">1</span>] = g[p];</div><div class=\"line\">\t\t\tsir[<span class=\"number\">2</span>] = b[p];</div><div class=\"line\"></div><div class=\"line\">\t\t\trinsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tginsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tbinsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\trsum += rinsum;</div><div class=\"line\">\t\t\tgsum += ginsum;</div><div class=\"line\">\t\t\tbsum += binsum;</div><div class=\"line\"></div><div class=\"line\">\t\t\tstackpointer = (stackpointer + <span class=\"number\">1</span>) % div;</div><div class=\"line\">\t\t\tsir = stack[stackpointer];</div><div class=\"line\"></div><div class=\"line\">\t\t\troutsum += sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tgoutsum += sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tboutsum += sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\trinsum -= sir[<span class=\"number\">0</span>];</div><div class=\"line\">\t\t\tginsum -= sir[<span class=\"number\">1</span>];</div><div class=\"line\">\t\t\tbinsum -= sir[<span class=\"number\">2</span>];</div><div class=\"line\"></div><div class=\"line\">\t\t\tyi += w;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tbitmap.setPixels(pix, <span class=\"number\">0</span>, w, <span class=\"number\">0</span>, <span class=\"number\">0</span>, w, h);</div><div class=\"line\">\treturn (bitmap);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>"},{"title":"Android实现渐变title栏","date":"2016-03-02T02:03:48.000Z","_content":"\n最近用美团外卖点餐看到这样一个效果：\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/change-title1.png)\n\n顶部的title栏伴随着滑动有这样的一个效果，看起来很不错。\n\n正好项目中可能需要用到，于是打算自己实现一波。\n\n后面在百度、谷歌之后，发现ToolBar+CoordinatorLayout可以很轻易的实现这种效果。\n\n但是在项目中，并没有采用Android新特性的一些东西，所以就得基于目前状况想办法了。\n\n<!--more-->\n\n---\n先上一下最终的效果图：\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/change-title2.png)\n\n项目中并没有使用ToolBar这种控件，而是全部自己写的xml文件当做title，整个页面又是由ListView构成。顶部的遮罩背景是添加的一个HeaderView。\n\n贴一下这个页面的布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:id=\"@+id/root\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:background=\"#ffffff\"\n    android:orientation=\"vertical\">\n\n    <ListView\n        android:id=\"@+id/share_list\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:divider=\"@null\"\n        android:scrollbars=\"none\" />\n\n    <LinearLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:orientation=\"vertical\">\n\n        <FrameLayout\n            android:id=\"@+id/profile_header\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"@dimen/activity_head_normal_height\"\n            android:background=\"#00ffffff\">\n\n            <ImageView\n                android:id=\"@+id/profile_play_entry\"\n                android:layout_width=\"40dp\"\n                android:layout_height=\"40dp\"\n                android:layout_gravity=\"center_vertical|right\"\n                android:scaleType=\"center\"\n                android:src=\"@drawable/play_entry\" />\n\n            <TextView\n                android:id=\"@+id/profile_page\"\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:layout_gravity=\"center\"\n                android:text=\"我的\"\n                android:textColor=\"#ffffff\"\n                android:textSize=\"16sp\" />\n\n        </FrameLayout>\n\n        <View\n            android:id=\"@+id/divider\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"1px\"\n            android:background=\"@color/dark_gray\" />\n\n    </LinearLayout>\n\n</FrameLayout>\n```\n使用了一个布局固定在顶部，利用FrameLayout进行遮盖。那么要怎么样实现图中的效果呢？\n\n起初，我是想着自定义View，然后重写onTouchEvent事件，但是后面考虑到滑动距离，上滑、下滑等等很多可能性之后，可能需要各种各样的逻辑判断，会显得非常复杂，所以便放弃了这种思路。\n\n后面考虑到，其实我只需要获得到ListView顶端滑出屏幕的纵向距离，然后计算alpha值，赋给title的父布局应该就可以实现了。\n\n若是使用ScrollView，则会有个方法getScrollY可以直接获得到滑出的Y值，但是ListView我试了一下，获得的Y值总是0，所以得另想办法了。\n\n在网上找到这样的一个方法：\n```\npublic int getScrollY() {\n    View c = mListView.getChildAt(0);\n    if (c == null) {\n        return 0;\n    }\n    int firstVisiblePosition = mListView.getFirstVisiblePosition();\n    int top = c.getTop();\n    return -top + firstVisiblePosition * c.getHeight() ;\n}\n```\n就是通过item高度，以及第一个child的top值来计算出滑出的距离。\n\n结合这个思路，写出如下代码：\n```\nprivate AbsListView.OnScrollListener mScrollListener = new AbsListView.OnScrollListener() {\n        @Override\n        public void onScrollStateChanged(AbsListView view, int scrollState) {\n            if (scrollState == AbsListView.OnScrollListener.SCROLL_STATE_IDLE && !nothingToLoad) {\n                // 如果到达最后一行\n                if (shareList.getLastVisiblePosition() == shareList.getAdapter().getCount() - 1) {\n                    loadMore(); // 加载更多\n                }\n            }\n        }\n\n        @Override\n        public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCount, int totalItemCount) {\n            float scrollY = getScrollY();\n            float alpha = getAlpha(scrollY);\n            profilePage.setAlpha(alpha);\n            if (alpha > 0.5) { // alpha > 0.5设置黑色图标\n                if (isWhite) {\n                    entryPlay.setImageResource(R.drawable.play_entry1);\n                    profilePage.setTextColor(Color.BLACK);\n                    ObjectAnimator animator = ObjectAnimator.ofFloat(entryPlay, \"alpha\", 0.5f, 1);\n                    animator.setDuration(1000);\n                    animator.start();\n                }\n                isWhite = false;\n            } else { // 否则设置白色\n                if (!isWhite) {\n                    entryPlay.setImageResource(R.drawable.play_entry);\n                    profilePage.setTextColor(Color.WHITE);\n                    ObjectAnimator animator = ObjectAnimator.ofFloat(entryPlay, \"alpha\", 0.5f, 1);\n                    animator.setDuration(1000);\n                    animator.start();\n                }\n                isWhite = true;\n            }\n            if (Math.abs(alpha - 1) < 0.03) {\n                divider.setVisibility(View.VISIBLE);\n            } else {\n                divider.setVisibility(View.GONE);\n            }\n            header.setBackgroundColor(Color.argb((int) (alpha * 255), 255, 255, 255));\n        }\n    };\n\n    /**\n     * 计算ListView顶部滑动Y值\n     *\n     * @return\n     */\n    public float getScrollY() {\n        float scrollY;\n        View c = shareList.getChildAt(0);\n        if (c == null) {\n            return 0;\n        }\n        int firstVisiblePosition = shareList.getFirstVisiblePosition();\n        int top = c.getTop();\n        if (firstVisiblePosition > 0) {\n            scrollY = mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height); // 当HeaderView完全滑出时，alpha值为1，直接设置其高度值\n        } else {\n            scrollY = -top;\n        }\n        if (scrollY > mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height)) {\n            scrollY = mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height);\n        }\n        return scrollY;\n    }\n\n    /**\n     * 根据滑动Y值计算alpha值\n     *\n     * @param scrollY\n     * @return\n     */\n    public float getAlpha(float scrollY) {\n        if (mHeaderView.getHeight() != 0) {\n            return scrollY / (mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height));\n        }\n        return 0;\n    }\n```\nactivity_head_normal_height就是title栏的高度，所以能够滑动的最高距离是ListView的HeaderView的高度减去title的高度，当滑出高度大于这个高度，alpha直接就等于1了。\n\n通过上述代码，即可实现之前的效果了。\n\n---\n疑问：\n\n - 当HeaderView完全滑出的时候，c.getHeight() != mHeaderView.getHeight()，按理说c应该是跟mHeaderView是一致的；\n - 在滑动过程中，白色变黑色如何能够让它更自然的过渡呢（图标、文字）？目前是alpha = 0.5这个阈值，直接由白变黑，由黑变白，显得不太自然。\n\n欢迎网友们一起探讨~\n","source":"_posts/change-title.md","raw":"---\ntitle: Android实现渐变title栏\ndate: 2016-03-02 10:03:48\ntags:\n - 日常开发\n---\n\n最近用美团外卖点餐看到这样一个效果：\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/change-title1.png)\n\n顶部的title栏伴随着滑动有这样的一个效果，看起来很不错。\n\n正好项目中可能需要用到，于是打算自己实现一波。\n\n后面在百度、谷歌之后，发现ToolBar+CoordinatorLayout可以很轻易的实现这种效果。\n\n但是在项目中，并没有采用Android新特性的一些东西，所以就得基于目前状况想办法了。\n\n<!--more-->\n\n---\n先上一下最终的效果图：\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/change-title2.png)\n\n项目中并没有使用ToolBar这种控件，而是全部自己写的xml文件当做title，整个页面又是由ListView构成。顶部的遮罩背景是添加的一个HeaderView。\n\n贴一下这个页面的布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:id=\"@+id/root\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:background=\"#ffffff\"\n    android:orientation=\"vertical\">\n\n    <ListView\n        android:id=\"@+id/share_list\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:divider=\"@null\"\n        android:scrollbars=\"none\" />\n\n    <LinearLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:orientation=\"vertical\">\n\n        <FrameLayout\n            android:id=\"@+id/profile_header\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"@dimen/activity_head_normal_height\"\n            android:background=\"#00ffffff\">\n\n            <ImageView\n                android:id=\"@+id/profile_play_entry\"\n                android:layout_width=\"40dp\"\n                android:layout_height=\"40dp\"\n                android:layout_gravity=\"center_vertical|right\"\n                android:scaleType=\"center\"\n                android:src=\"@drawable/play_entry\" />\n\n            <TextView\n                android:id=\"@+id/profile_page\"\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:layout_gravity=\"center\"\n                android:text=\"我的\"\n                android:textColor=\"#ffffff\"\n                android:textSize=\"16sp\" />\n\n        </FrameLayout>\n\n        <View\n            android:id=\"@+id/divider\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"1px\"\n            android:background=\"@color/dark_gray\" />\n\n    </LinearLayout>\n\n</FrameLayout>\n```\n使用了一个布局固定在顶部，利用FrameLayout进行遮盖。那么要怎么样实现图中的效果呢？\n\n起初，我是想着自定义View，然后重写onTouchEvent事件，但是后面考虑到滑动距离，上滑、下滑等等很多可能性之后，可能需要各种各样的逻辑判断，会显得非常复杂，所以便放弃了这种思路。\n\n后面考虑到，其实我只需要获得到ListView顶端滑出屏幕的纵向距离，然后计算alpha值，赋给title的父布局应该就可以实现了。\n\n若是使用ScrollView，则会有个方法getScrollY可以直接获得到滑出的Y值，但是ListView我试了一下，获得的Y值总是0，所以得另想办法了。\n\n在网上找到这样的一个方法：\n```\npublic int getScrollY() {\n    View c = mListView.getChildAt(0);\n    if (c == null) {\n        return 0;\n    }\n    int firstVisiblePosition = mListView.getFirstVisiblePosition();\n    int top = c.getTop();\n    return -top + firstVisiblePosition * c.getHeight() ;\n}\n```\n就是通过item高度，以及第一个child的top值来计算出滑出的距离。\n\n结合这个思路，写出如下代码：\n```\nprivate AbsListView.OnScrollListener mScrollListener = new AbsListView.OnScrollListener() {\n        @Override\n        public void onScrollStateChanged(AbsListView view, int scrollState) {\n            if (scrollState == AbsListView.OnScrollListener.SCROLL_STATE_IDLE && !nothingToLoad) {\n                // 如果到达最后一行\n                if (shareList.getLastVisiblePosition() == shareList.getAdapter().getCount() - 1) {\n                    loadMore(); // 加载更多\n                }\n            }\n        }\n\n        @Override\n        public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCount, int totalItemCount) {\n            float scrollY = getScrollY();\n            float alpha = getAlpha(scrollY);\n            profilePage.setAlpha(alpha);\n            if (alpha > 0.5) { // alpha > 0.5设置黑色图标\n                if (isWhite) {\n                    entryPlay.setImageResource(R.drawable.play_entry1);\n                    profilePage.setTextColor(Color.BLACK);\n                    ObjectAnimator animator = ObjectAnimator.ofFloat(entryPlay, \"alpha\", 0.5f, 1);\n                    animator.setDuration(1000);\n                    animator.start();\n                }\n                isWhite = false;\n            } else { // 否则设置白色\n                if (!isWhite) {\n                    entryPlay.setImageResource(R.drawable.play_entry);\n                    profilePage.setTextColor(Color.WHITE);\n                    ObjectAnimator animator = ObjectAnimator.ofFloat(entryPlay, \"alpha\", 0.5f, 1);\n                    animator.setDuration(1000);\n                    animator.start();\n                }\n                isWhite = true;\n            }\n            if (Math.abs(alpha - 1) < 0.03) {\n                divider.setVisibility(View.VISIBLE);\n            } else {\n                divider.setVisibility(View.GONE);\n            }\n            header.setBackgroundColor(Color.argb((int) (alpha * 255), 255, 255, 255));\n        }\n    };\n\n    /**\n     * 计算ListView顶部滑动Y值\n     *\n     * @return\n     */\n    public float getScrollY() {\n        float scrollY;\n        View c = shareList.getChildAt(0);\n        if (c == null) {\n            return 0;\n        }\n        int firstVisiblePosition = shareList.getFirstVisiblePosition();\n        int top = c.getTop();\n        if (firstVisiblePosition > 0) {\n            scrollY = mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height); // 当HeaderView完全滑出时，alpha值为1，直接设置其高度值\n        } else {\n            scrollY = -top;\n        }\n        if (scrollY > mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height)) {\n            scrollY = mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height);\n        }\n        return scrollY;\n    }\n\n    /**\n     * 根据滑动Y值计算alpha值\n     *\n     * @param scrollY\n     * @return\n     */\n    public float getAlpha(float scrollY) {\n        if (mHeaderView.getHeight() != 0) {\n            return scrollY / (mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height));\n        }\n        return 0;\n    }\n```\nactivity_head_normal_height就是title栏的高度，所以能够滑动的最高距离是ListView的HeaderView的高度减去title的高度，当滑出高度大于这个高度，alpha直接就等于1了。\n\n通过上述代码，即可实现之前的效果了。\n\n---\n疑问：\n\n - 当HeaderView完全滑出的时候，c.getHeight() != mHeaderView.getHeight()，按理说c应该是跟mHeaderView是一致的；\n - 在滑动过程中，白色变黑色如何能够让它更自然的过渡呢（图标、文字）？目前是alpha = 0.5这个阈值，直接由白变黑，由黑变白，显得不太自然。\n\n欢迎网友们一起探讨~\n","slug":"change-title","published":1,"updated":"2016-11-21T09:57:09.751Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758c000j1cb8hi12ylbw","content":"<p>最近用美团外卖点餐看到这样一个效果：</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/change-title1.png\" alt=\"这里写图片描述\"></p>\n<p>顶部的title栏伴随着滑动有这样的一个效果，看起来很不错。</p>\n<p>正好项目中可能需要用到，于是打算自己实现一波。</p>\n<p>后面在百度、谷歌之后，发现ToolBar+CoordinatorLayout可以很轻易的实现这种效果。</p>\n<p>但是在项目中，并没有采用Android新特性的一些东西，所以就得基于目前状况想办法了。</p>\n<a id=\"more\"></a>\n<hr>\n<p>先上一下最终的效果图：</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/change-title2.png\" alt=\"这里写图片描述\"></p>\n<p>项目中并没有使用ToolBar这种控件，而是全部自己写的xml文件当做title，整个页面又是由ListView构成。顶部的遮罩背景是添加的一个HeaderView。</p>\n<p>贴一下这个页面的布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/root\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:background</span>=<span class=\"string\">\"#ffffff\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ListView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/share_list\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:divider</span>=<span class=\"string\">\"@null\"</span></div><div class=\"line\">        <span class=\"attr\">android:scrollbars</span>=<span class=\"string\">\"none\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/profile_header\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"@dimen/activity_head_normal_height\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"#00ffffff\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/profile_play_entry\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center_vertical|right\"</span></div><div class=\"line\">                <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">                <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/play_entry\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/profile_page\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"我的\"</span></div><div class=\"line\">                <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"#ffffff\"</span></div><div class=\"line\">                <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"16sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">View</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/divider\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"1px\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@color/dark_gray\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>使用了一个布局固定在顶部，利用FrameLayout进行遮盖。那么要怎么样实现图中的效果呢？</p>\n<p>起初，我是想着自定义View，然后重写onTouchEvent事件，但是后面考虑到滑动距离，上滑、下滑等等很多可能性之后，可能需要各种各样的逻辑判断，会显得非常复杂，所以便放弃了这种思路。</p>\n<p>后面考虑到，其实我只需要获得到ListView顶端滑出屏幕的纵向距离，然后计算alpha值，赋给title的父布局应该就可以实现了。</p>\n<p>若是使用ScrollView，则会有个方法getScrollY可以直接获得到滑出的Y值，但是ListView我试了一下，获得的Y值总是0，所以得另想办法了。</p>\n<p>在网上找到这样的一个方法：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getScrollY</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    View c = mListView.getChildAt(<span class=\"number\">0</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (c == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">int</span> firstVisiblePosition = mListView.getFirstVisiblePosition();</div><div class=\"line\">    <span class=\"keyword\">int</span> top = c.getTop();</div><div class=\"line\">    <span class=\"keyword\">return</span> -top + firstVisiblePosition * c.getHeight() ;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>就是通过item高度，以及第一个child的top值来计算出滑出的距离。</p>\n<p>结合这个思路，写出如下代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> AbsListView.OnScrollListener mScrollListener = <span class=\"keyword\">new</span> AbsListView.OnScrollListener() &#123;</div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScrollStateChanged</span><span class=\"params\">(AbsListView view, <span class=\"keyword\">int</span> scrollState)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (scrollState == AbsListView.OnScrollListener.SCROLL_STATE_IDLE &amp;&amp; !nothingToLoad) &#123;</div><div class=\"line\">                <span class=\"comment\">// 如果到达最后一行</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (shareList.getLastVisiblePosition() == shareList.getAdapter().getCount() - <span class=\"number\">1</span>) &#123;</div><div class=\"line\">                    loadMore(); <span class=\"comment\">// 加载更多</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScroll</span><span class=\"params\">(AbsListView view, <span class=\"keyword\">int</span> firstVisibleItem, <span class=\"keyword\">int</span> visibleItemCount, <span class=\"keyword\">int</span> totalItemCount)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">float</span> scrollY = getScrollY();</div><div class=\"line\">            <span class=\"keyword\">float</span> alpha = getAlpha(scrollY);</div><div class=\"line\">            profilePage.setAlpha(alpha);</div><div class=\"line\">            <span class=\"keyword\">if</span> (alpha &gt; <span class=\"number\">0.5</span>) &#123; <span class=\"comment\">// alpha &gt; 0.5设置黑色图标</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (isWhite) &#123;</div><div class=\"line\">                    entryPlay.setImageResource(R.drawable.play_entry1);</div><div class=\"line\">                    profilePage.setTextColor(Color.BLACK);</div><div class=\"line\">                    ObjectAnimator animator = ObjectAnimator.ofFloat(entryPlay, <span class=\"string\">\"alpha\"</span>, <span class=\"number\">0.5</span>f, <span class=\"number\">1</span>);</div><div class=\"line\">                    animator.setDuration(<span class=\"number\">1000</span>);</div><div class=\"line\">                    animator.start();</div><div class=\"line\">                &#125;</div><div class=\"line\">                isWhite = <span class=\"keyword\">false</span>;</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 否则设置白色</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (!isWhite) &#123;</div><div class=\"line\">                    entryPlay.setImageResource(R.drawable.play_entry);</div><div class=\"line\">                    profilePage.setTextColor(Color.WHITE);</div><div class=\"line\">                    ObjectAnimator animator = ObjectAnimator.ofFloat(entryPlay, <span class=\"string\">\"alpha\"</span>, <span class=\"number\">0.5</span>f, <span class=\"number\">1</span>);</div><div class=\"line\">                    animator.setDuration(<span class=\"number\">1000</span>);</div><div class=\"line\">                    animator.start();</div><div class=\"line\">                &#125;</div><div class=\"line\">                isWhite = <span class=\"keyword\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span> (Math.abs(alpha - <span class=\"number\">1</span>) &lt; <span class=\"number\">0.03</span>) &#123;</div><div class=\"line\">                divider.setVisibility(View.VISIBLE);</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                divider.setVisibility(View.GONE);</div><div class=\"line\">            &#125;</div><div class=\"line\">            header.setBackgroundColor(Color.argb((<span class=\"keyword\">int</span>) (alpha * <span class=\"number\">255</span>), <span class=\"number\">255</span>, <span class=\"number\">255</span>, <span class=\"number\">255</span>));</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 计算ListView顶部滑动Y值</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">float</span> <span class=\"title\">getScrollY</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> scrollY;</div><div class=\"line\">        View c = shareList.getChildAt(<span class=\"number\">0</span>);</div><div class=\"line\">        <span class=\"keyword\">if</span> (c == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">int</span> firstVisiblePosition = shareList.getFirstVisiblePosition();</div><div class=\"line\">        <span class=\"keyword\">int</span> top = c.getTop();</div><div class=\"line\">        <span class=\"keyword\">if</span> (firstVisiblePosition &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            scrollY = mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height); <span class=\"comment\">// 当HeaderView完全滑出时，alpha值为1，直接设置其高度值</span></div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            scrollY = -top;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scrollY &gt; mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height)) &#123;</div><div class=\"line\">            scrollY = mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> scrollY;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 根据滑动Y值计算alpha值</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> scrollY</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">float</span> <span class=\"title\">getAlpha</span><span class=\"params\">(<span class=\"keyword\">float</span> scrollY)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (mHeaderView.getHeight() != <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> scrollY / (mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height));</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>activity_head_normal_height就是title栏的高度，所以能够滑动的最高距离是ListView的HeaderView的高度减去title的高度，当滑出高度大于这个高度，alpha直接就等于1了。</p>\n<p>通过上述代码，即可实现之前的效果了。</p>\n<hr>\n<p>疑问：</p>\n<ul>\n<li>当HeaderView完全滑出的时候，c.getHeight() != mHeaderView.getHeight()，按理说c应该是跟mHeaderView是一致的；</li>\n<li>在滑动过程中，白色变黑色如何能够让它更自然的过渡呢（图标、文字）？目前是alpha = 0.5这个阈值，直接由白变黑，由黑变白，显得不太自然。</li>\n</ul>\n<p>欢迎网友们一起探讨~</p>\n","excerpt":"<p>最近用美团外卖点餐看到这样一个效果：</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/change-title1.png\" alt=\"这里写图片描述\"></p>\n<p>顶部的title栏伴随着滑动有这样的一个效果，看起来很不错。</p>\n<p>正好项目中可能需要用到，于是打算自己实现一波。</p>\n<p>后面在百度、谷歌之后，发现ToolBar+CoordinatorLayout可以很轻易的实现这种效果。</p>\n<p>但是在项目中，并没有采用Android新特性的一些东西，所以就得基于目前状况想办法了。</p>","more":"<hr>\n<p>先上一下最终的效果图：</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/change-title2.png\" alt=\"这里写图片描述\"></p>\n<p>项目中并没有使用ToolBar这种控件，而是全部自己写的xml文件当做title，整个页面又是由ListView构成。顶部的遮罩背景是添加的一个HeaderView。</p>\n<p>贴一下这个页面的布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/root\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:background</span>=<span class=\"string\">\"#ffffff\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ListView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/share_list\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:divider</span>=<span class=\"string\">\"@null\"</span></div><div class=\"line\">        <span class=\"attr\">android:scrollbars</span>=<span class=\"string\">\"none\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/profile_header\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"@dimen/activity_head_normal_height\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"#00ffffff\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/profile_play_entry\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center_vertical|right\"</span></div><div class=\"line\">                <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">                <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/play_entry\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/profile_page\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"我的\"</span></div><div class=\"line\">                <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"#ffffff\"</span></div><div class=\"line\">                <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"16sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">View</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/divider\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"1px\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@color/dark_gray\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>使用了一个布局固定在顶部，利用FrameLayout进行遮盖。那么要怎么样实现图中的效果呢？</p>\n<p>起初，我是想着自定义View，然后重写onTouchEvent事件，但是后面考虑到滑动距离，上滑、下滑等等很多可能性之后，可能需要各种各样的逻辑判断，会显得非常复杂，所以便放弃了这种思路。</p>\n<p>后面考虑到，其实我只需要获得到ListView顶端滑出屏幕的纵向距离，然后计算alpha值，赋给title的父布局应该就可以实现了。</p>\n<p>若是使用ScrollView，则会有个方法getScrollY可以直接获得到滑出的Y值，但是ListView我试了一下，获得的Y值总是0，所以得另想办法了。</p>\n<p>在网上找到这样的一个方法：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getScrollY</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    View c = mListView.getChildAt(<span class=\"number\">0</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (c == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">int</span> firstVisiblePosition = mListView.getFirstVisiblePosition();</div><div class=\"line\">    <span class=\"keyword\">int</span> top = c.getTop();</div><div class=\"line\">    <span class=\"keyword\">return</span> -top + firstVisiblePosition * c.getHeight() ;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>就是通过item高度，以及第一个child的top值来计算出滑出的距离。</p>\n<p>结合这个思路，写出如下代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> AbsListView.OnScrollListener mScrollListener = <span class=\"keyword\">new</span> AbsListView.OnScrollListener() &#123;</div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScrollStateChanged</span><span class=\"params\">(AbsListView view, <span class=\"keyword\">int</span> scrollState)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (scrollState == AbsListView.OnScrollListener.SCROLL_STATE_IDLE &amp;&amp; !nothingToLoad) &#123;</div><div class=\"line\">                <span class=\"comment\">// 如果到达最后一行</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (shareList.getLastVisiblePosition() == shareList.getAdapter().getCount() - <span class=\"number\">1</span>) &#123;</div><div class=\"line\">                    loadMore(); <span class=\"comment\">// 加载更多</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScroll</span><span class=\"params\">(AbsListView view, <span class=\"keyword\">int</span> firstVisibleItem, <span class=\"keyword\">int</span> visibleItemCount, <span class=\"keyword\">int</span> totalItemCount)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">float</span> scrollY = getScrollY();</div><div class=\"line\">            <span class=\"keyword\">float</span> alpha = getAlpha(scrollY);</div><div class=\"line\">            profilePage.setAlpha(alpha);</div><div class=\"line\">            <span class=\"keyword\">if</span> (alpha &gt; <span class=\"number\">0.5</span>) &#123; <span class=\"comment\">// alpha &gt; 0.5设置黑色图标</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (isWhite) &#123;</div><div class=\"line\">                    entryPlay.setImageResource(R.drawable.play_entry1);</div><div class=\"line\">                    profilePage.setTextColor(Color.BLACK);</div><div class=\"line\">                    ObjectAnimator animator = ObjectAnimator.ofFloat(entryPlay, <span class=\"string\">\"alpha\"</span>, <span class=\"number\">0.5</span>f, <span class=\"number\">1</span>);</div><div class=\"line\">                    animator.setDuration(<span class=\"number\">1000</span>);</div><div class=\"line\">                    animator.start();</div><div class=\"line\">                &#125;</div><div class=\"line\">                isWhite = <span class=\"keyword\">false</span>;</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 否则设置白色</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (!isWhite) &#123;</div><div class=\"line\">                    entryPlay.setImageResource(R.drawable.play_entry);</div><div class=\"line\">                    profilePage.setTextColor(Color.WHITE);</div><div class=\"line\">                    ObjectAnimator animator = ObjectAnimator.ofFloat(entryPlay, <span class=\"string\">\"alpha\"</span>, <span class=\"number\">0.5</span>f, <span class=\"number\">1</span>);</div><div class=\"line\">                    animator.setDuration(<span class=\"number\">1000</span>);</div><div class=\"line\">                    animator.start();</div><div class=\"line\">                &#125;</div><div class=\"line\">                isWhite = <span class=\"keyword\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span> (Math.abs(alpha - <span class=\"number\">1</span>) &lt; <span class=\"number\">0.03</span>) &#123;</div><div class=\"line\">                divider.setVisibility(View.VISIBLE);</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                divider.setVisibility(View.GONE);</div><div class=\"line\">            &#125;</div><div class=\"line\">            header.setBackgroundColor(Color.argb((<span class=\"keyword\">int</span>) (alpha * <span class=\"number\">255</span>), <span class=\"number\">255</span>, <span class=\"number\">255</span>, <span class=\"number\">255</span>));</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 计算ListView顶部滑动Y值</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">float</span> <span class=\"title\">getScrollY</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> scrollY;</div><div class=\"line\">        View c = shareList.getChildAt(<span class=\"number\">0</span>);</div><div class=\"line\">        <span class=\"keyword\">if</span> (c == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">int</span> firstVisiblePosition = shareList.getFirstVisiblePosition();</div><div class=\"line\">        <span class=\"keyword\">int</span> top = c.getTop();</div><div class=\"line\">        <span class=\"keyword\">if</span> (firstVisiblePosition &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            scrollY = mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height); <span class=\"comment\">// 当HeaderView完全滑出时，alpha值为1，直接设置其高度值</span></div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            scrollY = -top;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scrollY &gt; mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height)) &#123;</div><div class=\"line\">            scrollY = mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> scrollY;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 根据滑动Y值计算alpha值</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> scrollY</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">float</span> <span class=\"title\">getAlpha</span><span class=\"params\">(<span class=\"keyword\">float</span> scrollY)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (mHeaderView.getHeight() != <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> scrollY / (mHeaderView.getHeight() - getResources().getDimension(R.dimen.activity_head_normal_height));</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>activity_head_normal_height就是title栏的高度，所以能够滑动的最高距离是ListView的HeaderView的高度减去title的高度，当滑出高度大于这个高度，alpha直接就等于1了。</p>\n<p>通过上述代码，即可实现之前的效果了。</p>\n<hr>\n<p>疑问：</p>\n<ul>\n<li>当HeaderView完全滑出的时候，c.getHeight() != mHeaderView.getHeight()，按理说c应该是跟mHeaderView是一致的；</li>\n<li>在滑动过程中，白色变黑色如何能够让它更自然的过渡呢（图标、文字）？目前是alpha = 0.5这个阈值，直接由白变黑，由黑变白，显得不太自然。</li>\n</ul>\n<p>欢迎网友们一起探讨~</p>"},{"title":"Android-iOS 跨平台传输方案调研","date":"2016-10-28T08:21:48.000Z","_content":"\n## 现状\n1. iOS：在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipeer Connectivity框架，即使在没有连接到WiFi（WLAN）或移动网络（xG）的情况下，距离较近的Apple设备（iMac/iPad/iPhone）之间可基于蓝牙和WiFi（P2P WiFi）技术进行发现和连接实现近场通信。\n2. Android：Wi-Fi peer-to-peer（P2P，对等网络），它允许具备相应硬件的Android 4.0（API level 14）或者更高版本的设备可以直接通过wifi而不需要其它中间中转节点就能直接通信（Android的Wi-Fi P2P框架符合Wi-Fi联盟的Wi-Fi Direct™直连认证标志）。使用这些API，你可以搜索并连接其它同样支持Wi-Fi P2P的设备，然后再通过一个高速的连接进行互相通信，并且这个连接的有效距离要比蓝牙连接的有效距离要长的多。这对于需要在用户之间共享数据的应用程序非常有用，例如多玩家游戏或者照片分享之类应用。\n\n<!-- more -->\n\n但是iOS的MC框架与Android的Wifi Direct不兼容，通过苹果开发者论坛[iOS and Wi-Fi Direct](https://forums.developer.apple.com/message/49337#49337)了解：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video7.png)\n关于不同技术在iOS、Android上的兼容性，如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video8.png)\n\n## 蓝牙\n1. 经典蓝牙阶段：在蓝牙4.0（Bluetooth Low Energy）之前，也就是所谓的经典蓝牙，苹果的蓝牙拒绝接入不信任的设备。也就是说，没得连。\n2. 蓝牙4.0阶段：从ios6.0开始，iPhone支持BLe以后，问题得到了改善，因为在蓝牙4.0以后不再存在经典蓝牙的那个限制。ios7.0以后，BLe在 iOS 7 技术性提升里占到的重要位置。但是Android在这方面的脚步就慢很多了。\n - Android4.3：SDK从4.3以后开始正式在官方层面支持蓝牙4.0，可以使用安卓设备建立主机。注意，这里是说可以建立主机，也就是只能是安卓建立主机，iOS设备连接才可以。安卓无法去连接iOS的主机。\n - Android L：也就是Android 5.0，从这个版本开始，谷歌正式支持主从机的建立。\n\n[Android与IOS之间如何实现蓝牙通信数据传输？](https://www.zhihu.com/question/23246210)\n\n## 现有产品\n1. [快牙](http://www.kuaiya.cn/)\n> 快牙（ZAPYA），是一款全球首创、实现跨平台文件传输的应用，能帮助智能手机用户之间实现高速海量数据传输。支持安卓（Android）、苹果（iOS）、WP、PC等多种智能终端间的互联互通。通过快牙，可以和任何人分享应用、照片、视频、音乐及其他任意格式文件。目前快牙全球用户数量已超3亿，遍及海内外178个国家和地区，在同类型的传输应用中稳居第一。\n\n2. [茄子快传](https://www.ushareit.com/)\n> 茄子快传是北京众联极享科技有限公司推出的一款跨平台、多场景的移动数字互动平台（手机内容传输工具）。通过设备间建立的数据传输通路，茄子快传实现了在没有外部WiFi网络或者数据网络的情况下的数据高速收发，过程中无需消耗数据流量。用户操作简单，没有复杂的配对配置，无需登录账户、添加好友，支持多人互传，让用户摆脱数据线、蓝牙等复杂的分享方式，用一种简单、直观的交互让用户体验到近距离线下社交中与人分享的快乐。\n\n通过以上2款产品，可以实现跨平台数据传输。\n\n我利用2台Android手机测试，都是需要创建``热点``进行传输。Android与iOS测试，也是需要开启``热点``的，并且在iOS下需要手动链接到对应的热点。\n\n## 第三方\n1. [AllJoyn](https://allseenalliance.org/)\n> AllJoyn，由高通公司主导的高通创新中心（Qualcomm Innovation Center）所开发的开放源代码专案，主要用于近距离无线传输，透过Wifi或蓝牙技术，进行定位与点对点档案传输。\n\n2. [FireChat](http://www.opengarden.com/)\n> FireChat，是一个专门用于手机的APP，由开放花园公司开发。它能使智能手机在没有网络存取时，经由无线网状网络的蓝牙、Wi-Fi，或苹果公司的多点连线（Multipeer Connectivity）对等网络架构连线。\n\n3. [Underdark](http://underdark.io/)\n> Mobile peer-to-peer mesh networking library.Integrates into iOS and Android apps and works over Wi-Fi and Bluetooth.\n\n目前只是知道这些三方库，至于其内部的实现原理还不了解，但应该是结合Wi-Fi与蓝牙来实现的。\n\n## 小结\n通过目前已有的技术（不做多余的工作），应该是做不到跨平台传输的。但是如果自己通过开发Wi-Fi以及蓝牙，应该是可以实现跨平台传输的。至于开发的难点以及技术点，我也不清楚。\n\n## 其他参考\n[The Sorry State of Peer to Peer iOS to Android connectivity](http://blog.moritzhaarmann.de/blog/2014/04/27/sorry-state-of-p2p/)\n[Peer to peer android and iOS with Wifi direct (multipeer connectivity?)](http://stackoverflow.com/questions/28906948/peer-to-peer-android-and-ios-with-wifi-direct-multipeer-connectivity)\n[Is iOS 7 Multipeer Connectivity compatible with Android Wi-Fi Direct?](http://stackoverflow.com/questions/19067794/is-ios-7-multipeer-connectivity-compatible-with-android-wi-fi-direct)\n[9 of the best apps for sharing files between devices and friends](http://thenextweb.com/apps/2015/07/10/9-of-the-best-apps-for-sharing-files-between-devices-and-friends/)\n","source":"_posts/cross-platform.md","raw":"---\ntitle: Android-iOS 跨平台传输方案调研\ndate: 2016-10-28 16:21:48\ntags:\n - 直播\n---\n\n## 现状\n1. iOS：在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipeer Connectivity框架，即使在没有连接到WiFi（WLAN）或移动网络（xG）的情况下，距离较近的Apple设备（iMac/iPad/iPhone）之间可基于蓝牙和WiFi（P2P WiFi）技术进行发现和连接实现近场通信。\n2. Android：Wi-Fi peer-to-peer（P2P，对等网络），它允许具备相应硬件的Android 4.0（API level 14）或者更高版本的设备可以直接通过wifi而不需要其它中间中转节点就能直接通信（Android的Wi-Fi P2P框架符合Wi-Fi联盟的Wi-Fi Direct™直连认证标志）。使用这些API，你可以搜索并连接其它同样支持Wi-Fi P2P的设备，然后再通过一个高速的连接进行互相通信，并且这个连接的有效距离要比蓝牙连接的有效距离要长的多。这对于需要在用户之间共享数据的应用程序非常有用，例如多玩家游戏或者照片分享之类应用。\n\n<!-- more -->\n\n但是iOS的MC框架与Android的Wifi Direct不兼容，通过苹果开发者论坛[iOS and Wi-Fi Direct](https://forums.developer.apple.com/message/49337#49337)了解：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video7.png)\n关于不同技术在iOS、Android上的兼容性，如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video8.png)\n\n## 蓝牙\n1. 经典蓝牙阶段：在蓝牙4.0（Bluetooth Low Energy）之前，也就是所谓的经典蓝牙，苹果的蓝牙拒绝接入不信任的设备。也就是说，没得连。\n2. 蓝牙4.0阶段：从ios6.0开始，iPhone支持BLe以后，问题得到了改善，因为在蓝牙4.0以后不再存在经典蓝牙的那个限制。ios7.0以后，BLe在 iOS 7 技术性提升里占到的重要位置。但是Android在这方面的脚步就慢很多了。\n - Android4.3：SDK从4.3以后开始正式在官方层面支持蓝牙4.0，可以使用安卓设备建立主机。注意，这里是说可以建立主机，也就是只能是安卓建立主机，iOS设备连接才可以。安卓无法去连接iOS的主机。\n - Android L：也就是Android 5.0，从这个版本开始，谷歌正式支持主从机的建立。\n\n[Android与IOS之间如何实现蓝牙通信数据传输？](https://www.zhihu.com/question/23246210)\n\n## 现有产品\n1. [快牙](http://www.kuaiya.cn/)\n> 快牙（ZAPYA），是一款全球首创、实现跨平台文件传输的应用，能帮助智能手机用户之间实现高速海量数据传输。支持安卓（Android）、苹果（iOS）、WP、PC等多种智能终端间的互联互通。通过快牙，可以和任何人分享应用、照片、视频、音乐及其他任意格式文件。目前快牙全球用户数量已超3亿，遍及海内外178个国家和地区，在同类型的传输应用中稳居第一。\n\n2. [茄子快传](https://www.ushareit.com/)\n> 茄子快传是北京众联极享科技有限公司推出的一款跨平台、多场景的移动数字互动平台（手机内容传输工具）。通过设备间建立的数据传输通路，茄子快传实现了在没有外部WiFi网络或者数据网络的情况下的数据高速收发，过程中无需消耗数据流量。用户操作简单，没有复杂的配对配置，无需登录账户、添加好友，支持多人互传，让用户摆脱数据线、蓝牙等复杂的分享方式，用一种简单、直观的交互让用户体验到近距离线下社交中与人分享的快乐。\n\n通过以上2款产品，可以实现跨平台数据传输。\n\n我利用2台Android手机测试，都是需要创建``热点``进行传输。Android与iOS测试，也是需要开启``热点``的，并且在iOS下需要手动链接到对应的热点。\n\n## 第三方\n1. [AllJoyn](https://allseenalliance.org/)\n> AllJoyn，由高通公司主导的高通创新中心（Qualcomm Innovation Center）所开发的开放源代码专案，主要用于近距离无线传输，透过Wifi或蓝牙技术，进行定位与点对点档案传输。\n\n2. [FireChat](http://www.opengarden.com/)\n> FireChat，是一个专门用于手机的APP，由开放花园公司开发。它能使智能手机在没有网络存取时，经由无线网状网络的蓝牙、Wi-Fi，或苹果公司的多点连线（Multipeer Connectivity）对等网络架构连线。\n\n3. [Underdark](http://underdark.io/)\n> Mobile peer-to-peer mesh networking library.Integrates into iOS and Android apps and works over Wi-Fi and Bluetooth.\n\n目前只是知道这些三方库，至于其内部的实现原理还不了解，但应该是结合Wi-Fi与蓝牙来实现的。\n\n## 小结\n通过目前已有的技术（不做多余的工作），应该是做不到跨平台传输的。但是如果自己通过开发Wi-Fi以及蓝牙，应该是可以实现跨平台传输的。至于开发的难点以及技术点，我也不清楚。\n\n## 其他参考\n[The Sorry State of Peer to Peer iOS to Android connectivity](http://blog.moritzhaarmann.de/blog/2014/04/27/sorry-state-of-p2p/)\n[Peer to peer android and iOS with Wifi direct (multipeer connectivity?)](http://stackoverflow.com/questions/28906948/peer-to-peer-android-and-ios-with-wifi-direct-multipeer-connectivity)\n[Is iOS 7 Multipeer Connectivity compatible with Android Wi-Fi Direct?](http://stackoverflow.com/questions/19067794/is-ios-7-multipeer-connectivity-compatible-with-android-wi-fi-direct)\n[9 of the best apps for sharing files between devices and friends](http://thenextweb.com/apps/2015/07/10/9-of-the-best-apps-for-sharing-files-between-devices-and-friends/)\n","slug":"cross-platform","published":1,"updated":"2016-11-21T10:00:46.907Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758e000l1cb8etqgaq2y","content":"<h2 id=\"现状\"><a href=\"#现状\" class=\"headerlink\" title=\"现状\"></a>现状</h2><ol>\n<li>iOS：在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipeer Connectivity框架，即使在没有连接到WiFi（WLAN）或移动网络（xG）的情况下，距离较近的Apple设备（iMac/iPad/iPhone）之间可基于蓝牙和WiFi（P2P WiFi）技术进行发现和连接实现近场通信。</li>\n<li>Android：Wi-Fi peer-to-peer（P2P，对等网络），它允许具备相应硬件的Android 4.0（API level 14）或者更高版本的设备可以直接通过wifi而不需要其它中间中转节点就能直接通信（Android的Wi-Fi P2P框架符合Wi-Fi联盟的Wi-Fi Direct™直连认证标志）。使用这些API，你可以搜索并连接其它同样支持Wi-Fi P2P的设备，然后再通过一个高速的连接进行互相通信，并且这个连接的有效距离要比蓝牙连接的有效距离要长的多。这对于需要在用户之间共享数据的应用程序非常有用，例如多玩家游戏或者照片分享之类应用。</li>\n</ol>\n<a id=\"more\"></a>\n<p>但是iOS的MC框架与Android的Wifi Direct不兼容，通过苹果开发者论坛<a href=\"https://forums.developer.apple.com/message/49337#49337\" target=\"_blank\" rel=\"external\">iOS and Wi-Fi Direct</a>了解：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video7.png\" alt=\"\"><br>关于不同技术在iOS、Android上的兼容性，如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video8.png\" alt=\"\"></p>\n<h2 id=\"蓝牙\"><a href=\"#蓝牙\" class=\"headerlink\" title=\"蓝牙\"></a>蓝牙</h2><ol>\n<li>经典蓝牙阶段：在蓝牙4.0（Bluetooth Low Energy）之前，也就是所谓的经典蓝牙，苹果的蓝牙拒绝接入不信任的设备。也就是说，没得连。</li>\n<li>蓝牙4.0阶段：从ios6.0开始，iPhone支持BLe以后，问题得到了改善，因为在蓝牙4.0以后不再存在经典蓝牙的那个限制。ios7.0以后，BLe在 iOS 7 技术性提升里占到的重要位置。但是Android在这方面的脚步就慢很多了。<ul>\n<li>Android4.3：SDK从4.3以后开始正式在官方层面支持蓝牙4.0，可以使用安卓设备建立主机。注意，这里是说可以建立主机，也就是只能是安卓建立主机，iOS设备连接才可以。安卓无法去连接iOS的主机。</li>\n<li>Android L：也就是Android 5.0，从这个版本开始，谷歌正式支持主从机的建立。</li>\n</ul>\n</li>\n</ol>\n<p><a href=\"https://www.zhihu.com/question/23246210\" target=\"_blank\" rel=\"external\">Android与IOS之间如何实现蓝牙通信数据传输？</a></p>\n<h2 id=\"现有产品\"><a href=\"#现有产品\" class=\"headerlink\" title=\"现有产品\"></a>现有产品</h2><ol>\n<li><p><a href=\"http://www.kuaiya.cn/\" target=\"_blank\" rel=\"external\">快牙</a></p>\n<blockquote>\n<p>快牙（ZAPYA），是一款全球首创、实现跨平台文件传输的应用，能帮助智能手机用户之间实现高速海量数据传输。支持安卓（Android）、苹果（iOS）、WP、PC等多种智能终端间的互联互通。通过快牙，可以和任何人分享应用、照片、视频、音乐及其他任意格式文件。目前快牙全球用户数量已超3亿，遍及海内外178个国家和地区，在同类型的传输应用中稳居第一。</p>\n</blockquote>\n</li>\n<li><p><a href=\"https://www.ushareit.com/\" target=\"_blank\" rel=\"external\">茄子快传</a></p>\n<blockquote>\n<p>茄子快传是北京众联极享科技有限公司推出的一款跨平台、多场景的移动数字互动平台（手机内容传输工具）。通过设备间建立的数据传输通路，茄子快传实现了在没有外部WiFi网络或者数据网络的情况下的数据高速收发，过程中无需消耗数据流量。用户操作简单，没有复杂的配对配置，无需登录账户、添加好友，支持多人互传，让用户摆脱数据线、蓝牙等复杂的分享方式，用一种简单、直观的交互让用户体验到近距离线下社交中与人分享的快乐。</p>\n</blockquote>\n</li>\n</ol>\n<p>通过以上2款产品，可以实现跨平台数据传输。</p>\n<p>我利用2台Android手机测试，都是需要创建<code>热点</code>进行传输。Android与iOS测试，也是需要开启<code>热点</code>的，并且在iOS下需要手动链接到对应的热点。</p>\n<h2 id=\"第三方\"><a href=\"#第三方\" class=\"headerlink\" title=\"第三方\"></a>第三方</h2><ol>\n<li><p><a href=\"https://allseenalliance.org/\" target=\"_blank\" rel=\"external\">AllJoyn</a></p>\n<blockquote>\n<p>AllJoyn，由高通公司主导的高通创新中心（Qualcomm Innovation Center）所开发的开放源代码专案，主要用于近距离无线传输，透过Wifi或蓝牙技术，进行定位与点对点档案传输。</p>\n</blockquote>\n</li>\n<li><p><a href=\"http://www.opengarden.com/\" target=\"_blank\" rel=\"external\">FireChat</a></p>\n<blockquote>\n<p>FireChat，是一个专门用于手机的APP，由开放花园公司开发。它能使智能手机在没有网络存取时，经由无线网状网络的蓝牙、Wi-Fi，或苹果公司的多点连线（Multipeer Connectivity）对等网络架构连线。</p>\n</blockquote>\n</li>\n<li><p><a href=\"http://underdark.io/\" target=\"_blank\" rel=\"external\">Underdark</a></p>\n<blockquote>\n<p>Mobile peer-to-peer mesh networking library.Integrates into iOS and Android apps and works over Wi-Fi and Bluetooth.</p>\n</blockquote>\n</li>\n</ol>\n<p>目前只是知道这些三方库，至于其内部的实现原理还不了解，但应该是结合Wi-Fi与蓝牙来实现的。</p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><p>通过目前已有的技术（不做多余的工作），应该是做不到跨平台传输的。但是如果自己通过开发Wi-Fi以及蓝牙，应该是可以实现跨平台传输的。至于开发的难点以及技术点，我也不清楚。</p>\n<h2 id=\"其他参考\"><a href=\"#其他参考\" class=\"headerlink\" title=\"其他参考\"></a>其他参考</h2><p><a href=\"http://blog.moritzhaarmann.de/blog/2014/04/27/sorry-state-of-p2p/\" target=\"_blank\" rel=\"external\">The Sorry State of Peer to Peer iOS to Android connectivity</a><br><a href=\"http://stackoverflow.com/questions/28906948/peer-to-peer-android-and-ios-with-wifi-direct-multipeer-connectivity\" target=\"_blank\" rel=\"external\">Peer to peer android and iOS with Wifi direct (multipeer connectivity?)</a><br><a href=\"http://stackoverflow.com/questions/19067794/is-ios-7-multipeer-connectivity-compatible-with-android-wi-fi-direct\" target=\"_blank\" rel=\"external\">Is iOS 7 Multipeer Connectivity compatible with Android Wi-Fi Direct?</a><br><a href=\"http://thenextweb.com/apps/2015/07/10/9-of-the-best-apps-for-sharing-files-between-devices-and-friends/\" target=\"_blank\" rel=\"external\">9 of the best apps for sharing files between devices and friends</a></p>\n","excerpt":"<h2 id=\"现状\"><a href=\"#现状\" class=\"headerlink\" title=\"现状\"></a>现状</h2><ol>\n<li>iOS：在iOS7中，引入了一个全新的框架——Multipeer Connectivity（多点连接）。利用Multipeer Connectivity框架，即使在没有连接到WiFi（WLAN）或移动网络（xG）的情况下，距离较近的Apple设备（iMac/iPad/iPhone）之间可基于蓝牙和WiFi（P2P WiFi）技术进行发现和连接实现近场通信。</li>\n<li>Android：Wi-Fi peer-to-peer（P2P，对等网络），它允许具备相应硬件的Android 4.0（API level 14）或者更高版本的设备可以直接通过wifi而不需要其它中间中转节点就能直接通信（Android的Wi-Fi P2P框架符合Wi-Fi联盟的Wi-Fi Direct™直连认证标志）。使用这些API，你可以搜索并连接其它同样支持Wi-Fi P2P的设备，然后再通过一个高速的连接进行互相通信，并且这个连接的有效距离要比蓝牙连接的有效距离要长的多。这对于需要在用户之间共享数据的应用程序非常有用，例如多玩家游戏或者照片分享之类应用。</li>\n</ol>","more":"<p>但是iOS的MC框架与Android的Wifi Direct不兼容，通过苹果开发者论坛<a href=\"https://forums.developer.apple.com/message/49337#49337\">iOS and Wi-Fi Direct</a>了解：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video7.png\" alt=\"\"><br>关于不同技术在iOS、Android上的兼容性，如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video8.png\" alt=\"\"></p>\n<h2 id=\"蓝牙\"><a href=\"#蓝牙\" class=\"headerlink\" title=\"蓝牙\"></a>蓝牙</h2><ol>\n<li>经典蓝牙阶段：在蓝牙4.0（Bluetooth Low Energy）之前，也就是所谓的经典蓝牙，苹果的蓝牙拒绝接入不信任的设备。也就是说，没得连。</li>\n<li>蓝牙4.0阶段：从ios6.0开始，iPhone支持BLe以后，问题得到了改善，因为在蓝牙4.0以后不再存在经典蓝牙的那个限制。ios7.0以后，BLe在 iOS 7 技术性提升里占到的重要位置。但是Android在这方面的脚步就慢很多了。<ul>\n<li>Android4.3：SDK从4.3以后开始正式在官方层面支持蓝牙4.0，可以使用安卓设备建立主机。注意，这里是说可以建立主机，也就是只能是安卓建立主机，iOS设备连接才可以。安卓无法去连接iOS的主机。</li>\n<li>Android L：也就是Android 5.0，从这个版本开始，谷歌正式支持主从机的建立。</li>\n</ul>\n</li>\n</ol>\n<p><a href=\"https://www.zhihu.com/question/23246210\">Android与IOS之间如何实现蓝牙通信数据传输？</a></p>\n<h2 id=\"现有产品\"><a href=\"#现有产品\" class=\"headerlink\" title=\"现有产品\"></a>现有产品</h2><ol>\n<li><p><a href=\"http://www.kuaiya.cn/\">快牙</a></p>\n<blockquote>\n<p>快牙（ZAPYA），是一款全球首创、实现跨平台文件传输的应用，能帮助智能手机用户之间实现高速海量数据传输。支持安卓（Android）、苹果（iOS）、WP、PC等多种智能终端间的互联互通。通过快牙，可以和任何人分享应用、照片、视频、音乐及其他任意格式文件。目前快牙全球用户数量已超3亿，遍及海内外178个国家和地区，在同类型的传输应用中稳居第一。</p>\n</blockquote>\n</li>\n<li><p><a href=\"https://www.ushareit.com/\">茄子快传</a></p>\n<blockquote>\n<p>茄子快传是北京众联极享科技有限公司推出的一款跨平台、多场景的移动数字互动平台（手机内容传输工具）。通过设备间建立的数据传输通路，茄子快传实现了在没有外部WiFi网络或者数据网络的情况下的数据高速收发，过程中无需消耗数据流量。用户操作简单，没有复杂的配对配置，无需登录账户、添加好友，支持多人互传，让用户摆脱数据线、蓝牙等复杂的分享方式，用一种简单、直观的交互让用户体验到近距离线下社交中与人分享的快乐。</p>\n</blockquote>\n</li>\n</ol>\n<p>通过以上2款产品，可以实现跨平台数据传输。</p>\n<p>我利用2台Android手机测试，都是需要创建<code>热点</code>进行传输。Android与iOS测试，也是需要开启<code>热点</code>的，并且在iOS下需要手动链接到对应的热点。</p>\n<h2 id=\"第三方\"><a href=\"#第三方\" class=\"headerlink\" title=\"第三方\"></a>第三方</h2><ol>\n<li><p><a href=\"https://allseenalliance.org/\">AllJoyn</a></p>\n<blockquote>\n<p>AllJoyn，由高通公司主导的高通创新中心（Qualcomm Innovation Center）所开发的开放源代码专案，主要用于近距离无线传输，透过Wifi或蓝牙技术，进行定位与点对点档案传输。</p>\n</blockquote>\n</li>\n<li><p><a href=\"http://www.opengarden.com/\">FireChat</a></p>\n<blockquote>\n<p>FireChat，是一个专门用于手机的APP，由开放花园公司开发。它能使智能手机在没有网络存取时，经由无线网状网络的蓝牙、Wi-Fi，或苹果公司的多点连线（Multipeer Connectivity）对等网络架构连线。</p>\n</blockquote>\n</li>\n<li><p><a href=\"http://underdark.io/\">Underdark</a></p>\n<blockquote>\n<p>Mobile peer-to-peer mesh networking library.Integrates into iOS and Android apps and works over Wi-Fi and Bluetooth.</p>\n</blockquote>\n</li>\n</ol>\n<p>目前只是知道这些三方库，至于其内部的实现原理还不了解，但应该是结合Wi-Fi与蓝牙来实现的。</p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><p>通过目前已有的技术（不做多余的工作），应该是做不到跨平台传输的。但是如果自己通过开发Wi-Fi以及蓝牙，应该是可以实现跨平台传输的。至于开发的难点以及技术点，我也不清楚。</p>\n<h2 id=\"其他参考\"><a href=\"#其他参考\" class=\"headerlink\" title=\"其他参考\"></a>其他参考</h2><p><a href=\"http://blog.moritzhaarmann.de/blog/2014/04/27/sorry-state-of-p2p/\">The Sorry State of Peer to Peer iOS to Android connectivity</a><br><a href=\"http://stackoverflow.com/questions/28906948/peer-to-peer-android-and-ios-with-wifi-direct-multipeer-connectivity\">Peer to peer android and iOS with Wifi direct (multipeer connectivity?)</a><br><a href=\"http://stackoverflow.com/questions/19067794/is-ios-7-multipeer-connectivity-compatible-with-android-wi-fi-direct\">Is iOS 7 Multipeer Connectivity compatible with Android Wi-Fi Direct?</a><br><a href=\"http://thenextweb.com/apps/2015/07/10/9-of-the-best-apps-for-sharing-files-between-devices-and-friends/\">9 of the best apps for sharing files between devices and friends</a></p>"},{"title":"Android自定义属性","date":"2016-05-10T07:42:43.000Z","_content":"\n## 前言\n项目中对于图片的长宽比有很严格的需求，如果比例不一致，那么在App上显示会影响体验，于是要求长宽比一致。但是比例并不是固定的，有的图需要1:1比例，有的图需要14:9比例，有的图又需要9:16的比例。\n\n起初我的想法是，自定义View在onMeasure里利用比例，将计算后的宽高设置给View就好了。但是这么一想，比例不一致啊。现在需要3种比例，我要自定义3个View，那如果后面有其他的一些比例呢？我不是又得写啦~\n\n抱着偷懒的态度，我设想用自定义属性来解决这个问题，自己设置比例，这样只用自定义一个View，然后根据传入的比例再行计算即可。\n\n<!-- more -->\n\n## 自定义属性\n### 添加属性\n在``res/value``文件夹下定义一个``attr.xml``文件，添加如下代码：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>  \n<resources>  \n    <declare-styleable name=\"CertainScaleImageView\">  \n        <attr name=\"radio\" format=\"float\" />  \n    </declare-styleable>  \n</resources>\n```\nradio即是代表比例，这里是高比宽。我是先获取宽，然后根据比例计算高。\n\n### 设置属性\n在xml顶层布局中添加``xmlns:app=\"http://schemas.android.com/apk/res-auto\"``，然后利用``app:radio``设置属性，示例代码如下：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\">\n\n    <FrameLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:layout_marginBottom=\"8dp\"\n        android:background=\"#ffffff\"\n        android:focusable=\"true\"\n        android:focusableInTouchMode=\"true\">\n\n        <com.miamusic.android.live.ui.widget.CertainScaleImageView\n            android:id=\"@+id/anchor_profile_background\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\"\n            android:scaleType=\"centerCrop\"\n            android:transitionName=\"cover\"\n            app:radio=\"1.779\" />\n\n...\n```\n这里我设置的1.779，即高是宽的1.779倍，显示一个瘦窄的长方形。\n\n### 获取属性\n在自定义View中通过如下代码获取``radio``属性：\n```\npublic CertainScaleImageView(Context context, AttributeSet attrs) {\n    super(context, attrs);\n    TypedArray typedArray = context.obtainStyledAttributes(attrs, R.styleable.CertainScaleImageView);\n    radio = typedArray.getFloat(R.styleable.CertainScaleImageView_radio, 1f);\n    typedArray.recycle();\n}\n```\nradio自定义View的一个属性，通过TypedArray获取相应的值并保存起来，TypedArray用完需要调用``recycle()``。\n\n### 计算宽高\n获取属性之后，我们需要通过这个比例来计算宽高，代码如下：\n```\n@Override\nprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n    int width = MeasureSpec.getSize(widthMeasureSpec);\n    int widthSpec = MeasureSpec.makeMeasureSpec(width, MeasureSpec.EXACTLY);\n    int heightSpec = MeasureSpec.makeMeasureSpec((int) (width * radio), MeasureSpec.EXACTLY);\n    setMeasuredDimension(widthSpec, heightSpec);\n}\n```\n获得宽度值，然后根据radio计算高度，然后调用``setMeasuredDimension``即可。\n\n## 总结\n通过onMeasure，我们可以自行控制View要显示的区域。\n在调用``setMeasuredDimension``时，我们不仅需要计算它确切的高宽，还要给他设置一个``MODE``。\n``MODE``有三类：\n1. MeasureSpec.EXACTLY：精确尺寸，当我们将控件的layout_width或layout_height指定为具体数值时如andorid:layout_width=\"50dp\"，或者为match_parent是，都是控件大小已经确定的情况，都是精确尺寸。\n2. MeasureSpec.AT_MOST：最大尺寸，当控件的layout_width或layout_height指定为wrap_content时，控件大小一般随着控件的子空间或内容进行变化，此时控件尺寸只要不超过父控件允许的最大尺寸即可。因此，此时的mode是AT_MOST，size给出了父控件允许的最大尺寸。\n3. MeasureSpec.UNSPECIFIED：未指定尺寸，这种情况不多，一般都是父控件是AdapterView，通过measure方法传入的模式。\n","source":"_posts/custom-attr.md","raw":"---\ntitle: Android自定义属性\ndate: 2016-05-10 15:42:43\ntags:\n - 日常开发\n---\n\n## 前言\n项目中对于图片的长宽比有很严格的需求，如果比例不一致，那么在App上显示会影响体验，于是要求长宽比一致。但是比例并不是固定的，有的图需要1:1比例，有的图需要14:9比例，有的图又需要9:16的比例。\n\n起初我的想法是，自定义View在onMeasure里利用比例，将计算后的宽高设置给View就好了。但是这么一想，比例不一致啊。现在需要3种比例，我要自定义3个View，那如果后面有其他的一些比例呢？我不是又得写啦~\n\n抱着偷懒的态度，我设想用自定义属性来解决这个问题，自己设置比例，这样只用自定义一个View，然后根据传入的比例再行计算即可。\n\n<!-- more -->\n\n## 自定义属性\n### 添加属性\n在``res/value``文件夹下定义一个``attr.xml``文件，添加如下代码：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>  \n<resources>  \n    <declare-styleable name=\"CertainScaleImageView\">  \n        <attr name=\"radio\" format=\"float\" />  \n    </declare-styleable>  \n</resources>\n```\nradio即是代表比例，这里是高比宽。我是先获取宽，然后根据比例计算高。\n\n### 设置属性\n在xml顶层布局中添加``xmlns:app=\"http://schemas.android.com/apk/res-auto\"``，然后利用``app:radio``设置属性，示例代码如下：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\">\n\n    <FrameLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:layout_marginBottom=\"8dp\"\n        android:background=\"#ffffff\"\n        android:focusable=\"true\"\n        android:focusableInTouchMode=\"true\">\n\n        <com.miamusic.android.live.ui.widget.CertainScaleImageView\n            android:id=\"@+id/anchor_profile_background\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\"\n            android:scaleType=\"centerCrop\"\n            android:transitionName=\"cover\"\n            app:radio=\"1.779\" />\n\n...\n```\n这里我设置的1.779，即高是宽的1.779倍，显示一个瘦窄的长方形。\n\n### 获取属性\n在自定义View中通过如下代码获取``radio``属性：\n```\npublic CertainScaleImageView(Context context, AttributeSet attrs) {\n    super(context, attrs);\n    TypedArray typedArray = context.obtainStyledAttributes(attrs, R.styleable.CertainScaleImageView);\n    radio = typedArray.getFloat(R.styleable.CertainScaleImageView_radio, 1f);\n    typedArray.recycle();\n}\n```\nradio自定义View的一个属性，通过TypedArray获取相应的值并保存起来，TypedArray用完需要调用``recycle()``。\n\n### 计算宽高\n获取属性之后，我们需要通过这个比例来计算宽高，代码如下：\n```\n@Override\nprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n    int width = MeasureSpec.getSize(widthMeasureSpec);\n    int widthSpec = MeasureSpec.makeMeasureSpec(width, MeasureSpec.EXACTLY);\n    int heightSpec = MeasureSpec.makeMeasureSpec((int) (width * radio), MeasureSpec.EXACTLY);\n    setMeasuredDimension(widthSpec, heightSpec);\n}\n```\n获得宽度值，然后根据radio计算高度，然后调用``setMeasuredDimension``即可。\n\n## 总结\n通过onMeasure，我们可以自行控制View要显示的区域。\n在调用``setMeasuredDimension``时，我们不仅需要计算它确切的高宽，还要给他设置一个``MODE``。\n``MODE``有三类：\n1. MeasureSpec.EXACTLY：精确尺寸，当我们将控件的layout_width或layout_height指定为具体数值时如andorid:layout_width=\"50dp\"，或者为match_parent是，都是控件大小已经确定的情况，都是精确尺寸。\n2. MeasureSpec.AT_MOST：最大尺寸，当控件的layout_width或layout_height指定为wrap_content时，控件大小一般随着控件的子空间或内容进行变化，此时控件尺寸只要不超过父控件允许的最大尺寸即可。因此，此时的mode是AT_MOST，size给出了父控件允许的最大尺寸。\n3. MeasureSpec.UNSPECIFIED：未指定尺寸，这种情况不多，一般都是父控件是AdapterView，通过measure方法传入的模式。\n","slug":"custom-attr","published":1,"updated":"2016-11-21T09:59:06.901Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758g000o1cb8kd69xhyg","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>项目中对于图片的长宽比有很严格的需求，如果比例不一致，那么在App上显示会影响体验，于是要求长宽比一致。但是比例并不是固定的，有的图需要1:1比例，有的图需要14:9比例，有的图又需要9:16的比例。</p>\n<p>起初我的想法是，自定义View在onMeasure里利用比例，将计算后的宽高设置给View就好了。但是这么一想，比例不一致啊。现在需要3种比例，我要自定义3个View，那如果后面有其他的一些比例呢？我不是又得写啦~</p>\n<p>抱着偷懒的态度，我设想用自定义属性来解决这个问题，自己设置比例，这样只用自定义一个View，然后根据传入的比例再行计算即可。</p>\n<a id=\"more\"></a>\n<h2 id=\"自定义属性\"><a href=\"#自定义属性\" class=\"headerlink\" title=\"自定义属性\"></a>自定义属性</h2><h3 id=\"添加属性\"><a href=\"#添加属性\" class=\"headerlink\" title=\"添加属性\"></a>添加属性</h3><p>在<code>res/value</code>文件夹下定义一个<code>attr.xml</code>文件，添加如下代码：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span>  </div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span>  </div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">declare-styleable</span> <span class=\"attr\">name</span>=<span class=\"string\">\"CertainScaleImageView\"</span>&gt;</span>  </div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"radio\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"float\"</span> /&gt;</span>  </div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">declare-styleable</span>&gt;</span>  </div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>radio即是代表比例，这里是高比宽。我是先获取宽，然后根据比例计算高。</p>\n<h3 id=\"设置属性\"><a href=\"#设置属性\" class=\"headerlink\" title=\"设置属性\"></a>设置属性</h3><p>在xml顶层布局中添加<code>xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;</code>，然后利用<code>app:radio</code>设置属性，示例代码如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginBottom</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:background</span>=<span class=\"string\">\"#ffffff\"</span></div><div class=\"line\">        <span class=\"attr\">android:focusable</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">        <span class=\"attr\">android:focusableInTouchMode</span>=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">com.miamusic.android.live.ui.widget.CertainScaleImageView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/anchor_profile_background\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">            <span class=\"attr\">android:transitionName</span>=<span class=\"string\">\"cover\"</span></div><div class=\"line\">            <span class=\"attr\">app:radio</span>=<span class=\"string\">\"1.779\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">...</div></pre></td></tr></table></figure></p>\n<p>这里我设置的1.779，即高是宽的1.779倍，显示一个瘦窄的长方形。</p>\n<h3 id=\"获取属性\"><a href=\"#获取属性\" class=\"headerlink\" title=\"获取属性\"></a>获取属性</h3><p>在自定义View中通过如下代码获取<code>radio</code>属性：<br><figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"title\">public</span> <span class=\"type\">CertainScaleImageView</span>(<span class=\"type\">Context</span> context, <span class=\"type\">AttributeSet</span> attrs) &#123;</div><div class=\"line\">    super(context, attrs);</div><div class=\"line\">    <span class=\"type\">TypedArray</span> typedArray = context.obtainStyledAttributes(attrs, <span class=\"type\">R</span>.styleable.<span class=\"type\">CertainScaleImageView</span>);</div><div class=\"line\">    radio = typedArray.getFloat(<span class=\"type\">R</span>.styleable.<span class=\"type\">CertainScaleImageView_radio</span>, 1f);</div><div class=\"line\">    typedArray.recycle();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>radio自定义View的一个属性，通过TypedArray获取相应的值并保存起来，TypedArray用完需要调用<code>recycle()</code>。</p>\n<h3 id=\"计算宽高\"><a href=\"#计算宽高\" class=\"headerlink\" title=\"计算宽高\"></a>计算宽高</h3><p>获取属性之后，我们需要通过这个比例来计算宽高，代码如下：<br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">@Override</div><div class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onMeasure(<span class=\"keyword\">int</span> widthMeasureSpec, <span class=\"keyword\">int</span> heightMeasureSpec) &#123;</div><div class=\"line\">    <span class=\"keyword\">int</span> <span class=\"built_in\">width</span> = MeasureSpec.getSize(widthMeasureSpec);</div><div class=\"line\">    <span class=\"keyword\">int</span> widthSpec = MeasureSpec.makeMeasureSpec(<span class=\"built_in\">width</span>, MeasureSpec.EXACTLY);</div><div class=\"line\">    <span class=\"keyword\">int</span> heightSpec = MeasureSpec.makeMeasureSpec((<span class=\"keyword\">int</span>) (<span class=\"built_in\">width</span> * radio), MeasureSpec.EXACTLY);</div><div class=\"line\">    setMeasuredDimension(widthSpec, heightSpec);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>获得宽度值，然后根据radio计算高度，然后调用<code>setMeasuredDimension</code>即可。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过onMeasure，我们可以自行控制View要显示的区域。<br>在调用<code>setMeasuredDimension</code>时，我们不仅需要计算它确切的高宽，还要给他设置一个<code>MODE</code>。<br><code>MODE</code>有三类：</p>\n<ol>\n<li>MeasureSpec.EXACTLY：精确尺寸，当我们将控件的layout_width或layout_height指定为具体数值时如andorid:layout_width=”50dp”，或者为match_parent是，都是控件大小已经确定的情况，都是精确尺寸。</li>\n<li>MeasureSpec.AT_MOST：最大尺寸，当控件的layout_width或layout_height指定为wrap_content时，控件大小一般随着控件的子空间或内容进行变化，此时控件尺寸只要不超过父控件允许的最大尺寸即可。因此，此时的mode是AT_MOST，size给出了父控件允许的最大尺寸。</li>\n<li>MeasureSpec.UNSPECIFIED：未指定尺寸，这种情况不多，一般都是父控件是AdapterView，通过measure方法传入的模式。</li>\n</ol>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>项目中对于图片的长宽比有很严格的需求，如果比例不一致，那么在App上显示会影响体验，于是要求长宽比一致。但是比例并不是固定的，有的图需要1:1比例，有的图需要14:9比例，有的图又需要9:16的比例。</p>\n<p>起初我的想法是，自定义View在onMeasure里利用比例，将计算后的宽高设置给View就好了。但是这么一想，比例不一致啊。现在需要3种比例，我要自定义3个View，那如果后面有其他的一些比例呢？我不是又得写啦~</p>\n<p>抱着偷懒的态度，我设想用自定义属性来解决这个问题，自己设置比例，这样只用自定义一个View，然后根据传入的比例再行计算即可。</p>","more":"<h2 id=\"自定义属性\"><a href=\"#自定义属性\" class=\"headerlink\" title=\"自定义属性\"></a>自定义属性</h2><h3 id=\"添加属性\"><a href=\"#添加属性\" class=\"headerlink\" title=\"添加属性\"></a>添加属性</h3><p>在<code>res/value</code>文件夹下定义一个<code>attr.xml</code>文件，添加如下代码：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span>  </div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span>  </div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">declare-styleable</span> <span class=\"attr\">name</span>=<span class=\"string\">\"CertainScaleImageView\"</span>&gt;</span>  </div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"radio\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"float\"</span> /&gt;</span>  </div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">declare-styleable</span>&gt;</span>  </div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>radio即是代表比例，这里是高比宽。我是先获取宽，然后根据比例计算高。</p>\n<h3 id=\"设置属性\"><a href=\"#设置属性\" class=\"headerlink\" title=\"设置属性\"></a>设置属性</h3><p>在xml顶层布局中添加<code>xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;</code>，然后利用<code>app:radio</code>设置属性，示例代码如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginBottom</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:background</span>=<span class=\"string\">\"#ffffff\"</span></div><div class=\"line\">        <span class=\"attr\">android:focusable</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">        <span class=\"attr\">android:focusableInTouchMode</span>=<span class=\"string\">\"true\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">com.miamusic.android.live.ui.widget.CertainScaleImageView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/anchor_profile_background\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">            <span class=\"attr\">android:transitionName</span>=<span class=\"string\">\"cover\"</span></div><div class=\"line\">            <span class=\"attr\">app:radio</span>=<span class=\"string\">\"1.779\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">...</div></pre></td></tr></table></figure></p>\n<p>这里我设置的1.779，即高是宽的1.779倍，显示一个瘦窄的长方形。</p>\n<h3 id=\"获取属性\"><a href=\"#获取属性\" class=\"headerlink\" title=\"获取属性\"></a>获取属性</h3><p>在自定义View中通过如下代码获取<code>radio</code>属性：<br><figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"title\">public</span> <span class=\"type\">CertainScaleImageView</span>(<span class=\"type\">Context</span> context, <span class=\"type\">AttributeSet</span> attrs) &#123;</div><div class=\"line\">    super(context, attrs);</div><div class=\"line\">    <span class=\"type\">TypedArray</span> typedArray = context.obtainStyledAttributes(attrs, <span class=\"type\">R</span>.styleable.<span class=\"type\">CertainScaleImageView</span>);</div><div class=\"line\">    radio = typedArray.getFloat(<span class=\"type\">R</span>.styleable.<span class=\"type\">CertainScaleImageView_radio</span>, 1f);</div><div class=\"line\">    typedArray.recycle();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>radio自定义View的一个属性，通过TypedArray获取相应的值并保存起来，TypedArray用完需要调用<code>recycle()</code>。</p>\n<h3 id=\"计算宽高\"><a href=\"#计算宽高\" class=\"headerlink\" title=\"计算宽高\"></a>计算宽高</h3><p>获取属性之后，我们需要通过这个比例来计算宽高，代码如下：<br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">@Override</div><div class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onMeasure(<span class=\"keyword\">int</span> widthMeasureSpec, <span class=\"keyword\">int</span> heightMeasureSpec) &#123;</div><div class=\"line\">    <span class=\"keyword\">int</span> <span class=\"built_in\">width</span> = MeasureSpec.getSize(widthMeasureSpec);</div><div class=\"line\">    <span class=\"keyword\">int</span> widthSpec = MeasureSpec.makeMeasureSpec(<span class=\"built_in\">width</span>, MeasureSpec.EXACTLY);</div><div class=\"line\">    <span class=\"keyword\">int</span> heightSpec = MeasureSpec.makeMeasureSpec((<span class=\"keyword\">int</span>) (<span class=\"built_in\">width</span> * radio), MeasureSpec.EXACTLY);</div><div class=\"line\">    setMeasuredDimension(widthSpec, heightSpec);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>获得宽度值，然后根据radio计算高度，然后调用<code>setMeasuredDimension</code>即可。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过onMeasure，我们可以自行控制View要显示的区域。<br>在调用<code>setMeasuredDimension</code>时，我们不仅需要计算它确切的高宽，还要给他设置一个<code>MODE</code>。<br><code>MODE</code>有三类：</p>\n<ol>\n<li>MeasureSpec.EXACTLY：精确尺寸，当我们将控件的layout_width或layout_height指定为具体数值时如andorid:layout_width=”50dp”，或者为match_parent是，都是控件大小已经确定的情况，都是精确尺寸。</li>\n<li>MeasureSpec.AT_MOST：最大尺寸，当控件的layout_width或layout_height指定为wrap_content时，控件大小一般随着控件的子空间或内容进行变化，此时控件尺寸只要不超过父控件允许的最大尺寸即可。因此，此时的mode是AT_MOST，size给出了父控件允许的最大尺寸。</li>\n<li>MeasureSpec.UNSPECIFIED：未指定尺寸，这种情况不多，一般都是父控件是AdapterView，通过measure方法传入的模式。</li>\n</ol>"},{"title":"Android DDMS无法输出logcat","date":"2015-10-24T08:00:11.000Z","_content":"\n### 问题\n在Android开发中，我们经常需要真机测试，查看log。有好几次碰到如下的情况：\n```\nUnable to open log device‘/dev/log/main’: No such file or directory\n```\n导致连上真机却看不到log。\n\n网上有很多解决方法，比如各种重启，重启手机，电脑，eclipse，adb，重新安装eclipse，拨号等。又或者[stackoverflow](http://stackoverflow.com/questions/4867971/dev-log-main-not-found)上说的与手机内核有关。但是对我的手机都不奏效，我的手机是华为3C，刷的MIUI的rom。\n\n### 原因\n后面折腾了老半天，终于找到了原因：\n\n >./system/etc/init.d目录下的脚本删掉了日志设备 </font>\n\n\n知道问题出在哪了，那么解决起来就很方便了。\n\n<!--more-->\n\n### 解决方法\n\n#### 找到删掉日志设备的脚本\n```\nadb shell\nsu\ncd /system/etc/init.d && grep -r \"rm /dev/log/main\"\n```\n找到该文件：03MTKTweakElse文件。\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat1.png)\n\n#### 修改脚本\n利用pull指令将该文件拷贝到电脑上。\n```\nabd pull /system/ect/init.d/03MTKTweakElse  L:\\\n```\n利用文本编辑工具（editplus、notepad++等）打开03MTKTweakElse文件，找到``rm    /dev/log/main``，然后注释掉该行。\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat2.png)\n\n#### 将文件替换到之前的路径中\n```\nadb push L:\\03MTKTweakElse  /system/etc/init.d\n```\n\n#### 重启手机\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat3.png)\n\n经过以上几个步骤，应该就可以输出logcat了。\n\n### Tips\n- 手机需要root。\n- adb pull、push指令可能会失败，建议可以使用R.E资源管理器。\n","source":"_posts/ddms-logcat.md","raw":"---\ntitle: Android DDMS无法输出logcat\ndate: 2015-10-24 16:00:11\ntags:\n - 日常开发\n---\n\n### 问题\n在Android开发中，我们经常需要真机测试，查看log。有好几次碰到如下的情况：\n```\nUnable to open log device‘/dev/log/main’: No such file or directory\n```\n导致连上真机却看不到log。\n\n网上有很多解决方法，比如各种重启，重启手机，电脑，eclipse，adb，重新安装eclipse，拨号等。又或者[stackoverflow](http://stackoverflow.com/questions/4867971/dev-log-main-not-found)上说的与手机内核有关。但是对我的手机都不奏效，我的手机是华为3C，刷的MIUI的rom。\n\n### 原因\n后面折腾了老半天，终于找到了原因：\n\n >./system/etc/init.d目录下的脚本删掉了日志设备 </font>\n\n\n知道问题出在哪了，那么解决起来就很方便了。\n\n<!--more-->\n\n### 解决方法\n\n#### 找到删掉日志设备的脚本\n```\nadb shell\nsu\ncd /system/etc/init.d && grep -r \"rm /dev/log/main\"\n```\n找到该文件：03MTKTweakElse文件。\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat1.png)\n\n#### 修改脚本\n利用pull指令将该文件拷贝到电脑上。\n```\nabd pull /system/ect/init.d/03MTKTweakElse  L:\\\n```\n利用文本编辑工具（editplus、notepad++等）打开03MTKTweakElse文件，找到``rm    /dev/log/main``，然后注释掉该行。\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat2.png)\n\n#### 将文件替换到之前的路径中\n```\nadb push L:\\03MTKTweakElse  /system/etc/init.d\n```\n\n#### 重启手机\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat3.png)\n\n经过以上几个步骤，应该就可以输出logcat了。\n\n### Tips\n- 手机需要root。\n- adb pull、push指令可能会失败，建议可以使用R.E资源管理器。\n","slug":"ddms-logcat","published":1,"updated":"2016-11-21T09:59:13.127Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758j000q1cb8b0k448qj","content":"<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><p>在Android开发中，我们经常需要真机测试，查看log。有好几次碰到如下的情况：<br><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Unable <span class=\"built_in\">to</span> <span class=\"built_in\">open</span> <span class=\"built_in\">log</span> device‘/dev/<span class=\"built_in\">log</span>/main’: No such <span class=\"built_in\">file</span> <span class=\"keyword\">or</span> <span class=\"built_in\">directory</span></div></pre></td></tr></table></figure></p>\n<p>导致连上真机却看不到log。</p>\n<p>网上有很多解决方法，比如各种重启，重启手机，电脑，eclipse，adb，重新安装eclipse，拨号等。又或者<a href=\"http://stackoverflow.com/questions/4867971/dev-log-main-not-found\" target=\"_blank\" rel=\"external\">stackoverflow</a>上说的与手机内核有关。但是对我的手机都不奏效，我的手机是华为3C，刷的MIUI的rom。</p>\n<h3 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h3><p>后面折腾了老半天，终于找到了原因：</p>\n<blockquote>\n<p>./system/etc/init.d目录下的脚本删掉了日志设备 </p>\n</blockquote>\n<p>知道问题出在哪了，那么解决起来就很方便了。</p>\n<a id=\"more\"></a>\n<h3 id=\"解决方法\"><a href=\"#解决方法\" class=\"headerlink\" title=\"解决方法\"></a>解决方法</h3><h4 id=\"找到删掉日志设备的脚本\"><a href=\"#找到删掉日志设备的脚本\" class=\"headerlink\" title=\"找到删掉日志设备的脚本\"></a>找到删掉日志设备的脚本</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">adb <span class=\"keyword\">shell</span></div><div class=\"line\">su</div><div class=\"line\"><span class=\"keyword\">cd</span> /<span class=\"built_in\">system</span>/etc/init.d &amp;&amp; <span class=\"keyword\">grep</span> -r <span class=\"string\">\"rm /dev/log/main\"</span></div></pre></td></tr></table></figure>\n<p>找到该文件：03MTKTweakElse文件。</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat1.png\" alt=\"这里写图片描述\"></p>\n<h4 id=\"修改脚本\"><a href=\"#修改脚本\" class=\"headerlink\" title=\"修改脚本\"></a>修改脚本</h4><p>利用pull指令将该文件拷贝到电脑上。<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">abd pull <span class=\"regexp\">/system/</span>ect<span class=\"regexp\">/init.d/</span><span class=\"number\">03</span>MTKTweakElse  <span class=\"string\">L:</span>\\</div></pre></td></tr></table></figure></p>\n<p>利用文本编辑工具（editplus、notepad++等）打开03MTKTweakElse文件，找到<code>rm    /dev/log/main</code>，然后注释掉该行。</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat2.png\" alt=\"这里写图片描述\"></p>\n<h4 id=\"将文件替换到之前的路径中\"><a href=\"#将文件替换到之前的路径中\" class=\"headerlink\" title=\"将文件替换到之前的路径中\"></a>将文件替换到之前的路径中</h4><figure class=\"highlight gauss\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">adb <span class=\"keyword\">push</span> L:\\<span class=\"number\">03</span>MTKTweakElse  /<span class=\"keyword\">system</span>/etc/init.d</div></pre></td></tr></table></figure>\n<h4 id=\"重启手机\"><a href=\"#重启手机\" class=\"headerlink\" title=\"重启手机\"></a>重启手机</h4><p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat3.png\" alt=\"这里写图片描述\"></p>\n<p>经过以上几个步骤，应该就可以输出logcat了。</p>\n<h3 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h3><ul>\n<li>手机需要root。</li>\n<li>adb pull、push指令可能会失败，建议可以使用R.E资源管理器。</li>\n</ul>\n","excerpt":"<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><p>在Android开发中，我们经常需要真机测试，查看log。有好几次碰到如下的情况：<br><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Unable <span class=\"built_in\">to</span> <span class=\"built_in\">open</span> <span class=\"built_in\">log</span> device‘/dev/<span class=\"built_in\">log</span>/main’: No such <span class=\"built_in\">file</span> <span class=\"keyword\">or</span> <span class=\"built_in\">directory</span></div></pre></td></tr></table></figure></p>\n<p>导致连上真机却看不到log。</p>\n<p>网上有很多解决方法，比如各种重启，重启手机，电脑，eclipse，adb，重新安装eclipse，拨号等。又或者<a href=\"http://stackoverflow.com/questions/4867971/dev-log-main-not-found\">stackoverflow</a>上说的与手机内核有关。但是对我的手机都不奏效，我的手机是华为3C，刷的MIUI的rom。</p>\n<h3 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h3><p>后面折腾了老半天，终于找到了原因：</p>\n<blockquote>\n<p>./system/etc/init.d目录下的脚本删掉了日志设备 </font></p>\n</blockquote>\n<p>知道问题出在哪了，那么解决起来就很方便了。</p>","more":"<h3 id=\"解决方法\"><a href=\"#解决方法\" class=\"headerlink\" title=\"解决方法\"></a>解决方法</h3><h4 id=\"找到删掉日志设备的脚本\"><a href=\"#找到删掉日志设备的脚本\" class=\"headerlink\" title=\"找到删掉日志设备的脚本\"></a>找到删掉日志设备的脚本</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">adb <span class=\"keyword\">shell</span></div><div class=\"line\">su</div><div class=\"line\"><span class=\"keyword\">cd</span> /<span class=\"built_in\">system</span>/etc/init.d &amp;&amp; <span class=\"keyword\">grep</span> -r <span class=\"string\">\"rm /dev/log/main\"</span></div></pre></td></tr></table></figure>\n<p>找到该文件：03MTKTweakElse文件。</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat1.png\" alt=\"这里写图片描述\"></p>\n<h4 id=\"修改脚本\"><a href=\"#修改脚本\" class=\"headerlink\" title=\"修改脚本\"></a>修改脚本</h4><p>利用pull指令将该文件拷贝到电脑上。<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">abd pull <span class=\"regexp\">/system/</span>ect<span class=\"regexp\">/init.d/</span><span class=\"number\">03</span>MTKTweakElse  <span class=\"string\">L:</span>\\</div></pre></td></tr></table></figure></p>\n<p>利用文本编辑工具（editplus、notepad++等）打开03MTKTweakElse文件，找到<code>rm    /dev/log/main</code>，然后注释掉该行。</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat2.png\" alt=\"这里写图片描述\"></p>\n<h4 id=\"将文件替换到之前的路径中\"><a href=\"#将文件替换到之前的路径中\" class=\"headerlink\" title=\"将文件替换到之前的路径中\"></a>将文件替换到之前的路径中</h4><figure class=\"highlight gauss\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">adb <span class=\"keyword\">push</span> L:\\<span class=\"number\">03</span>MTKTweakElse  /<span class=\"keyword\">system</span>/etc/init.d</div></pre></td></tr></table></figure>\n<h4 id=\"重启手机\"><a href=\"#重启手机\" class=\"headerlink\" title=\"重启手机\"></a>重启手机</h4><p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/10/ddms-logcat3.png\" alt=\"这里写图片描述\"></p>\n<p>经过以上几个步骤，应该就可以输出logcat了。</p>\n<h3 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h3><ul>\n<li>手机需要root。</li>\n<li>adb pull、push指令可能会失败，建议可以使用R.E资源管理器。</li>\n</ul>"},{"title":"Android自定义View实现仪表盘效果","date":"2016-05-16T06:41:26.000Z","_content":"\n本篇博客主要介绍如何实现一个仪表盘动态显示的效果，此效果来源于[买卖人](http://www.maimairen.com/)这个应用，3个室友有2个做安卓，而且都在``买卖人``，所以我也跟着实现了一波。\n效果如下：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard1.gif)\n\n<!-- more -->\n\n## 实现思路\n涉及到动画效果，首先将其拆分成``变化的部分``，和``不变的部分``。变化的部分有：颜色渐变的进度条、以及数字。不变的部分：指针刻度、灰色圆弧背景。拆分开来后，再来单独实现就非常简单了。\n1. 渐变的进度条：通过``shader``，设置起点和终点的颜色，便能达到颜色渐变的一个效果了。\n```\nmShader = new RadialGradient(0, 0, (1080 - 300) / 2, 0xffde5669, 0xffe79950, Shader.TileMode.MIRROR);\n```\n2. 数字：直接调用``drawText``即可。\n3. 指针刻度：先选取最好画的一个刻度，然后通过``旋转画布``重新绘制，就能画出所有的刻度了。（记得在画完之后要把画布归位）\n4. 灰色圆弧背景：设置好参数，调用``drawArc``即可。\n5. 动画效果：通过handler发送消息，改变变量值然后重绘就能实现了。\n\n## 完整代码\n```\npublic class DashboardView extends View {\n\n    private Paint mPaint;\n    private RectF rectF;\n    private Shader mShader;\n\n    private int targetDegree; // 目标角度\n    private int currentDegree; // 当前角度\n    private int currentNum; // 当前数值\n    private int targetNum; // 目标数值\n\n    public DashboardView(Context context) {\n        super(context);\n        init();\n    }\n\n    public DashboardView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init();\n    }\n\n    public DashboardView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init();\n    }\n\n    private void init() {\n        mPaint = new Paint();\n        rectF = new RectF();\n        // 颜色渐变的shader\n        mShader = new RadialGradient(0, 0, (1080 - 300) / 2, 0xffde5669, 0xffe79950, Shader.TileMode.MIRROR);\n    }\n\n    /**\n     * 通过Handler发送消息，改变变量，重绘View\n     */\n    private Handler handler = new Handler() {\n        @Override\n        public void handleMessage(Message msg) {\n            currentDegree += 5;\n            currentNum += currentDegree / 1000f * 259;\n            if (currentDegree < targetDegree) {\n                handler.sendEmptyMessageDelayed(0, 5);\n            } else {\n                currentDegree = targetDegree;\n                currentNum = targetNum;\n            }\n            invalidate();\n        }\n    };\n\n    public void setNum(int num) {\n        targetNum = num;\n        targetDegree = (int) (targetNum / 1000f * 259);\n        handler.sendEmptyMessageDelayed(0, 400);\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n        // 画大圆弧灰色背景\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setColor(Color.GRAY);\n        mPaint.setStrokeWidth(40);\n        mPaint.setStyle(Paint.Style.STROKE);\n        mPaint.setStrokeCap(Paint.Cap.ROUND);\n        rectF.top = getMeasuredHeight() / 2 - getMeasuredWidth() / 4;\n        rectF.left = getMeasuredWidth() / 4;\n        rectF.right = getWidth() / 4 * 3;\n        rectF.bottom = getMeasuredHeight() / 2 + getMeasuredWidth() / 4;\n        canvas.drawArc(rectF, 140, 260, false, mPaint);\n\n        // 通过旋转画布画指针刻度\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setColor(Color.GRAY);\n        mPaint.setStrokeWidth(3);\n        canvas.drawLine(getMeasuredWidth() / 2, rectF.top + 40, getMeasuredWidth() / 2, rectF.top + 60, mPaint);\n        for (int i = 0; i < 26; i++) {\n            int degrees = (int) (10 * (i + 1) * Math.pow(-1, i));\n            canvas.rotate(degrees, getWidth() / 2, getHeight() / 2);\n            canvas.drawLine(getMeasuredWidth() / 2, rectF.top + 40, getMeasuredWidth() / 2, rectF.top + 60, mPaint);\n        }\n        canvas.rotate(130, getWidth() / 2, getHeight() / 2);\n\n        // 画中间的小圆\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setColor(Color.DKGRAY);\n        canvas.drawCircle(getMeasuredWidth() / 2, getMeasuredHeight() / 2, 80, mPaint);\n\n        // 画带颜色的进度条\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setShader(mShader);\n        mPaint.setStyle(Paint.Style.STROKE);\n        mPaint.setStrokeWidth(40);\n        mPaint.setStrokeCap(Paint.Cap.ROUND);\n        canvas.drawArc(rectF, 140, currentDegree, false, mPaint);\n\n        // 画Text\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setColor(Color.parseColor(\"#ffde5669\"));\n        mPaint.setTextSize(70);\n        canvas.drawText(String.valueOf(currentNum), getMeasuredWidth() / 2 - 55, getMeasuredHeight() / 2 + 25, mPaint);\n    }\n}\n```\n## 画笔相关\nStyle有三种。\nSTROKE：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard1.png)\nFILL：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard2.png)\nFILL_AND_STROKE：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard3.png)\nStrokeCap也有三种。\nBUTT：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard4.png)\nSQUARE:\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard5.png)\nROUND：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard6.png)\n## 最后\n代码比较简单，在实现带动画的View时，最好先进行拆分，找出变化的部分和不变的部分，然后各自实现，将大问题拆分成若干个小问题，逐个击破。\n","source":"_posts/dashboard.md","raw":"---\ntitle: Android自定义View实现仪表盘效果\ndate: 2016-05-16 14:41:26\ntags:\n - 自定义View\n---\n\n本篇博客主要介绍如何实现一个仪表盘动态显示的效果，此效果来源于[买卖人](http://www.maimairen.com/)这个应用，3个室友有2个做安卓，而且都在``买卖人``，所以我也跟着实现了一波。\n效果如下：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard1.gif)\n\n<!-- more -->\n\n## 实现思路\n涉及到动画效果，首先将其拆分成``变化的部分``，和``不变的部分``。变化的部分有：颜色渐变的进度条、以及数字。不变的部分：指针刻度、灰色圆弧背景。拆分开来后，再来单独实现就非常简单了。\n1. 渐变的进度条：通过``shader``，设置起点和终点的颜色，便能达到颜色渐变的一个效果了。\n```\nmShader = new RadialGradient(0, 0, (1080 - 300) / 2, 0xffde5669, 0xffe79950, Shader.TileMode.MIRROR);\n```\n2. 数字：直接调用``drawText``即可。\n3. 指针刻度：先选取最好画的一个刻度，然后通过``旋转画布``重新绘制，就能画出所有的刻度了。（记得在画完之后要把画布归位）\n4. 灰色圆弧背景：设置好参数，调用``drawArc``即可。\n5. 动画效果：通过handler发送消息，改变变量值然后重绘就能实现了。\n\n## 完整代码\n```\npublic class DashboardView extends View {\n\n    private Paint mPaint;\n    private RectF rectF;\n    private Shader mShader;\n\n    private int targetDegree; // 目标角度\n    private int currentDegree; // 当前角度\n    private int currentNum; // 当前数值\n    private int targetNum; // 目标数值\n\n    public DashboardView(Context context) {\n        super(context);\n        init();\n    }\n\n    public DashboardView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init();\n    }\n\n    public DashboardView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init();\n    }\n\n    private void init() {\n        mPaint = new Paint();\n        rectF = new RectF();\n        // 颜色渐变的shader\n        mShader = new RadialGradient(0, 0, (1080 - 300) / 2, 0xffde5669, 0xffe79950, Shader.TileMode.MIRROR);\n    }\n\n    /**\n     * 通过Handler发送消息，改变变量，重绘View\n     */\n    private Handler handler = new Handler() {\n        @Override\n        public void handleMessage(Message msg) {\n            currentDegree += 5;\n            currentNum += currentDegree / 1000f * 259;\n            if (currentDegree < targetDegree) {\n                handler.sendEmptyMessageDelayed(0, 5);\n            } else {\n                currentDegree = targetDegree;\n                currentNum = targetNum;\n            }\n            invalidate();\n        }\n    };\n\n    public void setNum(int num) {\n        targetNum = num;\n        targetDegree = (int) (targetNum / 1000f * 259);\n        handler.sendEmptyMessageDelayed(0, 400);\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n        // 画大圆弧灰色背景\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setColor(Color.GRAY);\n        mPaint.setStrokeWidth(40);\n        mPaint.setStyle(Paint.Style.STROKE);\n        mPaint.setStrokeCap(Paint.Cap.ROUND);\n        rectF.top = getMeasuredHeight() / 2 - getMeasuredWidth() / 4;\n        rectF.left = getMeasuredWidth() / 4;\n        rectF.right = getWidth() / 4 * 3;\n        rectF.bottom = getMeasuredHeight() / 2 + getMeasuredWidth() / 4;\n        canvas.drawArc(rectF, 140, 260, false, mPaint);\n\n        // 通过旋转画布画指针刻度\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setColor(Color.GRAY);\n        mPaint.setStrokeWidth(3);\n        canvas.drawLine(getMeasuredWidth() / 2, rectF.top + 40, getMeasuredWidth() / 2, rectF.top + 60, mPaint);\n        for (int i = 0; i < 26; i++) {\n            int degrees = (int) (10 * (i + 1) * Math.pow(-1, i));\n            canvas.rotate(degrees, getWidth() / 2, getHeight() / 2);\n            canvas.drawLine(getMeasuredWidth() / 2, rectF.top + 40, getMeasuredWidth() / 2, rectF.top + 60, mPaint);\n        }\n        canvas.rotate(130, getWidth() / 2, getHeight() / 2);\n\n        // 画中间的小圆\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setColor(Color.DKGRAY);\n        canvas.drawCircle(getMeasuredWidth() / 2, getMeasuredHeight() / 2, 80, mPaint);\n\n        // 画带颜色的进度条\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setShader(mShader);\n        mPaint.setStyle(Paint.Style.STROKE);\n        mPaint.setStrokeWidth(40);\n        mPaint.setStrokeCap(Paint.Cap.ROUND);\n        canvas.drawArc(rectF, 140, currentDegree, false, mPaint);\n\n        // 画Text\n        mPaint.reset();\n        mPaint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        mPaint.setColor(Color.parseColor(\"#ffde5669\"));\n        mPaint.setTextSize(70);\n        canvas.drawText(String.valueOf(currentNum), getMeasuredWidth() / 2 - 55, getMeasuredHeight() / 2 + 25, mPaint);\n    }\n}\n```\n## 画笔相关\nStyle有三种。\nSTROKE：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard1.png)\nFILL：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard2.png)\nFILL_AND_STROKE：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard3.png)\nStrokeCap也有三种。\nBUTT：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard4.png)\nSQUARE:\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard5.png)\nROUND：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard6.png)\n## 最后\n代码比较简单，在实现带动画的View时，最好先进行拆分，找出变化的部分和不变的部分，然后各自实现，将大问题拆分成若干个小问题，逐个击破。\n","slug":"dashboard","published":1,"updated":"2016-11-21T09:59:10.023Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758m000t1cb88d3cuwrd","content":"<p>本篇博客主要介绍如何实现一个仪表盘动态显示的效果，此效果来源于<a href=\"http://www.maimairen.com/\" target=\"_blank\" rel=\"external\">买卖人</a>这个应用，3个室友有2个做安卓，而且都在<code>买卖人</code>，所以我也跟着实现了一波。<br>效果如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard1.gif\" alt=\"\"></p>\n<a id=\"more\"></a>\n<h2 id=\"实现思路\"><a href=\"#实现思路\" class=\"headerlink\" title=\"实现思路\"></a>实现思路</h2><p>涉及到动画效果，首先将其拆分成<code>变化的部分</code>，和<code>不变的部分</code>。变化的部分有：颜色渐变的进度条、以及数字。不变的部分：指针刻度、灰色圆弧背景。拆分开来后，再来单独实现就非常简单了。</p>\n<ol>\n<li><p>渐变的进度条：通过<code>shader</code>，设置起点和终点的颜色，便能达到颜色渐变的一个效果了。</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mShader = new RadialGradient(<span class=\"number\">0</span>, <span class=\"number\">0</span>, (<span class=\"number\">1080</span> - <span class=\"number\">300</span>) / <span class=\"number\">2</span>, <span class=\"number\">0xffde5669</span>, <span class=\"number\">0xffe79950</span>, Shader.TileMode.MIRROR);</div></pre></td></tr></table></figure>\n</li>\n<li><p>数字：直接调用<code>drawText</code>即可。</p>\n</li>\n<li>指针刻度：先选取最好画的一个刻度，然后通过<code>旋转画布</code>重新绘制，就能画出所有的刻度了。（记得在画完之后要把画布归位）</li>\n<li>灰色圆弧背景：设置好参数，调用<code>drawArc</code>即可。</li>\n<li>动画效果：通过handler发送消息，改变变量值然后重绘就能实现了。</li>\n</ol>\n<h2 id=\"完整代码\"><a href=\"#完整代码\" class=\"headerlink\" title=\"完整代码\"></a>完整代码</h2><figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DashboardView</span> <span class=\"title\">extends</span> <span class=\"title\">View</span> &#123;</span></div><div class=\"line\"></div><div class=\"line\">    private <span class=\"type\">Paint</span> mPaint;</div><div class=\"line\">    private <span class=\"type\">RectF</span> rectF;</div><div class=\"line\">    private <span class=\"type\">Shader</span> mShader;</div><div class=\"line\"></div><div class=\"line\">    private int targetDegree; <span class=\"comment\">// 目标角度</span></div><div class=\"line\">    private int currentDegree; <span class=\"comment\">// 当前角度</span></div><div class=\"line\">    private int currentNum; <span class=\"comment\">// 当前数值</span></div><div class=\"line\">    private int targetNum; <span class=\"comment\">// 目标数值</span></div><div class=\"line\"></div><div class=\"line\">    public <span class=\"type\">DashboardView</span>(<span class=\"type\">Context</span> context) &#123;</div><div class=\"line\">        super(context);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    public <span class=\"type\">DashboardView</span>(<span class=\"type\">Context</span> context, <span class=\"type\">AttributeSet</span> attrs) &#123;</div><div class=\"line\">        super(context, attrs);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    public <span class=\"type\">DashboardView</span>(<span class=\"type\">Context</span> context, <span class=\"type\">AttributeSet</span> attrs, int defStyleAttr) &#123;</div><div class=\"line\">        super(context, attrs, defStyleAttr);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    private void init() &#123;</div><div class=\"line\">        mPaint = <span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">Paint</span>();</span></div><div class=\"line\">        <span class=\"title\">rectF</span> = <span class=\"title\">new</span> <span class=\"title\">RectF</span>();</div><div class=\"line\">        <span class=\"comment\">// 颜色渐变的shader</span></div><div class=\"line\">        <span class=\"title\">mShader</span> = <span class=\"title\">new</span> <span class=\"title\">RadialGradient</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, (<span class=\"number\">1080</span> - <span class=\"number\">300</span>) / 2, 0<span class=\"title\">xffde5669</span>, 0<span class=\"title\">xffe79950</span>, <span class=\"title\">Shader</span>.<span class=\"title\">TileMode</span>.<span class=\"title\">MIRROR</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    /**</div><div class=\"line\">     * 通过<span class=\"title\">Handler</span>发送消息，改变变量，重绘<span class=\"title\">View</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"title\">private</span> <span class=\"title\">Handler</span> <span class=\"title\">handler</span> = <span class=\"title\">new</span> <span class=\"title\">Handler</span>() &#123;</div><div class=\"line\">        @<span class=\"title\">Override</span></div><div class=\"line\">        <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">handleMessage</span>(<span class=\"type\">Message</span> msg) &#123;</div><div class=\"line\">            <span class=\"title\">currentDegree</span> += 5;</div><div class=\"line\">            <span class=\"title\">currentNum</span> += <span class=\"title\">currentDegree</span> / 1000<span class=\"title\">f</span> * 259;</div><div class=\"line\">            <span class=\"title\">if</span> (currentDegree &lt; targetDegree) &#123;</div><div class=\"line\">                <span class=\"title\">handler</span>.<span class=\"title\">sendEmptyMessageDelayed</span>(<span class=\"number\">0</span>, <span class=\"number\">5</span>);</div><div class=\"line\">            &#125; <span class=\"title\">else</span> &#123;</div><div class=\"line\">                <span class=\"title\">currentDegree</span> = <span class=\"title\">targetDegree</span>;</div><div class=\"line\">                <span class=\"title\">currentNum</span> = <span class=\"title\">targetNum</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"title\">invalidate</span>();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">setNum</span>(int num) &#123;</div><div class=\"line\">        <span class=\"title\">targetNum</span> = <span class=\"title\">num</span>;</div><div class=\"line\">        <span class=\"title\">targetDegree</span> = (int) (targetNum / <span class=\"number\">1000</span>f * <span class=\"number\">259</span>);</div><div class=\"line\">        <span class=\"title\">handler</span>.<span class=\"title\">sendEmptyMessageDelayed</span>(<span class=\"number\">0</span>, <span class=\"number\">400</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @<span class=\"title\">Override</span></div><div class=\"line\">    <span class=\"title\">protected</span> <span class=\"title\">void</span> <span class=\"title\">onDraw</span>(<span class=\"type\">Canvas</span> canvas) &#123;</div><div class=\"line\">        <span class=\"title\">super</span>.<span class=\"title\">onDraw</span>(canvas);</div><div class=\"line\">        <span class=\"comment\">// 画大圆弧灰色背景</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setColor</span>(<span class=\"type\">Color</span>.<span class=\"type\">GRAY</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeWidth</span>(<span class=\"number\">40</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStyle</span>(<span class=\"type\">Paint</span>.<span class=\"type\">Style</span>.<span class=\"type\">STROKE</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeCap</span>(<span class=\"type\">Paint</span>.<span class=\"type\">Cap</span>.<span class=\"type\">ROUND</span>);</div><div class=\"line\">        <span class=\"title\">rectF</span>.<span class=\"title\">top</span> = <span class=\"title\">getMeasuredHeight</span>() / 2 - <span class=\"title\">getMeasuredWidth</span>() / 4;</div><div class=\"line\">        <span class=\"title\">rectF</span>.<span class=\"title\">left</span> = <span class=\"title\">getMeasuredWidth</span>() / 4;</div><div class=\"line\">        <span class=\"title\">rectF</span>.<span class=\"title\">right</span> = <span class=\"title\">getWidth</span>() / 4 * 3;</div><div class=\"line\">        <span class=\"title\">rectF</span>.<span class=\"title\">bottom</span> = <span class=\"title\">getMeasuredHeight</span>() / 2 + <span class=\"title\">getMeasuredWidth</span>() / 4;</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawArc</span>(rectF, <span class=\"number\">140</span>, <span class=\"number\">260</span>, false, mPaint);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 通过旋转画布画指针刻度</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setColor</span>(<span class=\"type\">Color</span>.<span class=\"type\">GRAY</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeWidth</span>(<span class=\"number\">3</span>);</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawLine</span>(getMeasuredWidth() / 2, <span class=\"title\">rectF</span>.<span class=\"title\">top</span> + 40, <span class=\"title\">getMeasuredWidth</span>() / 2, <span class=\"title\">rectF</span>.<span class=\"title\">top</span> + 60, <span class=\"title\">mPaint</span>);</div><div class=\"line\">        <span class=\"title\">for</span> (int i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">26</span>; i++) &#123;</div><div class=\"line\">            <span class=\"title\">int</span> <span class=\"title\">degrees</span> = (int) (<span class=\"number\">10</span> * (i + <span class=\"number\">1</span>) * <span class=\"title\">Math</span>.<span class=\"title\">pow</span>(<span class=\"number\">-1</span>, i));</div><div class=\"line\">            <span class=\"title\">canvas</span>.<span class=\"title\">rotate</span>(degrees, getWidth() / 2, <span class=\"title\">getHeight</span>() / 2);</div><div class=\"line\">            <span class=\"title\">canvas</span>.<span class=\"title\">drawLine</span>(getMeasuredWidth() / 2, <span class=\"title\">rectF</span>.<span class=\"title\">top</span> + 40, <span class=\"title\">getMeasuredWidth</span>() / 2, <span class=\"title\">rectF</span>.<span class=\"title\">top</span> + 60, <span class=\"title\">mPaint</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">rotate</span>(<span class=\"number\">130</span>, getWidth() / 2, <span class=\"title\">getHeight</span>() / 2);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画中间的小圆</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setColor</span>(<span class=\"type\">Color</span>.<span class=\"type\">DKGRAY</span>);</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawCircle</span>(getMeasuredWidth() / 2, <span class=\"title\">getMeasuredHeight</span>() / 2, 80, <span class=\"title\">mPaint</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画带颜色的进度条</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setShader</span>(mShader);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStyle</span>(<span class=\"type\">Paint</span>.<span class=\"type\">Style</span>.<span class=\"type\">STROKE</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeWidth</span>(<span class=\"number\">40</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeCap</span>(<span class=\"type\">Paint</span>.<span class=\"type\">Cap</span>.<span class=\"type\">ROUND</span>);</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawArc</span>(rectF, <span class=\"number\">140</span>, currentDegree, false, mPaint);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画Text</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setColor</span>(<span class=\"type\">Color</span>.parseColor(\"#ffde5669\"));</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setTextSize</span>(<span class=\"number\">70</span>);</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawText</span>(<span class=\"type\">String</span>.valueOf(currentNum), <span class=\"title\">getMeasuredWidth</span>() / 2 - 55, <span class=\"title\">getMeasuredHeight</span>() / 2 + 25, <span class=\"title\">mPaint</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"画笔相关\"><a href=\"#画笔相关\" class=\"headerlink\" title=\"画笔相关\"></a>画笔相关</h2><p>Style有三种。<br>STROKE：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard1.png\" alt=\"\"><br>FILL：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard2.png\" alt=\"\"><br>FILL_AND_STROKE：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard3.png\" alt=\"\"><br>StrokeCap也有三种。<br>BUTT：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard4.png\" alt=\"\"><br>SQUARE:<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard5.png\" alt=\"\"><br>ROUND：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard6.png\" alt=\"\"></p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>代码比较简单，在实现带动画的View时，最好先进行拆分，找出变化的部分和不变的部分，然后各自实现，将大问题拆分成若干个小问题，逐个击破。</p>\n","excerpt":"<p>本篇博客主要介绍如何实现一个仪表盘动态显示的效果，此效果来源于<a href=\"http://www.maimairen.com/\">买卖人</a>这个应用，3个室友有2个做安卓，而且都在<code>买卖人</code>，所以我也跟着实现了一波。<br>效果如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard1.gif\" alt=\"\"></p>","more":"<h2 id=\"实现思路\"><a href=\"#实现思路\" class=\"headerlink\" title=\"实现思路\"></a>实现思路</h2><p>涉及到动画效果，首先将其拆分成<code>变化的部分</code>，和<code>不变的部分</code>。变化的部分有：颜色渐变的进度条、以及数字。不变的部分：指针刻度、灰色圆弧背景。拆分开来后，再来单独实现就非常简单了。</p>\n<ol>\n<li><p>渐变的进度条：通过<code>shader</code>，设置起点和终点的颜色，便能达到颜色渐变的一个效果了。</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mShader = new RadialGradient(<span class=\"number\">0</span>, <span class=\"number\">0</span>, (<span class=\"number\">1080</span> - <span class=\"number\">300</span>) / <span class=\"number\">2</span>, <span class=\"number\">0xffde5669</span>, <span class=\"number\">0xffe79950</span>, Shader.TileMode.MIRROR);</div></pre></td></tr></table></figure>\n</li>\n<li><p>数字：直接调用<code>drawText</code>即可。</p>\n</li>\n<li>指针刻度：先选取最好画的一个刻度，然后通过<code>旋转画布</code>重新绘制，就能画出所有的刻度了。（记得在画完之后要把画布归位）</li>\n<li>灰色圆弧背景：设置好参数，调用<code>drawArc</code>即可。</li>\n<li>动画效果：通过handler发送消息，改变变量值然后重绘就能实现了。</li>\n</ol>\n<h2 id=\"完整代码\"><a href=\"#完整代码\" class=\"headerlink\" title=\"完整代码\"></a>完整代码</h2><figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DashboardView</span> <span class=\"title\">extends</span> <span class=\"title\">View</span> &#123;</span></div><div class=\"line\"></div><div class=\"line\">    private <span class=\"type\">Paint</span> mPaint;</div><div class=\"line\">    private <span class=\"type\">RectF</span> rectF;</div><div class=\"line\">    private <span class=\"type\">Shader</span> mShader;</div><div class=\"line\"></div><div class=\"line\">    private int targetDegree; <span class=\"comment\">// 目标角度</span></div><div class=\"line\">    private int currentDegree; <span class=\"comment\">// 当前角度</span></div><div class=\"line\">    private int currentNum; <span class=\"comment\">// 当前数值</span></div><div class=\"line\">    private int targetNum; <span class=\"comment\">// 目标数值</span></div><div class=\"line\"></div><div class=\"line\">    public <span class=\"type\">DashboardView</span>(<span class=\"type\">Context</span> context) &#123;</div><div class=\"line\">        super(context);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    public <span class=\"type\">DashboardView</span>(<span class=\"type\">Context</span> context, <span class=\"type\">AttributeSet</span> attrs) &#123;</div><div class=\"line\">        super(context, attrs);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    public <span class=\"type\">DashboardView</span>(<span class=\"type\">Context</span> context, <span class=\"type\">AttributeSet</span> attrs, int defStyleAttr) &#123;</div><div class=\"line\">        super(context, attrs, defStyleAttr);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    private void init() &#123;</div><div class=\"line\">        mPaint = <span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">Paint</span>();</div><div class=\"line\">        <span class=\"title\">rectF</span> = <span class=\"title\">new</span> <span class=\"title\">RectF</span>();</div><div class=\"line\">        <span class=\"comment\">// 颜色渐变的shader</span></div><div class=\"line\">        <span class=\"title\">mShader</span> = <span class=\"title\">new</span> <span class=\"title\">RadialGradient</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, (<span class=\"number\">1080</span> - <span class=\"number\">300</span>) / 2, 0<span class=\"title\">xffde5669</span>, 0<span class=\"title\">xffe79950</span>, <span class=\"title\">Shader</span>.<span class=\"title\">TileMode</span>.<span class=\"title\">MIRROR</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    /**</div><div class=\"line\">     * 通过<span class=\"title\">Handler</span>发送消息，改变变量，重绘<span class=\"title\">View</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"title\">private</span> <span class=\"title\">Handler</span> <span class=\"title\">handler</span> = <span class=\"title\">new</span> <span class=\"title\">Handler</span>() &#123;</div><div class=\"line\">        @<span class=\"title\">Override</span></div><div class=\"line\">        <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">handleMessage</span>(<span class=\"type\">Message</span> msg) &#123;</div><div class=\"line\">            <span class=\"title\">currentDegree</span> += 5;</div><div class=\"line\">            <span class=\"title\">currentNum</span> += <span class=\"title\">currentDegree</span> / 1000<span class=\"title\">f</span> * 259;</div><div class=\"line\">            <span class=\"title\">if</span> (currentDegree &lt; targetDegree) &#123;</div><div class=\"line\">                <span class=\"title\">handler</span>.<span class=\"title\">sendEmptyMessageDelayed</span>(<span class=\"number\">0</span>, <span class=\"number\">5</span>);</div><div class=\"line\">            &#125; <span class=\"title\">else</span> &#123;</div><div class=\"line\">                <span class=\"title\">currentDegree</span> = <span class=\"title\">targetDegree</span>;</div><div class=\"line\">                <span class=\"title\">currentNum</span> = <span class=\"title\">targetNum</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"title\">invalidate</span>();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">setNum</span>(int num) &#123;</div><div class=\"line\">        <span class=\"title\">targetNum</span> = <span class=\"title\">num</span>;</div><div class=\"line\">        <span class=\"title\">targetDegree</span> = (int) (targetNum / <span class=\"number\">1000</span>f * <span class=\"number\">259</span>);</div><div class=\"line\">        <span class=\"title\">handler</span>.<span class=\"title\">sendEmptyMessageDelayed</span>(<span class=\"number\">0</span>, <span class=\"number\">400</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @<span class=\"title\">Override</span></div><div class=\"line\">    <span class=\"title\">protected</span> <span class=\"title\">void</span> <span class=\"title\">onDraw</span>(<span class=\"type\">Canvas</span> canvas) &#123;</div><div class=\"line\">        <span class=\"title\">super</span>.<span class=\"title\">onDraw</span>(canvas);</div><div class=\"line\">        <span class=\"comment\">// 画大圆弧灰色背景</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setColor</span>(<span class=\"type\">Color</span>.<span class=\"type\">GRAY</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeWidth</span>(<span class=\"number\">40</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStyle</span>(<span class=\"type\">Paint</span>.<span class=\"type\">Style</span>.<span class=\"type\">STROKE</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeCap</span>(<span class=\"type\">Paint</span>.<span class=\"type\">Cap</span>.<span class=\"type\">ROUND</span>);</div><div class=\"line\">        <span class=\"title\">rectF</span>.<span class=\"title\">top</span> = <span class=\"title\">getMeasuredHeight</span>() / 2 - <span class=\"title\">getMeasuredWidth</span>() / 4;</div><div class=\"line\">        <span class=\"title\">rectF</span>.<span class=\"title\">left</span> = <span class=\"title\">getMeasuredWidth</span>() / 4;</div><div class=\"line\">        <span class=\"title\">rectF</span>.<span class=\"title\">right</span> = <span class=\"title\">getWidth</span>() / 4 * 3;</div><div class=\"line\">        <span class=\"title\">rectF</span>.<span class=\"title\">bottom</span> = <span class=\"title\">getMeasuredHeight</span>() / 2 + <span class=\"title\">getMeasuredWidth</span>() / 4;</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawArc</span>(rectF, <span class=\"number\">140</span>, <span class=\"number\">260</span>, false, mPaint);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 通过旋转画布画指针刻度</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setColor</span>(<span class=\"type\">Color</span>.<span class=\"type\">GRAY</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeWidth</span>(<span class=\"number\">3</span>);</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawLine</span>(getMeasuredWidth() / 2, <span class=\"title\">rectF</span>.<span class=\"title\">top</span> + 40, <span class=\"title\">getMeasuredWidth</span>() / 2, <span class=\"title\">rectF</span>.<span class=\"title\">top</span> + 60, <span class=\"title\">mPaint</span>);</div><div class=\"line\">        <span class=\"title\">for</span> (int i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">26</span>; i++) &#123;</div><div class=\"line\">            <span class=\"title\">int</span> <span class=\"title\">degrees</span> = (int) (<span class=\"number\">10</span> * (i + <span class=\"number\">1</span>) * <span class=\"title\">Math</span>.<span class=\"title\">pow</span>(<span class=\"number\">-1</span>, i));</div><div class=\"line\">            <span class=\"title\">canvas</span>.<span class=\"title\">rotate</span>(degrees, getWidth() / 2, <span class=\"title\">getHeight</span>() / 2);</div><div class=\"line\">            <span class=\"title\">canvas</span>.<span class=\"title\">drawLine</span>(getMeasuredWidth() / 2, <span class=\"title\">rectF</span>.<span class=\"title\">top</span> + 40, <span class=\"title\">getMeasuredWidth</span>() / 2, <span class=\"title\">rectF</span>.<span class=\"title\">top</span> + 60, <span class=\"title\">mPaint</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">rotate</span>(<span class=\"number\">130</span>, getWidth() / 2, <span class=\"title\">getHeight</span>() / 2);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画中间的小圆</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setColor</span>(<span class=\"type\">Color</span>.<span class=\"type\">DKGRAY</span>);</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawCircle</span>(getMeasuredWidth() / 2, <span class=\"title\">getMeasuredHeight</span>() / 2, 80, <span class=\"title\">mPaint</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画带颜色的进度条</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setShader</span>(mShader);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStyle</span>(<span class=\"type\">Paint</span>.<span class=\"type\">Style</span>.<span class=\"type\">STROKE</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeWidth</span>(<span class=\"number\">40</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setStrokeCap</span>(<span class=\"type\">Paint</span>.<span class=\"type\">Cap</span>.<span class=\"type\">ROUND</span>);</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawArc</span>(rectF, <span class=\"number\">140</span>, currentDegree, false, mPaint);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画Text</span></div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">reset</span>();</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setFlags</span>(<span class=\"type\">Paint</span>.<span class=\"type\">ANTI_ALIAS_FLAG</span>);</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setColor</span>(<span class=\"type\">Color</span>.parseColor(\"#ffde5669\"));</div><div class=\"line\">        <span class=\"title\">mPaint</span>.<span class=\"title\">setTextSize</span>(<span class=\"number\">70</span>);</div><div class=\"line\">        <span class=\"title\">canvas</span>.<span class=\"title\">drawText</span>(<span class=\"type\">String</span>.valueOf(currentNum), <span class=\"title\">getMeasuredWidth</span>() / 2 - 55, <span class=\"title\">getMeasuredHeight</span>() / 2 + 25, <span class=\"title\">mPaint</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</span></div></pre></td></tr></table></figure>\n<h2 id=\"画笔相关\"><a href=\"#画笔相关\" class=\"headerlink\" title=\"画笔相关\"></a>画笔相关</h2><p>Style有三种。<br>STROKE：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard1.png\" alt=\"\"><br>FILL：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard2.png\" alt=\"\"><br>FILL_AND_STROKE：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard3.png\" alt=\"\"><br>StrokeCap也有三种。<br>BUTT：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard4.png\" alt=\"\"><br>SQUARE:<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard5.png\" alt=\"\"><br>ROUND：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/05/dashboard6.png\" alt=\"\"></p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>代码比较简单，在实现带动画的View时，最好先进行拆分，找出变化的部分和不变的部分，然后各自实现，将大问题拆分成若干个小问题，逐个击破。</p>"},{"title":"博客添加域名映射","date":"2016-04-07T06:05:45.000Z","_content":"\n利用Github搭建博客有一阵子了，每次访问都必须带上``github.io``，其实我的内心是拒绝的，于是今天打算买个自己的域名，然后映射到博客。\n\n## 购买域名\n首先第一步自然是买域名了。许多人都说是用``GoDaddy``，但是我去搜了一下，随便一个就是15刀，吓死宝宝了~\n刚开始嘛，弄个便宜的尝尝鲜才是我的目的，于是我上[阿里云](https://wanwang.aliyun.com/)买了``lastwarmth.site``这个域名，首年才只收费4块钱哟~\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain9.png)\n\n<!-- more -->\n\n## 域名解析\n登录阿里云，进入到``管理控制台``，点击``域名``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain1.png)\n可以看到自己购买的域名，点击后面的``解析``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain2.png)\n跳过``新手设置引导``，直接点击``进入高级设置``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain3.png)\n然后点击``添加解析``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain4.png)\n可以看到记录的几种类型，因为映射到的github.io博客也是Github的域名，所以我选择的``CNAME``，主机记录配置``www``，解析线路``默认``，记录值填写自己的博客地址，我填的是``lijia92.github.io``。\n填写完之后，再添加一条``@``主机记录配置。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain5.png)\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain8.png)\n\n## Github关联\n在自己Github的github.io的仓库根目录下创建``CNAME``文件，编辑，填入你的域名。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain6.png)\n\n## 最后\nwait。\n\n稍后便能通过域名访问博客啦。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain7.png)\n\n## 小问题\n在更新博客deploy的时候，添加的``CNAME``文件会被刷掉，导致映射不过去。所以需要将``CNAME``添加到``hexo/source``下面，然后重新部署。\n","source":"_posts/domain.md","raw":"---\ntitle: 博客添加域名映射\ndate: 2016-04-07 14:05:45\ntags:\n - blog\n---\n\n利用Github搭建博客有一阵子了，每次访问都必须带上``github.io``，其实我的内心是拒绝的，于是今天打算买个自己的域名，然后映射到博客。\n\n## 购买域名\n首先第一步自然是买域名了。许多人都说是用``GoDaddy``，但是我去搜了一下，随便一个就是15刀，吓死宝宝了~\n刚开始嘛，弄个便宜的尝尝鲜才是我的目的，于是我上[阿里云](https://wanwang.aliyun.com/)买了``lastwarmth.site``这个域名，首年才只收费4块钱哟~\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain9.png)\n\n<!-- more -->\n\n## 域名解析\n登录阿里云，进入到``管理控制台``，点击``域名``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain1.png)\n可以看到自己购买的域名，点击后面的``解析``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain2.png)\n跳过``新手设置引导``，直接点击``进入高级设置``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain3.png)\n然后点击``添加解析``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain4.png)\n可以看到记录的几种类型，因为映射到的github.io博客也是Github的域名，所以我选择的``CNAME``，主机记录配置``www``，解析线路``默认``，记录值填写自己的博客地址，我填的是``lijia92.github.io``。\n填写完之后，再添加一条``@``主机记录配置。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain5.png)\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain8.png)\n\n## Github关联\n在自己Github的github.io的仓库根目录下创建``CNAME``文件，编辑，填入你的域名。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain6.png)\n\n## 最后\nwait。\n\n稍后便能通过域名访问博客啦。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain7.png)\n\n## 小问题\n在更新博客deploy的时候，添加的``CNAME``文件会被刷掉，导致映射不过去。所以需要将``CNAME``添加到``hexo/source``下面，然后重新部署。\n","slug":"domain","published":1,"updated":"2016-11-21T09:59:18.720Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758n000v1cb826w7kgai","content":"<p>利用Github搭建博客有一阵子了，每次访问都必须带上<code>github.io</code>，其实我的内心是拒绝的，于是今天打算买个自己的域名，然后映射到博客。</p>\n<h2 id=\"购买域名\"><a href=\"#购买域名\" class=\"headerlink\" title=\"购买域名\"></a>购买域名</h2><p>首先第一步自然是买域名了。许多人都说是用<code>GoDaddy</code>，但是我去搜了一下，随便一个就是15刀，吓死宝宝了~<br>刚开始嘛，弄个便宜的尝尝鲜才是我的目的，于是我上<a href=\"https://wanwang.aliyun.com/\" target=\"_blank\" rel=\"external\">阿里云</a>买了<code>lastwarmth.site</code>这个域名，首年才只收费4块钱哟~<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain9.png\" alt=\"\"></p>\n<a id=\"more\"></a>\n<h2 id=\"域名解析\"><a href=\"#域名解析\" class=\"headerlink\" title=\"域名解析\"></a>域名解析</h2><p>登录阿里云，进入到<code>管理控制台</code>，点击<code>域名</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain1.png\" alt=\"\"><br>可以看到自己购买的域名，点击后面的<code>解析</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain2.png\" alt=\"\"><br>跳过<code>新手设置引导</code>，直接点击<code>进入高级设置</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain3.png\" alt=\"\"><br>然后点击<code>添加解析</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain4.png\" alt=\"\"><br>可以看到记录的几种类型，因为映射到的github.io博客也是Github的域名，所以我选择的<code>CNAME</code>，主机记录配置<code>www</code>，解析线路<code>默认</code>，记录值填写自己的博客地址，我填的是<code>lijia92.github.io</code>。<br>填写完之后，再添加一条<code>@</code>主机记录配置。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain5.png\" alt=\"\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain8.png\" alt=\"\"></p>\n<h2 id=\"Github关联\"><a href=\"#Github关联\" class=\"headerlink\" title=\"Github关联\"></a>Github关联</h2><p>在自己Github的github.io的仓库根目录下创建<code>CNAME</code>文件，编辑，填入你的域名。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain6.png\" alt=\"\"></p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>wait。</p>\n<p>稍后便能通过域名访问博客啦。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain7.png\" alt=\"\"></p>\n<h2 id=\"小问题\"><a href=\"#小问题\" class=\"headerlink\" title=\"小问题\"></a>小问题</h2><p>在更新博客deploy的时候，添加的<code>CNAME</code>文件会被刷掉，导致映射不过去。所以需要将<code>CNAME</code>添加到<code>hexo/source</code>下面，然后重新部署。</p>\n","excerpt":"<p>利用Github搭建博客有一阵子了，每次访问都必须带上<code>github.io</code>，其实我的内心是拒绝的，于是今天打算买个自己的域名，然后映射到博客。</p>\n<h2 id=\"购买域名\"><a href=\"#购买域名\" class=\"headerlink\" title=\"购买域名\"></a>购买域名</h2><p>首先第一步自然是买域名了。许多人都说是用<code>GoDaddy</code>，但是我去搜了一下，随便一个就是15刀，吓死宝宝了~<br>刚开始嘛，弄个便宜的尝尝鲜才是我的目的，于是我上<a href=\"https://wanwang.aliyun.com/\">阿里云</a>买了<code>lastwarmth.site</code>这个域名，首年才只收费4块钱哟~<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain9.png\" alt=\"\"></p>","more":"<h2 id=\"域名解析\"><a href=\"#域名解析\" class=\"headerlink\" title=\"域名解析\"></a>域名解析</h2><p>登录阿里云，进入到<code>管理控制台</code>，点击<code>域名</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain1.png\" alt=\"\"><br>可以看到自己购买的域名，点击后面的<code>解析</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain2.png\" alt=\"\"><br>跳过<code>新手设置引导</code>，直接点击<code>进入高级设置</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain3.png\" alt=\"\"><br>然后点击<code>添加解析</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain4.png\" alt=\"\"><br>可以看到记录的几种类型，因为映射到的github.io博客也是Github的域名，所以我选择的<code>CNAME</code>，主机记录配置<code>www</code>，解析线路<code>默认</code>，记录值填写自己的博客地址，我填的是<code>lijia92.github.io</code>。<br>填写完之后，再添加一条<code>@</code>主机记录配置。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain5.png\" alt=\"\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain8.png\" alt=\"\"></p>\n<h2 id=\"Github关联\"><a href=\"#Github关联\" class=\"headerlink\" title=\"Github关联\"></a>Github关联</h2><p>在自己Github的github.io的仓库根目录下创建<code>CNAME</code>文件，编辑，填入你的域名。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain6.png\" alt=\"\"></p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>wait。</p>\n<p>稍后便能通过域名访问博客啦。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/domain7.png\" alt=\"\"></p>\n<h2 id=\"小问题\"><a href=\"#小问题\" class=\"headerlink\" title=\"小问题\"></a>小问题</h2><p>在更新博客deploy的时候，添加的<code>CNAME</code>文件会被刷掉，导致映射不过去。所以需要将<code>CNAME</code>添加到<code>hexo/source</code>下面，然后重新部署。</p>"},{"title":"Android Studio使用Genymotion小记","date":"2015-11-05T02:46:29.000Z","_content":"\n在学习Android Studio的过程中，看到网上很多人都推荐使用Genymotion插件，在某些无法使用真机的情况下，这个模拟器插件能大大加快模拟器的运行速度。而且由于没有Android 5.0以上的真机，使用Genymotion可以运行Android 5.0以上的模拟器，看看Meterial Design的设计，所谓一举两得，于是便开始了一波Genymotion的学习。\n\n---\n### 安装Genymotion\n安装Genymotion。进入到官网，下载Genymotion，没有安装Virtual Box的，选择带有Virtual Box的安装文件进行下载。下载成功后，安装，基本都是下一步，下一步。\n\n### Android Studio使用Genymotion插件\n\n1. Android Studio安装Genymotion插件。安装过程很简单，网上一搜一大把，就不赘述了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion1.png)\n\n2. 将Genymotion路径配置到Android Studio中。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion2.png)\n\n3. 启动Genymotion插件，选择要配置的机型，系统，点击Next，等待下载，安装，部署结束之后，启动模拟器即可进行使用了。\n\n<!--more-->\n\n### 问题\n- 在选择好机型后，点击Next时，一直在Downloading files界面，最后弹出\"Connection timeout occurred\"，提示创建虚拟机失败。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion3.png)\n出现这种情况，主要是下载的ova文件无法正常下载下来。打开日志文件（路径：C:\\Users\\Administrator\\AppData\\Local\\Genymobile\\genymotion.log），可以看到类似的log：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion4.png)\n拷贝出.ova的那个地址，下载好这个ova文件后，替换到C:\\Users\\Administrator\\AppData\\Local\\Genymobile\\Genymotion\\ova文件夹中即可。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion14.png)\n在我的情形中，是由于公司网速太慢导致QAQ...后面在寝室一下就好了~\n\n- 创建好虚拟机后，启动失败。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion5.png)\n网上查了许多解决方法，诸如修改Ip的一些等等，但是并不适用于我的情况。后面找到了解决方法：减少虚拟机内存！\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion6.png)\n打开Virtual Box，找到相应的虚拟机，打开设置->系统，将内存大小从2048改成1024后，虚拟机启动成功！\n\n- 但是当我创建安卓5.0以上的虚拟机时，虚拟机虽然启动成功了，却一直停留在下面这个画面：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion7.png)\n本以为进度到了74之后就会结束，进入系统的，结果是我太天真...\n进度到了74之后，黑屏，显示一个“Android”字样，然后又重复开始从1到74，就这样不停重复不停重复，根本无法使用虚拟机。\n于是又在网上搜罗相关的解决办法，最后算是找到了：``安装HAXM``。\n1. 首先进入BIOS开启intel虚拟加速。不同的品牌电脑设置界面不同，这个自行百度。\n2. 需要在SDK Manager里面下载Intel x86 Emulator Accelator。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion8.png)\n3. 下载完成之后，找到相关安装文件进行安装。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion9.png)\n4. 进入cmd，输入命令【sc query intelhaxm】查看intelhaxm状态。没有开启的话，输入【sc start intelhaxm】即可进行开启。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion10.png)\n通过以上步骤，我的安卓5.1虚拟机，总算是成功跑起来了！！！\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion11.png)\n\n- 后面回到家里，也通过上述一些操作，但是却仍然启动失败！！！后面打开VirtualBox，从VirtualBox启动虚拟机，报如下的错误：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion12.png)\n后面网上找到该错误的原因，是因为系统破解，system32文件夹下的uxtheme.dll文件出问题。在网上下载电脑相应64位或32位的未破解的uxtheme.dll文件，替换到system32里去，然后重新启动虚拟机，成功！也可以下载下面的破解还原工具，还原破解。\n[破解还原工具](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotiontheme%28win7X64%29.zip)\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion13.png)\n- 使用Genymotion安装APK出现错误INSTALL_FAILED_CPU_ABI_INCOMPATIBLE，解决办法如下：下载[这个Zip](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotionGenymotion-ARM-Translation.zip)，不要解压，直接拖到虚拟机窗口中。对，你没有看错，就是直接拖进去。然后重启虚拟机就可以了。\n","source":"_posts/genymotion.md","raw":"---\ntitle: Android Studio使用Genymotion小记\ndate: 2015-11-05 10:46:29\ntags:\n - android studio\n---\n\n在学习Android Studio的过程中，看到网上很多人都推荐使用Genymotion插件，在某些无法使用真机的情况下，这个模拟器插件能大大加快模拟器的运行速度。而且由于没有Android 5.0以上的真机，使用Genymotion可以运行Android 5.0以上的模拟器，看看Meterial Design的设计，所谓一举两得，于是便开始了一波Genymotion的学习。\n\n---\n### 安装Genymotion\n安装Genymotion。进入到官网，下载Genymotion，没有安装Virtual Box的，选择带有Virtual Box的安装文件进行下载。下载成功后，安装，基本都是下一步，下一步。\n\n### Android Studio使用Genymotion插件\n\n1. Android Studio安装Genymotion插件。安装过程很简单，网上一搜一大把，就不赘述了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion1.png)\n\n2. 将Genymotion路径配置到Android Studio中。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion2.png)\n\n3. 启动Genymotion插件，选择要配置的机型，系统，点击Next，等待下载，安装，部署结束之后，启动模拟器即可进行使用了。\n\n<!--more-->\n\n### 问题\n- 在选择好机型后，点击Next时，一直在Downloading files界面，最后弹出\"Connection timeout occurred\"，提示创建虚拟机失败。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion3.png)\n出现这种情况，主要是下载的ova文件无法正常下载下来。打开日志文件（路径：C:\\Users\\Administrator\\AppData\\Local\\Genymobile\\genymotion.log），可以看到类似的log：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion4.png)\n拷贝出.ova的那个地址，下载好这个ova文件后，替换到C:\\Users\\Administrator\\AppData\\Local\\Genymobile\\Genymotion\\ova文件夹中即可。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion14.png)\n在我的情形中，是由于公司网速太慢导致QAQ...后面在寝室一下就好了~\n\n- 创建好虚拟机后，启动失败。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion5.png)\n网上查了许多解决方法，诸如修改Ip的一些等等，但是并不适用于我的情况。后面找到了解决方法：减少虚拟机内存！\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion6.png)\n打开Virtual Box，找到相应的虚拟机，打开设置->系统，将内存大小从2048改成1024后，虚拟机启动成功！\n\n- 但是当我创建安卓5.0以上的虚拟机时，虚拟机虽然启动成功了，却一直停留在下面这个画面：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion7.png)\n本以为进度到了74之后就会结束，进入系统的，结果是我太天真...\n进度到了74之后，黑屏，显示一个“Android”字样，然后又重复开始从1到74，就这样不停重复不停重复，根本无法使用虚拟机。\n于是又在网上搜罗相关的解决办法，最后算是找到了：``安装HAXM``。\n1. 首先进入BIOS开启intel虚拟加速。不同的品牌电脑设置界面不同，这个自行百度。\n2. 需要在SDK Manager里面下载Intel x86 Emulator Accelator。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion8.png)\n3. 下载完成之后，找到相关安装文件进行安装。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion9.png)\n4. 进入cmd，输入命令【sc query intelhaxm】查看intelhaxm状态。没有开启的话，输入【sc start intelhaxm】即可进行开启。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion10.png)\n通过以上步骤，我的安卓5.1虚拟机，总算是成功跑起来了！！！\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion11.png)\n\n- 后面回到家里，也通过上述一些操作，但是却仍然启动失败！！！后面打开VirtualBox，从VirtualBox启动虚拟机，报如下的错误：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion12.png)\n后面网上找到该错误的原因，是因为系统破解，system32文件夹下的uxtheme.dll文件出问题。在网上下载电脑相应64位或32位的未破解的uxtheme.dll文件，替换到system32里去，然后重新启动虚拟机，成功！也可以下载下面的破解还原工具，还原破解。\n[破解还原工具](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotiontheme%28win7X64%29.zip)\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion13.png)\n- 使用Genymotion安装APK出现错误INSTALL_FAILED_CPU_ABI_INCOMPATIBLE，解决办法如下：下载[这个Zip](http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotionGenymotion-ARM-Translation.zip)，不要解压，直接拖到虚拟机窗口中。对，你没有看错，就是直接拖进去。然后重启虚拟机就可以了。\n","slug":"genymotion","published":1,"updated":"2016-11-21T09:59:22.702Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758p000y1cb8u29kdodb","content":"<p>在学习Android Studio的过程中，看到网上很多人都推荐使用Genymotion插件，在某些无法使用真机的情况下，这个模拟器插件能大大加快模拟器的运行速度。而且由于没有Android 5.0以上的真机，使用Genymotion可以运行Android 5.0以上的模拟器，看看Meterial Design的设计，所谓一举两得，于是便开始了一波Genymotion的学习。</p>\n<hr>\n<h3 id=\"安装Genymotion\"><a href=\"#安装Genymotion\" class=\"headerlink\" title=\"安装Genymotion\"></a>安装Genymotion</h3><p>安装Genymotion。进入到官网，下载Genymotion，没有安装Virtual Box的，选择带有Virtual Box的安装文件进行下载。下载成功后，安装，基本都是下一步，下一步。</p>\n<h3 id=\"Android-Studio使用Genymotion插件\"><a href=\"#Android-Studio使用Genymotion插件\" class=\"headerlink\" title=\"Android Studio使用Genymotion插件\"></a>Android Studio使用Genymotion插件</h3><ol>\n<li><p>Android Studio安装Genymotion插件。安装过程很简单，网上一搜一大把，就不赘述了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion1.png\" alt=\"这里写图片描述\"></p>\n</li>\n<li><p>将Genymotion路径配置到Android Studio中。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion2.png\" alt=\"这里写图片描述\"></p>\n</li>\n<li><p>启动Genymotion插件，选择要配置的机型，系统，点击Next，等待下载，安装，部署结束之后，启动模拟器即可进行使用了。</p>\n</li>\n</ol>\n<a id=\"more\"></a>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><ul>\n<li><p>在选择好机型后，点击Next时，一直在Downloading files界面，最后弹出”Connection timeout occurred”，提示创建虚拟机失败。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion3.png\" alt=\"这里写图片描述\"><br>出现这种情况，主要是下载的ova文件无法正常下载下来。打开日志文件（路径：C:\\Users\\Administrator\\AppData\\Local\\Genymobile\\genymotion.log），可以看到类似的log：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion4.png\" alt=\"这里写图片描述\"><br>拷贝出.ova的那个地址，下载好这个ova文件后，替换到C:\\Users\\Administrator\\AppData\\Local\\Genymobile\\Genymotion\\ova文件夹中即可。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion14.png\" alt=\"这里写图片描述\"><br>在我的情形中，是由于公司网速太慢导致QAQ…后面在寝室一下就好了~</p>\n</li>\n<li><p>创建好虚拟机后，启动失败。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion5.png\" alt=\"这里写图片描述\"><br>网上查了许多解决方法，诸如修改Ip的一些等等，但是并不适用于我的情况。后面找到了解决方法：减少虚拟机内存！<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion6.png\" alt=\"这里写图片描述\"><br>打开Virtual Box，找到相应的虚拟机，打开设置-&gt;系统，将内存大小从2048改成1024后，虚拟机启动成功！</p>\n</li>\n<li><p>但是当我创建安卓5.0以上的虚拟机时，虚拟机虽然启动成功了，却一直停留在下面这个画面：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion7.png\" alt=\"这里写图片描述\"><br>本以为进度到了74之后就会结束，进入系统的，结果是我太天真…<br>进度到了74之后，黑屏，显示一个“Android”字样，然后又重复开始从1到74，就这样不停重复不停重复，根本无法使用虚拟机。<br>于是又在网上搜罗相关的解决办法，最后算是找到了：<code>安装HAXM</code>。</p>\n</li>\n</ul>\n<ol>\n<li>首先进入BIOS开启intel虚拟加速。不同的品牌电脑设置界面不同，这个自行百度。</li>\n<li>需要在SDK Manager里面下载Intel x86 Emulator Accelator。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion8.png\" alt=\"这里写图片描述\"></li>\n<li>下载完成之后，找到相关安装文件进行安装。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion9.png\" alt=\"这里写图片描述\"></li>\n<li>进入cmd，输入命令【sc query intelhaxm】查看intelhaxm状态。没有开启的话，输入【sc start intelhaxm】即可进行开启。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion10.png\" alt=\"这里写图片描述\"><br>通过以上步骤，我的安卓5.1虚拟机，总算是成功跑起来了！！！<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion11.png\" alt=\"这里写图片描述\"></li>\n</ol>\n<ul>\n<li>后面回到家里，也通过上述一些操作，但是却仍然启动失败！！！后面打开VirtualBox，从VirtualBox启动虚拟机，报如下的错误：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion12.png\" alt=\"这里写图片描述\"><br>后面网上找到该错误的原因，是因为系统破解，system32文件夹下的uxtheme.dll文件出问题。在网上下载电脑相应64位或32位的未破解的uxtheme.dll文件，替换到system32里去，然后重新启动虚拟机，成功！也可以下载下面的破解还原工具，还原破解。<br><a href=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotiontheme%28win7X64%29.zip\" target=\"_blank\" rel=\"external\">破解还原工具</a><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion13.png\" alt=\"这里写图片描述\"></li>\n<li>使用Genymotion安装APK出现错误INSTALL_FAILED_CPU_ABI_INCOMPATIBLE，解决办法如下：下载<a href=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotionGenymotion-ARM-Translation.zip\" target=\"_blank\" rel=\"external\">这个Zip</a>，不要解压，直接拖到虚拟机窗口中。对，你没有看错，就是直接拖进去。然后重启虚拟机就可以了。</li>\n</ul>\n","excerpt":"<p>在学习Android Studio的过程中，看到网上很多人都推荐使用Genymotion插件，在某些无法使用真机的情况下，这个模拟器插件能大大加快模拟器的运行速度。而且由于没有Android 5.0以上的真机，使用Genymotion可以运行Android 5.0以上的模拟器，看看Meterial Design的设计，所谓一举两得，于是便开始了一波Genymotion的学习。</p>\n<hr>\n<h3 id=\"安装Genymotion\"><a href=\"#安装Genymotion\" class=\"headerlink\" title=\"安装Genymotion\"></a>安装Genymotion</h3><p>安装Genymotion。进入到官网，下载Genymotion，没有安装Virtual Box的，选择带有Virtual Box的安装文件进行下载。下载成功后，安装，基本都是下一步，下一步。</p>\n<h3 id=\"Android-Studio使用Genymotion插件\"><a href=\"#Android-Studio使用Genymotion插件\" class=\"headerlink\" title=\"Android Studio使用Genymotion插件\"></a>Android Studio使用Genymotion插件</h3><ol>\n<li><p>Android Studio安装Genymotion插件。安装过程很简单，网上一搜一大把，就不赘述了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion1.png\" alt=\"这里写图片描述\"></p>\n</li>\n<li><p>将Genymotion路径配置到Android Studio中。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion2.png\" alt=\"这里写图片描述\"></p>\n</li>\n<li><p>启动Genymotion插件，选择要配置的机型，系统，点击Next，等待下载，安装，部署结束之后，启动模拟器即可进行使用了。</p>\n</li>\n</ol>","more":"<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><ul>\n<li><p>在选择好机型后，点击Next时，一直在Downloading files界面，最后弹出”Connection timeout occurred”，提示创建虚拟机失败。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion3.png\" alt=\"这里写图片描述\"><br>出现这种情况，主要是下载的ova文件无法正常下载下来。打开日志文件（路径：C:\\Users\\Administrator\\AppData\\Local\\Genymobile\\genymotion.log），可以看到类似的log：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion4.png\" alt=\"这里写图片描述\"><br>拷贝出.ova的那个地址，下载好这个ova文件后，替换到C:\\Users\\Administrator\\AppData\\Local\\Genymobile\\Genymotion\\ova文件夹中即可。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion14.png\" alt=\"这里写图片描述\"><br>在我的情形中，是由于公司网速太慢导致QAQ…后面在寝室一下就好了~</p>\n</li>\n<li><p>创建好虚拟机后，启动失败。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion5.png\" alt=\"这里写图片描述\"><br>网上查了许多解决方法，诸如修改Ip的一些等等，但是并不适用于我的情况。后面找到了解决方法：减少虚拟机内存！<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion6.png\" alt=\"这里写图片描述\"><br>打开Virtual Box，找到相应的虚拟机，打开设置-&gt;系统，将内存大小从2048改成1024后，虚拟机启动成功！</p>\n</li>\n<li><p>但是当我创建安卓5.0以上的虚拟机时，虚拟机虽然启动成功了，却一直停留在下面这个画面：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion7.png\" alt=\"这里写图片描述\"><br>本以为进度到了74之后就会结束，进入系统的，结果是我太天真…<br>进度到了74之后，黑屏，显示一个“Android”字样，然后又重复开始从1到74，就这样不停重复不停重复，根本无法使用虚拟机。<br>于是又在网上搜罗相关的解决办法，最后算是找到了：<code>安装HAXM</code>。</p>\n</li>\n</ul>\n<ol>\n<li>首先进入BIOS开启intel虚拟加速。不同的品牌电脑设置界面不同，这个自行百度。</li>\n<li>需要在SDK Manager里面下载Intel x86 Emulator Accelator。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion8.png\" alt=\"这里写图片描述\"></li>\n<li>下载完成之后，找到相关安装文件进行安装。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion9.png\" alt=\"这里写图片描述\"></li>\n<li>进入cmd，输入命令【sc query intelhaxm】查看intelhaxm状态。没有开启的话，输入【sc start intelhaxm】即可进行开启。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion10.png\" alt=\"这里写图片描述\"><br>通过以上步骤，我的安卓5.1虚拟机，总算是成功跑起来了！！！<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion11.png\" alt=\"这里写图片描述\"></li>\n</ol>\n<ul>\n<li>后面回到家里，也通过上述一些操作，但是却仍然启动失败！！！后面打开VirtualBox，从VirtualBox启动虚拟机，报如下的错误：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion12.png\" alt=\"这里写图片描述\"><br>后面网上找到该错误的原因，是因为系统破解，system32文件夹下的uxtheme.dll文件出问题。在网上下载电脑相应64位或32位的未破解的uxtheme.dll文件，替换到system32里去，然后重新启动虚拟机，成功！也可以下载下面的破解还原工具，还原破解。<br><a href=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotiontheme%28win7X64%29.zip\">破解还原工具</a><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotion13.png\" alt=\"这里写图片描述\"></li>\n<li>使用Genymotion安装APK出现错误INSTALL_FAILED_CPU_ABI_INCOMPATIBLE，解决办法如下：下载<a href=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/genymotionGenymotion-ARM-Translation.zip\">这个Zip</a>，不要解压，直接拖到虚拟机窗口中。对，你没有看错，就是直接拖进去。然后重启虚拟机就可以了。</li>\n</ul>"},{"title":"Android Studio使用Gradle进行多渠道打包","date":"2016-03-09T06:39:58.000Z","_content":"\n使用Android Studio也有一段时间了，最近项目开发完成，内部测试也已经通过。下一步就是渠道打包，然后上线了。\n\n在出渠道包的时候，若是出一个包，便手动修改一次渠道号，很显然是很费时费力的。庆幸的是，Android Studio采用的Gradle可以很方便的实现我们的多渠道出包。\n\n下面结合代码进行说明。\n\n项目中使用的是友盟，在AndroidManifest.xml中有这样的代码：\n```\n<meta-data android:name=\"UMENG_CHANNEL\" android:value=\"${UMENG_CHANNEL_VALUE}\" />\n```\n其中${UMENG_CHANNEL_VALUE}中的值就是在gradle中自定义配置的值。\n\n<!--more-->\n\n然后在项目的build.gradle中利用productFlavors进行多渠道的配置，在android节点下添加如下代码：\n```\nproductFlavors {\n        official {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"official\"]\n        }\n        baidu {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"baidu\"]\n        }\n        _360 {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"_360\"]\n        }\n        samsung {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"samsung\"]\n        }\n        huawei {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"huawei\"]\n        }\n        lenovo {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"lenovo\"]\n        }\n    }\n```\n项目实际情况，便是上线百度、360、三星、华为、联想这5个市场。\n\n至此，所有的配置已经完成。下面开始编译出包了。\n\n在Android Studio中打开Terminal：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack1.png)\n输入指令``gradlew assembleRelease``便可以生成所有的渠道包了。但是此次命令中使用的gradle版本无法控制，很有可能会去下其他的gradle版本，gradle的下载需要翻墙，若是没翻则会一直下载，耽误时间。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack2.png)\n这里我们直接ctrl+c，再输入y，终止操作。使用下面的方法。\n\n先找到gralde的根目录，在系统变量里添加两个环境变量：\n\n变量名为GRADLE_HOME，变量值就为gradle的根目录。在我的环境里，使用的gradle 2.2.1的版本，目录是C:\\Users\\*****\\.gradle\\wrapper\\dists\\gradle-2.2.1-all\\c64ydeuardnfqctvr1gm30w53\\gradle-2.2.1。\n\n然后在系统变量path里面添加gradle的bin目录%GRADLE_HOME%\\bin。\n\n这里配置完成了，接着在Terminal中敲下``gradle assembleRelease``就可以一次性生成所有的渠道包了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack3.png)\nbuild成功后，便可生成所有渠道的渠道包了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack4.png)\n若是想单独生成某一个渠道包，先打开Android Studio右侧的Gradle栏：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack5.png)\n点到相应项目的build task中。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack6.png)\n要生成什么渠道包，双击相应的栏目即可。\n\n---\n改进：将productFlavors改成如下，更加简洁些：\n```\nproductFlavors {\n        \"official\" {}\n        \"baidu\" {}\n        \"_360\" {}\n        \"samsung\" {}\n        \"huawei\" {}\n        \"lenovo\" {}\n    }\n\n    productFlavors.all {\n        flavor -> flavor.manifestPlaceholders = [UMENG_CHANNEL_VALUE: name]\n    }\n```\n","source":"_posts/gradle-pack.md","raw":"---\ntitle: Android Studio使用Gradle进行多渠道打包\ndate: 2016-03-09 14:39:58\ntags:\n - android studio\n---\n\n使用Android Studio也有一段时间了，最近项目开发完成，内部测试也已经通过。下一步就是渠道打包，然后上线了。\n\n在出渠道包的时候，若是出一个包，便手动修改一次渠道号，很显然是很费时费力的。庆幸的是，Android Studio采用的Gradle可以很方便的实现我们的多渠道出包。\n\n下面结合代码进行说明。\n\n项目中使用的是友盟，在AndroidManifest.xml中有这样的代码：\n```\n<meta-data android:name=\"UMENG_CHANNEL\" android:value=\"${UMENG_CHANNEL_VALUE}\" />\n```\n其中${UMENG_CHANNEL_VALUE}中的值就是在gradle中自定义配置的值。\n\n<!--more-->\n\n然后在项目的build.gradle中利用productFlavors进行多渠道的配置，在android节点下添加如下代码：\n```\nproductFlavors {\n        official {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"official\"]\n        }\n        baidu {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"baidu\"]\n        }\n        _360 {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"_360\"]\n        }\n        samsung {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"samsung\"]\n        }\n        huawei {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"huawei\"]\n        }\n        lenovo {\n            manifestPlaceholders = [UMENG_CHANNEL_VALUE: \"lenovo\"]\n        }\n    }\n```\n项目实际情况，便是上线百度、360、三星、华为、联想这5个市场。\n\n至此，所有的配置已经完成。下面开始编译出包了。\n\n在Android Studio中打开Terminal：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack1.png)\n输入指令``gradlew assembleRelease``便可以生成所有的渠道包了。但是此次命令中使用的gradle版本无法控制，很有可能会去下其他的gradle版本，gradle的下载需要翻墙，若是没翻则会一直下载，耽误时间。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack2.png)\n这里我们直接ctrl+c，再输入y，终止操作。使用下面的方法。\n\n先找到gralde的根目录，在系统变量里添加两个环境变量：\n\n变量名为GRADLE_HOME，变量值就为gradle的根目录。在我的环境里，使用的gradle 2.2.1的版本，目录是C:\\Users\\*****\\.gradle\\wrapper\\dists\\gradle-2.2.1-all\\c64ydeuardnfqctvr1gm30w53\\gradle-2.2.1。\n\n然后在系统变量path里面添加gradle的bin目录%GRADLE_HOME%\\bin。\n\n这里配置完成了，接着在Terminal中敲下``gradle assembleRelease``就可以一次性生成所有的渠道包了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack3.png)\nbuild成功后，便可生成所有渠道的渠道包了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack4.png)\n若是想单独生成某一个渠道包，先打开Android Studio右侧的Gradle栏：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack5.png)\n点到相应项目的build task中。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack6.png)\n要生成什么渠道包，双击相应的栏目即可。\n\n---\n改进：将productFlavors改成如下，更加简洁些：\n```\nproductFlavors {\n        \"official\" {}\n        \"baidu\" {}\n        \"_360\" {}\n        \"samsung\" {}\n        \"huawei\" {}\n        \"lenovo\" {}\n    }\n\n    productFlavors.all {\n        flavor -> flavor.manifestPlaceholders = [UMENG_CHANNEL_VALUE: name]\n    }\n```\n","slug":"gradle-pack","published":1,"updated":"2016-11-21T09:59:25.965Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758q00101cb82s3fi4fa","content":"<p>使用Android Studio也有一段时间了，最近项目开发完成，内部测试也已经通过。下一步就是渠道打包，然后上线了。</p>\n<p>在出渠道包的时候，若是出一个包，便手动修改一次渠道号，很显然是很费时费力的。庆幸的是，Android Studio采用的Gradle可以很方便的实现我们的多渠道出包。</p>\n<p>下面结合代码进行说明。</p>\n<p>项目中使用的是友盟，在AndroidManifest.xml中有这样的代码：<br><figure class=\"highlight dust\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">meta-data</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"UMENG_CHANNEL\"</span> <span class=\"attr\">android:value</span>=<span class=\"string\">\"$</span></span></span><span class=\"template-variable\">&#123;UMENG_CHANNEL_VALUE&#125;</span><span class=\"xml\"><span class=\"tag\"><span class=\"string\">\"</span> /&gt;</span></span></div></pre></td></tr></table></figure></p>\n<p>其中${UMENG_CHANNEL_VALUE}中的值就是在gradle中自定义配置的值。</p>\n<a id=\"more\"></a>\n<p>然后在项目的build.gradle中利用productFlavors进行多渠道的配置，在android节点下添加如下代码：<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">productFlavors</span> &#123;</div><div class=\"line\">        <span class=\"section\">official</span> &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"official\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        baidu &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"baidu\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        _360 &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"_360\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        samsung &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"samsung\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        huawei &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"huawei\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        lenovo &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"lenovo\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>项目实际情况，便是上线百度、360、三星、华为、联想这5个市场。</p>\n<p>至此，所有的配置已经完成。下面开始编译出包了。</p>\n<p>在Android Studio中打开Terminal：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack1.png\" alt=\"\"><br>输入指令<code>gradlew assembleRelease</code>便可以生成所有的渠道包了。但是此次命令中使用的gradle版本无法控制，很有可能会去下其他的gradle版本，gradle的下载需要翻墙，若是没翻则会一直下载，耽误时间。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack2.png\" alt=\"\"><br>这里我们直接ctrl+c，再输入y，终止操作。使用下面的方法。</p>\n<p>先找到gralde的根目录，在系统变量里添加两个环境变量：</p>\n<p>变量名为GRADLE_HOME，变量值就为gradle的根目录。在我的环境里，使用的gradle 2.2.1的版本，目录是C:\\Users*<em>**</em>.gradle\\wrapper\\dists\\gradle-2.2.1-all\\c64ydeuardnfqctvr1gm30w53\\gradle-2.2.1。</p>\n<p>然后在系统变量path里面添加gradle的bin目录%GRADLE_HOME%\\bin。</p>\n<p>这里配置完成了，接着在Terminal中敲下<code>gradle assembleRelease</code>就可以一次性生成所有的渠道包了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack3.png\" alt=\"\"><br>build成功后，便可生成所有渠道的渠道包了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack4.png\" alt=\"\"><br>若是想单独生成某一个渠道包，先打开Android Studio右侧的Gradle栏：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack5.png\" alt=\"\"><br>点到相应项目的build task中。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack6.png\" alt=\"\"><br>要生成什么渠道包，双击相应的栏目即可。</p>\n<hr>\n<p>改进：将productFlavors改成如下，更加简洁些：<br><figure class=\"highlight xquery\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">productFlavors &#123;</div><div class=\"line\">        <span class=\"string\">\"official\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"baidu\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"_360\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"samsung\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"huawei\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"lenovo\"</span> &#123;&#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    productFlavors.all &#123;</div><div class=\"line\">        flavor -&gt; flavor.manifestPlaceholders = [UMENG_CHANNEL_VALUE: name]</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n","excerpt":"<p>使用Android Studio也有一段时间了，最近项目开发完成，内部测试也已经通过。下一步就是渠道打包，然后上线了。</p>\n<p>在出渠道包的时候，若是出一个包，便手动修改一次渠道号，很显然是很费时费力的。庆幸的是，Android Studio采用的Gradle可以很方便的实现我们的多渠道出包。</p>\n<p>下面结合代码进行说明。</p>\n<p>项目中使用的是友盟，在AndroidManifest.xml中有这样的代码：<br><figure class=\"highlight dust\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">meta-data</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"UMENG_CHANNEL\"</span> <span class=\"attr\">android:value</span>=<span class=\"string\">\"$</span></span></span><span class=\"template-variable\">&#123;UMENG_CHANNEL_VALUE&#125;</span><span class=\"xml\"><span class=\"tag\"><span class=\"string\">\"</span> /&gt;</span></span></div></pre></td></tr></table></figure></p>\n<p>其中${UMENG_CHANNEL_VALUE}中的值就是在gradle中自定义配置的值。</p>","more":"<p>然后在项目的build.gradle中利用productFlavors进行多渠道的配置，在android节点下添加如下代码：<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">productFlavors</span> &#123;</div><div class=\"line\">        <span class=\"section\">official</span> &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"official\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        baidu &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"baidu\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        _360 &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"_360\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        samsung &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"samsung\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        huawei &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"huawei\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">        lenovo &#123;</div><div class=\"line\">            <span class=\"attribute\">manifestPlaceholders</span> = [UMENG_CHANNEL_VALUE: <span class=\"string\">\"lenovo\"</span>]</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>项目实际情况，便是上线百度、360、三星、华为、联想这5个市场。</p>\n<p>至此，所有的配置已经完成。下面开始编译出包了。</p>\n<p>在Android Studio中打开Terminal：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack1.png\" alt=\"\"><br>输入指令<code>gradlew assembleRelease</code>便可以生成所有的渠道包了。但是此次命令中使用的gradle版本无法控制，很有可能会去下其他的gradle版本，gradle的下载需要翻墙，若是没翻则会一直下载，耽误时间。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack2.png\" alt=\"\"><br>这里我们直接ctrl+c，再输入y，终止操作。使用下面的方法。</p>\n<p>先找到gralde的根目录，在系统变量里添加两个环境变量：</p>\n<p>变量名为GRADLE_HOME，变量值就为gradle的根目录。在我的环境里，使用的gradle 2.2.1的版本，目录是C:\\Users*<em>**</em>.gradle\\wrapper\\dists\\gradle-2.2.1-all\\c64ydeuardnfqctvr1gm30w53\\gradle-2.2.1。</p>\n<p>然后在系统变量path里面添加gradle的bin目录%GRADLE_HOME%\\bin。</p>\n<p>这里配置完成了，接着在Terminal中敲下<code>gradle assembleRelease</code>就可以一次性生成所有的渠道包了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack3.png\" alt=\"\"><br>build成功后，便可生成所有渠道的渠道包了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack4.png\" alt=\"\"><br>若是想单独生成某一个渠道包，先打开Android Studio右侧的Gradle栏：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack5.png\" alt=\"\"><br>点到相应项目的build task中。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/gradle-pack6.png\" alt=\"\"><br>要生成什么渠道包，双击相应的栏目即可。</p>\n<hr>\n<p>改进：将productFlavors改成如下，更加简洁些：<br><figure class=\"highlight xquery\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">productFlavors &#123;</div><div class=\"line\">        <span class=\"string\">\"official\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"baidu\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"_360\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"samsung\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"huawei\"</span> &#123;&#125;</div><div class=\"line\">        <span class=\"string\">\"lenovo\"</span> &#123;&#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    productFlavors.all &#123;</div><div class=\"line\">        flavor -&gt; flavor.manifestPlaceholders = [UMENG_CHANNEL_VALUE: name]</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>"},{"title":"Windows使用Hexo + Github Pages搭建自己的博客","date":"2016-03-17T03:30:45.000Z","_content":"\n本文主要讲述一下Windows环境使用Hexo + Github Pages搭建自己博客的一些主要步骤。\n## 介绍\n### Hexo\nhexo是一个基于Node.js的静态博客程序，可以方便的生成静态网页托管在Github上。\n\n> A fast, simple & powerful blog framework\n\n1. 超快的速度：Node.js 所带来的超快生成速度，让上百个页面在几秒内瞬间完成渲染。\n2. 支持 Markdown：Hexo 支持 GitHub Flavored Markdown 的所有功能，甚至可以整合 Octopress 的大多数插件。\n3. 一键部署：只需一条指令即可部署到 GitHub Pages, Heroku 或其他网站。\n4. 丰富的插件：Hexo 拥有强大的插件系统，安装插件可以让 Hexo 支持 Jade, CoffeeScript。\n\n### Github Pages\nGitHub Pages本用于介绍托管在GitHub的项目， 不过，由于他的空间免费稳定，用来做搭建一个博客再好不过了。\n\n> Websites for you and your projects.\n\n1. Github Pages 有300M免费空间，资料自己管理，保存可靠；\n2. Github作为最大的同性交流社区，已经得到了人们的肯定；\n3. Github上有很多大牛，学着用 Github ，享受 GitHub 的便利，眼界会开阔很多。\n\n<!--more-->\n\n## 前期准备\n### 安装Git\n去 [Git](https://git-scm.com/) 官网下载相应版本，进行安装即可。\n### 安装Node.js\n去 [NodeJs](https://nodejs.org/en/) 官网下载相应版本，进行安装即可。\n### 注册Github账号\n去 [Github](https://github.com/) 官网进行注册即可。\n注册完之后记得添加 [SSH Key](https://help.github.com/articles/generating-an-ssh-key/)。\n\n## 搭建博客\n### 安装Hexo\n在本地新建一个blog文件夹，右键，选择Git Bash。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog3.png)\n输入指令安装Hexo：\n\n```\nnpm install -g hexo\n```\n等到完成之后，输入指令初始化Hexo：\n\n```\nhexo init Hexo\n```\n完成之后，便能在blog文件夹下看到hexo文件夹了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog4.png)\n\n进入到hexo目录，输入指令npm install，安装依赖文件\n\n```\n$ cd hexo\n$ npm install\n```\n安装完成之后，输入指令部署：\n\n```\n$ hexo generate\n$ hexo server\n```\n此时打开浏览器，输入``http://localhost:4000/``便可看到最原始的博客了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog1.png)\n\n此时，Hexo已搭建完毕。\n\n### GitHub创建仓库\n登录Github，点击New respository。\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog6.png)\n\n输入仓库名：你的Github名称.github.io。然后点击Create repository。\n图中因为我已经创建，故给出提示，不用管。\n\n### 托管到Github\n打开hexo配置文件_config.yml。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog5.png)\n\n编辑deploy属性：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog7.png)\nrepository属性改成你的git地址即可。\n\n然后Git Bash进入到hexo文件夹，输入指令即可完成部署：\n\n```\n$ hexo clean\n$ hexo generate\n$ hexo deploy\n```\n最后，打开你的github.io页面看下效果吧~\n","source":"_posts/hexo-blog.md","raw":"---\ntitle: Windows使用Hexo + Github Pages搭建自己的博客\ndate: 2016-03-17 11:30:45\ntags:\n - blog\n---\n\n本文主要讲述一下Windows环境使用Hexo + Github Pages搭建自己博客的一些主要步骤。\n## 介绍\n### Hexo\nhexo是一个基于Node.js的静态博客程序，可以方便的生成静态网页托管在Github上。\n\n> A fast, simple & powerful blog framework\n\n1. 超快的速度：Node.js 所带来的超快生成速度，让上百个页面在几秒内瞬间完成渲染。\n2. 支持 Markdown：Hexo 支持 GitHub Flavored Markdown 的所有功能，甚至可以整合 Octopress 的大多数插件。\n3. 一键部署：只需一条指令即可部署到 GitHub Pages, Heroku 或其他网站。\n4. 丰富的插件：Hexo 拥有强大的插件系统，安装插件可以让 Hexo 支持 Jade, CoffeeScript。\n\n### Github Pages\nGitHub Pages本用于介绍托管在GitHub的项目， 不过，由于他的空间免费稳定，用来做搭建一个博客再好不过了。\n\n> Websites for you and your projects.\n\n1. Github Pages 有300M免费空间，资料自己管理，保存可靠；\n2. Github作为最大的同性交流社区，已经得到了人们的肯定；\n3. Github上有很多大牛，学着用 Github ，享受 GitHub 的便利，眼界会开阔很多。\n\n<!--more-->\n\n## 前期准备\n### 安装Git\n去 [Git](https://git-scm.com/) 官网下载相应版本，进行安装即可。\n### 安装Node.js\n去 [NodeJs](https://nodejs.org/en/) 官网下载相应版本，进行安装即可。\n### 注册Github账号\n去 [Github](https://github.com/) 官网进行注册即可。\n注册完之后记得添加 [SSH Key](https://help.github.com/articles/generating-an-ssh-key/)。\n\n## 搭建博客\n### 安装Hexo\n在本地新建一个blog文件夹，右键，选择Git Bash。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog3.png)\n输入指令安装Hexo：\n\n```\nnpm install -g hexo\n```\n等到完成之后，输入指令初始化Hexo：\n\n```\nhexo init Hexo\n```\n完成之后，便能在blog文件夹下看到hexo文件夹了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog4.png)\n\n进入到hexo目录，输入指令npm install，安装依赖文件\n\n```\n$ cd hexo\n$ npm install\n```\n安装完成之后，输入指令部署：\n\n```\n$ hexo generate\n$ hexo server\n```\n此时打开浏览器，输入``http://localhost:4000/``便可看到最原始的博客了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog1.png)\n\n此时，Hexo已搭建完毕。\n\n### GitHub创建仓库\n登录Github，点击New respository。\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog6.png)\n\n输入仓库名：你的Github名称.github.io。然后点击Create repository。\n图中因为我已经创建，故给出提示，不用管。\n\n### 托管到Github\n打开hexo配置文件_config.yml。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog5.png)\n\n编辑deploy属性：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog7.png)\nrepository属性改成你的git地址即可。\n\n然后Git Bash进入到hexo文件夹，输入指令即可完成部署：\n\n```\n$ hexo clean\n$ hexo generate\n$ hexo deploy\n```\n最后，打开你的github.io页面看下效果吧~\n","slug":"hexo-blog","published":1,"updated":"2016-11-21T09:59:29.271Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758r00131cb8v7mwx6ol","content":"<p>本文主要讲述一下Windows环境使用Hexo + Github Pages搭建自己博客的一些主要步骤。</p>\n<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><h3 id=\"Hexo\"><a href=\"#Hexo\" class=\"headerlink\" title=\"Hexo\"></a>Hexo</h3><p>hexo是一个基于Node.js的静态博客程序，可以方便的生成静态网页托管在Github上。</p>\n<blockquote>\n<p>A fast, simple &amp; powerful blog framework</p>\n</blockquote>\n<ol>\n<li>超快的速度：Node.js 所带来的超快生成速度，让上百个页面在几秒内瞬间完成渲染。</li>\n<li>支持 Markdown：Hexo 支持 GitHub Flavored Markdown 的所有功能，甚至可以整合 Octopress 的大多数插件。</li>\n<li>一键部署：只需一条指令即可部署到 GitHub Pages, Heroku 或其他网站。</li>\n<li>丰富的插件：Hexo 拥有强大的插件系统，安装插件可以让 Hexo 支持 Jade, CoffeeScript。</li>\n</ol>\n<h3 id=\"Github-Pages\"><a href=\"#Github-Pages\" class=\"headerlink\" title=\"Github Pages\"></a>Github Pages</h3><p>GitHub Pages本用于介绍托管在GitHub的项目， 不过，由于他的空间免费稳定，用来做搭建一个博客再好不过了。</p>\n<blockquote>\n<p>Websites for you and your projects.</p>\n</blockquote>\n<ol>\n<li>Github Pages 有300M免费空间，资料自己管理，保存可靠；</li>\n<li>Github作为最大的同性交流社区，已经得到了人们的肯定；</li>\n<li>Github上有很多大牛，学着用 Github ，享受 GitHub 的便利，眼界会开阔很多。</li>\n</ol>\n<a id=\"more\"></a>\n<h2 id=\"前期准备\"><a href=\"#前期准备\" class=\"headerlink\" title=\"前期准备\"></a>前期准备</h2><h3 id=\"安装Git\"><a href=\"#安装Git\" class=\"headerlink\" title=\"安装Git\"></a>安装Git</h3><p>去 <a href=\"https://git-scm.com/\" target=\"_blank\" rel=\"external\">Git</a> 官网下载相应版本，进行安装即可。</p>\n<h3 id=\"安装Node-js\"><a href=\"#安装Node-js\" class=\"headerlink\" title=\"安装Node.js\"></a>安装Node.js</h3><p>去 <a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"external\">NodeJs</a> 官网下载相应版本，进行安装即可。</p>\n<h3 id=\"注册Github账号\"><a href=\"#注册Github账号\" class=\"headerlink\" title=\"注册Github账号\"></a>注册Github账号</h3><p>去 <a href=\"https://github.com/\" target=\"_blank\" rel=\"external\">Github</a> 官网进行注册即可。<br>注册完之后记得添加 <a href=\"https://help.github.com/articles/generating-an-ssh-key/\" target=\"_blank\" rel=\"external\">SSH Key</a>。</p>\n<h2 id=\"搭建博客\"><a href=\"#搭建博客\" class=\"headerlink\" title=\"搭建博客\"></a>搭建博客</h2><h3 id=\"安装Hexo\"><a href=\"#安装Hexo\" class=\"headerlink\" title=\"安装Hexo\"></a>安装Hexo</h3><p>在本地新建一个blog文件夹，右键，选择Git Bash。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog3.png\" alt=\"这里写图片描述\"><br>输入指令安装Hexo：</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">npm <span class=\"keyword\">install</span> -g hexo</div></pre></td></tr></table></figure>\n<p>等到完成之后，输入指令初始化Hexo：</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">hexo init Hexo</span></div></pre></td></tr></table></figure>\n<p>完成之后，便能在blog文件夹下看到hexo文件夹了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog4.png\" alt=\"这里写图片描述\"></p>\n<p>进入到hexo目录，输入指令npm install，安装依赖文件</p>\n<figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"variable\">$ </span>cd hexo</div><div class=\"line\"><span class=\"variable\">$ </span>npm install</div></pre></td></tr></table></figure>\n<p>安装完成之后，输入指令部署：</p>\n<figure class=\"highlight verilog\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo <span class=\"keyword\">generate</span></div><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>此时打开浏览器，输入<code>http://localhost:4000/</code>便可看到最原始的博客了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog1.png\" alt=\"这里写图片描述\"></p>\n<p>此时，Hexo已搭建完毕。</p>\n<h3 id=\"GitHub创建仓库\"><a href=\"#GitHub创建仓库\" class=\"headerlink\" title=\"GitHub创建仓库\"></a>GitHub创建仓库</h3><p>登录Github，点击New respository。</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog6.png\" alt=\"这里写图片描述\"></p>\n<p>输入仓库名：你的Github名称.github.io。然后点击Create repository。<br>图中因为我已经创建，故给出提示，不用管。</p>\n<h3 id=\"托管到Github\"><a href=\"#托管到Github\" class=\"headerlink\" title=\"托管到Github\"></a>托管到Github</h3><p>打开hexo配置文件_config.yml。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog5.png\" alt=\"这里写图片描述\"></p>\n<p>编辑deploy属性：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog7.png\" alt=\"这里写图片描述\"><br>repository属性改成你的git地址即可。</p>\n<p>然后Git Bash进入到hexo文件夹，输入指令即可完成部署：</p>\n<figure class=\"highlight verilog\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo clean</div><div class=\"line\">$ hexo <span class=\"keyword\">generate</span></div><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>最后，打开你的github.io页面看下效果吧~</p>\n","excerpt":"<p>本文主要讲述一下Windows环境使用Hexo + Github Pages搭建自己博客的一些主要步骤。</p>\n<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><h3 id=\"Hexo\"><a href=\"#Hexo\" class=\"headerlink\" title=\"Hexo\"></a>Hexo</h3><p>hexo是一个基于Node.js的静态博客程序，可以方便的生成静态网页托管在Github上。</p>\n<blockquote>\n<p>A fast, simple &amp; powerful blog framework</p>\n</blockquote>\n<ol>\n<li>超快的速度：Node.js 所带来的超快生成速度，让上百个页面在几秒内瞬间完成渲染。</li>\n<li>支持 Markdown：Hexo 支持 GitHub Flavored Markdown 的所有功能，甚至可以整合 Octopress 的大多数插件。</li>\n<li>一键部署：只需一条指令即可部署到 GitHub Pages, Heroku 或其他网站。</li>\n<li>丰富的插件：Hexo 拥有强大的插件系统，安装插件可以让 Hexo 支持 Jade, CoffeeScript。</li>\n</ol>\n<h3 id=\"Github-Pages\"><a href=\"#Github-Pages\" class=\"headerlink\" title=\"Github Pages\"></a>Github Pages</h3><p>GitHub Pages本用于介绍托管在GitHub的项目， 不过，由于他的空间免费稳定，用来做搭建一个博客再好不过了。</p>\n<blockquote>\n<p>Websites for you and your projects.</p>\n</blockquote>\n<ol>\n<li>Github Pages 有300M免费空间，资料自己管理，保存可靠；</li>\n<li>Github作为最大的同性交流社区，已经得到了人们的肯定；</li>\n<li>Github上有很多大牛，学着用 Github ，享受 GitHub 的便利，眼界会开阔很多。</li>\n</ol>","more":"<h2 id=\"前期准备\"><a href=\"#前期准备\" class=\"headerlink\" title=\"前期准备\"></a>前期准备</h2><h3 id=\"安装Git\"><a href=\"#安装Git\" class=\"headerlink\" title=\"安装Git\"></a>安装Git</h3><p>去 <a href=\"https://git-scm.com/\">Git</a> 官网下载相应版本，进行安装即可。</p>\n<h3 id=\"安装Node-js\"><a href=\"#安装Node-js\" class=\"headerlink\" title=\"安装Node.js\"></a>安装Node.js</h3><p>去 <a href=\"https://nodejs.org/en/\">NodeJs</a> 官网下载相应版本，进行安装即可。</p>\n<h3 id=\"注册Github账号\"><a href=\"#注册Github账号\" class=\"headerlink\" title=\"注册Github账号\"></a>注册Github账号</h3><p>去 <a href=\"https://github.com/\">Github</a> 官网进行注册即可。<br>注册完之后记得添加 <a href=\"https://help.github.com/articles/generating-an-ssh-key/\">SSH Key</a>。</p>\n<h2 id=\"搭建博客\"><a href=\"#搭建博客\" class=\"headerlink\" title=\"搭建博客\"></a>搭建博客</h2><h3 id=\"安装Hexo\"><a href=\"#安装Hexo\" class=\"headerlink\" title=\"安装Hexo\"></a>安装Hexo</h3><p>在本地新建一个blog文件夹，右键，选择Git Bash。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog3.png\" alt=\"这里写图片描述\"><br>输入指令安装Hexo：</p>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">npm <span class=\"keyword\">install</span> -g hexo</div></pre></td></tr></table></figure>\n<p>等到完成之后，输入指令初始化Hexo：</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">hexo init Hexo</span></div></pre></td></tr></table></figure>\n<p>完成之后，便能在blog文件夹下看到hexo文件夹了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog4.png\" alt=\"这里写图片描述\"></p>\n<p>进入到hexo目录，输入指令npm install，安装依赖文件</p>\n<figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"variable\">$ </span>cd hexo</div><div class=\"line\"><span class=\"variable\">$ </span>npm install</div></pre></td></tr></table></figure>\n<p>安装完成之后，输入指令部署：</p>\n<figure class=\"highlight verilog\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo <span class=\"keyword\">generate</span></div><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>此时打开浏览器，输入<code>http://localhost:4000/</code>便可看到最原始的博客了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog1.png\" alt=\"这里写图片描述\"></p>\n<p>此时，Hexo已搭建完毕。</p>\n<h3 id=\"GitHub创建仓库\"><a href=\"#GitHub创建仓库\" class=\"headerlink\" title=\"GitHub创建仓库\"></a>GitHub创建仓库</h3><p>登录Github，点击New respository。</p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog6.png\" alt=\"这里写图片描述\"></p>\n<p>输入仓库名：你的Github名称.github.io。然后点击Create repository。<br>图中因为我已经创建，故给出提示，不用管。</p>\n<h3 id=\"托管到Github\"><a href=\"#托管到Github\" class=\"headerlink\" title=\"托管到Github\"></a>托管到Github</h3><p>打开hexo配置文件_config.yml。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog5.png\" alt=\"这里写图片描述\"></p>\n<p>编辑deploy属性：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-blog7.png\" alt=\"这里写图片描述\"><br>repository属性改成你的git地址即可。</p>\n<p>然后Git Bash进入到hexo文件夹，输入指令即可完成部署：</p>\n<figure class=\"highlight verilog\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo clean</div><div class=\"line\">$ hexo <span class=\"keyword\">generate</span></div><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>最后，打开你的github.io页面看下效果吧~</p>"},{"title":"Hexo-Tips","date":"2016-03-17T04:23:14.000Z","_content":"\n本文主要讲述一下使用Hexo搭建博客的一些Tips。\n## hexo基本指令\n1. hexo clean 清除\n2. hexo new page \"menu name\" 新建菜单\n3. hexo g == hexo generate 生成\n4. hexo d == hexo deploy 部署\n5. hexo s == hexo server 启动本地\n6. hexo n == hexo new 新建\n\n## 首页文章显示\n在md文件中添加``<!--more-->``，那么首页就只会显示这个标签之上的内容了，并显示一个``阅读全文``的按钮。\n\n## 部署到Github保证README.md不被渲染\n1. 在Hexo目录下的source根目录下创建README.md文件,并编辑保存。\n2. 编辑Hexo目录的_config.yml文件中的“skip_render”参数。\n```\nskip_render: README.md\n```\n3. 部署到Github，然后看仓库是否有README.md。\n\n<!--more-->\n\n## 博客基本配置\n打开hexo目录下的``_config.yml``文件。\n```\n# Hexo Configuration\n## Docs: https://hexo.io/docs/configuration.html\n## Source: https://github.com/hexojs/hexo/\n\n# Site\ntitle: 听雪楼 #站点名，站点左上角\nsubtitle: 那是一座悲欢离合聚集的楼。 #副标题，站点左上角\ndescription: #对站点的描述\nauthor: 最后的温存 #作者\nlanguage: zh-Hans #语言\ntimezone: #时区\n\n# URL\n## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'\nurl: http://lijia92.github.io/  #站点Url\nroot: /\npermalink: :year/:month/:day/:title/\npermalink_defaults:\n\n# Directory\nsource_dir: source\npublic_dir: public\ntag_dir: tags\narchive_dir: archives\ncategory_dir: categories\ncode_dir: downloads/code\ni18n_dir: :lang\nskip_render:\n\n# Writing\nnew_post_name: :title.md # File name of new posts\ndefault_layout: post\ntitlecase: false # Transform title into titlecase\nexternal_link: true # Open external links in new tab\nfilename_case: 0\nrender_drafts: false\npost_asset_folder: false\nrelative_link: false\nfuture: true\nhighlight:\n  enable: true\n  line_number: true\n  auto_detect: false\n  tab_replace:\n\n# Category & Tag\ndefault_category: uncategorized\ncategory_map:\ntag_map:\n\n# Date / Time format\n## Hexo uses Moment.js to parse and display date\n## You can customize the date format as defined in\n## http://momentjs.com/docs/#/displaying/format/\ndate_format: YYYY-MM-DD\ntime_format: HH:mm:ss\n\n# Pagination\n## Set per_page to 0 to disable pagination\nper_page: 10\npagination_dir: page\n\n# Extensions\n## Plugins: https://hexo.io/plugins/\n## Themes: https://hexo.io/themes/\ntheme: hexo-theme-next #主题插件\n\n# Deployment\n## Docs: https://hexo.io/docs/deployment.html\ndeploy: #部署相关信息\n  type: git\n  repository: https://github.com/LiJia92/LiJia92.github.io.git\n  branch: master\n```\n## 分类与标签\n1.若已存在分类或标签，则直接修改。\n打开``hexo/source/tags/index.md``。修改为如下。\n```\ntitle: tags\ndate: 2016-03-16 15:33:44\ntype: \"tags\"\n```\n时间可随意修改，必须设置type字段为\"tags\"。\n分类也如此：\n```\ntitle: categories\ndate: 2016-03-16 15:33:56\ntype: \"categories\"\n```\n2.若不存在，则直接新建，修改为1中所示即可。\n```\n$ hexo new page \"tags\"\n$ hexo new page \"categories\"\n```\nindex.md中不需要再额外写什么东西，它会根据你日志的分类、标签自动匹配。\n```\ntitle: Windows使用Hexo + Github Pages搭建自己的博客\ndate: 2016-03-17 11:30:45\ntags:\n - blog\n - hexo\ncategories: hexo\n```\n\n## 主题\nhexo有许多主题可以选择，可以参考[知乎回答](https://www.zhihu.com/question/24422335)选择自己喜欢的主题。\n我这里选择的是next主题。\n### 下载主题\n使用Git Bash进入到hexo目录。输入指令下载主题：\n```\n$ git clone https://github.com/iissnan/hexo-theme-next themes/next\n```\n### 使用主题\n回到上面的_config.yml配置文件中，找到theme字段，修改成next主题：\n```\n# Extensions\n## Plugins: https://hexo.io/plugins/\n## Themes: https://hexo.io/themes/\ntheme: hexo-theme-next\n```\n## Next主题相关\n### 语言\n``hexo/_config.yml``的配置中，language字段若要使用中文，需使用``zh-Hans``。\n### 菜单\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n``menu``是设置菜单，``menu_icons``是设置菜单对应的图标。这里对应的key都必须是一样的，大小写也有区分。\n```\n# ---------------------------------------------------------------\n# Menu Settings\n# ---------------------------------------------------------------\n\n# When running hexo in a subdirectory (e.g. domain.tld/blog)\n# Remove leading slashes ( \"/archives\" -> \"archives\" )\nmenu:\n  home: /\n  categories: /categories\n  archives: /archives\n  tags: /tags\n  # about: /about\n  commonweal: /404.html\n\n\n# Enable/Disable menu icons.\n# Icon Mapping:\n#   Map a menu item to a specific FontAwesome icon name.\n#   Key is the name of menu item and value is the name of FontAwsome icon.\n#   When an question mask icon presenting up means that the item has no mapping icon.\nmenu_icons:\n  enable: true\n  # Icon Mapping.\n  home: home\n  about: user\n  categories: th\n  tags: tags\n  archives: archive\n  commonweal: heartbeat\n```\n### 设置个人信息\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n将图像avatar.png放在hexo/themes/hexo-theme-next/source/images目录下。\n``avatar``-->个人头像，``author``-->昵称，``description``-->描述\n```\navatar: /images/avatar.png\n\nauthor: lastwarmth\n\ndescription: 如果要飞得高，就该把地平线忘掉\n```\n### 社交信息\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n设置社交信息与icon，与菜单一样，key值需要完全对应，区分大小写。\n```\n# Social links\nsocial:\n  GitHub: https://github.com/LiJia92\n  Weibo: http://weibo.com/2950244271\n\n# Social Icons\nsocial_icons:\n  enable: true\n  # Icon Mappings\n  GitHub: github\n  Twitter: twitter\n  Weibo: weibo\n```\n### Schemes\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\nNext主题有三种Scheme，可随意切换。\n```\n#scheme: Muse\n#scheme: Mist\nscheme: Pisces\n```\n### 网站图标\n与设置个人图像类似。\n```\n# Place your favicon.ico to /source directory.\nfavicon: /images/avatar.png\n```\n### 集成多说\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n设置``duoshuo_shortname``字段。\n```\n# Duoshuo ShortName\nduoshuo_shortname: lastwarmth\n```\n这个ShortName怎么来？\n进入[多说](http://duoshuo.com/create-site/)\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tipsduoshuo-create-site.png)\n红色方框填写的即是ShortName\n\n### 代码高亮\n``hexo/_config.yml``的配置中。\n修改``auto_detect``字段为``true``\n```\nhighlight:\n  enable: true\n  line_number: true\n  auto_detect: true\n  tab_replace:\n```\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n修改``highlight_theme: normal``字段。NexT使用``Tomorrow Theme``作为代码高亮，共有5款主题供你选择，可选的值有 normal，night， night blue， night bright， night eighties。\n```\n# Code Highlight theme\n# Available value:\n#    normal | night | night eighties | night blue | night bright\n# https://github.com/chriskempson/tomorrow-theme\nhighlight_theme: normal\n```\n### 问题\n> 本地预览没问题，deploy后主页显示大面积空白\n\n[点此](https://github.com/iissnan/hexo-theme-next/issues/1214)\n\n### 更多\n更多请查看[ Next ](http://theme-next.iissnan.com/getting-started.html#third-party-services)官网\n","source":"_posts/hexo-tips.md","raw":"---\ntitle: Hexo-Tips\ndate: 2016-03-17 12:23:14\ntags:\n - blog\n---\n\n本文主要讲述一下使用Hexo搭建博客的一些Tips。\n## hexo基本指令\n1. hexo clean 清除\n2. hexo new page \"menu name\" 新建菜单\n3. hexo g == hexo generate 生成\n4. hexo d == hexo deploy 部署\n5. hexo s == hexo server 启动本地\n6. hexo n == hexo new 新建\n\n## 首页文章显示\n在md文件中添加``<!--more-->``，那么首页就只会显示这个标签之上的内容了，并显示一个``阅读全文``的按钮。\n\n## 部署到Github保证README.md不被渲染\n1. 在Hexo目录下的source根目录下创建README.md文件,并编辑保存。\n2. 编辑Hexo目录的_config.yml文件中的“skip_render”参数。\n```\nskip_render: README.md\n```\n3. 部署到Github，然后看仓库是否有README.md。\n\n<!--more-->\n\n## 博客基本配置\n打开hexo目录下的``_config.yml``文件。\n```\n# Hexo Configuration\n## Docs: https://hexo.io/docs/configuration.html\n## Source: https://github.com/hexojs/hexo/\n\n# Site\ntitle: 听雪楼 #站点名，站点左上角\nsubtitle: 那是一座悲欢离合聚集的楼。 #副标题，站点左上角\ndescription: #对站点的描述\nauthor: 最后的温存 #作者\nlanguage: zh-Hans #语言\ntimezone: #时区\n\n# URL\n## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'\nurl: http://lijia92.github.io/  #站点Url\nroot: /\npermalink: :year/:month/:day/:title/\npermalink_defaults:\n\n# Directory\nsource_dir: source\npublic_dir: public\ntag_dir: tags\narchive_dir: archives\ncategory_dir: categories\ncode_dir: downloads/code\ni18n_dir: :lang\nskip_render:\n\n# Writing\nnew_post_name: :title.md # File name of new posts\ndefault_layout: post\ntitlecase: false # Transform title into titlecase\nexternal_link: true # Open external links in new tab\nfilename_case: 0\nrender_drafts: false\npost_asset_folder: false\nrelative_link: false\nfuture: true\nhighlight:\n  enable: true\n  line_number: true\n  auto_detect: false\n  tab_replace:\n\n# Category & Tag\ndefault_category: uncategorized\ncategory_map:\ntag_map:\n\n# Date / Time format\n## Hexo uses Moment.js to parse and display date\n## You can customize the date format as defined in\n## http://momentjs.com/docs/#/displaying/format/\ndate_format: YYYY-MM-DD\ntime_format: HH:mm:ss\n\n# Pagination\n## Set per_page to 0 to disable pagination\nper_page: 10\npagination_dir: page\n\n# Extensions\n## Plugins: https://hexo.io/plugins/\n## Themes: https://hexo.io/themes/\ntheme: hexo-theme-next #主题插件\n\n# Deployment\n## Docs: https://hexo.io/docs/deployment.html\ndeploy: #部署相关信息\n  type: git\n  repository: https://github.com/LiJia92/LiJia92.github.io.git\n  branch: master\n```\n## 分类与标签\n1.若已存在分类或标签，则直接修改。\n打开``hexo/source/tags/index.md``。修改为如下。\n```\ntitle: tags\ndate: 2016-03-16 15:33:44\ntype: \"tags\"\n```\n时间可随意修改，必须设置type字段为\"tags\"。\n分类也如此：\n```\ntitle: categories\ndate: 2016-03-16 15:33:56\ntype: \"categories\"\n```\n2.若不存在，则直接新建，修改为1中所示即可。\n```\n$ hexo new page \"tags\"\n$ hexo new page \"categories\"\n```\nindex.md中不需要再额外写什么东西，它会根据你日志的分类、标签自动匹配。\n```\ntitle: Windows使用Hexo + Github Pages搭建自己的博客\ndate: 2016-03-17 11:30:45\ntags:\n - blog\n - hexo\ncategories: hexo\n```\n\n## 主题\nhexo有许多主题可以选择，可以参考[知乎回答](https://www.zhihu.com/question/24422335)选择自己喜欢的主题。\n我这里选择的是next主题。\n### 下载主题\n使用Git Bash进入到hexo目录。输入指令下载主题：\n```\n$ git clone https://github.com/iissnan/hexo-theme-next themes/next\n```\n### 使用主题\n回到上面的_config.yml配置文件中，找到theme字段，修改成next主题：\n```\n# Extensions\n## Plugins: https://hexo.io/plugins/\n## Themes: https://hexo.io/themes/\ntheme: hexo-theme-next\n```\n## Next主题相关\n### 语言\n``hexo/_config.yml``的配置中，language字段若要使用中文，需使用``zh-Hans``。\n### 菜单\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n``menu``是设置菜单，``menu_icons``是设置菜单对应的图标。这里对应的key都必须是一样的，大小写也有区分。\n```\n# ---------------------------------------------------------------\n# Menu Settings\n# ---------------------------------------------------------------\n\n# When running hexo in a subdirectory (e.g. domain.tld/blog)\n# Remove leading slashes ( \"/archives\" -> \"archives\" )\nmenu:\n  home: /\n  categories: /categories\n  archives: /archives\n  tags: /tags\n  # about: /about\n  commonweal: /404.html\n\n\n# Enable/Disable menu icons.\n# Icon Mapping:\n#   Map a menu item to a specific FontAwesome icon name.\n#   Key is the name of menu item and value is the name of FontAwsome icon.\n#   When an question mask icon presenting up means that the item has no mapping icon.\nmenu_icons:\n  enable: true\n  # Icon Mapping.\n  home: home\n  about: user\n  categories: th\n  tags: tags\n  archives: archive\n  commonweal: heartbeat\n```\n### 设置个人信息\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n将图像avatar.png放在hexo/themes/hexo-theme-next/source/images目录下。\n``avatar``-->个人头像，``author``-->昵称，``description``-->描述\n```\navatar: /images/avatar.png\n\nauthor: lastwarmth\n\ndescription: 如果要飞得高，就该把地平线忘掉\n```\n### 社交信息\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n设置社交信息与icon，与菜单一样，key值需要完全对应，区分大小写。\n```\n# Social links\nsocial:\n  GitHub: https://github.com/LiJia92\n  Weibo: http://weibo.com/2950244271\n\n# Social Icons\nsocial_icons:\n  enable: true\n  # Icon Mappings\n  GitHub: github\n  Twitter: twitter\n  Weibo: weibo\n```\n### Schemes\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\nNext主题有三种Scheme，可随意切换。\n```\n#scheme: Muse\n#scheme: Mist\nscheme: Pisces\n```\n### 网站图标\n与设置个人图像类似。\n```\n# Place your favicon.ico to /source directory.\nfavicon: /images/avatar.png\n```\n### 集成多说\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n设置``duoshuo_shortname``字段。\n```\n# Duoshuo ShortName\nduoshuo_shortname: lastwarmth\n```\n这个ShortName怎么来？\n进入[多说](http://duoshuo.com/create-site/)\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tipsduoshuo-create-site.png)\n红色方框填写的即是ShortName\n\n### 代码高亮\n``hexo/_config.yml``的配置中。\n修改``auto_detect``字段为``true``\n```\nhighlight:\n  enable: true\n  line_number: true\n  auto_detect: true\n  tab_replace:\n```\n``hexo/themes/hexo-theme-next/_config.yml``的配置中。\n修改``highlight_theme: normal``字段。NexT使用``Tomorrow Theme``作为代码高亮，共有5款主题供你选择，可选的值有 normal，night， night blue， night bright， night eighties。\n```\n# Code Highlight theme\n# Available value:\n#    normal | night | night eighties | night blue | night bright\n# https://github.com/chriskempson/tomorrow-theme\nhighlight_theme: normal\n```\n### 问题\n> 本地预览没问题，deploy后主页显示大面积空白\n\n[点此](https://github.com/iissnan/hexo-theme-next/issues/1214)\n\n### 更多\n更多请查看[ Next ](http://theme-next.iissnan.com/getting-started.html#third-party-services)官网\n","slug":"hexo-tips","published":1,"updated":"2016-11-21T09:59:32.863Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758s00151cb85lqdpjvl","content":"<p>本文主要讲述一下使用Hexo搭建博客的一些Tips。</p>\n<h2 id=\"hexo基本指令\"><a href=\"#hexo基本指令\" class=\"headerlink\" title=\"hexo基本指令\"></a>hexo基本指令</h2><ol>\n<li>hexo clean 清除</li>\n<li>hexo new page “menu name” 新建菜单</li>\n<li>hexo g == hexo generate 生成</li>\n<li>hexo d == hexo deploy 部署</li>\n<li>hexo s == hexo server 启动本地</li>\n<li>hexo n == hexo new 新建</li>\n</ol>\n<h2 id=\"首页文章显示\"><a href=\"#首页文章显示\" class=\"headerlink\" title=\"首页文章显示\"></a>首页文章显示</h2><p>在md文件中添加<code>&lt;!--more--&gt;</code>，那么首页就只会显示这个标签之上的内容了，并显示一个<code>阅读全文</code>的按钮。</p>\n<h2 id=\"部署到Github保证README-md不被渲染\"><a href=\"#部署到Github保证README-md不被渲染\" class=\"headerlink\" title=\"部署到Github保证README.md不被渲染\"></a>部署到Github保证README.md不被渲染</h2><ol>\n<li>在Hexo目录下的source根目录下创建README.md文件,并编辑保存。</li>\n<li><p>编辑Hexo目录的_config.yml文件中的“skip_render”参数。</p>\n<figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"symbol\">skip_render:</span> README.md</div></pre></td></tr></table></figure>\n</li>\n<li><p>部署到Github，然后看仓库是否有README.md。</p>\n</li>\n</ol>\n<a id=\"more\"></a>\n<h2 id=\"博客基本配置\"><a href=\"#博客基本配置\" class=\"headerlink\" title=\"博客基本配置\"></a>博客基本配置</h2><p>打开hexo目录下的<code>_config.yml</code>文件。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># Hexo Configuration</span></div><div class=\"line\"><span class=\"comment\">## Docs: https://hexo.io/docs/configuration.html</span></div><div class=\"line\"><span class=\"comment\">## Source: https://github.com/hexojs/hexo/</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Site</span></div><div class=\"line\"><span class=\"attr\">title:</span> 听雪楼 <span class=\"comment\">#站点名，站点左上角</span></div><div class=\"line\"><span class=\"attr\">subtitle:</span> 那是一座悲欢离合聚集的楼。 <span class=\"comment\">#副标题，站点左上角</span></div><div class=\"line\"><span class=\"attr\">description:</span> <span class=\"comment\">#对站点的描述</span></div><div class=\"line\"><span class=\"attr\">author:</span> 最后的温存 <span class=\"comment\">#作者</span></div><div class=\"line\"><span class=\"attr\">language:</span> zh-Hans <span class=\"comment\">#语言</span></div><div class=\"line\"><span class=\"attr\">timezone:</span> <span class=\"comment\">#时区</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># URL</span></div><div class=\"line\"><span class=\"comment\">## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'</span></div><div class=\"line\"><span class=\"attr\">url:</span> http://lijia92.github.io/  <span class=\"comment\">#站点Url</span></div><div class=\"line\"><span class=\"attr\">root:</span> /</div><div class=\"line\"><span class=\"attr\">permalink:</span> :year/:month/:day/:title/</div><div class=\"line\"><span class=\"attr\">permalink_defaults:</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Directory</span></div><div class=\"line\"><span class=\"attr\">source_dir:</span> source</div><div class=\"line\"><span class=\"attr\">public_dir:</span> public</div><div class=\"line\"><span class=\"attr\">tag_dir:</span> tags</div><div class=\"line\"><span class=\"attr\">archive_dir:</span> archives</div><div class=\"line\"><span class=\"attr\">category_dir:</span> categories</div><div class=\"line\"><span class=\"attr\">code_dir:</span> downloads/code</div><div class=\"line\"><span class=\"attr\">i18n_dir:</span> :lang</div><div class=\"line\"><span class=\"attr\">skip_render:</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Writing</span></div><div class=\"line\"><span class=\"attr\">new_post_name:</span> :title.md <span class=\"comment\"># File name of new posts</span></div><div class=\"line\"><span class=\"attr\">default_layout:</span> post</div><div class=\"line\"><span class=\"attr\">titlecase:</span> <span class=\"literal\">false</span> <span class=\"comment\"># Transform title into titlecase</span></div><div class=\"line\"><span class=\"attr\">external_link:</span> <span class=\"literal\">true</span> <span class=\"comment\"># Open external links in new tab</span></div><div class=\"line\"><span class=\"attr\">filename_case:</span> <span class=\"number\">0</span></div><div class=\"line\"><span class=\"attr\">render_drafts:</span> <span class=\"literal\">false</span></div><div class=\"line\"><span class=\"attr\">post_asset_folder:</span> <span class=\"literal\">false</span></div><div class=\"line\"><span class=\"attr\">relative_link:</span> <span class=\"literal\">false</span></div><div class=\"line\"><span class=\"attr\">future:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">highlight:</span></div><div class=\"line\"><span class=\"attr\">  enable:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  line_number:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  auto_detect:</span> <span class=\"literal\">false</span></div><div class=\"line\"><span class=\"attr\">  tab_replace:</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Category &amp; Tag</span></div><div class=\"line\"><span class=\"attr\">default_category:</span> uncategorized</div><div class=\"line\"><span class=\"attr\">category_map:</span></div><div class=\"line\"><span class=\"attr\">tag_map:</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Date / Time format</span></div><div class=\"line\"><span class=\"comment\">## Hexo uses Moment.js to parse and display date</span></div><div class=\"line\"><span class=\"comment\">## You can customize the date format as defined in</span></div><div class=\"line\"><span class=\"comment\">## http://momentjs.com/docs/#/displaying/format/</span></div><div class=\"line\"><span class=\"attr\">date_format:</span> YYYY-MM-DD</div><div class=\"line\"><span class=\"attr\">time_format:</span> HH:mm:ss</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Pagination</span></div><div class=\"line\"><span class=\"comment\">## Set per_page to 0 to disable pagination</span></div><div class=\"line\"><span class=\"attr\">per_page:</span> <span class=\"number\">10</span></div><div class=\"line\"><span class=\"attr\">pagination_dir:</span> page</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Extensions</span></div><div class=\"line\"><span class=\"comment\">## Plugins: https://hexo.io/plugins/</span></div><div class=\"line\"><span class=\"comment\">## Themes: https://hexo.io/themes/</span></div><div class=\"line\"><span class=\"attr\">theme:</span> hexo-theme-next <span class=\"comment\">#主题插件</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Deployment</span></div><div class=\"line\"><span class=\"comment\">## Docs: https://hexo.io/docs/deployment.html</span></div><div class=\"line\"><span class=\"attr\">deploy:</span> <span class=\"comment\">#部署相关信息</span></div><div class=\"line\"><span class=\"attr\">  type:</span> git</div><div class=\"line\"><span class=\"attr\">  repository:</span> https://github.com/LiJia92/LiJia92.github.io.git</div><div class=\"line\"><span class=\"attr\">  branch:</span> master</div></pre></td></tr></table></figure></p>\n<h2 id=\"分类与标签\"><a href=\"#分类与标签\" class=\"headerlink\" title=\"分类与标签\"></a>分类与标签</h2><p>1.若已存在分类或标签，则直接修改。<br>打开<code>hexo/source/tags/index.md</code>。修改为如下。<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"symbol\">title:</span> tags</div><div class=\"line\"><span class=\"symbol\">date:</span> <span class=\"number\">2016</span><span class=\"number\">-03</span><span class=\"number\">-16</span> <span class=\"number\">15</span>:<span class=\"number\">33</span>:<span class=\"number\">44</span></div><div class=\"line\"><span class=\"symbol\">type:</span> <span class=\"string\">\"tags\"</span></div></pre></td></tr></table></figure></p>\n<p>时间可随意修改，必须设置type字段为”tags”。<br>分类也如此：<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"symbol\">title:</span> categories</div><div class=\"line\"><span class=\"symbol\">date:</span> <span class=\"number\">2016</span><span class=\"number\">-03</span><span class=\"number\">-16</span> <span class=\"number\">15</span>:<span class=\"number\">33</span>:<span class=\"number\">56</span></div><div class=\"line\"><span class=\"symbol\">type:</span> <span class=\"string\">\"categories\"</span></div></pre></td></tr></table></figure></p>\n<p>2.若不存在，则直接新建，修改为1中所示即可。<br><figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo <span class=\"keyword\">new</span> <span class=\"type\">page</span> <span class=\"string\">\"tags\"</span></div><div class=\"line\">$ hexo <span class=\"keyword\">new</span> <span class=\"type\">page</span> <span class=\"string\">\"categories\"</span></div></pre></td></tr></table></figure></p>\n<p>index.md中不需要再额外写什么东西，它会根据你日志的分类、标签自动匹配。<br><figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">title: Windows使用Hexo + Github Pages搭建自己的博客</div><div class=\"line\">date: 2016<span class=\"string\">-03</span><span class=\"string\">-17</span> 11:30:45</div><div class=\"line\"><span class=\"keyword\">tags:</span></div><div class=\"line\"> - blog</div><div class=\"line\"> - hexo</div><div class=\"line\">categories: hexo</div></pre></td></tr></table></figure></p>\n<h2 id=\"主题\"><a href=\"#主题\" class=\"headerlink\" title=\"主题\"></a>主题</h2><p>hexo有许多主题可以选择，可以参考<a href=\"https://www.zhihu.com/question/24422335\" target=\"_blank\" rel=\"external\">知乎回答</a>选择自己喜欢的主题。<br>我这里选择的是next主题。</p>\n<h3 id=\"下载主题\"><a href=\"#下载主题\" class=\"headerlink\" title=\"下载主题\"></a>下载主题</h3><p>使用Git Bash进入到hexo目录。输入指令下载主题：<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/iissnan/hexo-theme-<span class=\"keyword\">next</span> themes/<span class=\"keyword\">next</span></div></pre></td></tr></table></figure></p>\n<h3 id=\"使用主题\"><a href=\"#使用主题\" class=\"headerlink\" title=\"使用主题\"></a>使用主题</h3><p>回到上面的_config.yml配置文件中，找到theme字段，修改成next主题：<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># Extensions</div><div class=\"line\">## Plugins: https:<span class=\"comment\">//hexo.io/plugins/</span></div><div class=\"line\">## Themes: https:<span class=\"comment\">//hexo.io/themes/</span></div><div class=\"line\">theme: hexo-theme-next</div></pre></td></tr></table></figure></p>\n<h2 id=\"Next主题相关\"><a href=\"#Next主题相关\" class=\"headerlink\" title=\"Next主题相关\"></a>Next主题相关</h2><h3 id=\"语言\"><a href=\"#语言\" class=\"headerlink\" title=\"语言\"></a>语言</h3><p><code>hexo/_config.yml</code>的配置中，language字段若要使用中文，需使用<code>zh-Hans</code>。</p>\n<h3 id=\"菜单\"><a href=\"#菜单\" class=\"headerlink\" title=\"菜单\"></a>菜单</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br><code>menu</code>是设置菜单，<code>menu_icons</code>是设置菜单对应的图标。这里对应的key都必须是一样的，大小写也有区分。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></div><div class=\"line\"><span class=\"comment\"># Menu Settings</span></div><div class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># When running hexo in a subdirectory (e.g. domain.tld/blog)</span></div><div class=\"line\"><span class=\"comment\"># Remove leading slashes ( \"/archives\" -&gt; \"archives\" )</span></div><div class=\"line\"><span class=\"attr\">menu:</span></div><div class=\"line\"><span class=\"attr\">  home:</span> /</div><div class=\"line\"><span class=\"attr\">  categories:</span> /categories</div><div class=\"line\"><span class=\"attr\">  archives:</span> /archives</div><div class=\"line\"><span class=\"attr\">  tags:</span> /tags</div><div class=\"line\">  <span class=\"comment\"># about: /about</span></div><div class=\"line\"><span class=\"attr\">  commonweal:</span> /<span class=\"number\">404.</span>html</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Enable/Disable menu icons.</span></div><div class=\"line\"><span class=\"comment\"># Icon Mapping:</span></div><div class=\"line\"><span class=\"comment\">#   Map a menu item to a specific FontAwesome icon name.</span></div><div class=\"line\"><span class=\"comment\">#   Key is the name of menu item and value is the name of FontAwsome icon.</span></div><div class=\"line\"><span class=\"comment\">#   When an question mask icon presenting up means that the item has no mapping icon.</span></div><div class=\"line\"><span class=\"attr\">menu_icons:</span></div><div class=\"line\"><span class=\"attr\">  enable:</span> <span class=\"literal\">true</span></div><div class=\"line\">  <span class=\"comment\"># Icon Mapping.</span></div><div class=\"line\"><span class=\"attr\">  home:</span> home</div><div class=\"line\"><span class=\"attr\">  about:</span> user</div><div class=\"line\"><span class=\"attr\">  categories:</span> th</div><div class=\"line\"><span class=\"attr\">  tags:</span> tags</div><div class=\"line\"><span class=\"attr\">  archives:</span> archive</div><div class=\"line\"><span class=\"attr\">  commonweal:</span> heartbeat</div></pre></td></tr></table></figure></p>\n<h3 id=\"设置个人信息\"><a href=\"#设置个人信息\" class=\"headerlink\" title=\"设置个人信息\"></a>设置个人信息</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>将图像avatar.png放在hexo/themes/hexo-theme-next/source/images目录下。<br><code>avatar</code>–&gt;个人头像，<code>author</code>–&gt;昵称，<code>description</code>–&gt;描述<br><figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">avatar</span>: /images/avatar.png</div><div class=\"line\"></div><div class=\"line\"><span class=\"http\"><span class=\"attribute\">author</span>: lastwarmth</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"avrasm\"><span class=\"symbol\">description:</span> 如果要飞得高，就该把地平线忘掉</span></div></pre></td></tr></table></figure></p>\n<h3 id=\"社交信息\"><a href=\"#社交信息\" class=\"headerlink\" title=\"社交信息\"></a>社交信息</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>设置社交信息与icon，与菜单一样，key值需要完全对应，区分大小写。<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\"># Social links</span></div><div class=\"line\"><span class=\"symbol\">social:</span></div><div class=\"line\"><span class=\"symbol\">  GitHub:</span> https:<span class=\"comment\">//github.com/LiJia92</span></div><div class=\"line\"><span class=\"symbol\">  Weibo:</span> http:<span class=\"comment\">//weibo.com/2950244271</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\"># Social Icons</span></div><div class=\"line\"><span class=\"symbol\">social_icons:</span></div><div class=\"line\"><span class=\"symbol\">  enable:</span> true</div><div class=\"line\">  <span class=\"meta\"># Icon Mappings</span></div><div class=\"line\"><span class=\"symbol\">  GitHub:</span> github</div><div class=\"line\"><span class=\"symbol\">  Twitter:</span> twitter</div><div class=\"line\"><span class=\"symbol\">  Weibo:</span> weibo</div></pre></td></tr></table></figure></p>\n<h3 id=\"Schemes\"><a href=\"#Schemes\" class=\"headerlink\" title=\"Schemes\"></a>Schemes</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>Next主题有三种Scheme，可随意切换。<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-id\">#scheme</span>: Muse</div><div class=\"line\"><span class=\"selector-id\">#scheme</span>: Mist</div><div class=\"line\">scheme: Pisces</div></pre></td></tr></table></figure></p>\n<h3 id=\"网站图标\"><a href=\"#网站图标\" class=\"headerlink\" title=\"网站图标\"></a>网站图标</h3><p>与设置个人图像类似。<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># Place your favicon.ico to /source directory.</span></div><div class=\"line\">favicon: <span class=\"regexp\">/images/</span>avatar.png</div></pre></td></tr></table></figure></p>\n<h3 id=\"集成多说\"><a href=\"#集成多说\" class=\"headerlink\" title=\"集成多说\"></a>集成多说</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>设置<code>duoshuo_shortname</code>字段。<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\"># Duoshuo ShortName</span></div><div class=\"line\"><span class=\"symbol\">duoshuo_shortname:</span> lastwarmth</div></pre></td></tr></table></figure></p>\n<p>这个ShortName怎么来？<br>进入<a href=\"http://duoshuo.com/create-site/\" target=\"_blank\" rel=\"external\">多说</a><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tipsduoshuo-create-site.png\" alt=\"这里写图片描述\"><br>红色方框填写的即是ShortName</p>\n<h3 id=\"代码高亮\"><a href=\"#代码高亮\" class=\"headerlink\" title=\"代码高亮\"></a>代码高亮</h3><p><code>hexo/_config.yml</code>的配置中。<br>修改<code>auto_detect</code>字段为<code>true</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">highlight:</span></div><div class=\"line\"><span class=\"attr\">  enable:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  line_number:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  auto_detect:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  tab_replace:</span></div></pre></td></tr></table></figure></p>\n<p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>修改<code>highlight_theme: normal</code>字段。NexT使用<code>Tomorrow Theme</code>作为代码高亮，共有5款主题供你选择，可选的值有 normal，night， night blue， night bright， night eighties。<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\"># Code Highlight theme</span></div><div class=\"line\"><span class=\"meta\"># Available value:</span></div><div class=\"line\"><span class=\"meta\">#    normal | night | night eighties | night blue | night bright</span></div><div class=\"line\"><span class=\"meta\"># https://github.com/chriskempson/tomorrow-theme</span></div><div class=\"line\">highlight_theme: normal</div></pre></td></tr></table></figure></p>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><blockquote>\n<p>本地预览没问题，deploy后主页显示大面积空白</p>\n</blockquote>\n<p><a href=\"https://github.com/iissnan/hexo-theme-next/issues/1214\" target=\"_blank\" rel=\"external\">点此</a></p>\n<h3 id=\"更多\"><a href=\"#更多\" class=\"headerlink\" title=\"更多\"></a>更多</h3><p>更多请查看<a href=\"http://theme-next.iissnan.com/getting-started.html#third-party-services\" target=\"_blank\" rel=\"external\"> Next </a>官网</p>\n","excerpt":"<p>本文主要讲述一下使用Hexo搭建博客的一些Tips。</p>\n<h2 id=\"hexo基本指令\"><a href=\"#hexo基本指令\" class=\"headerlink\" title=\"hexo基本指令\"></a>hexo基本指令</h2><ol>\n<li>hexo clean 清除</li>\n<li>hexo new page “menu name” 新建菜单</li>\n<li>hexo g == hexo generate 生成</li>\n<li>hexo d == hexo deploy 部署</li>\n<li>hexo s == hexo server 启动本地</li>\n<li>hexo n == hexo new 新建</li>\n</ol>\n<h2 id=\"首页文章显示\"><a href=\"#首页文章显示\" class=\"headerlink\" title=\"首页文章显示\"></a>首页文章显示</h2><p>在md文件中添加<code>&lt;!--more--&gt;</code>，那么首页就只会显示这个标签之上的内容了，并显示一个<code>阅读全文</code>的按钮。</p>\n<h2 id=\"部署到Github保证README-md不被渲染\"><a href=\"#部署到Github保证README-md不被渲染\" class=\"headerlink\" title=\"部署到Github保证README.md不被渲染\"></a>部署到Github保证README.md不被渲染</h2><ol>\n<li>在Hexo目录下的source根目录下创建README.md文件,并编辑保存。</li>\n<li><p>编辑Hexo目录的_config.yml文件中的“skip_render”参数。</p>\n<figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"symbol\">skip_render:</span> README.md</div></pre></td></tr></table></figure>\n</li>\n<li><p>部署到Github，然后看仓库是否有README.md。</p>\n</li>\n</ol>","more":"<h2 id=\"博客基本配置\"><a href=\"#博客基本配置\" class=\"headerlink\" title=\"博客基本配置\"></a>博客基本配置</h2><p>打开hexo目录下的<code>_config.yml</code>文件。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># Hexo Configuration</span></div><div class=\"line\"><span class=\"comment\">## Docs: https://hexo.io/docs/configuration.html</span></div><div class=\"line\"><span class=\"comment\">## Source: https://github.com/hexojs/hexo/</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Site</span></div><div class=\"line\"><span class=\"attr\">title:</span> 听雪楼 <span class=\"comment\">#站点名，站点左上角</span></div><div class=\"line\"><span class=\"attr\">subtitle:</span> 那是一座悲欢离合聚集的楼。 <span class=\"comment\">#副标题，站点左上角</span></div><div class=\"line\"><span class=\"attr\">description:</span> <span class=\"comment\">#对站点的描述</span></div><div class=\"line\"><span class=\"attr\">author:</span> 最后的温存 <span class=\"comment\">#作者</span></div><div class=\"line\"><span class=\"attr\">language:</span> zh-Hans <span class=\"comment\">#语言</span></div><div class=\"line\"><span class=\"attr\">timezone:</span> <span class=\"comment\">#时区</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># URL</span></div><div class=\"line\"><span class=\"comment\">## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'</span></div><div class=\"line\"><span class=\"attr\">url:</span> http://lijia92.github.io/  <span class=\"comment\">#站点Url</span></div><div class=\"line\"><span class=\"attr\">root:</span> /</div><div class=\"line\"><span class=\"attr\">permalink:</span> :year/:month/:day/:title/</div><div class=\"line\"><span class=\"attr\">permalink_defaults:</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Directory</span></div><div class=\"line\"><span class=\"attr\">source_dir:</span> source</div><div class=\"line\"><span class=\"attr\">public_dir:</span> public</div><div class=\"line\"><span class=\"attr\">tag_dir:</span> tags</div><div class=\"line\"><span class=\"attr\">archive_dir:</span> archives</div><div class=\"line\"><span class=\"attr\">category_dir:</span> categories</div><div class=\"line\"><span class=\"attr\">code_dir:</span> downloads/code</div><div class=\"line\"><span class=\"attr\">i18n_dir:</span> :lang</div><div class=\"line\"><span class=\"attr\">skip_render:</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Writing</span></div><div class=\"line\"><span class=\"attr\">new_post_name:</span> :title.md <span class=\"comment\"># File name of new posts</span></div><div class=\"line\"><span class=\"attr\">default_layout:</span> post</div><div class=\"line\"><span class=\"attr\">titlecase:</span> <span class=\"literal\">false</span> <span class=\"comment\"># Transform title into titlecase</span></div><div class=\"line\"><span class=\"attr\">external_link:</span> <span class=\"literal\">true</span> <span class=\"comment\"># Open external links in new tab</span></div><div class=\"line\"><span class=\"attr\">filename_case:</span> <span class=\"number\">0</span></div><div class=\"line\"><span class=\"attr\">render_drafts:</span> <span class=\"literal\">false</span></div><div class=\"line\"><span class=\"attr\">post_asset_folder:</span> <span class=\"literal\">false</span></div><div class=\"line\"><span class=\"attr\">relative_link:</span> <span class=\"literal\">false</span></div><div class=\"line\"><span class=\"attr\">future:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">highlight:</span></div><div class=\"line\"><span class=\"attr\">  enable:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  line_number:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  auto_detect:</span> <span class=\"literal\">false</span></div><div class=\"line\"><span class=\"attr\">  tab_replace:</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Category &amp; Tag</span></div><div class=\"line\"><span class=\"attr\">default_category:</span> uncategorized</div><div class=\"line\"><span class=\"attr\">category_map:</span></div><div class=\"line\"><span class=\"attr\">tag_map:</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Date / Time format</span></div><div class=\"line\"><span class=\"comment\">## Hexo uses Moment.js to parse and display date</span></div><div class=\"line\"><span class=\"comment\">## You can customize the date format as defined in</span></div><div class=\"line\"><span class=\"comment\">## http://momentjs.com/docs/#/displaying/format/</span></div><div class=\"line\"><span class=\"attr\">date_format:</span> YYYY-MM-DD</div><div class=\"line\"><span class=\"attr\">time_format:</span> HH:mm:ss</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Pagination</span></div><div class=\"line\"><span class=\"comment\">## Set per_page to 0 to disable pagination</span></div><div class=\"line\"><span class=\"attr\">per_page:</span> <span class=\"number\">10</span></div><div class=\"line\"><span class=\"attr\">pagination_dir:</span> page</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Extensions</span></div><div class=\"line\"><span class=\"comment\">## Plugins: https://hexo.io/plugins/</span></div><div class=\"line\"><span class=\"comment\">## Themes: https://hexo.io/themes/</span></div><div class=\"line\"><span class=\"attr\">theme:</span> hexo-theme-next <span class=\"comment\">#主题插件</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Deployment</span></div><div class=\"line\"><span class=\"comment\">## Docs: https://hexo.io/docs/deployment.html</span></div><div class=\"line\"><span class=\"attr\">deploy:</span> <span class=\"comment\">#部署相关信息</span></div><div class=\"line\"><span class=\"attr\">  type:</span> git</div><div class=\"line\"><span class=\"attr\">  repository:</span> https://github.com/LiJia92/LiJia92.github.io.git</div><div class=\"line\"><span class=\"attr\">  branch:</span> master</div></pre></td></tr></table></figure></p>\n<h2 id=\"分类与标签\"><a href=\"#分类与标签\" class=\"headerlink\" title=\"分类与标签\"></a>分类与标签</h2><p>1.若已存在分类或标签，则直接修改。<br>打开<code>hexo/source/tags/index.md</code>。修改为如下。<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"symbol\">title:</span> tags</div><div class=\"line\"><span class=\"symbol\">date:</span> <span class=\"number\">2016</span><span class=\"number\">-03</span><span class=\"number\">-16</span> <span class=\"number\">15</span>:<span class=\"number\">33</span>:<span class=\"number\">44</span></div><div class=\"line\"><span class=\"symbol\">type:</span> <span class=\"string\">\"tags\"</span></div></pre></td></tr></table></figure></p>\n<p>时间可随意修改，必须设置type字段为”tags”。<br>分类也如此：<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"symbol\">title:</span> categories</div><div class=\"line\"><span class=\"symbol\">date:</span> <span class=\"number\">2016</span><span class=\"number\">-03</span><span class=\"number\">-16</span> <span class=\"number\">15</span>:<span class=\"number\">33</span>:<span class=\"number\">56</span></div><div class=\"line\"><span class=\"symbol\">type:</span> <span class=\"string\">\"categories\"</span></div></pre></td></tr></table></figure></p>\n<p>2.若不存在，则直接新建，修改为1中所示即可。<br><figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo <span class=\"keyword\">new</span> <span class=\"type\">page</span> <span class=\"string\">\"tags\"</span></div><div class=\"line\">$ hexo <span class=\"keyword\">new</span> <span class=\"type\">page</span> <span class=\"string\">\"categories\"</span></div></pre></td></tr></table></figure></p>\n<p>index.md中不需要再额外写什么东西，它会根据你日志的分类、标签自动匹配。<br><figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">title: Windows使用Hexo + Github Pages搭建自己的博客</div><div class=\"line\">date: 2016<span class=\"string\">-03</span><span class=\"string\">-17</span> 11:30:45</div><div class=\"line\"><span class=\"keyword\">tags:</span></div><div class=\"line\"> - blog</div><div class=\"line\"> - hexo</div><div class=\"line\">categories: hexo</div></pre></td></tr></table></figure></p>\n<h2 id=\"主题\"><a href=\"#主题\" class=\"headerlink\" title=\"主题\"></a>主题</h2><p>hexo有许多主题可以选择，可以参考<a href=\"https://www.zhihu.com/question/24422335\">知乎回答</a>选择自己喜欢的主题。<br>我这里选择的是next主题。</p>\n<h3 id=\"下载主题\"><a href=\"#下载主题\" class=\"headerlink\" title=\"下载主题\"></a>下载主题</h3><p>使用Git Bash进入到hexo目录。输入指令下载主题：<br><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git clone http<span class=\"variable\">s:</span>//github.<span class=\"keyword\">com</span>/iissnan/hexo-theme-<span class=\"keyword\">next</span> themes/<span class=\"keyword\">next</span></div></pre></td></tr></table></figure></p>\n<h3 id=\"使用主题\"><a href=\"#使用主题\" class=\"headerlink\" title=\"使用主题\"></a>使用主题</h3><p>回到上面的_config.yml配置文件中，找到theme字段，修改成next主题：<br><figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># Extensions</div><div class=\"line\">## Plugins: https:<span class=\"comment\">//hexo.io/plugins/</span></div><div class=\"line\">## Themes: https:<span class=\"comment\">//hexo.io/themes/</span></div><div class=\"line\">theme: hexo-theme-next</div></pre></td></tr></table></figure></p>\n<h2 id=\"Next主题相关\"><a href=\"#Next主题相关\" class=\"headerlink\" title=\"Next主题相关\"></a>Next主题相关</h2><h3 id=\"语言\"><a href=\"#语言\" class=\"headerlink\" title=\"语言\"></a>语言</h3><p><code>hexo/_config.yml</code>的配置中，language字段若要使用中文，需使用<code>zh-Hans</code>。</p>\n<h3 id=\"菜单\"><a href=\"#菜单\" class=\"headerlink\" title=\"菜单\"></a>菜单</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br><code>menu</code>是设置菜单，<code>menu_icons</code>是设置菜单对应的图标。这里对应的key都必须是一样的，大小写也有区分。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></div><div class=\"line\"><span class=\"comment\"># Menu Settings</span></div><div class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># When running hexo in a subdirectory (e.g. domain.tld/blog)</span></div><div class=\"line\"><span class=\"comment\"># Remove leading slashes ( \"/archives\" -&gt; \"archives\" )</span></div><div class=\"line\"><span class=\"attr\">menu:</span></div><div class=\"line\"><span class=\"attr\">  home:</span> /</div><div class=\"line\"><span class=\"attr\">  categories:</span> /categories</div><div class=\"line\"><span class=\"attr\">  archives:</span> /archives</div><div class=\"line\"><span class=\"attr\">  tags:</span> /tags</div><div class=\"line\">  <span class=\"comment\"># about: /about</span></div><div class=\"line\"><span class=\"attr\">  commonweal:</span> /<span class=\"number\">404.</span>html</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Enable/Disable menu icons.</span></div><div class=\"line\"><span class=\"comment\"># Icon Mapping:</span></div><div class=\"line\"><span class=\"comment\">#   Map a menu item to a specific FontAwesome icon name.</span></div><div class=\"line\"><span class=\"comment\">#   Key is the name of menu item and value is the name of FontAwsome icon.</span></div><div class=\"line\"><span class=\"comment\">#   When an question mask icon presenting up means that the item has no mapping icon.</span></div><div class=\"line\"><span class=\"attr\">menu_icons:</span></div><div class=\"line\"><span class=\"attr\">  enable:</span> <span class=\"literal\">true</span></div><div class=\"line\">  <span class=\"comment\"># Icon Mapping.</span></div><div class=\"line\"><span class=\"attr\">  home:</span> home</div><div class=\"line\"><span class=\"attr\">  about:</span> user</div><div class=\"line\"><span class=\"attr\">  categories:</span> th</div><div class=\"line\"><span class=\"attr\">  tags:</span> tags</div><div class=\"line\"><span class=\"attr\">  archives:</span> archive</div><div class=\"line\"><span class=\"attr\">  commonweal:</span> heartbeat</div></pre></td></tr></table></figure></p>\n<h3 id=\"设置个人信息\"><a href=\"#设置个人信息\" class=\"headerlink\" title=\"设置个人信息\"></a>设置个人信息</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>将图像avatar.png放在hexo/themes/hexo-theme-next/source/images目录下。<br><code>avatar</code>–&gt;个人头像，<code>author</code>–&gt;昵称，<code>description</code>–&gt;描述<br><figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">avatar</span>: /images/avatar.png</div><div class=\"line\"></div><div class=\"line\"><span class=\"http\"><span class=\"attribute\">author</span>: lastwarmth</div><div class=\"line\"></div><div class=\"line\"><span class=\"avrasm\"><span class=\"symbol\">description:</span> 如果要飞得高，就该把地平线忘掉</span></span></div></pre></td></tr></table></figure></p>\n<h3 id=\"社交信息\"><a href=\"#社交信息\" class=\"headerlink\" title=\"社交信息\"></a>社交信息</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>设置社交信息与icon，与菜单一样，key值需要完全对应，区分大小写。<br><figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\"># Social links</span></div><div class=\"line\"><span class=\"symbol\">social:</span></div><div class=\"line\"><span class=\"symbol\">  GitHub:</span> https:<span class=\"comment\">//github.com/LiJia92</span></div><div class=\"line\"><span class=\"symbol\">  Weibo:</span> http:<span class=\"comment\">//weibo.com/2950244271</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\"># Social Icons</span></div><div class=\"line\"><span class=\"symbol\">social_icons:</span></div><div class=\"line\"><span class=\"symbol\">  enable:</span> true</div><div class=\"line\">  <span class=\"meta\"># Icon Mappings</span></div><div class=\"line\"><span class=\"symbol\">  GitHub:</span> github</div><div class=\"line\"><span class=\"symbol\">  Twitter:</span> twitter</div><div class=\"line\"><span class=\"symbol\">  Weibo:</span> weibo</div></pre></td></tr></table></figure></p>\n<h3 id=\"Schemes\"><a href=\"#Schemes\" class=\"headerlink\" title=\"Schemes\"></a>Schemes</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>Next主题有三种Scheme，可随意切换。<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-id\">#scheme</span>: Muse</div><div class=\"line\"><span class=\"selector-id\">#scheme</span>: Mist</div><div class=\"line\">scheme: Pisces</div></pre></td></tr></table></figure></p>\n<h3 id=\"网站图标\"><a href=\"#网站图标\" class=\"headerlink\" title=\"网站图标\"></a>网站图标</h3><p>与设置个人图像类似。<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># Place your favicon.ico to /source directory.</span></div><div class=\"line\">favicon: <span class=\"regexp\">/images/</span>avatar.png</div></pre></td></tr></table></figure></p>\n<h3 id=\"集成多说\"><a href=\"#集成多说\" class=\"headerlink\" title=\"集成多说\"></a>集成多说</h3><p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>设置<code>duoshuo_shortname</code>字段。<br><figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\"># Duoshuo ShortName</span></div><div class=\"line\"><span class=\"symbol\">duoshuo_shortname:</span> lastwarmth</div></pre></td></tr></table></figure></p>\n<p>这个ShortName怎么来？<br>进入<a href=\"http://duoshuo.com/create-site/\">多说</a><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tipsduoshuo-create-site.png\" alt=\"这里写图片描述\"><br>红色方框填写的即是ShortName</p>\n<h3 id=\"代码高亮\"><a href=\"#代码高亮\" class=\"headerlink\" title=\"代码高亮\"></a>代码高亮</h3><p><code>hexo/_config.yml</code>的配置中。<br>修改<code>auto_detect</code>字段为<code>true</code><br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">highlight:</span></div><div class=\"line\"><span class=\"attr\">  enable:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  line_number:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  auto_detect:</span> <span class=\"literal\">true</span></div><div class=\"line\"><span class=\"attr\">  tab_replace:</span></div></pre></td></tr></table></figure></p>\n<p><code>hexo/themes/hexo-theme-next/_config.yml</code>的配置中。<br>修改<code>highlight_theme: normal</code>字段。NexT使用<code>Tomorrow Theme</code>作为代码高亮，共有5款主题供你选择，可选的值有 normal，night， night blue， night bright， night eighties。<br><figure class=\"highlight vala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\"># Code Highlight theme</span></div><div class=\"line\"><span class=\"meta\"># Available value:</span></div><div class=\"line\"><span class=\"meta\">#    normal | night | night eighties | night blue | night bright</span></div><div class=\"line\"><span class=\"meta\"># https://github.com/chriskempson/tomorrow-theme</span></div><div class=\"line\">highlight_theme: normal</div></pre></td></tr></table></figure></p>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><blockquote>\n<p>本地预览没问题，deploy后主页显示大面积空白</p>\n</blockquote>\n<p><a href=\"https://github.com/iissnan/hexo-theme-next/issues/1214\">点此</a></p>\n<h3 id=\"更多\"><a href=\"#更多\" class=\"headerlink\" title=\"更多\"></a>更多</h3><p>更多请查看<a href=\"http://theme-next.iissnan.com/getting-started.html#third-party-services\"> Next </a>官网</p>"},{"title":"Hexo-Tools","date":"2016-03-17T10:14:16.000Z","_content":"\n本文主要讲述一下使用Hexo搭建博客的过程中，使用的一些比较实用的工具。\n\n## 七牛\n### 介绍\n在博客中若要插入图片，我们可以直接将图片放在本地。但是这样的话，在deploy的时候，图片也会上传至Github。但是Github上的空间只有300Mb，很有可能导致以后不够用，所以最好找一个图床。\n之前听说过七牛，便打算试一试。\n它：\n1. 注册之后实名制便有10G的免费空间，一段时间内是肯定够用的；\n2. 比较稳定；\n3. 有很多实用的工具，你可以使用；\n4. 更多的就待以后慢慢发现了~\n\n<!--more-->\n\n### 注册\n1. 去到[七牛官网](https://portal.qiniu.com/signin)注册账户。\n\n### 上传图片\n2. 创建空间。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools1.png)\n3. 长传图片。\n选择空间后，点击内容管理。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools4.png)\n点击上传文件。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools2.png)\n在长传文件时，建议加入路径前缀，方便后面进行查找。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools3.png)\n\n### 使用图片\n1. 在七牛中预览图片，点击复制外链。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools5.png)\n2. 在Markdown中引用\n```\n![这里输入图片描述](图片外链地址)\n```\n\n## Atom\n### 介绍\n在代码编辑器、文本编辑器领域，有着不少的「神器」级的产品，如历史悠久的 VIM、Emacs 以及如今当红的 SublimeText。另外还有 EditPlus、NotePad++、UltraEdit 等一大堆流行的利器，可谓百家争鸣。\n\n然而，作为目前全球范围内影响力最大的代码仓库/开源社区，GitHub 的程序员们并不满足于此。他们使用目前最先进流行的技术重新打造了一款称为“属于21世纪”的代码编辑器——``Atom``， 它开源免费跨平台，并且整合 GIT 并提供类似 SublimeText 的包管理功能，支持插件扩展，可配置性非常高……\n\n> ATOM - 由 GitHub 打造更为先进的编辑器\n\n### 安装\n去到[ Atom ](https://atom.io/)官网，进行下载安装。\n### 使用\n点击File-->Open Folder...\n打开自己的工程。\n然后便可以随心所欲的编辑了~\n### Markdown编辑与预览\n1. 打开任意.md文件(Markdown源文件);\n2. windows下使用快捷键 ctrl + shift + p，打开命令输入框；\n3. 输入``Markdown Preview Toggle``(可以偷懒只输入mdpt，支持模糊匹配)。也可以通过菜单栏Packages->Markdown Preview->Toggle Treview。按enter键即可看到预览，左边编辑，右边实时预览。也可以直接使用快捷键``Ctrl + Shift + M``。\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools6.png)\n如此便能非常方便的编辑、预览我们的博客了。\n","source":"_posts/hexo-tools.md","raw":"---\ntitle: Hexo-Tools\ndate: 2016-03-17 18:14:16\ntags:\n - blog\n---\n\n本文主要讲述一下使用Hexo搭建博客的过程中，使用的一些比较实用的工具。\n\n## 七牛\n### 介绍\n在博客中若要插入图片，我们可以直接将图片放在本地。但是这样的话，在deploy的时候，图片也会上传至Github。但是Github上的空间只有300Mb，很有可能导致以后不够用，所以最好找一个图床。\n之前听说过七牛，便打算试一试。\n它：\n1. 注册之后实名制便有10G的免费空间，一段时间内是肯定够用的；\n2. 比较稳定；\n3. 有很多实用的工具，你可以使用；\n4. 更多的就待以后慢慢发现了~\n\n<!--more-->\n\n### 注册\n1. 去到[七牛官网](https://portal.qiniu.com/signin)注册账户。\n\n### 上传图片\n2. 创建空间。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools1.png)\n3. 长传图片。\n选择空间后，点击内容管理。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools4.png)\n点击上传文件。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools2.png)\n在长传文件时，建议加入路径前缀，方便后面进行查找。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools3.png)\n\n### 使用图片\n1. 在七牛中预览图片，点击复制外链。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools5.png)\n2. 在Markdown中引用\n```\n![这里输入图片描述](图片外链地址)\n```\n\n## Atom\n### 介绍\n在代码编辑器、文本编辑器领域，有着不少的「神器」级的产品，如历史悠久的 VIM、Emacs 以及如今当红的 SublimeText。另外还有 EditPlus、NotePad++、UltraEdit 等一大堆流行的利器，可谓百家争鸣。\n\n然而，作为目前全球范围内影响力最大的代码仓库/开源社区，GitHub 的程序员们并不满足于此。他们使用目前最先进流行的技术重新打造了一款称为“属于21世纪”的代码编辑器——``Atom``， 它开源免费跨平台，并且整合 GIT 并提供类似 SublimeText 的包管理功能，支持插件扩展，可配置性非常高……\n\n> ATOM - 由 GitHub 打造更为先进的编辑器\n\n### 安装\n去到[ Atom ](https://atom.io/)官网，进行下载安装。\n### 使用\n点击File-->Open Folder...\n打开自己的工程。\n然后便可以随心所欲的编辑了~\n### Markdown编辑与预览\n1. 打开任意.md文件(Markdown源文件);\n2. windows下使用快捷键 ctrl + shift + p，打开命令输入框；\n3. 输入``Markdown Preview Toggle``(可以偷懒只输入mdpt，支持模糊匹配)。也可以通过菜单栏Packages->Markdown Preview->Toggle Treview。按enter键即可看到预览，左边编辑，右边实时预览。也可以直接使用快捷键``Ctrl + Shift + M``。\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools6.png)\n如此便能非常方便的编辑、预览我们的博客了。\n","slug":"hexo-tools","published":1,"updated":"2016-11-21T09:59:36.665Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e758y00171cb86mtqgtx9","content":"<p>本文主要讲述一下使用Hexo搭建博客的过程中，使用的一些比较实用的工具。</p>\n<h2 id=\"七牛\"><a href=\"#七牛\" class=\"headerlink\" title=\"七牛\"></a>七牛</h2><h3 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h3><p>在博客中若要插入图片，我们可以直接将图片放在本地。但是这样的话，在deploy的时候，图片也会上传至Github。但是Github上的空间只有300Mb，很有可能导致以后不够用，所以最好找一个图床。<br>之前听说过七牛，便打算试一试。<br>它：</p>\n<ol>\n<li>注册之后实名制便有10G的免费空间，一段时间内是肯定够用的；</li>\n<li>比较稳定；</li>\n<li>有很多实用的工具，你可以使用；</li>\n<li>更多的就待以后慢慢发现了~</li>\n</ol>\n<a id=\"more\"></a>\n<h3 id=\"注册\"><a href=\"#注册\" class=\"headerlink\" title=\"注册\"></a>注册</h3><ol>\n<li>去到<a href=\"https://portal.qiniu.com/signin\" target=\"_blank\" rel=\"external\">七牛官网</a>注册账户。</li>\n</ol>\n<h3 id=\"上传图片\"><a href=\"#上传图片\" class=\"headerlink\" title=\"上传图片\"></a>上传图片</h3><ol>\n<li>创建空间。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools1.png\" alt=\"\"></li>\n<li>长传图片。<br>选择空间后，点击内容管理。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools4.png\" alt=\"\"><br>点击上传文件。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools2.png\" alt=\"\"><br>在长传文件时，建议加入路径前缀，方便后面进行查找。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools3.png\" alt=\"\"></li>\n</ol>\n<h3 id=\"使用图片\"><a href=\"#使用图片\" class=\"headerlink\" title=\"使用图片\"></a>使用图片</h3><ol>\n<li>在七牛中预览图片，点击复制外链。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools5.png\" alt=\"\"></li>\n<li>在Markdown中引用<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">![<span class=\"string\">这里输入图片描述</span>](<span class=\"link\">图片外链地址</span>)</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"Atom\"><a href=\"#Atom\" class=\"headerlink\" title=\"Atom\"></a>Atom</h2><h3 id=\"介绍-1\"><a href=\"#介绍-1\" class=\"headerlink\" title=\"介绍\"></a>介绍</h3><p>在代码编辑器、文本编辑器领域，有着不少的「神器」级的产品，如历史悠久的 VIM、Emacs 以及如今当红的 SublimeText。另外还有 EditPlus、NotePad++、UltraEdit 等一大堆流行的利器，可谓百家争鸣。</p>\n<p>然而，作为目前全球范围内影响力最大的代码仓库/开源社区，GitHub 的程序员们并不满足于此。他们使用目前最先进流行的技术重新打造了一款称为“属于21世纪”的代码编辑器——<code>Atom</code>， 它开源免费跨平台，并且整合 GIT 并提供类似 SublimeText 的包管理功能，支持插件扩展，可配置性非常高……</p>\n<blockquote>\n<p>ATOM - 由 GitHub 打造更为先进的编辑器</p>\n</blockquote>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>去到<a href=\"https://atom.io/\" target=\"_blank\" rel=\"external\"> Atom </a>官网，进行下载安装。</p>\n<h3 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h3><p>点击File–&gt;Open Folder…<br>打开自己的工程。<br>然后便可以随心所欲的编辑了~</p>\n<h3 id=\"Markdown编辑与预览\"><a href=\"#Markdown编辑与预览\" class=\"headerlink\" title=\"Markdown编辑与预览\"></a>Markdown编辑与预览</h3><ol>\n<li>打开任意.md文件(Markdown源文件);</li>\n<li>windows下使用快捷键 ctrl + shift + p，打开命令输入框；</li>\n<li>输入<code>Markdown Preview Toggle</code>(可以偷懒只输入mdpt，支持模糊匹配)。也可以通过菜单栏Packages-&gt;Markdown Preview-&gt;Toggle Treview。按enter键即可看到预览，左边编辑，右边实时预览。也可以直接使用快捷键<code>Ctrl + Shift + M</code>。</li>\n</ol>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools6.png\" alt=\"\"><br>如此便能非常方便的编辑、预览我们的博客了。</p>\n","excerpt":"<p>本文主要讲述一下使用Hexo搭建博客的过程中，使用的一些比较实用的工具。</p>\n<h2 id=\"七牛\"><a href=\"#七牛\" class=\"headerlink\" title=\"七牛\"></a>七牛</h2><h3 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h3><p>在博客中若要插入图片，我们可以直接将图片放在本地。但是这样的话，在deploy的时候，图片也会上传至Github。但是Github上的空间只有300Mb，很有可能导致以后不够用，所以最好找一个图床。<br>之前听说过七牛，便打算试一试。<br>它：</p>\n<ol>\n<li>注册之后实名制便有10G的免费空间，一段时间内是肯定够用的；</li>\n<li>比较稳定；</li>\n<li>有很多实用的工具，你可以使用；</li>\n<li>更多的就待以后慢慢发现了~</li>\n</ol>","more":"<h3 id=\"注册\"><a href=\"#注册\" class=\"headerlink\" title=\"注册\"></a>注册</h3><ol>\n<li>去到<a href=\"https://portal.qiniu.com/signin\">七牛官网</a>注册账户。</li>\n</ol>\n<h3 id=\"上传图片\"><a href=\"#上传图片\" class=\"headerlink\" title=\"上传图片\"></a>上传图片</h3><ol>\n<li>创建空间。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools1.png\" alt=\"\"></li>\n<li>长传图片。<br>选择空间后，点击内容管理。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools4.png\" alt=\"\"><br>点击上传文件。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools2.png\" alt=\"\"><br>在长传文件时，建议加入路径前缀，方便后面进行查找。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools3.png\" alt=\"\"></li>\n</ol>\n<h3 id=\"使用图片\"><a href=\"#使用图片\" class=\"headerlink\" title=\"使用图片\"></a>使用图片</h3><ol>\n<li>在七牛中预览图片，点击复制外链。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools5.png\" alt=\"\"></li>\n<li>在Markdown中引用<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">![<span class=\"string\">这里输入图片描述</span>](<span class=\"link\">图片外链地址</span>)</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"Atom\"><a href=\"#Atom\" class=\"headerlink\" title=\"Atom\"></a>Atom</h2><h3 id=\"介绍-1\"><a href=\"#介绍-1\" class=\"headerlink\" title=\"介绍\"></a>介绍</h3><p>在代码编辑器、文本编辑器领域，有着不少的「神器」级的产品，如历史悠久的 VIM、Emacs 以及如今当红的 SublimeText。另外还有 EditPlus、NotePad++、UltraEdit 等一大堆流行的利器，可谓百家争鸣。</p>\n<p>然而，作为目前全球范围内影响力最大的代码仓库/开源社区，GitHub 的程序员们并不满足于此。他们使用目前最先进流行的技术重新打造了一款称为“属于21世纪”的代码编辑器——<code>Atom</code>， 它开源免费跨平台，并且整合 GIT 并提供类似 SublimeText 的包管理功能，支持插件扩展，可配置性非常高……</p>\n<blockquote>\n<p>ATOM - 由 GitHub 打造更为先进的编辑器</p>\n</blockquote>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>去到<a href=\"https://atom.io/\"> Atom </a>官网，进行下载安装。</p>\n<h3 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h3><p>点击File–&gt;Open Folder…<br>打开自己的工程。<br>然后便可以随心所欲的编辑了~</p>\n<h3 id=\"Markdown编辑与预览\"><a href=\"#Markdown编辑与预览\" class=\"headerlink\" title=\"Markdown编辑与预览\"></a>Markdown编辑与预览</h3><ol>\n<li>打开任意.md文件(Markdown源文件);</li>\n<li>windows下使用快捷键 ctrl + shift + p，打开命令输入框；</li>\n<li>输入<code>Markdown Preview Toggle</code>(可以偷懒只输入mdpt，支持模糊匹配)。也可以通过菜单栏Packages-&gt;Markdown Preview-&gt;Toggle Treview。按enter键即可看到预览，左边编辑，右边实时预览。也可以直接使用快捷键<code>Ctrl + Shift + M</code>。</li>\n</ol>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/hexo-tools6.png\" alt=\"\"><br>如此便能非常方便的编辑、预览我们的博客了。</p>"},{"title":"Android Hybrid开发入门：原生Android与JS的交互","date":"2015-12-25T07:03:16.000Z","_content":"\n## 介绍\n我们知道，现在App大致分为3类：``Hybrid App``、``Web App``、``Native App``。Hybrid App兼具“Native App良好用户交互体验的优势”和“Web App跨平台开发的优势”，市面上现在也有许多Hybrid App。\n\n最近做的项目，也会使用到Hybrid开发，之前没做过的。所以今天初步学习了一下，记录一下学习心得。\n\n## 代码\n首先，新建一个新的AS module，然后新建assets目录，至于src/main文件夹下。如下图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/12/hybrid-introduction1.png)\n我们再assets目录下，新建一个hello.html，编辑内容如下：\n```\n<html>\n<head>\n    <script>\n    function hello() {\n        document.getElementById(\"demo\").innerHTML = \"Hello Hybrid!\";\n    }\n    </script>\n</head>\n<body>\n<div>\n    <a href=\"#\" id=\"demo\" onclick=\"window.demo.clickOnAndroid()\">Click Me</a>\n</div>\n</body>\n</html>\n```\n一个很简单的html页面。\n\n<!--more-->\n\n然后新建一个WebViewActivity。\n```\npublic class WebViewActivity extends Activity {\n\n    private WebView webView;\n    private Context mContext;\n    private Handler mHandler = new Handler();\n\n    @SuppressLint(\"JavascriptInterface\")\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        mContext = this;\n        // 创建WebView对象\n        webView = new WebView(this);\n        // 切换到内容视图\n        setContentView(webView);\n        // 获取WebView配置\n        WebSettings ws = webView.getSettings();\n        // 启用JavaScript\n        ws.setJavaScriptEnabled(true);\n        // 载入assets目录下的一个页面\n        webView.loadUrl(\"file:///android_asset/hello.html\");\n        // 添加交互接口\n        webView.addJavascriptInterface(new Object() {\n            @JavascriptInterface\n            public void clickOnAndroid() {\n                Toast.makeText(mContext, \"Hello Hybrid.\", Toast.LENGTH_SHORT).show();\n                mHandler.post(new Runnable() {\n                    public void run() {\n                        webView.loadUrl(\"javascript:hello()\");\n                    }\n                });\n            }\n        }, \"demo\");\n    }\n}\n```\n通过WebView的loadUrl，填入我们hello.html的路径，便能在App中加载这个页面了。（别忘记在AndroidManifest.xml中声明Activity）\nloadUrl填入JS方法，则可调JS方法。\n注意使用的handler发送消息来更新。如是直接webView.loadUrl(\"javascript:hello()\");可能会导致如下错误：\n\n > <font color=red>java.lang.Throwable: A WebView method was called on thread 'JavaBridge'. All WebView methods must be called on the same thread. (Expected Looper Looper (main, tid 1) {425f48a8} called on Looper (JavaBridge, tid 92104) {426508d0}, FYI main Looper is Looper (main, tid 1) {425f48a8})\n\n即是需要在同一个进程中进行更新，所以需要使用handler发送消息更新。\n\n回到AS帮我们自动建好的MainActivity。修改FloatingActionButton点击事件：\n```\nFloatingActionButton fab = (FloatingActionButton) findViewById(R.id.fab);\n        fab.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View view) {\n                Intent intent = new Intent(MainActivity.this, WebViewActivity.class);\n                startActivity(intent);\n            }\n        });\n```\n启动应用，看下效果：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/12/hybrid-introduction2.png)\n可以看到，点击“click me”的时候，弹出了Toast，并且button的text改变了，这即是android与js的交互。当然，这个交互十分简单，后面还有很多的坑要踩~\n\n## Tips\n注意到代码中的clickOnAndroid方法上方的注解``@JavascriptInterface``，这个注解很关键。若没有这个注解，会在4.2以上版本的android上出现：``Uncaught TypeError: Object [object Object] has no method xxx``的错误。\n\n对于4.2之前的版本，采用这种方式可能会被恶意JS攻击，诸如平台型App需要访问三方Html的则不建议采用这种方式实现交互。\n\n## 更多\n前面示例js调用android是通过addJavascriptInterface来进行交互的，下面再介绍2种方式。\n\n - 重写WebViewClient.shouldOverrideUrlLoading：\n```\nwebView.setWebViewClient(new WebViewClient() {\n            @Override\n            public boolean shouldOverrideUrlLoading(WebView view, String url) {\n                Toast.makeText(mContext, url, Toast.LENGTH_SHORT).show();\n                return super.shouldOverrideUrlLoading(view, url);\n            }\n        });\n```\n当页面内的URL发生变化时，如点击链接、执行JavaScript（如location.href=\"xxxxxxx\"）等均会触发WebViewClient.shouldOverrideUrlLoading，通过将Web调用Native的数据封装在URL，再由Native解析数据并执行响应Native方法。\n\n例如：将前面示例中的hello.html改成如下：\n```\n<html>\n<head>\n    <script>\n    function hello() {\n        document.getElementById(\"demo\").innerHTML = \"Hello Hybrid!\";\n    }\n    </script>\n</head>\n<body>\n<div>\n    <a href=\"hybrid.html\" id=\"demo\" onclick=\"window.demo.clickOnAndroid()\">Click Me</a>\n</div>\n</body>\n</html>\n```\n在点击“Click Me\"之后，页面会跳转到hybrid.html，此时便会进入native执行shouldOverrideUrlLoading方法，再来解析Url，并执行相应的native方法。\n\n -  重写WebChromeClient.onJsPrompt，或onJsConfirm，或onJsAlert：\n```\nwebView.setWebChromeClient(new WebChromeClient() {\n            public boolean onJsPrompt(WebView view, String url, String message, String defaultValue, JsPromptResult result) {\n                Toast.makeText(mContext, url, Toast.LENGTH_SHORT).show();\n                result.confirm(\"\");\n                return true;\n            }\n        });\n```\n当执行“window.prompt（“{}”）”这样的JavaScript代码时，将会触发WebChromeClient.onJsPrompt。onJsConfirm、onJsAlert也是如此。\n\n例如：将前面示例中的hello.html改成如下：\n```\n<html>\n<head>\n    <script>\n    function hello() {\n        document.getElementById(\"demo\").innerHTML = \"Hello Hybrid!\";\n    }\n    </script>\n</head>\n<body>\n<div>\n    <a href=\"#\" id=\"demo\" onclick=\"window.prompt('Hello')\">Click Me</a>\n</div>\n</body>\n</html>\n```\n当点击“Click Me”时，会进入native执行onJsPrompt方法，再来解析url，message，并执行相应的native方法。\n\n## 最后\nGithub上找到一个开源库：[safe-java-js-webview-bridge](https://github.com/pedant/safe-java-js-webview-bridge)，便是采用的这种方式进行交互，并做了更好的封装，是个不错的选择。\n","source":"_posts/hybrid-introduction.md","raw":"---\ntitle: Android Hybrid开发入门：原生Android与JS的交互\ndate: 2015-12-25 15:03:16\ntags:\n - hybrid开发\n---\n\n## 介绍\n我们知道，现在App大致分为3类：``Hybrid App``、``Web App``、``Native App``。Hybrid App兼具“Native App良好用户交互体验的优势”和“Web App跨平台开发的优势”，市面上现在也有许多Hybrid App。\n\n最近做的项目，也会使用到Hybrid开发，之前没做过的。所以今天初步学习了一下，记录一下学习心得。\n\n## 代码\n首先，新建一个新的AS module，然后新建assets目录，至于src/main文件夹下。如下图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/12/hybrid-introduction1.png)\n我们再assets目录下，新建一个hello.html，编辑内容如下：\n```\n<html>\n<head>\n    <script>\n    function hello() {\n        document.getElementById(\"demo\").innerHTML = \"Hello Hybrid!\";\n    }\n    </script>\n</head>\n<body>\n<div>\n    <a href=\"#\" id=\"demo\" onclick=\"window.demo.clickOnAndroid()\">Click Me</a>\n</div>\n</body>\n</html>\n```\n一个很简单的html页面。\n\n<!--more-->\n\n然后新建一个WebViewActivity。\n```\npublic class WebViewActivity extends Activity {\n\n    private WebView webView;\n    private Context mContext;\n    private Handler mHandler = new Handler();\n\n    @SuppressLint(\"JavascriptInterface\")\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        mContext = this;\n        // 创建WebView对象\n        webView = new WebView(this);\n        // 切换到内容视图\n        setContentView(webView);\n        // 获取WebView配置\n        WebSettings ws = webView.getSettings();\n        // 启用JavaScript\n        ws.setJavaScriptEnabled(true);\n        // 载入assets目录下的一个页面\n        webView.loadUrl(\"file:///android_asset/hello.html\");\n        // 添加交互接口\n        webView.addJavascriptInterface(new Object() {\n            @JavascriptInterface\n            public void clickOnAndroid() {\n                Toast.makeText(mContext, \"Hello Hybrid.\", Toast.LENGTH_SHORT).show();\n                mHandler.post(new Runnable() {\n                    public void run() {\n                        webView.loadUrl(\"javascript:hello()\");\n                    }\n                });\n            }\n        }, \"demo\");\n    }\n}\n```\n通过WebView的loadUrl，填入我们hello.html的路径，便能在App中加载这个页面了。（别忘记在AndroidManifest.xml中声明Activity）\nloadUrl填入JS方法，则可调JS方法。\n注意使用的handler发送消息来更新。如是直接webView.loadUrl(\"javascript:hello()\");可能会导致如下错误：\n\n > <font color=red>java.lang.Throwable: A WebView method was called on thread 'JavaBridge'. All WebView methods must be called on the same thread. (Expected Looper Looper (main, tid 1) {425f48a8} called on Looper (JavaBridge, tid 92104) {426508d0}, FYI main Looper is Looper (main, tid 1) {425f48a8})\n\n即是需要在同一个进程中进行更新，所以需要使用handler发送消息更新。\n\n回到AS帮我们自动建好的MainActivity。修改FloatingActionButton点击事件：\n```\nFloatingActionButton fab = (FloatingActionButton) findViewById(R.id.fab);\n        fab.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View view) {\n                Intent intent = new Intent(MainActivity.this, WebViewActivity.class);\n                startActivity(intent);\n            }\n        });\n```\n启动应用，看下效果：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/12/hybrid-introduction2.png)\n可以看到，点击“click me”的时候，弹出了Toast，并且button的text改变了，这即是android与js的交互。当然，这个交互十分简单，后面还有很多的坑要踩~\n\n## Tips\n注意到代码中的clickOnAndroid方法上方的注解``@JavascriptInterface``，这个注解很关键。若没有这个注解，会在4.2以上版本的android上出现：``Uncaught TypeError: Object [object Object] has no method xxx``的错误。\n\n对于4.2之前的版本，采用这种方式可能会被恶意JS攻击，诸如平台型App需要访问三方Html的则不建议采用这种方式实现交互。\n\n## 更多\n前面示例js调用android是通过addJavascriptInterface来进行交互的，下面再介绍2种方式。\n\n - 重写WebViewClient.shouldOverrideUrlLoading：\n```\nwebView.setWebViewClient(new WebViewClient() {\n            @Override\n            public boolean shouldOverrideUrlLoading(WebView view, String url) {\n                Toast.makeText(mContext, url, Toast.LENGTH_SHORT).show();\n                return super.shouldOverrideUrlLoading(view, url);\n            }\n        });\n```\n当页面内的URL发生变化时，如点击链接、执行JavaScript（如location.href=\"xxxxxxx\"）等均会触发WebViewClient.shouldOverrideUrlLoading，通过将Web调用Native的数据封装在URL，再由Native解析数据并执行响应Native方法。\n\n例如：将前面示例中的hello.html改成如下：\n```\n<html>\n<head>\n    <script>\n    function hello() {\n        document.getElementById(\"demo\").innerHTML = \"Hello Hybrid!\";\n    }\n    </script>\n</head>\n<body>\n<div>\n    <a href=\"hybrid.html\" id=\"demo\" onclick=\"window.demo.clickOnAndroid()\">Click Me</a>\n</div>\n</body>\n</html>\n```\n在点击“Click Me\"之后，页面会跳转到hybrid.html，此时便会进入native执行shouldOverrideUrlLoading方法，再来解析Url，并执行相应的native方法。\n\n -  重写WebChromeClient.onJsPrompt，或onJsConfirm，或onJsAlert：\n```\nwebView.setWebChromeClient(new WebChromeClient() {\n            public boolean onJsPrompt(WebView view, String url, String message, String defaultValue, JsPromptResult result) {\n                Toast.makeText(mContext, url, Toast.LENGTH_SHORT).show();\n                result.confirm(\"\");\n                return true;\n            }\n        });\n```\n当执行“window.prompt（“{}”）”这样的JavaScript代码时，将会触发WebChromeClient.onJsPrompt。onJsConfirm、onJsAlert也是如此。\n\n例如：将前面示例中的hello.html改成如下：\n```\n<html>\n<head>\n    <script>\n    function hello() {\n        document.getElementById(\"demo\").innerHTML = \"Hello Hybrid!\";\n    }\n    </script>\n</head>\n<body>\n<div>\n    <a href=\"#\" id=\"demo\" onclick=\"window.prompt('Hello')\">Click Me</a>\n</div>\n</body>\n</html>\n```\n当点击“Click Me”时，会进入native执行onJsPrompt方法，再来解析url，message，并执行相应的native方法。\n\n## 最后\nGithub上找到一个开源库：[safe-java-js-webview-bridge](https://github.com/pedant/safe-java-js-webview-bridge)，便是采用的这种方式进行交互，并做了更好的封装，是个不错的选择。\n","slug":"hybrid-introduction","published":1,"updated":"2016-11-21T10:01:01.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7591001a1cb8hanwgp1o","content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>我们知道，现在App大致分为3类：<code>Hybrid App</code>、<code>Web App</code>、<code>Native App</code>。Hybrid App兼具“Native App良好用户交互体验的优势”和“Web App跨平台开发的优势”，市面上现在也有许多Hybrid App。</p>\n<p>最近做的项目，也会使用到Hybrid开发，之前没做过的。所以今天初步学习了一下，记录一下学习心得。</p>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>首先，新建一个新的AS module，然后新建assets目录，至于src/main文件夹下。如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/12/hybrid-introduction1.png\" alt=\"这里写图片描述\"><br>我们再assets目录下，新建一个hello.html，编辑内容如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">hello</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"demo\"</span>).innerHTML = <span class=\"string\">\"Hello Hybrid!\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"#\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"demo\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"window.demo.clickOnAndroid()\"</span>&gt;</span>Click Me<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>一个很简单的html页面。</p>\n<a id=\"more\"></a>\n<p>然后新建一个WebViewActivity。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebViewActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">Activity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> WebView webView;</div><div class=\"line\">    <span class=\"keyword\">private</span> Context mContext;</div><div class=\"line\">    <span class=\"keyword\">private</span> Handler mHandler = <span class=\"keyword\">new</span> Handler();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@SuppressLint</span>(<span class=\"string\">\"JavascriptInterface\"</span>)</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        mContext = <span class=\"keyword\">this</span>;</div><div class=\"line\">        <span class=\"comment\">// 创建WebView对象</span></div><div class=\"line\">        webView = <span class=\"keyword\">new</span> WebView(<span class=\"keyword\">this</span>);</div><div class=\"line\">        <span class=\"comment\">// 切换到内容视图</span></div><div class=\"line\">        setContentView(webView);</div><div class=\"line\">        <span class=\"comment\">// 获取WebView配置</span></div><div class=\"line\">        WebSettings ws = webView.getSettings();</div><div class=\"line\">        <span class=\"comment\">// 启用JavaScript</span></div><div class=\"line\">        ws.setJavaScriptEnabled(<span class=\"keyword\">true</span>);</div><div class=\"line\">        <span class=\"comment\">// 载入assets目录下的一个页面</span></div><div class=\"line\">        webView.loadUrl(<span class=\"string\">\"file:///android_asset/hello.html\"</span>);</div><div class=\"line\">        <span class=\"comment\">// 添加交互接口</span></div><div class=\"line\">        webView.addJavascriptInterface(<span class=\"keyword\">new</span> Object() &#123;</div><div class=\"line\">            <span class=\"meta\">@JavascriptInterface</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clickOnAndroid</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">                Toast.makeText(mContext, <span class=\"string\">\"Hello Hybrid.\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">                    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">                        webView.loadUrl(<span class=\"string\">\"javascript:hello()\"</span>);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;, <span class=\"string\">\"demo\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过WebView的loadUrl，填入我们hello.html的路径，便能在App中加载这个页面了。（别忘记在AndroidManifest.xml中声明Activity）<br>loadUrl填入JS方法，则可调JS方法。<br>注意使用的handler发送消息来更新。如是直接webView.loadUrl(“javascript:hello()”);可能会导致如下错误：</p>\n<blockquote>\n<p><font color=\"red\">java.lang.Throwable: A WebView method was called on thread ‘JavaBridge’. All WebView methods must be called on the same thread. (Expected Looper Looper (main, tid 1) {425f48a8} called on Looper (JavaBridge, tid 92104) {426508d0}, FYI main Looper is Looper (main, tid 1) {425f48a8})</font></p>\n</blockquote>\n<p>即是需要在同一个进程中进行更新，所以需要使用handler发送消息更新。</p>\n<p>回到AS帮我们自动建好的MainActivity。修改FloatingActionButton点击事件：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">FloatingActionButton fab = (FloatingActionButton) findViewById(R.id.fab);</div><div class=\"line\">        fab.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View view)</span> </span>&#123;</div><div class=\"line\">                Intent intent = <span class=\"keyword\">new</span> Intent(MainActivity.<span class=\"keyword\">this</span>, WebViewActivity.class);</div><div class=\"line\">                startActivity(intent);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div></pre></td></tr></table></figure></p>\n<p>启动应用，看下效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/12/hybrid-introduction2.png\" alt=\"这里写图片描述\"><br>可以看到，点击“click me”的时候，弹出了Toast，并且button的text改变了，这即是android与js的交互。当然，这个交互十分简单，后面还有很多的坑要踩~</p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><p>注意到代码中的clickOnAndroid方法上方的注解<code>@JavascriptInterface</code>，这个注解很关键。若没有这个注解，会在4.2以上版本的android上出现：<code>Uncaught TypeError: Object [object Object] has no method xxx</code>的错误。</p>\n<p>对于4.2之前的版本，采用这种方式可能会被恶意JS攻击，诸如平台型App需要访问三方Html的则不建议采用这种方式实现交互。</p>\n<h2 id=\"更多\"><a href=\"#更多\" class=\"headerlink\" title=\"更多\"></a>更多</h2><p>前面示例js调用android是通过addJavascriptInterface来进行交互的，下面再介绍2种方式。</p>\n<ul>\n<li>重写WebViewClient.shouldOverrideUrlLoading：<figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">webView.setWebViewClient(<span class=\"keyword\">new</span> WebViewClient() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">shouldOverrideUrlLoading</span><span class=\"params\">(WebView view, String url)</span> </span>&#123;</div><div class=\"line\">                Toast.makeText(mContext, url, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">shouldOverrideUrlLoading</span><span class=\"params\">(view, url)</span></span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>当页面内的URL发生变化时，如点击链接、执行JavaScript（如location.href=”xxxxxxx”）等均会触发WebViewClient.shouldOverrideUrlLoading，通过将Web调用Native的数据封装在URL，再由Native解析数据并执行响应Native方法。</p>\n<p>例如：将前面示例中的hello.html改成如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">hello</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"demo\"</span>).innerHTML = <span class=\"string\">\"Hello Hybrid!\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"hybrid.html\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"demo\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"window.demo.clickOnAndroid()\"</span>&gt;</span>Click Me<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>在点击“Click Me”之后，页面会跳转到hybrid.html，此时便会进入native执行shouldOverrideUrlLoading方法，再来解析Url，并执行相应的native方法。</p>\n<ul>\n<li>重写WebChromeClient.onJsPrompt，或onJsConfirm，或onJsAlert：<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">webView.setWebChromeClient(<span class=\"keyword\">new</span> <span class=\"type\">WebChromeClient</span>() &#123;</div><div class=\"line\">            <span class=\"keyword\">public</span> boolean onJsPrompt(WebView view, <span class=\"keyword\">String</span> url, <span class=\"keyword\">String</span> message, <span class=\"keyword\">String</span> defaultValue, JsPromptResult result) &#123;</div><div class=\"line\">                Toast.makeText(mContext, url, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                result.confirm(<span class=\"string\">\"\"</span>);</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>当执行“window.prompt（“{}”）”这样的JavaScript代码时，将会触发WebChromeClient.onJsPrompt。onJsConfirm、onJsAlert也是如此。</p>\n<p>例如：将前面示例中的hello.html改成如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">hello</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"demo\"</span>).innerHTML = <span class=\"string\">\"Hello Hybrid!\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"#\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"demo\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"window.prompt('Hello')\"</span>&gt;</span>Click Me<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>当点击“Click Me”时，会进入native执行onJsPrompt方法，再来解析url，message，并执行相应的native方法。</p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>Github上找到一个开源库：<a href=\"https://github.com/pedant/safe-java-js-webview-bridge\" target=\"_blank\" rel=\"external\">safe-java-js-webview-bridge</a>，便是采用的这种方式进行交互，并做了更好的封装，是个不错的选择。</p>\n","excerpt":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>我们知道，现在App大致分为3类：<code>Hybrid App</code>、<code>Web App</code>、<code>Native App</code>。Hybrid App兼具“Native App良好用户交互体验的优势”和“Web App跨平台开发的优势”，市面上现在也有许多Hybrid App。</p>\n<p>最近做的项目，也会使用到Hybrid开发，之前没做过的。所以今天初步学习了一下，记录一下学习心得。</p>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>首先，新建一个新的AS module，然后新建assets目录，至于src/main文件夹下。如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/12/hybrid-introduction1.png\" alt=\"这里写图片描述\"><br>我们再assets目录下，新建一个hello.html，编辑内容如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">hello</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"demo\"</span>).innerHTML = <span class=\"string\">\"Hello Hybrid!\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"#\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"demo\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"window.demo.clickOnAndroid()\"</span>&gt;</span>Click Me<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>一个很简单的html页面。</p>","more":"<p>然后新建一个WebViewActivity。<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebViewActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">Activity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> WebView webView;</div><div class=\"line\">    <span class=\"keyword\">private</span> Context mContext;</div><div class=\"line\">    <span class=\"keyword\">private</span> Handler mHandler = <span class=\"keyword\">new</span> Handler();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@SuppressLint</span>(<span class=\"string\">\"JavascriptInterface\"</span>)</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        mContext = <span class=\"keyword\">this</span>;</div><div class=\"line\">        <span class=\"comment\">// 创建WebView对象</span></div><div class=\"line\">        webView = <span class=\"keyword\">new</span> WebView(<span class=\"keyword\">this</span>);</div><div class=\"line\">        <span class=\"comment\">// 切换到内容视图</span></div><div class=\"line\">        setContentView(webView);</div><div class=\"line\">        <span class=\"comment\">// 获取WebView配置</span></div><div class=\"line\">        WebSettings ws = webView.getSettings();</div><div class=\"line\">        <span class=\"comment\">// 启用JavaScript</span></div><div class=\"line\">        ws.setJavaScriptEnabled(<span class=\"keyword\">true</span>);</div><div class=\"line\">        <span class=\"comment\">// 载入assets目录下的一个页面</span></div><div class=\"line\">        webView.loadUrl(<span class=\"string\">\"file:///android_asset/hello.html\"</span>);</div><div class=\"line\">        <span class=\"comment\">// 添加交互接口</span></div><div class=\"line\">        webView.addJavascriptInterface(<span class=\"keyword\">new</span> Object() &#123;</div><div class=\"line\">            <span class=\"meta\">@JavascriptInterface</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clickOnAndroid</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">                Toast.makeText(mContext, <span class=\"string\">\"Hello Hybrid.\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">                    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">                        webView.loadUrl(<span class=\"string\">\"javascript:hello()\"</span>);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;, <span class=\"string\">\"demo\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过WebView的loadUrl，填入我们hello.html的路径，便能在App中加载这个页面了。（别忘记在AndroidManifest.xml中声明Activity）<br>loadUrl填入JS方法，则可调JS方法。<br>注意使用的handler发送消息来更新。如是直接webView.loadUrl(“javascript:hello()”);可能会导致如下错误：</p>\n<blockquote>\n<p><font color=red>java.lang.Throwable: A WebView method was called on thread ‘JavaBridge’. All WebView methods must be called on the same thread. (Expected Looper Looper (main, tid 1) {425f48a8} called on Looper (JavaBridge, tid 92104) {426508d0}, FYI main Looper is Looper (main, tid 1) {425f48a8})</p>\n</blockquote>\n<p>即是需要在同一个进程中进行更新，所以需要使用handler发送消息更新。</p>\n<p>回到AS帮我们自动建好的MainActivity。修改FloatingActionButton点击事件：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">FloatingActionButton fab = (FloatingActionButton) findViewById(R.id.fab);</div><div class=\"line\">        fab.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View view)</span> </span>&#123;</div><div class=\"line\">                Intent intent = <span class=\"keyword\">new</span> Intent(MainActivity.<span class=\"keyword\">this</span>, WebViewActivity.class);</div><div class=\"line\">                startActivity(intent);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div></pre></td></tr></table></figure></p>\n<p>启动应用，看下效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/12/hybrid-introduction2.png\" alt=\"这里写图片描述\"><br>可以看到，点击“click me”的时候，弹出了Toast，并且button的text改变了，这即是android与js的交互。当然，这个交互十分简单，后面还有很多的坑要踩~</p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><p>注意到代码中的clickOnAndroid方法上方的注解<code>@JavascriptInterface</code>，这个注解很关键。若没有这个注解，会在4.2以上版本的android上出现：<code>Uncaught TypeError: Object [object Object] has no method xxx</code>的错误。</p>\n<p>对于4.2之前的版本，采用这种方式可能会被恶意JS攻击，诸如平台型App需要访问三方Html的则不建议采用这种方式实现交互。</p>\n<h2 id=\"更多\"><a href=\"#更多\" class=\"headerlink\" title=\"更多\"></a>更多</h2><p>前面示例js调用android是通过addJavascriptInterface来进行交互的，下面再介绍2种方式。</p>\n<ul>\n<li>重写WebViewClient.shouldOverrideUrlLoading：<figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">webView.setWebViewClient(<span class=\"keyword\">new</span> WebViewClient() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">shouldOverrideUrlLoading</span><span class=\"params\">(WebView view, String url)</span> </span>&#123;</div><div class=\"line\">                Toast.makeText(mContext, url, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">shouldOverrideUrlLoading</span><span class=\"params\">(view, url)</span></span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>当页面内的URL发生变化时，如点击链接、执行JavaScript（如location.href=”xxxxxxx”）等均会触发WebViewClient.shouldOverrideUrlLoading，通过将Web调用Native的数据封装在URL，再由Native解析数据并执行响应Native方法。</p>\n<p>例如：将前面示例中的hello.html改成如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">hello</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"demo\"</span>).innerHTML = <span class=\"string\">\"Hello Hybrid!\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"hybrid.html\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"demo\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"window.demo.clickOnAndroid()\"</span>&gt;</span>Click Me<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>在点击“Click Me”之后，页面会跳转到hybrid.html，此时便会进入native执行shouldOverrideUrlLoading方法，再来解析Url，并执行相应的native方法。</p>\n<ul>\n<li>重写WebChromeClient.onJsPrompt，或onJsConfirm，或onJsAlert：<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">webView.setWebChromeClient(<span class=\"keyword\">new</span> <span class=\"type\">WebChromeClient</span>() &#123;</div><div class=\"line\">            <span class=\"keyword\">public</span> boolean onJsPrompt(WebView view, <span class=\"keyword\">String</span> url, <span class=\"keyword\">String</span> message, <span class=\"keyword\">String</span> defaultValue, JsPromptResult result) &#123;</div><div class=\"line\">                Toast.makeText(mContext, url, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                result.confirm(<span class=\"string\">\"\"</span>);</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>当执行“window.prompt（“{}”）”这样的JavaScript代码时，将会触发WebChromeClient.onJsPrompt。onJsConfirm、onJsAlert也是如此。</p>\n<p>例如：将前面示例中的hello.html改成如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">hello</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"demo\"</span>).innerHTML = <span class=\"string\">\"Hello Hybrid!\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"#\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"demo\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"window.prompt('Hello')\"</span>&gt;</span>Click Me<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>当点击“Click Me”时，会进入native执行onJsPrompt方法，再来解析url，message，并执行相应的native方法。</p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>Github上找到一个开源库：<a href=\"https://github.com/pedant/safe-java-js-webview-bridge\">safe-java-js-webview-bridge</a>，便是采用的这种方式进行交互，并做了更好的封装，是个不错的选择。</p>"},{"title":"Android 转 iOS","date":"2016-11-21T09:55:53.000Z","_content":"\n过完一个周末来上班，今天被技术负责人约着谈了一下，主题是：让我转iOS开发。\n\n其实在刚刚听到这个消息的时候，内心是窃喜的。因为自国庆以来，做的主要工作是预研性质的，诸如网络连接、音视频、图像处理这些非常专业的领域。也不是说自己不能够学习，主要是这些领域都是需要非常专业的人来做这些事情。通过我自学，预研，然后来做相关的开发，说实话，我自己都觉得不靠谱。所以一直以来，我对自己的工作都不是很不满意，虽然通过查资料，看文章，了解了相关东西的一点点皮毛，但是这些皮毛感觉没啥用，如果你不在这些专业的领域继续深挖进去，可以说我之前1、2月的工作都是做的无用功。当然，稍微拓宽了自己的知识层面这是不可否认的![](http://7xryow.com1.z0.glb.clouddn.com//mh121.gif)。\n\n<!-- more -->\n\n虽然是以谈的方式来进行的，但是其实我也没得选择了，只能选择同意。难不成不同意然后等着被辞退吗![](http://7xryow.com1.z0.glb.clouddn.com//mh127.gif)。目前公司是全力进攻iOS端的项目，Android可能要到后续iOS出到稳定的产品了才能慢慢接入进来，但那都是之后的事情了，基于当下的话必须给我找点事干，所以便让我来做iOS，说是同意的话就马上配电脑，前面一段时间可以自己学习，后面才会安排一些事情，其实这样挺好的。于我接触了点新鲜东西，还能体验体验苹果电脑，于公司花成本来培养我，我后面也可以帮忙现在的iOS同事做些事情，缓解他的压力。\n\n就在前不久，苹果发布新的Mackbook Pro了，主要是配备了Touch Bar和Touch Id，但是价格却是异常的贵。15英寸最低配的都得1万8软妹币。。。我的内心是崩溃的![](http://7xryow.com1.z0.glb.clouddn.com//mh118.gif)，我是打算出了新款花1万左右买台笔记本来体验一下，结果苹果闹了这么一出。纠结了好久，最后还是决定没有买，代价实在太大了。13英寸虽说便宜些，但是我还是喜欢大屏的，1万8的价格我配台外星人打游戏能打得飞起。我最近在玩梦幻西游，每天下班回家就刷刷神器副本啥的，买Mac也是考虑到梦幻有Mac客户端，但是我室友花了1万8买了台15英寸的回来，打梦幻打了一会就直接红屏了![](http://7xryow.com1.z0.glb.clouddn.com//mh124.gif)，还好我没买![](http://7xryow.com1.z0.glb.clouddn.com//mh24.gif)。\n\n现在公司能够配电脑让我去学习，我还能体验体验苹果电脑，这也解决了我之前买Mac的心结，最后也是自愿选的转iOS，后面就是要开始学习iOS的入门开发了，不过天下语言一个样，有了Java基础，再来转相信也是挺容易的。况且，大学的入门语言就是C++呢，虽然后面全忘了![](http://7xryow.com1.z0.glb.clouddn.com//mh132.gif)，但是花点功夫去学学，相信还是能捡起来的。\n\n加油！![](http://7xryow.com1.z0.glb.clouddn.com//mh109.gif)\n\n从今天开始打算在自己的博客加入一些生活杂谈方面的笔录，而不再只作为技术博客。毕竟生活不只是工作、技术，也有其他的乐趣所在嘛。\n","source":"_posts/ios.md","raw":"---\ntitle: Android 转 iOS\ndate: 2016-11-21 17:55:53\ntags:\n - 杂谈\n---\n\n过完一个周末来上班，今天被技术负责人约着谈了一下，主题是：让我转iOS开发。\n\n其实在刚刚听到这个消息的时候，内心是窃喜的。因为自国庆以来，做的主要工作是预研性质的，诸如网络连接、音视频、图像处理这些非常专业的领域。也不是说自己不能够学习，主要是这些领域都是需要非常专业的人来做这些事情。通过我自学，预研，然后来做相关的开发，说实话，我自己都觉得不靠谱。所以一直以来，我对自己的工作都不是很不满意，虽然通过查资料，看文章，了解了相关东西的一点点皮毛，但是这些皮毛感觉没啥用，如果你不在这些专业的领域继续深挖进去，可以说我之前1、2月的工作都是做的无用功。当然，稍微拓宽了自己的知识层面这是不可否认的![](http://7xryow.com1.z0.glb.clouddn.com//mh121.gif)。\n\n<!-- more -->\n\n虽然是以谈的方式来进行的，但是其实我也没得选择了，只能选择同意。难不成不同意然后等着被辞退吗![](http://7xryow.com1.z0.glb.clouddn.com//mh127.gif)。目前公司是全力进攻iOS端的项目，Android可能要到后续iOS出到稳定的产品了才能慢慢接入进来，但那都是之后的事情了，基于当下的话必须给我找点事干，所以便让我来做iOS，说是同意的话就马上配电脑，前面一段时间可以自己学习，后面才会安排一些事情，其实这样挺好的。于我接触了点新鲜东西，还能体验体验苹果电脑，于公司花成本来培养我，我后面也可以帮忙现在的iOS同事做些事情，缓解他的压力。\n\n就在前不久，苹果发布新的Mackbook Pro了，主要是配备了Touch Bar和Touch Id，但是价格却是异常的贵。15英寸最低配的都得1万8软妹币。。。我的内心是崩溃的![](http://7xryow.com1.z0.glb.clouddn.com//mh118.gif)，我是打算出了新款花1万左右买台笔记本来体验一下，结果苹果闹了这么一出。纠结了好久，最后还是决定没有买，代价实在太大了。13英寸虽说便宜些，但是我还是喜欢大屏的，1万8的价格我配台外星人打游戏能打得飞起。我最近在玩梦幻西游，每天下班回家就刷刷神器副本啥的，买Mac也是考虑到梦幻有Mac客户端，但是我室友花了1万8买了台15英寸的回来，打梦幻打了一会就直接红屏了![](http://7xryow.com1.z0.glb.clouddn.com//mh124.gif)，还好我没买![](http://7xryow.com1.z0.glb.clouddn.com//mh24.gif)。\n\n现在公司能够配电脑让我去学习，我还能体验体验苹果电脑，这也解决了我之前买Mac的心结，最后也是自愿选的转iOS，后面就是要开始学习iOS的入门开发了，不过天下语言一个样，有了Java基础，再来转相信也是挺容易的。况且，大学的入门语言就是C++呢，虽然后面全忘了![](http://7xryow.com1.z0.glb.clouddn.com//mh132.gif)，但是花点功夫去学学，相信还是能捡起来的。\n\n加油！![](http://7xryow.com1.z0.glb.clouddn.com//mh109.gif)\n\n从今天开始打算在自己的博客加入一些生活杂谈方面的笔录，而不再只作为技术博客。毕竟生活不只是工作、技术，也有其他的乐趣所在嘛。\n","slug":"ios","published":1,"updated":"2016-11-22T08:43:24.130Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7592001c1cb8r2d1efg6","content":"<p>过完一个周末来上班，今天被技术负责人约着谈了一下，主题是：让我转iOS开发。</p>\n<p>其实在刚刚听到这个消息的时候，内心是窃喜的。因为自国庆以来，做的主要工作是预研性质的，诸如网络连接、音视频、图像处理这些非常专业的领域。也不是说自己不能够学习，主要是这些领域都是需要非常专业的人来做这些事情。通过我自学，预研，然后来做相关的开发，说实话，我自己都觉得不靠谱。所以一直以来，我对自己的工作都不是很不满意，虽然通过查资料，看文章，了解了相关东西的一点点皮毛，但是这些皮毛感觉没啥用，如果你不在这些专业的领域继续深挖进去，可以说我之前1、2月的工作都是做的无用功。当然，稍微拓宽了自己的知识层面这是不可否认的<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh121.gif\" alt=\"\">。</p>\n<a id=\"more\"></a>\n<p>虽然是以谈的方式来进行的，但是其实我也没得选择了，只能选择同意。难不成不同意然后等着被辞退吗<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh127.gif\" alt=\"\">。目前公司是全力进攻iOS端的项目，Android可能要到后续iOS出到稳定的产品了才能慢慢接入进来，但那都是之后的事情了，基于当下的话必须给我找点事干，所以便让我来做iOS，说是同意的话就马上配电脑，前面一段时间可以自己学习，后面才会安排一些事情，其实这样挺好的。于我接触了点新鲜东西，还能体验体验苹果电脑，于公司花成本来培养我，我后面也可以帮忙现在的iOS同事做些事情，缓解他的压力。</p>\n<p>就在前不久，苹果发布新的Mackbook Pro了，主要是配备了Touch Bar和Touch Id，但是价格却是异常的贵。15英寸最低配的都得1万8软妹币。。。我的内心是崩溃的<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh118.gif\" alt=\"\">，我是打算出了新款花1万左右买台笔记本来体验一下，结果苹果闹了这么一出。纠结了好久，最后还是决定没有买，代价实在太大了。13英寸虽说便宜些，但是我还是喜欢大屏的，1万8的价格我配台外星人打游戏能打得飞起。我最近在玩梦幻西游，每天下班回家就刷刷神器副本啥的，买Mac也是考虑到梦幻有Mac客户端，但是我室友花了1万8买了台15英寸的回来，打梦幻打了一会就直接红屏了<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh124.gif\" alt=\"\">，还好我没买<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh24.gif\" alt=\"\">。</p>\n<p>现在公司能够配电脑让我去学习，我还能体验体验苹果电脑，这也解决了我之前买Mac的心结，最后也是自愿选的转iOS，后面就是要开始学习iOS的入门开发了，不过天下语言一个样，有了Java基础，再来转相信也是挺容易的。况且，大学的入门语言就是C++呢，虽然后面全忘了<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh132.gif\" alt=\"\">，但是花点功夫去学学，相信还是能捡起来的。</p>\n<p>加油！<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh109.gif\" alt=\"\"></p>\n<p>从今天开始打算在自己的博客加入一些生活杂谈方面的笔录，而不再只作为技术博客。毕竟生活不只是工作、技术，也有其他的乐趣所在嘛。</p>\n","excerpt":"<p>过完一个周末来上班，今天被技术负责人约着谈了一下，主题是：让我转iOS开发。</p>\n<p>其实在刚刚听到这个消息的时候，内心是窃喜的。因为自国庆以来，做的主要工作是预研性质的，诸如网络连接、音视频、图像处理这些非常专业的领域。也不是说自己不能够学习，主要是这些领域都是需要非常专业的人来做这些事情。通过我自学，预研，然后来做相关的开发，说实话，我自己都觉得不靠谱。所以一直以来，我对自己的工作都不是很不满意，虽然通过查资料，看文章，了解了相关东西的一点点皮毛，但是这些皮毛感觉没啥用，如果你不在这些专业的领域继续深挖进去，可以说我之前1、2月的工作都是做的无用功。当然，稍微拓宽了自己的知识层面这是不可否认的<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh121.gif\" alt=\"\">。</p>","more":"<p>虽然是以谈的方式来进行的，但是其实我也没得选择了，只能选择同意。难不成不同意然后等着被辞退吗<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh127.gif\" alt=\"\">。目前公司是全力进攻iOS端的项目，Android可能要到后续iOS出到稳定的产品了才能慢慢接入进来，但那都是之后的事情了，基于当下的话必须给我找点事干，所以便让我来做iOS，说是同意的话就马上配电脑，前面一段时间可以自己学习，后面才会安排一些事情，其实这样挺好的。于我接触了点新鲜东西，还能体验体验苹果电脑，于公司花成本来培养我，我后面也可以帮忙现在的iOS同事做些事情，缓解他的压力。</p>\n<p>就在前不久，苹果发布新的Mackbook Pro了，主要是配备了Touch Bar和Touch Id，但是价格却是异常的贵。15英寸最低配的都得1万8软妹币。。。我的内心是崩溃的<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh118.gif\" alt=\"\">，我是打算出了新款花1万左右买台笔记本来体验一下，结果苹果闹了这么一出。纠结了好久，最后还是决定没有买，代价实在太大了。13英寸虽说便宜些，但是我还是喜欢大屏的，1万8的价格我配台外星人打游戏能打得飞起。我最近在玩梦幻西游，每天下班回家就刷刷神器副本啥的，买Mac也是考虑到梦幻有Mac客户端，但是我室友花了1万8买了台15英寸的回来，打梦幻打了一会就直接红屏了<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh124.gif\" alt=\"\">，还好我没买<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh24.gif\" alt=\"\">。</p>\n<p>现在公司能够配电脑让我去学习，我还能体验体验苹果电脑，这也解决了我之前买Mac的心结，最后也是自愿选的转iOS，后面就是要开始学习iOS的入门开发了，不过天下语言一个样，有了Java基础，再来转相信也是挺容易的。况且，大学的入门语言就是C++呢，虽然后面全忘了<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh132.gif\" alt=\"\">，但是花点功夫去学学，相信还是能捡起来的。</p>\n<p>加油！<img src=\"http://7xryow.com1.z0.glb.clouddn.com//mh109.gif\" alt=\"\"></p>\n<p>从今天开始打算在自己的博客加入一些生活杂谈方面的笔录，而不再只作为技术博客。毕竟生活不只是工作、技术，也有其他的乐趣所在嘛。</p>"},{"title":"Android Hybrid开发实战之图片的交互","date":"2016-01-14T06:32:59.000Z","_content":"\n## 前言\n最近一直在学习Hybrid开发，如何在H5页面调用Android原生接口，并返回值，以及回调。学习了一段时间，总算是有点收获，效果也做出来了。于是写下这篇博客，记录一下。\n\n本文中我以2个接口示例，来进行讲解。第1个示例很简单，就是调用接口，返回登录Token；第2个示例是H5调用接口，弹出Android原生界面进行图片选择，选择完之后返回选择图片的Base64格式的字符串。然后H5页面接收返回的字符串，回调进行图片显示。\n\n## Base64\n首先，讲解一下Base64。图片也是一个文件，可以通过Base64返回这个文件的Base64字符串，这个字符串可以直接放到H5的img标签进行显示。\n\n<!--more-->\n\n下面做个示例，方便大家了解。\n新建一个Html文件，编写代码如下：\n```\n<html>\n<head>\n</head>\n<body>\n<img src=\"data:image/jpg;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAAwCAMAAAChd4FcAAAAA3NCSVQICAjb4U/gAAACRlBMVEUAAADi6OSMjIxSUlIrXja5trg8rFEDRhErokJ8w4pJrVxmZmYERRIinTn++P07nk/X0Naww7Stra0pdTj37/dlunUXWiS53L+ZmZmOy5pahGJKdVIQEBAsXzdni24VmC7MzMw1kEYzMzPZ4Nul1K6Wr5tWs2jp8eseaC0ufz5mZmaEoorI1cszpUkXTSJErFix2bi1tbVKSkp7e3skWC9wvn5zlHq6yL3S3dSXzqJBcEspKSnY6dxCQkLI486mvKulpaVAbUkTSx8ICAgjcDIhISHh7eM6Ojonnz1QsGP///+Dxo9Re1paWlqNqZOZzJmasJ6s1rMZGRk4pkx5wYYcYyodmzViuHPFxcVEtFl5mH/V3def0qlhh2rZ7d7F2MiEhIQ4Z0Lv8+/F4csvo0QbUidAp1OEoIoqfDozZjOx27kOSho6mkw2j0iftaMyi0S2xroSUiBrvHuFx5J0v4Lm7+eNqJOc0KVBq1TU59gpoEBskXRzc3Pg2N6tubDe5d99nYRNr1+ZmZkbWyg9pFHN18779/patWuZzJkzZT6Sq5e0xbfAz8OtvbUhazC12ryJpY6+3sXD0MbE4MmJyJUgVCtSsmXQ5tWjuKd5wobd8OEfYy0ZUCS9vb3v7+8LRxgtgD0xZzw1j0cnWjJiimp2mX2An4aUtZye1qkYmjDm5ube3t7W1tbk9+fM5NA4lEombjRWfl9Ke1K2270xhUGbs6BrjnI7akSY1aSrvq+5yr1Kc0q8zL/19fVrvXMxYjt5mX+1vbVNR7MSAAAACXBIWXMAAAsSAAALEgHS3X78AAAAFnRFWHRDcmVhdGlvbiBUaW1lADAzLzI0LzEzWoVZMQAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNXG14zYAAAt9SURBVFiFzZn/U9NoHsfDl3KFXgOWAQtUL0Kh7EiF0sUFSqG0UsoDdYQgxBM9zUbOubIo2C7feoeM8HRWdjiqq7jnJuyt685d2ivrCHg4ZvRPuydJW5ICCj/s6WeYJn1Kklfen29PnmDCJ27YAeMQwv8rx4G2DyAEyNAWR5uPT7kHEICs16vbL1pbW/vmzr+xfHTGDEAgHLuSe2biXu25c+dqSycmTpxcFj4uogoQwPFXgdKbG4vT9aJNL27cLHV3dkDwsegENSB4UBGo3ZhW21dPAxV1H5FwFxDC1TOlG0i3TDtV+kO12s0ofZJpLn4kE16K1nTuox1pHMeTBzy4i3Ju/As5AY8Q2WlAXPh5vXh0L55oxetzyqoDLl+4DHie4CC9FIccH4+JJA8uzEOhqAh9hzzPxWIwViTAeYJHv4HmC6Fvy1+/xuuqqurGq3DLkyfcUQFx4UXg1qV98ZBtrl/ZJcSX+t51NrMG1sCxlIaIGSlXHIJjfavlNMsaiJgGUAQaImw2NqYhDDyE3/ad7Vu+fvrV7dM7z/vOtoa2V8tPHjZqUoDwSuCnA/mmL90KbKe9AubGwdd3qTjQsC6KdRUhIArHb3f++fa8AXCGOCsCLgEDh3M2G+GiADi5A0LL5eDC6urO2WXQd7luZ67isD5OAoLT6wfrJ2t4PnXPYHsL3P8FASK9+FhMBEKAVcvVr/6mAZytSFJwCSLAmIHi4/MQnOwAdePboPr86s4fl0H5t+Vbq334kQDBa/fN9/KhODzzIEmIP+h811fFulgNbWBZKi4ruNx6/0WzRmMjOBflWqIIQBk0bNxA2JCL37Q+f9FxBdxfPd1x9hh48UXF+Z9bD8knA0L61cX34yG7lz4naN6qAhoiTkO6qEiQkgJh112oAnRRDEI+znM8SoJ4PJ0kS1shrhnOz1dlXeaFJaF5/PISfRRA8HVgbP/8VdhGoDrlZBxAyMbEb4rkTpcZCFMlKF1m0G9y3RE3QOryR1EQWt7+mslXv7cgrlynD4hs/ICAOmhcZpa3H2pTIiDY2iPg2KlTGxlF8VKh+4l8Mohn2FobLii/p06+ZtlFxdX/AClKPlmMSvKqTa1gRUYEbpa6f/jBXfrZ6KhisPDH3/0sHQfXyloUVhYNkWQDaJhsStpkr6w03q+/k2JtKFMdASHn8UiEoBsj0BYSOpVlKwFB86NNZQovPj1z5djS0u25G/cK0yKeWnE/Kl+SLxz8g17PMD69Xj9rZfRDBUIZw7QUMLOzswxJarU+0ivJBKb0+UBWrJ1h9LumJdsAsGOVUtA6MI3Y+5yY2mJAATg+UahK19w3ssx1128syg4XJzVfVyWFhwmkQkFe71TLSNAamWqJ4ng/OVlQcDyRKGMi7e0Pr+IJc39/f0OQGW5AW/NxPMrUNKTspbmAvFqUnW3qMoqOrUQKShun/do1u2jhHLvdBZUKzpUqXVn8aClJD+ZzV+rrF29dDDzbfiPsxoWoSY8VqQAakEZAjD/vWl6JpTcYIQuCwWAbXYB09Pms9ST69DHMTLt2cK1lKmntEfI/3ZJMYUQ0gPnt9mzYjRlAVpakS46JUMcg3lerSIcxd7plCOCJe7N44kzFVlZmWbAskAkE1u8bRFFmaQiBNnKyxUeS09Mk6Wuh6/Mm8wfzI+Tj/MHBwXrrlwnt4OQQigCrVqsdGhwm/2HThXWYqSvt0bgTM8QwTzbiM2BSVCqTpLNYAfjjs6x0FkL6n+tv39XBPVUL0hIgEAFx/PhQjdeLAGeD0Zcvo8HZKbp+2osuNSLHYIRpb9c2WRKJtYjVPJNIeGvIGQnET4TDYRPmD4clBecHMMwZAw4sR3k5TIBZb28qAFeUbRx/0GHZW1MhLSrYDmnc7BtEX4R8fWRtdLLFKp/BKgKKhadFny/eqwwIQ6FQCXOcDtF0DzmD4/yAKQ52Y7AbcwE+B8MGcjBPPBMwVwl4UdXG95lZQstkT03N9DT6qFnIK6ipebyGf1/TjgCZyPfIIsx+gIO9Pqs1DwUAST6MiAo6sW5KbCwOjAVStXEhzGwTcrdRpYgIeEIJeE41EdqnJ+FtpNWKxBI/UcxZrUwUNTLRxdpJ88iIeVJycUhyca8ozrAIGGxoCgYX8iZLSu601ZBXgV+MPL8aELVAHRp1ZQAK9CtlDG5+XrX7D/Qv1fN7RbyamDk+Onp8Zq0NMbUlZiC80/SlddA8axXLo9VnRklSZjabm5jhfrTpYVCSTIqok0xb/gKN95BXRRCHCQsDoFQQhj1YpoRiFlesKAALJ97tZvH937s/L+/gMxghBAkruhAulRmUBlfJAjOTL5jLRhbyyu40CJZpxieXGb1UZhIJbZMX5U/EOpI/G2yryfsTNqDDdJRJDaipxLBGtkutoVgHt0uVdfrmmdtJHlD3qLjwx3vu3JPHODUj+G62BM1LkmUGf6ltGvGVge8WvMP1d6ZHcLxhMD8/v3eYfNyLtoMt8CETjAwhVCuqNPrHEbKNitlQsvJSJ0kC2oxiZYQg1oV5OKgC3FJ3kpUb49LqB9j5/OIomtWIfeTt2Te0olJ767UtIlkSMN/X0uuLtmsLvJH6MpKJyv1NikF5N6oNRlPduOyllCQuBCiaA6PkLGaNpkYpoXmnTl2owdKNW6qJy6/uivvLy9V97pXF5PhG8cTE9bt1KRcLJUy9F6YAYaiA7F+oj/b4/g5qSG+vbzh5G8ksRntRbQmdNu8CKjMSIEFRRBdmJCgC78bscRsRp5ARyHhlqxOE1hX1zOqn2glkF28px06dmwgkeww9yTBm8dK4WR9E5WRKX4JcHhn67stgPekNTfse4knA79OApNKsEqDOtTs3MGZMFrrSTpbmg+fdKh8jWxwbW8wYurQRuC8B4u0+ckRGaPg30ggfWWjvIRP//Rc+OMTUWMBfSrzyrGfqD0kFBUvwcY3C8mkoNhKqMmXdhMHRpTS/0sUCPv+s+AOPTKIVn0gJH02kLtyfZIkmQNFf8VA0ahFsfCqfQmZvSgf11Bo1SYE3EtKDgGR7FvrUE1YB3A0UfvCZZCywuvtMsruCKB0v9Sw56LMqWXQ1+QfF3FjahfIOeixxNR72sUR+qgudWPmggE+/SccFoIxGNKMEcSOSQQC0wajBQaUubrQJkGN5geU1Rkr+wZicebLzrJEVJ2Yao4sDsW6TgTvco3vyubgjsPkBJ38WOJa+ZV1l2D+QDYwOe9ikA4QjJ1xZyTUONOaYnMI8ZhM8jpxGTxhQA357jkmcMAucqQsN6YDF2Wj3OyjKYQrzRwFEk9bAxvsIL321/jy9smDEUG9BH36PgWcNkm95O++sBIDFCB4BYnYAwibIGiFHIFAREG3ANQ/QdcV4vtEE7I7Drm8lAaFQMTH2nrWZDfeL9CMw0DmQ+7JQB8ju7qrMpj2od4oxiMorIQN6DGhiMgB5ndOpM9nFpTrOg1qt0QQrHf7GRr8OhB1HXTwCodaJgzX8yl1BpxMRlTCUgNkYb88WhYw7nQD1J9bpTwOKjf+aCXQ7IOA9dsDxCNAoTqaAbgDdi/EaUvKICoqEFYHNfZYvpfhb7+MUdwzDXf4chw24Bhp1Th1eVenUVepgt1+l4LUBYOzy+3O6/CC7i5MAjSaBa3SgQw3A5emOHW75aHeFFQhzgdrCfUQcexp4rn5rAmIGlkZ+5VhDXHQvhTYwHkOhtsRxRZxQhB7Y+bj8b3wRjBGCEOelIQiKDCy6FCRsh1zCVKxRQ7BzIlBcmKHiWHHgm+VMf8BkYd2tg8l1DiD/QXkXSkvF0upGakisnXI5PBxfxiq/5Zdngdpbu32vcLM2kLvKHfZkv4Wp35NAkFVdccNdWlt8E1lt6cSjigv8J/SeRBARYfPWXF/n29zczr658cvwE3vTJJrUQHmeP9Iy3m9mB7zthJ/M287/AdxppEv2qVN4AAAAAElFTkSuQmCC\" />\n</body>\n</html>\n```\n可以看到img标签的src属性跟一串字符。”data:image/jpg;base64“表示数据的类型，之后的一大长串就是Base64串。直接浏览器打开，显示如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice1.png)\n可以看到图片正常显示了。\n\n有了这个基础之后，后面的思路就很清楚了：Android层选择好图片后，返回图片的Base64格式的String对象到H5，H5回调拿来显示即可。\n\n## 实践\n本次例子采用三方库[safe-java-js-webview-bridge](https://github.com/pedant/safe-java-js-webview-bridge)进行Android、JS互调，[PhotoPicker](https://github.com/liuling07/PhotoPicker)进行图片选择。\n\nAS新建项目，添加gradle依赖。PhotoPicker不支持gradle依赖，直接将代码下载下来后导入library Module。\n添加asserts目录，将H5页面，js、css文件添加进去。这里我直接将项目中的联调页面扔进去了，以求简便。\n\n根据safe-java-js-webview-bridge三方库的使用说明，新建MyBridge类。这个类就是定义Android、JS互调接口的类。\n```\npublic class MyBridge {\n\n    private static WebViewActivity activity;\n\n    public static void init(WebViewActivity activity) {\n        MyBridge.activity = activity;\n    }\n\n    public static void send(WebView webView, JSONObject jsonObject, JsCallback jsCallback) {\n        try {\n            String method = jsonObject.getString(\"cmd\");\n            switch (method) {\n                case \"getToken\":\n                    String token = activity.getToken();\n                    if (jsCallback != null) {\n                        jsCallback.apply(token);\n                    }\n                    break;\n                case \"getPictures\":\n                    activity.getPictures(jsCallback);\n                    break;\n                default:\n                    break;\n            }\n        } catch (JSONException e) {\n            e.printStackTrace();\n        } catch (JsCallback.JsCallbackException e) {\n            e.printStackTrace();\n        }\n    }\n\n}\n```\n这个类需要根据H5页面那边调用接口的格式来进行编写，示例中的接口调用是这样子的。\n```\nfunction connectWebViewJavascriptBridge(callback) {\n    if (window.WebViewJavascriptBridge) {\n        callback(WebViewJavascriptBridge);\n    } else {\n        document.addEventListener('WebViewJavascriptBridgeReady', function() {\n            callback(WebViewJavascriptBridge)\n        }, false);\n    }\n};\n\n$(document).ready(function() {\n    connectWebViewJavascriptBridge(function(bridge) {\n\n        $(\"#getTokenBtn\").click(function() {\n            bridge.send({\n                \"cmd\": \"getToken\",\n                \"data\":{}\n            }, function responseCallback(responseData) {\n                $(\"#logger\")[0].innerHTML += responseData + \"<br>\";\n            });\n        });\n\n        $(\"#addPicBtn\").click(function() {\n            bridge.send({\n                \"cmd\": \"getPictures\",\n                \"data\": {\n                    \"count\": 9\n                }\n            }, function responseCallback(responseData) {\n                var imgs = JSON.parse(responseData).data.imgs;\n                for (var i = 0; i < imgs.length; i++) {\n                    $('#picList').append('<li><img src=\"data:image/jpeg;base64,' + imgs[i] + '\" alt=\"image\" width=\"50\" height=\"50\"></li>');\n                }\n            });\n        });\n    });\n});\n```\n所以我的MyBridge类只定义了一个send方法，在其内部接收Json数据，根据cmd参数判断到底要执行哪个方法。我把方法写在引用WebView的Activity中了，所以添加了一个init方法，进行初始化，保持WebViewActivity对象，以便调用。\n\n下面编写WebViewActivity类。\n```\npublic class WebViewActivity extends Activity {\n\n    private WebView webView;\n\n    public static JsCallback onceCallback; // 单次回调\n\n    private static final int PICK_PHOTO_REQUEST = 1; // 选择图片请求码\n    private static final int MAX_PHOTO_NUM = 9; // 最大选择数量\n    private static boolean showCamera = true; // 是否打开相机\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        MyBridge.init(this);\n        webView = new WebView(this);\n        // 切换到内容视图\n        setContentView(webView);\n        // 获取WebView配置\n        WebSettings ws = webView.getSettings();\n        // 启用JavaScript\n        ws.setJavaScriptEnabled(true);\n        webView.setWebChromeClient(new InjectedChromeClient(\"WebViewJavascriptBridge\", MyBridge.class));\n        // 载入assets目录下的一个页面\n        webView.loadUrl(\"file:///android_asset/native-api.html\");\n    }\n\n    public String getToken() {\n        return \"hello world\";\n    }\n\n    public void getPictures(JsCallback jsCallback) {\n        onceCallback = jsCallback;\n        Intent intent = new Intent(this, PhotoPickerActivity.class);\n        intent.putExtra(PhotoPickerActivity.EXTRA_SHOW_CAMERA, showCamera);\n        intent.putExtra(PhotoPickerActivity.EXTRA_SELECT_MODE, PhotoPickerActivity.MODE_MULTI);\n        intent.putExtra(PhotoPickerActivity.EXTRA_MAX_MUN, MAX_PHOTO_NUM);\n        startActivityForResult(intent, PICK_PHOTO_REQUEST);\n\n    }\n\n    @Override\n    protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n        if (requestCode == PICK_PHOTO_REQUEST) {\n            if (resultCode == RESULT_OK) {\n                // 拼接返回Json\n                ArrayList<String> result = data.getStringArrayListExtra(PhotoPickerActivity.KEY_RESULT);\n                JSONObject dataJson = new JSONObject();\n                JSONObject images = new JSONObject();\n                JSONArray jsonArray = new JSONArray();\n                for (int i = 0; i < result.size(); i++) {\n                    File file = new File(result.get(i));\n                    try {\n                        FileInputStream fis = new FileInputStream(file);\n                        byte[] dataInByte = steamToByte(fis);\n                        String msg = Base64.encodeToString(dataInByte, Base64.DEFAULT);\n                        // 通过Base64方式返回的String会包含许多\\n，需去除掉\n                        msg = msg.replaceAll(\"\\n\", \"\");\n                        jsonArray.put(msg);\n                        fis.close();\n                    } catch (FileNotFoundException e) {\n                        e.printStackTrace();\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                }\n                try {\n                    images.put(\"imgs\", jsonArray);\n                    dataJson.put(\"data\", images);\n                } catch (JSONException e) {\n                    e.printStackTrace();\n                }\n                // 回调\n                try {\n                    if (onceCallback != null) {\n                        onceCallback.apply(dataJson.toString());\n                    }\n                } catch (JsCallback.JsCallbackException e) {\n                    e.printStackTrace();\n                }\n            }\n        }\n        super.onActivityResult(requestCode, resultCode, data);\n    }\n\n    public static byte[] steamToByte(InputStream input) throws IOException {\n        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n        int len;\n        byte[] b = new byte[1024];\n        while ((len = input.read(b, 0, b.length)) != -1) {\n            baos.write(b, 0, len);\n        }\n        byte[] buffer = baos.toByteArray();\n        return buffer;\n    }\n}\n```\n可以看到MyBridge中的send方法最终会调用到WebViewActivity中的getToken方法与getPictures方法。\ngetToken方法很简单，仅仅是返回一个”Hello world“。getPictures方法则是打开PhotoPicker三方库中的Activity。在选完图片之后，利用onActivityResult接收返回的图片路径。然后利用Base64进行处理，得到我们需要的String对象，返回给JsCallback进行回调。\n\n在JS中处理回调参数的代码是``var imgs = JSON.parse(responseData).data.imgs;``，所以我们返回的String对象也需要时JSON格式，并且包含data、imgs属性。类似这样：{\"data\":{\"imgs\":[\"string1\", \"string2\"]}}。所以我在onActivityResult中进行了拼接处理。\n\n最后运行程序，得到的效果大致是这样的。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice2.png)\n可以看到，在我们的H5页面确实显示了图片。\n\n## 题外话\n### 话题1\n在引入PhotoPicker的时候，若在选择图片碰到很长的图片，例如微博长图，400*8000px这样的图，会导致在时容易出现OOM。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice3.png)\n在原来库中进行压缩的inSampleSize是这样计算的：\n```\nprivate int calculateInSampleSize(BitmapFactory.Options options, int reqWidth, int reqHeight) {\n    // 源图片的宽度\n    int width = options.outWidth;\n    int height = options.outHeight;\n    int inSampleSize = 1;\n    int min = Math.min(width, height);\n    int maxReq = Math.max(reqWidth, reqHeight);\n    if(min > maxReq) {\n        inSampleSize = Math.round((float) min / (float) maxReq);\n    }\n    return inSampleSize;\n}\n```\n使用这种方式，计算得到的inSampleSize值，在压缩这种长图后得到的Bitmap仍然会很大，导致OOM。\n改成如下则不会OOM了，但是图片会变得模糊一些（不可避免的，总要舍弃一些东西，微信也是这样）。\n```\nprivate int calculateInSampleSize(BitmapFactory.Options options, int reqWidth, int reqHeight) {\n    // 源图片的宽度\n    int width = options.outWidth;\n    int height = options.outHeight;\n    int inSampleSize = 1;\n\n    if (width > reqWidth || height > reqHeight) {\n        int widthRadio = Math.round(width * 1.0f / reqWidth);\n        int heightRadio = Math.round(height * 1.0f / reqHeight);\n        inSampleSize = Math.max(widthRadio, heightRadio);\n    }\n    return inSampleSize;\n}\n```\n这个问题我已经跟作者反应，并且已经改正了。\n\n### 话题2\n拼接好String字符串，准备返回给JsCallback进行回调时会出错。Log信息：\n```\nLog：I/chromium: [INFO:CONSOLE(1)] \"Uncaught SyntaxError: Unexpected identifier\", source: (1)\n```\n后面我看到JsCallback里的apply函数：\n```\npublic void apply (Object... args) throws JsCallbackException {\n    if (mWebViewRef.get() == null) {\n        throw new JsCallbackException(\"the WebView related to the JsCallback has been recycled\");\n    }\n    if (!mCouldGoOn) {\n        throw new JsCallbackException(\"the JsCallback isn't permanent,cannot be called more than once\");\n    }\n    StringBuilder sb = new StringBuilder();\n    for (Object arg : args){\n        sb.append(\",\");\n        boolean isStrArg = arg instanceof String;\n        if (isStrArg) {\n            sb.append(\"\\\"\");\n        }\n        sb.append(String.valueOf(arg));\n        if (isStrArg) {\n            sb.append(\"\\\"\");\n        }\n    }\n    String execJs = String.format(CALLBACK_JS_FORMAT, mInjectedName, mIndex, mIsPermanent, sb.toString());\n    Log.d(\"JsCallBack\", execJs);\n    mWebViewRef.get().loadUrl(execJs);\n    mCouldGoOn = mIsPermanent > 0;\n}\n```\n他会在参数的前后加上双引号。因为返回的String对象是类似Json格式，里面也会包含双引号，这就会导致传递出错。\n这个问题我也已经提了issue给作者，但目前还没有什么回应。\n\n碰到问题需要解决，在作者回应之前只能自己改咯。\n将代码下载下来，丢到工程中，不采用gradle依赖的方式了。也就三个类：InjectedChromeClient、JsCallback、JsCallJava。手动将apply中的代码改成如下：\n```\npublic void apply (Object... args) throws JsCallbackException {\n    if (mWebViewRef.get() == null) {\n        throw new JsCallbackException(\"the WebView related to the JsCallback has been recycled\");\n    }\n    if (!mCouldGoOn) {\n        throw new JsCallbackException(\"the JsCallback isn't permanent,cannot be called more than once\");\n    }\n    StringBuilder sb = new StringBuilder();\n    for (Object arg : args){\n        sb.append(\",\");\n        boolean isStrArg = arg instanceof String;\n        if (isStrArg) {\n            sb.append(\"'\");\n        }\n        sb.append(String.valueOf(arg));\n        if (isStrArg) {\n            sb.append(\"'\");\n        }\n    }\n    String execJs = String.format(CALLBACK_JS_FORMAT, mInjectedName, mIndex, mIsPermanent, sb.toString());\n    Log.d(\"JsCallBack\", execJs);\n    mWebViewRef.get().loadUrl(execJs);\n    mCouldGoOn = mIsPermanent > 0;\n}\n```\n双引号改成单引号就行了。\n\n但是只有又会引发新的问题：返回的String不能包含单引号。这确实比较蛋疼了，只能根据需求来吧，能解决当前问题的就行。延伸到既包含双引号又包含单引号的String对象又该如何传递呢？这里抛个疑问，大家可以共同探讨。\n\n补充一点：通过Base64返回的String串来显示图片只适合小图片，太大的图片需要压缩后再返回，不然也会OOM。\n\n## 最后\n[源码下载](https://github.com/LiJia92/HybridPhotoPicker)\n","source":"_posts/hybrid-practice.md","raw":"---\ntitle: Android Hybrid开发实战之图片的交互\ndate: 2016-01-14 14:32:59\ntags:\n - hybrid开发\n---\n\n## 前言\n最近一直在学习Hybrid开发，如何在H5页面调用Android原生接口，并返回值，以及回调。学习了一段时间，总算是有点收获，效果也做出来了。于是写下这篇博客，记录一下。\n\n本文中我以2个接口示例，来进行讲解。第1个示例很简单，就是调用接口，返回登录Token；第2个示例是H5调用接口，弹出Android原生界面进行图片选择，选择完之后返回选择图片的Base64格式的字符串。然后H5页面接收返回的字符串，回调进行图片显示。\n\n## Base64\n首先，讲解一下Base64。图片也是一个文件，可以通过Base64返回这个文件的Base64字符串，这个字符串可以直接放到H5的img标签进行显示。\n\n<!--more-->\n\n下面做个示例，方便大家了解。\n新建一个Html文件，编写代码如下：\n```\n<html>\n<head>\n</head>\n<body>\n<img src=\"data:image/jpg;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAAwCAMAAAChd4FcAAAAA3NCSVQICAjb4U/gAAACRlBMVEUAAADi6OSMjIxSUlIrXja5trg8rFEDRhErokJ8w4pJrVxmZmYERRIinTn++P07nk/X0Naww7Stra0pdTj37/dlunUXWiS53L+ZmZmOy5pahGJKdVIQEBAsXzdni24VmC7MzMw1kEYzMzPZ4Nul1K6Wr5tWs2jp8eseaC0ufz5mZmaEoorI1cszpUkXTSJErFix2bi1tbVKSkp7e3skWC9wvn5zlHq6yL3S3dSXzqJBcEspKSnY6dxCQkLI486mvKulpaVAbUkTSx8ICAgjcDIhISHh7eM6Ojonnz1QsGP///+Dxo9Re1paWlqNqZOZzJmasJ6s1rMZGRk4pkx5wYYcYyodmzViuHPFxcVEtFl5mH/V3def0qlhh2rZ7d7F2MiEhIQ4Z0Lv8+/F4csvo0QbUidAp1OEoIoqfDozZjOx27kOSho6mkw2j0iftaMyi0S2xroSUiBrvHuFx5J0v4Lm7+eNqJOc0KVBq1TU59gpoEBskXRzc3Pg2N6tubDe5d99nYRNr1+ZmZkbWyg9pFHN18779/patWuZzJkzZT6Sq5e0xbfAz8OtvbUhazC12ryJpY6+3sXD0MbE4MmJyJUgVCtSsmXQ5tWjuKd5wobd8OEfYy0ZUCS9vb3v7+8LRxgtgD0xZzw1j0cnWjJiimp2mX2An4aUtZye1qkYmjDm5ube3t7W1tbk9+fM5NA4lEombjRWfl9Ke1K2270xhUGbs6BrjnI7akSY1aSrvq+5yr1Kc0q8zL/19fVrvXMxYjt5mX+1vbVNR7MSAAAACXBIWXMAAAsSAAALEgHS3X78AAAAFnRFWHRDcmVhdGlvbiBUaW1lADAzLzI0LzEzWoVZMQAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNXG14zYAAAt9SURBVFiFzZn/U9NoHsfDl3KFXgOWAQtUL0Kh7EiF0sUFSqG0UsoDdYQgxBM9zUbOubIo2C7feoeM8HRWdjiqq7jnJuyt685d2ivrCHg4ZvRPuydJW5ICCj/s6WeYJn1Kklfen29PnmDCJ27YAeMQwv8rx4G2DyAEyNAWR5uPT7kHEICs16vbL1pbW/vmzr+xfHTGDEAgHLuSe2biXu25c+dqSycmTpxcFj4uogoQwPFXgdKbG4vT9aJNL27cLHV3dkDwsegENSB4UBGo3ZhW21dPAxV1H5FwFxDC1TOlG0i3TDtV+kO12s0ofZJpLn4kE16K1nTuox1pHMeTBzy4i3Ju/As5AY8Q2WlAXPh5vXh0L55oxetzyqoDLl+4DHie4CC9FIccH4+JJA8uzEOhqAh9hzzPxWIwViTAeYJHv4HmC6Fvy1+/xuuqqurGq3DLkyfcUQFx4UXg1qV98ZBtrl/ZJcSX+t51NrMG1sCxlIaIGSlXHIJjfavlNMsaiJgGUAQaImw2NqYhDDyE3/ad7Vu+fvrV7dM7z/vOtoa2V8tPHjZqUoDwSuCnA/mmL90KbKe9AubGwdd3qTjQsC6KdRUhIArHb3f++fa8AXCGOCsCLgEDh3M2G+GiADi5A0LL5eDC6urO2WXQd7luZ67isD5OAoLT6wfrJ2t4PnXPYHsL3P8FASK9+FhMBEKAVcvVr/6mAZytSFJwCSLAmIHi4/MQnOwAdePboPr86s4fl0H5t+Vbq334kQDBa/fN9/KhODzzIEmIP+h811fFulgNbWBZKi4ruNx6/0WzRmMjOBflWqIIQBk0bNxA2JCL37Q+f9FxBdxfPd1x9hh48UXF+Z9bD8knA0L61cX34yG7lz4naN6qAhoiTkO6qEiQkgJh112oAnRRDEI+znM8SoJ4PJ0kS1shrhnOz1dlXeaFJaF5/PISfRRA8HVgbP/8VdhGoDrlZBxAyMbEb4rkTpcZCFMlKF1m0G9y3RE3QOryR1EQWt7+mslXv7cgrlynD4hs/ICAOmhcZpa3H2pTIiDY2iPg2KlTGxlF8VKh+4l8Mohn2FobLii/p06+ZtlFxdX/AClKPlmMSvKqTa1gRUYEbpa6f/jBXfrZ6KhisPDH3/0sHQfXyloUVhYNkWQDaJhsStpkr6w03q+/k2JtKFMdASHn8UiEoBsj0BYSOpVlKwFB86NNZQovPj1z5djS0u25G/cK0yKeWnE/Kl+SLxz8g17PMD69Xj9rZfRDBUIZw7QUMLOzswxJarU+0ivJBKb0+UBWrJ1h9LumJdsAsGOVUtA6MI3Y+5yY2mJAATg+UahK19w3ssx1128syg4XJzVfVyWFhwmkQkFe71TLSNAamWqJ4ng/OVlQcDyRKGMi7e0Pr+IJc39/f0OQGW5AW/NxPMrUNKTspbmAvFqUnW3qMoqOrUQKShun/do1u2jhHLvdBZUKzpUqXVn8aClJD+ZzV+rrF29dDDzbfiPsxoWoSY8VqQAakEZAjD/vWl6JpTcYIQuCwWAbXYB09Pms9ST69DHMTLt2cK1lKmntEfI/3ZJMYUQ0gPnt9mzYjRlAVpakS46JUMcg3lerSIcxd7plCOCJe7N44kzFVlZmWbAskAkE1u8bRFFmaQiBNnKyxUeS09Mk6Wuh6/Mm8wfzI+Tj/MHBwXrrlwnt4OQQigCrVqsdGhwm/2HThXWYqSvt0bgTM8QwTzbiM2BSVCqTpLNYAfjjs6x0FkL6n+tv39XBPVUL0hIgEAFx/PhQjdeLAGeD0Zcvo8HZKbp+2osuNSLHYIRpb9c2WRKJtYjVPJNIeGvIGQnET4TDYRPmD4clBecHMMwZAw4sR3k5TIBZb28qAFeUbRx/0GHZW1MhLSrYDmnc7BtEX4R8fWRtdLLFKp/BKgKKhadFny/eqwwIQ6FQCXOcDtF0DzmD4/yAKQ52Y7AbcwE+B8MGcjBPPBMwVwl4UdXG95lZQstkT03N9DT6qFnIK6ipebyGf1/TjgCZyPfIIsx+gIO9Pqs1DwUAST6MiAo6sW5KbCwOjAVStXEhzGwTcrdRpYgIeEIJeE41EdqnJ+FtpNWKxBI/UcxZrUwUNTLRxdpJ88iIeVJycUhyca8ozrAIGGxoCgYX8iZLSu601ZBXgV+MPL8aELVAHRp1ZQAK9CtlDG5+XrX7D/Qv1fN7RbyamDk+Onp8Zq0NMbUlZiC80/SlddA8axXLo9VnRklSZjabm5jhfrTpYVCSTIqok0xb/gKN95BXRRCHCQsDoFQQhj1YpoRiFlesKAALJ97tZvH937s/L+/gMxghBAkruhAulRmUBlfJAjOTL5jLRhbyyu40CJZpxieXGb1UZhIJbZMX5U/EOpI/G2yryfsTNqDDdJRJDaipxLBGtkutoVgHt0uVdfrmmdtJHlD3qLjwx3vu3JPHODUj+G62BM1LkmUGf6ltGvGVge8WvMP1d6ZHcLxhMD8/v3eYfNyLtoMt8CETjAwhVCuqNPrHEbKNitlQsvJSJ0kC2oxiZYQg1oV5OKgC3FJ3kpUb49LqB9j5/OIomtWIfeTt2Te0olJ767UtIlkSMN/X0uuLtmsLvJH6MpKJyv1NikF5N6oNRlPduOyllCQuBCiaA6PkLGaNpkYpoXmnTl2owdKNW6qJy6/uivvLy9V97pXF5PhG8cTE9bt1KRcLJUy9F6YAYaiA7F+oj/b4/g5qSG+vbzh5G8ksRntRbQmdNu8CKjMSIEFRRBdmJCgC78bscRsRp5ARyHhlqxOE1hX1zOqn2glkF28px06dmwgkeww9yTBm8dK4WR9E5WRKX4JcHhn67stgPekNTfse4knA79OApNKsEqDOtTs3MGZMFrrSTpbmg+fdKh8jWxwbW8wYurQRuC8B4u0+ckRGaPg30ggfWWjvIRP//Rc+OMTUWMBfSrzyrGfqD0kFBUvwcY3C8mkoNhKqMmXdhMHRpTS/0sUCPv+s+AOPTKIVn0gJH02kLtyfZIkmQNFf8VA0ahFsfCqfQmZvSgf11Bo1SYE3EtKDgGR7FvrUE1YB3A0UfvCZZCywuvtMsruCKB0v9Sw56LMqWXQ1+QfF3FjahfIOeixxNR72sUR+qgudWPmggE+/SccFoIxGNKMEcSOSQQC0wajBQaUubrQJkGN5geU1Rkr+wZicebLzrJEVJ2Yao4sDsW6TgTvco3vyubgjsPkBJ38WOJa+ZV1l2D+QDYwOe9ikA4QjJ1xZyTUONOaYnMI8ZhM8jpxGTxhQA357jkmcMAucqQsN6YDF2Wj3OyjKYQrzRwFEk9bAxvsIL321/jy9smDEUG9BH36PgWcNkm95O++sBIDFCB4BYnYAwibIGiFHIFAREG3ANQ/QdcV4vtEE7I7Drm8lAaFQMTH2nrWZDfeL9CMw0DmQ+7JQB8ju7qrMpj2od4oxiMorIQN6DGhiMgB5ndOpM9nFpTrOg1qt0QQrHf7GRr8OhB1HXTwCodaJgzX8yl1BpxMRlTCUgNkYb88WhYw7nQD1J9bpTwOKjf+aCXQ7IOA9dsDxCNAoTqaAbgDdi/EaUvKICoqEFYHNfZYvpfhb7+MUdwzDXf4chw24Bhp1Th1eVenUVepgt1+l4LUBYOzy+3O6/CC7i5MAjSaBa3SgQw3A5emOHW75aHeFFQhzgdrCfUQcexp4rn5rAmIGlkZ+5VhDXHQvhTYwHkOhtsRxRZxQhB7Y+bj8b3wRjBGCEOelIQiKDCy6FCRsh1zCVKxRQ7BzIlBcmKHiWHHgm+VMf8BkYd2tg8l1DiD/QXkXSkvF0upGakisnXI5PBxfxiq/5Zdngdpbu32vcLM2kLvKHfZkv4Wp35NAkFVdccNdWlt8E1lt6cSjigv8J/SeRBARYfPWXF/n29zczr658cvwE3vTJJrUQHmeP9Iy3m9mB7zthJ/M287/AdxppEv2qVN4AAAAAElFTkSuQmCC\" />\n</body>\n</html>\n```\n可以看到img标签的src属性跟一串字符。”data:image/jpg;base64“表示数据的类型，之后的一大长串就是Base64串。直接浏览器打开，显示如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice1.png)\n可以看到图片正常显示了。\n\n有了这个基础之后，后面的思路就很清楚了：Android层选择好图片后，返回图片的Base64格式的String对象到H5，H5回调拿来显示即可。\n\n## 实践\n本次例子采用三方库[safe-java-js-webview-bridge](https://github.com/pedant/safe-java-js-webview-bridge)进行Android、JS互调，[PhotoPicker](https://github.com/liuling07/PhotoPicker)进行图片选择。\n\nAS新建项目，添加gradle依赖。PhotoPicker不支持gradle依赖，直接将代码下载下来后导入library Module。\n添加asserts目录，将H5页面，js、css文件添加进去。这里我直接将项目中的联调页面扔进去了，以求简便。\n\n根据safe-java-js-webview-bridge三方库的使用说明，新建MyBridge类。这个类就是定义Android、JS互调接口的类。\n```\npublic class MyBridge {\n\n    private static WebViewActivity activity;\n\n    public static void init(WebViewActivity activity) {\n        MyBridge.activity = activity;\n    }\n\n    public static void send(WebView webView, JSONObject jsonObject, JsCallback jsCallback) {\n        try {\n            String method = jsonObject.getString(\"cmd\");\n            switch (method) {\n                case \"getToken\":\n                    String token = activity.getToken();\n                    if (jsCallback != null) {\n                        jsCallback.apply(token);\n                    }\n                    break;\n                case \"getPictures\":\n                    activity.getPictures(jsCallback);\n                    break;\n                default:\n                    break;\n            }\n        } catch (JSONException e) {\n            e.printStackTrace();\n        } catch (JsCallback.JsCallbackException e) {\n            e.printStackTrace();\n        }\n    }\n\n}\n```\n这个类需要根据H5页面那边调用接口的格式来进行编写，示例中的接口调用是这样子的。\n```\nfunction connectWebViewJavascriptBridge(callback) {\n    if (window.WebViewJavascriptBridge) {\n        callback(WebViewJavascriptBridge);\n    } else {\n        document.addEventListener('WebViewJavascriptBridgeReady', function() {\n            callback(WebViewJavascriptBridge)\n        }, false);\n    }\n};\n\n$(document).ready(function() {\n    connectWebViewJavascriptBridge(function(bridge) {\n\n        $(\"#getTokenBtn\").click(function() {\n            bridge.send({\n                \"cmd\": \"getToken\",\n                \"data\":{}\n            }, function responseCallback(responseData) {\n                $(\"#logger\")[0].innerHTML += responseData + \"<br>\";\n            });\n        });\n\n        $(\"#addPicBtn\").click(function() {\n            bridge.send({\n                \"cmd\": \"getPictures\",\n                \"data\": {\n                    \"count\": 9\n                }\n            }, function responseCallback(responseData) {\n                var imgs = JSON.parse(responseData).data.imgs;\n                for (var i = 0; i < imgs.length; i++) {\n                    $('#picList').append('<li><img src=\"data:image/jpeg;base64,' + imgs[i] + '\" alt=\"image\" width=\"50\" height=\"50\"></li>');\n                }\n            });\n        });\n    });\n});\n```\n所以我的MyBridge类只定义了一个send方法，在其内部接收Json数据，根据cmd参数判断到底要执行哪个方法。我把方法写在引用WebView的Activity中了，所以添加了一个init方法，进行初始化，保持WebViewActivity对象，以便调用。\n\n下面编写WebViewActivity类。\n```\npublic class WebViewActivity extends Activity {\n\n    private WebView webView;\n\n    public static JsCallback onceCallback; // 单次回调\n\n    private static final int PICK_PHOTO_REQUEST = 1; // 选择图片请求码\n    private static final int MAX_PHOTO_NUM = 9; // 最大选择数量\n    private static boolean showCamera = true; // 是否打开相机\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        MyBridge.init(this);\n        webView = new WebView(this);\n        // 切换到内容视图\n        setContentView(webView);\n        // 获取WebView配置\n        WebSettings ws = webView.getSettings();\n        // 启用JavaScript\n        ws.setJavaScriptEnabled(true);\n        webView.setWebChromeClient(new InjectedChromeClient(\"WebViewJavascriptBridge\", MyBridge.class));\n        // 载入assets目录下的一个页面\n        webView.loadUrl(\"file:///android_asset/native-api.html\");\n    }\n\n    public String getToken() {\n        return \"hello world\";\n    }\n\n    public void getPictures(JsCallback jsCallback) {\n        onceCallback = jsCallback;\n        Intent intent = new Intent(this, PhotoPickerActivity.class);\n        intent.putExtra(PhotoPickerActivity.EXTRA_SHOW_CAMERA, showCamera);\n        intent.putExtra(PhotoPickerActivity.EXTRA_SELECT_MODE, PhotoPickerActivity.MODE_MULTI);\n        intent.putExtra(PhotoPickerActivity.EXTRA_MAX_MUN, MAX_PHOTO_NUM);\n        startActivityForResult(intent, PICK_PHOTO_REQUEST);\n\n    }\n\n    @Override\n    protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n        if (requestCode == PICK_PHOTO_REQUEST) {\n            if (resultCode == RESULT_OK) {\n                // 拼接返回Json\n                ArrayList<String> result = data.getStringArrayListExtra(PhotoPickerActivity.KEY_RESULT);\n                JSONObject dataJson = new JSONObject();\n                JSONObject images = new JSONObject();\n                JSONArray jsonArray = new JSONArray();\n                for (int i = 0; i < result.size(); i++) {\n                    File file = new File(result.get(i));\n                    try {\n                        FileInputStream fis = new FileInputStream(file);\n                        byte[] dataInByte = steamToByte(fis);\n                        String msg = Base64.encodeToString(dataInByte, Base64.DEFAULT);\n                        // 通过Base64方式返回的String会包含许多\\n，需去除掉\n                        msg = msg.replaceAll(\"\\n\", \"\");\n                        jsonArray.put(msg);\n                        fis.close();\n                    } catch (FileNotFoundException e) {\n                        e.printStackTrace();\n                    } catch (IOException e) {\n                        e.printStackTrace();\n                    }\n                }\n                try {\n                    images.put(\"imgs\", jsonArray);\n                    dataJson.put(\"data\", images);\n                } catch (JSONException e) {\n                    e.printStackTrace();\n                }\n                // 回调\n                try {\n                    if (onceCallback != null) {\n                        onceCallback.apply(dataJson.toString());\n                    }\n                } catch (JsCallback.JsCallbackException e) {\n                    e.printStackTrace();\n                }\n            }\n        }\n        super.onActivityResult(requestCode, resultCode, data);\n    }\n\n    public static byte[] steamToByte(InputStream input) throws IOException {\n        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n        int len;\n        byte[] b = new byte[1024];\n        while ((len = input.read(b, 0, b.length)) != -1) {\n            baos.write(b, 0, len);\n        }\n        byte[] buffer = baos.toByteArray();\n        return buffer;\n    }\n}\n```\n可以看到MyBridge中的send方法最终会调用到WebViewActivity中的getToken方法与getPictures方法。\ngetToken方法很简单，仅仅是返回一个”Hello world“。getPictures方法则是打开PhotoPicker三方库中的Activity。在选完图片之后，利用onActivityResult接收返回的图片路径。然后利用Base64进行处理，得到我们需要的String对象，返回给JsCallback进行回调。\n\n在JS中处理回调参数的代码是``var imgs = JSON.parse(responseData).data.imgs;``，所以我们返回的String对象也需要时JSON格式，并且包含data、imgs属性。类似这样：{\"data\":{\"imgs\":[\"string1\", \"string2\"]}}。所以我在onActivityResult中进行了拼接处理。\n\n最后运行程序，得到的效果大致是这样的。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice2.png)\n可以看到，在我们的H5页面确实显示了图片。\n\n## 题外话\n### 话题1\n在引入PhotoPicker的时候，若在选择图片碰到很长的图片，例如微博长图，400*8000px这样的图，会导致在时容易出现OOM。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice3.png)\n在原来库中进行压缩的inSampleSize是这样计算的：\n```\nprivate int calculateInSampleSize(BitmapFactory.Options options, int reqWidth, int reqHeight) {\n    // 源图片的宽度\n    int width = options.outWidth;\n    int height = options.outHeight;\n    int inSampleSize = 1;\n    int min = Math.min(width, height);\n    int maxReq = Math.max(reqWidth, reqHeight);\n    if(min > maxReq) {\n        inSampleSize = Math.round((float) min / (float) maxReq);\n    }\n    return inSampleSize;\n}\n```\n使用这种方式，计算得到的inSampleSize值，在压缩这种长图后得到的Bitmap仍然会很大，导致OOM。\n改成如下则不会OOM了，但是图片会变得模糊一些（不可避免的，总要舍弃一些东西，微信也是这样）。\n```\nprivate int calculateInSampleSize(BitmapFactory.Options options, int reqWidth, int reqHeight) {\n    // 源图片的宽度\n    int width = options.outWidth;\n    int height = options.outHeight;\n    int inSampleSize = 1;\n\n    if (width > reqWidth || height > reqHeight) {\n        int widthRadio = Math.round(width * 1.0f / reqWidth);\n        int heightRadio = Math.round(height * 1.0f / reqHeight);\n        inSampleSize = Math.max(widthRadio, heightRadio);\n    }\n    return inSampleSize;\n}\n```\n这个问题我已经跟作者反应，并且已经改正了。\n\n### 话题2\n拼接好String字符串，准备返回给JsCallback进行回调时会出错。Log信息：\n```\nLog：I/chromium: [INFO:CONSOLE(1)] \"Uncaught SyntaxError: Unexpected identifier\", source: (1)\n```\n后面我看到JsCallback里的apply函数：\n```\npublic void apply (Object... args) throws JsCallbackException {\n    if (mWebViewRef.get() == null) {\n        throw new JsCallbackException(\"the WebView related to the JsCallback has been recycled\");\n    }\n    if (!mCouldGoOn) {\n        throw new JsCallbackException(\"the JsCallback isn't permanent,cannot be called more than once\");\n    }\n    StringBuilder sb = new StringBuilder();\n    for (Object arg : args){\n        sb.append(\",\");\n        boolean isStrArg = arg instanceof String;\n        if (isStrArg) {\n            sb.append(\"\\\"\");\n        }\n        sb.append(String.valueOf(arg));\n        if (isStrArg) {\n            sb.append(\"\\\"\");\n        }\n    }\n    String execJs = String.format(CALLBACK_JS_FORMAT, mInjectedName, mIndex, mIsPermanent, sb.toString());\n    Log.d(\"JsCallBack\", execJs);\n    mWebViewRef.get().loadUrl(execJs);\n    mCouldGoOn = mIsPermanent > 0;\n}\n```\n他会在参数的前后加上双引号。因为返回的String对象是类似Json格式，里面也会包含双引号，这就会导致传递出错。\n这个问题我也已经提了issue给作者，但目前还没有什么回应。\n\n碰到问题需要解决，在作者回应之前只能自己改咯。\n将代码下载下来，丢到工程中，不采用gradle依赖的方式了。也就三个类：InjectedChromeClient、JsCallback、JsCallJava。手动将apply中的代码改成如下：\n```\npublic void apply (Object... args) throws JsCallbackException {\n    if (mWebViewRef.get() == null) {\n        throw new JsCallbackException(\"the WebView related to the JsCallback has been recycled\");\n    }\n    if (!mCouldGoOn) {\n        throw new JsCallbackException(\"the JsCallback isn't permanent,cannot be called more than once\");\n    }\n    StringBuilder sb = new StringBuilder();\n    for (Object arg : args){\n        sb.append(\",\");\n        boolean isStrArg = arg instanceof String;\n        if (isStrArg) {\n            sb.append(\"'\");\n        }\n        sb.append(String.valueOf(arg));\n        if (isStrArg) {\n            sb.append(\"'\");\n        }\n    }\n    String execJs = String.format(CALLBACK_JS_FORMAT, mInjectedName, mIndex, mIsPermanent, sb.toString());\n    Log.d(\"JsCallBack\", execJs);\n    mWebViewRef.get().loadUrl(execJs);\n    mCouldGoOn = mIsPermanent > 0;\n}\n```\n双引号改成单引号就行了。\n\n但是只有又会引发新的问题：返回的String不能包含单引号。这确实比较蛋疼了，只能根据需求来吧，能解决当前问题的就行。延伸到既包含双引号又包含单引号的String对象又该如何传递呢？这里抛个疑问，大家可以共同探讨。\n\n补充一点：通过Base64返回的String串来显示图片只适合小图片，太大的图片需要压缩后再返回，不然也会OOM。\n\n## 最后\n[源码下载](https://github.com/LiJia92/HybridPhotoPicker)\n","slug":"hybrid-practice","published":1,"updated":"2016-11-21T10:00:01.880Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7594001f1cb8ygthbve4","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近一直在学习Hybrid开发，如何在H5页面调用Android原生接口，并返回值，以及回调。学习了一段时间，总算是有点收获，效果也做出来了。于是写下这篇博客，记录一下。</p>\n<p>本文中我以2个接口示例，来进行讲解。第1个示例很简单，就是调用接口，返回登录Token；第2个示例是H5调用接口，弹出Android原生界面进行图片选择，选择完之后返回选择图片的Base64格式的字符串。然后H5页面接收返回的字符串，回调进行图片显示。</p>\n<h2 id=\"Base64\"><a href=\"#Base64\" class=\"headerlink\" title=\"Base64\"></a>Base64</h2><p>首先，讲解一下Base64。图片也是一个文件，可以通过Base64返回这个文件的Base64字符串，这个字符串可以直接放到H5的img标签进行显示。</p>\n<a id=\"more\"></a>\n<p>下面做个示例，方便大家了解。<br>新建一个Html文件，编写代码如下：<br><figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;html&gt;</div><div class=\"line\">&lt;head&gt;</div><div class=\"line\">&lt;/head&gt;</div><div class=\"line\">&lt;body&gt;</div><div class=\"line\">&lt;img src=\"data:image/jpg;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAAwCAMAAAChd4FcAAAAA3NCSVQICAjb4U/gAAACRlBMVEUAAADi6OSMjIxSUlIrXja5trg8rFEDRhErokJ8w4pJrVxmZmYERRIinTn++P07nk/X0Naww7Stra0pdTj37/dlunUXWiS53L+ZmZmOy5pahGJKdVIQEBAsXzdni24VmC7MzMw1kEYzMzPZ4Nul1K6Wr5tWs2jp8eseaC0ufz5mZmaEoorI1cszpUkXTSJErFix2bi1tbVKSkp7e3skWC9wvn5zlHq6yL3S3dSXzqJBcEspKSnY6dxCQkLI486mvKulpaVAbUkTSx8ICAgjcDIhISHh7eM6Ojonnz1QsGP///+Dxo9Re1paWlqNqZOZzJmasJ6s1rMZGRk4pkx5wYYcYyodmzViuHPFxcVEtFl5mH/V3def0qlhh2rZ7d7F2MiEhIQ4Z0Lv8+/F4csvo0QbUidAp1OEoIoqfDozZjOx27kOSho6mkw2j0iftaMyi0S2xroSUiBrvHuFx5J0v4Lm7+eNqJOc0KVBq1TU59gpoEBskXRzc3Pg2N6tubDe5d99nYRNr1+ZmZkbWyg9pFHN18779/patWuZzJkzZT6Sq5e0xbfAz8OtvbUhazC12ryJpY6<span class=\"string\">+3</span>sXD0MbE4MmJyJUgVCtSsmXQ5tWjuKd5wobd8OEfYy0ZUCS9vb3v7<span class=\"string\">+8</span>LRxgtgD0xZzw1j0cnWjJiimp2mX2An4aUtZye1qkYmjDm5ube3t7W1tbk9+fM5NA4lEombjRWfl9Ke1K2270xhUGbs6BrjnI7akSY1aSrvq<span class=\"string\">+5</span>yr1Kc0q8zL/19fVrvXMxYjt5mX<span class=\"string\">+1</span>vbVNR7MSAAAACXBIWXMAAAsSAAALEgHS3X78AAAAFnRFWHRDcmVhdGlvbiBUaW1lADAzLzI0LzEzWoVZMQAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNXG14zYAAAt9SURBVFiFzZn/U9NoHsfDl3KFXgOWAQtUL0Kh7EiF0sUFSqG0UsoDdYQgxBM9zUbOubIo2C7feoeM8HRWdjiqq7jnJuyt685d2ivrCHg4ZvRPuydJW5ICCj/s6WeYJn1Kklfen29PnmDCJ27YAeMQwv8rx4G2DyAEyNAWR5uPT7kHEICs16vbL1pbW/vmzr+xfHTGDEAgHLuSe2biXu25c+dqSycmTpxcFj4uogoQwPFXgdKbG4vT9aJNL27cLHV3dkDwsegENSB4UBGo3ZhW21dPAxV1H5FwFxDC1TOlG0i3TDtV+kO12s0ofZJpLn4kE16K1nTuox1pHMeTBzy4i3Ju/As5AY8Q2WlAXPh5vXh0L55oxetzyqoDLl<span class=\"string\">+4</span>DHie4CC9FIccH4+JJA8uzEOhqAh9hzzPxWIwViTAeYJHv4HmC6Fvy1+/xuuqqurGq3DLkyfcUQFx4UXg1qV98ZBtrl/ZJcSX+t51NrMG1sCxlIaIGSlXHIJjfavlNMsaiJgGUAQaImw2NqYhDDyE3/ad7Vu+fvrV7dM7z/vOtoa2V8tPHjZqUoDwSuCnA/mmL90KbKe9AubGwdd3qTjQsC6KdRUhIArHb3f++fa8AXCGOCsCLgEDh3M2G+GiADi5A0LL5eDC6urO2WXQd7luZ67isD5OAoLT6wfrJ2t4PnXPYHsL3P8FASK9+FhMBEKAVcvVr/6mAZytSFJwCSLAmIHi4/MQnOwAdePboPr86s4fl0H5t+Vbq334kQDBa/fN9/KhODzzIEmIP+h811fFulgNbWBZKi4ruNx6/0WzRmMjOBflWqIIQBk0bNxA2JCL37Q+f9FxBdxfPd1x9hh48UXF+Z9bD8knA0L61cX34yG7lz4naN6qAhoiTkO6qEiQkgJh112oAnRRDEI+znM8SoJ4PJ0kS1shrhnOz1dlXeaFJaF5/PISfRRA8HVgbP/8VdhGoDrlZBxAyMbEb4rkTpcZCFMlKF1m0G9y3RE3QOryR1EQWt7+mslXv7cgrlynD4hs/ICAOmhcZpa3H2pTIiDY2iPg2KlTGxlF8VKh<span class=\"string\">+4</span>l8Mohn2FobLii/p06+ZtlFxdX/AClKPlmMSvKqTa1gRUYEbpa6f/jBXfrZ6KhisPDH3/0sHQfXyloUVhYNkWQDaJhsStpkr6w03q+/k2JtKFMdASHn8UiEoBsj0BYSOpVlKwFB86NNZQovPj1z5djS0u25G/cK0yKeWnE/Kl+SLxz8g17PMD69Xj9rZfRDBUIZw7QUMLOzswxJarU<span class=\"string\">+0</span>ivJBKb0+UBWrJ1h9LumJdsAsGOVUtA6MI3Y<span class=\"string\">+5</span>yY2mJAATg+UahK19w3ssx1128syg4XJzVfVyWFhwmkQkFe71TLSNAamWqJ4ng/OVlQcDyRKGMi7e0Pr+IJc39/f0OQGW5AW/NxPMrUNKTspbmAvFqUnW3qMoqOrUQKShun/do1u2jhHLvdBZUKzpUqXVn8aClJD+ZzV+rrF29dDDzbfiPsxoWoSY8VqQAakEZAjD/vWl6JpTcYIQuCwWAbXYB09Pms9ST69DHMTLt2cK1lKmntEfI/3ZJMYUQ0gPnt9mzYjRlAVpakS46JUMcg3lerSIcxd7plCOCJe7N44kzFVlZmWbAskAkE1u8bRFFmaQiBNnKyxUeS09Mk6Wuh6/Mm8wfzI+Tj/MHBwXrrlwnt4OQQigCrVqsdGhwm/2HThXWYqSvt0bgTM8QwTzbiM2BSVCqTpLNYAfjjs6x0FkL6n+tv39XBPVUL0hIgEAFx/PhQjdeLAGeD0Zcvo8HZKbp<span class=\"string\">+2</span>osuNSLHYIRpb9c2WRKJtYjVPJNIeGvIGQnET4TDYRPmD4clBecHMMwZAw4sR3k5TIBZb28qAFeUbRx/0GHZW1MhLSrYDmnc7BtEX4R8fWRtdLLFKp/BKgKKhadFny/eqwwIQ6FQCXOcDtF0DzmD4/yAKQ52Y7AbcwE+B8MGcjBPPBMwVwl4UdXG95lZQstkT03N9DT6qFnIK6ipebyGf1/TjgCZyPfIIsx+gIO9Pqs1DwUAST6MiAo6sW5KbCwOjAVStXEhzGwTcrdRpYgIeEIJeE41EdqnJ+FtpNWKxBI/UcxZrUwUNTLRxdpJ88iIeVJycUhyca8ozrAIGGxoCgYX8iZLSu601ZBXgV+MPL8aELVAHRp1ZQAK9CtlDG5+XrX7D/Qv1fN7RbyamDk+Onp8Zq0NMbUlZiC80/SlddA8axXLo9VnRklSZjabm5jhfrTpYVCSTIqok0xb/gKN95BXRRCHCQsDoFQQhj1YpoRiFlesKAALJ97tZvH937s/L+/gMxghBAkruhAulRmUBlfJAjOTL5jLRhbyyu40CJZpxieXGb1UZhIJbZMX5U/EOpI/G2yryfsTNqDDdJRJDaipxLBGtkutoVgHt0uVdfrmmdtJHlD3qLjwx3vu3JPHODUj+G62BM1LkmUGf6ltGvGVge8WvMP1d6ZHcLxhMD8/v3eYfNyLtoMt8CETjAwhVCuqNPrHEbKNitlQsvJSJ0kC2oxiZYQg1oV5OKgC3FJ3kpUb49LqB9j5/OIomtWIfeTt2Te0olJ767UtIlkSMN/X0uuLtmsLvJH6MpKJyv1NikF5N6oNRlPduOyllCQuBCiaA6PkLGaNpkYpoXmnTl2owdKNW6qJy6/uivvLy9V97pXF5PhG8cTE9bt1KRcLJUy9F6YAYaiA7F+oj/b4/g5qSG+vbzh5G8ksRntRbQmdNu8CKjMSIEFRRBdmJCgC78bscRsRp5ARyHhlqxOE1hX1zOqn2glkF28px06dmwgkeww9yTBm8dK4WR9E5WRKX4JcHhn67stgPekNTfse4knA79OApNKsEqDOtTs3MGZMFrrSTpbmg+fdKh8jWxwbW8wYurQRuC8B4u0+ckRGaPg30ggfWWjvIRP//Rc+OMTUWMBfSrzyrGfqD0kFBUvwcY3C8mkoNhKqMmXdhMHRpTS/0sUCPv+s+AOPTKIVn0gJH02kLtyfZIkmQNFf8VA0ahFsfCqfQmZvSgf11Bo1SYE3EtKDgGR7FvrUE1YB3A0UfvCZZCywuvtMsruCKB0v9Sw56LMqWXQ1+QfF3FjahfIOeixxNR72sUR+qgudWPmggE+/SccFoIxGNKMEcSOSQQC0wajBQaUubrQJkGN5geU1Rkr+wZicebLzrJEVJ2Yao4sDsW6TgTvco3vyubgjsPkBJ38WOJa+ZV1l2D+QDYwOe9ikA4QjJ1xZyTUONOaYnMI8ZhM8jpxGTxhQA357jkmcMAucqQsN6YDF2Wj3OyjKYQrzRwFEk9bAxvsIL321/jy9smDEUG9BH36PgWcNkm95O++sBIDFCB4BYnYAwibIGiFHIFAREG3ANQ/QdcV4vtEE7I7Drm8lAaFQMTH2nrWZDfeL9CMw0DmQ<span class=\"string\">+7</span>JQB8ju7qrMpj2od4oxiMorIQN6DGhiMgB5ndOpM9nFpTrOg1qt0QQrHf7GRr8OhB1HXTwCodaJgzX8yl1BpxMRlTCUgNkYb88WhYw7nQD1J9bpTwOKjf+aCXQ7IOA9dsDxCNAoTqaAbgDdi/EaUvKICoqEFYHNfZYvpfhb7+MUdwzDXf4chw24Bhp1Th1eVenUVepgt1+l4LUBYOzy<span class=\"string\">+3</span>O6/CC7i5MAjSaBa3SgQw3A5emOHW75aHeFFQhzgdrCfUQcexp4rn5rAmIGlkZ<span class=\"string\">+5</span>VhDXHQvhTYwHkOhtsRxRZxQhB7Y+bj8b3wRjBGCEOelIQiKDCy6FCRsh1zCVKxRQ7BzIlBcmKHiWHHgm+VMf8BkYd2tg8l1DiD/QXkXSkvF0upGakisnXI5PBxfxiq/5Zdngdpbu32vcLM2kLvKHfZkv4Wp35NAkFVdccNdWlt8E1lt6cSjigv8J/SeRBARYfPWXF/n29zczr658cvwE3vTJJrUQHmeP9Iy3m9mB7zthJ/M287/AdxppEv2qVN4AAAAAElFTkSuQmCC\" /&gt;</div><div class=\"line\">&lt;/body&gt;</div><div class=\"line\">&lt;/html&gt;</div></pre></td></tr></table></figure></p>\n<p>可以看到img标签的src属性跟一串字符。”data:image/jpg;base64“表示数据的类型，之后的一大长串就是Base64串。直接浏览器打开，显示如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice1.png\" alt=\"这里写图片描述\"><br>可以看到图片正常显示了。</p>\n<p>有了这个基础之后，后面的思路就很清楚了：Android层选择好图片后，返回图片的Base64格式的String对象到H5，H5回调拿来显示即可。</p>\n<h2 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h2><p>本次例子采用三方库<a href=\"https://github.com/pedant/safe-java-js-webview-bridge\" target=\"_blank\" rel=\"external\">safe-java-js-webview-bridge</a>进行Android、JS互调，<a href=\"https://github.com/liuling07/PhotoPicker\" target=\"_blank\" rel=\"external\">PhotoPicker</a>进行图片选择。</p>\n<p>AS新建项目，添加gradle依赖。PhotoPicker不支持gradle依赖，直接将代码下载下来后导入library Module。<br>添加asserts目录，将H5页面，js、css文件添加进去。这里我直接将项目中的联调页面扔进去了，以求简便。</p>\n<p>根据safe-java-js-webview-bridge三方库的使用说明，新建MyBridge类。这个类就是定义Android、JS互调接口的类。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyBridge</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> WebViewActivity activity;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(WebViewActivity activity)</span> </span>&#123;</div><div class=\"line\">        MyBridge.activity = activity;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">send</span><span class=\"params\">(WebView webView, JSONObject jsonObject, JsCallback jsCallback)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            String method = jsonObject.getString(<span class=\"string\">\"cmd\"</span>);</div><div class=\"line\">            <span class=\"keyword\">switch</span> (method) &#123;</div><div class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">\"getToken\"</span>:</div><div class=\"line\">                    String token = activity.getToken();</div><div class=\"line\">                    <span class=\"keyword\">if</span> (jsCallback != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        jsCallback.apply(token);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">\"getPictures\"</span>:</div><div class=\"line\">                    activity.getPictures(jsCallback);</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"keyword\">default</span>:</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (JSONException e) &#123;</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (JsCallback.JsCallbackException e) &#123;</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这个类需要根据H5页面那边调用接口的格式来进行编写，示例中的接口调用是这样子的。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connectWebViewJavascriptBridge</span>(<span class=\"params\">callback</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">window</span>.WebViewJavascriptBridge) &#123;</div><div class=\"line\">        callback(WebViewJavascriptBridge);</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'WebViewJavascriptBridgeReady'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">            callback(WebViewJavascriptBridge)</div><div class=\"line\">        &#125;, <span class=\"literal\">false</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$(<span class=\"built_in\">document</span>).ready(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    connectWebViewJavascriptBridge(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">bridge</span>) </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        $(<span class=\"string\">\"#getTokenBtn\"</span>).click(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">            bridge.send(&#123;</div><div class=\"line\">                <span class=\"string\">\"cmd\"</span>: <span class=\"string\">\"getToken\"</span>,</div><div class=\"line\">                <span class=\"string\">\"data\"</span>:&#123;&#125;</div><div class=\"line\">            &#125;, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">responseCallback</span>(<span class=\"params\">responseData</span>) </span>&#123;</div><div class=\"line\">                $(<span class=\"string\">\"#logger\"</span>)[<span class=\"number\">0</span>].innerHTML += responseData + <span class=\"string\">\"&lt;br&gt;\"</span>;</div><div class=\"line\">            &#125;);</div><div class=\"line\">        &#125;);</div><div class=\"line\"></div><div class=\"line\">        $(<span class=\"string\">\"#addPicBtn\"</span>).click(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">            bridge.send(&#123;</div><div class=\"line\">                <span class=\"string\">\"cmd\"</span>: <span class=\"string\">\"getPictures\"</span>,</div><div class=\"line\">                <span class=\"string\">\"data\"</span>: &#123;</div><div class=\"line\">                    <span class=\"string\">\"count\"</span>: <span class=\"number\">9</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">responseCallback</span>(<span class=\"params\">responseData</span>) </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">var</span> imgs = <span class=\"built_in\">JSON</span>.parse(responseData).data.imgs;</div><div class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; imgs.length; i++) &#123;</div><div class=\"line\">                    $(<span class=\"string\">'#picList'</span>).append(<span class=\"string\">'&lt;li&gt;&lt;img src=\"data:image/jpeg;base64,'</span> + imgs[i] + <span class=\"string\">'\" alt=\"image\" width=\"50\" height=\"50\"&gt;&lt;/li&gt;'</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;);</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>所以我的MyBridge类只定义了一个send方法，在其内部接收Json数据，根据cmd参数判断到底要执行哪个方法。我把方法写在引用WebView的Activity中了，所以添加了一个init方法，进行初始化，保持WebViewActivity对象，以便调用。</p>\n<p>下面编写WebViewActivity类。<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> WebViewActivity <span class=\"keyword\">extends</span> Activity &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> WebView webView;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> JsCallback onceCallback; <span class=\"comment\">// 单次回调</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> PICK_PHOTO_REQUEST = <span class=\"number\">1</span>; <span class=\"comment\">// 选择图片请求码</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MAX_PHOTO_NUM = <span class=\"number\">9</span>; <span class=\"comment\">// 最大选择数量</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> showCamera = <span class=\"keyword\">true</span>; <span class=\"comment\">// 是否打开相机</span></div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onCreate(Bundle savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        MyBridge.init(<span class=\"keyword\">this</span>);</div><div class=\"line\">        webView = <span class=\"keyword\">new</span> WebView(<span class=\"keyword\">this</span>);</div><div class=\"line\">        <span class=\"comment\">// 切换到内容视图</span></div><div class=\"line\">        setContentView(webView);</div><div class=\"line\">        <span class=\"comment\">// 获取WebView配置</span></div><div class=\"line\">        WebSettings ws = webView.getSettings();</div><div class=\"line\">        <span class=\"comment\">// 启用JavaScript</span></div><div class=\"line\">        ws.setJavaScriptEnabled(<span class=\"keyword\">true</span>);</div><div class=\"line\">        webView.setWebChromeClient(<span class=\"keyword\">new</span> InjectedChromeClient(<span class=\"string\">\"WebViewJavascriptBridge\"</span>, MyBridge.<span class=\"keyword\">class</span>));</div><div class=\"line\">        <span class=\"comment\">// 载入assets目录下的一个页面</span></div><div class=\"line\">        webView.loadUrl(<span class=\"string\">\"file:///android_asset/native-api.html\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> String getToken() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"hello world\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> getPictures(JsCallback jsCallback) &#123;</div><div class=\"line\">        onceCallback = jsCallback;</div><div class=\"line\">        Intent intent = <span class=\"keyword\">new</span> Intent(<span class=\"keyword\">this</span>, PhotoPickerActivity.<span class=\"keyword\">class</span>);</div><div class=\"line\">        intent.putExtra(PhotoPickerActivity.EXTRA_SHOW_CAMERA, showCamera);</div><div class=\"line\">        intent.putExtra(PhotoPickerActivity.EXTRA_SELECT_MODE, PhotoPickerActivity.MODE_MULTI);</div><div class=\"line\">        intent.putExtra(PhotoPickerActivity.EXTRA_MAX_MUN, MAX_PHOTO_NUM);</div><div class=\"line\">        startActivityForResult(intent, PICK_PHOTO_REQUEST);</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onActivityResult(<span class=\"keyword\">int</span> requestCode, <span class=\"keyword\">int</span> resultCode, Intent data) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (requestCode == PICK_PHOTO_REQUEST) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (resultCode == RESULT_OK) &#123;</div><div class=\"line\">                <span class=\"comment\">// 拼接返回Json</span></div><div class=\"line\">                ArrayList&lt;String&gt; result = data.getStringArrayListExtra(PhotoPickerActivity.KEY_RESULT);</div><div class=\"line\">                JSONObject dataJson = <span class=\"keyword\">new</span> JSONObject();</div><div class=\"line\">                JSONObject images = <span class=\"keyword\">new</span> JSONObject();</div><div class=\"line\">                JSONArray jsonArray = <span class=\"keyword\">new</span> JSONArray();</div><div class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; result.<span class=\"keyword\">size</span>(); i++) &#123;</div><div class=\"line\">                    <span class=\"keyword\">File</span> <span class=\"keyword\">file</span> = <span class=\"keyword\">new</span> <span class=\"keyword\">File</span>(result.get(i));</div><div class=\"line\">                    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                        FileInputStream fis = <span class=\"keyword\">new</span> FileInputStream(<span class=\"keyword\">file</span>);</div><div class=\"line\">                        <span class=\"keyword\">byte</span>[] dataInByte = steamToByte(fis);</div><div class=\"line\">                        String msg = Base64.encodeToString(dataInByte, Base64.<span class=\"keyword\">DEFAULT</span>);</div><div class=\"line\">                        <span class=\"comment\">// 通过Base64方式返回的String会包含许多\\n，需去除掉</span></div><div class=\"line\">                        msg = msg.replaceAll(<span class=\"string\">\"\\n\"</span>, <span class=\"string\">\"\"</span>);</div><div class=\"line\">                        jsonArray.put(msg);</div><div class=\"line\">                        fis.close();</div><div class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (FileNotFoundException e) &#123;</div><div class=\"line\">                        e.printStackTrace();</div><div class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">                        e.printStackTrace();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                    images.put(<span class=\"string\">\"imgs\"</span>, jsonArray);</div><div class=\"line\">                    dataJson.put(<span class=\"string\">\"data\"</span>, images);</div><div class=\"line\">                &#125; <span class=\"keyword\">catch</span> (JSONException e) &#123;</div><div class=\"line\">                    e.printStackTrace();</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"comment\">// 回调</span></div><div class=\"line\">                <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                    <span class=\"keyword\">if</span> (onceCallback != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        onceCallback.apply(dataJson.toString());</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125; <span class=\"keyword\">catch</span> (JsCallback.JsCallbackException e) &#123;</div><div class=\"line\">                    e.printStackTrace();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onActivityResult(requestCode, resultCode, data);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] steamToByte(InputStream input) <span class=\"keyword\">throws</span> IOException &#123;</div><div class=\"line\">        ByteArrayOutputStream baos = <span class=\"keyword\">new</span> ByteArrayOutputStream();</div><div class=\"line\">        <span class=\"keyword\">int</span> len;</div><div class=\"line\">        <span class=\"keyword\">byte</span>[] b = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</div><div class=\"line\">        <span class=\"keyword\">while</span> ((len = input.<span class=\"keyword\">read</span>(b, <span class=\"number\">0</span>, b.length)) != -<span class=\"number\">1</span>) &#123;</div><div class=\"line\">            baos.<span class=\"keyword\">write</span>(b, <span class=\"number\">0</span>, len);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">byte</span>[] buffer = baos.toByteArray();</div><div class=\"line\">        <span class=\"keyword\">return</span> buffer;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到MyBridge中的send方法最终会调用到WebViewActivity中的getToken方法与getPictures方法。<br>getToken方法很简单，仅仅是返回一个”Hello world“。getPictures方法则是打开PhotoPicker三方库中的Activity。在选完图片之后，利用onActivityResult接收返回的图片路径。然后利用Base64进行处理，得到我们需要的String对象，返回给JsCallback进行回调。</p>\n<p>在JS中处理回调参数的代码是<code>var imgs = JSON.parse(responseData).data.imgs;</code>，所以我们返回的String对象也需要时JSON格式，并且包含data、imgs属性。类似这样：{“data”:{“imgs”:[“string1”, “string2”]}}。所以我在onActivityResult中进行了拼接处理。</p>\n<p>最后运行程序，得到的效果大致是这样的。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice2.png\" alt=\"这里写图片描述\"><br>可以看到，在我们的H5页面确实显示了图片。</p>\n<h2 id=\"题外话\"><a href=\"#题外话\" class=\"headerlink\" title=\"题外话\"></a>题外话</h2><h3 id=\"话题1\"><a href=\"#话题1\" class=\"headerlink\" title=\"话题1\"></a>话题1</h3><p>在引入PhotoPicker的时候，若在选择图片碰到很长的图片，例如微博长图，400*8000px这样的图，会导致在时容易出现OOM。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice3.png\" alt=\"这里写图片描述\"><br>在原来库中进行压缩的inSampleSize是这样计算的：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"built_in\">int</span> calculateInSampleSize(BitmapFactory.Options options, <span class=\"built_in\">int</span> reqWidth, <span class=\"built_in\">int</span> reqHeight) &#123;</div><div class=\"line\">    <span class=\"comment\">// 源图片的宽度</span></div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">width</span> = options.outWidth;</div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">height</span> = options.outHeight;</div><div class=\"line\">    <span class=\"built_in\">int</span> inSampleSize = <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">min</span> = Math.<span class=\"built_in\">min</span>(<span class=\"built_in\">width</span>, <span class=\"built_in\">height</span>);</div><div class=\"line\">    <span class=\"built_in\">int</span> maxReq = Math.<span class=\"built_in\">max</span>(reqWidth, reqHeight);</div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"built_in\">min</span> &gt; maxReq) &#123;</div><div class=\"line\">        inSampleSize = Math.<span class=\"built_in\">round</span>((<span class=\"built_in\">float</span>) <span class=\"built_in\">min</span> / (<span class=\"built_in\">float</span>) maxReq);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> inSampleSize;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>使用这种方式，计算得到的inSampleSize值，在压缩这种长图后得到的Bitmap仍然会很大，导致OOM。<br>改成如下则不会OOM了，但是图片会变得模糊一些（不可避免的，总要舍弃一些东西，微信也是这样）。<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"built_in\">int</span> calculateInSampleSize(BitmapFactory.Options options, <span class=\"built_in\">int</span> reqWidth, <span class=\"built_in\">int</span> reqHeight) &#123;</div><div class=\"line\">    <span class=\"comment\">// 源图片的宽度</span></div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">width</span> = options.outWidth;</div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">height</span> = options.outHeight;</div><div class=\"line\">    <span class=\"built_in\">int</span> inSampleSize = <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">width</span> &gt; reqWidth || <span class=\"built_in\">height</span> &gt; reqHeight) &#123;</div><div class=\"line\">        <span class=\"built_in\">int</span> widthRadio = Math.<span class=\"built_in\">round</span>(<span class=\"built_in\">width</span> * <span class=\"number\">1.0</span>f / reqWidth);</div><div class=\"line\">        <span class=\"built_in\">int</span> heightRadio = Math.<span class=\"built_in\">round</span>(<span class=\"built_in\">height</span> * <span class=\"number\">1.0</span>f / reqHeight);</div><div class=\"line\">        inSampleSize = Math.<span class=\"built_in\">max</span>(widthRadio, heightRadio);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> inSampleSize;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这个问题我已经跟作者反应，并且已经改正了。</p>\n<h3 id=\"话题2\"><a href=\"#话题2\" class=\"headerlink\" title=\"话题2\"></a>话题2</h3><p>拼接好String字符串，准备返回给JsCallback进行回调时会出错。Log信息：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Log：I/<span class=\"string\">chromium:</span> [<span class=\"string\">INFO:</span>CONSOLE(<span class=\"number\">1</span>)] <span class=\"string\">\"Uncaught SyntaxError: Unexpected identifier\"</span>, <span class=\"string\">source:</span> (<span class=\"number\">1</span>)</div></pre></td></tr></table></figure></p>\n<p>后面我看到JsCallback里的apply函数：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> apply (<span class=\"keyword\">Object</span>... args) <span class=\"keyword\">throws</span> JsCallbackException &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mWebViewRef.<span class=\"built_in\">get</span>() == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JsCallbackException(<span class=\"string\">\"the WebView related to the JsCallback has been recycled\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!mCouldGoOn) &#123;</div><div class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JsCallbackException(<span class=\"string\">\"the JsCallback isn't permanent,cannot be called more than once\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    StringBuilder sb = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">Object</span> arg : args)&#123;</div><div class=\"line\">        sb.<span class=\"built_in\">append</span>(<span class=\"string\">\",\"</span>);</div><div class=\"line\">        <span class=\"built_in\">boolean</span> isStrArg = arg <span class=\"keyword\">instanceof</span> <span class=\"keyword\">String</span>;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isStrArg) &#123;</div><div class=\"line\">            sb.<span class=\"built_in\">append</span>(<span class=\"string\">\"\\\"\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        sb.<span class=\"built_in\">append</span>(<span class=\"keyword\">String</span>.valueOf(arg));</div><div class=\"line\">        <span class=\"keyword\">if</span> (isStrArg) &#123;</div><div class=\"line\">            sb.<span class=\"built_in\">append</span>(<span class=\"string\">\"\\\"\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">String</span> execJs = <span class=\"keyword\">String</span>.format(CALLBACK_JS_FORMAT, mInjectedName, mIndex, mIsPermanent, sb.toString());</div><div class=\"line\">    Log.d(<span class=\"string\">\"JsCallBack\"</span>, execJs);</div><div class=\"line\">    mWebViewRef.<span class=\"built_in\">get</span>().loadUrl(execJs);</div><div class=\"line\">    mCouldGoOn = mIsPermanent &gt; <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>他会在参数的前后加上双引号。因为返回的String对象是类似Json格式，里面也会包含双引号，这就会导致传递出错。<br>这个问题我也已经提了issue给作者，但目前还没有什么回应。</p>\n<p>碰到问题需要解决，在作者回应之前只能自己改咯。<br>将代码下载下来，丢到工程中，不采用gradle依赖的方式了。也就三个类：InjectedChromeClient、JsCallback、JsCallJava。手动将apply中的代码改成如下：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> apply (<span class=\"keyword\">Object</span>... args) <span class=\"keyword\">throws</span> JsCallbackException &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mWebViewRef.<span class=\"built_in\">get</span>() == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JsCallbackException(<span class=\"string\">\"the WebView related to the JsCallback has been recycled\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!mCouldGoOn) &#123;</div><div class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JsCallbackException(<span class=\"string\">\"the JsCallback isn't permanent,cannot be called more than once\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    StringBuilder sb = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">Object</span> arg : args)&#123;</div><div class=\"line\">        sb.<span class=\"built_in\">append</span>(<span class=\"string\">\",\"</span>);</div><div class=\"line\">        <span class=\"built_in\">boolean</span> isStrArg = arg <span class=\"keyword\">instanceof</span> <span class=\"keyword\">String</span>;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isStrArg) &#123;</div><div class=\"line\">            sb.<span class=\"built_in\">append</span>(<span class=\"string\">\"'\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        sb.<span class=\"built_in\">append</span>(<span class=\"keyword\">String</span>.valueOf(arg));</div><div class=\"line\">        <span class=\"keyword\">if</span> (isStrArg) &#123;</div><div class=\"line\">            sb.<span class=\"built_in\">append</span>(<span class=\"string\">\"'\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">String</span> execJs = <span class=\"keyword\">String</span>.format(CALLBACK_JS_FORMAT, mInjectedName, mIndex, mIsPermanent, sb.toString());</div><div class=\"line\">    Log.d(<span class=\"string\">\"JsCallBack\"</span>, execJs);</div><div class=\"line\">    mWebViewRef.<span class=\"built_in\">get</span>().loadUrl(execJs);</div><div class=\"line\">    mCouldGoOn = mIsPermanent &gt; <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>双引号改成单引号就行了。</p>\n<p>但是只有又会引发新的问题：返回的String不能包含单引号。这确实比较蛋疼了，只能根据需求来吧，能解决当前问题的就行。延伸到既包含双引号又包含单引号的String对象又该如何传递呢？这里抛个疑问，大家可以共同探讨。</p>\n<p>补充一点：通过Base64返回的String串来显示图片只适合小图片，太大的图片需要压缩后再返回，不然也会OOM。</p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p><a href=\"https://github.com/LiJia92/HybridPhotoPicker\" target=\"_blank\" rel=\"external\">源码下载</a></p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近一直在学习Hybrid开发，如何在H5页面调用Android原生接口，并返回值，以及回调。学习了一段时间，总算是有点收获，效果也做出来了。于是写下这篇博客，记录一下。</p>\n<p>本文中我以2个接口示例，来进行讲解。第1个示例很简单，就是调用接口，返回登录Token；第2个示例是H5调用接口，弹出Android原生界面进行图片选择，选择完之后返回选择图片的Base64格式的字符串。然后H5页面接收返回的字符串，回调进行图片显示。</p>\n<h2 id=\"Base64\"><a href=\"#Base64\" class=\"headerlink\" title=\"Base64\"></a>Base64</h2><p>首先，讲解一下Base64。图片也是一个文件，可以通过Base64返回这个文件的Base64字符串，这个字符串可以直接放到H5的img标签进行显示。</p>","more":"<p>下面做个示例，方便大家了解。<br>新建一个Html文件，编写代码如下：<br><figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;html&gt;</div><div class=\"line\">&lt;head&gt;</div><div class=\"line\">&lt;/head&gt;</div><div class=\"line\">&lt;body&gt;</div><div class=\"line\">&lt;img src=\"data:image/jpg;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAAwCAMAAAChd4FcAAAAA3NCSVQICAjb4U/gAAACRlBMVEUAAADi6OSMjIxSUlIrXja5trg8rFEDRhErokJ8w4pJrVxmZmYERRIinTn++P07nk/X0Naww7Stra0pdTj37/dlunUXWiS53L+ZmZmOy5pahGJKdVIQEBAsXzdni24VmC7MzMw1kEYzMzPZ4Nul1K6Wr5tWs2jp8eseaC0ufz5mZmaEoorI1cszpUkXTSJErFix2bi1tbVKSkp7e3skWC9wvn5zlHq6yL3S3dSXzqJBcEspKSnY6dxCQkLI486mvKulpaVAbUkTSx8ICAgjcDIhISHh7eM6Ojonnz1QsGP///+Dxo9Re1paWlqNqZOZzJmasJ6s1rMZGRk4pkx5wYYcYyodmzViuHPFxcVEtFl5mH/V3def0qlhh2rZ7d7F2MiEhIQ4Z0Lv8+/F4csvo0QbUidAp1OEoIoqfDozZjOx27kOSho6mkw2j0iftaMyi0S2xroSUiBrvHuFx5J0v4Lm7+eNqJOc0KVBq1TU59gpoEBskXRzc3Pg2N6tubDe5d99nYRNr1+ZmZkbWyg9pFHN18779/patWuZzJkzZT6Sq5e0xbfAz8OtvbUhazC12ryJpY6<span class=\"string\">+3</span>sXD0MbE4MmJyJUgVCtSsmXQ5tWjuKd5wobd8OEfYy0ZUCS9vb3v7<span class=\"string\">+8</span>LRxgtgD0xZzw1j0cnWjJiimp2mX2An4aUtZye1qkYmjDm5ube3t7W1tbk9+fM5NA4lEombjRWfl9Ke1K2270xhUGbs6BrjnI7akSY1aSrvq<span class=\"string\">+5</span>yr1Kc0q8zL/19fVrvXMxYjt5mX<span class=\"string\">+1</span>vbVNR7MSAAAACXBIWXMAAAsSAAALEgHS3X78AAAAFnRFWHRDcmVhdGlvbiBUaW1lADAzLzI0LzEzWoVZMQAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNXG14zYAAAt9SURBVFiFzZn/U9NoHsfDl3KFXgOWAQtUL0Kh7EiF0sUFSqG0UsoDdYQgxBM9zUbOubIo2C7feoeM8HRWdjiqq7jnJuyt685d2ivrCHg4ZvRPuydJW5ICCj/s6WeYJn1Kklfen29PnmDCJ27YAeMQwv8rx4G2DyAEyNAWR5uPT7kHEICs16vbL1pbW/vmzr+xfHTGDEAgHLuSe2biXu25c+dqSycmTpxcFj4uogoQwPFXgdKbG4vT9aJNL27cLHV3dkDwsegENSB4UBGo3ZhW21dPAxV1H5FwFxDC1TOlG0i3TDtV+kO12s0ofZJpLn4kE16K1nTuox1pHMeTBzy4i3Ju/As5AY8Q2WlAXPh5vXh0L55oxetzyqoDLl<span class=\"string\">+4</span>DHie4CC9FIccH4+JJA8uzEOhqAh9hzzPxWIwViTAeYJHv4HmC6Fvy1+/xuuqqurGq3DLkyfcUQFx4UXg1qV98ZBtrl/ZJcSX+t51NrMG1sCxlIaIGSlXHIJjfavlNMsaiJgGUAQaImw2NqYhDDyE3/ad7Vu+fvrV7dM7z/vOtoa2V8tPHjZqUoDwSuCnA/mmL90KbKe9AubGwdd3qTjQsC6KdRUhIArHb3f++fa8AXCGOCsCLgEDh3M2G+GiADi5A0LL5eDC6urO2WXQd7luZ67isD5OAoLT6wfrJ2t4PnXPYHsL3P8FASK9+FhMBEKAVcvVr/6mAZytSFJwCSLAmIHi4/MQnOwAdePboPr86s4fl0H5t+Vbq334kQDBa/fN9/KhODzzIEmIP+h811fFulgNbWBZKi4ruNx6/0WzRmMjOBflWqIIQBk0bNxA2JCL37Q+f9FxBdxfPd1x9hh48UXF+Z9bD8knA0L61cX34yG7lz4naN6qAhoiTkO6qEiQkgJh112oAnRRDEI+znM8SoJ4PJ0kS1shrhnOz1dlXeaFJaF5/PISfRRA8HVgbP/8VdhGoDrlZBxAyMbEb4rkTpcZCFMlKF1m0G9y3RE3QOryR1EQWt7+mslXv7cgrlynD4hs/ICAOmhcZpa3H2pTIiDY2iPg2KlTGxlF8VKh<span class=\"string\">+4</span>l8Mohn2FobLii/p06+ZtlFxdX/AClKPlmMSvKqTa1gRUYEbpa6f/jBXfrZ6KhisPDH3/0sHQfXyloUVhYNkWQDaJhsStpkr6w03q+/k2JtKFMdASHn8UiEoBsj0BYSOpVlKwFB86NNZQovPj1z5djS0u25G/cK0yKeWnE/Kl+SLxz8g17PMD69Xj9rZfRDBUIZw7QUMLOzswxJarU<span class=\"string\">+0</span>ivJBKb0+UBWrJ1h9LumJdsAsGOVUtA6MI3Y<span class=\"string\">+5</span>yY2mJAATg+UahK19w3ssx1128syg4XJzVfVyWFhwmkQkFe71TLSNAamWqJ4ng/OVlQcDyRKGMi7e0Pr+IJc39/f0OQGW5AW/NxPMrUNKTspbmAvFqUnW3qMoqOrUQKShun/do1u2jhHLvdBZUKzpUqXVn8aClJD+ZzV+rrF29dDDzbfiPsxoWoSY8VqQAakEZAjD/vWl6JpTcYIQuCwWAbXYB09Pms9ST69DHMTLt2cK1lKmntEfI/3ZJMYUQ0gPnt9mzYjRlAVpakS46JUMcg3lerSIcxd7plCOCJe7N44kzFVlZmWbAskAkE1u8bRFFmaQiBNnKyxUeS09Mk6Wuh6/Mm8wfzI+Tj/MHBwXrrlwnt4OQQigCrVqsdGhwm/2HThXWYqSvt0bgTM8QwTzbiM2BSVCqTpLNYAfjjs6x0FkL6n+tv39XBPVUL0hIgEAFx/PhQjdeLAGeD0Zcvo8HZKbp<span class=\"string\">+2</span>osuNSLHYIRpb9c2WRKJtYjVPJNIeGvIGQnET4TDYRPmD4clBecHMMwZAw4sR3k5TIBZb28qAFeUbRx/0GHZW1MhLSrYDmnc7BtEX4R8fWRtdLLFKp/BKgKKhadFny/eqwwIQ6FQCXOcDtF0DzmD4/yAKQ52Y7AbcwE+B8MGcjBPPBMwVwl4UdXG95lZQstkT03N9DT6qFnIK6ipebyGf1/TjgCZyPfIIsx+gIO9Pqs1DwUAST6MiAo6sW5KbCwOjAVStXEhzGwTcrdRpYgIeEIJeE41EdqnJ+FtpNWKxBI/UcxZrUwUNTLRxdpJ88iIeVJycUhyca8ozrAIGGxoCgYX8iZLSu601ZBXgV+MPL8aELVAHRp1ZQAK9CtlDG5+XrX7D/Qv1fN7RbyamDk+Onp8Zq0NMbUlZiC80/SlddA8axXLo9VnRklSZjabm5jhfrTpYVCSTIqok0xb/gKN95BXRRCHCQsDoFQQhj1YpoRiFlesKAALJ97tZvH937s/L+/gMxghBAkruhAulRmUBlfJAjOTL5jLRhbyyu40CJZpxieXGb1UZhIJbZMX5U/EOpI/G2yryfsTNqDDdJRJDaipxLBGtkutoVgHt0uVdfrmmdtJHlD3qLjwx3vu3JPHODUj+G62BM1LkmUGf6ltGvGVge8WvMP1d6ZHcLxhMD8/v3eYfNyLtoMt8CETjAwhVCuqNPrHEbKNitlQsvJSJ0kC2oxiZYQg1oV5OKgC3FJ3kpUb49LqB9j5/OIomtWIfeTt2Te0olJ767UtIlkSMN/X0uuLtmsLvJH6MpKJyv1NikF5N6oNRlPduOyllCQuBCiaA6PkLGaNpkYpoXmnTl2owdKNW6qJy6/uivvLy9V97pXF5PhG8cTE9bt1KRcLJUy9F6YAYaiA7F+oj/b4/g5qSG+vbzh5G8ksRntRbQmdNu8CKjMSIEFRRBdmJCgC78bscRsRp5ARyHhlqxOE1hX1zOqn2glkF28px06dmwgkeww9yTBm8dK4WR9E5WRKX4JcHhn67stgPekNTfse4knA79OApNKsEqDOtTs3MGZMFrrSTpbmg+fdKh8jWxwbW8wYurQRuC8B4u0+ckRGaPg30ggfWWjvIRP//Rc+OMTUWMBfSrzyrGfqD0kFBUvwcY3C8mkoNhKqMmXdhMHRpTS/0sUCPv+s+AOPTKIVn0gJH02kLtyfZIkmQNFf8VA0ahFsfCqfQmZvSgf11Bo1SYE3EtKDgGR7FvrUE1YB3A0UfvCZZCywuvtMsruCKB0v9Sw56LMqWXQ1+QfF3FjahfIOeixxNR72sUR+qgudWPmggE+/SccFoIxGNKMEcSOSQQC0wajBQaUubrQJkGN5geU1Rkr+wZicebLzrJEVJ2Yao4sDsW6TgTvco3vyubgjsPkBJ38WOJa+ZV1l2D+QDYwOe9ikA4QjJ1xZyTUONOaYnMI8ZhM8jpxGTxhQA357jkmcMAucqQsN6YDF2Wj3OyjKYQrzRwFEk9bAxvsIL321/jy9smDEUG9BH36PgWcNkm95O++sBIDFCB4BYnYAwibIGiFHIFAREG3ANQ/QdcV4vtEE7I7Drm8lAaFQMTH2nrWZDfeL9CMw0DmQ<span class=\"string\">+7</span>JQB8ju7qrMpj2od4oxiMorIQN6DGhiMgB5ndOpM9nFpTrOg1qt0QQrHf7GRr8OhB1HXTwCodaJgzX8yl1BpxMRlTCUgNkYb88WhYw7nQD1J9bpTwOKjf+aCXQ7IOA9dsDxCNAoTqaAbgDdi/EaUvKICoqEFYHNfZYvpfhb7+MUdwzDXf4chw24Bhp1Th1eVenUVepgt1+l4LUBYOzy<span class=\"string\">+3</span>O6/CC7i5MAjSaBa3SgQw3A5emOHW75aHeFFQhzgdrCfUQcexp4rn5rAmIGlkZ<span class=\"string\">+5</span>VhDXHQvhTYwHkOhtsRxRZxQhB7Y+bj8b3wRjBGCEOelIQiKDCy6FCRsh1zCVKxRQ7BzIlBcmKHiWHHgm+VMf8BkYd2tg8l1DiD/QXkXSkvF0upGakisnXI5PBxfxiq/5Zdngdpbu32vcLM2kLvKHfZkv4Wp35NAkFVdccNdWlt8E1lt6cSjigv8J/SeRBARYfPWXF/n29zczr658cvwE3vTJJrUQHmeP9Iy3m9mB7zthJ/M287/AdxppEv2qVN4AAAAAElFTkSuQmCC\" /&gt;</div><div class=\"line\">&lt;/body&gt;</div><div class=\"line\">&lt;/html&gt;</div></pre></td></tr></table></figure></p>\n<p>可以看到img标签的src属性跟一串字符。”data:image/jpg;base64“表示数据的类型，之后的一大长串就是Base64串。直接浏览器打开，显示如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice1.png\" alt=\"这里写图片描述\"><br>可以看到图片正常显示了。</p>\n<p>有了这个基础之后，后面的思路就很清楚了：Android层选择好图片后，返回图片的Base64格式的String对象到H5，H5回调拿来显示即可。</p>\n<h2 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h2><p>本次例子采用三方库<a href=\"https://github.com/pedant/safe-java-js-webview-bridge\">safe-java-js-webview-bridge</a>进行Android、JS互调，<a href=\"https://github.com/liuling07/PhotoPicker\">PhotoPicker</a>进行图片选择。</p>\n<p>AS新建项目，添加gradle依赖。PhotoPicker不支持gradle依赖，直接将代码下载下来后导入library Module。<br>添加asserts目录，将H5页面，js、css文件添加进去。这里我直接将项目中的联调页面扔进去了，以求简便。</p>\n<p>根据safe-java-js-webview-bridge三方库的使用说明，新建MyBridge类。这个类就是定义Android、JS互调接口的类。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyBridge</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> WebViewActivity activity;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(WebViewActivity activity)</span> </span>&#123;</div><div class=\"line\">        MyBridge.activity = activity;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">send</span><span class=\"params\">(WebView webView, JSONObject jsonObject, JsCallback jsCallback)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            String method = jsonObject.getString(<span class=\"string\">\"cmd\"</span>);</div><div class=\"line\">            <span class=\"keyword\">switch</span> (method) &#123;</div><div class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">\"getToken\"</span>:</div><div class=\"line\">                    String token = activity.getToken();</div><div class=\"line\">                    <span class=\"keyword\">if</span> (jsCallback != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        jsCallback.apply(token);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">\"getPictures\"</span>:</div><div class=\"line\">                    activity.getPictures(jsCallback);</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"keyword\">default</span>:</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (JSONException e) &#123;</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (JsCallback.JsCallbackException e) &#123;</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这个类需要根据H5页面那边调用接口的格式来进行编写，示例中的接口调用是这样子的。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connectWebViewJavascriptBridge</span>(<span class=\"params\">callback</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">window</span>.WebViewJavascriptBridge) &#123;</div><div class=\"line\">        callback(WebViewJavascriptBridge);</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'WebViewJavascriptBridgeReady'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">            callback(WebViewJavascriptBridge)</div><div class=\"line\">        &#125;, <span class=\"literal\">false</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$(<span class=\"built_in\">document</span>).ready(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    connectWebViewJavascriptBridge(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">bridge</span>) </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        $(<span class=\"string\">\"#getTokenBtn\"</span>).click(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">            bridge.send(&#123;</div><div class=\"line\">                <span class=\"string\">\"cmd\"</span>: <span class=\"string\">\"getToken\"</span>,</div><div class=\"line\">                <span class=\"string\">\"data\"</span>:&#123;&#125;</div><div class=\"line\">            &#125;, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">responseCallback</span>(<span class=\"params\">responseData</span>) </span>&#123;</div><div class=\"line\">                $(<span class=\"string\">\"#logger\"</span>)[<span class=\"number\">0</span>].innerHTML += responseData + <span class=\"string\">\"&lt;br&gt;\"</span>;</div><div class=\"line\">            &#125;);</div><div class=\"line\">        &#125;);</div><div class=\"line\"></div><div class=\"line\">        $(<span class=\"string\">\"#addPicBtn\"</span>).click(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">            bridge.send(&#123;</div><div class=\"line\">                <span class=\"string\">\"cmd\"</span>: <span class=\"string\">\"getPictures\"</span>,</div><div class=\"line\">                <span class=\"string\">\"data\"</span>: &#123;</div><div class=\"line\">                    <span class=\"string\">\"count\"</span>: <span class=\"number\">9</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">responseCallback</span>(<span class=\"params\">responseData</span>) </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">var</span> imgs = <span class=\"built_in\">JSON</span>.parse(responseData).data.imgs;</div><div class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; imgs.length; i++) &#123;</div><div class=\"line\">                    $(<span class=\"string\">'#picList'</span>).append(<span class=\"string\">'&lt;li&gt;&lt;img src=\"data:image/jpeg;base64,'</span> + imgs[i] + <span class=\"string\">'\" alt=\"image\" width=\"50\" height=\"50\"&gt;&lt;/li&gt;'</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;);</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>所以我的MyBridge类只定义了一个send方法，在其内部接收Json数据，根据cmd参数判断到底要执行哪个方法。我把方法写在引用WebView的Activity中了，所以添加了一个init方法，进行初始化，保持WebViewActivity对象，以便调用。</p>\n<p>下面编写WebViewActivity类。<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> WebViewActivity <span class=\"keyword\">extends</span> Activity &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> WebView webView;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> JsCallback onceCallback; <span class=\"comment\">// 单次回调</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> PICK_PHOTO_REQUEST = <span class=\"number\">1</span>; <span class=\"comment\">// 选择图片请求码</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MAX_PHOTO_NUM = <span class=\"number\">9</span>; <span class=\"comment\">// 最大选择数量</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> showCamera = <span class=\"keyword\">true</span>; <span class=\"comment\">// 是否打开相机</span></div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onCreate(Bundle savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        MyBridge.init(<span class=\"keyword\">this</span>);</div><div class=\"line\">        webView = <span class=\"keyword\">new</span> WebView(<span class=\"keyword\">this</span>);</div><div class=\"line\">        <span class=\"comment\">// 切换到内容视图</span></div><div class=\"line\">        setContentView(webView);</div><div class=\"line\">        <span class=\"comment\">// 获取WebView配置</span></div><div class=\"line\">        WebSettings ws = webView.getSettings();</div><div class=\"line\">        <span class=\"comment\">// 启用JavaScript</span></div><div class=\"line\">        ws.setJavaScriptEnabled(<span class=\"keyword\">true</span>);</div><div class=\"line\">        webView.setWebChromeClient(<span class=\"keyword\">new</span> InjectedChromeClient(<span class=\"string\">\"WebViewJavascriptBridge\"</span>, MyBridge.<span class=\"keyword\">class</span>));</div><div class=\"line\">        <span class=\"comment\">// 载入assets目录下的一个页面</span></div><div class=\"line\">        webView.loadUrl(<span class=\"string\">\"file:///android_asset/native-api.html\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> String getToken() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"hello world\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> getPictures(JsCallback jsCallback) &#123;</div><div class=\"line\">        onceCallback = jsCallback;</div><div class=\"line\">        Intent intent = <span class=\"keyword\">new</span> Intent(<span class=\"keyword\">this</span>, PhotoPickerActivity.<span class=\"keyword\">class</span>);</div><div class=\"line\">        intent.putExtra(PhotoPickerActivity.EXTRA_SHOW_CAMERA, showCamera);</div><div class=\"line\">        intent.putExtra(PhotoPickerActivity.EXTRA_SELECT_MODE, PhotoPickerActivity.MODE_MULTI);</div><div class=\"line\">        intent.putExtra(PhotoPickerActivity.EXTRA_MAX_MUN, MAX_PHOTO_NUM);</div><div class=\"line\">        startActivityForResult(intent, PICK_PHOTO_REQUEST);</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onActivityResult(<span class=\"keyword\">int</span> requestCode, <span class=\"keyword\">int</span> resultCode, Intent data) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (requestCode == PICK_PHOTO_REQUEST) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (resultCode == RESULT_OK) &#123;</div><div class=\"line\">                <span class=\"comment\">// 拼接返回Json</span></div><div class=\"line\">                ArrayList&lt;String&gt; result = data.getStringArrayListExtra(PhotoPickerActivity.KEY_RESULT);</div><div class=\"line\">                JSONObject dataJson = <span class=\"keyword\">new</span> JSONObject();</div><div class=\"line\">                JSONObject images = <span class=\"keyword\">new</span> JSONObject();</div><div class=\"line\">                JSONArray jsonArray = <span class=\"keyword\">new</span> JSONArray();</div><div class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; result.<span class=\"keyword\">size</span>(); i++) &#123;</div><div class=\"line\">                    <span class=\"keyword\">File</span> <span class=\"keyword\">file</span> = <span class=\"keyword\">new</span> <span class=\"keyword\">File</span>(result.get(i));</div><div class=\"line\">                    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                        FileInputStream fis = <span class=\"keyword\">new</span> FileInputStream(<span class=\"keyword\">file</span>);</div><div class=\"line\">                        <span class=\"keyword\">byte</span>[] dataInByte = steamToByte(fis);</div><div class=\"line\">                        String msg = Base64.encodeToString(dataInByte, Base64.<span class=\"keyword\">DEFAULT</span>);</div><div class=\"line\">                        <span class=\"comment\">// 通过Base64方式返回的String会包含许多\\n，需去除掉</span></div><div class=\"line\">                        msg = msg.replaceAll(<span class=\"string\">\"\\n\"</span>, <span class=\"string\">\"\"</span>);</div><div class=\"line\">                        jsonArray.put(msg);</div><div class=\"line\">                        fis.close();</div><div class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (FileNotFoundException e) &#123;</div><div class=\"line\">                        e.printStackTrace();</div><div class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">                        e.printStackTrace();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                    images.put(<span class=\"string\">\"imgs\"</span>, jsonArray);</div><div class=\"line\">                    dataJson.put(<span class=\"string\">\"data\"</span>, images);</div><div class=\"line\">                &#125; <span class=\"keyword\">catch</span> (JSONException e) &#123;</div><div class=\"line\">                    e.printStackTrace();</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"comment\">// 回调</span></div><div class=\"line\">                <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                    <span class=\"keyword\">if</span> (onceCallback != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        onceCallback.apply(dataJson.toString());</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125; <span class=\"keyword\">catch</span> (JsCallback.JsCallbackException e) &#123;</div><div class=\"line\">                    e.printStackTrace();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onActivityResult(requestCode, resultCode, data);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] steamToByte(InputStream input) <span class=\"keyword\">throws</span> IOException &#123;</div><div class=\"line\">        ByteArrayOutputStream baos = <span class=\"keyword\">new</span> ByteArrayOutputStream();</div><div class=\"line\">        <span class=\"keyword\">int</span> len;</div><div class=\"line\">        <span class=\"keyword\">byte</span>[] b = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</div><div class=\"line\">        <span class=\"keyword\">while</span> ((len = input.<span class=\"keyword\">read</span>(b, <span class=\"number\">0</span>, b.length)) != -<span class=\"number\">1</span>) &#123;</div><div class=\"line\">            baos.<span class=\"keyword\">write</span>(b, <span class=\"number\">0</span>, len);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">byte</span>[] buffer = baos.toByteArray();</div><div class=\"line\">        <span class=\"keyword\">return</span> buffer;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到MyBridge中的send方法最终会调用到WebViewActivity中的getToken方法与getPictures方法。<br>getToken方法很简单，仅仅是返回一个”Hello world“。getPictures方法则是打开PhotoPicker三方库中的Activity。在选完图片之后，利用onActivityResult接收返回的图片路径。然后利用Base64进行处理，得到我们需要的String对象，返回给JsCallback进行回调。</p>\n<p>在JS中处理回调参数的代码是<code>var imgs = JSON.parse(responseData).data.imgs;</code>，所以我们返回的String对象也需要时JSON格式，并且包含data、imgs属性。类似这样：{“data”:{“imgs”:[“string1”, “string2”]}}。所以我在onActivityResult中进行了拼接处理。</p>\n<p>最后运行程序，得到的效果大致是这样的。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice2.png\" alt=\"这里写图片描述\"><br>可以看到，在我们的H5页面确实显示了图片。</p>\n<h2 id=\"题外话\"><a href=\"#题外话\" class=\"headerlink\" title=\"题外话\"></a>题外话</h2><h3 id=\"话题1\"><a href=\"#话题1\" class=\"headerlink\" title=\"话题1\"></a>话题1</h3><p>在引入PhotoPicker的时候，若在选择图片碰到很长的图片，例如微博长图，400*8000px这样的图，会导致在时容易出现OOM。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/hybrid-practice3.png\" alt=\"这里写图片描述\"><br>在原来库中进行压缩的inSampleSize是这样计算的：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"built_in\">int</span> calculateInSampleSize(BitmapFactory.Options options, <span class=\"built_in\">int</span> reqWidth, <span class=\"built_in\">int</span> reqHeight) &#123;</div><div class=\"line\">    <span class=\"comment\">// 源图片的宽度</span></div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">width</span> = options.outWidth;</div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">height</span> = options.outHeight;</div><div class=\"line\">    <span class=\"built_in\">int</span> inSampleSize = <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">min</span> = Math.<span class=\"built_in\">min</span>(<span class=\"built_in\">width</span>, <span class=\"built_in\">height</span>);</div><div class=\"line\">    <span class=\"built_in\">int</span> maxReq = Math.<span class=\"built_in\">max</span>(reqWidth, reqHeight);</div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"built_in\">min</span> &gt; maxReq) &#123;</div><div class=\"line\">        inSampleSize = Math.<span class=\"built_in\">round</span>((<span class=\"built_in\">float</span>) <span class=\"built_in\">min</span> / (<span class=\"built_in\">float</span>) maxReq);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> inSampleSize;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>使用这种方式，计算得到的inSampleSize值，在压缩这种长图后得到的Bitmap仍然会很大，导致OOM。<br>改成如下则不会OOM了，但是图片会变得模糊一些（不可避免的，总要舍弃一些东西，微信也是这样）。<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"built_in\">int</span> calculateInSampleSize(BitmapFactory.Options options, <span class=\"built_in\">int</span> reqWidth, <span class=\"built_in\">int</span> reqHeight) &#123;</div><div class=\"line\">    <span class=\"comment\">// 源图片的宽度</span></div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">width</span> = options.outWidth;</div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"built_in\">height</span> = options.outHeight;</div><div class=\"line\">    <span class=\"built_in\">int</span> inSampleSize = <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">width</span> &gt; reqWidth || <span class=\"built_in\">height</span> &gt; reqHeight) &#123;</div><div class=\"line\">        <span class=\"built_in\">int</span> widthRadio = Math.<span class=\"built_in\">round</span>(<span class=\"built_in\">width</span> * <span class=\"number\">1.0</span>f / reqWidth);</div><div class=\"line\">        <span class=\"built_in\">int</span> heightRadio = Math.<span class=\"built_in\">round</span>(<span class=\"built_in\">height</span> * <span class=\"number\">1.0</span>f / reqHeight);</div><div class=\"line\">        inSampleSize = Math.<span class=\"built_in\">max</span>(widthRadio, heightRadio);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> inSampleSize;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这个问题我已经跟作者反应，并且已经改正了。</p>\n<h3 id=\"话题2\"><a href=\"#话题2\" class=\"headerlink\" title=\"话题2\"></a>话题2</h3><p>拼接好String字符串，准备返回给JsCallback进行回调时会出错。Log信息：<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Log：I/<span class=\"string\">chromium:</span> [<span class=\"string\">INFO:</span>CONSOLE(<span class=\"number\">1</span>)] <span class=\"string\">\"Uncaught SyntaxError: Unexpected identifier\"</span>, <span class=\"string\">source:</span> (<span class=\"number\">1</span>)</div></pre></td></tr></table></figure></p>\n<p>后面我看到JsCallback里的apply函数：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> apply (<span class=\"keyword\">Object</span>... args) <span class=\"keyword\">throws</span> JsCallbackException &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mWebViewRef.<span class=\"built_in\">get</span>() == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JsCallbackException(<span class=\"string\">\"the WebView related to the JsCallback has been recycled\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!mCouldGoOn) &#123;</div><div class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JsCallbackException(<span class=\"string\">\"the JsCallback isn't permanent,cannot be called more than once\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    StringBuilder sb = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">Object</span> arg : args)&#123;</div><div class=\"line\">        sb.<span class=\"built_in\">append</span>(<span class=\"string\">\",\"</span>);</div><div class=\"line\">        <span class=\"built_in\">boolean</span> isStrArg = arg <span class=\"keyword\">instanceof</span> <span class=\"keyword\">String</span>;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isStrArg) &#123;</div><div class=\"line\">            sb.<span class=\"built_in\">append</span>(<span class=\"string\">\"\\\"\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        sb.<span class=\"built_in\">append</span>(<span class=\"keyword\">String</span>.valueOf(arg));</div><div class=\"line\">        <span class=\"keyword\">if</span> (isStrArg) &#123;</div><div class=\"line\">            sb.<span class=\"built_in\">append</span>(<span class=\"string\">\"\\\"\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">String</span> execJs = <span class=\"keyword\">String</span>.format(CALLBACK_JS_FORMAT, mInjectedName, mIndex, mIsPermanent, sb.toString());</div><div class=\"line\">    Log.d(<span class=\"string\">\"JsCallBack\"</span>, execJs);</div><div class=\"line\">    mWebViewRef.<span class=\"built_in\">get</span>().loadUrl(execJs);</div><div class=\"line\">    mCouldGoOn = mIsPermanent &gt; <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>他会在参数的前后加上双引号。因为返回的String对象是类似Json格式，里面也会包含双引号，这就会导致传递出错。<br>这个问题我也已经提了issue给作者，但目前还没有什么回应。</p>\n<p>碰到问题需要解决，在作者回应之前只能自己改咯。<br>将代码下载下来，丢到工程中，不采用gradle依赖的方式了。也就三个类：InjectedChromeClient、JsCallback、JsCallJava。手动将apply中的代码改成如下：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> apply (<span class=\"keyword\">Object</span>... args) <span class=\"keyword\">throws</span> JsCallbackException &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mWebViewRef.<span class=\"built_in\">get</span>() == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JsCallbackException(<span class=\"string\">\"the WebView related to the JsCallback has been recycled\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!mCouldGoOn) &#123;</div><div class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JsCallbackException(<span class=\"string\">\"the JsCallback isn't permanent,cannot be called more than once\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    StringBuilder sb = <span class=\"keyword\">new</span> StringBuilder();</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">Object</span> arg : args)&#123;</div><div class=\"line\">        sb.<span class=\"built_in\">append</span>(<span class=\"string\">\",\"</span>);</div><div class=\"line\">        <span class=\"built_in\">boolean</span> isStrArg = arg <span class=\"keyword\">instanceof</span> <span class=\"keyword\">String</span>;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isStrArg) &#123;</div><div class=\"line\">            sb.<span class=\"built_in\">append</span>(<span class=\"string\">\"'\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        sb.<span class=\"built_in\">append</span>(<span class=\"keyword\">String</span>.valueOf(arg));</div><div class=\"line\">        <span class=\"keyword\">if</span> (isStrArg) &#123;</div><div class=\"line\">            sb.<span class=\"built_in\">append</span>(<span class=\"string\">\"'\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">String</span> execJs = <span class=\"keyword\">String</span>.format(CALLBACK_JS_FORMAT, mInjectedName, mIndex, mIsPermanent, sb.toString());</div><div class=\"line\">    Log.d(<span class=\"string\">\"JsCallBack\"</span>, execJs);</div><div class=\"line\">    mWebViewRef.<span class=\"built_in\">get</span>().loadUrl(execJs);</div><div class=\"line\">    mCouldGoOn = mIsPermanent &gt; <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>双引号改成单引号就行了。</p>\n<p>但是只有又会引发新的问题：返回的String不能包含单引号。这确实比较蛋疼了，只能根据需求来吧，能解决当前问题的就行。延伸到既包含双引号又包含单引号的String对象又该如何传递呢？这里抛个疑问，大家可以共同探讨。</p>\n<p>补充一点：通过Base64返回的String串来显示图片只适合小图片，太大的图片需要压缩后再返回，不然也会OOM。</p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p><a href=\"https://github.com/LiJia92/HybridPhotoPicker\">源码下载</a></p>"},{"title":"Android接入JPush（极光推送）","date":"2016-04-05T06:14:58.000Z","_content":"\n项目中需要有推送功能，技术负责人最后决定使用``极光推送``，活被分配给我了，于是我便接了一波，在此小记一下~\n\n在极光推送的[官方文档](http://docs.jpush.io/guideline/android_guide/)中，已经有了较详细的说明了，这里只做一下简单的摘录。\n\n## 三分钟快速Demo\n在极光推送的官方文档中，有``三分钟快速Demo``，我也是从demo入手。\n### 创建开发者账号\n接过sdk的同学应该都知道，再使用第三方的服务的时候，总会需要先注册一个``开发者账号``。\n要创建极光推送开发者帐号，请访问[极光推送官方网站](http://jpush.cn)。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush1.png)\n\n<!-- more -->\n\n### 创建应用\n使用注册账号登录，进入极光控制台后，点击``创建应用``。创建帐号进入极光推送后，首先显示的是创建应用的界面。填上你的应用程序的名称，以及 Android包名这二顶就可以了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush2.png)\n\n### 下载应用Example\n点击``下载Android Example``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush3.png)\n\n### 启动项目\n下载后得到一个Zip，可直接解压导入到Android Studio中，然后编译运行项目，安装到手机运行即可。gradle配置可能需要依据你当前开发极其做些修改。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush4.png)\n\n### 推送消息\n填写要推送的内容，选择推送对象，点击发送即可推送消息了。这时手机便能接受到推送的消息了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush5.png)\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush6.png)\n\n## 接入JPush到实际项目\n### 导入sdk\n在官网上下载sdk，然后导入到项目中：\n1. 解压缩 jpush-sdk_v2.x.y.zip 集成压缩包\n2. 复制``libs/jpush-sdk-release2.x.y.jar``到工程 libs/ 目录下\n3. 复制``libs/armeabi/libjpush2xy.so``到工程 libs/armeabi 目录下\n4. 复制``libs/armeabi-v7a/libjpush.so``到工程 libs/armeabi-v7a 目录下\n5. 复制``res/drawable-hdpi``中的资源文件到工程的 res/drawable-hdpi/ 目录下\n6. 复制``res/layout``中的布局文件到工程的 res/layout/ 目录下\n\n其中5和6，其实是可以忽略的，我导入的时候看了下，这是极光推送默认的布局，在集成的时候，项目肯定会有自己的布局，需要自己去自定义，本身的默认布局是用不到的。\n### 配置AndroidManifest.xml\n参考官网的示例xml中进行配置``AndroidManifest.xml``，这里贴一下官网的示例：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?\n<manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"\n     package=\"您应用的包名\"\n     android:versionCode=\"205\"\n     android:versionName=\"2.0.5\"\n     >\n     <uses-sdk android:minSdkVersion=\"11\" android:targetSdkVersion=\"17\" />\n     <!-- Required 自定义用来收发消息的相关权限 -->\n     <permission\n         android:name=\"${applicationId}.permission.JPUSH_MESSAGE\"\n         android:protectionLevel=\"signature\" />\n\n     <!-- Required 一些系统要求的权限，如访问网络等-->\n     <uses-permission android:name=\"${applicationId}.permission.JPUSH_MESSAGE\" />\n     <uses-permission android:name=\"android.permission.RECEIVE_USER_PRESENT\" />\n     <uses-permission android:name=\"android.permission.INTERNET\" />\n     <uses-permission android:name=\"android.permission.WAKE_LOCK\" />\n     <uses-permission android:name=\"android.permission.READ_PHONE_STATE\" />\n     <uses-permission android:name=\"android.permission.WRITE_EXTERNAL_STORAGE\" />\n     <uses-permission android:name=\"android.permission.READ_EXTERNAL_STORAGE\" />\n     <uses-permission android:name=\"android.permission.WRITE_SETTINGS\" />\n     <uses-permission android:name=\"android.permission.VIBRATE\" />\n     <uses-permission android:name=\"android.permission.MOUNT_UNMOUNT_FILESYSTEMS\" />\n     <uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\" />\n     <uses-permission android:name=\"android.permission.ACCESS_WIFI_STATE\" />\n\n\n     <!-- Optional for location -->\n     <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\" />\n     <uses-permission android:name=\"android.permission.CHANGE_WIFI_STATE\" />\n     <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\" />\n     <uses-permission android:name=\"android.permission.ACCESS_LOCATION_EXTRA_COMMANDS\" />\n     <uses-permission android:name=\"android.permission.CHANGE_NETWORK_STATE\" />\n\n\n     <application\n         android:icon=\"@drawable/ic_launcher\"\n         android:label=\"@string/app_name\">\n\n\n         <!-- Required SDK核心功能-->\n         <activity\n             android:name=\"cn.jpush.android.ui.PushActivity\"\n             android:configChanges=\"orientation|keyboardHidden\"\n             android:theme=\"@android:style/Theme.NoTitleBar\"\n             android:exported=\"false\">\n             <intent-filter>\n                 <action android:name=\"cn.jpush.android.ui.PushActivity\" />\n                 <category android:name=\"android.intent.category.DEFAULT\" />\n                 <category android:name=\"${applicationId}\" />\n             </intent-filter>\n         </activity>\n\n         <!-- Required SDK核心功能-->\n         <service\n             android:name=\"cn.jpush.android.service.DownloadService\"\n             android:enabled=\"true\"\n             android:exported=\"false\" >\n         </service>\n\n         <!-- Required SDK 核心功能-->\n         <!-- option since 2.0.5 可配置PushService的android:process参数 将JPush服务配置为一个独立进程 -->\n         <!-- 如：android:process=\":remote\" -->\n         <service\n             android:name=\"cn.jpush.android.service.PushService\"\n             android:enabled=\"true\"\n             android:exported=\"false\">\n             <intent-filter>\n                 <action android:name=\"cn.jpush.android.intent.REGISTER\" />\n                 <action android:name=\"cn.jpush.android.intent.REPORT\" />\n                 <action android:name=\"cn.jpush.android.intent.PushService\" />\n                 <action android:name=\"cn.jpush.android.intent.PUSH_TIME\" />\n\n             </intent-filter>\n         </service>\n\n         <!-- Required SDK 核心功能 since 1.8.0 -->\n         <service\n             android:name=\"cn.jpush.android.service.DaemonService\"\n             android:enabled=\"true\"\n             android:exported=\"true\">\n             <intent-filter >\n                 <action android:name=\"cn.jpush.android.intent.DaemonService\" />\n                 <category android:name=\"${applicationId}\"/>\n             </intent-filter>\n         </service>\n\n         <!-- Required SDK核心功能-->\n         <receiver\n             android:name=\"cn.jpush.android.service.PushReceiver\"\n             android:enabled=\"true\"\n             android:exported=\"false\">\n             <intent-filter android:priority=\"1000\">\n                 <action android:name=\"cn.jpush.android.intent.NOTIFICATION_RECEIVED_PROXY\" /> <!--Required 显示通知栏 -->\n                 <category android:name=\"${applicationId}\" />\n             </intent-filter>\n             <intent-filter>\n                 <action android:name=\"android.intent.action.USER_PRESENT\" />\n                 <action android:name=\"android.net.conn.CONNECTIVITY_CHANGE\" />\n             </intent-filter>\n             <!-- Optional -->\n             <intent-filter>\n                 <action android:name=\"android.intent.action.PACKAGE_ADDED\" />\n                 <action android:name=\"android.intent.action.PACKAGE_REMOVED\" />\n                 <data android:scheme=\"package\" />\n             </intent-filter>\n         </receiver>\n\n         <!-- Required SDK核心功能-->\n         <receiver android:name=\"cn.jpush.android.service.AlarmReceiver\" />\n\n         <!-- User defined. 用户自定义的广播接收器-->\n         <receiver\n             android:name=\"您自己定义的Receiver\"\n             android:enabled=\"true\">\n             <intent-filter>\n                 <action android:name=\"cn.jpush.android.intent.REGISTRATION\" /> <!--Required 用户注册SDK的intent-->\n                 <action android:name=\"cn.jpush.android.intent.MESSAGE_RECEIVED\" /> <!--Required 用户接收SDK消息的intent-->\n                 <action android:name=\"cn.jpush.android.intent.NOTIFICATION_RECEIVED\" /> <!--Required 用户接收SDK通知栏信息的intent-->\n                 <action android:name=\"cn.jpush.android.intent.NOTIFICATION_OPENED\" /> <!--Required 用户打开自定义通知栏的intent-->\n                 <action android:name=\"cn.jpush.android.intent.ACTION_RICHPUSH_CALLBACK\" /> <!--Optional 用户接受Rich Push Javascript 回调函数的intent-->\n                 <action android:name=\"cn.jpush.android.intent.CONNECTION\" /><!-- 接收网络变化 连接/断开 since 1.6.3 -->\n                 <category android:name=\"${applicationId}\" />\n             </intent-filter>\n         </receiver>\n\n         <!-- Required . Enable it you can get statistics data with channel -->\n         <meta-data android:name=\"JPUSH_CHANNEL\" android:value=\"developer-default\"/>\n         <meta-data android:name=\"JPUSH_APPKEY\" android:value=\"您应用applicationId对应的appKey\" /> <!-- </>值来自开发者平台取得的AppKey-->\n     </application>\n</manifest>\n```\n其中注意：\n - 标注``Required``为必须的\n - 包名\n - AppKey\n\n### 初始化\n在Application中初始化JPush。\n```\npublic class ExampleApplication extends Application {\n    @Override\n    public void onCreate() {\n      super.onCreate();\n      JPushInterface.setDebugMode(true);\n      JPushInterface.init(this);\n    }\n}\n\n```\n至此，JPush便已全部集成完毕。至于自定义通知布局，以及Notification的点击响应，后面再说了。\n\n## 问题\n1. 我是小米的测试机，在接收推送消息的时候，必须要启动应用的时候才会收到推送的消息。后面才知道，是有些手机需要``允许应用自启动``。修改之后便可在没启动应用的时候也能收到推送消息了。[点这里](http://docs.jpush.io/guideline/faq/#android)传送常见问题。\n\n## 所感\n作为一款比较大众的产品，肯定是不会有很多坑的（不然也没那么多人会用它了），在其官方文档的说明上，一般都会有相应的说明。在看文档的时候，一定要``仔细``，``仔细``，``仔细``，重要的事情说三遍~\n","source":"_posts/jpush.md","raw":"---\ntitle: Android接入JPush（极光推送）\ndate: 2016-04-05 14:14:58\ntags:\n - sdk\n---\n\n项目中需要有推送功能，技术负责人最后决定使用``极光推送``，活被分配给我了，于是我便接了一波，在此小记一下~\n\n在极光推送的[官方文档](http://docs.jpush.io/guideline/android_guide/)中，已经有了较详细的说明了，这里只做一下简单的摘录。\n\n## 三分钟快速Demo\n在极光推送的官方文档中，有``三分钟快速Demo``，我也是从demo入手。\n### 创建开发者账号\n接过sdk的同学应该都知道，再使用第三方的服务的时候，总会需要先注册一个``开发者账号``。\n要创建极光推送开发者帐号，请访问[极光推送官方网站](http://jpush.cn)。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush1.png)\n\n<!-- more -->\n\n### 创建应用\n使用注册账号登录，进入极光控制台后，点击``创建应用``。创建帐号进入极光推送后，首先显示的是创建应用的界面。填上你的应用程序的名称，以及 Android包名这二顶就可以了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush2.png)\n\n### 下载应用Example\n点击``下载Android Example``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush3.png)\n\n### 启动项目\n下载后得到一个Zip，可直接解压导入到Android Studio中，然后编译运行项目，安装到手机运行即可。gradle配置可能需要依据你当前开发极其做些修改。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush4.png)\n\n### 推送消息\n填写要推送的内容，选择推送对象，点击发送即可推送消息了。这时手机便能接受到推送的消息了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush5.png)\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush6.png)\n\n## 接入JPush到实际项目\n### 导入sdk\n在官网上下载sdk，然后导入到项目中：\n1. 解压缩 jpush-sdk_v2.x.y.zip 集成压缩包\n2. 复制``libs/jpush-sdk-release2.x.y.jar``到工程 libs/ 目录下\n3. 复制``libs/armeabi/libjpush2xy.so``到工程 libs/armeabi 目录下\n4. 复制``libs/armeabi-v7a/libjpush.so``到工程 libs/armeabi-v7a 目录下\n5. 复制``res/drawable-hdpi``中的资源文件到工程的 res/drawable-hdpi/ 目录下\n6. 复制``res/layout``中的布局文件到工程的 res/layout/ 目录下\n\n其中5和6，其实是可以忽略的，我导入的时候看了下，这是极光推送默认的布局，在集成的时候，项目肯定会有自己的布局，需要自己去自定义，本身的默认布局是用不到的。\n### 配置AndroidManifest.xml\n参考官网的示例xml中进行配置``AndroidManifest.xml``，这里贴一下官网的示例：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?\n<manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"\n     package=\"您应用的包名\"\n     android:versionCode=\"205\"\n     android:versionName=\"2.0.5\"\n     >\n     <uses-sdk android:minSdkVersion=\"11\" android:targetSdkVersion=\"17\" />\n     <!-- Required 自定义用来收发消息的相关权限 -->\n     <permission\n         android:name=\"${applicationId}.permission.JPUSH_MESSAGE\"\n         android:protectionLevel=\"signature\" />\n\n     <!-- Required 一些系统要求的权限，如访问网络等-->\n     <uses-permission android:name=\"${applicationId}.permission.JPUSH_MESSAGE\" />\n     <uses-permission android:name=\"android.permission.RECEIVE_USER_PRESENT\" />\n     <uses-permission android:name=\"android.permission.INTERNET\" />\n     <uses-permission android:name=\"android.permission.WAKE_LOCK\" />\n     <uses-permission android:name=\"android.permission.READ_PHONE_STATE\" />\n     <uses-permission android:name=\"android.permission.WRITE_EXTERNAL_STORAGE\" />\n     <uses-permission android:name=\"android.permission.READ_EXTERNAL_STORAGE\" />\n     <uses-permission android:name=\"android.permission.WRITE_SETTINGS\" />\n     <uses-permission android:name=\"android.permission.VIBRATE\" />\n     <uses-permission android:name=\"android.permission.MOUNT_UNMOUNT_FILESYSTEMS\" />\n     <uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\" />\n     <uses-permission android:name=\"android.permission.ACCESS_WIFI_STATE\" />\n\n\n     <!-- Optional for location -->\n     <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\" />\n     <uses-permission android:name=\"android.permission.CHANGE_WIFI_STATE\" />\n     <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\" />\n     <uses-permission android:name=\"android.permission.ACCESS_LOCATION_EXTRA_COMMANDS\" />\n     <uses-permission android:name=\"android.permission.CHANGE_NETWORK_STATE\" />\n\n\n     <application\n         android:icon=\"@drawable/ic_launcher\"\n         android:label=\"@string/app_name\">\n\n\n         <!-- Required SDK核心功能-->\n         <activity\n             android:name=\"cn.jpush.android.ui.PushActivity\"\n             android:configChanges=\"orientation|keyboardHidden\"\n             android:theme=\"@android:style/Theme.NoTitleBar\"\n             android:exported=\"false\">\n             <intent-filter>\n                 <action android:name=\"cn.jpush.android.ui.PushActivity\" />\n                 <category android:name=\"android.intent.category.DEFAULT\" />\n                 <category android:name=\"${applicationId}\" />\n             </intent-filter>\n         </activity>\n\n         <!-- Required SDK核心功能-->\n         <service\n             android:name=\"cn.jpush.android.service.DownloadService\"\n             android:enabled=\"true\"\n             android:exported=\"false\" >\n         </service>\n\n         <!-- Required SDK 核心功能-->\n         <!-- option since 2.0.5 可配置PushService的android:process参数 将JPush服务配置为一个独立进程 -->\n         <!-- 如：android:process=\":remote\" -->\n         <service\n             android:name=\"cn.jpush.android.service.PushService\"\n             android:enabled=\"true\"\n             android:exported=\"false\">\n             <intent-filter>\n                 <action android:name=\"cn.jpush.android.intent.REGISTER\" />\n                 <action android:name=\"cn.jpush.android.intent.REPORT\" />\n                 <action android:name=\"cn.jpush.android.intent.PushService\" />\n                 <action android:name=\"cn.jpush.android.intent.PUSH_TIME\" />\n\n             </intent-filter>\n         </service>\n\n         <!-- Required SDK 核心功能 since 1.8.0 -->\n         <service\n             android:name=\"cn.jpush.android.service.DaemonService\"\n             android:enabled=\"true\"\n             android:exported=\"true\">\n             <intent-filter >\n                 <action android:name=\"cn.jpush.android.intent.DaemonService\" />\n                 <category android:name=\"${applicationId}\"/>\n             </intent-filter>\n         </service>\n\n         <!-- Required SDK核心功能-->\n         <receiver\n             android:name=\"cn.jpush.android.service.PushReceiver\"\n             android:enabled=\"true\"\n             android:exported=\"false\">\n             <intent-filter android:priority=\"1000\">\n                 <action android:name=\"cn.jpush.android.intent.NOTIFICATION_RECEIVED_PROXY\" /> <!--Required 显示通知栏 -->\n                 <category android:name=\"${applicationId}\" />\n             </intent-filter>\n             <intent-filter>\n                 <action android:name=\"android.intent.action.USER_PRESENT\" />\n                 <action android:name=\"android.net.conn.CONNECTIVITY_CHANGE\" />\n             </intent-filter>\n             <!-- Optional -->\n             <intent-filter>\n                 <action android:name=\"android.intent.action.PACKAGE_ADDED\" />\n                 <action android:name=\"android.intent.action.PACKAGE_REMOVED\" />\n                 <data android:scheme=\"package\" />\n             </intent-filter>\n         </receiver>\n\n         <!-- Required SDK核心功能-->\n         <receiver android:name=\"cn.jpush.android.service.AlarmReceiver\" />\n\n         <!-- User defined. 用户自定义的广播接收器-->\n         <receiver\n             android:name=\"您自己定义的Receiver\"\n             android:enabled=\"true\">\n             <intent-filter>\n                 <action android:name=\"cn.jpush.android.intent.REGISTRATION\" /> <!--Required 用户注册SDK的intent-->\n                 <action android:name=\"cn.jpush.android.intent.MESSAGE_RECEIVED\" /> <!--Required 用户接收SDK消息的intent-->\n                 <action android:name=\"cn.jpush.android.intent.NOTIFICATION_RECEIVED\" /> <!--Required 用户接收SDK通知栏信息的intent-->\n                 <action android:name=\"cn.jpush.android.intent.NOTIFICATION_OPENED\" /> <!--Required 用户打开自定义通知栏的intent-->\n                 <action android:name=\"cn.jpush.android.intent.ACTION_RICHPUSH_CALLBACK\" /> <!--Optional 用户接受Rich Push Javascript 回调函数的intent-->\n                 <action android:name=\"cn.jpush.android.intent.CONNECTION\" /><!-- 接收网络变化 连接/断开 since 1.6.3 -->\n                 <category android:name=\"${applicationId}\" />\n             </intent-filter>\n         </receiver>\n\n         <!-- Required . Enable it you can get statistics data with channel -->\n         <meta-data android:name=\"JPUSH_CHANNEL\" android:value=\"developer-default\"/>\n         <meta-data android:name=\"JPUSH_APPKEY\" android:value=\"您应用applicationId对应的appKey\" /> <!-- </>值来自开发者平台取得的AppKey-->\n     </application>\n</manifest>\n```\n其中注意：\n - 标注``Required``为必须的\n - 包名\n - AppKey\n\n### 初始化\n在Application中初始化JPush。\n```\npublic class ExampleApplication extends Application {\n    @Override\n    public void onCreate() {\n      super.onCreate();\n      JPushInterface.setDebugMode(true);\n      JPushInterface.init(this);\n    }\n}\n\n```\n至此，JPush便已全部集成完毕。至于自定义通知布局，以及Notification的点击响应，后面再说了。\n\n## 问题\n1. 我是小米的测试机，在接收推送消息的时候，必须要启动应用的时候才会收到推送的消息。后面才知道，是有些手机需要``允许应用自启动``。修改之后便可在没启动应用的时候也能收到推送消息了。[点这里](http://docs.jpush.io/guideline/faq/#android)传送常见问题。\n\n## 所感\n作为一款比较大众的产品，肯定是不会有很多坑的（不然也没那么多人会用它了），在其官方文档的说明上，一般都会有相应的说明。在看文档的时候，一定要``仔细``，``仔细``，``仔细``，重要的事情说三遍~\n","slug":"jpush","published":1,"updated":"2016-11-21T10:00:17.154Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7595001h1cb8bmjgmmrj","content":"<p>项目中需要有推送功能，技术负责人最后决定使用<code>极光推送</code>，活被分配给我了，于是我便接了一波，在此小记一下~</p>\n<p>在极光推送的<a href=\"http://docs.jpush.io/guideline/android_guide/\" target=\"_blank\" rel=\"external\">官方文档</a>中，已经有了较详细的说明了，这里只做一下简单的摘录。</p>\n<h2 id=\"三分钟快速Demo\"><a href=\"#三分钟快速Demo\" class=\"headerlink\" title=\"三分钟快速Demo\"></a>三分钟快速Demo</h2><p>在极光推送的官方文档中，有<code>三分钟快速Demo</code>，我也是从demo入手。</p>\n<h3 id=\"创建开发者账号\"><a href=\"#创建开发者账号\" class=\"headerlink\" title=\"创建开发者账号\"></a>创建开发者账号</h3><p>接过sdk的同学应该都知道，再使用第三方的服务的时候，总会需要先注册一个<code>开发者账号</code>。<br>要创建极光推送开发者帐号，请访问<a href=\"http://jpush.cn\" target=\"_blank\" rel=\"external\">极光推送官方网站</a>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush1.png\" alt=\"\"></p>\n<a id=\"more\"></a>\n<h3 id=\"创建应用\"><a href=\"#创建应用\" class=\"headerlink\" title=\"创建应用\"></a>创建应用</h3><p>使用注册账号登录，进入极光控制台后，点击<code>创建应用</code>。创建帐号进入极光推送后，首先显示的是创建应用的界面。填上你的应用程序的名称，以及 Android包名这二顶就可以了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush2.png\" alt=\"\"></p>\n<h3 id=\"下载应用Example\"><a href=\"#下载应用Example\" class=\"headerlink\" title=\"下载应用Example\"></a>下载应用Example</h3><p>点击<code>下载Android Example</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush3.png\" alt=\"\"></p>\n<h3 id=\"启动项目\"><a href=\"#启动项目\" class=\"headerlink\" title=\"启动项目\"></a>启动项目</h3><p>下载后得到一个Zip，可直接解压导入到Android Studio中，然后编译运行项目，安装到手机运行即可。gradle配置可能需要依据你当前开发极其做些修改。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush4.png\" alt=\"\"></p>\n<h3 id=\"推送消息\"><a href=\"#推送消息\" class=\"headerlink\" title=\"推送消息\"></a>推送消息</h3><p>填写要推送的内容，选择推送对象，点击发送即可推送消息了。这时手机便能接受到推送的消息了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush5.png\" alt=\"\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush6.png\" alt=\"\"></p>\n<h2 id=\"接入JPush到实际项目\"><a href=\"#接入JPush到实际项目\" class=\"headerlink\" title=\"接入JPush到实际项目\"></a>接入JPush到实际项目</h2><h3 id=\"导入sdk\"><a href=\"#导入sdk\" class=\"headerlink\" title=\"导入sdk\"></a>导入sdk</h3><p>在官网上下载sdk，然后导入到项目中：</p>\n<ol>\n<li>解压缩 jpush-sdk_v2.x.y.zip 集成压缩包</li>\n<li>复制<code>libs/jpush-sdk-release2.x.y.jar</code>到工程 libs/ 目录下</li>\n<li>复制<code>libs/armeabi/libjpush2xy.so</code>到工程 libs/armeabi 目录下</li>\n<li>复制<code>libs/armeabi-v7a/libjpush.so</code>到工程 libs/armeabi-v7a 目录下</li>\n<li>复制<code>res/drawable-hdpi</code>中的资源文件到工程的 res/drawable-hdpi/ 目录下</li>\n<li>复制<code>res/layout</code>中的布局文件到工程的 res/layout/ 目录下</li>\n</ol>\n<p>其中5和6，其实是可以忽略的，我导入的时候看了下，这是极光推送默认的布局，在集成的时候，项目肯定会有自己的布局，需要自己去自定义，本身的默认布局是用不到的。</p>\n<h3 id=\"配置AndroidManifest-xml\"><a href=\"#配置AndroidManifest-xml\" class=\"headerlink\" title=\"配置AndroidManifest.xml\"></a>配置AndroidManifest.xml</h3><p>参考官网的示例xml中进行配置<code>AndroidManifest.xml</code>，这里贴一下官网的示例：<br><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span>?</div><div class=\"line\">&lt;manifest xmlns:android=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">     package=<span class=\"string\">\"您应用的包名\"</span></div><div class=\"line\">     android:versionCode=<span class=\"string\">\"205\"</span></div><div class=\"line\">     android:versionName=<span class=\"string\">\"2.0.5\"</span></div><div class=\"line\">     &gt;</div><div class=\"line\">     &lt;uses-sdk android:minSdkVersion=<span class=\"string\">\"11\"</span> android:targetSdkVersion=<span class=\"string\">\"17\"</span> /&gt;</div><div class=\"line\">     &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> 自定义用来收发消息的相关权限 --&gt;</span></div><div class=\"line\">     &lt;permission</div><div class=\"line\">         android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;.permission.JPUSH_MESSAGE\"</span></div><div class=\"line\">         android:protectionLevel=<span class=\"string\">\"signature\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">     &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> 一些系统要求的权限，如访问网络等--&gt;</span></div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;.permission.JPUSH_MESSAGE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.RECEIVE_USER_PRESENT\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.INTERNET\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.WAKE_LOCK\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.READ_PHONE_STATE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.WRITE_EXTERNAL_STORAGE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.READ_EXTERNAL_STORAGE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.WRITE_SETTINGS\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.VIBRATE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.MOUNT_UNMOUNT_FILESYSTEMS\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_NETWORK_STATE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_WIFI_STATE\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">     &lt;!-- O<span class=\"function\"><span class=\"title\">ptional</span> <span class=\"keyword\">for</span> location --&gt;</span></div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_COARSE_LOCATION\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.CHANGE_WIFI_STATE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_FINE_LOCATION\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_LOCATION_EXTRA_COMMANDS\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.CHANGE_NETWORK_STATE\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">     &lt;application</div><div class=\"line\">         android:icon=<span class=\"string\">\"@drawable/ic_launcher\"</span></div><div class=\"line\">         android:label=<span class=\"string\">\"@string/app_name\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK核心功能--&gt;</span></div><div class=\"line\">         &lt;activity</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.ui.PushActivity\"</span></div><div class=\"line\">             android:configChanges=<span class=\"string\">\"orientation|keyboardHidden\"</span></div><div class=\"line\">             android:<span class=\"built_in\">theme</span>=<span class=\"string\">\"@android:style/Theme.NoTitleBar\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"false\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.ui.PushActivity\"</span> /&gt;</div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.intent.category.DEFAULT\"</span> /&gt;</div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/activity&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK核心功能--&gt;</span></div><div class=\"line\">         &lt;service</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.DownloadService\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"false\"</span> &gt;</div><div class=\"line\">         &lt;/service&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK 核心功能--&gt;</span></div><div class=\"line\">         &lt;!-- <span class=\"function\"><span class=\"title\">option</span> since 2.0.5 可配置PushService的android:process参数 将JPush服务配置为一个独立进程 --&gt;</span></div><div class=\"line\">         &lt;!-- 如：<span class=\"function\"><span class=\"title\">android</span>:process=\":remote\" --&gt;</span></div><div class=\"line\">         &lt;service</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.PushService\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"false\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.REGISTER\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.REPORT\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.PushService\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.PUSH_TIME\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/service&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK 核心功能 since 1.8.0 --&gt;</span></div><div class=\"line\">         &lt;service</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.DaemonService\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter &gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.DaemonService\"</span> /&gt;</div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;\"</span>/&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/service&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK核心功能--&gt;</span></div><div class=\"line\">         &lt;receiver</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.PushReceiver\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"false\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter android:priority=<span class=\"string\">\"1000\"</span>&gt;</div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.NOTIFICATION_RECEIVED_PROXY\" /&gt; &lt;!--Required 显示通知栏 --&gt;</span></div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.intent.action.USER_PRESENT\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.net.conn.CONNECTIVITY_CHANGE\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">             &lt;!-- O<span class=\"function\"><span class=\"title\">ptional</span> --&gt;</span></div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.intent.action.PACKAGE_ADDED\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.intent.action.PACKAGE_REMOVED\"</span> /&gt;</div><div class=\"line\">                 &lt;<span class=\"keyword\">data</span> android:scheme=<span class=\"string\">\"package\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/receiver&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK核心功能--&gt;</span></div><div class=\"line\">         &lt;receiver android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.AlarmReceiver\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- U<span class=\"function\"><span class=\"title\">ser</span> defined. 用户自定义的广播接收器--&gt;</span></div><div class=\"line\">         &lt;receiver</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"您自己定义的Receiver\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.REGISTRATION\" /&gt; &lt;!--Required 用户注册SDK的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.MESSAGE_RECEIVED\" /&gt; &lt;!--Required 用户接收SDK消息的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.NOTIFICATION_RECEIVED\" /&gt; &lt;!--Required 用户接收SDK通知栏信息的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.NOTIFICATION_OPENED\" /&gt; &lt;!--Required 用户打开自定义通知栏的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.ACTION_RICHPUSH_CALLBACK\" /&gt; &lt;!--Optional 用户接受Rich Push Javascript 回调函数的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.CONNECTION\" /&gt;&lt;!-- 接收网络变化 连接/断开 since 1.6.3 --&gt;</span></div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/receiver&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> . Enable it you can get statistics <span class=\"keyword\">data</span> <span class=\"keyword\">with</span> channel --&gt;</span></div><div class=\"line\">         &lt;meta-<span class=\"keyword\">data</span> android:<span class=\"keyword\">name</span>=<span class=\"string\">\"JPUSH_CHANNEL\"</span> android:value=<span class=\"string\">\"developer-default\"</span>/&gt;</div><div class=\"line\">         &lt;<span class=\"function\"><span class=\"title\">meta</span>-<span class=\"keyword\">data</span> android:<span class=\"keyword\">name</span>=\"JPUSH_APPKEY\" android:value=\"您应用applicationId对应的appKey\" /&gt; &lt;!-- &lt;/&gt;值来自开发者平台取得的AppKey--&gt;</span></div><div class=\"line\">     &lt;/application&gt;</div><div class=\"line\">&lt;/manifest&gt;</div></pre></td></tr></table></figure></p>\n<p>其中注意：</p>\n<ul>\n<li>标注<code>Required</code>为必须的</li>\n<li>包名</li>\n<li>AppKey</li>\n</ul>\n<h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><p>在Application中初始化JPush。<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExampleApplication</span> <span class=\"keyword\">extends</span> <span class=\"title\">Application</span> </span>&#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    public void onCreate() &#123;</div><div class=\"line\">      <span class=\"keyword\">super</span>.onCreate();</div><div class=\"line\">      <span class=\"type\">JPushInterface</span>.setDebugMode(<span class=\"literal\">true</span>);</div><div class=\"line\">      <span class=\"type\">JPushInterface</span>.init(<span class=\"keyword\">this</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>至此，JPush便已全部集成完毕。至于自定义通知布局，以及Notification的点击响应，后面再说了。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><ol>\n<li>我是小米的测试机，在接收推送消息的时候，必须要启动应用的时候才会收到推送的消息。后面才知道，是有些手机需要<code>允许应用自启动</code>。修改之后便可在没启动应用的时候也能收到推送消息了。<a href=\"http://docs.jpush.io/guideline/faq/#android\" target=\"_blank\" rel=\"external\">点这里</a>传送常见问题。</li>\n</ol>\n<h2 id=\"所感\"><a href=\"#所感\" class=\"headerlink\" title=\"所感\"></a>所感</h2><p>作为一款比较大众的产品，肯定是不会有很多坑的（不然也没那么多人会用它了），在其官方文档的说明上，一般都会有相应的说明。在看文档的时候，一定要<code>仔细</code>，<code>仔细</code>，<code>仔细</code>，重要的事情说三遍~</p>\n","excerpt":"<p>项目中需要有推送功能，技术负责人最后决定使用<code>极光推送</code>，活被分配给我了，于是我便接了一波，在此小记一下~</p>\n<p>在极光推送的<a href=\"http://docs.jpush.io/guideline/android_guide/\">官方文档</a>中，已经有了较详细的说明了，这里只做一下简单的摘录。</p>\n<h2 id=\"三分钟快速Demo\"><a href=\"#三分钟快速Demo\" class=\"headerlink\" title=\"三分钟快速Demo\"></a>三分钟快速Demo</h2><p>在极光推送的官方文档中，有<code>三分钟快速Demo</code>，我也是从demo入手。</p>\n<h3 id=\"创建开发者账号\"><a href=\"#创建开发者账号\" class=\"headerlink\" title=\"创建开发者账号\"></a>创建开发者账号</h3><p>接过sdk的同学应该都知道，再使用第三方的服务的时候，总会需要先注册一个<code>开发者账号</code>。<br>要创建极光推送开发者帐号，请访问<a href=\"http://jpush.cn\">极光推送官方网站</a>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush1.png\" alt=\"\"></p>","more":"<h3 id=\"创建应用\"><a href=\"#创建应用\" class=\"headerlink\" title=\"创建应用\"></a>创建应用</h3><p>使用注册账号登录，进入极光控制台后，点击<code>创建应用</code>。创建帐号进入极光推送后，首先显示的是创建应用的界面。填上你的应用程序的名称，以及 Android包名这二顶就可以了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush2.png\" alt=\"\"></p>\n<h3 id=\"下载应用Example\"><a href=\"#下载应用Example\" class=\"headerlink\" title=\"下载应用Example\"></a>下载应用Example</h3><p>点击<code>下载Android Example</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush3.png\" alt=\"\"></p>\n<h3 id=\"启动项目\"><a href=\"#启动项目\" class=\"headerlink\" title=\"启动项目\"></a>启动项目</h3><p>下载后得到一个Zip，可直接解压导入到Android Studio中，然后编译运行项目，安装到手机运行即可。gradle配置可能需要依据你当前开发极其做些修改。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush4.png\" alt=\"\"></p>\n<h3 id=\"推送消息\"><a href=\"#推送消息\" class=\"headerlink\" title=\"推送消息\"></a>推送消息</h3><p>填写要推送的内容，选择推送对象，点击发送即可推送消息了。这时手机便能接受到推送的消息了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush5.png\" alt=\"\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/jpush6.png\" alt=\"\"></p>\n<h2 id=\"接入JPush到实际项目\"><a href=\"#接入JPush到实际项目\" class=\"headerlink\" title=\"接入JPush到实际项目\"></a>接入JPush到实际项目</h2><h3 id=\"导入sdk\"><a href=\"#导入sdk\" class=\"headerlink\" title=\"导入sdk\"></a>导入sdk</h3><p>在官网上下载sdk，然后导入到项目中：</p>\n<ol>\n<li>解压缩 jpush-sdk_v2.x.y.zip 集成压缩包</li>\n<li>复制<code>libs/jpush-sdk-release2.x.y.jar</code>到工程 libs/ 目录下</li>\n<li>复制<code>libs/armeabi/libjpush2xy.so</code>到工程 libs/armeabi 目录下</li>\n<li>复制<code>libs/armeabi-v7a/libjpush.so</code>到工程 libs/armeabi-v7a 目录下</li>\n<li>复制<code>res/drawable-hdpi</code>中的资源文件到工程的 res/drawable-hdpi/ 目录下</li>\n<li>复制<code>res/layout</code>中的布局文件到工程的 res/layout/ 目录下</li>\n</ol>\n<p>其中5和6，其实是可以忽略的，我导入的时候看了下，这是极光推送默认的布局，在集成的时候，项目肯定会有自己的布局，需要自己去自定义，本身的默认布局是用不到的。</p>\n<h3 id=\"配置AndroidManifest-xml\"><a href=\"#配置AndroidManifest-xml\" class=\"headerlink\" title=\"配置AndroidManifest.xml\"></a>配置AndroidManifest.xml</h3><p>参考官网的示例xml中进行配置<code>AndroidManifest.xml</code>，这里贴一下官网的示例：<br><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span>?</div><div class=\"line\">&lt;manifest xmlns:android=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">     package=<span class=\"string\">\"您应用的包名\"</span></div><div class=\"line\">     android:versionCode=<span class=\"string\">\"205\"</span></div><div class=\"line\">     android:versionName=<span class=\"string\">\"2.0.5\"</span></div><div class=\"line\">     &gt;</div><div class=\"line\">     &lt;uses-sdk android:minSdkVersion=<span class=\"string\">\"11\"</span> android:targetSdkVersion=<span class=\"string\">\"17\"</span> /&gt;</div><div class=\"line\">     &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> 自定义用来收发消息的相关权限 --&gt;</span></div><div class=\"line\">     &lt;permission</div><div class=\"line\">         android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;.permission.JPUSH_MESSAGE\"</span></div><div class=\"line\">         android:protectionLevel=<span class=\"string\">\"signature\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">     &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> 一些系统要求的权限，如访问网络等--&gt;</span></div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;.permission.JPUSH_MESSAGE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.RECEIVE_USER_PRESENT\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.INTERNET\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.WAKE_LOCK\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.READ_PHONE_STATE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.WRITE_EXTERNAL_STORAGE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.READ_EXTERNAL_STORAGE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.WRITE_SETTINGS\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.VIBRATE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.MOUNT_UNMOUNT_FILESYSTEMS\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_NETWORK_STATE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_WIFI_STATE\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">     &lt;!-- O<span class=\"function\"><span class=\"title\">ptional</span> <span class=\"keyword\">for</span> location --&gt;</span></div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_COARSE_LOCATION\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.CHANGE_WIFI_STATE\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_FINE_LOCATION\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.ACCESS_LOCATION_EXTRA_COMMANDS\"</span> /&gt;</div><div class=\"line\">     &lt;uses-permission android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.permission.CHANGE_NETWORK_STATE\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">     &lt;application</div><div class=\"line\">         android:icon=<span class=\"string\">\"@drawable/ic_launcher\"</span></div><div class=\"line\">         android:label=<span class=\"string\">\"@string/app_name\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK核心功能--&gt;</span></div><div class=\"line\">         &lt;activity</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.ui.PushActivity\"</span></div><div class=\"line\">             android:configChanges=<span class=\"string\">\"orientation|keyboardHidden\"</span></div><div class=\"line\">             android:<span class=\"built_in\">theme</span>=<span class=\"string\">\"@android:style/Theme.NoTitleBar\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"false\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.ui.PushActivity\"</span> /&gt;</div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.intent.category.DEFAULT\"</span> /&gt;</div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/activity&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK核心功能--&gt;</span></div><div class=\"line\">         &lt;service</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.DownloadService\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"false\"</span> &gt;</div><div class=\"line\">         &lt;/service&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK 核心功能--&gt;</span></div><div class=\"line\">         &lt;!-- <span class=\"function\"><span class=\"title\">option</span> since 2.0.5 可配置PushService的android:process参数 将JPush服务配置为一个独立进程 --&gt;</span></div><div class=\"line\">         &lt;!-- 如：<span class=\"function\"><span class=\"title\">android</span>:process=\":remote\" --&gt;</span></div><div class=\"line\">         &lt;service</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.PushService\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"false\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.REGISTER\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.REPORT\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.PushService\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.PUSH_TIME\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/service&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK 核心功能 since 1.8.0 --&gt;</span></div><div class=\"line\">         &lt;service</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.DaemonService\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter &gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.intent.DaemonService\"</span> /&gt;</div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;\"</span>/&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/service&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK核心功能--&gt;</span></div><div class=\"line\">         &lt;receiver</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.PushReceiver\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span></div><div class=\"line\">             android:exported=<span class=\"string\">\"false\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter android:priority=<span class=\"string\">\"1000\"</span>&gt;</div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.NOTIFICATION_RECEIVED_PROXY\" /&gt; &lt;!--Required 显示通知栏 --&gt;</span></div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.intent.action.USER_PRESENT\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.net.conn.CONNECTIVITY_CHANGE\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">             &lt;!-- O<span class=\"function\"><span class=\"title\">ptional</span> --&gt;</span></div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.intent.action.PACKAGE_ADDED\"</span> /&gt;</div><div class=\"line\">                 &lt;action android:<span class=\"keyword\">name</span>=<span class=\"string\">\"android.intent.action.PACKAGE_REMOVED\"</span> /&gt;</div><div class=\"line\">                 &lt;<span class=\"keyword\">data</span> android:scheme=<span class=\"string\">\"package\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/receiver&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> SDK核心功能--&gt;</span></div><div class=\"line\">         &lt;receiver android:<span class=\"keyword\">name</span>=<span class=\"string\">\"cn.jpush.android.service.AlarmReceiver\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- U<span class=\"function\"><span class=\"title\">ser</span> defined. 用户自定义的广播接收器--&gt;</span></div><div class=\"line\">         &lt;receiver</div><div class=\"line\">             android:<span class=\"keyword\">name</span>=<span class=\"string\">\"您自己定义的Receiver\"</span></div><div class=\"line\">             android:enabled=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\">             &lt;intent-filter&gt;</div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.REGISTRATION\" /&gt; &lt;!--Required 用户注册SDK的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.MESSAGE_RECEIVED\" /&gt; &lt;!--Required 用户接收SDK消息的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.NOTIFICATION_RECEIVED\" /&gt; &lt;!--Required 用户接收SDK通知栏信息的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.NOTIFICATION_OPENED\" /&gt; &lt;!--Required 用户打开自定义通知栏的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.ACTION_RICHPUSH_CALLBACK\" /&gt; &lt;!--Optional 用户接受Rich Push Javascript 回调函数的intent--&gt;</span></div><div class=\"line\">                 &lt;<span class=\"function\"><span class=\"title\">action</span> android:<span class=\"keyword\">name</span>=\"cn.jpush.android.intent.CONNECTION\" /&gt;&lt;!-- 接收网络变化 连接/断开 since 1.6.3 --&gt;</span></div><div class=\"line\">                 &lt;category android:<span class=\"keyword\">name</span>=<span class=\"string\">\"$&#123;applicationId&#125;\"</span> /&gt;</div><div class=\"line\">             &lt;/intent-filter&gt;</div><div class=\"line\">         &lt;/receiver&gt;</div><div class=\"line\"></div><div class=\"line\">         &lt;!-- R<span class=\"function\"><span class=\"title\">equired</span> . Enable it you can get statistics <span class=\"keyword\">data</span> <span class=\"keyword\">with</span> channel --&gt;</span></div><div class=\"line\">         &lt;meta-<span class=\"keyword\">data</span> android:<span class=\"keyword\">name</span>=<span class=\"string\">\"JPUSH_CHANNEL\"</span> android:value=<span class=\"string\">\"developer-default\"</span>/&gt;</div><div class=\"line\">         &lt;<span class=\"function\"><span class=\"title\">meta</span>-<span class=\"keyword\">data</span> android:<span class=\"keyword\">name</span>=\"JPUSH_APPKEY\" android:value=\"您应用applicationId对应的appKey\" /&gt; &lt;!-- &lt;/&gt;值来自开发者平台取得的AppKey--&gt;</span></div><div class=\"line\">     &lt;/application&gt;</div><div class=\"line\">&lt;/manifest&gt;</div></pre></td></tr></table></figure></p>\n<p>其中注意：</p>\n<ul>\n<li>标注<code>Required</code>为必须的</li>\n<li>包名</li>\n<li>AppKey</li>\n</ul>\n<h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><p>在Application中初始化JPush。<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExampleApplication</span> <span class=\"keyword\">extends</span> <span class=\"title\">Application</span> </span>&#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    public void onCreate() &#123;</div><div class=\"line\">      <span class=\"keyword\">super</span>.onCreate();</div><div class=\"line\">      <span class=\"type\">JPushInterface</span>.setDebugMode(<span class=\"literal\">true</span>);</div><div class=\"line\">      <span class=\"type\">JPushInterface</span>.init(<span class=\"keyword\">this</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>至此，JPush便已全部集成完毕。至于自定义通知布局，以及Notification的点击响应，后面再说了。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><ol>\n<li>我是小米的测试机，在接收推送消息的时候，必须要启动应用的时候才会收到推送的消息。后面才知道，是有些手机需要<code>允许应用自启动</code>。修改之后便可在没启动应用的时候也能收到推送消息了。<a href=\"http://docs.jpush.io/guideline/faq/#android\">点这里</a>传送常见问题。</li>\n</ol>\n<h2 id=\"所感\"><a href=\"#所感\" class=\"headerlink\" title=\"所感\"></a>所感</h2><p>作为一款比较大众的产品，肯定是不会有很多坑的（不然也没那么多人会用它了），在其官方文档的说明上，一般都会有相应的说明。在看文档的时候，一定要<code>仔细</code>，<code>仔细</code>，<code>仔细</code>，重要的事情说三遍~</p>"},{"title":"Android Studio发布项目到JCenter","date":"2016-09-12T08:40:48.000Z","_content":"\n在我的上一篇文章中，尝试将弧形seekbar抽成了一个三方库，这篇文章便以该库为例，将其上传至JCenter。\n\n<!-- more -->\n\n## 注册Binatry\n到[Binatry官网](https://bintray.com)注册账号。\n然后到``Your Profile``点击``Edit``，在下面会看到``API Key``，记录下这个Key备用。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter2.png)\n\n## 配置gradle\n我是使用的``gradle-bintray-plugin``插件来上传项目的，在项目的``build.gradle``下添加如下配置:\n```\napply plugin: 'com.android.library'\n\napply plugin: 'com.github.dcendents.android-maven'\napply plugin: 'com.jfrog.bintray'\n//提交到仓库中的版本号\nversion = \"1.0.0\"\n\nandroid {\n    compileSdkVersion 23\n    buildToolsVersion \"23.0.3\"\n\n    defaultConfig {\n        minSdkVersion 16\n        targetSdkVersion 23\n        versionCode 1\n        versionName \"1.0\"\n    }\n    buildTypes {\n        release {\n            minifyEnabled false\n            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n        }\n    }\n}\n\ndependencies {\n    compile fileTree(dir: 'libs', include: ['*.jar'])\n    testCompile 'junit:junit:4.12'\n    compile 'com.android.support:appcompat-v7:23.2.1'\n}\n\ndef siteUrl = 'https://github.com/LiJia92/CustomArcSeekBar'         // 项目的主页\ndef gitUrl = 'https://github.com/LiJia92/CustomArcSeekBar'          // Git仓库的url\ngroup = \"com.android.lovesixgod.customarcseekbar\"                   // Maven Group ID for the artifact，一般填你唯一的包名\ninstall {\n    repositories.mavenInstaller {\n        // This generates POM.xml with proper parameters\n        pom {\n            project {\n                packaging 'aar'\n                // Add your description here\n                name 'Custom arc seek bar' \t//项目描述\n                url siteUrl\n                // Set your license\n                licenses {\n                    license {\n                        name 'The Apache Software License, Version 2.0'\n                        url 'http://www.apache.org/licenses/LICENSE-2.0.txt'\n                    }\n                }\n                developers {\n                    developer {\n                        id 'lijia92'\t\t//填写的一些基本信息\n                        name 'lastwarmth'\n                        email '243244898@qq.com'\n                    }\n                }\n                scm {\n                    connection gitUrl\n                    developerConnection gitUrl\n                    url siteUrl\n                }\n            }\n        }\n    }\n}\ntask sourcesJar(type: Jar) {\n    from android.sourceSets.main.java.srcDirs\n    classifier = 'sources'\n}\ntask javadoc(type: Javadoc) {\n    source = android.sourceSets.main.java.srcDirs\n    classpath += project.files(android.getBootClasspath().join(File.pathSeparator))\n}\ntask javadocJar(type: Jar, dependsOn: javadoc) {\n    classifier = 'javadoc'\n    from javadoc.destinationDir\n}\nartifacts {\n    archives javadocJar\n    archives sourcesJar\n}\nProperties properties = new Properties()\nproperties.load(project.rootProject.file('local.properties').newDataInputStream())\nbintray {\n    user = properties.getProperty(\"bintray.user\")\n    key = properties.getProperty(\"bintray.apikey\")\n    configurations = ['archives']\n    pkg {\n        repo = \"maven\"\n        name = \"arcseekbar\"\t        //发布到JCenter上的项目名字\n        websiteUrl = siteUrl\n        vcsUrl = gitUrl\n        licenses = [\"Apache-2.0\"]\n        publish = true\n    }\n}\n\n// 解决GBK乱码\njavadoc {\n    options{\n        encoding \"UTF-8\"\n        charSet 'UTF-8'\n        author true\n        version true\n        links \"http://docs.oracle.com/javase/7/docs/api\"\n    }\n}\n```\n\n## 配置name&key\n在``local.propertis``里配置binatry的名称与api key：\n```\nbintray.user=username\nbintray.apikey=key\n```\nuser即是你注册的名称，key则是第一步中保存的值。\n\n## 上传\n首先Sync Gradle File，当build成功后，打开Terminal，执行指令：\n```\ngradlew install\n```\nbuild成功后在执行指令：\n```\ngradlew bintrayUpload\n```\n成功后便能在binatry上看到自己上传的项目了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter3.png)\n\n## 同步到JCenter\n点开自己的项目，有一个``Add to JCenter``，点击后填写描述即可提交申请给binatry了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter4.png)\n最后便是等待审核了，审核通过后会收到如下的消息：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter5.png)\n然后我们进入到项目详情页，会看到``Add to JCenter``按钮消失了，说明审核已经通过。\n点到Gradle便能看到gradle依赖的代码：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter6.png)\n迫不及待的在AS中试了一下，真的可以用了，成就感十足，哈哈。\n\n## 问题\n1. 看[Hongyang大神的博客](http://blog.csdn.net/lmj623565791/article/details/51148825)，打算使用``bintray-release``插件来进行上传的，但是出现了GBK中文编码乱码的问题，除了将代码中的中文全部换成英文之外，没找到其他好的方法，便放弃了这个方法，采用的``gradle-bintray-plugin``插件可通过配置javadoc的编码来解决这个问题。\n2. 包名非常不好看，以后得起个好点的包名。而且不能瞎用“com.android....”，这是google android团队的。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter7.png)\n3. 出现如下的错误：\n```\nExecution failed for task ':library:bintrayUpload'.\n> Could not create package 'lijia92/maven/CustomArcSeekBar': HTTP/1.1 404 Not Found [message:Repo 'maven' was not found]\n```\n说是maven不存在，于是我在binatry下创建了一个名为``maven``的仓库，然后重新上传便成功了。（非常坑，找了半天的原因，看的好多博客都没说这个，可能是他们账号下面本身就已经存在maven仓库了）\n","source":"_posts/jcenter.md","raw":"---\ntitle: Android Studio发布项目到JCenter\ndate: 2016-09-12 16:40:48\ntags:\n - android studio\n---\n\n在我的上一篇文章中，尝试将弧形seekbar抽成了一个三方库，这篇文章便以该库为例，将其上传至JCenter。\n\n<!-- more -->\n\n## 注册Binatry\n到[Binatry官网](https://bintray.com)注册账号。\n然后到``Your Profile``点击``Edit``，在下面会看到``API Key``，记录下这个Key备用。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter2.png)\n\n## 配置gradle\n我是使用的``gradle-bintray-plugin``插件来上传项目的，在项目的``build.gradle``下添加如下配置:\n```\napply plugin: 'com.android.library'\n\napply plugin: 'com.github.dcendents.android-maven'\napply plugin: 'com.jfrog.bintray'\n//提交到仓库中的版本号\nversion = \"1.0.0\"\n\nandroid {\n    compileSdkVersion 23\n    buildToolsVersion \"23.0.3\"\n\n    defaultConfig {\n        minSdkVersion 16\n        targetSdkVersion 23\n        versionCode 1\n        versionName \"1.0\"\n    }\n    buildTypes {\n        release {\n            minifyEnabled false\n            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'\n        }\n    }\n}\n\ndependencies {\n    compile fileTree(dir: 'libs', include: ['*.jar'])\n    testCompile 'junit:junit:4.12'\n    compile 'com.android.support:appcompat-v7:23.2.1'\n}\n\ndef siteUrl = 'https://github.com/LiJia92/CustomArcSeekBar'         // 项目的主页\ndef gitUrl = 'https://github.com/LiJia92/CustomArcSeekBar'          // Git仓库的url\ngroup = \"com.android.lovesixgod.customarcseekbar\"                   // Maven Group ID for the artifact，一般填你唯一的包名\ninstall {\n    repositories.mavenInstaller {\n        // This generates POM.xml with proper parameters\n        pom {\n            project {\n                packaging 'aar'\n                // Add your description here\n                name 'Custom arc seek bar' \t//项目描述\n                url siteUrl\n                // Set your license\n                licenses {\n                    license {\n                        name 'The Apache Software License, Version 2.0'\n                        url 'http://www.apache.org/licenses/LICENSE-2.0.txt'\n                    }\n                }\n                developers {\n                    developer {\n                        id 'lijia92'\t\t//填写的一些基本信息\n                        name 'lastwarmth'\n                        email '243244898@qq.com'\n                    }\n                }\n                scm {\n                    connection gitUrl\n                    developerConnection gitUrl\n                    url siteUrl\n                }\n            }\n        }\n    }\n}\ntask sourcesJar(type: Jar) {\n    from android.sourceSets.main.java.srcDirs\n    classifier = 'sources'\n}\ntask javadoc(type: Javadoc) {\n    source = android.sourceSets.main.java.srcDirs\n    classpath += project.files(android.getBootClasspath().join(File.pathSeparator))\n}\ntask javadocJar(type: Jar, dependsOn: javadoc) {\n    classifier = 'javadoc'\n    from javadoc.destinationDir\n}\nartifacts {\n    archives javadocJar\n    archives sourcesJar\n}\nProperties properties = new Properties()\nproperties.load(project.rootProject.file('local.properties').newDataInputStream())\nbintray {\n    user = properties.getProperty(\"bintray.user\")\n    key = properties.getProperty(\"bintray.apikey\")\n    configurations = ['archives']\n    pkg {\n        repo = \"maven\"\n        name = \"arcseekbar\"\t        //发布到JCenter上的项目名字\n        websiteUrl = siteUrl\n        vcsUrl = gitUrl\n        licenses = [\"Apache-2.0\"]\n        publish = true\n    }\n}\n\n// 解决GBK乱码\njavadoc {\n    options{\n        encoding \"UTF-8\"\n        charSet 'UTF-8'\n        author true\n        version true\n        links \"http://docs.oracle.com/javase/7/docs/api\"\n    }\n}\n```\n\n## 配置name&key\n在``local.propertis``里配置binatry的名称与api key：\n```\nbintray.user=username\nbintray.apikey=key\n```\nuser即是你注册的名称，key则是第一步中保存的值。\n\n## 上传\n首先Sync Gradle File，当build成功后，打开Terminal，执行指令：\n```\ngradlew install\n```\nbuild成功后在执行指令：\n```\ngradlew bintrayUpload\n```\n成功后便能在binatry上看到自己上传的项目了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter3.png)\n\n## 同步到JCenter\n点开自己的项目，有一个``Add to JCenter``，点击后填写描述即可提交申请给binatry了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter4.png)\n最后便是等待审核了，审核通过后会收到如下的消息：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter5.png)\n然后我们进入到项目详情页，会看到``Add to JCenter``按钮消失了，说明审核已经通过。\n点到Gradle便能看到gradle依赖的代码：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter6.png)\n迫不及待的在AS中试了一下，真的可以用了，成就感十足，哈哈。\n\n## 问题\n1. 看[Hongyang大神的博客](http://blog.csdn.net/lmj623565791/article/details/51148825)，打算使用``bintray-release``插件来进行上传的，但是出现了GBK中文编码乱码的问题，除了将代码中的中文全部换成英文之外，没找到其他好的方法，便放弃了这个方法，采用的``gradle-bintray-plugin``插件可通过配置javadoc的编码来解决这个问题。\n2. 包名非常不好看，以后得起个好点的包名。而且不能瞎用“com.android....”，这是google android团队的。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter7.png)\n3. 出现如下的错误：\n```\nExecution failed for task ':library:bintrayUpload'.\n> Could not create package 'lijia92/maven/CustomArcSeekBar': HTTP/1.1 404 Not Found [message:Repo 'maven' was not found]\n```\n说是maven不存在，于是我在binatry下创建了一个名为``maven``的仓库，然后重新上传便成功了。（非常坑，找了半天的原因，看的好多博客都没说这个，可能是他们账号下面本身就已经存在maven仓库了）\n","slug":"jcenter","published":1,"updated":"2016-11-21T10:01:26.097Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7597001k1cb8i3fyvsro","content":"<p>在我的上一篇文章中，尝试将弧形seekbar抽成了一个三方库，这篇文章便以该库为例，将其上传至JCenter。</p>\n<a id=\"more\"></a>\n<h2 id=\"注册Binatry\"><a href=\"#注册Binatry\" class=\"headerlink\" title=\"注册Binatry\"></a>注册Binatry</h2><p>到<a href=\"https://bintray.com\" target=\"_blank\" rel=\"external\">Binatry官网</a>注册账号。<br>然后到<code>Your Profile</code>点击<code>Edit</code>，在下面会看到<code>API Key</code>，记录下这个Key备用。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter2.png\" alt=\"\"></p>\n<h2 id=\"配置gradle\"><a href=\"#配置gradle\" class=\"headerlink\" title=\"配置gradle\"></a>配置gradle</h2><p>我是使用的<code>gradle-bintray-plugin</code>插件来上传项目的，在项目的<code>build.gradle</code>下添加如下配置:<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div></pre></td><td class=\"code\"><pre><div class=\"line\">apply plugin: <span class=\"string\">'com.android.library'</span></div><div class=\"line\"></div><div class=\"line\">apply plugin: <span class=\"string\">'com.github.dcendents.android-maven'</span></div><div class=\"line\">apply plugin: <span class=\"string\">'com.jfrog.bintray'</span></div><div class=\"line\"><span class=\"comment\">//提交到仓库中的版本号</span></div><div class=\"line\">version = <span class=\"string\">\"1.0.0\"</span></div><div class=\"line\"></div><div class=\"line\">android &#123;</div><div class=\"line\">    compileSdkVersion <span class=\"number\">23</span></div><div class=\"line\">    buildToolsVersion <span class=\"string\">\"23.0.3\"</span></div><div class=\"line\"></div><div class=\"line\">    defaultConfig &#123;</div><div class=\"line\">        minSdkVersion <span class=\"number\">16</span></div><div class=\"line\">        targetSdkVersion <span class=\"number\">23</span></div><div class=\"line\">        versionCode <span class=\"number\">1</span></div><div class=\"line\">        versionName <span class=\"string\">\"1.0\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">    buildTypes &#123;</div><div class=\"line\">        release &#123;</div><div class=\"line\">            minifyEnabled <span class=\"keyword\">false</span></div><div class=\"line\">            proguardFiles getDefaultProguardFile(<span class=\"string\">'proguard-android.txt'</span>), <span class=\"string\">'proguard-rules.pro'</span></div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">dependencies</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">compile</span> <span class=\"keyword\">fileTree</span>(dir: <span class=\"string\">'libs'</span>, <span class=\"keyword\">include</span>: [<span class=\"string\">'*.jar'</span>])</div><div class=\"line\">    testCompile <span class=\"string\">'junit:junit:4.12'</span></div><div class=\"line\">    <span class=\"keyword\">compile</span> <span class=\"string\">'com.android.support:appcompat-v7:23.2.1'</span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">def</span> siteUrl = <span class=\"string\">'https://github.com/LiJia92/CustomArcSeekBar'</span>         <span class=\"comment\">// 项目的主页</span></div><div class=\"line\"><span class=\"keyword\">def</span> gitUrl = <span class=\"string\">'https://github.com/LiJia92/CustomArcSeekBar'</span>          <span class=\"comment\">// Git仓库的url</span></div><div class=\"line\"><span class=\"keyword\">group</span> = <span class=\"string\">\"com.android.lovesixgod.customarcseekbar\"</span>                   <span class=\"comment\">// Maven Group ID for the artifact，一般填你唯一的包名</span></div><div class=\"line\">install &#123;</div><div class=\"line\">    <span class=\"keyword\">repositories</span>.mavenInstaller &#123;</div><div class=\"line\">        <span class=\"comment\">// This generates POM.xml with proper parameters</span></div><div class=\"line\">        pom &#123;</div><div class=\"line\">            <span class=\"keyword\">project</span> &#123;</div><div class=\"line\">                packaging <span class=\"string\">'aar'</span></div><div class=\"line\">                <span class=\"comment\">// Add your description here</span></div><div class=\"line\">                name <span class=\"string\">'Custom arc seek bar'</span> \t<span class=\"comment\">//项目描述</span></div><div class=\"line\">                url siteUrl</div><div class=\"line\">                <span class=\"comment\">// Set your license</span></div><div class=\"line\">                licenses &#123;</div><div class=\"line\">                    license &#123;</div><div class=\"line\">                        name <span class=\"string\">'The Apache Software License, Version 2.0'</span></div><div class=\"line\">                        url <span class=\"string\">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span></div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                developers &#123;</div><div class=\"line\">                    developer &#123;</div><div class=\"line\">                        id <span class=\"string\">'lijia92'</span>\t\t<span class=\"comment\">//填写的一些基本信息</span></div><div class=\"line\">                        name <span class=\"string\">'lastwarmth'</span></div><div class=\"line\">                        email <span class=\"string\">'243244898@qq.com'</span></div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                scm &#123;</div><div class=\"line\">                    connection gitUrl</div><div class=\"line\">                    developerConnection gitUrl</div><div class=\"line\">                    url siteUrl</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">task</span> sourcesJar(type: Jar) &#123;</div><div class=\"line\">    <span class=\"keyword\">from</span> android.<span class=\"keyword\">sourceSets</span>.main.java.srcDirs</div><div class=\"line\">    classifier = <span class=\"string\">'sources'</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">task</span> javadoc(type: Javadoc) &#123;</div><div class=\"line\">    <span class=\"keyword\">source</span> = android.<span class=\"keyword\">sourceSets</span>.main.java.srcDirs</div><div class=\"line\">    <span class=\"keyword\">classpath</span> += <span class=\"keyword\">project</span>.files(android.getBootClasspath().<span class=\"keyword\">join</span>(<span class=\"keyword\">File</span>.pathSeparator))</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">task</span> javadocJar(type: Jar, dependsOn: javadoc) &#123;</div><div class=\"line\">    classifier = <span class=\"string\">'javadoc'</span></div><div class=\"line\">    <span class=\"keyword\">from</span> javadoc.<span class=\"keyword\">destinationDir</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">artifacts</span> &#123;</div><div class=\"line\">    archives javadocJar</div><div class=\"line\">    archives sourcesJar</div><div class=\"line\">&#125;</div><div class=\"line\">Properties properties = <span class=\"keyword\">new</span> Properties()</div><div class=\"line\">properties.load(<span class=\"keyword\">project</span>.rootProject.<span class=\"keyword\">file</span>(<span class=\"string\">'local.properties'</span>).newDataInputStream())</div><div class=\"line\">bintray &#123;</div><div class=\"line\">    user = properties.getProperty(<span class=\"string\">\"bintray.user\"</span>)</div><div class=\"line\">    key = properties.getProperty(<span class=\"string\">\"bintray.apikey\"</span>)</div><div class=\"line\">    <span class=\"keyword\">configurations</span> = [<span class=\"string\">'archives'</span>]</div><div class=\"line\">    pkg &#123;</div><div class=\"line\">        repo = <span class=\"string\">\"maven\"</span></div><div class=\"line\">        name = <span class=\"string\">\"arcseekbar\"</span>\t        <span class=\"comment\">//发布到JCenter上的项目名字</span></div><div class=\"line\">        websiteUrl = siteUrl</div><div class=\"line\">        vcsUrl = gitUrl</div><div class=\"line\">        licenses = [<span class=\"string\">\"Apache-2.0\"</span>]</div><div class=\"line\">        publish = <span class=\"keyword\">true</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 解决GBK乱码</span></div><div class=\"line\">javadoc &#123;</div><div class=\"line\">    <span class=\"keyword\">options</span>&#123;</div><div class=\"line\">        encoding <span class=\"string\">\"UTF-8\"</span></div><div class=\"line\">        charSet <span class=\"string\">'UTF-8'</span></div><div class=\"line\">        author <span class=\"keyword\">true</span></div><div class=\"line\">        version <span class=\"keyword\">true</span></div><div class=\"line\">        links <span class=\"string\">\"http://docs.oracle.com/javase/7/docs/api\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置name-amp-key\"><a href=\"#配置name-amp-key\" class=\"headerlink\" title=\"配置name&amp;key\"></a>配置name&amp;key</h2><p>在<code>local.propertis</code>里配置binatry的名称与api key：<br><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">bintray.<span class=\"attr\">user=username</span></div><div class=\"line\">bintray.<span class=\"attr\">apikey=key</span></div></pre></td></tr></table></figure></p>\n<p>user即是你注册的名称，key则是第一步中保存的值。</p>\n<h2 id=\"上传\"><a href=\"#上传\" class=\"headerlink\" title=\"上传\"></a>上传</h2><p>首先Sync Gradle File，当build成功后，打开Terminal，执行指令：<br><figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">gradlew <span class=\"keyword\">install</span></div></pre></td></tr></table></figure></p>\n<p>build成功后在执行指令：<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">gradlew bintrayUpload</span></div></pre></td></tr></table></figure></p>\n<p>成功后便能在binatry上看到自己上传的项目了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter3.png\" alt=\"\"></p>\n<h2 id=\"同步到JCenter\"><a href=\"#同步到JCenter\" class=\"headerlink\" title=\"同步到JCenter\"></a>同步到JCenter</h2><p>点开自己的项目，有一个<code>Add to JCenter</code>，点击后填写描述即可提交申请给binatry了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter4.png\" alt=\"\"><br>最后便是等待审核了，审核通过后会收到如下的消息：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter5.png\" alt=\"\"><br>然后我们进入到项目详情页，会看到<code>Add to JCenter</code>按钮消失了，说明审核已经通过。<br>点到Gradle便能看到gradle依赖的代码：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter6.png\" alt=\"\"><br>迫不及待的在AS中试了一下，真的可以用了，成就感十足，哈哈。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><ol>\n<li>看<a href=\"http://blog.csdn.net/lmj623565791/article/details/51148825\" target=\"_blank\" rel=\"external\">Hongyang大神的博客</a>，打算使用<code>bintray-release</code>插件来进行上传的，但是出现了GBK中文编码乱码的问题，除了将代码中的中文全部换成英文之外，没找到其他好的方法，便放弃了这个方法，采用的<code>gradle-bintray-plugin</code>插件可通过配置javadoc的编码来解决这个问题。</li>\n<li>包名非常不好看，以后得起个好点的包名。而且不能瞎用“com.android….”，这是google android团队的。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter7.png\" alt=\"\"></li>\n<li>出现如下的错误：<figure class=\"highlight delphi\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Execution failed <span class=\"keyword\">for</span> task <span class=\"string\">':library:bintrayUpload'</span>.</div><div class=\"line\">&gt; Could <span class=\"keyword\">not</span> create package <span class=\"string\">'lijia92/maven/CustomArcSeekBar'</span>: HTTP/<span class=\"number\">1.1</span> <span class=\"number\">404</span> <span class=\"keyword\">Not</span> Found [<span class=\"keyword\">message</span>:Repo <span class=\"string\">'maven'</span> was <span class=\"keyword\">not</span> found]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>说是maven不存在，于是我在binatry下创建了一个名为<code>maven</code>的仓库，然后重新上传便成功了。（非常坑，找了半天的原因，看的好多博客都没说这个，可能是他们账号下面本身就已经存在maven仓库了）</p>\n","excerpt":"<p>在我的上一篇文章中，尝试将弧形seekbar抽成了一个三方库，这篇文章便以该库为例，将其上传至JCenter。</p>","more":"<h2 id=\"注册Binatry\"><a href=\"#注册Binatry\" class=\"headerlink\" title=\"注册Binatry\"></a>注册Binatry</h2><p>到<a href=\"https://bintray.com\">Binatry官网</a>注册账号。<br>然后到<code>Your Profile</code>点击<code>Edit</code>，在下面会看到<code>API Key</code>，记录下这个Key备用。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter2.png\" alt=\"\"></p>\n<h2 id=\"配置gradle\"><a href=\"#配置gradle\" class=\"headerlink\" title=\"配置gradle\"></a>配置gradle</h2><p>我是使用的<code>gradle-bintray-plugin</code>插件来上传项目的，在项目的<code>build.gradle</code>下添加如下配置:<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div></pre></td><td class=\"code\"><pre><div class=\"line\">apply plugin: <span class=\"string\">'com.android.library'</span></div><div class=\"line\"></div><div class=\"line\">apply plugin: <span class=\"string\">'com.github.dcendents.android-maven'</span></div><div class=\"line\">apply plugin: <span class=\"string\">'com.jfrog.bintray'</span></div><div class=\"line\"><span class=\"comment\">//提交到仓库中的版本号</span></div><div class=\"line\">version = <span class=\"string\">\"1.0.0\"</span></div><div class=\"line\"></div><div class=\"line\">android &#123;</div><div class=\"line\">    compileSdkVersion <span class=\"number\">23</span></div><div class=\"line\">    buildToolsVersion <span class=\"string\">\"23.0.3\"</span></div><div class=\"line\"></div><div class=\"line\">    defaultConfig &#123;</div><div class=\"line\">        minSdkVersion <span class=\"number\">16</span></div><div class=\"line\">        targetSdkVersion <span class=\"number\">23</span></div><div class=\"line\">        versionCode <span class=\"number\">1</span></div><div class=\"line\">        versionName <span class=\"string\">\"1.0\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">    buildTypes &#123;</div><div class=\"line\">        release &#123;</div><div class=\"line\">            minifyEnabled <span class=\"keyword\">false</span></div><div class=\"line\">            proguardFiles getDefaultProguardFile(<span class=\"string\">'proguard-android.txt'</span>), <span class=\"string\">'proguard-rules.pro'</span></div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">dependencies</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">compile</span> <span class=\"keyword\">fileTree</span>(dir: <span class=\"string\">'libs'</span>, <span class=\"keyword\">include</span>: [<span class=\"string\">'*.jar'</span>])</div><div class=\"line\">    testCompile <span class=\"string\">'junit:junit:4.12'</span></div><div class=\"line\">    <span class=\"keyword\">compile</span> <span class=\"string\">'com.android.support:appcompat-v7:23.2.1'</span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">def</span> siteUrl = <span class=\"string\">'https://github.com/LiJia92/CustomArcSeekBar'</span>         <span class=\"comment\">// 项目的主页</span></div><div class=\"line\"><span class=\"keyword\">def</span> gitUrl = <span class=\"string\">'https://github.com/LiJia92/CustomArcSeekBar'</span>          <span class=\"comment\">// Git仓库的url</span></div><div class=\"line\"><span class=\"keyword\">group</span> = <span class=\"string\">\"com.android.lovesixgod.customarcseekbar\"</span>                   <span class=\"comment\">// Maven Group ID for the artifact，一般填你唯一的包名</span></div><div class=\"line\">install &#123;</div><div class=\"line\">    <span class=\"keyword\">repositories</span>.mavenInstaller &#123;</div><div class=\"line\">        <span class=\"comment\">// This generates POM.xml with proper parameters</span></div><div class=\"line\">        pom &#123;</div><div class=\"line\">            <span class=\"keyword\">project</span> &#123;</div><div class=\"line\">                packaging <span class=\"string\">'aar'</span></div><div class=\"line\">                <span class=\"comment\">// Add your description here</span></div><div class=\"line\">                name <span class=\"string\">'Custom arc seek bar'</span> \t<span class=\"comment\">//项目描述</span></div><div class=\"line\">                url siteUrl</div><div class=\"line\">                <span class=\"comment\">// Set your license</span></div><div class=\"line\">                licenses &#123;</div><div class=\"line\">                    license &#123;</div><div class=\"line\">                        name <span class=\"string\">'The Apache Software License, Version 2.0'</span></div><div class=\"line\">                        url <span class=\"string\">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span></div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                developers &#123;</div><div class=\"line\">                    developer &#123;</div><div class=\"line\">                        id <span class=\"string\">'lijia92'</span>\t\t<span class=\"comment\">//填写的一些基本信息</span></div><div class=\"line\">                        name <span class=\"string\">'lastwarmth'</span></div><div class=\"line\">                        email <span class=\"string\">'243244898@qq.com'</span></div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                scm &#123;</div><div class=\"line\">                    connection gitUrl</div><div class=\"line\">                    developerConnection gitUrl</div><div class=\"line\">                    url siteUrl</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">task</span> sourcesJar(type: Jar) &#123;</div><div class=\"line\">    <span class=\"keyword\">from</span> android.<span class=\"keyword\">sourceSets</span>.main.java.srcDirs</div><div class=\"line\">    classifier = <span class=\"string\">'sources'</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">task</span> javadoc(type: Javadoc) &#123;</div><div class=\"line\">    <span class=\"keyword\">source</span> = android.<span class=\"keyword\">sourceSets</span>.main.java.srcDirs</div><div class=\"line\">    <span class=\"keyword\">classpath</span> += <span class=\"keyword\">project</span>.files(android.getBootClasspath().<span class=\"keyword\">join</span>(<span class=\"keyword\">File</span>.pathSeparator))</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">task</span> javadocJar(type: Jar, dependsOn: javadoc) &#123;</div><div class=\"line\">    classifier = <span class=\"string\">'javadoc'</span></div><div class=\"line\">    <span class=\"keyword\">from</span> javadoc.<span class=\"keyword\">destinationDir</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">artifacts</span> &#123;</div><div class=\"line\">    archives javadocJar</div><div class=\"line\">    archives sourcesJar</div><div class=\"line\">&#125;</div><div class=\"line\">Properties properties = <span class=\"keyword\">new</span> Properties()</div><div class=\"line\">properties.load(<span class=\"keyword\">project</span>.rootProject.<span class=\"keyword\">file</span>(<span class=\"string\">'local.properties'</span>).newDataInputStream())</div><div class=\"line\">bintray &#123;</div><div class=\"line\">    user = properties.getProperty(<span class=\"string\">\"bintray.user\"</span>)</div><div class=\"line\">    key = properties.getProperty(<span class=\"string\">\"bintray.apikey\"</span>)</div><div class=\"line\">    <span class=\"keyword\">configurations</span> = [<span class=\"string\">'archives'</span>]</div><div class=\"line\">    pkg &#123;</div><div class=\"line\">        repo = <span class=\"string\">\"maven\"</span></div><div class=\"line\">        name = <span class=\"string\">\"arcseekbar\"</span>\t        <span class=\"comment\">//发布到JCenter上的项目名字</span></div><div class=\"line\">        websiteUrl = siteUrl</div><div class=\"line\">        vcsUrl = gitUrl</div><div class=\"line\">        licenses = [<span class=\"string\">\"Apache-2.0\"</span>]</div><div class=\"line\">        publish = <span class=\"keyword\">true</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 解决GBK乱码</span></div><div class=\"line\">javadoc &#123;</div><div class=\"line\">    <span class=\"keyword\">options</span>&#123;</div><div class=\"line\">        encoding <span class=\"string\">\"UTF-8\"</span></div><div class=\"line\">        charSet <span class=\"string\">'UTF-8'</span></div><div class=\"line\">        author <span class=\"keyword\">true</span></div><div class=\"line\">        version <span class=\"keyword\">true</span></div><div class=\"line\">        links <span class=\"string\">\"http://docs.oracle.com/javase/7/docs/api\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置name-amp-key\"><a href=\"#配置name-amp-key\" class=\"headerlink\" title=\"配置name&amp;key\"></a>配置name&amp;key</h2><p>在<code>local.propertis</code>里配置binatry的名称与api key：<br><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">bintray.<span class=\"attr\">user=username</span></div><div class=\"line\">bintray.<span class=\"attr\">apikey=key</span></div></pre></td></tr></table></figure></p>\n<p>user即是你注册的名称，key则是第一步中保存的值。</p>\n<h2 id=\"上传\"><a href=\"#上传\" class=\"headerlink\" title=\"上传\"></a>上传</h2><p>首先Sync Gradle File，当build成功后，打开Terminal，执行指令：<br><figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">gradlew <span class=\"keyword\">install</span></div></pre></td></tr></table></figure></p>\n<p>build成功后在执行指令：<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">gradlew bintrayUpload</span></div></pre></td></tr></table></figure></p>\n<p>成功后便能在binatry上看到自己上传的项目了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter3.png\" alt=\"\"></p>\n<h2 id=\"同步到JCenter\"><a href=\"#同步到JCenter\" class=\"headerlink\" title=\"同步到JCenter\"></a>同步到JCenter</h2><p>点开自己的项目，有一个<code>Add to JCenter</code>，点击后填写描述即可提交申请给binatry了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter4.png\" alt=\"\"><br>最后便是等待审核了，审核通过后会收到如下的消息：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter5.png\" alt=\"\"><br>然后我们进入到项目详情页，会看到<code>Add to JCenter</code>按钮消失了，说明审核已经通过。<br>点到Gradle便能看到gradle依赖的代码：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter6.png\" alt=\"\"><br>迫不及待的在AS中试了一下，真的可以用了，成就感十足，哈哈。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><ol>\n<li>看<a href=\"http://blog.csdn.net/lmj623565791/article/details/51148825\">Hongyang大神的博客</a>，打算使用<code>bintray-release</code>插件来进行上传的，但是出现了GBK中文编码乱码的问题，除了将代码中的中文全部换成英文之外，没找到其他好的方法，便放弃了这个方法，采用的<code>gradle-bintray-plugin</code>插件可通过配置javadoc的编码来解决这个问题。</li>\n<li>包名非常不好看，以后得起个好点的包名。而且不能瞎用“com.android….”，这是google android团队的。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/jcenter7.png\" alt=\"\"></li>\n<li>出现如下的错误：<figure class=\"highlight delphi\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Execution failed <span class=\"keyword\">for</span> task <span class=\"string\">':library:bintrayUpload'</span>.</div><div class=\"line\">&gt; Could <span class=\"keyword\">not</span> create package <span class=\"string\">'lijia92/maven/CustomArcSeekBar'</span>: HTTP/<span class=\"number\">1.1</span> <span class=\"number\">404</span> <span class=\"keyword\">Not</span> Found [<span class=\"keyword\">message</span>:Repo <span class=\"string\">'maven'</span> was <span class=\"keyword\">not</span> found]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>说是maven不存在，于是我在binatry下创建了一个名为<code>maven</code>的仓库，然后重新上传便成功了。（非常坑，找了半天的原因，看的好多博客都没说这个，可能是他们账号下面本身就已经存在maven仓库了）</p>"},{"title":"【Android音视频开发】- 实时采集视频","date":"2016-10-20T02:24:19.000Z","_content":"\n## 前言\n通过我的上一篇文章，可以知道直播大致有几个步骤：音视频采集 -> 美颜/滤镜/特效处理 -> 编码 -> 封包 -> 推流 -> 分发 -> 解码/渲染/播放。那么首先便从采集开始，这里我先做的视频采集。\n那么实时采集视频有哪些方案呢？\n\n## 调研\n通过各种调研，查阅文章，了解到目前Android实时采集视频大致有3种方式：\n1. 通过Android Camera拍摄预览中设置setPreviewCallback实现onPreviewFrame接口，实时截取每一帧视频流数据\n2. 通过通过Android的MediaRecorder，在SetoutputFile函数中绑定LocalSocket实现\n3. 流媒体服务器方式，利用ffmpeg或GetStreamer等获取Camera视频\n\n通过学习，大致了解了1，2两种方式的实现方式，但是对于第3种方式，暂时没有研究。\n\n<!-- more -->\n\n## spydroid\n当我们在接触一个全新领域的时候，最希望的是能实实在在看到一个demo产品，通过demo产品我们更容易理解其内在的原理。在网上看到了许多的开源项目，最后选择了[spydroid](https://github.com/fyhertz/spydroid-ipcamera)，感觉它跟Android结合更紧密。更多的信息可以参考[Android视频采集方案总结](http://www.smarting.me/android-video-caputure.html)。\n\n### 拷贝工程\n通过github看到的项目是Eclipse结构，这里我把代码拷贝下来后，通过AS打开，配置一些信息后项目结构如下：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video1.png)\n\n[streaming](https://github.com/fyhertz/libstreaming)是作者封装的一套库。\n> A solution for streaming H.264, H.263, AMR, AAC using RTP on Android\n\n### 运行\n项目拷贝到AS后，有部分错误，修复后成功运行在MI 4LTE。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video2.png)\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video3.png)\n它可以通过http，也可以通过rtsp进行推流，打开rtsp推流的开关，首页会多了一个VLC的地址。\n我在Win 10上使用Chrome接收失败，打开网站后Connect一直连不上。所以采取的VLC方式。\n打开VLC输入首页提示的地址，即可看到推流成功了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video4.png)\ndemo跑通后，便有了一个直观的感受，接下来便是看代码了。\n\n### 代码\n从``SpydroidActivity``开始，会看到它连接了一个Service：\n```\nprivate ServiceConnection mRtspServiceConnection = new ServiceConnection() {\n\n\t@Override\n\tpublic void onServiceConnected(ComponentName name, IBinder service) {\n\t\tmRtspServer = (CustomRtspServer) ((RtspServer.LocalBinder)service).getService();\n\t\tmRtspServer.addCallbackListener(mRtspCallbackListener);\n\t\tmRtspServer.start();\n\t}\n\n\t@Override\n\tpublic void onServiceDisconnected(ComponentName name) {}\n\n};\n```\n看到``RtspServer``中的start方法：\n```\npublic void start() {\n\tif (!mEnabled || mRestart) stop();\n\tif (mEnabled && mListenerThread == null) {\n\t\ttry {\n\t\t\tmListenerThread = new RequestListener();\n\t\t} catch (Exception e) {\n\t\t\tmListenerThread = null;\n\t\t}\n\t}\n\tmRestart = false;\n}\n```\n再看到``RequestListener``：\n```\nclass RequestListener extends Thread implements Runnable {\n\n\tprivate final ServerSocket mServer;\n\n\tpublic RequestListener() throws IOException {\n\t\ttry {\n\t\t\tmServer = new ServerSocket(mPort);\n\t\t\tstart();\n\t\t} catch (BindException e) {\n\t\t\tLog.e(TAG,\"Port already in use !\");\n\t\t\tpostError(e, ERROR_BIND_FAILED);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tpublic void run() {\n\t\tLog.i(TAG,\"RTSP server listening on port \"+mServer.getLocalPort());\n\t\twhile (!Thread.interrupted()) {\n\t\t\ttry {\n\t\t\t\tnew WorkerThread(mServer.accept()).start();\n\t\t\t} catch (SocketException e) {\n\t\t\t\tbreak;\n\t\t\t} catch (IOException e) {\n\t\t\t\tLog.e(TAG,e.getMessage());\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\t\tLog.i(TAG,\"RTSP server stopped !\");\n\t}\n\n\tpublic void kill() {\n\t\ttry {\n\t\t\tmServer.close();\n\t\t} catch (IOException e) {}\n\t\ttry {\n\t\t\tthis.join();\n\t\t} catch (InterruptedException ignore) {}\n\t}\n\n}\n```\n这是一个进程类，在构造方法中直接调用了Thread.start()，那么便会执行到run()方法。可以看到，初始化了一个ServerSocket，然后当有客户端连接后（通过VLC输入地址开始播放即是连接到这个ServerSocket），便会执行``WorkerThread``线程：\n```\nclass WorkerThread extends Thread implements Runnable {\n\n\tprivate final Socket mClient;\n\tprivate final OutputStream mOutput;\n\tprivate final BufferedReader mInput;\n\n\t// Each client has an associated session\n\tprivate Session mSession;\n\n\tpublic WorkerThread(final Socket client) throws IOException {\n\t\tmInput = new BufferedReader(new InputStreamReader(client.getInputStream()));\n\t\tmOutput = client.getOutputStream();\n\t\tmClient = client;\n\t\tmSession = new Session();\n\t}\n\n\tpublic void run() {\n\t\tRequest request;\n\t\tResponse response;\n\n\t\tLog.i(TAG, \"Connection from \"+mClient.getInetAddress().getHostAddress());\n\n\t\twhile (!Thread.interrupted()) {\n\n\t\t\trequest = null;\n\t\t\tresponse = null;\n\n\t\t\t// Parse the request\n\t\t\ttry {\n\t\t\t\trequest = Request.parseRequest(mInput);\n\t\t\t} catch (SocketException e) {\n\t\t\t\t// Client has left\n\t\t\t\tbreak;\n\t\t\t} catch (Exception e) {\n\t\t\t\t// We don't understand the request :/\n\t\t\t\tresponse = new Response();\n\t\t\t\tresponse.status = Response.STATUS_BAD_REQUEST;\n\t\t\t}\n\n\t\t\t// Do something accordingly like starting the streams, sending a session description\n\t\t\tif (request != null) {\n\t\t\t\ttry {\n\t\t\t\t\tresponse = processRequest(request);\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\t// This alerts the main thread that something has gone wrong in this thread\n\t\t\t\t\tpostError(e, ERROR_START_FAILED);\n\t\t\t\t\tLog.e(TAG,e.getMessage()!=null?e.getMessage():\"An error occurred\");\n\t\t\t\t\te.printStackTrace();\n\t\t\t\t\tresponse = new Response(request);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// We always send a response\n\t\t\t// The client will receive an \"INTERNAL SERVER ERROR\" if an exception has been thrown at some point\n\t\t\ttry {\n\t\t\t\tresponse.send(mOutput);\n\t\t\t} catch (IOException e) {\n\t\t\t\tLog.e(TAG,\"Response was not sent properly\");\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t}\n\n\t\t// Streaming stops when client disconnects\n\t\tboolean streaming = isStreaming();\n\t\tmSession.syncStop();\n\t\tif (streaming && !isStreaming()) {\n\t\t\tpostMessage(MESSAGE_STREAMING_STOPPED);\n\t\t}\n\t\tmSession.release();\n\n\t\ttry {\n\t\t\tmClient.close();\n\t\t} catch (IOException ignore) {}\n\n\t\tLog.i(TAG, \"Client disconnected\");\n\n\t}\n\n\tpublic Response processRequest(Request request) throws IllegalStateException, IOException {\n\t\tResponse response = new Response(request);\n\n        //Ask for authorization unless this is an OPTIONS request\n        if(!isAuthorized(request) && !request.method.equalsIgnoreCase(\"OPTIONS\"))\n        {\n            response.attributes = \"WWW-Authenticate: Basic realm=\\\"\"+SERVER_NAME+\"\\\"\\r\\n\";\n            response.status = Response.STATUS_UNAUTHORIZED;\n        }\n        else\n        {\n\t\t    /* ********************************************************************************** */\n\t\t    /* ********************************* Method DESCRIBE ******************************** */\n\t\t    /* ********************************************************************************** */\n            if (request.method.equalsIgnoreCase(\"DESCRIBE\")) {\n\n                // Parse the requested URI and configure the session\n                mSession = handleRequest(request.uri, mClient);\n                mSessions.put(mSession, null);\n                mSession.syncConfigure();\n\n                String requestContent = mSession.getSessionDescription();\n                String requestAttributes =\n                        \"Content-Base: \" + mClient.getLocalAddress().getHostAddress() + \":\" + mClient.getLocalPort() + \"/\\r\\n\" +\n                                \"Content-Type: application/sdp\\r\\n\";\n\n                response.attributes = requestAttributes;\n                response.content = requestContent;\n\n                // If no exception has been thrown, we reply with OK\n                response.status = Response.STATUS_OK;\n\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************* Method OPTIONS ********************************* */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"OPTIONS\")) {\n                response.status = Response.STATUS_OK;\n                response.attributes = \"Public: DESCRIBE,SETUP,TEARDOWN,PLAY,PAUSE\\r\\n\";\n                response.status = Response.STATUS_OK;\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************** Method SETUP ********************************** */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"SETUP\")) {\n                Pattern p;\n                Matcher m;\n                int p2, p1, ssrc, trackId, src[];\n                String destination;\n\n                p = Pattern.compile(\"trackID=(\\\\w+)\", Pattern.CASE_INSENSITIVE);\n                m = p.matcher(request.uri);\n\n                if (!m.find()) {\n                    response.status = Response.STATUS_BAD_REQUEST;\n                    return response;\n                }\n\n                trackId = Integer.parseInt(m.group(1));\n\n                if (!mSession.trackExists(trackId)) {\n                    response.status = Response.STATUS_NOT_FOUND;\n                    return response;\n                }\n\n                p = Pattern.compile(\"client_port=(\\\\d+)-(\\\\d+)\", Pattern.CASE_INSENSITIVE);\n                m = p.matcher(request.headers.get(\"transport\"));\n\n                if (!m.find()) {\n                    int[] ports = mSession.getTrack(trackId).getDestinationPorts();\n                    p1 = ports[0];\n                    p2 = ports[1];\n                } else {\n                    p1 = Integer.parseInt(m.group(1));\n                    p2 = Integer.parseInt(m.group(2));\n                }\n\n                ssrc = mSession.getTrack(trackId).getSSRC();\n                src = mSession.getTrack(trackId).getLocalPorts();\n                destination = mSession.getDestination();\n\n                mSession.getTrack(trackId).setDestinationPorts(p1, p2);\n\n                boolean streaming = isStreaming();\n                mSession.syncStart(trackId);\n                if (!streaming && isStreaming()) {\n                    postMessage(MESSAGE_STREAMING_STARTED);\n                }\n\n                response.attributes = \"Transport: RTP/AVP/UDP;\" + (InetAddress.getByName(destination).isMulticastAddress() ? \"multicast\" : \"unicast\") +\n                        \";destination=\" + mSession.getDestination() +\n                        \";client_port=\" + p1 + \"-\" + p2 +\n                        \";server_port=\" + src[0] + \"-\" + src[1] +\n                        \";ssrc=\" + Integer.toHexString(ssrc) +\n                        \";mode=play\\r\\n\" +\n                        \"Session: \" + \"1185d20035702ca\" + \"\\r\\n\" +\n                        \"Cache-Control: no-cache\\r\\n\";\n                response.status = Response.STATUS_OK;\n\n                // If no exception has been thrown, we reply with OK\n                response.status = Response.STATUS_OK;\n\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************** Method PLAY *********************************** */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"PLAY\")) {\n                String requestAttributes = \"RTP-Info: \";\n                if (mSession.trackExists(0))\n                    requestAttributes += \"url=rtsp://\" + mClient.getLocalAddress().getHostAddress() + \":\" + mClient.getLocalPort() + \"/trackID=\" + 0 + \";seq=0,\";\n                if (mSession.trackExists(1))\n                    requestAttributes += \"url=rtsp://\" + mClient.getLocalAddress().getHostAddress() + \":\" + mClient.getLocalPort() + \"/trackID=\" + 1 + \";seq=0,\";\n                requestAttributes = requestAttributes.substring(0, requestAttributes.length() - 1) + \"\\r\\nSession: 1185d20035702ca\\r\\n\";\n\n                response.attributes = requestAttributes;\n\n                // If no exception has been thrown, we reply with OK\n                response.status = Response.STATUS_OK;\n\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************** Method PAUSE ********************************** */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"PAUSE\")) {\n                response.status = Response.STATUS_OK;\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************* Method TEARDOWN ******************************** */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"TEARDOWN\")) {\n                response.status = Response.STATUS_OK;\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************* Unknown method ? ******************************* */\n            /* ********************************************************************************** */\n            else {\n                Log.e(TAG, \"Command unknown: \" + request);\n                response.status = Response.STATUS_BAD_REQUEST;\n            }\n        }\n\t\treturn response;\n\n\t}\n\n    /**\n     * Check if the request is authorized\n     * @param request\n     * @return true or false\n     */\n    private boolean isAuthorized(Request request)\n    {\n        String auth = request.headers.get(\"authorization\");\n        if(mUsername == null || mPassword == null || mUsername.isEmpty())\n            return true;\n\n        if(auth != null && !auth.isEmpty())\n        {\n            String received = auth.substring(auth.lastIndexOf(\" \")+1);\n            String local = mUsername+\":\"+mPassword;\n            String localEncoded = Base64.encodeToString(local.getBytes(),Base64.NO_WRAP);\n            if(localEncoded.equals(received))\n                return true;\n        }\n\n        return false;\n    }\n}\n```\n这个类比较长，但是我只需关注``采集``。看到``processRequest方法``，当有Client连接后，便会有session了，然后打印一些配置之类的信息，最后看到``mSession.syncStart(trackId)``，可以猜测这个方法便是开始采集、推流了。\n```\n/**\n * Starts a stream in a synchronous manner. <br />\n * Throws exceptions in addition to calling a callback.\n * @param id The id of the stream to start\n **/\npublic void syncStart(int id) \t\t\t\n\t\tthrows CameraInUseException,\n\t\tStorageUnavailableException,\n\t\tConfNotSupportedException,\n\t\tInvalidSurfaceException,\n\t\tUnknownHostException,\n\t\tIOException {\n\n\tStream stream = id==0 ? mAudioStream : mVideoStream;\n\tif (stream!=null && !stream.isStreaming()) {\n\t\ttry {\n\t\t\tInetAddress destination =  InetAddress.getByName(mDestination);\n\t\t\tstream.setTimeToLive(mTimeToLive);\n\t\t\tstream.setDestinationAddress(destination);\n\t\t\tstream.start();\n\t\t\tif (getTrack(1-id) == null || getTrack(1-id).isStreaming()) {\n\t\t\t\tpostSessionStarted();\n\t\t\t}\n\t\t\tif (getTrack(1-id) == null || !getTrack(1-id).isStreaming()) {\n\t\t\t\tmHandler.post(mUpdateBitrate);\n\t\t\t}\n\t\t} catch (UnknownHostException e) {\n\t\t\tpostError(ERROR_UNKNOWN_HOST, id, e);\n\t\t\tthrow e;\n\t\t} catch (CameraInUseException e) {\n\t\t\tpostError(ERROR_CAMERA_ALREADY_IN_USE , id, e);\n\t\t\tthrow e;\n\t\t} catch (StorageUnavailableException e) {\n\t\t\tpostError(ERROR_STORAGE_NOT_READY , id, e);\n\t\t\tthrow e;\n\t\t} catch (ConfNotSupportedException e) {\n\t\t\tpostError(ERROR_CONFIGURATION_NOT_SUPPORTED , id, e);\n\t\t\tthrow e;\n\t\t} catch (InvalidSurfaceException e) {\n\t\t\tpostError(ERROR_INVALID_SURFACE , id, e);\n\t\t\tthrow e;\n\t\t} catch (IOException e) {\n\t\t\tpostError(ERROR_OTHER, id, e);\n\t\t\tthrow e;\n\t\t} catch (RuntimeException e) {\n\t\t\tpostError(ERROR_OTHER, id, e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n}\n```\n参数id用来标识是音频，还是视频，最后执行到``stream.start()``，其调用的是最顶层的Stream实现类``MediaStream``的start方法。\n```\n/** Starts the stream. */\npublic synchronized void start() throws IllegalStateException, IOException {\n\n\tif (mDestination==null)\n\t\tthrow new IllegalStateException(\"No destination ip address set for the stream !\");\n\n\tif (mRtpPort<=0 || mRtcpPort<=0)\n\t\tthrow new IllegalStateException(\"No destination ports set for the stream !\");\n\n\tmPacketizer.setTimeToLive(mTTL);\n\n\tif (mMode != MODE_MEDIARECORDER_API) {\n\t\tencodeWithMediaCodec();\n\t} else {\n\t\tencodeWithMediaRecorder();\n\t}\n\n}\n```\n可以看到，根据Mode选择``encodeWithMediaCodec``或是``encodeWithMediaRecorder``。\n然后看到其继承类的实现方法，这里我只关注了``VideoStream``的实现。\n```\n/**\n * Video encoding is done by a MediaRecorder.\n */\nprotected void encodeWithMediaRecorder() throws IOException {\n\n  Log.d(TAG,\"Video encoded using the MediaRecorder API\");\n\n  // We need a local socket to forward data output by the camera to the packetizer\n  createSockets();\n\n  // Reopens the camera if needed\n  destroyCamera();\n  createCamera();\n\n  // The camera must be unlocked before the MediaRecorder can use it\n  unlockCamera();\n\n  try {\n    mMediaRecorder = new MediaRecorder();\n    mMediaRecorder.setCamera(mCamera);\n    mMediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);\n    mMediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);\n    mMediaRecorder.setVideoEncoder(mVideoEncoder);\n    mMediaRecorder.setPreviewDisplay(mSurfaceView.getHolder().getSurface());\n    mMediaRecorder.setVideoSize(mRequestedQuality.resX,mRequestedQuality.resY);\n    mMediaRecorder.setVideoFrameRate(mRequestedQuality.framerate);\n\n    // The bandwidth actually consumed is often above what was requested\n    mMediaRecorder.setVideoEncodingBitRate((int)(mRequestedQuality.bitrate*0.8));\n\n    // We write the ouput of the camera in a local socket instead of a file !\t\t\t\n    // This one little trick makes streaming feasible quiet simply: data from the camera\n    // can then be manipulated at the other end of the socket\n    mMediaRecorder.setOutputFile(mSender.getFileDescriptor());\n\n    mMediaRecorder.prepare();\n    mMediaRecorder.start();\n\n  } catch (Exception e) {\n    throw new ConfNotSupportedException(e.getMessage());\n  }\n\n  // This will skip the MPEG4 header if this step fails we can't stream anything :(\n  InputStream is = mReceiver.getInputStream();\n  try {\n    byte buffer[] = new byte[4];\n    // Skip all atoms preceding mdat atom\n    while (!Thread.interrupted()) {\n      while (is.read() != 'm');\n      is.read(buffer,0,3);\n      if (buffer[0] == 'd' && buffer[1] == 'a' && buffer[2] == 't') break;\n    }\n  } catch (IOException e) {\n    Log.e(TAG,\"Couldn't skip mp4 header :/\");\n    stop();\n    throw e;\n  }\n\n  // The packetizer encapsulates the bit stream in an RTP stream and send it over the network\n  mPacketizer.setDestination(mDestination, mRtpPort, mRtcpPort);\n  mPacketizer.setInputStream(mReceiver.getInputStream());\n  mPacketizer.start();\n\n  mStreaming = true;\n\n}\n\n\n/**\n * Video encoding is done by a MediaCodec.\n */\nprotected void encodeWithMediaCodec() throws RuntimeException, IOException {\n  if (mMode == MODE_MEDIACODEC_API_2) {\n    // Uses the method MediaCodec.createInputSurface to feed the encoder\n    encodeWithMediaCodecMethod2();\n  } else {\n    // Uses dequeueInputBuffer to feed the encoder\n    encodeWithMediaCodecMethod1();\n  }\n}\n\n/**\n * Video encoding is done by a MediaCodec.\n */\n@SuppressLint(\"NewApi\")\nprotected void encodeWithMediaCodecMethod1() throws RuntimeException, IOException {\n\n  Log.d(TAG,\"Video encoded using the MediaCodec API with a buffer\");\n\n  // Updates the parameters of the camera if needed\n  createCamera();\n  updateCamera();\n\n  // Estimates the framerate of the camera\n  measureFramerate();\n\n  // Starts the preview if needed\n  if (!mPreviewStarted) {\n    try {\n      mCamera.startPreview();\n      mPreviewStarted = true;\n    } catch (RuntimeException e) {\n      destroyCamera();\n      throw e;\n    }\n  }\n\n  EncoderDebugger debugger = EncoderDebugger.debug(mSettings, mQuality.resX, mQuality.resY);\n  final NV21Convertor convertor = debugger.getNV21Convertor();\n\n  mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());\n  MediaFormat mediaFormat = MediaFormat.createVideoFormat(\"video/avc\", mQuality.resX, mQuality.resY);\n  mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, mQuality.bitrate);\n  mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, mQuality.framerate);\n  mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,debugger.getEncoderColorFormat());\n  mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 1);\n  mMediaCodec.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);\n  mMediaCodec.start();\n\n  Camera.PreviewCallback callback = new Camera.PreviewCallback() {\n    long now = System.nanoTime()/1000, oldnow = now, i=0;\n    ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();\n    @Override\n    public void onPreviewFrame(byte[] data, Camera camera) {\n      oldnow = now;\n      now = System.nanoTime()/1000;\n      if (i++>3) {\n        i = 0;\n        //Log.d(TAG,\"Measured: \"+1000000L/(now-oldnow)+\" fps.\");\n      }\n      try {\n        int bufferIndex = mMediaCodec.dequeueInputBuffer(500000);\n        if (bufferIndex>=0) {\n          inputBuffers[bufferIndex].clear();\n          convertor.convert(data, inputBuffers[bufferIndex]);\n          mMediaCodec.queueInputBuffer(bufferIndex, 0, inputBuffers[bufferIndex].position(), now, 0);\n        } else {\n          Log.e(TAG,\"No buffer available !\");\n        }\n      } finally {\n        mCamera.addCallbackBuffer(data);\n      }\t\t\t\t\n    }\n  };\n\n  for (int i=0;i<10;i++) mCamera.addCallbackBuffer(new byte[convertor.getBufferSize()]);\n  mCamera.setPreviewCallbackWithBuffer(callback);\n\n  // The packetizer encapsulates the bit stream in an RTP stream and send it over the network\n  mPacketizer.setDestination(mDestination, mRtpPort, mRtcpPort);\n  mPacketizer.setInputStream(new MediaCodecInputStream(mMediaCodec));\n  mPacketizer.start();\n\n  mStreaming = true;\n\n}\n\n/**\n * Video encoding is done by a MediaCodec.\n * But here we will use the buffer-to-surface methode\n */\n@SuppressLint({ \"InlinedApi\", \"NewApi\" })\nprotected void encodeWithMediaCodecMethod2() throws RuntimeException, IOException {\n\n  Log.d(TAG,\"Video encoded using the MediaCodec API with a surface\");\n\n  // Updates the parameters of the camera if needed\n  createCamera();\n  updateCamera();\n\n  // Estimates the framerate of the camera\n  measureFramerate();\n\n  EncoderDebugger debugger = EncoderDebugger.debug(mSettings, mQuality.resX, mQuality.resY);\n\n  mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());\n  MediaFormat mediaFormat = MediaFormat.createVideoFormat(\"video/avc\", mQuality.resX, mQuality.resY);\n  mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, mQuality.bitrate);\n  mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, mQuality.framerate);\n  mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface);\n  mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 1);\n  mMediaCodec.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);\n  Surface surface = mMediaCodec.createInputSurface();\n  ((SurfaceView)mSurfaceView).addMediaCodecSurface(surface);\n  mMediaCodec.start();\n\n  // The packetizer encapsulates the bit stream in an RTP stream and send it over the network\n  mPacketizer.setDestination(mDestination, mRtpPort, mRtcpPort);\n  mPacketizer.setInputStream(new MediaCodecInputStream(mMediaCodec));\n  mPacketizer.start();\n\n  mStreaming = true;\n\n}\n```\n可以看到，整体实现有2个方式：\n1. MediaRecorder采集数据，通过绑定LocalSocket来获取数据\n2. 利用Camera又分了2种方式：回调``onPreviewFrame``获取数据进行处理，或者直接输出到``Surface``\n\n这与之前说到的不谋而合。\n\n## 问题\n通过绑定LocalSocket的方式，我在运行（MI 4LTE Android 6.0.1）的时候出现了``MediaRecorder: start failed -38``的错误。经过Google，后面找到[解决方案](http://stackoverflow.com/questions/26990816/mediarecorder-issue-on-android-lollipop/27118142#27118142)，setOutputFile时使用``ParcelFileDescriptor``。作者也在[spydroid libstreaming](https://github.com/fyhertz/libstreaming)中提到了，并进行了修正。于是我拷贝最新的``libstreaming``到工程中，运行的依然出错：MediaRecorder: start failed -2147483648，这下我没招了QAQ。\n后面想到``github issues``或许也有别人用的时候有这个问题呢，于是我便去看看。但是很不幸，说是在Android 5.0之后不能用MediaRecorder绑定LocalSocket的方式了==>[issues#227](https://github.com/fyhertz/libstreaming/issues/227)、[issues208](https://github.com/fyhertz/libstreaming/issues/208)、[issues#155](https://github.com/fyhertz/libstreaming/issues/155)。\n毕竟是好几年前的库了，之前Android都没出到5、6呢，后面作者也没有进行维护了，不过我在OPPA A31（Android 4.4.4）的环境下通过此种方式确实可以运行。\n\n## 参考\n[Android 实时视频采集/编码/传输/解码/播放—方案调研（初）](http://www.cnblogs.com/skyseraph/archive/2012/03/23/2415018.html)\n[Android 实时视频采集—MediaRecoder录制](http://www.cnblogs.com/skyseraph/archive/2012/03/31/2427593.html)\n[libstreaming](https://github.com/fyhertz/libstreaming)\n[spydroid-ipcamera](https://github.com/fyhertz/spydroid-ipcamera)\n[libstreaming-examples](https://github.com/fyhertz/libstreaming-examples)\n","source":"_posts/live-capture-video.md","raw":"---\ntitle: 【Android音视频开发】- 实时采集视频\ndate: 2016-10-20 10:24:19\ntags:\n - 直播\n---\n\n## 前言\n通过我的上一篇文章，可以知道直播大致有几个步骤：音视频采集 -> 美颜/滤镜/特效处理 -> 编码 -> 封包 -> 推流 -> 分发 -> 解码/渲染/播放。那么首先便从采集开始，这里我先做的视频采集。\n那么实时采集视频有哪些方案呢？\n\n## 调研\n通过各种调研，查阅文章，了解到目前Android实时采集视频大致有3种方式：\n1. 通过Android Camera拍摄预览中设置setPreviewCallback实现onPreviewFrame接口，实时截取每一帧视频流数据\n2. 通过通过Android的MediaRecorder，在SetoutputFile函数中绑定LocalSocket实现\n3. 流媒体服务器方式，利用ffmpeg或GetStreamer等获取Camera视频\n\n通过学习，大致了解了1，2两种方式的实现方式，但是对于第3种方式，暂时没有研究。\n\n<!-- more -->\n\n## spydroid\n当我们在接触一个全新领域的时候，最希望的是能实实在在看到一个demo产品，通过demo产品我们更容易理解其内在的原理。在网上看到了许多的开源项目，最后选择了[spydroid](https://github.com/fyhertz/spydroid-ipcamera)，感觉它跟Android结合更紧密。更多的信息可以参考[Android视频采集方案总结](http://www.smarting.me/android-video-caputure.html)。\n\n### 拷贝工程\n通过github看到的项目是Eclipse结构，这里我把代码拷贝下来后，通过AS打开，配置一些信息后项目结构如下：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video1.png)\n\n[streaming](https://github.com/fyhertz/libstreaming)是作者封装的一套库。\n> A solution for streaming H.264, H.263, AMR, AAC using RTP on Android\n\n### 运行\n项目拷贝到AS后，有部分错误，修复后成功运行在MI 4LTE。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video2.png)\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video3.png)\n它可以通过http，也可以通过rtsp进行推流，打开rtsp推流的开关，首页会多了一个VLC的地址。\n我在Win 10上使用Chrome接收失败，打开网站后Connect一直连不上。所以采取的VLC方式。\n打开VLC输入首页提示的地址，即可看到推流成功了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video4.png)\ndemo跑通后，便有了一个直观的感受，接下来便是看代码了。\n\n### 代码\n从``SpydroidActivity``开始，会看到它连接了一个Service：\n```\nprivate ServiceConnection mRtspServiceConnection = new ServiceConnection() {\n\n\t@Override\n\tpublic void onServiceConnected(ComponentName name, IBinder service) {\n\t\tmRtspServer = (CustomRtspServer) ((RtspServer.LocalBinder)service).getService();\n\t\tmRtspServer.addCallbackListener(mRtspCallbackListener);\n\t\tmRtspServer.start();\n\t}\n\n\t@Override\n\tpublic void onServiceDisconnected(ComponentName name) {}\n\n};\n```\n看到``RtspServer``中的start方法：\n```\npublic void start() {\n\tif (!mEnabled || mRestart) stop();\n\tif (mEnabled && mListenerThread == null) {\n\t\ttry {\n\t\t\tmListenerThread = new RequestListener();\n\t\t} catch (Exception e) {\n\t\t\tmListenerThread = null;\n\t\t}\n\t}\n\tmRestart = false;\n}\n```\n再看到``RequestListener``：\n```\nclass RequestListener extends Thread implements Runnable {\n\n\tprivate final ServerSocket mServer;\n\n\tpublic RequestListener() throws IOException {\n\t\ttry {\n\t\t\tmServer = new ServerSocket(mPort);\n\t\t\tstart();\n\t\t} catch (BindException e) {\n\t\t\tLog.e(TAG,\"Port already in use !\");\n\t\t\tpostError(e, ERROR_BIND_FAILED);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tpublic void run() {\n\t\tLog.i(TAG,\"RTSP server listening on port \"+mServer.getLocalPort());\n\t\twhile (!Thread.interrupted()) {\n\t\t\ttry {\n\t\t\t\tnew WorkerThread(mServer.accept()).start();\n\t\t\t} catch (SocketException e) {\n\t\t\t\tbreak;\n\t\t\t} catch (IOException e) {\n\t\t\t\tLog.e(TAG,e.getMessage());\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\t\tLog.i(TAG,\"RTSP server stopped !\");\n\t}\n\n\tpublic void kill() {\n\t\ttry {\n\t\t\tmServer.close();\n\t\t} catch (IOException e) {}\n\t\ttry {\n\t\t\tthis.join();\n\t\t} catch (InterruptedException ignore) {}\n\t}\n\n}\n```\n这是一个进程类，在构造方法中直接调用了Thread.start()，那么便会执行到run()方法。可以看到，初始化了一个ServerSocket，然后当有客户端连接后（通过VLC输入地址开始播放即是连接到这个ServerSocket），便会执行``WorkerThread``线程：\n```\nclass WorkerThread extends Thread implements Runnable {\n\n\tprivate final Socket mClient;\n\tprivate final OutputStream mOutput;\n\tprivate final BufferedReader mInput;\n\n\t// Each client has an associated session\n\tprivate Session mSession;\n\n\tpublic WorkerThread(final Socket client) throws IOException {\n\t\tmInput = new BufferedReader(new InputStreamReader(client.getInputStream()));\n\t\tmOutput = client.getOutputStream();\n\t\tmClient = client;\n\t\tmSession = new Session();\n\t}\n\n\tpublic void run() {\n\t\tRequest request;\n\t\tResponse response;\n\n\t\tLog.i(TAG, \"Connection from \"+mClient.getInetAddress().getHostAddress());\n\n\t\twhile (!Thread.interrupted()) {\n\n\t\t\trequest = null;\n\t\t\tresponse = null;\n\n\t\t\t// Parse the request\n\t\t\ttry {\n\t\t\t\trequest = Request.parseRequest(mInput);\n\t\t\t} catch (SocketException e) {\n\t\t\t\t// Client has left\n\t\t\t\tbreak;\n\t\t\t} catch (Exception e) {\n\t\t\t\t// We don't understand the request :/\n\t\t\t\tresponse = new Response();\n\t\t\t\tresponse.status = Response.STATUS_BAD_REQUEST;\n\t\t\t}\n\n\t\t\t// Do something accordingly like starting the streams, sending a session description\n\t\t\tif (request != null) {\n\t\t\t\ttry {\n\t\t\t\t\tresponse = processRequest(request);\n\t\t\t\t}\n\t\t\t\tcatch (Exception e) {\n\t\t\t\t\t// This alerts the main thread that something has gone wrong in this thread\n\t\t\t\t\tpostError(e, ERROR_START_FAILED);\n\t\t\t\t\tLog.e(TAG,e.getMessage()!=null?e.getMessage():\"An error occurred\");\n\t\t\t\t\te.printStackTrace();\n\t\t\t\t\tresponse = new Response(request);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// We always send a response\n\t\t\t// The client will receive an \"INTERNAL SERVER ERROR\" if an exception has been thrown at some point\n\t\t\ttry {\n\t\t\t\tresponse.send(mOutput);\n\t\t\t} catch (IOException e) {\n\t\t\t\tLog.e(TAG,\"Response was not sent properly\");\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t}\n\n\t\t// Streaming stops when client disconnects\n\t\tboolean streaming = isStreaming();\n\t\tmSession.syncStop();\n\t\tif (streaming && !isStreaming()) {\n\t\t\tpostMessage(MESSAGE_STREAMING_STOPPED);\n\t\t}\n\t\tmSession.release();\n\n\t\ttry {\n\t\t\tmClient.close();\n\t\t} catch (IOException ignore) {}\n\n\t\tLog.i(TAG, \"Client disconnected\");\n\n\t}\n\n\tpublic Response processRequest(Request request) throws IllegalStateException, IOException {\n\t\tResponse response = new Response(request);\n\n        //Ask for authorization unless this is an OPTIONS request\n        if(!isAuthorized(request) && !request.method.equalsIgnoreCase(\"OPTIONS\"))\n        {\n            response.attributes = \"WWW-Authenticate: Basic realm=\\\"\"+SERVER_NAME+\"\\\"\\r\\n\";\n            response.status = Response.STATUS_UNAUTHORIZED;\n        }\n        else\n        {\n\t\t    /* ********************************************************************************** */\n\t\t    /* ********************************* Method DESCRIBE ******************************** */\n\t\t    /* ********************************************************************************** */\n            if (request.method.equalsIgnoreCase(\"DESCRIBE\")) {\n\n                // Parse the requested URI and configure the session\n                mSession = handleRequest(request.uri, mClient);\n                mSessions.put(mSession, null);\n                mSession.syncConfigure();\n\n                String requestContent = mSession.getSessionDescription();\n                String requestAttributes =\n                        \"Content-Base: \" + mClient.getLocalAddress().getHostAddress() + \":\" + mClient.getLocalPort() + \"/\\r\\n\" +\n                                \"Content-Type: application/sdp\\r\\n\";\n\n                response.attributes = requestAttributes;\n                response.content = requestContent;\n\n                // If no exception has been thrown, we reply with OK\n                response.status = Response.STATUS_OK;\n\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************* Method OPTIONS ********************************* */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"OPTIONS\")) {\n                response.status = Response.STATUS_OK;\n                response.attributes = \"Public: DESCRIBE,SETUP,TEARDOWN,PLAY,PAUSE\\r\\n\";\n                response.status = Response.STATUS_OK;\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************** Method SETUP ********************************** */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"SETUP\")) {\n                Pattern p;\n                Matcher m;\n                int p2, p1, ssrc, trackId, src[];\n                String destination;\n\n                p = Pattern.compile(\"trackID=(\\\\w+)\", Pattern.CASE_INSENSITIVE);\n                m = p.matcher(request.uri);\n\n                if (!m.find()) {\n                    response.status = Response.STATUS_BAD_REQUEST;\n                    return response;\n                }\n\n                trackId = Integer.parseInt(m.group(1));\n\n                if (!mSession.trackExists(trackId)) {\n                    response.status = Response.STATUS_NOT_FOUND;\n                    return response;\n                }\n\n                p = Pattern.compile(\"client_port=(\\\\d+)-(\\\\d+)\", Pattern.CASE_INSENSITIVE);\n                m = p.matcher(request.headers.get(\"transport\"));\n\n                if (!m.find()) {\n                    int[] ports = mSession.getTrack(trackId).getDestinationPorts();\n                    p1 = ports[0];\n                    p2 = ports[1];\n                } else {\n                    p1 = Integer.parseInt(m.group(1));\n                    p2 = Integer.parseInt(m.group(2));\n                }\n\n                ssrc = mSession.getTrack(trackId).getSSRC();\n                src = mSession.getTrack(trackId).getLocalPorts();\n                destination = mSession.getDestination();\n\n                mSession.getTrack(trackId).setDestinationPorts(p1, p2);\n\n                boolean streaming = isStreaming();\n                mSession.syncStart(trackId);\n                if (!streaming && isStreaming()) {\n                    postMessage(MESSAGE_STREAMING_STARTED);\n                }\n\n                response.attributes = \"Transport: RTP/AVP/UDP;\" + (InetAddress.getByName(destination).isMulticastAddress() ? \"multicast\" : \"unicast\") +\n                        \";destination=\" + mSession.getDestination() +\n                        \";client_port=\" + p1 + \"-\" + p2 +\n                        \";server_port=\" + src[0] + \"-\" + src[1] +\n                        \";ssrc=\" + Integer.toHexString(ssrc) +\n                        \";mode=play\\r\\n\" +\n                        \"Session: \" + \"1185d20035702ca\" + \"\\r\\n\" +\n                        \"Cache-Control: no-cache\\r\\n\";\n                response.status = Response.STATUS_OK;\n\n                // If no exception has been thrown, we reply with OK\n                response.status = Response.STATUS_OK;\n\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************** Method PLAY *********************************** */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"PLAY\")) {\n                String requestAttributes = \"RTP-Info: \";\n                if (mSession.trackExists(0))\n                    requestAttributes += \"url=rtsp://\" + mClient.getLocalAddress().getHostAddress() + \":\" + mClient.getLocalPort() + \"/trackID=\" + 0 + \";seq=0,\";\n                if (mSession.trackExists(1))\n                    requestAttributes += \"url=rtsp://\" + mClient.getLocalAddress().getHostAddress() + \":\" + mClient.getLocalPort() + \"/trackID=\" + 1 + \";seq=0,\";\n                requestAttributes = requestAttributes.substring(0, requestAttributes.length() - 1) + \"\\r\\nSession: 1185d20035702ca\\r\\n\";\n\n                response.attributes = requestAttributes;\n\n                // If no exception has been thrown, we reply with OK\n                response.status = Response.STATUS_OK;\n\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************** Method PAUSE ********************************** */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"PAUSE\")) {\n                response.status = Response.STATUS_OK;\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************* Method TEARDOWN ******************************** */\n            /* ********************************************************************************** */\n            else if (request.method.equalsIgnoreCase(\"TEARDOWN\")) {\n                response.status = Response.STATUS_OK;\n            }\n\n            /* ********************************************************************************** */\n            /* ********************************* Unknown method ? ******************************* */\n            /* ********************************************************************************** */\n            else {\n                Log.e(TAG, \"Command unknown: \" + request);\n                response.status = Response.STATUS_BAD_REQUEST;\n            }\n        }\n\t\treturn response;\n\n\t}\n\n    /**\n     * Check if the request is authorized\n     * @param request\n     * @return true or false\n     */\n    private boolean isAuthorized(Request request)\n    {\n        String auth = request.headers.get(\"authorization\");\n        if(mUsername == null || mPassword == null || mUsername.isEmpty())\n            return true;\n\n        if(auth != null && !auth.isEmpty())\n        {\n            String received = auth.substring(auth.lastIndexOf(\" \")+1);\n            String local = mUsername+\":\"+mPassword;\n            String localEncoded = Base64.encodeToString(local.getBytes(),Base64.NO_WRAP);\n            if(localEncoded.equals(received))\n                return true;\n        }\n\n        return false;\n    }\n}\n```\n这个类比较长，但是我只需关注``采集``。看到``processRequest方法``，当有Client连接后，便会有session了，然后打印一些配置之类的信息，最后看到``mSession.syncStart(trackId)``，可以猜测这个方法便是开始采集、推流了。\n```\n/**\n * Starts a stream in a synchronous manner. <br />\n * Throws exceptions in addition to calling a callback.\n * @param id The id of the stream to start\n **/\npublic void syncStart(int id) \t\t\t\n\t\tthrows CameraInUseException,\n\t\tStorageUnavailableException,\n\t\tConfNotSupportedException,\n\t\tInvalidSurfaceException,\n\t\tUnknownHostException,\n\t\tIOException {\n\n\tStream stream = id==0 ? mAudioStream : mVideoStream;\n\tif (stream!=null && !stream.isStreaming()) {\n\t\ttry {\n\t\t\tInetAddress destination =  InetAddress.getByName(mDestination);\n\t\t\tstream.setTimeToLive(mTimeToLive);\n\t\t\tstream.setDestinationAddress(destination);\n\t\t\tstream.start();\n\t\t\tif (getTrack(1-id) == null || getTrack(1-id).isStreaming()) {\n\t\t\t\tpostSessionStarted();\n\t\t\t}\n\t\t\tif (getTrack(1-id) == null || !getTrack(1-id).isStreaming()) {\n\t\t\t\tmHandler.post(mUpdateBitrate);\n\t\t\t}\n\t\t} catch (UnknownHostException e) {\n\t\t\tpostError(ERROR_UNKNOWN_HOST, id, e);\n\t\t\tthrow e;\n\t\t} catch (CameraInUseException e) {\n\t\t\tpostError(ERROR_CAMERA_ALREADY_IN_USE , id, e);\n\t\t\tthrow e;\n\t\t} catch (StorageUnavailableException e) {\n\t\t\tpostError(ERROR_STORAGE_NOT_READY , id, e);\n\t\t\tthrow e;\n\t\t} catch (ConfNotSupportedException e) {\n\t\t\tpostError(ERROR_CONFIGURATION_NOT_SUPPORTED , id, e);\n\t\t\tthrow e;\n\t\t} catch (InvalidSurfaceException e) {\n\t\t\tpostError(ERROR_INVALID_SURFACE , id, e);\n\t\t\tthrow e;\n\t\t} catch (IOException e) {\n\t\t\tpostError(ERROR_OTHER, id, e);\n\t\t\tthrow e;\n\t\t} catch (RuntimeException e) {\n\t\t\tpostError(ERROR_OTHER, id, e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n}\n```\n参数id用来标识是音频，还是视频，最后执行到``stream.start()``，其调用的是最顶层的Stream实现类``MediaStream``的start方法。\n```\n/** Starts the stream. */\npublic synchronized void start() throws IllegalStateException, IOException {\n\n\tif (mDestination==null)\n\t\tthrow new IllegalStateException(\"No destination ip address set for the stream !\");\n\n\tif (mRtpPort<=0 || mRtcpPort<=0)\n\t\tthrow new IllegalStateException(\"No destination ports set for the stream !\");\n\n\tmPacketizer.setTimeToLive(mTTL);\n\n\tif (mMode != MODE_MEDIARECORDER_API) {\n\t\tencodeWithMediaCodec();\n\t} else {\n\t\tencodeWithMediaRecorder();\n\t}\n\n}\n```\n可以看到，根据Mode选择``encodeWithMediaCodec``或是``encodeWithMediaRecorder``。\n然后看到其继承类的实现方法，这里我只关注了``VideoStream``的实现。\n```\n/**\n * Video encoding is done by a MediaRecorder.\n */\nprotected void encodeWithMediaRecorder() throws IOException {\n\n  Log.d(TAG,\"Video encoded using the MediaRecorder API\");\n\n  // We need a local socket to forward data output by the camera to the packetizer\n  createSockets();\n\n  // Reopens the camera if needed\n  destroyCamera();\n  createCamera();\n\n  // The camera must be unlocked before the MediaRecorder can use it\n  unlockCamera();\n\n  try {\n    mMediaRecorder = new MediaRecorder();\n    mMediaRecorder.setCamera(mCamera);\n    mMediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);\n    mMediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);\n    mMediaRecorder.setVideoEncoder(mVideoEncoder);\n    mMediaRecorder.setPreviewDisplay(mSurfaceView.getHolder().getSurface());\n    mMediaRecorder.setVideoSize(mRequestedQuality.resX,mRequestedQuality.resY);\n    mMediaRecorder.setVideoFrameRate(mRequestedQuality.framerate);\n\n    // The bandwidth actually consumed is often above what was requested\n    mMediaRecorder.setVideoEncodingBitRate((int)(mRequestedQuality.bitrate*0.8));\n\n    // We write the ouput of the camera in a local socket instead of a file !\t\t\t\n    // This one little trick makes streaming feasible quiet simply: data from the camera\n    // can then be manipulated at the other end of the socket\n    mMediaRecorder.setOutputFile(mSender.getFileDescriptor());\n\n    mMediaRecorder.prepare();\n    mMediaRecorder.start();\n\n  } catch (Exception e) {\n    throw new ConfNotSupportedException(e.getMessage());\n  }\n\n  // This will skip the MPEG4 header if this step fails we can't stream anything :(\n  InputStream is = mReceiver.getInputStream();\n  try {\n    byte buffer[] = new byte[4];\n    // Skip all atoms preceding mdat atom\n    while (!Thread.interrupted()) {\n      while (is.read() != 'm');\n      is.read(buffer,0,3);\n      if (buffer[0] == 'd' && buffer[1] == 'a' && buffer[2] == 't') break;\n    }\n  } catch (IOException e) {\n    Log.e(TAG,\"Couldn't skip mp4 header :/\");\n    stop();\n    throw e;\n  }\n\n  // The packetizer encapsulates the bit stream in an RTP stream and send it over the network\n  mPacketizer.setDestination(mDestination, mRtpPort, mRtcpPort);\n  mPacketizer.setInputStream(mReceiver.getInputStream());\n  mPacketizer.start();\n\n  mStreaming = true;\n\n}\n\n\n/**\n * Video encoding is done by a MediaCodec.\n */\nprotected void encodeWithMediaCodec() throws RuntimeException, IOException {\n  if (mMode == MODE_MEDIACODEC_API_2) {\n    // Uses the method MediaCodec.createInputSurface to feed the encoder\n    encodeWithMediaCodecMethod2();\n  } else {\n    // Uses dequeueInputBuffer to feed the encoder\n    encodeWithMediaCodecMethod1();\n  }\n}\n\n/**\n * Video encoding is done by a MediaCodec.\n */\n@SuppressLint(\"NewApi\")\nprotected void encodeWithMediaCodecMethod1() throws RuntimeException, IOException {\n\n  Log.d(TAG,\"Video encoded using the MediaCodec API with a buffer\");\n\n  // Updates the parameters of the camera if needed\n  createCamera();\n  updateCamera();\n\n  // Estimates the framerate of the camera\n  measureFramerate();\n\n  // Starts the preview if needed\n  if (!mPreviewStarted) {\n    try {\n      mCamera.startPreview();\n      mPreviewStarted = true;\n    } catch (RuntimeException e) {\n      destroyCamera();\n      throw e;\n    }\n  }\n\n  EncoderDebugger debugger = EncoderDebugger.debug(mSettings, mQuality.resX, mQuality.resY);\n  final NV21Convertor convertor = debugger.getNV21Convertor();\n\n  mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());\n  MediaFormat mediaFormat = MediaFormat.createVideoFormat(\"video/avc\", mQuality.resX, mQuality.resY);\n  mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, mQuality.bitrate);\n  mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, mQuality.framerate);\n  mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,debugger.getEncoderColorFormat());\n  mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 1);\n  mMediaCodec.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);\n  mMediaCodec.start();\n\n  Camera.PreviewCallback callback = new Camera.PreviewCallback() {\n    long now = System.nanoTime()/1000, oldnow = now, i=0;\n    ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();\n    @Override\n    public void onPreviewFrame(byte[] data, Camera camera) {\n      oldnow = now;\n      now = System.nanoTime()/1000;\n      if (i++>3) {\n        i = 0;\n        //Log.d(TAG,\"Measured: \"+1000000L/(now-oldnow)+\" fps.\");\n      }\n      try {\n        int bufferIndex = mMediaCodec.dequeueInputBuffer(500000);\n        if (bufferIndex>=0) {\n          inputBuffers[bufferIndex].clear();\n          convertor.convert(data, inputBuffers[bufferIndex]);\n          mMediaCodec.queueInputBuffer(bufferIndex, 0, inputBuffers[bufferIndex].position(), now, 0);\n        } else {\n          Log.e(TAG,\"No buffer available !\");\n        }\n      } finally {\n        mCamera.addCallbackBuffer(data);\n      }\t\t\t\t\n    }\n  };\n\n  for (int i=0;i<10;i++) mCamera.addCallbackBuffer(new byte[convertor.getBufferSize()]);\n  mCamera.setPreviewCallbackWithBuffer(callback);\n\n  // The packetizer encapsulates the bit stream in an RTP stream and send it over the network\n  mPacketizer.setDestination(mDestination, mRtpPort, mRtcpPort);\n  mPacketizer.setInputStream(new MediaCodecInputStream(mMediaCodec));\n  mPacketizer.start();\n\n  mStreaming = true;\n\n}\n\n/**\n * Video encoding is done by a MediaCodec.\n * But here we will use the buffer-to-surface methode\n */\n@SuppressLint({ \"InlinedApi\", \"NewApi\" })\nprotected void encodeWithMediaCodecMethod2() throws RuntimeException, IOException {\n\n  Log.d(TAG,\"Video encoded using the MediaCodec API with a surface\");\n\n  // Updates the parameters of the camera if needed\n  createCamera();\n  updateCamera();\n\n  // Estimates the framerate of the camera\n  measureFramerate();\n\n  EncoderDebugger debugger = EncoderDebugger.debug(mSettings, mQuality.resX, mQuality.resY);\n\n  mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());\n  MediaFormat mediaFormat = MediaFormat.createVideoFormat(\"video/avc\", mQuality.resX, mQuality.resY);\n  mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, mQuality.bitrate);\n  mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, mQuality.framerate);\n  mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface);\n  mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 1);\n  mMediaCodec.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);\n  Surface surface = mMediaCodec.createInputSurface();\n  ((SurfaceView)mSurfaceView).addMediaCodecSurface(surface);\n  mMediaCodec.start();\n\n  // The packetizer encapsulates the bit stream in an RTP stream and send it over the network\n  mPacketizer.setDestination(mDestination, mRtpPort, mRtcpPort);\n  mPacketizer.setInputStream(new MediaCodecInputStream(mMediaCodec));\n  mPacketizer.start();\n\n  mStreaming = true;\n\n}\n```\n可以看到，整体实现有2个方式：\n1. MediaRecorder采集数据，通过绑定LocalSocket来获取数据\n2. 利用Camera又分了2种方式：回调``onPreviewFrame``获取数据进行处理，或者直接输出到``Surface``\n\n这与之前说到的不谋而合。\n\n## 问题\n通过绑定LocalSocket的方式，我在运行（MI 4LTE Android 6.0.1）的时候出现了``MediaRecorder: start failed -38``的错误。经过Google，后面找到[解决方案](http://stackoverflow.com/questions/26990816/mediarecorder-issue-on-android-lollipop/27118142#27118142)，setOutputFile时使用``ParcelFileDescriptor``。作者也在[spydroid libstreaming](https://github.com/fyhertz/libstreaming)中提到了，并进行了修正。于是我拷贝最新的``libstreaming``到工程中，运行的依然出错：MediaRecorder: start failed -2147483648，这下我没招了QAQ。\n后面想到``github issues``或许也有别人用的时候有这个问题呢，于是我便去看看。但是很不幸，说是在Android 5.0之后不能用MediaRecorder绑定LocalSocket的方式了==>[issues#227](https://github.com/fyhertz/libstreaming/issues/227)、[issues208](https://github.com/fyhertz/libstreaming/issues/208)、[issues#155](https://github.com/fyhertz/libstreaming/issues/155)。\n毕竟是好几年前的库了，之前Android都没出到5、6呢，后面作者也没有进行维护了，不过我在OPPA A31（Android 4.4.4）的环境下通过此种方式确实可以运行。\n\n## 参考\n[Android 实时视频采集/编码/传输/解码/播放—方案调研（初）](http://www.cnblogs.com/skyseraph/archive/2012/03/23/2415018.html)\n[Android 实时视频采集—MediaRecoder录制](http://www.cnblogs.com/skyseraph/archive/2012/03/31/2427593.html)\n[libstreaming](https://github.com/fyhertz/libstreaming)\n[spydroid-ipcamera](https://github.com/fyhertz/spydroid-ipcamera)\n[libstreaming-examples](https://github.com/fyhertz/libstreaming-examples)\n","slug":"live-capture-video","published":1,"updated":"2016-11-21T10:01:34.329Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e7599001m1cb8x19r02j4","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>通过我的上一篇文章，可以知道直播大致有几个步骤：音视频采集 -&gt; 美颜/滤镜/特效处理 -&gt; 编码 -&gt; 封包 -&gt; 推流 -&gt; 分发 -&gt; 解码/渲染/播放。那么首先便从采集开始，这里我先做的视频采集。<br>那么实时采集视频有哪些方案呢？</p>\n<h2 id=\"调研\"><a href=\"#调研\" class=\"headerlink\" title=\"调研\"></a>调研</h2><p>通过各种调研，查阅文章，了解到目前Android实时采集视频大致有3种方式：</p>\n<ol>\n<li>通过Android Camera拍摄预览中设置setPreviewCallback实现onPreviewFrame接口，实时截取每一帧视频流数据</li>\n<li>通过通过Android的MediaRecorder，在SetoutputFile函数中绑定LocalSocket实现</li>\n<li>流媒体服务器方式，利用ffmpeg或GetStreamer等获取Camera视频</li>\n</ol>\n<p>通过学习，大致了解了1，2两种方式的实现方式，但是对于第3种方式，暂时没有研究。</p>\n<a id=\"more\"></a>\n<h2 id=\"spydroid\"><a href=\"#spydroid\" class=\"headerlink\" title=\"spydroid\"></a>spydroid</h2><p>当我们在接触一个全新领域的时候，最希望的是能实实在在看到一个demo产品，通过demo产品我们更容易理解其内在的原理。在网上看到了许多的开源项目，最后选择了<a href=\"https://github.com/fyhertz/spydroid-ipcamera\" target=\"_blank\" rel=\"external\">spydroid</a>，感觉它跟Android结合更紧密。更多的信息可以参考<a href=\"http://www.smarting.me/android-video-caputure.html\" target=\"_blank\" rel=\"external\">Android视频采集方案总结</a>。</p>\n<h3 id=\"拷贝工程\"><a href=\"#拷贝工程\" class=\"headerlink\" title=\"拷贝工程\"></a>拷贝工程</h3><p>通过github看到的项目是Eclipse结构，这里我把代码拷贝下来后，通过AS打开，配置一些信息后项目结构如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video1.png\" alt=\"\"></p>\n<p><a href=\"https://github.com/fyhertz/libstreaming\" target=\"_blank\" rel=\"external\">streaming</a>是作者封装的一套库。</p>\n<blockquote>\n<p>A solution for streaming H.264, H.263, AMR, AAC using RTP on Android</p>\n</blockquote>\n<h3 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h3><p>项目拷贝到AS后，有部分错误，修复后成功运行在MI 4LTE。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video2.png\" alt=\"\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video3.png\" alt=\"\"><br>它可以通过http，也可以通过rtsp进行推流，打开rtsp推流的开关，首页会多了一个VLC的地址。<br>我在Win 10上使用Chrome接收失败，打开网站后Connect一直连不上。所以采取的VLC方式。<br>打开VLC输入首页提示的地址，即可看到推流成功了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video4.png\" alt=\"\"><br>demo跑通后，便有了一个直观的感受，接下来便是看代码了。</p>\n<h3 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h3><p>从<code>SpydroidActivity</code>开始，会看到它连接了一个Service：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> ServiceConnection mRtspServiceConnection = <span class=\"keyword\">new</span> ServiceConnection() &#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onServiceConnected</span><span class=\"params\">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class=\"line\">\t\tmRtspServer = (CustomRtspServer) ((RtspServer.LocalBinder)service).getService();</div><div class=\"line\">\t\tmRtspServer.addCallbackListener(mRtspCallbackListener);</div><div class=\"line\">\t\tmRtspServer.start();</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onServiceDisconnected</span><span class=\"params\">(ComponentName name)</span> </span>&#123;&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure></p>\n<p>看到<code>RtspServer</code>中的start方法：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">if</span> (!mEnabled || mRestart) stop();</div><div class=\"line\">\t<span class=\"keyword\">if</span> (mEnabled &amp;&amp; mListenerThread == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tmListenerThread = <span class=\"keyword\">new</span> RequestListener();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">\t\t\tmListenerThread = <span class=\"keyword\">null</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tmRestart = <span class=\"keyword\">false</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>再看到<code>RequestListener</code>：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RequestListener</span> <span class=\"keyword\">extends</span> <span class=\"title\">Thread</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ServerSocket mServer;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RequestListener</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tmServer = <span class=\"keyword\">new</span> ServerSocket(mPort);</div><div class=\"line\">\t\t\tstart();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (BindException e) &#123;</div><div class=\"line\">\t\t\tLog.e(TAG,<span class=\"string\">\"Port already in use !\"</span>);</div><div class=\"line\">\t\t\tpostError(e, ERROR_BIND_FAILED);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\tLog.i(TAG,<span class=\"string\">\"RTSP server listening on port \"</span>+mServer.getLocalPort());</div><div class=\"line\">\t\t<span class=\"keyword\">while</span> (!Thread.interrupted()) &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> WorkerThread(mServer.accept()).start();</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (SocketException e) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">\t\t\t\tLog.e(TAG,e.getMessage());</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tLog.i(TAG,<span class=\"string\">\"RTSP server stopped !\"</span>);</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">kill</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tmServer.close();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">this</span>.join();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (InterruptedException ignore) &#123;&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这是一个进程类，在构造方法中直接调用了Thread.start()，那么便会执行到run()方法。可以看到，初始化了一个ServerSocket，然后当有客户端连接后（通过VLC输入地址开始播放即是连接到这个ServerSocket），便会执行<code>WorkerThread</code>线程：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div></pre></td><td class=\"code\"><pre><div class=\"line\">class WorkerThread extends Thread implements Runnable &#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Socket mClient;</div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">final</span> OutputStream mOutput;</div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">BufferedReader</span> mInput;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">// Each client has an associated session</span></div><div class=\"line\">\t<span class=\"keyword\">private</span> Session mSession;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> WorkerThread(<span class=\"keyword\">final</span> Socket client) <span class=\"keyword\">throws</span> IOException &#123;</div><div class=\"line\">\t\tmInput = <span class=\"keyword\">new</span> <span class=\"keyword\">BufferedReader</span>(<span class=\"keyword\">new</span> InputStreamReader(client.getInputStream()));</div><div class=\"line\">\t\tmOutput = client.getOutputStream();</div><div class=\"line\">\t\tmClient = client;</div><div class=\"line\">\t\tmSession = <span class=\"keyword\">new</span> Session();</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> run() &#123;</div><div class=\"line\">\t\tRequest request;</div><div class=\"line\">\t\tResponse response;</div><div class=\"line\"></div><div class=\"line\">\t\tLog.i(TAG, <span class=\"string\">\"Connection from \"</span>+mClient.getInetAddress().getHostAddress());</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">while</span> (!Thread.interrupted()) &#123;</div><div class=\"line\"></div><div class=\"line\">\t\t\trequest = <span class=\"keyword\">null</span>;</div><div class=\"line\">\t\t\tresponse = <span class=\"keyword\">null</span>;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\">// Parse the request</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\trequest = Request.parseRequest(mInput);</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (SocketException e) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"comment\">// Client has left</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"comment\">// We don't understand the request :/</span></div><div class=\"line\">\t\t\t\tresponse = <span class=\"keyword\">new</span> Response();</div><div class=\"line\">\t\t\t\tresponse.status = Response.STATUS_BAD_REQUEST;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\">// Do something accordingly like starting the streams, sending a session description</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (request != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\t\tresponse = processRequest(request);</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">\t\t\t\t\t<span class=\"comment\">// This alerts the main thread that something has gone wrong in this thread</span></div><div class=\"line\">\t\t\t\t\tpostError(e, ERROR_START_FAILED);</div><div class=\"line\">\t\t\t\t\tLog.e(TAG,e.getMessage()!=<span class=\"keyword\">null</span>?e.getMessage():<span class=\"string\">\"An error occurred\"</span>);</div><div class=\"line\">\t\t\t\t\te.printStackTrace();</div><div class=\"line\">\t\t\t\t\tresponse = <span class=\"keyword\">new</span> Response(request);</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\">// We always send a response</span></div><div class=\"line\">\t\t\t<span class=\"comment\">// The client will receive an \"INTERNAL SERVER ERROR\" if an exception has been thrown at some point</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\tresponse.send(mOutput);</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">\t\t\t\tLog.e(TAG,<span class=\"string\">\"Response was not sent properly\"</span>);</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">// Streaming stops when client disconnects</span></div><div class=\"line\">\t\t<span class=\"built_in\">boolean</span> streaming = isStreaming();</div><div class=\"line\">\t\tmSession.syncStop();</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> (streaming &amp;&amp; !isStreaming()) &#123;</div><div class=\"line\">\t\t\tpostMessage(MESSAGE_STREAMING_STOPPED);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tmSession.release();</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tmClient.close();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IOException ignore) &#123;&#125;</div><div class=\"line\"></div><div class=\"line\">\t\tLog.i(TAG, <span class=\"string\">\"Client disconnected\"</span>);</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> Response processRequest(Request request) <span class=\"keyword\">throws</span> IllegalStateException, IOException &#123;</div><div class=\"line\">\t\tResponse response = <span class=\"keyword\">new</span> Response(request);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">//Ask for authorization unless this is an OPTIONS request</span></div><div class=\"line\">        <span class=\"keyword\">if</span>(!isAuthorized(request) &amp;&amp; !request.method.equalsIgnoreCase(<span class=\"string\">\"OPTIONS\"</span>))</div><div class=\"line\">        &#123;</div><div class=\"line\">            response.attributes = <span class=\"string\">\"WWW-Authenticate: Basic realm=\\\"\"</span>+SERVER_NAME+<span class=\"string\">\"\\\"\\r\\n\"</span>;</div><div class=\"line\">            response.status = Response.STATUS_UNAUTHORIZED;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span></div><div class=\"line\">        &#123;</div><div class=\"line\">\t\t    <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">\t\t    <span class=\"comment\">/* ********************************* Method DESCRIBE ******************************** */</span></div><div class=\"line\">\t\t    <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"DESCRIBE\"</span>)) &#123;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">// Parse the requested URI and configure the session</span></div><div class=\"line\">                mSession = handleRequest(request.uri, mClient);</div><div class=\"line\">                mSessions.put(mSession, <span class=\"keyword\">null</span>);</div><div class=\"line\">                mSession.syncConfigure();</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">String</span> requestContent = mSession.getSessionDescription();</div><div class=\"line\">                <span class=\"keyword\">String</span> requestAttributes =</div><div class=\"line\">                        <span class=\"string\">\"Content-Base: \"</span> + mClient.getLocalAddress().getHostAddress() + <span class=\"string\">\":\"</span> + mClient.getLocalPort() + <span class=\"string\">\"/\\r\\n\"</span> +</div><div class=\"line\">                                <span class=\"string\">\"Content-Type: application/sdp\\r\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">                response.attributes = requestAttributes;</div><div class=\"line\">                response.content = requestContent;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">// If no exception has been thrown, we reply with OK</span></div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************* Method OPTIONS ********************************* */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"OPTIONS\"</span>)) &#123;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\">                response.attributes = <span class=\"string\">\"Public: DESCRIBE,SETUP,TEARDOWN,PLAY,PAUSE\\r\\n\"</span>;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************** Method SETUP ********************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"SETUP\"</span>)) &#123;</div><div class=\"line\">                Pattern p;</div><div class=\"line\">                Matcher m;</div><div class=\"line\">                <span class=\"built_in\">int</span> p2, p1, ssrc, trackId, src[];</div><div class=\"line\">                <span class=\"keyword\">String</span> destination;</div><div class=\"line\"></div><div class=\"line\">                p = Pattern.compile(<span class=\"string\">\"trackID=(\\\\w+)\"</span>, Pattern.CASE_INSENSITIVE);</div><div class=\"line\">                m = p.matcher(request.uri);</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">if</span> (!m.find()) &#123;</div><div class=\"line\">                    response.status = Response.STATUS_BAD_REQUEST;</div><div class=\"line\">                    <span class=\"keyword\">return</span> response;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                trackId = Integer.parseInt(m.group(<span class=\"number\">1</span>));</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">if</span> (!mSession.trackExists(trackId)) &#123;</div><div class=\"line\">                    response.status = Response.STATUS_NOT_FOUND;</div><div class=\"line\">                    <span class=\"keyword\">return</span> response;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                p = Pattern.compile(<span class=\"string\">\"client_port=(\\\\d+)-(\\\\d+)\"</span>, Pattern.CASE_INSENSITIVE);</div><div class=\"line\">                m = p.matcher(request.headers.<span class=\"built_in\">get</span>(<span class=\"string\">\"transport\"</span>));</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">if</span> (!m.find()) &#123;</div><div class=\"line\">                    <span class=\"built_in\">int</span>[] ports = mSession.getTrack(trackId).getDestinationPorts();</div><div class=\"line\">                    p1 = ports[<span class=\"number\">0</span>];</div><div class=\"line\">                    p2 = ports[<span class=\"number\">1</span>];</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    p1 = Integer.parseInt(m.group(<span class=\"number\">1</span>));</div><div class=\"line\">                    p2 = Integer.parseInt(m.group(<span class=\"number\">2</span>));</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                ssrc = mSession.getTrack(trackId).getSSRC();</div><div class=\"line\">                src = mSession.getTrack(trackId).getLocalPorts();</div><div class=\"line\">                destination = mSession.getDestination();</div><div class=\"line\"></div><div class=\"line\">                mSession.getTrack(trackId).setDestinationPorts(p1, p2);</div><div class=\"line\"></div><div class=\"line\">                <span class=\"built_in\">boolean</span> streaming = isStreaming();</div><div class=\"line\">                mSession.syncStart(trackId);</div><div class=\"line\">                <span class=\"keyword\">if</span> (!streaming &amp;&amp; isStreaming()) &#123;</div><div class=\"line\">                    postMessage(MESSAGE_STREAMING_STARTED);</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                response.attributes = <span class=\"string\">\"Transport: RTP/AVP/UDP;\"</span> + (InetAddress.getByName(destination).isMulticastAddress() ? <span class=\"string\">\"multicast\"</span> : <span class=\"string\">\"unicast\"</span>) +</div><div class=\"line\">                        <span class=\"string\">\";destination=\"</span> + mSession.getDestination() +</div><div class=\"line\">                        <span class=\"string\">\";client_port=\"</span> + p1 + <span class=\"string\">\"-\"</span> + p2 +</div><div class=\"line\">                        <span class=\"string\">\";server_port=\"</span> + src[<span class=\"number\">0</span>] + <span class=\"string\">\"-\"</span> + src[<span class=\"number\">1</span>] +</div><div class=\"line\">                        <span class=\"string\">\";ssrc=\"</span> + Integer.toHexString(ssrc) +</div><div class=\"line\">                        <span class=\"string\">\";mode=play\\r\\n\"</span> +</div><div class=\"line\">                        <span class=\"string\">\"Session: \"</span> + <span class=\"string\">\"1185d20035702ca\"</span> + <span class=\"string\">\"\\r\\n\"</span> +</div><div class=\"line\">                        <span class=\"string\">\"Cache-Control: no-cache\\r\\n\"</span>;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">// If no exception has been thrown, we reply with OK</span></div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************** Method PLAY *********************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"PLAY\"</span>)) &#123;</div><div class=\"line\">                <span class=\"keyword\">String</span> requestAttributes = <span class=\"string\">\"RTP-Info: \"</span>;</div><div class=\"line\">                <span class=\"keyword\">if</span> (mSession.trackExists(<span class=\"number\">0</span>))</div><div class=\"line\">                    requestAttributes += <span class=\"string\">\"url=rtsp://\"</span> + mClient.getLocalAddress().getHostAddress() + <span class=\"string\">\":\"</span> + mClient.getLocalPort() + <span class=\"string\">\"/trackID=\"</span> + <span class=\"number\">0</span> + <span class=\"string\">\";seq=0,\"</span>;</div><div class=\"line\">                <span class=\"keyword\">if</span> (mSession.trackExists(<span class=\"number\">1</span>))</div><div class=\"line\">                    requestAttributes += <span class=\"string\">\"url=rtsp://\"</span> + mClient.getLocalAddress().getHostAddress() + <span class=\"string\">\":\"</span> + mClient.getLocalPort() + <span class=\"string\">\"/trackID=\"</span> + <span class=\"number\">1</span> + <span class=\"string\">\";seq=0,\"</span>;</div><div class=\"line\">                requestAttributes = requestAttributes.substring(<span class=\"number\">0</span>, requestAttributes.length() - <span class=\"number\">1</span>) + <span class=\"string\">\"\\r\\nSession: 1185d20035702ca\\r\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">                response.attributes = requestAttributes;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">// If no exception has been thrown, we reply with OK</span></div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************** Method PAUSE ********************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"PAUSE\"</span>)) &#123;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************* Method TEARDOWN ******************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"TEARDOWN\"</span>)) &#123;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************* Unknown method ? ******************************* */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                Log.e(TAG, <span class=\"string\">\"Command unknown: \"</span> + request);</div><div class=\"line\">                response.status = Response.STATUS_BAD_REQUEST;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> response;</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * Check if the request is authorized</div><div class=\"line\">     * @param request</div><div class=\"line\">     * @return true or false</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"built_in\">boolean</span> isAuthorized(Request request)</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"keyword\">String</span> auth = request.headers.<span class=\"built_in\">get</span>(<span class=\"string\">\"authorization\"</span>);</div><div class=\"line\">        <span class=\"keyword\">if</span>(mUsername == <span class=\"keyword\">null</span> || mPassword == <span class=\"keyword\">null</span> || mUsername.isEmpty())</div><div class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span>(auth != <span class=\"keyword\">null</span> &amp;&amp; !auth.isEmpty())</div><div class=\"line\">        &#123;</div><div class=\"line\">            <span class=\"keyword\">String</span> received = auth.substring(auth.lastIndexOf(<span class=\"string\">\" \"</span>)+<span class=\"number\">1</span>);</div><div class=\"line\">            <span class=\"keyword\">String</span> local = mUsername+<span class=\"string\">\":\"</span>+mPassword;</div><div class=\"line\">            <span class=\"keyword\">String</span> localEncoded = Base64.encodeToString(local.getBytes(),Base64.NO_WRAP);</div><div class=\"line\">            <span class=\"keyword\">if</span>(localEncoded.equals(received))</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这个类比较长，但是我只需关注<code>采集</code>。看到<code>processRequest方法</code>，当有Client连接后，便会有session了，然后打印一些配置之类的信息，最后看到<code>mSession.syncStart(trackId)</code>，可以猜测这个方法便是开始采集、推流了。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * Starts a stream in a synchronous manner. &lt;br /&gt;</div><div class=\"line\"> * Throws exceptions in addition to calling a callback.</div><div class=\"line\"> * <span class=\"doctag\">@param</span> id The id of the stream to start</div><div class=\"line\"> **/</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">syncStart</span><span class=\"params\">(<span class=\"keyword\">int</span> id)</span> \t\t\t</span></div><div class=\"line\">\t\t<span class=\"keyword\">throws</span> CameraInUseException,</div><div class=\"line\">\t\tStorageUnavailableException,</div><div class=\"line\">\t\tConfNotSupportedException,</div><div class=\"line\">\t\tInvalidSurfaceException,</div><div class=\"line\">\t\tUnknownHostException,</div><div class=\"line\">\t\tIOException &#123;</div><div class=\"line\"></div><div class=\"line\">\tStream stream = id==<span class=\"number\">0</span> ? mAudioStream : mVideoStream;</div><div class=\"line\">\t<span class=\"keyword\">if</span> (stream!=<span class=\"keyword\">null</span> &amp;&amp; !stream.isStreaming()) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tInetAddress destination =  InetAddress.getByName(mDestination);</div><div class=\"line\">\t\t\tstream.setTimeToLive(mTimeToLive);</div><div class=\"line\">\t\t\tstream.setDestinationAddress(destination);</div><div class=\"line\">\t\t\tstream.start();</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (getTrack(<span class=\"number\">1</span>-id) == <span class=\"keyword\">null</span> || getTrack(<span class=\"number\">1</span>-id).isStreaming()) &#123;</div><div class=\"line\">\t\t\t\tpostSessionStarted();</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (getTrack(<span class=\"number\">1</span>-id) == <span class=\"keyword\">null</span> || !getTrack(<span class=\"number\">1</span>-id).isStreaming()) &#123;</div><div class=\"line\">\t\t\t\tmHandler.post(mUpdateBitrate);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (UnknownHostException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_UNKNOWN_HOST, id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (CameraInUseException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_CAMERA_ALREADY_IN_USE , id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (StorageUnavailableException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_STORAGE_NOT_READY , id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (ConfNotSupportedException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_CONFIGURATION_NOT_SUPPORTED , id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (InvalidSurfaceException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_INVALID_SURFACE , id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_OTHER, id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (RuntimeException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_OTHER, id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>参数id用来标识是音频，还是视频，最后执行到<code>stream.start()</code>，其调用的是最顶层的Stream实现类<code>MediaStream</code>的start方法。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/** Starts the stream. */</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IllegalStateException, IOException </span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> (mDestination==<span class=\"keyword\">null</span>)</div><div class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">\"No destination ip address set for the stream !\"</span>);</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> (mRtpPort&lt;=<span class=\"number\">0</span> || mRtcpPort&lt;=<span class=\"number\">0</span>)</div><div class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">\"No destination ports set for the stream !\"</span>);</div><div class=\"line\"></div><div class=\"line\">\tmPacketizer.setTimeToLive(mTTL);</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> (mMode != MODE_MEDIARECORDER_API) &#123;</div><div class=\"line\">\t\tencodeWithMediaCodec();</div><div class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">\t\tencodeWithMediaRecorder();</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到，根据Mode选择<code>encodeWithMediaCodec</code>或是<code>encodeWithMediaRecorder</code>。<br>然后看到其继承类的实现方法，这里我只关注了<code>VideoStream</code>的实现。<br><figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * Video encoding is done by a MediaRecorder.</div><div class=\"line\"> */</div><div class=\"line\">protected void encodeWithMediaRecorder() throws <span class=\"type\">IOException</span> &#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"type\">Log</span>.d(<span class=\"type\">TAG</span>,<span class=\"string\">\"Video encoded using the MediaRecorder API\"</span>);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// We need a local socket to forward data output by the camera to the packetizer</span></div><div class=\"line\">  createSockets();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Reopens the camera if needed</span></div><div class=\"line\">  destroyCamera();</div><div class=\"line\">  createCamera();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The camera must be unlocked before the MediaRecorder can use it</span></div><div class=\"line\">  unlockCamera();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">    mMediaRecorder = <span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">MediaRecorder</span>();</span></div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setCamera</span>(mCamera);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoSource</span>(<span class=\"type\">MediaRecorder</span>.<span class=\"type\">VideoSource</span>.<span class=\"type\">CAMERA</span>);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setOutputFormat</span>(<span class=\"type\">MediaRecorder</span>.<span class=\"type\">OutputFormat</span>.<span class=\"type\">THREE_GPP</span>);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoEncoder</span>(mVideoEncoder);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setPreviewDisplay</span>(mSurfaceView.getHolder().<span class=\"title\">getSurface</span>());</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoSize</span>(mRequestedQuality.resX,mRequestedQuality.resY);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoFrameRate</span>(mRequestedQuality.framerate);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// The bandwidth actually consumed is often above what was requested</span></div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoEncodingBitRate</span>((int)(mRequestedQuality.bitrate*<span class=\"number\">0.8</span>));</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// We write the ouput of the camera in a local socket instead of a file !\t\t\t</span></div><div class=\"line\">    <span class=\"comment\">// This one little trick makes streaming feasible quiet simply: data from the camera</span></div><div class=\"line\">    <span class=\"comment\">// can then be manipulated at the other end of the socket</span></div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setOutputFile</span>(mSender.getFileDescriptor());</div><div class=\"line\"></div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">prepare</span>();</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  &#125; <span class=\"title\">catch</span> (<span class=\"type\">Exception</span> e) &#123;</div><div class=\"line\">    <span class=\"title\">throw</span> <span class=\"title\">new</span> <span class=\"title\">ConfNotSupportedException</span>(e.getMessage());</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// This will skip the MPEG4 header if this step fails we can't stream anything :(</span></div><div class=\"line\">  <span class=\"title\">InputStream</span> <span class=\"title\">is</span> = <span class=\"title\">mReceiver</span>.<span class=\"title\">getInputStream</span>();</div><div class=\"line\">  <span class=\"title\">try</span> &#123;</div><div class=\"line\">    <span class=\"title\">byte</span> <span class=\"title\">buffer</span>[] = <span class=\"title\">new</span> <span class=\"title\">byte</span>[4];</div><div class=\"line\">    <span class=\"comment\">// Skip all atoms preceding mdat atom</span></div><div class=\"line\">    <span class=\"title\">while</span> (!<span class=\"type\">Thread</span>.interrupted()) &#123;</div><div class=\"line\">      <span class=\"title\">while</span> (is.read() != '<span class=\"title\">m</span>');</div><div class=\"line\">      <span class=\"title\">is</span>.<span class=\"title\">read</span>(buffer,<span class=\"number\">0</span>,<span class=\"number\">3</span>);</div><div class=\"line\">      <span class=\"title\">if</span> (buffer[<span class=\"number\">0</span>] == 'd' &amp;&amp; buffer[<span class=\"number\">1</span>] == 'a' &amp;&amp; buffer[<span class=\"number\">2</span>] == 't') <span class=\"title\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125; <span class=\"title\">catch</span> (<span class=\"type\">IOException</span> e) &#123;</div><div class=\"line\">    <span class=\"title\">Log</span>.<span class=\"title\">e</span>(<span class=\"type\">TAG</span>,\"<span class=\"type\">Couldn</span>'t skip mp4 header :/\");</div><div class=\"line\">    <span class=\"title\">stop</span>();</div><div class=\"line\">    <span class=\"title\">throw</span> <span class=\"title\">e</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The packetizer encapsulates the bit stream in an RTP stream and send it over the network</span></div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setDestination</span>(mDestination, mRtpPort, mRtcpPort);</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setInputStream</span>(mReceiver.getInputStream());</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mStreaming</span> = <span class=\"title\">true</span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">/**</div><div class=\"line\"> * <span class=\"title\">Video</span> <span class=\"title\">encoding</span> <span class=\"title\">is</span> <span class=\"title\">done</span> <span class=\"title\">by</span> <span class=\"title\">a</span> <span class=\"title\">MediaCodec</span>.</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"title\">protected</span> <span class=\"title\">void</span> <span class=\"title\">encodeWithMediaCodec</span>() <span class=\"title\">throws</span> <span class=\"title\">RuntimeException</span>, <span class=\"title\">IOException</span> &#123;</div><div class=\"line\">  <span class=\"title\">if</span> (mMode == <span class=\"type\">MODE_MEDIACODEC_API_2</span>) &#123;</div><div class=\"line\">    <span class=\"comment\">// Uses the method MediaCodec.createInputSurface to feed the encoder</span></div><div class=\"line\">    <span class=\"title\">encodeWithMediaCodecMethod2</span>();</div><div class=\"line\">  &#125; <span class=\"title\">else</span> &#123;</div><div class=\"line\">    <span class=\"comment\">// Uses dequeueInputBuffer to feed the encoder</span></div><div class=\"line\">    <span class=\"title\">encodeWithMediaCodecMethod1</span>();</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">/**</div><div class=\"line\"> * <span class=\"title\">Video</span> <span class=\"title\">encoding</span> <span class=\"title\">is</span> <span class=\"title\">done</span> <span class=\"title\">by</span> <span class=\"title\">a</span> <span class=\"title\">MediaCodec</span>.</div><div class=\"line\"> */</div><div class=\"line\">@<span class=\"title\">SuppressLint</span>(\"<span class=\"type\">NewApi</span>\")</div><div class=\"line\"><span class=\"title\">protected</span> <span class=\"title\">void</span> <span class=\"title\">encodeWithMediaCodecMethod1</span>() <span class=\"title\">throws</span> <span class=\"title\">RuntimeException</span>, <span class=\"title\">IOException</span> &#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">Log</span>.<span class=\"title\">d</span>(<span class=\"type\">TAG</span>,\"<span class=\"type\">Video</span> encoded using the <span class=\"type\">MediaCodec</span> <span class=\"type\">API</span> with a buffer\");</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Updates the parameters of the camera if needed</span></div><div class=\"line\">  <span class=\"title\">createCamera</span>();</div><div class=\"line\">  <span class=\"title\">updateCamera</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Estimates the framerate of the camera</span></div><div class=\"line\">  <span class=\"title\">measureFramerate</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Starts the preview if needed</span></div><div class=\"line\">  <span class=\"title\">if</span> (!mPreviewStarted) &#123;</div><div class=\"line\">    <span class=\"title\">try</span> &#123;</div><div class=\"line\">      <span class=\"title\">mCamera</span>.<span class=\"title\">startPreview</span>();</div><div class=\"line\">      <span class=\"title\">mPreviewStarted</span> = <span class=\"title\">true</span>;</div><div class=\"line\">    &#125; <span class=\"title\">catch</span> (<span class=\"type\">RuntimeException</span> e) &#123;</div><div class=\"line\">      <span class=\"title\">destroyCamera</span>();</div><div class=\"line\">      <span class=\"title\">throw</span> <span class=\"title\">e</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">EncoderDebugger</span> <span class=\"title\">debugger</span> = <span class=\"title\">EncoderDebugger</span>.<span class=\"title\">debug</span>(mSettings, mQuality.resX, mQuality.resY);</div><div class=\"line\">  <span class=\"title\">final</span> <span class=\"title\">NV21Convertor</span> <span class=\"title\">convertor</span> = <span class=\"title\">debugger</span>.<span class=\"title\">getNV21Convertor</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mMediaCodec</span> = <span class=\"title\">MediaCodec</span>.<span class=\"title\">createByCodecName</span>(debugger.getEncoderName());</div><div class=\"line\">  <span class=\"title\">MediaFormat</span> <span class=\"title\">mediaFormat</span> = <span class=\"title\">MediaFormat</span>.<span class=\"title\">createVideoFormat</span>(\"video/avc\", mQuality.resX, mQuality.resY);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_BIT_RATE</span>, mQuality.bitrate);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_FRAME_RATE</span>, mQuality.framerate);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_COLOR_FORMAT</span>,debugger.getEncoderColorFormat());</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_I_FRAME_INTERVAL</span>, <span class=\"number\">1</span>);</div><div class=\"line\">  <span class=\"title\">mMediaCodec</span>.<span class=\"title\">configure</span>(mediaFormat, null, null, <span class=\"type\">MediaCodec</span>.<span class=\"type\">CONFIGURE_FLAG_ENCODE</span>);</div><div class=\"line\">  <span class=\"title\">mMediaCodec</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">Camera</span>.<span class=\"title\">PreviewCallback</span> <span class=\"title\">callback</span> = <span class=\"title\">new</span> <span class=\"title\">Camera</span>.<span class=\"title\">PreviewCallback</span>() &#123;</div><div class=\"line\">    <span class=\"title\">long</span> <span class=\"title\">now</span> = <span class=\"title\">System</span>.<span class=\"title\">nanoTime</span>()/1000, <span class=\"title\">oldnow</span> = <span class=\"title\">now</span>, <span class=\"title\">i</span>=0;</div><div class=\"line\">    <span class=\"title\">ByteBuffer</span>[] <span class=\"title\">inputBuffers</span> = <span class=\"title\">mMediaCodec</span>.<span class=\"title\">getInputBuffers</span>();</div><div class=\"line\">    @<span class=\"title\">Override</span></div><div class=\"line\">    <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">onPreviewFrame</span>(byte[] data, <span class=\"type\">Camera</span> camera) &#123;</div><div class=\"line\">      <span class=\"title\">oldnow</span> = <span class=\"title\">now</span>;</div><div class=\"line\">      <span class=\"title\">now</span> = <span class=\"title\">System</span>.<span class=\"title\">nanoTime</span>()/1000;</div><div class=\"line\">      <span class=\"title\">if</span> (i++&gt;<span class=\"number\">3</span>) &#123;</div><div class=\"line\">        <span class=\"title\">i</span> = 0;</div><div class=\"line\">        <span class=\"comment\">//Log.d(TAG,\"Measured: \"+1000000L/(now-oldnow)+\" fps.\");</span></div><div class=\"line\">      &#125;</div><div class=\"line\">      <span class=\"title\">try</span> &#123;</div><div class=\"line\">        <span class=\"title\">int</span> <span class=\"title\">bufferIndex</span> = <span class=\"title\">mMediaCodec</span>.<span class=\"title\">dequeueInputBuffer</span>(<span class=\"number\">500000</span>);</div><div class=\"line\">        <span class=\"title\">if</span> (bufferIndex&gt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">          <span class=\"title\">inputBuffers</span>[<span class=\"title\">bufferIndex</span>].<span class=\"title\">clear</span>();</div><div class=\"line\">          <span class=\"title\">convertor</span>.<span class=\"title\">convert</span>(data, inputBuffers[bufferIndex]);</div><div class=\"line\">          <span class=\"title\">mMediaCodec</span>.<span class=\"title\">queueInputBuffer</span>(bufferIndex, <span class=\"number\">0</span>, inputBuffers[bufferIndex].position(), <span class=\"title\">now</span>, 0);</div><div class=\"line\">        &#125; <span class=\"title\">else</span> &#123;</div><div class=\"line\">          <span class=\"title\">Log</span>.<span class=\"title\">e</span>(<span class=\"type\">TAG</span>,\"<span class=\"type\">No</span> buffer available !\");</div><div class=\"line\">        &#125;</div><div class=\"line\">      &#125; <span class=\"title\">finally</span> &#123;</div><div class=\"line\">        <span class=\"title\">mCamera</span>.<span class=\"title\">addCallbackBuffer</span>(data);</div><div class=\"line\">      &#125;\t\t\t\t</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">for</span> (int i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">10</span>;i++) <span class=\"title\">mCamera</span>.<span class=\"title\">addCallbackBuffer</span>(new byte[convertor.getBufferSize()]);</div><div class=\"line\">  <span class=\"title\">mCamera</span>.<span class=\"title\">setPreviewCallbackWithBuffer</span>(callback);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The packetizer encapsulates the bit stream in an RTP stream and send it over the network</span></div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setDestination</span>(mDestination, mRtpPort, mRtcpPort);</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setInputStream</span>(new <span class=\"type\">MediaCodecInputStream</span>(mMediaCodec));</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mStreaming</span> = <span class=\"title\">true</span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">/**</div><div class=\"line\"> * <span class=\"title\">Video</span> <span class=\"title\">encoding</span> <span class=\"title\">is</span> <span class=\"title\">done</span> <span class=\"title\">by</span> <span class=\"title\">a</span> <span class=\"title\">MediaCodec</span>.</div><div class=\"line\"> * <span class=\"title\">But</span> <span class=\"title\">here</span> <span class=\"title\">we</span> <span class=\"title\">will</span> <span class=\"title\">use</span> <span class=\"title\">the</span> <span class=\"title\">buffer</span>-<span class=\"title\">to</span>-<span class=\"title\">surface</span> <span class=\"title\">methode</span></div><div class=\"line\"> */</div><div class=\"line\">@<span class=\"title\">SuppressLint</span>(&#123; \"<span class=\"type\">InlinedApi</span>\", \"<span class=\"type\">NewApi</span>\" &#125;)</div><div class=\"line\"><span class=\"title\">protected</span> <span class=\"title\">void</span> <span class=\"title\">encodeWithMediaCodecMethod2</span>() <span class=\"title\">throws</span> <span class=\"title\">RuntimeException</span>, <span class=\"title\">IOException</span> &#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">Log</span>.<span class=\"title\">d</span>(<span class=\"type\">TAG</span>,\"<span class=\"type\">Video</span> encoded using the <span class=\"type\">MediaCodec</span> <span class=\"type\">API</span> with a surface\");</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Updates the parameters of the camera if needed</span></div><div class=\"line\">  <span class=\"title\">createCamera</span>();</div><div class=\"line\">  <span class=\"title\">updateCamera</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Estimates the framerate of the camera</span></div><div class=\"line\">  <span class=\"title\">measureFramerate</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">EncoderDebugger</span> <span class=\"title\">debugger</span> = <span class=\"title\">EncoderDebugger</span>.<span class=\"title\">debug</span>(mSettings, mQuality.resX, mQuality.resY);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mMediaCodec</span> = <span class=\"title\">MediaCodec</span>.<span class=\"title\">createByCodecName</span>(debugger.getEncoderName());</div><div class=\"line\">  <span class=\"title\">MediaFormat</span> <span class=\"title\">mediaFormat</span> = <span class=\"title\">MediaFormat</span>.<span class=\"title\">createVideoFormat</span>(\"video/avc\", mQuality.resX, mQuality.resY);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_BIT_RATE</span>, mQuality.bitrate);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_FRAME_RATE</span>, mQuality.framerate);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_COLOR_FORMAT</span>, <span class=\"type\">MediaCodecInfo</span>.<span class=\"type\">CodecCapabilities</span>.<span class=\"type\">COLOR_FormatSurface</span>);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_I_FRAME_INTERVAL</span>, <span class=\"number\">1</span>);</div><div class=\"line\">  <span class=\"title\">mMediaCodec</span>.<span class=\"title\">configure</span>(mediaFormat, null, null, <span class=\"type\">MediaCodec</span>.<span class=\"type\">CONFIGURE_FLAG_ENCODE</span>);</div><div class=\"line\">  <span class=\"title\">Surface</span> <span class=\"title\">surface</span> = <span class=\"title\">mMediaCodec</span>.<span class=\"title\">createInputSurface</span>();</div><div class=\"line\">  ((<span class=\"type\">SurfaceView</span>)<span class=\"title\">mSurfaceView</span>).<span class=\"title\">addMediaCodecSurface</span>(surface);</div><div class=\"line\">  <span class=\"title\">mMediaCodec</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The packetizer encapsulates the bit stream in an RTP stream and send it over the network</span></div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setDestination</span>(mDestination, mRtpPort, mRtcpPort);</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setInputStream</span>(new <span class=\"type\">MediaCodecInputStream</span>(mMediaCodec));</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mStreaming</span> = <span class=\"title\">true</span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到，整体实现有2个方式：</p>\n<ol>\n<li>MediaRecorder采集数据，通过绑定LocalSocket来获取数据</li>\n<li>利用Camera又分了2种方式：回调<code>onPreviewFrame</code>获取数据进行处理，或者直接输出到<code>Surface</code></li>\n</ol>\n<p>这与之前说到的不谋而合。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>通过绑定LocalSocket的方式，我在运行（MI 4LTE Android 6.0.1）的时候出现了<code>MediaRecorder: start failed -38</code>的错误。经过Google，后面找到<a href=\"http://stackoverflow.com/questions/26990816/mediarecorder-issue-on-android-lollipop/27118142#27118142\" target=\"_blank\" rel=\"external\">解决方案</a>，setOutputFile时使用<code>ParcelFileDescriptor</code>。作者也在<a href=\"https://github.com/fyhertz/libstreaming\" target=\"_blank\" rel=\"external\">spydroid libstreaming</a>中提到了，并进行了修正。于是我拷贝最新的<code>libstreaming</code>到工程中，运行的依然出错：MediaRecorder: start failed -2147483648，这下我没招了QAQ。<br>后面想到<code>github issues</code>或许也有别人用的时候有这个问题呢，于是我便去看看。但是很不幸，说是在Android 5.0之后不能用MediaRecorder绑定LocalSocket的方式了==&gt;<a href=\"https://github.com/fyhertz/libstreaming/issues/227\" target=\"_blank\" rel=\"external\">issues#227</a>、<a href=\"https://github.com/fyhertz/libstreaming/issues/208\" target=\"_blank\" rel=\"external\">issues208</a>、<a href=\"https://github.com/fyhertz/libstreaming/issues/155\" target=\"_blank\" rel=\"external\">issues#155</a>。<br>毕竟是好几年前的库了，之前Android都没出到5、6呢，后面作者也没有进行维护了，不过我在OPPA A31（Android 4.4.4）的环境下通过此种方式确实可以运行。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://www.cnblogs.com/skyseraph/archive/2012/03/23/2415018.html\" target=\"_blank\" rel=\"external\">Android 实时视频采集/编码/传输/解码/播放—方案调研（初）</a><br><a href=\"http://www.cnblogs.com/skyseraph/archive/2012/03/31/2427593.html\" target=\"_blank\" rel=\"external\">Android 实时视频采集—MediaRecoder录制</a><br><a href=\"https://github.com/fyhertz/libstreaming\" target=\"_blank\" rel=\"external\">libstreaming</a><br><a href=\"https://github.com/fyhertz/spydroid-ipcamera\" target=\"_blank\" rel=\"external\">spydroid-ipcamera</a><br><a href=\"https://github.com/fyhertz/libstreaming-examples\" target=\"_blank\" rel=\"external\">libstreaming-examples</a></p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>通过我的上一篇文章，可以知道直播大致有几个步骤：音视频采集 -&gt; 美颜/滤镜/特效处理 -&gt; 编码 -&gt; 封包 -&gt; 推流 -&gt; 分发 -&gt; 解码/渲染/播放。那么首先便从采集开始，这里我先做的视频采集。<br>那么实时采集视频有哪些方案呢？</p>\n<h2 id=\"调研\"><a href=\"#调研\" class=\"headerlink\" title=\"调研\"></a>调研</h2><p>通过各种调研，查阅文章，了解到目前Android实时采集视频大致有3种方式：</p>\n<ol>\n<li>通过Android Camera拍摄预览中设置setPreviewCallback实现onPreviewFrame接口，实时截取每一帧视频流数据</li>\n<li>通过通过Android的MediaRecorder，在SetoutputFile函数中绑定LocalSocket实现</li>\n<li>流媒体服务器方式，利用ffmpeg或GetStreamer等获取Camera视频</li>\n</ol>\n<p>通过学习，大致了解了1，2两种方式的实现方式，但是对于第3种方式，暂时没有研究。</p>","more":"<h2 id=\"spydroid\"><a href=\"#spydroid\" class=\"headerlink\" title=\"spydroid\"></a>spydroid</h2><p>当我们在接触一个全新领域的时候，最希望的是能实实在在看到一个demo产品，通过demo产品我们更容易理解其内在的原理。在网上看到了许多的开源项目，最后选择了<a href=\"https://github.com/fyhertz/spydroid-ipcamera\">spydroid</a>，感觉它跟Android结合更紧密。更多的信息可以参考<a href=\"http://www.smarting.me/android-video-caputure.html\">Android视频采集方案总结</a>。</p>\n<h3 id=\"拷贝工程\"><a href=\"#拷贝工程\" class=\"headerlink\" title=\"拷贝工程\"></a>拷贝工程</h3><p>通过github看到的项目是Eclipse结构，这里我把代码拷贝下来后，通过AS打开，配置一些信息后项目结构如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video1.png\" alt=\"\"></p>\n<p><a href=\"https://github.com/fyhertz/libstreaming\">streaming</a>是作者封装的一套库。</p>\n<blockquote>\n<p>A solution for streaming H.264, H.263, AMR, AAC using RTP on Android</p>\n</blockquote>\n<h3 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h3><p>项目拷贝到AS后，有部分错误，修复后成功运行在MI 4LTE。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video2.png\" alt=\"\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video3.png\" alt=\"\"><br>它可以通过http，也可以通过rtsp进行推流，打开rtsp推流的开关，首页会多了一个VLC的地址。<br>我在Win 10上使用Chrome接收失败，打开网站后Connect一直连不上。所以采取的VLC方式。<br>打开VLC输入首页提示的地址，即可看到推流成功了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video4.png\" alt=\"\"><br>demo跑通后，便有了一个直观的感受，接下来便是看代码了。</p>\n<h3 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h3><p>从<code>SpydroidActivity</code>开始，会看到它连接了一个Service：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> ServiceConnection mRtspServiceConnection = <span class=\"keyword\">new</span> ServiceConnection() &#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onServiceConnected</span><span class=\"params\">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class=\"line\">\t\tmRtspServer = (CustomRtspServer) ((RtspServer.LocalBinder)service).getService();</div><div class=\"line\">\t\tmRtspServer.addCallbackListener(mRtspCallbackListener);</div><div class=\"line\">\t\tmRtspServer.start();</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onServiceDisconnected</span><span class=\"params\">(ComponentName name)</span> </span>&#123;&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure></p>\n<p>看到<code>RtspServer</code>中的start方法：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">if</span> (!mEnabled || mRestart) stop();</div><div class=\"line\">\t<span class=\"keyword\">if</span> (mEnabled &amp;&amp; mListenerThread == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tmListenerThread = <span class=\"keyword\">new</span> RequestListener();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">\t\t\tmListenerThread = <span class=\"keyword\">null</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tmRestart = <span class=\"keyword\">false</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>再看到<code>RequestListener</code>：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RequestListener</span> <span class=\"keyword\">extends</span> <span class=\"title\">Thread</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ServerSocket mServer;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RequestListener</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tmServer = <span class=\"keyword\">new</span> ServerSocket(mPort);</div><div class=\"line\">\t\t\tstart();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (BindException e) &#123;</div><div class=\"line\">\t\t\tLog.e(TAG,<span class=\"string\">\"Port already in use !\"</span>);</div><div class=\"line\">\t\t\tpostError(e, ERROR_BIND_FAILED);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\tLog.i(TAG,<span class=\"string\">\"RTSP server listening on port \"</span>+mServer.getLocalPort());</div><div class=\"line\">\t\t<span class=\"keyword\">while</span> (!Thread.interrupted()) &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> WorkerThread(mServer.accept()).start();</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (SocketException e) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">\t\t\t\tLog.e(TAG,e.getMessage());</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tLog.i(TAG,<span class=\"string\">\"RTSP server stopped !\"</span>);</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">kill</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tmServer.close();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">this</span>.join();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (InterruptedException ignore) &#123;&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这是一个进程类，在构造方法中直接调用了Thread.start()，那么便会执行到run()方法。可以看到，初始化了一个ServerSocket，然后当有客户端连接后（通过VLC输入地址开始播放即是连接到这个ServerSocket），便会执行<code>WorkerThread</code>线程：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div></pre></td><td class=\"code\"><pre><div class=\"line\">class WorkerThread extends Thread implements Runnable &#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Socket mClient;</div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">final</span> OutputStream mOutput;</div><div class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">BufferedReader</span> mInput;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">// Each client has an associated session</span></div><div class=\"line\">\t<span class=\"keyword\">private</span> Session mSession;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> WorkerThread(<span class=\"keyword\">final</span> Socket client) <span class=\"keyword\">throws</span> IOException &#123;</div><div class=\"line\">\t\tmInput = <span class=\"keyword\">new</span> <span class=\"keyword\">BufferedReader</span>(<span class=\"keyword\">new</span> InputStreamReader(client.getInputStream()));</div><div class=\"line\">\t\tmOutput = client.getOutputStream();</div><div class=\"line\">\t\tmClient = client;</div><div class=\"line\">\t\tmSession = <span class=\"keyword\">new</span> Session();</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> run() &#123;</div><div class=\"line\">\t\tRequest request;</div><div class=\"line\">\t\tResponse response;</div><div class=\"line\"></div><div class=\"line\">\t\tLog.i(TAG, <span class=\"string\">\"Connection from \"</span>+mClient.getInetAddress().getHostAddress());</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">while</span> (!Thread.interrupted()) &#123;</div><div class=\"line\"></div><div class=\"line\">\t\t\trequest = <span class=\"keyword\">null</span>;</div><div class=\"line\">\t\t\tresponse = <span class=\"keyword\">null</span>;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\">// Parse the request</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\trequest = Request.parseRequest(mInput);</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (SocketException e) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"comment\">// Client has left</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"comment\">// We don't understand the request :/</span></div><div class=\"line\">\t\t\t\tresponse = <span class=\"keyword\">new</span> Response();</div><div class=\"line\">\t\t\t\tresponse.status = Response.STATUS_BAD_REQUEST;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\">// Do something accordingly like starting the streams, sending a session description</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (request != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\t\tresponse = processRequest(request);</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">\t\t\t\t\t<span class=\"comment\">// This alerts the main thread that something has gone wrong in this thread</span></div><div class=\"line\">\t\t\t\t\tpostError(e, ERROR_START_FAILED);</div><div class=\"line\">\t\t\t\t\tLog.e(TAG,e.getMessage()!=<span class=\"keyword\">null</span>?e.getMessage():<span class=\"string\">\"An error occurred\"</span>);</div><div class=\"line\">\t\t\t\t\te.printStackTrace();</div><div class=\"line\">\t\t\t\t\tresponse = <span class=\"keyword\">new</span> Response(request);</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\">// We always send a response</span></div><div class=\"line\">\t\t\t<span class=\"comment\">// The client will receive an \"INTERNAL SERVER ERROR\" if an exception has been thrown at some point</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\tresponse.send(mOutput);</div><div class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">\t\t\t\tLog.e(TAG,<span class=\"string\">\"Response was not sent properly\"</span>);</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">// Streaming stops when client disconnects</span></div><div class=\"line\">\t\t<span class=\"built_in\">boolean</span> streaming = isStreaming();</div><div class=\"line\">\t\tmSession.syncStop();</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> (streaming &amp;&amp; !isStreaming()) &#123;</div><div class=\"line\">\t\t\tpostMessage(MESSAGE_STREAMING_STOPPED);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\tmSession.release();</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tmClient.close();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IOException ignore) &#123;&#125;</div><div class=\"line\"></div><div class=\"line\">\t\tLog.i(TAG, <span class=\"string\">\"Client disconnected\"</span>);</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> Response processRequest(Request request) <span class=\"keyword\">throws</span> IllegalStateException, IOException &#123;</div><div class=\"line\">\t\tResponse response = <span class=\"keyword\">new</span> Response(request);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">//Ask for authorization unless this is an OPTIONS request</span></div><div class=\"line\">        <span class=\"keyword\">if</span>(!isAuthorized(request) &amp;&amp; !request.method.equalsIgnoreCase(<span class=\"string\">\"OPTIONS\"</span>))</div><div class=\"line\">        &#123;</div><div class=\"line\">            response.attributes = <span class=\"string\">\"WWW-Authenticate: Basic realm=\\\"\"</span>+SERVER_NAME+<span class=\"string\">\"\\\"\\r\\n\"</span>;</div><div class=\"line\">            response.status = Response.STATUS_UNAUTHORIZED;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span></div><div class=\"line\">        &#123;</div><div class=\"line\">\t\t    <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">\t\t    <span class=\"comment\">/* ********************************* Method DESCRIBE ******************************** */</span></div><div class=\"line\">\t\t    <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"DESCRIBE\"</span>)) &#123;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">// Parse the requested URI and configure the session</span></div><div class=\"line\">                mSession = handleRequest(request.uri, mClient);</div><div class=\"line\">                mSessions.put(mSession, <span class=\"keyword\">null</span>);</div><div class=\"line\">                mSession.syncConfigure();</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">String</span> requestContent = mSession.getSessionDescription();</div><div class=\"line\">                <span class=\"keyword\">String</span> requestAttributes =</div><div class=\"line\">                        <span class=\"string\">\"Content-Base: \"</span> + mClient.getLocalAddress().getHostAddress() + <span class=\"string\">\":\"</span> + mClient.getLocalPort() + <span class=\"string\">\"/\\r\\n\"</span> +</div><div class=\"line\">                                <span class=\"string\">\"Content-Type: application/sdp\\r\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">                response.attributes = requestAttributes;</div><div class=\"line\">                response.content = requestContent;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">// If no exception has been thrown, we reply with OK</span></div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************* Method OPTIONS ********************************* */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"OPTIONS\"</span>)) &#123;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\">                response.attributes = <span class=\"string\">\"Public: DESCRIBE,SETUP,TEARDOWN,PLAY,PAUSE\\r\\n\"</span>;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************** Method SETUP ********************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"SETUP\"</span>)) &#123;</div><div class=\"line\">                Pattern p;</div><div class=\"line\">                Matcher m;</div><div class=\"line\">                <span class=\"built_in\">int</span> p2, p1, ssrc, trackId, src[];</div><div class=\"line\">                <span class=\"keyword\">String</span> destination;</div><div class=\"line\"></div><div class=\"line\">                p = Pattern.compile(<span class=\"string\">\"trackID=(\\\\w+)\"</span>, Pattern.CASE_INSENSITIVE);</div><div class=\"line\">                m = p.matcher(request.uri);</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">if</span> (!m.find()) &#123;</div><div class=\"line\">                    response.status = Response.STATUS_BAD_REQUEST;</div><div class=\"line\">                    <span class=\"keyword\">return</span> response;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                trackId = Integer.parseInt(m.group(<span class=\"number\">1</span>));</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">if</span> (!mSession.trackExists(trackId)) &#123;</div><div class=\"line\">                    response.status = Response.STATUS_NOT_FOUND;</div><div class=\"line\">                    <span class=\"keyword\">return</span> response;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                p = Pattern.compile(<span class=\"string\">\"client_port=(\\\\d+)-(\\\\d+)\"</span>, Pattern.CASE_INSENSITIVE);</div><div class=\"line\">                m = p.matcher(request.headers.<span class=\"built_in\">get</span>(<span class=\"string\">\"transport\"</span>));</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">if</span> (!m.find()) &#123;</div><div class=\"line\">                    <span class=\"built_in\">int</span>[] ports = mSession.getTrack(trackId).getDestinationPorts();</div><div class=\"line\">                    p1 = ports[<span class=\"number\">0</span>];</div><div class=\"line\">                    p2 = ports[<span class=\"number\">1</span>];</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    p1 = Integer.parseInt(m.group(<span class=\"number\">1</span>));</div><div class=\"line\">                    p2 = Integer.parseInt(m.group(<span class=\"number\">2</span>));</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                ssrc = mSession.getTrack(trackId).getSSRC();</div><div class=\"line\">                src = mSession.getTrack(trackId).getLocalPorts();</div><div class=\"line\">                destination = mSession.getDestination();</div><div class=\"line\"></div><div class=\"line\">                mSession.getTrack(trackId).setDestinationPorts(p1, p2);</div><div class=\"line\"></div><div class=\"line\">                <span class=\"built_in\">boolean</span> streaming = isStreaming();</div><div class=\"line\">                mSession.syncStart(trackId);</div><div class=\"line\">                <span class=\"keyword\">if</span> (!streaming &amp;&amp; isStreaming()) &#123;</div><div class=\"line\">                    postMessage(MESSAGE_STREAMING_STARTED);</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                response.attributes = <span class=\"string\">\"Transport: RTP/AVP/UDP;\"</span> + (InetAddress.getByName(destination).isMulticastAddress() ? <span class=\"string\">\"multicast\"</span> : <span class=\"string\">\"unicast\"</span>) +</div><div class=\"line\">                        <span class=\"string\">\";destination=\"</span> + mSession.getDestination() +</div><div class=\"line\">                        <span class=\"string\">\";client_port=\"</span> + p1 + <span class=\"string\">\"-\"</span> + p2 +</div><div class=\"line\">                        <span class=\"string\">\";server_port=\"</span> + src[<span class=\"number\">0</span>] + <span class=\"string\">\"-\"</span> + src[<span class=\"number\">1</span>] +</div><div class=\"line\">                        <span class=\"string\">\";ssrc=\"</span> + Integer.toHexString(ssrc) +</div><div class=\"line\">                        <span class=\"string\">\";mode=play\\r\\n\"</span> +</div><div class=\"line\">                        <span class=\"string\">\"Session: \"</span> + <span class=\"string\">\"1185d20035702ca\"</span> + <span class=\"string\">\"\\r\\n\"</span> +</div><div class=\"line\">                        <span class=\"string\">\"Cache-Control: no-cache\\r\\n\"</span>;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">// If no exception has been thrown, we reply with OK</span></div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************** Method PLAY *********************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"PLAY\"</span>)) &#123;</div><div class=\"line\">                <span class=\"keyword\">String</span> requestAttributes = <span class=\"string\">\"RTP-Info: \"</span>;</div><div class=\"line\">                <span class=\"keyword\">if</span> (mSession.trackExists(<span class=\"number\">0</span>))</div><div class=\"line\">                    requestAttributes += <span class=\"string\">\"url=rtsp://\"</span> + mClient.getLocalAddress().getHostAddress() + <span class=\"string\">\":\"</span> + mClient.getLocalPort() + <span class=\"string\">\"/trackID=\"</span> + <span class=\"number\">0</span> + <span class=\"string\">\";seq=0,\"</span>;</div><div class=\"line\">                <span class=\"keyword\">if</span> (mSession.trackExists(<span class=\"number\">1</span>))</div><div class=\"line\">                    requestAttributes += <span class=\"string\">\"url=rtsp://\"</span> + mClient.getLocalAddress().getHostAddress() + <span class=\"string\">\":\"</span> + mClient.getLocalPort() + <span class=\"string\">\"/trackID=\"</span> + <span class=\"number\">1</span> + <span class=\"string\">\";seq=0,\"</span>;</div><div class=\"line\">                requestAttributes = requestAttributes.substring(<span class=\"number\">0</span>, requestAttributes.length() - <span class=\"number\">1</span>) + <span class=\"string\">\"\\r\\nSession: 1185d20035702ca\\r\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">                response.attributes = requestAttributes;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">// If no exception has been thrown, we reply with OK</span></div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************** Method PAUSE ********************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"PAUSE\"</span>)) &#123;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************* Method TEARDOWN ******************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (request.method.equalsIgnoreCase(<span class=\"string\">\"TEARDOWN\"</span>)) &#123;</div><div class=\"line\">                response.status = Response.STATUS_OK;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************* Unknown method ? ******************************* */</span></div><div class=\"line\">            <span class=\"comment\">/* ********************************************************************************** */</span></div><div class=\"line\">            <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                Log.e(TAG, <span class=\"string\">\"Command unknown: \"</span> + request);</div><div class=\"line\">                response.status = Response.STATUS_BAD_REQUEST;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> response;</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * Check if the request is authorized</div><div class=\"line\">     * @param request</div><div class=\"line\">     * @return true or false</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"built_in\">boolean</span> isAuthorized(Request request)</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"keyword\">String</span> auth = request.headers.<span class=\"built_in\">get</span>(<span class=\"string\">\"authorization\"</span>);</div><div class=\"line\">        <span class=\"keyword\">if</span>(mUsername == <span class=\"keyword\">null</span> || mPassword == <span class=\"keyword\">null</span> || mUsername.isEmpty())</div><div class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span>(auth != <span class=\"keyword\">null</span> &amp;&amp; !auth.isEmpty())</div><div class=\"line\">        &#123;</div><div class=\"line\">            <span class=\"keyword\">String</span> received = auth.substring(auth.lastIndexOf(<span class=\"string\">\" \"</span>)+<span class=\"number\">1</span>);</div><div class=\"line\">            <span class=\"keyword\">String</span> local = mUsername+<span class=\"string\">\":\"</span>+mPassword;</div><div class=\"line\">            <span class=\"keyword\">String</span> localEncoded = Base64.encodeToString(local.getBytes(),Base64.NO_WRAP);</div><div class=\"line\">            <span class=\"keyword\">if</span>(localEncoded.equals(received))</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这个类比较长，但是我只需关注<code>采集</code>。看到<code>processRequest方法</code>，当有Client连接后，便会有session了，然后打印一些配置之类的信息，最后看到<code>mSession.syncStart(trackId)</code>，可以猜测这个方法便是开始采集、推流了。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * Starts a stream in a synchronous manner. &lt;br /&gt;</div><div class=\"line\"> * Throws exceptions in addition to calling a callback.</div><div class=\"line\"> * <span class=\"doctag\">@param</span> id The id of the stream to start</div><div class=\"line\"> **/</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">syncStart</span><span class=\"params\">(<span class=\"keyword\">int</span> id)</span> \t\t\t</div><div class=\"line\">\t\t<span class=\"keyword\">throws</span> CameraInUseException,</div><div class=\"line\">\t\tStorageUnavailableException,</div><div class=\"line\">\t\tConfNotSupportedException,</div><div class=\"line\">\t\tInvalidSurfaceException,</div><div class=\"line\">\t\tUnknownHostException,</div><div class=\"line\">\t\tIOException </span>&#123;</div><div class=\"line\"></div><div class=\"line\">\tStream stream = id==<span class=\"number\">0</span> ? mAudioStream : mVideoStream;</div><div class=\"line\">\t<span class=\"keyword\">if</span> (stream!=<span class=\"keyword\">null</span> &amp;&amp; !stream.isStreaming()) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tInetAddress destination =  InetAddress.getByName(mDestination);</div><div class=\"line\">\t\t\tstream.setTimeToLive(mTimeToLive);</div><div class=\"line\">\t\t\tstream.setDestinationAddress(destination);</div><div class=\"line\">\t\t\tstream.start();</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (getTrack(<span class=\"number\">1</span>-id) == <span class=\"keyword\">null</span> || getTrack(<span class=\"number\">1</span>-id).isStreaming()) &#123;</div><div class=\"line\">\t\t\t\tpostSessionStarted();</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> (getTrack(<span class=\"number\">1</span>-id) == <span class=\"keyword\">null</span> || !getTrack(<span class=\"number\">1</span>-id).isStreaming()) &#123;</div><div class=\"line\">\t\t\t\tmHandler.post(mUpdateBitrate);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (UnknownHostException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_UNKNOWN_HOST, id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (CameraInUseException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_CAMERA_ALREADY_IN_USE , id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (StorageUnavailableException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_STORAGE_NOT_READY , id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (ConfNotSupportedException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_CONFIGURATION_NOT_SUPPORTED , id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (InvalidSurfaceException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_INVALID_SURFACE , id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_OTHER, id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (RuntimeException e) &#123;</div><div class=\"line\">\t\t\tpostError(ERROR_OTHER, id, e);</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> e;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>参数id用来标识是音频，还是视频，最后执行到<code>stream.start()</code>，其调用的是最顶层的Stream实现类<code>MediaStream</code>的start方法。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/** Starts the stream. */</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IllegalStateException, IOException </span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> (mDestination==<span class=\"keyword\">null</span>)</div><div class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">\"No destination ip address set for the stream !\"</span>);</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> (mRtpPort&lt;=<span class=\"number\">0</span> || mRtcpPort&lt;=<span class=\"number\">0</span>)</div><div class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">\"No destination ports set for the stream !\"</span>);</div><div class=\"line\"></div><div class=\"line\">\tmPacketizer.setTimeToLive(mTTL);</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> (mMode != MODE_MEDIARECORDER_API) &#123;</div><div class=\"line\">\t\tencodeWithMediaCodec();</div><div class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">\t\tencodeWithMediaRecorder();</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到，根据Mode选择<code>encodeWithMediaCodec</code>或是<code>encodeWithMediaRecorder</code>。<br>然后看到其继承类的实现方法，这里我只关注了<code>VideoStream</code>的实现。<br><figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * Video encoding is done by a MediaRecorder.</div><div class=\"line\"> */</span></div><div class=\"line\">protected void encodeWithMediaRecorder() throws <span class=\"type\">IOException</span> &#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"type\">Log</span>.d(<span class=\"type\">TAG</span>,<span class=\"string\">\"Video encoded using the MediaRecorder API\"</span>);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// We need a local socket to forward data output by the camera to the packetizer</span></div><div class=\"line\">  createSockets();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Reopens the camera if needed</span></div><div class=\"line\">  destroyCamera();</div><div class=\"line\">  createCamera();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The camera must be unlocked before the MediaRecorder can use it</span></div><div class=\"line\">  unlockCamera();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">    mMediaRecorder = <span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">MediaRecorder</span>();</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setCamera</span>(mCamera);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoSource</span>(<span class=\"type\">MediaRecorder</span>.<span class=\"type\">VideoSource</span>.<span class=\"type\">CAMERA</span>);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setOutputFormat</span>(<span class=\"type\">MediaRecorder</span>.<span class=\"type\">OutputFormat</span>.<span class=\"type\">THREE_GPP</span>);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoEncoder</span>(mVideoEncoder);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setPreviewDisplay</span>(mSurfaceView.getHolder().<span class=\"title\">getSurface</span>());</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoSize</span>(mRequestedQuality.resX,mRequestedQuality.resY);</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoFrameRate</span>(mRequestedQuality.framerate);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// The bandwidth actually consumed is often above what was requested</span></div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setVideoEncodingBitRate</span>((int)(mRequestedQuality.bitrate*<span class=\"number\">0.8</span>));</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// We write the ouput of the camera in a local socket instead of a file !\t\t\t</span></div><div class=\"line\">    <span class=\"comment\">// This one little trick makes streaming feasible quiet simply: data from the camera</span></div><div class=\"line\">    <span class=\"comment\">// can then be manipulated at the other end of the socket</span></div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">setOutputFile</span>(mSender.getFileDescriptor());</div><div class=\"line\"></div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">prepare</span>();</div><div class=\"line\">    <span class=\"title\">mMediaRecorder</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  &#125; <span class=\"title\">catch</span> (<span class=\"type\">Exception</span> e) &#123;</div><div class=\"line\">    <span class=\"title\">throw</span> <span class=\"title\">new</span> <span class=\"title\">ConfNotSupportedException</span>(e.getMessage());</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// This will skip the MPEG4 header if this step fails we can't stream anything :(</span></div><div class=\"line\">  <span class=\"title\">InputStream</span> <span class=\"title\">is</span> = <span class=\"title\">mReceiver</span>.<span class=\"title\">getInputStream</span>();</div><div class=\"line\">  <span class=\"title\">try</span> &#123;</div><div class=\"line\">    <span class=\"title\">byte</span> <span class=\"title\">buffer</span>[] = <span class=\"title\">new</span> <span class=\"title\">byte</span>[4];</div><div class=\"line\">    <span class=\"comment\">// Skip all atoms preceding mdat atom</span></div><div class=\"line\">    <span class=\"title\">while</span> (!<span class=\"type\">Thread</span>.interrupted()) &#123;</div><div class=\"line\">      <span class=\"title\">while</span> (is.read() != '<span class=\"title\">m</span>');</div><div class=\"line\">      <span class=\"title\">is</span>.<span class=\"title\">read</span>(buffer,<span class=\"number\">0</span>,<span class=\"number\">3</span>);</div><div class=\"line\">      <span class=\"title\">if</span> (buffer[<span class=\"number\">0</span>] == 'd' &amp;&amp; buffer[<span class=\"number\">1</span>] == 'a' &amp;&amp; buffer[<span class=\"number\">2</span>] == 't') <span class=\"title\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125; <span class=\"title\">catch</span> (<span class=\"type\">IOException</span> e) &#123;</div><div class=\"line\">    <span class=\"title\">Log</span>.<span class=\"title\">e</span>(<span class=\"type\">TAG</span>,\"<span class=\"type\">Couldn</span>'t skip mp4 header :/\");</div><div class=\"line\">    <span class=\"title\">stop</span>();</div><div class=\"line\">    <span class=\"title\">throw</span> <span class=\"title\">e</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The packetizer encapsulates the bit stream in an RTP stream and send it over the network</span></div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setDestination</span>(mDestination, mRtpPort, mRtcpPort);</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setInputStream</span>(mReceiver.getInputStream());</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mStreaming</span> = <span class=\"title\">true</span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">/**</div><div class=\"line\"> * <span class=\"title\">Video</span> <span class=\"title\">encoding</span> <span class=\"title\">is</span> <span class=\"title\">done</span> <span class=\"title\">by</span> <span class=\"title\">a</span> <span class=\"title\">MediaCodec</span>.</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"title\">protected</span> <span class=\"title\">void</span> <span class=\"title\">encodeWithMediaCodec</span>() <span class=\"title\">throws</span> <span class=\"title\">RuntimeException</span>, <span class=\"title\">IOException</span> &#123;</div><div class=\"line\">  <span class=\"title\">if</span> (mMode == <span class=\"type\">MODE_MEDIACODEC_API_2</span>) &#123;</div><div class=\"line\">    <span class=\"comment\">// Uses the method MediaCodec.createInputSurface to feed the encoder</span></div><div class=\"line\">    <span class=\"title\">encodeWithMediaCodecMethod2</span>();</div><div class=\"line\">  &#125; <span class=\"title\">else</span> &#123;</div><div class=\"line\">    <span class=\"comment\">// Uses dequeueInputBuffer to feed the encoder</span></div><div class=\"line\">    <span class=\"title\">encodeWithMediaCodecMethod1</span>();</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">/**</div><div class=\"line\"> * <span class=\"title\">Video</span> <span class=\"title\">encoding</span> <span class=\"title\">is</span> <span class=\"title\">done</span> <span class=\"title\">by</span> <span class=\"title\">a</span> <span class=\"title\">MediaCodec</span>.</div><div class=\"line\"> */</div><div class=\"line\">@<span class=\"title\">SuppressLint</span>(\"<span class=\"type\">NewApi</span>\")</div><div class=\"line\"><span class=\"title\">protected</span> <span class=\"title\">void</span> <span class=\"title\">encodeWithMediaCodecMethod1</span>() <span class=\"title\">throws</span> <span class=\"title\">RuntimeException</span>, <span class=\"title\">IOException</span> &#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">Log</span>.<span class=\"title\">d</span>(<span class=\"type\">TAG</span>,\"<span class=\"type\">Video</span> encoded using the <span class=\"type\">MediaCodec</span> <span class=\"type\">API</span> with a buffer\");</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Updates the parameters of the camera if needed</span></div><div class=\"line\">  <span class=\"title\">createCamera</span>();</div><div class=\"line\">  <span class=\"title\">updateCamera</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Estimates the framerate of the camera</span></div><div class=\"line\">  <span class=\"title\">measureFramerate</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Starts the preview if needed</span></div><div class=\"line\">  <span class=\"title\">if</span> (!mPreviewStarted) &#123;</div><div class=\"line\">    <span class=\"title\">try</span> &#123;</div><div class=\"line\">      <span class=\"title\">mCamera</span>.<span class=\"title\">startPreview</span>();</div><div class=\"line\">      <span class=\"title\">mPreviewStarted</span> = <span class=\"title\">true</span>;</div><div class=\"line\">    &#125; <span class=\"title\">catch</span> (<span class=\"type\">RuntimeException</span> e) &#123;</div><div class=\"line\">      <span class=\"title\">destroyCamera</span>();</div><div class=\"line\">      <span class=\"title\">throw</span> <span class=\"title\">e</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">EncoderDebugger</span> <span class=\"title\">debugger</span> = <span class=\"title\">EncoderDebugger</span>.<span class=\"title\">debug</span>(mSettings, mQuality.resX, mQuality.resY);</div><div class=\"line\">  <span class=\"title\">final</span> <span class=\"title\">NV21Convertor</span> <span class=\"title\">convertor</span> = <span class=\"title\">debugger</span>.<span class=\"title\">getNV21Convertor</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mMediaCodec</span> = <span class=\"title\">MediaCodec</span>.<span class=\"title\">createByCodecName</span>(debugger.getEncoderName());</div><div class=\"line\">  <span class=\"title\">MediaFormat</span> <span class=\"title\">mediaFormat</span> = <span class=\"title\">MediaFormat</span>.<span class=\"title\">createVideoFormat</span>(\"video/avc\", mQuality.resX, mQuality.resY);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_BIT_RATE</span>, mQuality.bitrate);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_FRAME_RATE</span>, mQuality.framerate);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_COLOR_FORMAT</span>,debugger.getEncoderColorFormat());</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_I_FRAME_INTERVAL</span>, <span class=\"number\">1</span>);</div><div class=\"line\">  <span class=\"title\">mMediaCodec</span>.<span class=\"title\">configure</span>(mediaFormat, null, null, <span class=\"type\">MediaCodec</span>.<span class=\"type\">CONFIGURE_FLAG_ENCODE</span>);</div><div class=\"line\">  <span class=\"title\">mMediaCodec</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">Camera</span>.<span class=\"title\">PreviewCallback</span> <span class=\"title\">callback</span> = <span class=\"title\">new</span> <span class=\"title\">Camera</span>.<span class=\"title\">PreviewCallback</span>() &#123;</div><div class=\"line\">    <span class=\"title\">long</span> <span class=\"title\">now</span> = <span class=\"title\">System</span>.<span class=\"title\">nanoTime</span>()/1000, <span class=\"title\">oldnow</span> = <span class=\"title\">now</span>, <span class=\"title\">i</span>=0;</div><div class=\"line\">    <span class=\"title\">ByteBuffer</span>[] <span class=\"title\">inputBuffers</span> = <span class=\"title\">mMediaCodec</span>.<span class=\"title\">getInputBuffers</span>();</div><div class=\"line\">    @<span class=\"title\">Override</span></div><div class=\"line\">    <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">onPreviewFrame</span>(byte[] data, <span class=\"type\">Camera</span> camera) &#123;</div><div class=\"line\">      <span class=\"title\">oldnow</span> = <span class=\"title\">now</span>;</div><div class=\"line\">      <span class=\"title\">now</span> = <span class=\"title\">System</span>.<span class=\"title\">nanoTime</span>()/1000;</div><div class=\"line\">      <span class=\"title\">if</span> (i++&gt;<span class=\"number\">3</span>) &#123;</div><div class=\"line\">        <span class=\"title\">i</span> = 0;</div><div class=\"line\">        <span class=\"comment\">//Log.d(TAG,\"Measured: \"+1000000L/(now-oldnow)+\" fps.\");</span></div><div class=\"line\">      &#125;</div><div class=\"line\">      <span class=\"title\">try</span> &#123;</div><div class=\"line\">        <span class=\"title\">int</span> <span class=\"title\">bufferIndex</span> = <span class=\"title\">mMediaCodec</span>.<span class=\"title\">dequeueInputBuffer</span>(<span class=\"number\">500000</span>);</div><div class=\"line\">        <span class=\"title\">if</span> (bufferIndex&gt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">          <span class=\"title\">inputBuffers</span>[<span class=\"title\">bufferIndex</span>].<span class=\"title\">clear</span>();</div><div class=\"line\">          <span class=\"title\">convertor</span>.<span class=\"title\">convert</span>(data, inputBuffers[bufferIndex]);</div><div class=\"line\">          <span class=\"title\">mMediaCodec</span>.<span class=\"title\">queueInputBuffer</span>(bufferIndex, <span class=\"number\">0</span>, inputBuffers[bufferIndex].position(), <span class=\"title\">now</span>, 0);</div><div class=\"line\">        &#125; <span class=\"title\">else</span> &#123;</div><div class=\"line\">          <span class=\"title\">Log</span>.<span class=\"title\">e</span>(<span class=\"type\">TAG</span>,\"<span class=\"type\">No</span> buffer available !\");</div><div class=\"line\">        &#125;</div><div class=\"line\">      &#125; <span class=\"title\">finally</span> &#123;</div><div class=\"line\">        <span class=\"title\">mCamera</span>.<span class=\"title\">addCallbackBuffer</span>(data);</div><div class=\"line\">      &#125;\t\t\t\t</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">for</span> (int i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">10</span>;i++) <span class=\"title\">mCamera</span>.<span class=\"title\">addCallbackBuffer</span>(new byte[convertor.getBufferSize()]);</div><div class=\"line\">  <span class=\"title\">mCamera</span>.<span class=\"title\">setPreviewCallbackWithBuffer</span>(callback);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The packetizer encapsulates the bit stream in an RTP stream and send it over the network</span></div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setDestination</span>(mDestination, mRtpPort, mRtcpPort);</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setInputStream</span>(new <span class=\"type\">MediaCodecInputStream</span>(mMediaCodec));</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mStreaming</span> = <span class=\"title\">true</span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">/**</div><div class=\"line\"> * <span class=\"title\">Video</span> <span class=\"title\">encoding</span> <span class=\"title\">is</span> <span class=\"title\">done</span> <span class=\"title\">by</span> <span class=\"title\">a</span> <span class=\"title\">MediaCodec</span>.</div><div class=\"line\"> * <span class=\"title\">But</span> <span class=\"title\">here</span> <span class=\"title\">we</span> <span class=\"title\">will</span> <span class=\"title\">use</span> <span class=\"title\">the</span> <span class=\"title\">buffer</span>-<span class=\"title\">to</span>-<span class=\"title\">surface</span> <span class=\"title\">methode</span></div><div class=\"line\"> */</div><div class=\"line\">@<span class=\"title\">SuppressLint</span>(&#123; \"<span class=\"type\">InlinedApi</span>\", \"<span class=\"type\">NewApi</span>\" &#125;)</div><div class=\"line\"><span class=\"title\">protected</span> <span class=\"title\">void</span> <span class=\"title\">encodeWithMediaCodecMethod2</span>() <span class=\"title\">throws</span> <span class=\"title\">RuntimeException</span>, <span class=\"title\">IOException</span> &#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">Log</span>.<span class=\"title\">d</span>(<span class=\"type\">TAG</span>,\"<span class=\"type\">Video</span> encoded using the <span class=\"type\">MediaCodec</span> <span class=\"type\">API</span> with a surface\");</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Updates the parameters of the camera if needed</span></div><div class=\"line\">  <span class=\"title\">createCamera</span>();</div><div class=\"line\">  <span class=\"title\">updateCamera</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Estimates the framerate of the camera</span></div><div class=\"line\">  <span class=\"title\">measureFramerate</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">EncoderDebugger</span> <span class=\"title\">debugger</span> = <span class=\"title\">EncoderDebugger</span>.<span class=\"title\">debug</span>(mSettings, mQuality.resX, mQuality.resY);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mMediaCodec</span> = <span class=\"title\">MediaCodec</span>.<span class=\"title\">createByCodecName</span>(debugger.getEncoderName());</div><div class=\"line\">  <span class=\"title\">MediaFormat</span> <span class=\"title\">mediaFormat</span> = <span class=\"title\">MediaFormat</span>.<span class=\"title\">createVideoFormat</span>(\"video/avc\", mQuality.resX, mQuality.resY);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_BIT_RATE</span>, mQuality.bitrate);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_FRAME_RATE</span>, mQuality.framerate);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_COLOR_FORMAT</span>, <span class=\"type\">MediaCodecInfo</span>.<span class=\"type\">CodecCapabilities</span>.<span class=\"type\">COLOR_FormatSurface</span>);</div><div class=\"line\">  <span class=\"title\">mediaFormat</span>.<span class=\"title\">setInteger</span>(<span class=\"type\">MediaFormat</span>.<span class=\"type\">KEY_I_FRAME_INTERVAL</span>, <span class=\"number\">1</span>);</div><div class=\"line\">  <span class=\"title\">mMediaCodec</span>.<span class=\"title\">configure</span>(mediaFormat, null, null, <span class=\"type\">MediaCodec</span>.<span class=\"type\">CONFIGURE_FLAG_ENCODE</span>);</div><div class=\"line\">  <span class=\"title\">Surface</span> <span class=\"title\">surface</span> = <span class=\"title\">mMediaCodec</span>.<span class=\"title\">createInputSurface</span>();</div><div class=\"line\">  ((<span class=\"type\">SurfaceView</span>)<span class=\"title\">mSurfaceView</span>).<span class=\"title\">addMediaCodecSurface</span>(surface);</div><div class=\"line\">  <span class=\"title\">mMediaCodec</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The packetizer encapsulates the bit stream in an RTP stream and send it over the network</span></div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setDestination</span>(mDestination, mRtpPort, mRtcpPort);</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">setInputStream</span>(new <span class=\"type\">MediaCodecInputStream</span>(mMediaCodec));</div><div class=\"line\">  <span class=\"title\">mPacketizer</span>.<span class=\"title\">start</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"title\">mStreaming</span> = <span class=\"title\">true</span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</span></div></pre></td></tr></table></figure></p>\n<p>可以看到，整体实现有2个方式：</p>\n<ol>\n<li>MediaRecorder采集数据，通过绑定LocalSocket来获取数据</li>\n<li>利用Camera又分了2种方式：回调<code>onPreviewFrame</code>获取数据进行处理，或者直接输出到<code>Surface</code></li>\n</ol>\n<p>这与之前说到的不谋而合。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>通过绑定LocalSocket的方式，我在运行（MI 4LTE Android 6.0.1）的时候出现了<code>MediaRecorder: start failed -38</code>的错误。经过Google，后面找到<a href=\"http://stackoverflow.com/questions/26990816/mediarecorder-issue-on-android-lollipop/27118142#27118142\">解决方案</a>，setOutputFile时使用<code>ParcelFileDescriptor</code>。作者也在<a href=\"https://github.com/fyhertz/libstreaming\">spydroid libstreaming</a>中提到了，并进行了修正。于是我拷贝最新的<code>libstreaming</code>到工程中，运行的依然出错：MediaRecorder: start failed -2147483648，这下我没招了QAQ。<br>后面想到<code>github issues</code>或许也有别人用的时候有这个问题呢，于是我便去看看。但是很不幸，说是在Android 5.0之后不能用MediaRecorder绑定LocalSocket的方式了==&gt;<a href=\"https://github.com/fyhertz/libstreaming/issues/227\">issues#227</a>、<a href=\"https://github.com/fyhertz/libstreaming/issues/208\">issues208</a>、<a href=\"https://github.com/fyhertz/libstreaming/issues/155\">issues#155</a>。<br>毕竟是好几年前的库了，之前Android都没出到5、6呢，后面作者也没有进行维护了，不过我在OPPA A31（Android 4.4.4）的环境下通过此种方式确实可以运行。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://www.cnblogs.com/skyseraph/archive/2012/03/23/2415018.html\">Android 实时视频采集/编码/传输/解码/播放—方案调研（初）</a><br><a href=\"http://www.cnblogs.com/skyseraph/archive/2012/03/31/2427593.html\">Android 实时视频采集—MediaRecoder录制</a><br><a href=\"https://github.com/fyhertz/libstreaming\">libstreaming</a><br><a href=\"https://github.com/fyhertz/spydroid-ipcamera\">spydroid-ipcamera</a><br><a href=\"https://github.com/fyhertz/libstreaming-examples\">libstreaming-examples</a></p>"},{"title":"【Android音视频开发】- 实时采集音频并编码","date":"2016-10-22T01:54:26.000Z","_content":"\n## 前言\n通过我的上一篇文章，利用Camera实时采集视频，并用MediaCodec编码，可以得到YUV、H264文件了。那么接下来便是采集音频并编码了。\n\n## 基础概念\n在音频开发中，有一些基础的概念是必须要知道的。\n### 采样率（samplerate）\n采样就是把模拟信号数字化的过程，不仅仅是音频需要采样，所有的模拟信号都需要通过采样转换为可以用0101来表示的数字信号，示意图如下所示：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video6.png)\n蓝色代表模拟音频信号，红色的点代表采样得到的量化数值。采样频率越高，红色的间隔就越密集，记录这一段音频信号所用的数据量就越大，同时音频质量也就越高。根据奈奎斯特理论，采样频率只要不低于音频信号最高频率的两倍，就可以无损失地还原原始的声音。通常人耳能听到频率范围大约在20Hz～20kHz之间的声音，为了保证声音不失真，采样频率应在40kHz以上。常用的音频采样频率有：8kHz、11.025kHz、22.05kHz、16kHz、37.8kHz、44.1kHz、48kHz、96kHz、192kHz等。\n\n### 量化精度（位宽）\n上图中，每一个红色的采样点，都需要用一个数值来表示大小，这个数值的数据类型大小可以是：4bit、8bit、16bit、32bit等等，位数越多，表示得就越精细，声音质量自然就越好，当然，数据量也会成倍增大。常见的位宽是：8bit 或者 16bit。\n\n### 声道数（channels）\n由于音频的采集和播放是可以叠加的，因此，可以同时从多个音频源采集声音，并分别输出到不同的扬声器，故声道数一般表示声音录制时的音源数量或回放时相应的扬声器数量。单声道（Mono）和双声道（Stereo）比较常见，顾名思义，前者的声道数为1，后者为2。\n\n### 音频帧（frame）\n音频数据是流式的，本身并没有明确的一帧帧的概念，在实际的应用中，为了音频算法处理/传输的方便，一般约定俗成取 2.5 ms ~ 60 ms为单位的数据量为一帧音频。 这个时间被称之为“采样时间”，其长度没有特别的标准。我们可以计算一下一帧音频帧的大小。假设某通道的音频信号是采样率为 8 kHz，位宽为16 bit，20 ms 一帧，双通道，则一帧音频数据的大小为：\n```\nint size = 8000 x 16bit x 0.02s  x 2 = 5120 bit = 640 byte\n```\n\n<!-- more -->\n\n## 采集\n> Android SDK 提供了两套音频采集的API，分别是：MediaRecorder 和 AudioRecord，前者是一个更加上层一点的API，它可以直接把手机麦克风录入的音频数据进行编码压缩（如AMR、MP3等）并存成文件，而后者则更接近底层，能够更加自由灵活地控制，可以得到原始的一帧帧PCM音频数据。如果想简单地做一个录音机，录制成音频文件，则推荐使用 MediaRecorder，而如果需要对音频做进一步的算法处理、或者采用第三方的编码库进行压缩、以及网络传输等应用，则建议使用 AudioRecord，其实 MediaRecorder 底层也是调用了 AudioRecord 与 Android Framework 层的 AudioFlinger 进行交互的。\n\n由上可知，在直播中实时采集音频自然是要用``AudioRecord``了。\n\n## 编码\n通过``AudioRecord``我们可以获取到原始的PCM数据了，接下来就是利用``MediaCodec``来进行编码成AAC数据了。\n\n## 示例代码\n变量声明：\n```\nprivate static final int DEFAULT_SOURCE = MediaRecorder.AudioSource.MIC;            // 麦克风\nprivate static final int DEFAULT_SAMPLE_RATE = 44100;                               // 44.1KHz采样率\nprivate static final int DEFAULT_CHANNEL_CONFIG = AudioFormat.CHANNEL_IN_STEREO;    // 立体声\nprivate static final int DEFAULT_AUDIO_FORMAT = AudioFormat.ENCODING_PCM_16BIT;     // 16位宽\nprivate static final int DEFAULT_BIT_RATE = 32000;                                  // 比特率\nprivate static final String AAC_MIME = \"audio/mp4a-latm\";                           // AAC编码\n```\n初始化AudioRecord：\n```\n/**\n * 初始化AudioRecord\n *\n * @return\n */\nprivate boolean initAudioRecord() {\n    if (mIsCaptureStarted) {\n        Log.e(TAG, \"Capture already started !\");\n        return false;\n    }\n\n    mMinBufferSize = AudioRecord.getMinBufferSize(DEFAULT_SAMPLE_RATE, DEFAULT_CHANNEL_CONFIG, DEFAULT_AUDIO_FORMAT);\n    if (mMinBufferSize == AudioRecord.ERROR_BAD_VALUE) {\n        Log.e(TAG, \"Invalid parameter !\");\n        return false;\n    }\n    Log.d(TAG, \"getMinBufferSize = \" + mMinBufferSize + \" bytes !\");\n\n    mAudioRecord = new AudioRecord(DEFAULT_SOURCE, DEFAULT_SAMPLE_RATE, DEFAULT_CHANNEL_CONFIG, DEFAULT_AUDIO_FORMAT, mMinBufferSize);\n    if (mAudioRecord.getState() == AudioRecord.STATE_UNINITIALIZED) {\n        Log.e(TAG, \"AudioRecord initialize fail !\");\n        return false;\n    }\n    return true;\n}\n```\n初始化MediaCodec：\n```\n/**\n * 初始化MediaCodec\n */\nprivate void initMediaCodec() {\n    try {\n        mMediaCodec = MediaCodec.createEncoderByType(AAC_MIME);\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n    MediaFormat format = new MediaFormat();\n    format.setString(MediaFormat.KEY_MIME, AAC_MIME);\n    format.setInteger(MediaFormat.KEY_BIT_RATE, DEFAULT_BIT_RATE);\n    format.setInteger(MediaFormat.KEY_CHANNEL_COUNT, 2);\n    format.setInteger(MediaFormat.KEY_SAMPLE_RATE, DEFAULT_SAMPLE_RATE);\n    format.setInteger(MediaFormat.KEY_AAC_PROFILE, MediaCodecInfo.CodecProfileLevel.AACObjectLC);\n    format.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, mMinBufferSize * 2);\n    mMediaCodec.configure(format, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);\n    mAudioRecord.startRecording();\n    mMediaCodec.start();\n}\n```\n调用``mAudioRecord.startRecording()``开始采集，并启动线程从AudioRecord获取数据，最后调用``mAudioRecord.stop();``停止采集。\n```\nprivate class AudioCaptureRunnable implements Runnable {\n    @Override\n    public void run() {\n        while (!mIsLoopExit) {\n            byte[] buffer = new byte[mMinBufferSize];\n            int ret = mAudioRecord.read(buffer, 0, mMinBufferSize);\n            if (ret == AudioRecord.ERROR_INVALID_OPERATION) {\n                Log.e(TAG, \"Error ERROR_INVALID_OPERATION\");\n            } else if (ret == AudioRecord.ERROR_BAD_VALUE) {\n                Log.e(TAG, \"Error ERROR_BAD_VALUE\");\n            } else {\n                Log.d(TAG, \"OK, Captured \" + ret + \" bytes !\");\n                Util.save(buffer, 0, buffer.length, pcmPath, true);\n                ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();\n                ByteBuffer[] outputBuffers = mMediaCodec.getOutputBuffers();\n                int inputBufferIndex = mMediaCodec.dequeueInputBuffer(-1);\n                if (inputBufferIndex >= 0) {\n                    ByteBuffer inputBuffer = inputBuffers[inputBufferIndex];\n                    inputBuffer.clear();\n                    inputBuffer.put(buffer);\n                    mMediaCodec.queueInputBuffer(inputBufferIndex, 0, buffer.length,\n                            System.nanoTime(), 0);\n                }\n                MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo();\n                int outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, 0);\n                while (outputBufferIndex >= 0) {\n                    ByteBuffer outputBuffer = outputBuffers[outputBufferIndex];\n\n                    outputBuffer.position(bufferInfo.offset);\n                    outputBuffer.limit(bufferInfo.offset + bufferInfo.size);\n\n                    byte[] outData = new byte[bufferInfo.size + 7];\n\n                    addADTStoPacket(outData, bufferInfo.size + 7);\n\n                    outputBuffer.get(outData, 7, bufferInfo.size);\n\n                    outputBuffer.position(bufferInfo.offset);\n\n\n                    Util.save(outData, 0, outData.length, aacPath, true);\n\n                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, false);\n                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, 0);\n                }\n            }\n        }\n    }\n}\n```\n核心代码便是这些了，运行程序后最后会生成PCM、AAC文件，将AAC文件用VLC打开也是可以播放的。\n\n[工程代码示例](https://github.com/LiJia92/spydroid-ipcamera)\n\n## ADTS\n可以看到上述代码中有``addADTStoPacket``这个方法：\n```\n/**\n * Add ADTS header at the beginning of each and every AAC packet.\n * This is needed as MediaCodec encoder generates a packet of raw\n * AAC data.\n * <p>\n * Note the packetLen must count in the ADTS header itself.\n **/\nprivate void addADTStoPacket(byte[] packet, int packetLen) {\n    int profile = 2;  //AAC LC\n    //39=MediaCodecInfo.CodecProfileLevel.AACObjectELD;\n    int freqIdx = 4;  //44.1KHz\n    int chanCfg = 2;  //CPE\n\n    // fill in ADTS data\n    packet[0] = (byte) 0xFF;\n    packet[1] = (byte) 0xF9;\n    packet[2] = (byte) (((profile - 1) << 6) + (freqIdx << 2) + (chanCfg >> 2));\n    packet[3] = (byte) (((chanCfg & 3) << 6) + (packetLen >> 11));\n    packet[4] = (byte) ((packetLen & 0x7FF) >> 3);\n    packet[5] = (byte) (((packetLen & 7) << 5) + 0x1F);\n    packet[6] = (byte) 0xFC;\n}\n```\nADTS头中相对有用的信息 采样率、声道数、帧长度。想想也是，我要是解码器的话，你给我一堆得AAC音频ES流我也解不出来。每一个带ADTS头信息的AAC流会清晰的告送解码器他需要的这些信息。更多信息请参见``参考``。\n\n## 参考\n[Android音频开发（1）：基础知识](http://ticktick.blog.51cto.com/823160/1748506)\n[Android音频开发（2）：如何采集一帧音频](http://ticktick.blog.51cto.com/823160/1749719)\n[Android音频开发之AudioRecord录音实现](http://www.cnblogs.com/whoislcj/p/5477216.html)\n[多媒体封装格式详解--- AAC ADTS格式分析](http://blog.csdn.net/tx3344/article/details/7414543)\n[How to generate the AAC ADTS elementary stream with Android MediaCodec](http://stackoverflow.com/questions/18862715/how-to-generate-the-aac-adts-elementary-stream-with-android-mediacodec)\n","source":"_posts/live-audio.md","raw":"---\ntitle: 【Android音视频开发】- 实时采集音频并编码\ndate: 2016-10-22 09:54:26\ntags:\n - 直播\n---\n\n## 前言\n通过我的上一篇文章，利用Camera实时采集视频，并用MediaCodec编码，可以得到YUV、H264文件了。那么接下来便是采集音频并编码了。\n\n## 基础概念\n在音频开发中，有一些基础的概念是必须要知道的。\n### 采样率（samplerate）\n采样就是把模拟信号数字化的过程，不仅仅是音频需要采样，所有的模拟信号都需要通过采样转换为可以用0101来表示的数字信号，示意图如下所示：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video6.png)\n蓝色代表模拟音频信号，红色的点代表采样得到的量化数值。采样频率越高，红色的间隔就越密集，记录这一段音频信号所用的数据量就越大，同时音频质量也就越高。根据奈奎斯特理论，采样频率只要不低于音频信号最高频率的两倍，就可以无损失地还原原始的声音。通常人耳能听到频率范围大约在20Hz～20kHz之间的声音，为了保证声音不失真，采样频率应在40kHz以上。常用的音频采样频率有：8kHz、11.025kHz、22.05kHz、16kHz、37.8kHz、44.1kHz、48kHz、96kHz、192kHz等。\n\n### 量化精度（位宽）\n上图中，每一个红色的采样点，都需要用一个数值来表示大小，这个数值的数据类型大小可以是：4bit、8bit、16bit、32bit等等，位数越多，表示得就越精细，声音质量自然就越好，当然，数据量也会成倍增大。常见的位宽是：8bit 或者 16bit。\n\n### 声道数（channels）\n由于音频的采集和播放是可以叠加的，因此，可以同时从多个音频源采集声音，并分别输出到不同的扬声器，故声道数一般表示声音录制时的音源数量或回放时相应的扬声器数量。单声道（Mono）和双声道（Stereo）比较常见，顾名思义，前者的声道数为1，后者为2。\n\n### 音频帧（frame）\n音频数据是流式的，本身并没有明确的一帧帧的概念，在实际的应用中，为了音频算法处理/传输的方便，一般约定俗成取 2.5 ms ~ 60 ms为单位的数据量为一帧音频。 这个时间被称之为“采样时间”，其长度没有特别的标准。我们可以计算一下一帧音频帧的大小。假设某通道的音频信号是采样率为 8 kHz，位宽为16 bit，20 ms 一帧，双通道，则一帧音频数据的大小为：\n```\nint size = 8000 x 16bit x 0.02s  x 2 = 5120 bit = 640 byte\n```\n\n<!-- more -->\n\n## 采集\n> Android SDK 提供了两套音频采集的API，分别是：MediaRecorder 和 AudioRecord，前者是一个更加上层一点的API，它可以直接把手机麦克风录入的音频数据进行编码压缩（如AMR、MP3等）并存成文件，而后者则更接近底层，能够更加自由灵活地控制，可以得到原始的一帧帧PCM音频数据。如果想简单地做一个录音机，录制成音频文件，则推荐使用 MediaRecorder，而如果需要对音频做进一步的算法处理、或者采用第三方的编码库进行压缩、以及网络传输等应用，则建议使用 AudioRecord，其实 MediaRecorder 底层也是调用了 AudioRecord 与 Android Framework 层的 AudioFlinger 进行交互的。\n\n由上可知，在直播中实时采集音频自然是要用``AudioRecord``了。\n\n## 编码\n通过``AudioRecord``我们可以获取到原始的PCM数据了，接下来就是利用``MediaCodec``来进行编码成AAC数据了。\n\n## 示例代码\n变量声明：\n```\nprivate static final int DEFAULT_SOURCE = MediaRecorder.AudioSource.MIC;            // 麦克风\nprivate static final int DEFAULT_SAMPLE_RATE = 44100;                               // 44.1KHz采样率\nprivate static final int DEFAULT_CHANNEL_CONFIG = AudioFormat.CHANNEL_IN_STEREO;    // 立体声\nprivate static final int DEFAULT_AUDIO_FORMAT = AudioFormat.ENCODING_PCM_16BIT;     // 16位宽\nprivate static final int DEFAULT_BIT_RATE = 32000;                                  // 比特率\nprivate static final String AAC_MIME = \"audio/mp4a-latm\";                           // AAC编码\n```\n初始化AudioRecord：\n```\n/**\n * 初始化AudioRecord\n *\n * @return\n */\nprivate boolean initAudioRecord() {\n    if (mIsCaptureStarted) {\n        Log.e(TAG, \"Capture already started !\");\n        return false;\n    }\n\n    mMinBufferSize = AudioRecord.getMinBufferSize(DEFAULT_SAMPLE_RATE, DEFAULT_CHANNEL_CONFIG, DEFAULT_AUDIO_FORMAT);\n    if (mMinBufferSize == AudioRecord.ERROR_BAD_VALUE) {\n        Log.e(TAG, \"Invalid parameter !\");\n        return false;\n    }\n    Log.d(TAG, \"getMinBufferSize = \" + mMinBufferSize + \" bytes !\");\n\n    mAudioRecord = new AudioRecord(DEFAULT_SOURCE, DEFAULT_SAMPLE_RATE, DEFAULT_CHANNEL_CONFIG, DEFAULT_AUDIO_FORMAT, mMinBufferSize);\n    if (mAudioRecord.getState() == AudioRecord.STATE_UNINITIALIZED) {\n        Log.e(TAG, \"AudioRecord initialize fail !\");\n        return false;\n    }\n    return true;\n}\n```\n初始化MediaCodec：\n```\n/**\n * 初始化MediaCodec\n */\nprivate void initMediaCodec() {\n    try {\n        mMediaCodec = MediaCodec.createEncoderByType(AAC_MIME);\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n    MediaFormat format = new MediaFormat();\n    format.setString(MediaFormat.KEY_MIME, AAC_MIME);\n    format.setInteger(MediaFormat.KEY_BIT_RATE, DEFAULT_BIT_RATE);\n    format.setInteger(MediaFormat.KEY_CHANNEL_COUNT, 2);\n    format.setInteger(MediaFormat.KEY_SAMPLE_RATE, DEFAULT_SAMPLE_RATE);\n    format.setInteger(MediaFormat.KEY_AAC_PROFILE, MediaCodecInfo.CodecProfileLevel.AACObjectLC);\n    format.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, mMinBufferSize * 2);\n    mMediaCodec.configure(format, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);\n    mAudioRecord.startRecording();\n    mMediaCodec.start();\n}\n```\n调用``mAudioRecord.startRecording()``开始采集，并启动线程从AudioRecord获取数据，最后调用``mAudioRecord.stop();``停止采集。\n```\nprivate class AudioCaptureRunnable implements Runnable {\n    @Override\n    public void run() {\n        while (!mIsLoopExit) {\n            byte[] buffer = new byte[mMinBufferSize];\n            int ret = mAudioRecord.read(buffer, 0, mMinBufferSize);\n            if (ret == AudioRecord.ERROR_INVALID_OPERATION) {\n                Log.e(TAG, \"Error ERROR_INVALID_OPERATION\");\n            } else if (ret == AudioRecord.ERROR_BAD_VALUE) {\n                Log.e(TAG, \"Error ERROR_BAD_VALUE\");\n            } else {\n                Log.d(TAG, \"OK, Captured \" + ret + \" bytes !\");\n                Util.save(buffer, 0, buffer.length, pcmPath, true);\n                ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();\n                ByteBuffer[] outputBuffers = mMediaCodec.getOutputBuffers();\n                int inputBufferIndex = mMediaCodec.dequeueInputBuffer(-1);\n                if (inputBufferIndex >= 0) {\n                    ByteBuffer inputBuffer = inputBuffers[inputBufferIndex];\n                    inputBuffer.clear();\n                    inputBuffer.put(buffer);\n                    mMediaCodec.queueInputBuffer(inputBufferIndex, 0, buffer.length,\n                            System.nanoTime(), 0);\n                }\n                MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo();\n                int outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, 0);\n                while (outputBufferIndex >= 0) {\n                    ByteBuffer outputBuffer = outputBuffers[outputBufferIndex];\n\n                    outputBuffer.position(bufferInfo.offset);\n                    outputBuffer.limit(bufferInfo.offset + bufferInfo.size);\n\n                    byte[] outData = new byte[bufferInfo.size + 7];\n\n                    addADTStoPacket(outData, bufferInfo.size + 7);\n\n                    outputBuffer.get(outData, 7, bufferInfo.size);\n\n                    outputBuffer.position(bufferInfo.offset);\n\n\n                    Util.save(outData, 0, outData.length, aacPath, true);\n\n                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, false);\n                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, 0);\n                }\n            }\n        }\n    }\n}\n```\n核心代码便是这些了，运行程序后最后会生成PCM、AAC文件，将AAC文件用VLC打开也是可以播放的。\n\n[工程代码示例](https://github.com/LiJia92/spydroid-ipcamera)\n\n## ADTS\n可以看到上述代码中有``addADTStoPacket``这个方法：\n```\n/**\n * Add ADTS header at the beginning of each and every AAC packet.\n * This is needed as MediaCodec encoder generates a packet of raw\n * AAC data.\n * <p>\n * Note the packetLen must count in the ADTS header itself.\n **/\nprivate void addADTStoPacket(byte[] packet, int packetLen) {\n    int profile = 2;  //AAC LC\n    //39=MediaCodecInfo.CodecProfileLevel.AACObjectELD;\n    int freqIdx = 4;  //44.1KHz\n    int chanCfg = 2;  //CPE\n\n    // fill in ADTS data\n    packet[0] = (byte) 0xFF;\n    packet[1] = (byte) 0xF9;\n    packet[2] = (byte) (((profile - 1) << 6) + (freqIdx << 2) + (chanCfg >> 2));\n    packet[3] = (byte) (((chanCfg & 3) << 6) + (packetLen >> 11));\n    packet[4] = (byte) ((packetLen & 0x7FF) >> 3);\n    packet[5] = (byte) (((packetLen & 7) << 5) + 0x1F);\n    packet[6] = (byte) 0xFC;\n}\n```\nADTS头中相对有用的信息 采样率、声道数、帧长度。想想也是，我要是解码器的话，你给我一堆得AAC音频ES流我也解不出来。每一个带ADTS头信息的AAC流会清晰的告送解码器他需要的这些信息。更多信息请参见``参考``。\n\n## 参考\n[Android音频开发（1）：基础知识](http://ticktick.blog.51cto.com/823160/1748506)\n[Android音频开发（2）：如何采集一帧音频](http://ticktick.blog.51cto.com/823160/1749719)\n[Android音频开发之AudioRecord录音实现](http://www.cnblogs.com/whoislcj/p/5477216.html)\n[多媒体封装格式详解--- AAC ADTS格式分析](http://blog.csdn.net/tx3344/article/details/7414543)\n[How to generate the AAC ADTS elementary stream with Android MediaCodec](http://stackoverflow.com/questions/18862715/how-to-generate-the-aac-adts-elementary-stream-with-android-mediacodec)\n","slug":"live-audio","published":1,"updated":"2016-11-21T10:00:24.238Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759a001p1cb8avc9f05c","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>通过我的上一篇文章，利用Camera实时采集视频，并用MediaCodec编码，可以得到YUV、H264文件了。那么接下来便是采集音频并编码了。</p>\n<h2 id=\"基础概念\"><a href=\"#基础概念\" class=\"headerlink\" title=\"基础概念\"></a>基础概念</h2><p>在音频开发中，有一些基础的概念是必须要知道的。</p>\n<h3 id=\"采样率（samplerate）\"><a href=\"#采样率（samplerate）\" class=\"headerlink\" title=\"采样率（samplerate）\"></a>采样率（samplerate）</h3><p>采样就是把模拟信号数字化的过程，不仅仅是音频需要采样，所有的模拟信号都需要通过采样转换为可以用0101来表示的数字信号，示意图如下所示：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video6.png\" alt=\"\"><br>蓝色代表模拟音频信号，红色的点代表采样得到的量化数值。采样频率越高，红色的间隔就越密集，记录这一段音频信号所用的数据量就越大，同时音频质量也就越高。根据奈奎斯特理论，采样频率只要不低于音频信号最高频率的两倍，就可以无损失地还原原始的声音。通常人耳能听到频率范围大约在20Hz～20kHz之间的声音，为了保证声音不失真，采样频率应在40kHz以上。常用的音频采样频率有：8kHz、11.025kHz、22.05kHz、16kHz、37.8kHz、44.1kHz、48kHz、96kHz、192kHz等。</p>\n<h3 id=\"量化精度（位宽）\"><a href=\"#量化精度（位宽）\" class=\"headerlink\" title=\"量化精度（位宽）\"></a>量化精度（位宽）</h3><p>上图中，每一个红色的采样点，都需要用一个数值来表示大小，这个数值的数据类型大小可以是：4bit、8bit、16bit、32bit等等，位数越多，表示得就越精细，声音质量自然就越好，当然，数据量也会成倍增大。常见的位宽是：8bit 或者 16bit。</p>\n<h3 id=\"声道数（channels）\"><a href=\"#声道数（channels）\" class=\"headerlink\" title=\"声道数（channels）\"></a>声道数（channels）</h3><p>由于音频的采集和播放是可以叠加的，因此，可以同时从多个音频源采集声音，并分别输出到不同的扬声器，故声道数一般表示声音录制时的音源数量或回放时相应的扬声器数量。单声道（Mono）和双声道（Stereo）比较常见，顾名思义，前者的声道数为1，后者为2。</p>\n<h3 id=\"音频帧（frame）\"><a href=\"#音频帧（frame）\" class=\"headerlink\" title=\"音频帧（frame）\"></a>音频帧（frame）</h3><p>音频数据是流式的，本身并没有明确的一帧帧的概念，在实际的应用中，为了音频算法处理/传输的方便，一般约定俗成取 2.5 ms ~ 60 ms为单位的数据量为一帧音频。 这个时间被称之为“采样时间”，其长度没有特别的标准。我们可以计算一下一帧音频帧的大小。假设某通道的音频信号是采样率为 8 kHz，位宽为16 bit，20 ms 一帧，双通道，则一帧音频数据的大小为：<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">int size = <span class=\"number\">8000</span> x <span class=\"number\">16</span>bit x <span class=\"number\">0.02</span>s  x <span class=\"number\">2</span> = <span class=\"number\">5120</span> bit = <span class=\"number\">640</span> byte</div></pre></td></tr></table></figure></p>\n<a id=\"more\"></a>\n<h2 id=\"采集\"><a href=\"#采集\" class=\"headerlink\" title=\"采集\"></a>采集</h2><blockquote>\n<p>Android SDK 提供了两套音频采集的API，分别是：MediaRecorder 和 AudioRecord，前者是一个更加上层一点的API，它可以直接把手机麦克风录入的音频数据进行编码压缩（如AMR、MP3等）并存成文件，而后者则更接近底层，能够更加自由灵活地控制，可以得到原始的一帧帧PCM音频数据。如果想简单地做一个录音机，录制成音频文件，则推荐使用 MediaRecorder，而如果需要对音频做进一步的算法处理、或者采用第三方的编码库进行压缩、以及网络传输等应用，则建议使用 AudioRecord，其实 MediaRecorder 底层也是调用了 AudioRecord 与 Android Framework 层的 AudioFlinger 进行交互的。</p>\n</blockquote>\n<p>由上可知，在直播中实时采集音频自然是要用<code>AudioRecord</code>了。</p>\n<h2 id=\"编码\"><a href=\"#编码\" class=\"headerlink\" title=\"编码\"></a>编码</h2><p>通过<code>AudioRecord</code>我们可以获取到原始的PCM数据了，接下来就是利用<code>MediaCodec</code>来进行编码成AAC数据了。</p>\n<h2 id=\"示例代码\"><a href=\"#示例代码\" class=\"headerlink\" title=\"示例代码\"></a>示例代码</h2><p>变量声明：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_SOURCE = MediaRecorder.AudioSource.MIC;            <span class=\"comment\">// 麦克风</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_SAMPLE_RATE = <span class=\"number\">44100</span>;                               <span class=\"comment\">// 44.1KHz采样率</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_CHANNEL_CONFIG = AudioFormat.CHANNEL_IN_STEREO;    <span class=\"comment\">// 立体声</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_AUDIO_FORMAT = AudioFormat.ENCODING_PCM_16BIT;     <span class=\"comment\">// 16位宽</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_BIT_RATE = <span class=\"number\">32000</span>;                                  <span class=\"comment\">// 比特率</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> AAC_MIME = <span class=\"string\">\"audio/mp4a-latm\"</span>;                           <span class=\"comment\">// AAC编码</span></div></pre></td></tr></table></figure></p>\n<p>初始化AudioRecord：<br><figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 初始化AudioRecord</div><div class=\"line\"> *</div><div class=\"line\"> * @return</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"built_in\">boolean</span> initAudioRecord() &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mIsCaptureStarted) &#123;</div><div class=\"line\">        <span class=\"keyword\">Log</span>.e(<span class=\"built_in\">TAG</span>, <span class=\"string\">\"Capture already started !\"</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    mMinBufferSize = AudioRecord.getMinBufferSize(DEFAULT_SAMPLE_RATE, DEFAULT_CHANNEL_CONFIG, DEFAULT_AUDIO_FORMAT);</div><div class=\"line\">    <span class=\"keyword\">if</span> (mMinBufferSize == AudioRecord.ERROR_BAD_VALUE) &#123;</div><div class=\"line\">        <span class=\"keyword\">Log</span>.e(<span class=\"built_in\">TAG</span>, <span class=\"string\">\"Invalid parameter !\"</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">Log</span>.d(<span class=\"built_in\">TAG</span>, <span class=\"string\">\"getMinBufferSize = \"</span> + mMinBufferSize + <span class=\"string\">\" bytes !\"</span>);</div><div class=\"line\"></div><div class=\"line\">    mAudioRecord = <span class=\"literal\">new</span> AudioRecord(DEFAULT_SOURCE, DEFAULT_SAMPLE_RATE, DEFAULT_CHANNEL_CONFIG, DEFAULT_AUDIO_FORMAT, mMinBufferSize);</div><div class=\"line\">    <span class=\"keyword\">if</span> (mAudioRecord.getState() == AudioRecord.STATE_UNINITIALIZED) &#123;</div><div class=\"line\">        <span class=\"keyword\">Log</span>.e(<span class=\"built_in\">TAG</span>, <span class=\"string\">\"AudioRecord initialize fail !\"</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>初始化MediaCodec：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 初始化MediaCodec</div><div class=\"line\"> */</div><div class=\"line\">private void initMediaCodec() &#123;</div><div class=\"line\">    try &#123;</div><div class=\"line\">        mMediaCodec = MediaCodec.createEncoderByType(AAC_MIME)<span class=\"comment\">;</span></div><div class=\"line\">    &#125; catch (IOException e) &#123;</div><div class=\"line\">        e.printStackTrace()<span class=\"comment\">;</span></div><div class=\"line\">    &#125;</div><div class=\"line\">    MediaFormat format = new MediaFormat()<span class=\"comment\">;</span></div><div class=\"line\">    format.setString(MediaFormat.KEY_MIME, AAC_MIME)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_BIT_RATE, DEFAULT_BIT_RATE)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_CHANNEL_COUNT, <span class=\"number\">2</span>)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_SAMPLE_RATE, DEFAULT_SAMPLE_RATE)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_AAC_PROFILE, MediaCodecInfo.CodecProfileLevel.AACObjectLC)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, mMinBufferSize * <span class=\"number\">2</span>)<span class=\"comment\">;</span></div><div class=\"line\">    mMediaCodec.configure(format, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE)<span class=\"comment\">;</span></div><div class=\"line\">    mAudioRecord.startRecording()<span class=\"comment\">;</span></div><div class=\"line\">    mMediaCodec.start()<span class=\"comment\">;</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>调用<code>mAudioRecord.startRecording()</code>开始采集，并启动线程从AudioRecord获取数据，最后调用<code>mAudioRecord.stop();</code>停止采集。<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\">private class AudioCaptureRunnable implements Runnable &#123;</div><div class=\"line\">    @Override</div><div class=\"line\">    public void run() &#123;</div><div class=\"line\">        while (!mIsLoopExit) &#123;</div><div class=\"line\">            <span class=\"keyword\">byte[] </span><span class=\"keyword\">buffer </span>= new <span class=\"keyword\">byte[mMinBufferSize];</span></div><div class=\"line\">            int ret = mAudioRecord.read(<span class=\"keyword\">buffer, </span><span class=\"number\">0</span>, mMinBufferSize)<span class=\"comment\">;</span></div><div class=\"line\">            if (ret == AudioRecord.ERROR_INVALID_OPERATION) &#123;</div><div class=\"line\">                Log.e(TAG, <span class=\"string\">\"Error ERROR_INVALID_OPERATION\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">            &#125; else if (ret == AudioRecord.ERROR_BAD_VALUE) &#123;</div><div class=\"line\">                Log.e(TAG, <span class=\"string\">\"Error ERROR_BAD_VALUE\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">            &#125; else &#123;</div><div class=\"line\">                Log.d(TAG, <span class=\"string\">\"OK, Captured \"</span> + ret + <span class=\"string\">\" bytes !\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">                Util.save(<span class=\"keyword\">buffer, </span><span class=\"number\">0</span>, <span class=\"keyword\">buffer.length, </span>pcmPath, true)<span class=\"comment\">;</span></div><div class=\"line\">                <span class=\"keyword\">ByteBuffer[] </span>inputBuffers = mMediaCodec.getInputBuffers()<span class=\"comment\">;</span></div><div class=\"line\">                <span class=\"keyword\">ByteBuffer[] </span>outputBuffers = mMediaCodec.getOutputBuffers()<span class=\"comment\">;</span></div><div class=\"line\">                int inputBufferIndex = mMediaCodec.dequeueInputBuffer(-<span class=\"number\">1</span>)<span class=\"comment\">;</span></div><div class=\"line\">                if (inputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    <span class=\"keyword\">ByteBuffer </span>inputBuffer = inputBuffers[inputBufferIndex]<span class=\"comment\">;</span></div><div class=\"line\">                    inputBuffer.clear()<span class=\"comment\">;</span></div><div class=\"line\">                    inputBuffer.put(<span class=\"keyword\">buffer);</span></div><div class=\"line\">                    mMediaCodec.queueInputBuffer(inputBufferIndex, <span class=\"number\">0</span>, <span class=\"keyword\">buffer.length,</span></div><div class=\"line\">                            System.nanoTime(), <span class=\"number\">0</span>)<span class=\"comment\">;</span></div><div class=\"line\">                &#125;</div><div class=\"line\">                MediaCodec.<span class=\"keyword\">BufferInfo </span><span class=\"keyword\">bufferInfo </span>= new MediaCodec.<span class=\"keyword\">BufferInfo();</span></div><div class=\"line\">                int outputBufferIndex = mMediaCodec.dequeueOutputBuffer(<span class=\"keyword\">bufferInfo, </span><span class=\"number\">0</span>)<span class=\"comment\">;</span></div><div class=\"line\">                while (outputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    <span class=\"keyword\">ByteBuffer </span>outputBuffer = outputBuffers[outputBufferIndex]<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">                    outputBuffer.position(<span class=\"keyword\">bufferInfo.offset);</span></div><div class=\"line\">                    outputBuffer.limit(<span class=\"keyword\">bufferInfo.offset </span>+ <span class=\"keyword\">bufferInfo.size);</span></div><div class=\"line\"></div><div class=\"line\">                    <span class=\"keyword\">byte[] </span>outData = new <span class=\"keyword\">byte[bufferInfo.size </span>+ <span class=\"number\">7</span>]<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">                    <span class=\"keyword\">addADTStoPacket(outData, </span><span class=\"keyword\">bufferInfo.size </span>+ <span class=\"number\">7</span>)<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">                    outputBuffer.get(outData, <span class=\"number\">7</span>, <span class=\"keyword\">bufferInfo.size);</span></div><div class=\"line\"></div><div class=\"line\">                    outputBuffer.position(<span class=\"keyword\">bufferInfo.offset);</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">                    Util.save(outData, <span class=\"number\">0</span>, outData.length, aacPath, true)<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, false)<span class=\"comment\">;</span></div><div class=\"line\">                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(<span class=\"keyword\">bufferInfo, </span><span class=\"number\">0</span>)<span class=\"comment\">;</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>核心代码便是这些了，运行程序后最后会生成PCM、AAC文件，将AAC文件用VLC打开也是可以播放的。</p>\n<p><a href=\"https://github.com/LiJia92/spydroid-ipcamera\" target=\"_blank\" rel=\"external\">工程代码示例</a></p>\n<h2 id=\"ADTS\"><a href=\"#ADTS\" class=\"headerlink\" title=\"ADTS\"></a>ADTS</h2><p>可以看到上述代码中有<code>addADTStoPacket</code>这个方法：<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * Add ADTS header at the beginning of each and every AAC packet.</div><div class=\"line\"> * This is needed as MediaCodec encoder generates a packet of raw</div><div class=\"line\"> * AAC data.</div><div class=\"line\"> * &lt;p&gt;</div><div class=\"line\"> * Note the packetLen must count in the ADTS header itself.</div><div class=\"line\"> **/</div><div class=\"line\">private void addADTStoPacket(byte[] packet, int packetLen) &#123;</div><div class=\"line\">    int profile = <span class=\"number\">2</span>;  <span class=\"comment\">//AAC LC</span></div><div class=\"line\">    <span class=\"comment\">//39=MediaCodecInfo.CodecProfileLevel.AACObjectELD;</span></div><div class=\"line\">    int freqIdx = <span class=\"number\">4</span>;  <span class=\"comment\">//44.1KHz</span></div><div class=\"line\">    int chanCfg = <span class=\"number\">2</span>;  <span class=\"comment\">//CPE</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// fill in ADTS data</span></div><div class=\"line\">    packet[<span class=\"number\">0</span>] = (byte) <span class=\"number\">0xFF</span>;</div><div class=\"line\">    packet[<span class=\"number\">1</span>] = (byte) <span class=\"number\">0xF9</span>;</div><div class=\"line\">    packet[<span class=\"number\">2</span>] = (byte) (((profile - <span class=\"number\">1</span>) &lt;&lt; <span class=\"number\">6</span>) + (freqIdx &lt;&lt; <span class=\"number\">2</span>) + (chanCfg &gt;&gt; <span class=\"number\">2</span>));</div><div class=\"line\">    packet[<span class=\"number\">3</span>] = (byte) (((chanCfg &amp; <span class=\"number\">3</span>) &lt;&lt; <span class=\"number\">6</span>) + (packetLen &gt;&gt; <span class=\"number\">11</span>));</div><div class=\"line\">    packet[<span class=\"number\">4</span>] = (byte) ((packetLen &amp; <span class=\"number\">0x7FF</span>) &gt;&gt; <span class=\"number\">3</span>);</div><div class=\"line\">    packet[<span class=\"number\">5</span>] = (byte) (((packetLen &amp; <span class=\"number\">7</span>) &lt;&lt; <span class=\"number\">5</span>) + <span class=\"number\">0x1F</span>);</div><div class=\"line\">    packet[<span class=\"number\">6</span>] = (byte) <span class=\"number\">0xFC</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>ADTS头中相对有用的信息 采样率、声道数、帧长度。想想也是，我要是解码器的话，你给我一堆得AAC音频ES流我也解不出来。每一个带ADTS头信息的AAC流会清晰的告送解码器他需要的这些信息。更多信息请参见<code>参考</code>。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://ticktick.blog.51cto.com/823160/1748506\" target=\"_blank\" rel=\"external\">Android音频开发（1）：基础知识</a><br><a href=\"http://ticktick.blog.51cto.com/823160/1749719\" target=\"_blank\" rel=\"external\">Android音频开发（2）：如何采集一帧音频</a><br><a href=\"http://www.cnblogs.com/whoislcj/p/5477216.html\" target=\"_blank\" rel=\"external\">Android音频开发之AudioRecord录音实现</a><br><a href=\"http://blog.csdn.net/tx3344/article/details/7414543\" target=\"_blank\" rel=\"external\">多媒体封装格式详解— AAC ADTS格式分析</a><br><a href=\"http://stackoverflow.com/questions/18862715/how-to-generate-the-aac-adts-elementary-stream-with-android-mediacodec\" target=\"_blank\" rel=\"external\">How to generate the AAC ADTS elementary stream with Android MediaCodec</a></p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>通过我的上一篇文章，利用Camera实时采集视频，并用MediaCodec编码，可以得到YUV、H264文件了。那么接下来便是采集音频并编码了。</p>\n<h2 id=\"基础概念\"><a href=\"#基础概念\" class=\"headerlink\" title=\"基础概念\"></a>基础概念</h2><p>在音频开发中，有一些基础的概念是必须要知道的。</p>\n<h3 id=\"采样率（samplerate）\"><a href=\"#采样率（samplerate）\" class=\"headerlink\" title=\"采样率（samplerate）\"></a>采样率（samplerate）</h3><p>采样就是把模拟信号数字化的过程，不仅仅是音频需要采样，所有的模拟信号都需要通过采样转换为可以用0101来表示的数字信号，示意图如下所示：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video6.png\" alt=\"\"><br>蓝色代表模拟音频信号，红色的点代表采样得到的量化数值。采样频率越高，红色的间隔就越密集，记录这一段音频信号所用的数据量就越大，同时音频质量也就越高。根据奈奎斯特理论，采样频率只要不低于音频信号最高频率的两倍，就可以无损失地还原原始的声音。通常人耳能听到频率范围大约在20Hz～20kHz之间的声音，为了保证声音不失真，采样频率应在40kHz以上。常用的音频采样频率有：8kHz、11.025kHz、22.05kHz、16kHz、37.8kHz、44.1kHz、48kHz、96kHz、192kHz等。</p>\n<h3 id=\"量化精度（位宽）\"><a href=\"#量化精度（位宽）\" class=\"headerlink\" title=\"量化精度（位宽）\"></a>量化精度（位宽）</h3><p>上图中，每一个红色的采样点，都需要用一个数值来表示大小，这个数值的数据类型大小可以是：4bit、8bit、16bit、32bit等等，位数越多，表示得就越精细，声音质量自然就越好，当然，数据量也会成倍增大。常见的位宽是：8bit 或者 16bit。</p>\n<h3 id=\"声道数（channels）\"><a href=\"#声道数（channels）\" class=\"headerlink\" title=\"声道数（channels）\"></a>声道数（channels）</h3><p>由于音频的采集和播放是可以叠加的，因此，可以同时从多个音频源采集声音，并分别输出到不同的扬声器，故声道数一般表示声音录制时的音源数量或回放时相应的扬声器数量。单声道（Mono）和双声道（Stereo）比较常见，顾名思义，前者的声道数为1，后者为2。</p>\n<h3 id=\"音频帧（frame）\"><a href=\"#音频帧（frame）\" class=\"headerlink\" title=\"音频帧（frame）\"></a>音频帧（frame）</h3><p>音频数据是流式的，本身并没有明确的一帧帧的概念，在实际的应用中，为了音频算法处理/传输的方便，一般约定俗成取 2.5 ms ~ 60 ms为单位的数据量为一帧音频。 这个时间被称之为“采样时间”，其长度没有特别的标准。我们可以计算一下一帧音频帧的大小。假设某通道的音频信号是采样率为 8 kHz，位宽为16 bit，20 ms 一帧，双通道，则一帧音频数据的大小为：<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">int size = <span class=\"number\">8000</span> x <span class=\"number\">16</span>bit x <span class=\"number\">0.02</span>s  x <span class=\"number\">2</span> = <span class=\"number\">5120</span> bit = <span class=\"number\">640</span> byte</div></pre></td></tr></table></figure></p>","more":"<h2 id=\"采集\"><a href=\"#采集\" class=\"headerlink\" title=\"采集\"></a>采集</h2><blockquote>\n<p>Android SDK 提供了两套音频采集的API，分别是：MediaRecorder 和 AudioRecord，前者是一个更加上层一点的API，它可以直接把手机麦克风录入的音频数据进行编码压缩（如AMR、MP3等）并存成文件，而后者则更接近底层，能够更加自由灵活地控制，可以得到原始的一帧帧PCM音频数据。如果想简单地做一个录音机，录制成音频文件，则推荐使用 MediaRecorder，而如果需要对音频做进一步的算法处理、或者采用第三方的编码库进行压缩、以及网络传输等应用，则建议使用 AudioRecord，其实 MediaRecorder 底层也是调用了 AudioRecord 与 Android Framework 层的 AudioFlinger 进行交互的。</p>\n</blockquote>\n<p>由上可知，在直播中实时采集音频自然是要用<code>AudioRecord</code>了。</p>\n<h2 id=\"编码\"><a href=\"#编码\" class=\"headerlink\" title=\"编码\"></a>编码</h2><p>通过<code>AudioRecord</code>我们可以获取到原始的PCM数据了，接下来就是利用<code>MediaCodec</code>来进行编码成AAC数据了。</p>\n<h2 id=\"示例代码\"><a href=\"#示例代码\" class=\"headerlink\" title=\"示例代码\"></a>示例代码</h2><p>变量声明：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_SOURCE = MediaRecorder.AudioSource.MIC;            <span class=\"comment\">// 麦克风</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_SAMPLE_RATE = <span class=\"number\">44100</span>;                               <span class=\"comment\">// 44.1KHz采样率</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_CHANNEL_CONFIG = AudioFormat.CHANNEL_IN_STEREO;    <span class=\"comment\">// 立体声</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_AUDIO_FORMAT = AudioFormat.ENCODING_PCM_16BIT;     <span class=\"comment\">// 16位宽</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"built_in\">int</span> DEFAULT_BIT_RATE = <span class=\"number\">32000</span>;                                  <span class=\"comment\">// 比特率</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">String</span> AAC_MIME = <span class=\"string\">\"audio/mp4a-latm\"</span>;                           <span class=\"comment\">// AAC编码</span></div></pre></td></tr></table></figure></p>\n<p>初始化AudioRecord：<br><figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 初始化AudioRecord</div><div class=\"line\"> *</div><div class=\"line\"> * @return</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"built_in\">boolean</span> initAudioRecord() &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mIsCaptureStarted) &#123;</div><div class=\"line\">        <span class=\"keyword\">Log</span>.e(<span class=\"built_in\">TAG</span>, <span class=\"string\">\"Capture already started !\"</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    mMinBufferSize = AudioRecord.getMinBufferSize(DEFAULT_SAMPLE_RATE, DEFAULT_CHANNEL_CONFIG, DEFAULT_AUDIO_FORMAT);</div><div class=\"line\">    <span class=\"keyword\">if</span> (mMinBufferSize == AudioRecord.ERROR_BAD_VALUE) &#123;</div><div class=\"line\">        <span class=\"keyword\">Log</span>.e(<span class=\"built_in\">TAG</span>, <span class=\"string\">\"Invalid parameter !\"</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">Log</span>.d(<span class=\"built_in\">TAG</span>, <span class=\"string\">\"getMinBufferSize = \"</span> + mMinBufferSize + <span class=\"string\">\" bytes !\"</span>);</div><div class=\"line\"></div><div class=\"line\">    mAudioRecord = <span class=\"literal\">new</span> AudioRecord(DEFAULT_SOURCE, DEFAULT_SAMPLE_RATE, DEFAULT_CHANNEL_CONFIG, DEFAULT_AUDIO_FORMAT, mMinBufferSize);</div><div class=\"line\">    <span class=\"keyword\">if</span> (mAudioRecord.getState() == AudioRecord.STATE_UNINITIALIZED) &#123;</div><div class=\"line\">        <span class=\"keyword\">Log</span>.e(<span class=\"built_in\">TAG</span>, <span class=\"string\">\"AudioRecord initialize fail !\"</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>初始化MediaCodec：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 初始化MediaCodec</div><div class=\"line\"> */</span></div><div class=\"line\">private void initMediaCodec() &#123;</div><div class=\"line\">    try &#123;</div><div class=\"line\">        mMediaCodec = MediaCodec.createEncoderByType(AAC_MIME)<span class=\"comment\">;</span></div><div class=\"line\">    &#125; catch (IOException e) &#123;</div><div class=\"line\">        e.printStackTrace()<span class=\"comment\">;</span></div><div class=\"line\">    &#125;</div><div class=\"line\">    MediaFormat format = new MediaFormat()<span class=\"comment\">;</span></div><div class=\"line\">    format.setString(MediaFormat.KEY_MIME, AAC_MIME)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_BIT_RATE, DEFAULT_BIT_RATE)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_CHANNEL_COUNT, <span class=\"number\">2</span>)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_SAMPLE_RATE, DEFAULT_SAMPLE_RATE)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_AAC_PROFILE, MediaCodecInfo.CodecProfileLevel.AACObjectLC)<span class=\"comment\">;</span></div><div class=\"line\">    format.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, mMinBufferSize * <span class=\"number\">2</span>)<span class=\"comment\">;</span></div><div class=\"line\">    mMediaCodec.configure(format, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE)<span class=\"comment\">;</span></div><div class=\"line\">    mAudioRecord.startRecording()<span class=\"comment\">;</span></div><div class=\"line\">    mMediaCodec.start()<span class=\"comment\">;</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>调用<code>mAudioRecord.startRecording()</code>开始采集，并启动线程从AudioRecord获取数据，最后调用<code>mAudioRecord.stop();</code>停止采集。<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\">private class AudioCaptureRunnable implements Runnable &#123;</div><div class=\"line\">    @Override</div><div class=\"line\">    public void run() &#123;</div><div class=\"line\">        while (!mIsLoopExit) &#123;</div><div class=\"line\">            <span class=\"keyword\">byte[] </span><span class=\"keyword\">buffer </span>= new <span class=\"keyword\">byte[mMinBufferSize];</div><div class=\"line\"></span>            int ret = mAudioRecord.read(<span class=\"keyword\">buffer, </span><span class=\"number\">0</span>, mMinBufferSize)<span class=\"comment\">;</span></div><div class=\"line\">            if (ret == AudioRecord.ERROR_INVALID_OPERATION) &#123;</div><div class=\"line\">                Log.e(TAG, <span class=\"string\">\"Error ERROR_INVALID_OPERATION\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">            &#125; else if (ret == AudioRecord.ERROR_BAD_VALUE) &#123;</div><div class=\"line\">                Log.e(TAG, <span class=\"string\">\"Error ERROR_BAD_VALUE\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">            &#125; else &#123;</div><div class=\"line\">                Log.d(TAG, <span class=\"string\">\"OK, Captured \"</span> + ret + <span class=\"string\">\" bytes !\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">                Util.save(<span class=\"keyword\">buffer, </span><span class=\"number\">0</span>, <span class=\"keyword\">buffer.length, </span>pcmPath, true)<span class=\"comment\">;</span></div><div class=\"line\">                <span class=\"keyword\">ByteBuffer[] </span>inputBuffers = mMediaCodec.getInputBuffers()<span class=\"comment\">;</span></div><div class=\"line\">                <span class=\"keyword\">ByteBuffer[] </span>outputBuffers = mMediaCodec.getOutputBuffers()<span class=\"comment\">;</span></div><div class=\"line\">                int inputBufferIndex = mMediaCodec.dequeueInputBuffer(-<span class=\"number\">1</span>)<span class=\"comment\">;</span></div><div class=\"line\">                if (inputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    <span class=\"keyword\">ByteBuffer </span>inputBuffer = inputBuffers[inputBufferIndex]<span class=\"comment\">;</span></div><div class=\"line\">                    inputBuffer.clear()<span class=\"comment\">;</span></div><div class=\"line\">                    inputBuffer.put(<span class=\"keyword\">buffer);</div><div class=\"line\"></span>                    mMediaCodec.queueInputBuffer(inputBufferIndex, <span class=\"number\">0</span>, <span class=\"keyword\">buffer.length,</div><div class=\"line\"></span>                            System.nanoTime(), <span class=\"number\">0</span>)<span class=\"comment\">;</span></div><div class=\"line\">                &#125;</div><div class=\"line\">                MediaCodec.<span class=\"keyword\">BufferInfo </span><span class=\"keyword\">bufferInfo </span>= new MediaCodec.<span class=\"keyword\">BufferInfo();</div><div class=\"line\"></span>                int outputBufferIndex = mMediaCodec.dequeueOutputBuffer(<span class=\"keyword\">bufferInfo, </span><span class=\"number\">0</span>)<span class=\"comment\">;</span></div><div class=\"line\">                while (outputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    <span class=\"keyword\">ByteBuffer </span>outputBuffer = outputBuffers[outputBufferIndex]<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">                    outputBuffer.position(<span class=\"keyword\">bufferInfo.offset);</div><div class=\"line\"></span>                    outputBuffer.limit(<span class=\"keyword\">bufferInfo.offset </span>+ <span class=\"keyword\">bufferInfo.size);</div><div class=\"line\"></span></div><div class=\"line\">                    <span class=\"keyword\">byte[] </span>outData = new <span class=\"keyword\">byte[bufferInfo.size </span>+ <span class=\"number\">7</span>]<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">                    <span class=\"keyword\">addADTStoPacket(outData, </span><span class=\"keyword\">bufferInfo.size </span>+ <span class=\"number\">7</span>)<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">                    outputBuffer.get(outData, <span class=\"number\">7</span>, <span class=\"keyword\">bufferInfo.size);</div><div class=\"line\"></span></div><div class=\"line\">                    outputBuffer.position(<span class=\"keyword\">bufferInfo.offset);</div><div class=\"line\"></span></div><div class=\"line\"></div><div class=\"line\">                    Util.save(outData, <span class=\"number\">0</span>, outData.length, aacPath, true)<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, false)<span class=\"comment\">;</span></div><div class=\"line\">                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(<span class=\"keyword\">bufferInfo, </span><span class=\"number\">0</span>)<span class=\"comment\">;</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>核心代码便是这些了，运行程序后最后会生成PCM、AAC文件，将AAC文件用VLC打开也是可以播放的。</p>\n<p><a href=\"https://github.com/LiJia92/spydroid-ipcamera\">工程代码示例</a></p>\n<h2 id=\"ADTS\"><a href=\"#ADTS\" class=\"headerlink\" title=\"ADTS\"></a>ADTS</h2><p>可以看到上述代码中有<code>addADTStoPacket</code>这个方法：<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * Add ADTS header at the beginning of each and every AAC packet.</div><div class=\"line\"> * This is needed as MediaCodec encoder generates a packet of raw</div><div class=\"line\"> * AAC data.</div><div class=\"line\"> * &lt;p&gt;</div><div class=\"line\"> * Note the packetLen must count in the ADTS header itself.</div><div class=\"line\"> **/</span></div><div class=\"line\">private void addADTStoPacket(byte[] packet, int packetLen) &#123;</div><div class=\"line\">    int profile = <span class=\"number\">2</span>;  <span class=\"comment\">//AAC LC</span></div><div class=\"line\">    <span class=\"comment\">//39=MediaCodecInfo.CodecProfileLevel.AACObjectELD;</span></div><div class=\"line\">    int freqIdx = <span class=\"number\">4</span>;  <span class=\"comment\">//44.1KHz</span></div><div class=\"line\">    int chanCfg = <span class=\"number\">2</span>;  <span class=\"comment\">//CPE</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// fill in ADTS data</span></div><div class=\"line\">    packet[<span class=\"number\">0</span>] = (byte) <span class=\"number\">0xFF</span>;</div><div class=\"line\">    packet[<span class=\"number\">1</span>] = (byte) <span class=\"number\">0xF9</span>;</div><div class=\"line\">    packet[<span class=\"number\">2</span>] = (byte) (((profile - <span class=\"number\">1</span>) &lt;&lt; <span class=\"number\">6</span>) + (freqIdx &lt;&lt; <span class=\"number\">2</span>) + (chanCfg &gt;&gt; <span class=\"number\">2</span>));</div><div class=\"line\">    packet[<span class=\"number\">3</span>] = (byte) (((chanCfg &amp; <span class=\"number\">3</span>) &lt;&lt; <span class=\"number\">6</span>) + (packetLen &gt;&gt; <span class=\"number\">11</span>));</div><div class=\"line\">    packet[<span class=\"number\">4</span>] = (byte) ((packetLen &amp; <span class=\"number\">0x7FF</span>) &gt;&gt; <span class=\"number\">3</span>);</div><div class=\"line\">    packet[<span class=\"number\">5</span>] = (byte) (((packetLen &amp; <span class=\"number\">7</span>) &lt;&lt; <span class=\"number\">5</span>) + <span class=\"number\">0x1F</span>);</div><div class=\"line\">    packet[<span class=\"number\">6</span>] = (byte) <span class=\"number\">0xFC</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>ADTS头中相对有用的信息 采样率、声道数、帧长度。想想也是，我要是解码器的话，你给我一堆得AAC音频ES流我也解不出来。每一个带ADTS头信息的AAC流会清晰的告送解码器他需要的这些信息。更多信息请参见<code>参考</code>。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://ticktick.blog.51cto.com/823160/1748506\">Android音频开发（1）：基础知识</a><br><a href=\"http://ticktick.blog.51cto.com/823160/1749719\">Android音频开发（2）：如何采集一帧音频</a><br><a href=\"http://www.cnblogs.com/whoislcj/p/5477216.html\">Android音频开发之AudioRecord录音实现</a><br><a href=\"http://blog.csdn.net/tx3344/article/details/7414543\">多媒体封装格式详解— AAC ADTS格式分析</a><br><a href=\"http://stackoverflow.com/questions/18862715/how-to-generate-the-aac-adts-elementary-stream-with-android-mediacodec\">How to generate the AAC ADTS elementary stream with Android MediaCodec</a></p>"},{"title":"Android感悟之造轮子","date":"2016-09-12T03:17:11.000Z","_content":"\n最近项目要添加一个点赞的效果，类似[这篇文章所说](http://www.jianshu.com/p/03fdcfd3ae9c)，其实效果是差不多的，便打算直接拿来用了，感谢这位大大制作的轮子~\n\n而后自己思考了一下，怎么样的轮子别人用起来才方便呢？为了实现``方便``，其实我们能做的事情有很多，这里说一下自己的感悟。\n\n下面我便拿着我之前写的一个自定义弧形SeekBar来说明，将其抽成一个三方库要做哪些事。\n\n<!-- more -->\n\n之前的代码结构是这样的：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel1.png)\n引用的时候是这样的：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel2.png)\n这显然是非常笨重的引用方式，那么改如何改进呢？\n\n## Library\n第一个最先想到的自然是将代码抽成一个library。然后项目要引用时候，直接gradle添加依赖即可。\n选择``New Module``，选择``Android Library``即可，然后将代码放在``src/main/java/包名``文件夹下，添加``compile project(':library')``依赖即可。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel3.png)\n\n## 精简引用方式\n之前的代码要用，我需要xml中引入三个自定义View，显得很繁杂。站在使用者的角度，若是只用引入一个自定义View，便简单多了。\n至于球的大小，球的颜色等独立的属性，通过自定义属性来进行设置即可。\n\n下面上一下修改后的代码，ArcSeekBarParent类：\n```\npublic class ArcSeekBarParent extends FrameLayout implements SeekBarBallView.OnSmoothScrollListener {\n\n    private PointF pointF1;                     // 起始点\n    private PointF pointF2;                     // 控制点\n    private PointF pointF3;                     // 终止点\n    private PointF circleCenter;                // 球的坐标\n    private int top;\n    private int right;\n    private int bottom;\n    private int left;\n    private float currentX;                     // 当前x坐标，用于控制圆球位置\n    private final static float LEVEL = 6f;      // 设置档次\n    private int currentLevel = 1;               // 当前档次\n\n    private OnProgressChangedListener listener; // 档次改变的监听\n    private Context context;\n\n    private SeekBarBallView ball;               // 球\n    private SeekBarArcView arc;                 // 弧\n    private int ballSize;                       // 球的大小\n    private String ballColor;                   // 球的颜色\n    private int arcWidth;                       // 弧的宽度\n    private String arcColor;                    // 弧的颜色\n\n    public ArcSeekBarParent(Context context) {\n        super(context);\n        init();\n    }\n\n    public ArcSeekBarParent(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        this.context = context;\n        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.ArcSeekBarParent);\n        ballSize = array.getDimensionPixelSize(R.styleable.ArcSeekBarParent_ballSize, 30);\n        arcWidth = array.getDimensionPixelSize(R.styleable.ArcSeekBarParent_arcWidth, 10);\n        ballColor = array.getString(R.styleable.ArcSeekBarParent_ballColor);\n        arcColor = array.getString(R.styleable.ArcSeekBarParent_arcColor);\n        array.recycle();\n        init();\n    }\n\n    private void init() {\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n        circleCenter = new PointF();\n\n        // 添加弧线View\n        if (arcColor == null) {\n            arcColor = \"#000000\";      // 当没有设置颜色时候，默认使用黑色\n        }\n        arc = new SeekBarArcView(context, arcColor, arcWidth);\n        arc.setLayoutParams(new FrameLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT));\n        addView(arc);\n\n        // 添加球View\n        if (ballColor == null) {\n            ballColor = \"#FFFFFF\";      // 当没有设置颜色时候，默认使用白色\n        }\n        ball = new SeekBarBallView(context, ballColor, ballSize);\n        ball.setListener(this);\n        addView(ball);\n    }\n\n    public void setListener(OnProgressChangedListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        this.left = left;\n        this.top = top;\n        this.right = right;\n        this.bottom = bottom;\n        pointF1.set(0, bottom - top - 30);\n        pointF2.set((right - left) / 2, -(bottom - top) / 4);\n        pointF3.set(right, bottom - top - 30);\n        currentX = (right - left) / LEVEL;\n        changeBallLayout(currentX);\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent event) {\n        switch (event.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                float downX = event.getX();\n                float downY = event.getY();\n                float distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);\n                // 计算到圆球中心的距离，考虑20的误差\n                return !(distance - (ball.getMeasuredWidth() / 2 + 20) * (ball.getMeasuredWidth() / 2 + 20) > 0);\n            case MotionEvent.ACTION_MOVE:\n                float moveX = event.getX();\n                currentX = moveX; // 通过x坐标改变圆球的位置\n                changeBallLayout(currentX);\n                currentLevel = getLevel(moveX);\n                if (listener != null) {\n                    listener.OnProgressChanged(currentLevel);\n                }\n                break;\n            default:\n                // 当手指移出或者离开View时，圆球平滑滑到最近的档次\n                ball.smoothScrollLevel((int) currentX, (int) ((right - left) / LEVEL * currentLevel - currentX));\n                break;\n        }\n        return super.onTouchEvent(event);\n    }\n\n    /**\n     * 改变球的位置\n     *\n     * @param currentX 横坐标\n     */\n    private void changeBallLayout(float currentX) {\n        float t = (currentX / (right - left));\n        float x = (1 - t) * (1 - t) * pointF1.x + 2 * (t) * (1 - t) * pointF2.x + t * t * pointF3.x;\n        float y = (1 - t) * (1 - t) * pointF1.y + 2 * (t) * (1 - t) * pointF2.y + t * t * pointF3.y;\n        circleCenter.set(x, y);\n        ball.layout((int) (circleCenter.x - ball.getMeasuredWidth() / 2), (int) (circleCenter.y - ball.getMeasuredWidth() / 2), (int) (circleCenter.x + ball.getMeasuredWidth() / 2), (int) (circleCenter.y + ball.getMeasuredWidth() / 2));\n    }\n\n    /**\n     * 计算档次\n     *\n     * @param x 横坐标\n     * @return 档次\n     */\n    private int getLevel(float x) {\n        float ratio = (x / (right - left)) * LEVEL;\n        // 计算距离哪个档次最近\n        int result = new BigDecimal(ratio).setScale(0, BigDecimal.ROUND_HALF_UP).intValue();\n        if (result < 1) {\n            result = 1;\n        } else if (result > (LEVEL - 1)) {\n            result = (int) (LEVEL - 1);\n        }\n        return result;\n    }\n\n    @Override\n    public void onSmoothScroll(int currentX) {\n        changeBallLayout(currentX);\n    }\n\n    /**\n     * 滑动接口\n     */\n    public interface OnProgressChangedListener {\n        void OnProgressChanged(int level);\n    }\n}\n```\nSeekBarArcView类：\n```\npublic class SeekBarArcView extends View {\n\n    private Paint paint;\n    private Path path;\n    private PointF pointF1;     // 起始点\n    private PointF pointF2;     // 控制点\n    private PointF pointF3;     // 终止点\n    private String arcColor;    // 弧的颜色\n    private int arcWidth;       // 弧的宽度\n\n    public SeekBarArcView(Context context, String arcColor, int arcWidth) {\n        super(context);\n        this.arcColor = arcColor;\n        this.arcWidth = arcWidth;\n        init();\n    }\n\n    private void init() {\n        paint = new Paint();\n        path = new Path();\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n        // 初始化画笔\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.parseColor(arcColor));\n        paint.setStrokeWidth(arcWidth);\n        paint.setStyle(Paint.Style.STROKE);\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        pointF1.set(0, bottom - top - 30);\n        pointF2.set((right - left) / 2, -(bottom - top) / 4);\n        pointF3.set(right, bottom - top - 30);\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n        // 画2阶贝塞尔曲线\n        path.moveTo(pointF1.x, pointF1.y);\n        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);\n        canvas.drawPath(path, paint);\n    }\n}\n```\nSeekBarBallView类：\n```\npublic class SeekBarBallView extends View {\n\n    private Paint paint;\n    private Scroller scroller;\n    private int ballSize;\n    private String ballColor;\n    private OnSmoothScrollListener listener;\n\n    public SeekBarBallView(Context context, String ballColor, int ballSize) {\n        super(context);\n        this.ballColor = ballColor;\n        this.ballSize = ballSize;\n        init(context);\n    }\n\n    private void init(Context context) {\n        scroller = new Scroller(context);\n        paint = new Paint();\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.parseColor(ballColor));\n        paint.setStyle(Paint.Style.FILL);\n    }\n\n    public void setListener(OnSmoothScrollListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n        int spec = MeasureSpec.makeMeasureSpec(ballSize, MeasureSpec.EXACTLY);\n        setMeasuredDimension(spec, spec);\n    }\n\n    @Override\n    public void computeScroll() {\n        if (scroller.computeScrollOffset()) {\n            if (listener != null) {\n                listener.onSmoothScroll(scroller.getCurrX());\n                postInvalidate();\n            }\n        }\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        canvas.drawCircle(getMeasuredWidth() / 2, getMeasuredWidth() / 2, getMeasuredWidth() / 2, paint);\n    }\n\n    /**\n     * 平滑滑动\n     *\n     * @param start    起始值\n     * @param distance 滑动距离\n     */\n    public void smoothScrollLevel(int start, int distance) {\n        scroller.startScroll(start, 0, distance, 0, 200);\n        postInvalidate();\n    }\n\n    public interface OnSmoothScrollListener {\n        void onSmoothScroll(int currentX);\n    }\n}\n```\n以及自定义属性attr.xml：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<resources>\n    <declare-styleable name=\"ArcSeekBarParent\">\n        <attr name=\"ballColor\" format=\"string\" />\n        <attr name=\"ballSize\" format=\"dimension\" />\n        <attr name=\"arcWidth\" format=\"dimension\" />\n        <attr name=\"arcColor\" format=\"string\" />\n    </declare-styleable>\n</resources>\n```\n修改后，在使用的时候只用这样：\n```\n<com.android.lovesixgod.library.ArcSeekBarParent\n        android:id=\"@+id/seek_bar\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"100dp\"\n        android:layout_marginTop=\"40dp\"\n        android:background=\"@color/colorAccent\"\n        app:arcColor=\"#000000\"\n        app:arcWidth=\"3dp\"\n        app:ballColor=\"#00ffff\"\n        app:ballSize=\"30dp\" />\n```\n相比之前简单了不少。\n代码中再设置档次改变的监听响应即可直接使用了：\n```\nArcSeekBarParent seekBar = (ArcSeekBarParent) findViewById(R.id.seek_bar);\nseekBar.setListener(new ArcSeekBarParent.OnProgressChangedListener() {\n    @Override\n    public void OnProgressChanged(int level) {\n        textView.setText(String.valueOf(level));\n    }\n});\n```\n\n代码已更新至[Github](https://github.com/LiJia92/CustomArcSeekBar)。\n","source":"_posts/make-wheel.md","raw":"---\ntitle: Android感悟之造轮子\ndate: 2016-09-12 11:17:11\ntags:\n - 自定义View\n---\n\n最近项目要添加一个点赞的效果，类似[这篇文章所说](http://www.jianshu.com/p/03fdcfd3ae9c)，其实效果是差不多的，便打算直接拿来用了，感谢这位大大制作的轮子~\n\n而后自己思考了一下，怎么样的轮子别人用起来才方便呢？为了实现``方便``，其实我们能做的事情有很多，这里说一下自己的感悟。\n\n下面我便拿着我之前写的一个自定义弧形SeekBar来说明，将其抽成一个三方库要做哪些事。\n\n<!-- more -->\n\n之前的代码结构是这样的：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel1.png)\n引用的时候是这样的：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel2.png)\n这显然是非常笨重的引用方式，那么改如何改进呢？\n\n## Library\n第一个最先想到的自然是将代码抽成一个library。然后项目要引用时候，直接gradle添加依赖即可。\n选择``New Module``，选择``Android Library``即可，然后将代码放在``src/main/java/包名``文件夹下，添加``compile project(':library')``依赖即可。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel3.png)\n\n## 精简引用方式\n之前的代码要用，我需要xml中引入三个自定义View，显得很繁杂。站在使用者的角度，若是只用引入一个自定义View，便简单多了。\n至于球的大小，球的颜色等独立的属性，通过自定义属性来进行设置即可。\n\n下面上一下修改后的代码，ArcSeekBarParent类：\n```\npublic class ArcSeekBarParent extends FrameLayout implements SeekBarBallView.OnSmoothScrollListener {\n\n    private PointF pointF1;                     // 起始点\n    private PointF pointF2;                     // 控制点\n    private PointF pointF3;                     // 终止点\n    private PointF circleCenter;                // 球的坐标\n    private int top;\n    private int right;\n    private int bottom;\n    private int left;\n    private float currentX;                     // 当前x坐标，用于控制圆球位置\n    private final static float LEVEL = 6f;      // 设置档次\n    private int currentLevel = 1;               // 当前档次\n\n    private OnProgressChangedListener listener; // 档次改变的监听\n    private Context context;\n\n    private SeekBarBallView ball;               // 球\n    private SeekBarArcView arc;                 // 弧\n    private int ballSize;                       // 球的大小\n    private String ballColor;                   // 球的颜色\n    private int arcWidth;                       // 弧的宽度\n    private String arcColor;                    // 弧的颜色\n\n    public ArcSeekBarParent(Context context) {\n        super(context);\n        init();\n    }\n\n    public ArcSeekBarParent(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        this.context = context;\n        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.ArcSeekBarParent);\n        ballSize = array.getDimensionPixelSize(R.styleable.ArcSeekBarParent_ballSize, 30);\n        arcWidth = array.getDimensionPixelSize(R.styleable.ArcSeekBarParent_arcWidth, 10);\n        ballColor = array.getString(R.styleable.ArcSeekBarParent_ballColor);\n        arcColor = array.getString(R.styleable.ArcSeekBarParent_arcColor);\n        array.recycle();\n        init();\n    }\n\n    private void init() {\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n        circleCenter = new PointF();\n\n        // 添加弧线View\n        if (arcColor == null) {\n            arcColor = \"#000000\";      // 当没有设置颜色时候，默认使用黑色\n        }\n        arc = new SeekBarArcView(context, arcColor, arcWidth);\n        arc.setLayoutParams(new FrameLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT));\n        addView(arc);\n\n        // 添加球View\n        if (ballColor == null) {\n            ballColor = \"#FFFFFF\";      // 当没有设置颜色时候，默认使用白色\n        }\n        ball = new SeekBarBallView(context, ballColor, ballSize);\n        ball.setListener(this);\n        addView(ball);\n    }\n\n    public void setListener(OnProgressChangedListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        this.left = left;\n        this.top = top;\n        this.right = right;\n        this.bottom = bottom;\n        pointF1.set(0, bottom - top - 30);\n        pointF2.set((right - left) / 2, -(bottom - top) / 4);\n        pointF3.set(right, bottom - top - 30);\n        currentX = (right - left) / LEVEL;\n        changeBallLayout(currentX);\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent event) {\n        switch (event.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                float downX = event.getX();\n                float downY = event.getY();\n                float distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);\n                // 计算到圆球中心的距离，考虑20的误差\n                return !(distance - (ball.getMeasuredWidth() / 2 + 20) * (ball.getMeasuredWidth() / 2 + 20) > 0);\n            case MotionEvent.ACTION_MOVE:\n                float moveX = event.getX();\n                currentX = moveX; // 通过x坐标改变圆球的位置\n                changeBallLayout(currentX);\n                currentLevel = getLevel(moveX);\n                if (listener != null) {\n                    listener.OnProgressChanged(currentLevel);\n                }\n                break;\n            default:\n                // 当手指移出或者离开View时，圆球平滑滑到最近的档次\n                ball.smoothScrollLevel((int) currentX, (int) ((right - left) / LEVEL * currentLevel - currentX));\n                break;\n        }\n        return super.onTouchEvent(event);\n    }\n\n    /**\n     * 改变球的位置\n     *\n     * @param currentX 横坐标\n     */\n    private void changeBallLayout(float currentX) {\n        float t = (currentX / (right - left));\n        float x = (1 - t) * (1 - t) * pointF1.x + 2 * (t) * (1 - t) * pointF2.x + t * t * pointF3.x;\n        float y = (1 - t) * (1 - t) * pointF1.y + 2 * (t) * (1 - t) * pointF2.y + t * t * pointF3.y;\n        circleCenter.set(x, y);\n        ball.layout((int) (circleCenter.x - ball.getMeasuredWidth() / 2), (int) (circleCenter.y - ball.getMeasuredWidth() / 2), (int) (circleCenter.x + ball.getMeasuredWidth() / 2), (int) (circleCenter.y + ball.getMeasuredWidth() / 2));\n    }\n\n    /**\n     * 计算档次\n     *\n     * @param x 横坐标\n     * @return 档次\n     */\n    private int getLevel(float x) {\n        float ratio = (x / (right - left)) * LEVEL;\n        // 计算距离哪个档次最近\n        int result = new BigDecimal(ratio).setScale(0, BigDecimal.ROUND_HALF_UP).intValue();\n        if (result < 1) {\n            result = 1;\n        } else if (result > (LEVEL - 1)) {\n            result = (int) (LEVEL - 1);\n        }\n        return result;\n    }\n\n    @Override\n    public void onSmoothScroll(int currentX) {\n        changeBallLayout(currentX);\n    }\n\n    /**\n     * 滑动接口\n     */\n    public interface OnProgressChangedListener {\n        void OnProgressChanged(int level);\n    }\n}\n```\nSeekBarArcView类：\n```\npublic class SeekBarArcView extends View {\n\n    private Paint paint;\n    private Path path;\n    private PointF pointF1;     // 起始点\n    private PointF pointF2;     // 控制点\n    private PointF pointF3;     // 终止点\n    private String arcColor;    // 弧的颜色\n    private int arcWidth;       // 弧的宽度\n\n    public SeekBarArcView(Context context, String arcColor, int arcWidth) {\n        super(context);\n        this.arcColor = arcColor;\n        this.arcWidth = arcWidth;\n        init();\n    }\n\n    private void init() {\n        paint = new Paint();\n        path = new Path();\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n        // 初始化画笔\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.parseColor(arcColor));\n        paint.setStrokeWidth(arcWidth);\n        paint.setStyle(Paint.Style.STROKE);\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        pointF1.set(0, bottom - top - 30);\n        pointF2.set((right - left) / 2, -(bottom - top) / 4);\n        pointF3.set(right, bottom - top - 30);\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n        // 画2阶贝塞尔曲线\n        path.moveTo(pointF1.x, pointF1.y);\n        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);\n        canvas.drawPath(path, paint);\n    }\n}\n```\nSeekBarBallView类：\n```\npublic class SeekBarBallView extends View {\n\n    private Paint paint;\n    private Scroller scroller;\n    private int ballSize;\n    private String ballColor;\n    private OnSmoothScrollListener listener;\n\n    public SeekBarBallView(Context context, String ballColor, int ballSize) {\n        super(context);\n        this.ballColor = ballColor;\n        this.ballSize = ballSize;\n        init(context);\n    }\n\n    private void init(Context context) {\n        scroller = new Scroller(context);\n        paint = new Paint();\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.parseColor(ballColor));\n        paint.setStyle(Paint.Style.FILL);\n    }\n\n    public void setListener(OnSmoothScrollListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n        int spec = MeasureSpec.makeMeasureSpec(ballSize, MeasureSpec.EXACTLY);\n        setMeasuredDimension(spec, spec);\n    }\n\n    @Override\n    public void computeScroll() {\n        if (scroller.computeScrollOffset()) {\n            if (listener != null) {\n                listener.onSmoothScroll(scroller.getCurrX());\n                postInvalidate();\n            }\n        }\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        canvas.drawCircle(getMeasuredWidth() / 2, getMeasuredWidth() / 2, getMeasuredWidth() / 2, paint);\n    }\n\n    /**\n     * 平滑滑动\n     *\n     * @param start    起始值\n     * @param distance 滑动距离\n     */\n    public void smoothScrollLevel(int start, int distance) {\n        scroller.startScroll(start, 0, distance, 0, 200);\n        postInvalidate();\n    }\n\n    public interface OnSmoothScrollListener {\n        void onSmoothScroll(int currentX);\n    }\n}\n```\n以及自定义属性attr.xml：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<resources>\n    <declare-styleable name=\"ArcSeekBarParent\">\n        <attr name=\"ballColor\" format=\"string\" />\n        <attr name=\"ballSize\" format=\"dimension\" />\n        <attr name=\"arcWidth\" format=\"dimension\" />\n        <attr name=\"arcColor\" format=\"string\" />\n    </declare-styleable>\n</resources>\n```\n修改后，在使用的时候只用这样：\n```\n<com.android.lovesixgod.library.ArcSeekBarParent\n        android:id=\"@+id/seek_bar\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"100dp\"\n        android:layout_marginTop=\"40dp\"\n        android:background=\"@color/colorAccent\"\n        app:arcColor=\"#000000\"\n        app:arcWidth=\"3dp\"\n        app:ballColor=\"#00ffff\"\n        app:ballSize=\"30dp\" />\n```\n相比之前简单了不少。\n代码中再设置档次改变的监听响应即可直接使用了：\n```\nArcSeekBarParent seekBar = (ArcSeekBarParent) findViewById(R.id.seek_bar);\nseekBar.setListener(new ArcSeekBarParent.OnProgressChangedListener() {\n    @Override\n    public void OnProgressChanged(int level) {\n        textView.setText(String.valueOf(level));\n    }\n});\n```\n\n代码已更新至[Github](https://github.com/LiJia92/CustomArcSeekBar)。\n","slug":"make-wheel","published":1,"updated":"2016-11-21T10:01:50.288Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759f001r1cb8h5haeohv","content":"<p>最近项目要添加一个点赞的效果，类似<a href=\"http://www.jianshu.com/p/03fdcfd3ae9c\" target=\"_blank\" rel=\"external\">这篇文章所说</a>，其实效果是差不多的，便打算直接拿来用了，感谢这位大大制作的轮子~</p>\n<p>而后自己思考了一下，怎么样的轮子别人用起来才方便呢？为了实现<code>方便</code>，其实我们能做的事情有很多，这里说一下自己的感悟。</p>\n<p>下面我便拿着我之前写的一个自定义弧形SeekBar来说明，将其抽成一个三方库要做哪些事。</p>\n<a id=\"more\"></a>\n<p>之前的代码结构是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel1.png\" alt=\"\"><br>引用的时候是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel2.png\" alt=\"\"><br>这显然是非常笨重的引用方式，那么改如何改进呢？</p>\n<h2 id=\"Library\"><a href=\"#Library\" class=\"headerlink\" title=\"Library\"></a>Library</h2><p>第一个最先想到的自然是将代码抽成一个library。然后项目要引用时候，直接gradle添加依赖即可。<br>选择<code>New Module</code>，选择<code>Android Library</code>即可，然后将代码放在<code>src/main/java/包名</code>文件夹下，添加<code>compile project(&#39;:library&#39;)</code>依赖即可。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel3.png\" alt=\"\"></p>\n<h2 id=\"精简引用方式\"><a href=\"#精简引用方式\" class=\"headerlink\" title=\"精简引用方式\"></a>精简引用方式</h2><p>之前的代码要用，我需要xml中引入三个自定义View，显得很繁杂。站在使用者的角度，若是只用引入一个自定义View，便简单多了。<br>至于球的大小，球的颜色等独立的属性，通过自定义属性来进行设置即可。</p>\n<p>下面上一下修改后的代码，ArcSeekBarParent类：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ArcSeekBarParent</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrameLayout</span> <span class=\"keyword\">implements</span> <span class=\"title\">SeekBarBallView</span>.<span class=\"title\">OnSmoothScrollListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1;                     <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2;                     <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3;                     <span class=\"comment\">// 终止点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF circleCenter;                <span class=\"comment\">// 球的坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> top;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> right;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> bottom;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> left;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> currentX;                     <span class=\"comment\">// 当前x坐标，用于控制圆球位置</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">float</span> LEVEL = <span class=\"number\">6</span>f;      <span class=\"comment\">// 设置档次</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> currentLevel = <span class=\"number\">1</span>;               <span class=\"comment\">// 当前档次</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> OnProgressChangedListener listener; <span class=\"comment\">// 档次改变的监听</span></div><div class=\"line\">    <span class=\"keyword\">private</span> Context context;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> SeekBarBallView ball;               <span class=\"comment\">// 球</span></div><div class=\"line\">    <span class=\"keyword\">private</span> SeekBarArcView arc;                 <span class=\"comment\">// 弧</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> ballSize;                       <span class=\"comment\">// 球的大小</span></div><div class=\"line\">    <span class=\"keyword\">private</span> String ballColor;                   <span class=\"comment\">// 球的颜色</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> arcWidth;                       <span class=\"comment\">// 弧的宽度</span></div><div class=\"line\">    <span class=\"keyword\">private</span> String arcColor;                    <span class=\"comment\">// 弧的颜色</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        <span class=\"keyword\">this</span>.context = context;</div><div class=\"line\">        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.ArcSeekBarParent);</div><div class=\"line\">        ballSize = array.getDimensionPixelSize(R.styleable.ArcSeekBarParent_ballSize, <span class=\"number\">30</span>);</div><div class=\"line\">        arcWidth = array.getDimensionPixelSize(R.styleable.ArcSeekBarParent_arcWidth, <span class=\"number\">10</span>);</div><div class=\"line\">        ballColor = array.getString(R.styleable.ArcSeekBarParent_ballColor);</div><div class=\"line\">        arcColor = array.getString(R.styleable.ArcSeekBarParent_arcColor);</div><div class=\"line\">        array.recycle();</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        circleCenter = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 添加弧线View</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (arcColor == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            arcColor = <span class=\"string\">\"#000000\"</span>;      <span class=\"comment\">// 当没有设置颜色时候，默认使用黑色</span></div><div class=\"line\">        &#125;</div><div class=\"line\">        arc = <span class=\"keyword\">new</span> SeekBarArcView(context, arcColor, arcWidth);</div><div class=\"line\">        arc.setLayoutParams(<span class=\"keyword\">new</span> FrameLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT));</div><div class=\"line\">        addView(arc);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 添加球View</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (ballColor == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            ballColor = <span class=\"string\">\"#FFFFFF\"</span>;      <span class=\"comment\">// 当没有设置颜色时候，默认使用白色</span></div><div class=\"line\">        &#125;</div><div class=\"line\">        ball = <span class=\"keyword\">new</span> SeekBarBallView(context, ballColor, ballSize);</div><div class=\"line\">        ball.setListener(<span class=\"keyword\">this</span>);</div><div class=\"line\">        addView(ball);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnProgressChangedListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        <span class=\"keyword\">this</span>.left = left;</div><div class=\"line\">        <span class=\"keyword\">this</span>.top = top;</div><div class=\"line\">        <span class=\"keyword\">this</span>.right = right;</div><div class=\"line\">        <span class=\"keyword\">this</span>.bottom = bottom;</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">4</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        currentX = (right - left) / LEVEL;</div><div class=\"line\">        changeBallLayout(currentX);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (event.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                <span class=\"keyword\">float</span> downX = event.getX();</div><div class=\"line\">                <span class=\"keyword\">float</span> downY = event.getY();</div><div class=\"line\">                <span class=\"keyword\">float</span> distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);</div><div class=\"line\">                <span class=\"comment\">// 计算到圆球中心的距离，考虑20的误差</span></div><div class=\"line\">                <span class=\"keyword\">return</span> !(distance - (ball.getMeasuredWidth() / <span class=\"number\">2</span> + <span class=\"number\">20</span>) * (ball.getMeasuredWidth() / <span class=\"number\">2</span> + <span class=\"number\">20</span>) &gt; <span class=\"number\">0</span>);</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = event.getX();</div><div class=\"line\">                currentX = moveX; <span class=\"comment\">// 通过x坐标改变圆球的位置</span></div><div class=\"line\">                changeBallLayout(currentX);</div><div class=\"line\">                currentLevel = getLevel(moveX);</div><div class=\"line\">                <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    listener.OnProgressChanged(currentLevel);</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">default</span>:</div><div class=\"line\">                // 当手指移出或者离开View时，圆球平滑滑到最近的档次</div><div class=\"line\">                ball.smoothScrollLevel((<span class=\"keyword\">int</span>) currentX, (<span class=\"keyword\">int</span>) ((right - left) / LEVEL * currentLevel - currentX));</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 改变球的位置</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> currentX 横坐标</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">changeBallLayout</span><span class=\"params\">(<span class=\"keyword\">float</span> currentX)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> t = (currentX / (right - left));</div><div class=\"line\">        <span class=\"keyword\">float</span> x = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.x + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.x + t * t * pointF3.x;</div><div class=\"line\">        <span class=\"keyword\">float</span> y = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.y + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.y + t * t * pointF3.y;</div><div class=\"line\">        circleCenter.set(x, y);</div><div class=\"line\">        ball.layout((<span class=\"keyword\">int</span>) (circleCenter.x - ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.y - ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.x + ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.y + ball.getMeasuredWidth() / <span class=\"number\">2</span>));</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 计算档次</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> x 横坐标</div><div class=\"line\">     * <span class=\"doctag\">@return</span> 档次</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getLevel</span><span class=\"params\">(<span class=\"keyword\">float</span> x)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> ratio = (x / (right - left)) * LEVEL;</div><div class=\"line\">        <span class=\"comment\">// 计算距离哪个档次最近</span></div><div class=\"line\">        <span class=\"keyword\">int</span> result = <span class=\"keyword\">new</span> BigDecimal(ratio).setScale(<span class=\"number\">0</span>, BigDecimal.ROUND_HALF_UP).intValue();</div><div class=\"line\">        <span class=\"keyword\">if</span> (result &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\">            result = <span class=\"number\">1</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (result &gt; (LEVEL - <span class=\"number\">1</span>)) &#123;</div><div class=\"line\">            result = (<span class=\"keyword\">int</span>) (LEVEL - <span class=\"number\">1</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> result;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onSmoothScroll</span><span class=\"params\">(<span class=\"keyword\">int</span> currentX)</span> </span>&#123;</div><div class=\"line\">        changeBallLayout(currentX);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 滑动接口</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnProgressChangedListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>SeekBarArcView类：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SeekBarArcView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Path path;</div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1;     <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2;     <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3;     <span class=\"comment\">// 终止点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> String arcColor;    <span class=\"comment\">// 弧的颜色</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> arcWidth;       <span class=\"comment\">// 弧的宽度</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarArcView</span><span class=\"params\">(Context context, String arcColor, <span class=\"keyword\">int</span> arcWidth)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        <span class=\"keyword\">this</span>.arcColor = arcColor;</div><div class=\"line\">        <span class=\"keyword\">this</span>.arcWidth = arcWidth;</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        path = <span class=\"keyword\">new</span> Path();</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        <span class=\"comment\">// 初始化画笔</span></div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.parseColor(arcColor));</div><div class=\"line\">        paint.setStrokeWidth(arcWidth);</div><div class=\"line\">        paint.setStyle(Paint.Style.STROKE);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">4</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">        <span class=\"comment\">// 画2阶贝塞尔曲线</span></div><div class=\"line\">        path.moveTo(pointF1.x, pointF1.y);</div><div class=\"line\">        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);</div><div class=\"line\">        canvas.drawPath(path, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>SeekBarBallView类：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SeekBarBallView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller scroller;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> ballSize;</div><div class=\"line\">    <span class=\"keyword\">private</span> String ballColor;</div><div class=\"line\">    <span class=\"keyword\">private</span> OnSmoothScrollListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarBallView</span><span class=\"params\">(Context context, String ballColor, <span class=\"keyword\">int</span> ballSize)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        <span class=\"keyword\">this</span>.ballColor = ballColor;</div><div class=\"line\">        <span class=\"keyword\">this</span>.ballSize = ballSize;</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        scroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.parseColor(ballColor));</div><div class=\"line\">        paint.setStyle(Paint.Style.FILL);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnSmoothScrollListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onMeasure</span><span class=\"params\">(<span class=\"keyword\">int</span> widthMeasureSpec, <span class=\"keyword\">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">int</span> spec = MeasureSpec.makeMeasureSpec(ballSize, MeasureSpec.EXACTLY);</div><div class=\"line\">        setMeasuredDimension(spec, spec);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scroller.computeScrollOffset()) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                listener.onSmoothScroll(scroller.getCurrX());</div><div class=\"line\">                postInvalidate();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        canvas.drawCircle(getMeasuredWidth() / <span class=\"number\">2</span>, getMeasuredWidth() / <span class=\"number\">2</span>, getMeasuredWidth() / <span class=\"number\">2</span>, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 平滑滑动</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> start    起始值</div><div class=\"line\">     * <span class=\"doctag\">@param</span> distance 滑动距离</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">smoothScrollLevel</span><span class=\"params\">(<span class=\"keyword\">int</span> start, <span class=\"keyword\">int</span> distance)</span> </span>&#123;</div><div class=\"line\">        scroller.startScroll(start, <span class=\"number\">0</span>, distance, <span class=\"number\">0</span>, <span class=\"number\">200</span>);</div><div class=\"line\">        postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnSmoothScrollListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onSmoothScroll</span><span class=\"params\">(<span class=\"keyword\">int</span> currentX)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>以及自定义属性attr.xml：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">declare-styleable</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ArcSeekBarParent\"</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ballColor\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"string\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ballSize\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"dimension\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"arcWidth\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"dimension\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"arcColor\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"string\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">declare-styleable</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>修改后，在使用的时候只用这样：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.library</span><span class=\"selector-class\">.ArcSeekBarParent</span></div><div class=\"line\">        android:id=<span class=\"string\">\"@+id/seek_bar\"</span></div><div class=\"line\">        android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"100dp\"</span></div><div class=\"line\">        android:layout_marginTop=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">        android:<span class=\"attribute\">background</span>=<span class=\"string\">\"@color/colorAccent\"</span></div><div class=\"line\">        app:arcColor=<span class=\"string\">\"#000000\"</span></div><div class=\"line\">        app:arcWidth=<span class=\"string\">\"3dp\"</span></div><div class=\"line\">        app:ballColor=<span class=\"string\">\"#00ffff\"</span></div><div class=\"line\">        app:ballSize=<span class=\"string\">\"30dp\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>相比之前简单了不少。<br>代码中再设置档次改变的监听响应即可直接使用了：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">ArcSeekBarParent seekBar = (ArcSeekBarParent) findViewById(R.id.seek_bar);</div><div class=\"line\">seekBar.setListener(<span class=\"keyword\">new</span> ArcSeekBarParent.OnProgressChangedListener() &#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span> </span>&#123;</div><div class=\"line\">        textView.setText(String.valueOf(level));</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>代码已更新至<a href=\"https://github.com/LiJia92/CustomArcSeekBar\" target=\"_blank\" rel=\"external\">Github</a>。</p>\n","excerpt":"<p>最近项目要添加一个点赞的效果，类似<a href=\"http://www.jianshu.com/p/03fdcfd3ae9c\">这篇文章所说</a>，其实效果是差不多的，便打算直接拿来用了，感谢这位大大制作的轮子~</p>\n<p>而后自己思考了一下，怎么样的轮子别人用起来才方便呢？为了实现<code>方便</code>，其实我们能做的事情有很多，这里说一下自己的感悟。</p>\n<p>下面我便拿着我之前写的一个自定义弧形SeekBar来说明，将其抽成一个三方库要做哪些事。</p>","more":"<p>之前的代码结构是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel1.png\" alt=\"\"><br>引用的时候是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel2.png\" alt=\"\"><br>这显然是非常笨重的引用方式，那么改如何改进呢？</p>\n<h2 id=\"Library\"><a href=\"#Library\" class=\"headerlink\" title=\"Library\"></a>Library</h2><p>第一个最先想到的自然是将代码抽成一个library。然后项目要引用时候，直接gradle添加依赖即可。<br>选择<code>New Module</code>，选择<code>Android Library</code>即可，然后将代码放在<code>src/main/java/包名</code>文件夹下，添加<code>compile project(&#39;:library&#39;)</code>依赖即可。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/wheel3.png\" alt=\"\"></p>\n<h2 id=\"精简引用方式\"><a href=\"#精简引用方式\" class=\"headerlink\" title=\"精简引用方式\"></a>精简引用方式</h2><p>之前的代码要用，我需要xml中引入三个自定义View，显得很繁杂。站在使用者的角度，若是只用引入一个自定义View，便简单多了。<br>至于球的大小，球的颜色等独立的属性，通过自定义属性来进行设置即可。</p>\n<p>下面上一下修改后的代码，ArcSeekBarParent类：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ArcSeekBarParent</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrameLayout</span> <span class=\"keyword\">implements</span> <span class=\"title\">SeekBarBallView</span>.<span class=\"title\">OnSmoothScrollListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1;                     <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2;                     <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3;                     <span class=\"comment\">// 终止点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF circleCenter;                <span class=\"comment\">// 球的坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> top;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> right;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> bottom;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> left;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> currentX;                     <span class=\"comment\">// 当前x坐标，用于控制圆球位置</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">float</span> LEVEL = <span class=\"number\">6</span>f;      <span class=\"comment\">// 设置档次</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> currentLevel = <span class=\"number\">1</span>;               <span class=\"comment\">// 当前档次</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> OnProgressChangedListener listener; <span class=\"comment\">// 档次改变的监听</span></div><div class=\"line\">    <span class=\"keyword\">private</span> Context context;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> SeekBarBallView ball;               <span class=\"comment\">// 球</span></div><div class=\"line\">    <span class=\"keyword\">private</span> SeekBarArcView arc;                 <span class=\"comment\">// 弧</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> ballSize;                       <span class=\"comment\">// 球的大小</span></div><div class=\"line\">    <span class=\"keyword\">private</span> String ballColor;                   <span class=\"comment\">// 球的颜色</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> arcWidth;                       <span class=\"comment\">// 弧的宽度</span></div><div class=\"line\">    <span class=\"keyword\">private</span> String arcColor;                    <span class=\"comment\">// 弧的颜色</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        <span class=\"keyword\">this</span>.context = context;</div><div class=\"line\">        TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.ArcSeekBarParent);</div><div class=\"line\">        ballSize = array.getDimensionPixelSize(R.styleable.ArcSeekBarParent_ballSize, <span class=\"number\">30</span>);</div><div class=\"line\">        arcWidth = array.getDimensionPixelSize(R.styleable.ArcSeekBarParent_arcWidth, <span class=\"number\">10</span>);</div><div class=\"line\">        ballColor = array.getString(R.styleable.ArcSeekBarParent_ballColor);</div><div class=\"line\">        arcColor = array.getString(R.styleable.ArcSeekBarParent_arcColor);</div><div class=\"line\">        array.recycle();</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        circleCenter = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 添加弧线View</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (arcColor == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            arcColor = <span class=\"string\">\"#000000\"</span>;      <span class=\"comment\">// 当没有设置颜色时候，默认使用黑色</span></div><div class=\"line\">        &#125;</div><div class=\"line\">        arc = <span class=\"keyword\">new</span> SeekBarArcView(context, arcColor, arcWidth);</div><div class=\"line\">        arc.setLayoutParams(<span class=\"keyword\">new</span> FrameLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT));</div><div class=\"line\">        addView(arc);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 添加球View</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (ballColor == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            ballColor = <span class=\"string\">\"#FFFFFF\"</span>;      <span class=\"comment\">// 当没有设置颜色时候，默认使用白色</span></div><div class=\"line\">        &#125;</div><div class=\"line\">        ball = <span class=\"keyword\">new</span> SeekBarBallView(context, ballColor, ballSize);</div><div class=\"line\">        ball.setListener(<span class=\"keyword\">this</span>);</div><div class=\"line\">        addView(ball);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnProgressChangedListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        <span class=\"keyword\">this</span>.left = left;</div><div class=\"line\">        <span class=\"keyword\">this</span>.top = top;</div><div class=\"line\">        <span class=\"keyword\">this</span>.right = right;</div><div class=\"line\">        <span class=\"keyword\">this</span>.bottom = bottom;</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">4</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        currentX = (right - left) / LEVEL;</div><div class=\"line\">        changeBallLayout(currentX);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (event.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                <span class=\"keyword\">float</span> downX = event.getX();</div><div class=\"line\">                <span class=\"keyword\">float</span> downY = event.getY();</div><div class=\"line\">                <span class=\"keyword\">float</span> distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);</div><div class=\"line\">                <span class=\"comment\">// 计算到圆球中心的距离，考虑20的误差</span></div><div class=\"line\">                <span class=\"keyword\">return</span> !(distance - (ball.getMeasuredWidth() / <span class=\"number\">2</span> + <span class=\"number\">20</span>) * (ball.getMeasuredWidth() / <span class=\"number\">2</span> + <span class=\"number\">20</span>) &gt; <span class=\"number\">0</span>);</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = event.getX();</div><div class=\"line\">                currentX = moveX; <span class=\"comment\">// 通过x坐标改变圆球的位置</span></div><div class=\"line\">                changeBallLayout(currentX);</div><div class=\"line\">                currentLevel = getLevel(moveX);</div><div class=\"line\">                <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    listener.OnProgressChanged(currentLevel);</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">default</span>:</div><div class=\"line\">                // 当手指移出或者离开View时，圆球平滑滑到最近的档次</div><div class=\"line\">                ball.smoothScrollLevel((<span class=\"keyword\">int</span>) currentX, (<span class=\"keyword\">int</span>) ((right - left) / LEVEL * currentLevel - currentX));</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 改变球的位置</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> currentX 横坐标</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">changeBallLayout</span><span class=\"params\">(<span class=\"keyword\">float</span> currentX)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> t = (currentX / (right - left));</div><div class=\"line\">        <span class=\"keyword\">float</span> x = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.x + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.x + t * t * pointF3.x;</div><div class=\"line\">        <span class=\"keyword\">float</span> y = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.y + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.y + t * t * pointF3.y;</div><div class=\"line\">        circleCenter.set(x, y);</div><div class=\"line\">        ball.layout((<span class=\"keyword\">int</span>) (circleCenter.x - ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.y - ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.x + ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.y + ball.getMeasuredWidth() / <span class=\"number\">2</span>));</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 计算档次</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> x 横坐标</div><div class=\"line\">     * <span class=\"doctag\">@return</span> 档次</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getLevel</span><span class=\"params\">(<span class=\"keyword\">float</span> x)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> ratio = (x / (right - left)) * LEVEL;</div><div class=\"line\">        <span class=\"comment\">// 计算距离哪个档次最近</span></div><div class=\"line\">        <span class=\"keyword\">int</span> result = <span class=\"keyword\">new</span> BigDecimal(ratio).setScale(<span class=\"number\">0</span>, BigDecimal.ROUND_HALF_UP).intValue();</div><div class=\"line\">        <span class=\"keyword\">if</span> (result &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\">            result = <span class=\"number\">1</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (result &gt; (LEVEL - <span class=\"number\">1</span>)) &#123;</div><div class=\"line\">            result = (<span class=\"keyword\">int</span>) (LEVEL - <span class=\"number\">1</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> result;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onSmoothScroll</span><span class=\"params\">(<span class=\"keyword\">int</span> currentX)</span> </span>&#123;</div><div class=\"line\">        changeBallLayout(currentX);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 滑动接口</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnProgressChangedListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>SeekBarArcView类：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SeekBarArcView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Path path;</div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1;     <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2;     <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3;     <span class=\"comment\">// 终止点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> String arcColor;    <span class=\"comment\">// 弧的颜色</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> arcWidth;       <span class=\"comment\">// 弧的宽度</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarArcView</span><span class=\"params\">(Context context, String arcColor, <span class=\"keyword\">int</span> arcWidth)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        <span class=\"keyword\">this</span>.arcColor = arcColor;</div><div class=\"line\">        <span class=\"keyword\">this</span>.arcWidth = arcWidth;</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        path = <span class=\"keyword\">new</span> Path();</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        <span class=\"comment\">// 初始化画笔</span></div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.parseColor(arcColor));</div><div class=\"line\">        paint.setStrokeWidth(arcWidth);</div><div class=\"line\">        paint.setStyle(Paint.Style.STROKE);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">4</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">        <span class=\"comment\">// 画2阶贝塞尔曲线</span></div><div class=\"line\">        path.moveTo(pointF1.x, pointF1.y);</div><div class=\"line\">        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);</div><div class=\"line\">        canvas.drawPath(path, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>SeekBarBallView类：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SeekBarBallView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller scroller;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> ballSize;</div><div class=\"line\">    <span class=\"keyword\">private</span> String ballColor;</div><div class=\"line\">    <span class=\"keyword\">private</span> OnSmoothScrollListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarBallView</span><span class=\"params\">(Context context, String ballColor, <span class=\"keyword\">int</span> ballSize)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        <span class=\"keyword\">this</span>.ballColor = ballColor;</div><div class=\"line\">        <span class=\"keyword\">this</span>.ballSize = ballSize;</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        scroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.parseColor(ballColor));</div><div class=\"line\">        paint.setStyle(Paint.Style.FILL);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnSmoothScrollListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onMeasure</span><span class=\"params\">(<span class=\"keyword\">int</span> widthMeasureSpec, <span class=\"keyword\">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">int</span> spec = MeasureSpec.makeMeasureSpec(ballSize, MeasureSpec.EXACTLY);</div><div class=\"line\">        setMeasuredDimension(spec, spec);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scroller.computeScrollOffset()) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                listener.onSmoothScroll(scroller.getCurrX());</div><div class=\"line\">                postInvalidate();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        canvas.drawCircle(getMeasuredWidth() / <span class=\"number\">2</span>, getMeasuredWidth() / <span class=\"number\">2</span>, getMeasuredWidth() / <span class=\"number\">2</span>, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 平滑滑动</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> start    起始值</div><div class=\"line\">     * <span class=\"doctag\">@param</span> distance 滑动距离</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">smoothScrollLevel</span><span class=\"params\">(<span class=\"keyword\">int</span> start, <span class=\"keyword\">int</span> distance)</span> </span>&#123;</div><div class=\"line\">        scroller.startScroll(start, <span class=\"number\">0</span>, distance, <span class=\"number\">0</span>, <span class=\"number\">200</span>);</div><div class=\"line\">        postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnSmoothScrollListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onSmoothScroll</span><span class=\"params\">(<span class=\"keyword\">int</span> currentX)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>以及自定义属性attr.xml：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">declare-styleable</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ArcSeekBarParent\"</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ballColor\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"string\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"ballSize\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"dimension\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"arcWidth\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"dimension\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">attr</span> <span class=\"attr\">name</span>=<span class=\"string\">\"arcColor\"</span> <span class=\"attr\">format</span>=<span class=\"string\">\"string\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">declare-styleable</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>修改后，在使用的时候只用这样：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.library</span><span class=\"selector-class\">.ArcSeekBarParent</span></div><div class=\"line\">        android:id=<span class=\"string\">\"@+id/seek_bar\"</span></div><div class=\"line\">        android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"100dp\"</span></div><div class=\"line\">        android:layout_marginTop=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">        android:<span class=\"attribute\">background</span>=<span class=\"string\">\"@color/colorAccent\"</span></div><div class=\"line\">        app:arcColor=<span class=\"string\">\"#000000\"</span></div><div class=\"line\">        app:arcWidth=<span class=\"string\">\"3dp\"</span></div><div class=\"line\">        app:ballColor=<span class=\"string\">\"#00ffff\"</span></div><div class=\"line\">        app:ballSize=<span class=\"string\">\"30dp\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>相比之前简单了不少。<br>代码中再设置档次改变的监听响应即可直接使用了：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">ArcSeekBarParent seekBar = (ArcSeekBarParent) findViewById(R.id.seek_bar);</div><div class=\"line\">seekBar.setListener(<span class=\"keyword\">new</span> ArcSeekBarParent.OnProgressChangedListener() &#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span> </span>&#123;</div><div class=\"line\">        textView.setText(String.valueOf(level));</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>代码已更新至<a href=\"https://github.com/LiJia92/CustomArcSeekBar\">Github</a>。</p>"},{"title":"【Android音视频开发】- 直播","date":"2016-10-19T10:05:45.000Z","_content":"\n## 前言\n2015 ~ 1016是直播大火的年代，最近公司也是在着手直播这块，作为Android开发，自然也要懂得一些知识，经过一段时间的调研，学习，作了一下自我总结，写了一个``【Android音视频开发】``系列，此文便是开篇了！\nPS：关于这块的文章着实太少，点开10个链接，有7、8个链接的内容是一样的，各种转来转去，也是耗费了很大的功夫才了解到音视频的一点皮毛。而且很多文章都是12年、13年的，拿到现在可能根本就不适用，我通过实例验证，做下此总结。最近一直在看这一块的东西，今天抽空，趁着记忆的知识还比较新鲜记下来，好记性不如烂笔头，也希望能帮助到其他的人。\n\n## 直播\n从技术层面上来，直播大致分为：音视频采集、美颜/滤镜/特效处理、编码、封包、推流、分发、解码/渲染/播放。\n对应到具体的Android层面，便会有如下几个重要环节：\n1. 视频实时采集：Camera预览/MediaRecorder绑定LocalSocket\n2. 音频实时采集：MediaRecorder/AudioRecord/OpenSL ES\n3. 特效处理：视频磨皮美颜，音频降噪去回声等算法\n4. 编解码：H264&AAC，MediaCodec(API >= 16)硬解，ffmpeg等三方库软解\n5. 流媒体传输：rtmp rtsp hls等\n6. 渲染播放：MediaPlayer，ijkplayer等三方库\n\n<!-- more -->\n\n## 科普\n### 编解码\n采集到的原始音视频数据是非常大的，不利于传输，所以就需要对这些数据进行压缩，这个过程就是编码。解码则是编码的逆向过程。编码分为硬编码、软编码，解码也是如此。\n - 硬编码：使用非CPU进行编码，如显卡GPU、专用的DSP、FPGA、ASIC芯片等。性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。\n - 软编码：使用CPU进行编码。性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。\n\n关于音视频压缩编码的基本原理可以参见雷神的[这篇文章](http://blog.csdn.net/leixiaohua1020/article/details/28114081)。\n\n### 视频编码\n视频编码的主要作用是将视频像素数据（RGB，YUV等）压缩成为视频码流，从而降低视频的数据量。主要视频编码一览：\n\n| 名称  | 推出即构| 退出时间 | 目前使用领域 |\n| ----- | -------- |-------------| ----- |\n| HEVC(H.265)   | MPEG/ITU-T | 2013 | 研发中 |\n| H.264 | MPEG/ITU-T | 2003 | 各个领域 |\n| MPEG4 | MPEG | 2001 | 不温不火 |\n| MPEG2 | MPEG| 1994 | 研发中 |\n| VP9   | Google | 2013 | 研发中 |\n| VP8   | Google | 2008 | 不普及 |\n| VC-1  | Microsoft Inc. | 2006 | 微软平台 |\n\n不难看出，目前主流的视频编码便是H264了，我们项目中选取的也是此编码标准。\n\n### 音频编码\n音频编码的主要作用是将音频采样数据（PCM等）压缩成为音频码流，从而降低音频的数据量。主要音频编码一览：\n\n| 名称 | 推出即构| 退出时间 | 目前使用领域 |\n| ----- | -------- |-------------| ----- |\n| AAC   | MPEG | 1997 | 各个领域（新） |\n| AC-3  | Dolby Inc. | 1992 | 电影 |\n| MP3   | MPEG | 1993 | 各个领域（旧） |\n| WMA   | Microsoft Inc.| 1999 | 微软平台 |\n\n那么主流的音频编码便是AAC了，项目选取的也是此编码标准。\n\n## 参考\n[如何搭建一个完整的视频直播系统？](https://www.zhihu.com/question/42162310)\n[android音视频点/直播模块开发](http://www.jianshu.com/p/8436c7353296)\n[视音频编解码技术零基础学习方法](http://blog.csdn.net/leixiaohua1020/article/details/18893769)\n[移动直播技术秒开优化经验](http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=2653547042&idx=1&sn=26d8728548a6b5b657079eeab121e283&scene=1&srcid=0428msEitG9LJ3JaKGaRCEjg&from=groupmessage&isappinstalled=0#wechat_redirect)\n[从0到1打造直播 App](http://dev.qq.com/topic/5811d42e7fd6ec467453bf58)\n","source":"_posts/live.md","raw":"---\ntitle: 【Android音视频开发】- 直播\ndate: 2016-10-19 18:05:45\ntags:\n - 直播\n---\n\n## 前言\n2015 ~ 1016是直播大火的年代，最近公司也是在着手直播这块，作为Android开发，自然也要懂得一些知识，经过一段时间的调研，学习，作了一下自我总结，写了一个``【Android音视频开发】``系列，此文便是开篇了！\nPS：关于这块的文章着实太少，点开10个链接，有7、8个链接的内容是一样的，各种转来转去，也是耗费了很大的功夫才了解到音视频的一点皮毛。而且很多文章都是12年、13年的，拿到现在可能根本就不适用，我通过实例验证，做下此总结。最近一直在看这一块的东西，今天抽空，趁着记忆的知识还比较新鲜记下来，好记性不如烂笔头，也希望能帮助到其他的人。\n\n## 直播\n从技术层面上来，直播大致分为：音视频采集、美颜/滤镜/特效处理、编码、封包、推流、分发、解码/渲染/播放。\n对应到具体的Android层面，便会有如下几个重要环节：\n1. 视频实时采集：Camera预览/MediaRecorder绑定LocalSocket\n2. 音频实时采集：MediaRecorder/AudioRecord/OpenSL ES\n3. 特效处理：视频磨皮美颜，音频降噪去回声等算法\n4. 编解码：H264&AAC，MediaCodec(API >= 16)硬解，ffmpeg等三方库软解\n5. 流媒体传输：rtmp rtsp hls等\n6. 渲染播放：MediaPlayer，ijkplayer等三方库\n\n<!-- more -->\n\n## 科普\n### 编解码\n采集到的原始音视频数据是非常大的，不利于传输，所以就需要对这些数据进行压缩，这个过程就是编码。解码则是编码的逆向过程。编码分为硬编码、软编码，解码也是如此。\n - 硬编码：使用非CPU进行编码，如显卡GPU、专用的DSP、FPGA、ASIC芯片等。性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。\n - 软编码：使用CPU进行编码。性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。\n\n关于音视频压缩编码的基本原理可以参见雷神的[这篇文章](http://blog.csdn.net/leixiaohua1020/article/details/28114081)。\n\n### 视频编码\n视频编码的主要作用是将视频像素数据（RGB，YUV等）压缩成为视频码流，从而降低视频的数据量。主要视频编码一览：\n\n| 名称  | 推出即构| 退出时间 | 目前使用领域 |\n| ----- | -------- |-------------| ----- |\n| HEVC(H.265)   | MPEG/ITU-T | 2013 | 研发中 |\n| H.264 | MPEG/ITU-T | 2003 | 各个领域 |\n| MPEG4 | MPEG | 2001 | 不温不火 |\n| MPEG2 | MPEG| 1994 | 研发中 |\n| VP9   | Google | 2013 | 研发中 |\n| VP8   | Google | 2008 | 不普及 |\n| VC-1  | Microsoft Inc. | 2006 | 微软平台 |\n\n不难看出，目前主流的视频编码便是H264了，我们项目中选取的也是此编码标准。\n\n### 音频编码\n音频编码的主要作用是将音频采样数据（PCM等）压缩成为音频码流，从而降低音频的数据量。主要音频编码一览：\n\n| 名称 | 推出即构| 退出时间 | 目前使用领域 |\n| ----- | -------- |-------------| ----- |\n| AAC   | MPEG | 1997 | 各个领域（新） |\n| AC-3  | Dolby Inc. | 1992 | 电影 |\n| MP3   | MPEG | 1993 | 各个领域（旧） |\n| WMA   | Microsoft Inc.| 1999 | 微软平台 |\n\n那么主流的音频编码便是AAC了，项目选取的也是此编码标准。\n\n## 参考\n[如何搭建一个完整的视频直播系统？](https://www.zhihu.com/question/42162310)\n[android音视频点/直播模块开发](http://www.jianshu.com/p/8436c7353296)\n[视音频编解码技术零基础学习方法](http://blog.csdn.net/leixiaohua1020/article/details/18893769)\n[移动直播技术秒开优化经验](http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=2653547042&idx=1&sn=26d8728548a6b5b657079eeab121e283&scene=1&srcid=0428msEitG9LJ3JaKGaRCEjg&from=groupmessage&isappinstalled=0#wechat_redirect)\n[从0到1打造直播 App](http://dev.qq.com/topic/5811d42e7fd6ec467453bf58)\n","slug":"live","published":1,"updated":"2016-11-28T08:39:47.298Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759h001u1cb8nci53xai","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>2015 ~ 1016是直播大火的年代，最近公司也是在着手直播这块，作为Android开发，自然也要懂得一些知识，经过一段时间的调研，学习，作了一下自我总结，写了一个<code>【Android音视频开发】</code>系列，此文便是开篇了！<br>PS：关于这块的文章着实太少，点开10个链接，有7、8个链接的内容是一样的，各种转来转去，也是耗费了很大的功夫才了解到音视频的一点皮毛。而且很多文章都是12年、13年的，拿到现在可能根本就不适用，我通过实例验证，做下此总结。最近一直在看这一块的东西，今天抽空，趁着记忆的知识还比较新鲜记下来，好记性不如烂笔头，也希望能帮助到其他的人。</p>\n<h2 id=\"直播\"><a href=\"#直播\" class=\"headerlink\" title=\"直播\"></a>直播</h2><p>从技术层面上来，直播大致分为：音视频采集、美颜/滤镜/特效处理、编码、封包、推流、分发、解码/渲染/播放。<br>对应到具体的Android层面，便会有如下几个重要环节：</p>\n<ol>\n<li>视频实时采集：Camera预览/MediaRecorder绑定LocalSocket</li>\n<li>音频实时采集：MediaRecorder/AudioRecord/OpenSL ES</li>\n<li>特效处理：视频磨皮美颜，音频降噪去回声等算法</li>\n<li>编解码：H264&amp;AAC，MediaCodec(API &gt;= 16)硬解，ffmpeg等三方库软解</li>\n<li>流媒体传输：rtmp rtsp hls等</li>\n<li>渲染播放：MediaPlayer，ijkplayer等三方库</li>\n</ol>\n<a id=\"more\"></a>\n<h2 id=\"科普\"><a href=\"#科普\" class=\"headerlink\" title=\"科普\"></a>科普</h2><h3 id=\"编解码\"><a href=\"#编解码\" class=\"headerlink\" title=\"编解码\"></a>编解码</h3><p>采集到的原始音视频数据是非常大的，不利于传输，所以就需要对这些数据进行压缩，这个过程就是编码。解码则是编码的逆向过程。编码分为硬编码、软编码，解码也是如此。</p>\n<ul>\n<li>硬编码：使用非CPU进行编码，如显卡GPU、专用的DSP、FPGA、ASIC芯片等。性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。</li>\n<li>软编码：使用CPU进行编码。性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。</li>\n</ul>\n<p>关于音视频压缩编码的基本原理可以参见雷神的<a href=\"http://blog.csdn.net/leixiaohua1020/article/details/28114081\" target=\"_blank\" rel=\"external\">这篇文章</a>。</p>\n<h3 id=\"视频编码\"><a href=\"#视频编码\" class=\"headerlink\" title=\"视频编码\"></a>视频编码</h3><p>视频编码的主要作用是将视频像素数据（RGB，YUV等）压缩成为视频码流，从而降低视频的数据量。主要视频编码一览：</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>推出即构</th>\n<th>退出时间</th>\n<th>目前使用领域</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>HEVC(H.265)</td>\n<td>MPEG/ITU-T</td>\n<td>2013</td>\n<td>研发中</td>\n</tr>\n<tr>\n<td>H.264</td>\n<td>MPEG/ITU-T</td>\n<td>2003</td>\n<td>各个领域</td>\n</tr>\n<tr>\n<td>MPEG4</td>\n<td>MPEG</td>\n<td>2001</td>\n<td>不温不火</td>\n</tr>\n<tr>\n<td>MPEG2</td>\n<td>MPEG</td>\n<td>1994</td>\n<td>研发中</td>\n</tr>\n<tr>\n<td>VP9</td>\n<td>Google</td>\n<td>2013</td>\n<td>研发中</td>\n</tr>\n<tr>\n<td>VP8</td>\n<td>Google</td>\n<td>2008</td>\n<td>不普及</td>\n</tr>\n<tr>\n<td>VC-1</td>\n<td>Microsoft Inc.</td>\n<td>2006</td>\n<td>微软平台</td>\n</tr>\n</tbody>\n</table>\n<p>不难看出，目前主流的视频编码便是H264了，我们项目中选取的也是此编码标准。</p>\n<h3 id=\"音频编码\"><a href=\"#音频编码\" class=\"headerlink\" title=\"音频编码\"></a>音频编码</h3><p>音频编码的主要作用是将音频采样数据（PCM等）压缩成为音频码流，从而降低音频的数据量。主要音频编码一览：</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>推出即构</th>\n<th>退出时间</th>\n<th>目前使用领域</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>AAC</td>\n<td>MPEG</td>\n<td>1997</td>\n<td>各个领域（新）</td>\n</tr>\n<tr>\n<td>AC-3</td>\n<td>Dolby Inc.</td>\n<td>1992</td>\n<td>电影</td>\n</tr>\n<tr>\n<td>MP3</td>\n<td>MPEG</td>\n<td>1993</td>\n<td>各个领域（旧）</td>\n</tr>\n<tr>\n<td>WMA</td>\n<td>Microsoft Inc.</td>\n<td>1999</td>\n<td>微软平台</td>\n</tr>\n</tbody>\n</table>\n<p>那么主流的音频编码便是AAC了，项目选取的也是此编码标准。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://www.zhihu.com/question/42162310\" target=\"_blank\" rel=\"external\">如何搭建一个完整的视频直播系统？</a><br><a href=\"http://www.jianshu.com/p/8436c7353296\" target=\"_blank\" rel=\"external\">android音视频点/直播模块开发</a><br><a href=\"http://blog.csdn.net/leixiaohua1020/article/details/18893769\" target=\"_blank\" rel=\"external\">视音频编解码技术零基础学习方法</a><br><a href=\"http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653547042&amp;idx=1&amp;sn=26d8728548a6b5b657079eeab121e283&amp;scene=1&amp;srcid=0428msEitG9LJ3JaKGaRCEjg&amp;from=groupmessage&amp;isappinstalled=0#wechat_redirect\" target=\"_blank\" rel=\"external\">移动直播技术秒开优化经验</a><br><a href=\"http://dev.qq.com/topic/5811d42e7fd6ec467453bf58\" target=\"_blank\" rel=\"external\">从0到1打造直播 App</a></p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>2015 ~ 1016是直播大火的年代，最近公司也是在着手直播这块，作为Android开发，自然也要懂得一些知识，经过一段时间的调研，学习，作了一下自我总结，写了一个<code>【Android音视频开发】</code>系列，此文便是开篇了！<br>PS：关于这块的文章着实太少，点开10个链接，有7、8个链接的内容是一样的，各种转来转去，也是耗费了很大的功夫才了解到音视频的一点皮毛。而且很多文章都是12年、13年的，拿到现在可能根本就不适用，我通过实例验证，做下此总结。最近一直在看这一块的东西，今天抽空，趁着记忆的知识还比较新鲜记下来，好记性不如烂笔头，也希望能帮助到其他的人。</p>\n<h2 id=\"直播\"><a href=\"#直播\" class=\"headerlink\" title=\"直播\"></a>直播</h2><p>从技术层面上来，直播大致分为：音视频采集、美颜/滤镜/特效处理、编码、封包、推流、分发、解码/渲染/播放。<br>对应到具体的Android层面，便会有如下几个重要环节：</p>\n<ol>\n<li>视频实时采集：Camera预览/MediaRecorder绑定LocalSocket</li>\n<li>音频实时采集：MediaRecorder/AudioRecord/OpenSL ES</li>\n<li>特效处理：视频磨皮美颜，音频降噪去回声等算法</li>\n<li>编解码：H264&amp;AAC，MediaCodec(API &gt;= 16)硬解，ffmpeg等三方库软解</li>\n<li>流媒体传输：rtmp rtsp hls等</li>\n<li>渲染播放：MediaPlayer，ijkplayer等三方库</li>\n</ol>","more":"<h2 id=\"科普\"><a href=\"#科普\" class=\"headerlink\" title=\"科普\"></a>科普</h2><h3 id=\"编解码\"><a href=\"#编解码\" class=\"headerlink\" title=\"编解码\"></a>编解码</h3><p>采集到的原始音视频数据是非常大的，不利于传输，所以就需要对这些数据进行压缩，这个过程就是编码。解码则是编码的逆向过程。编码分为硬编码、软编码，解码也是如此。</p>\n<ul>\n<li>硬编码：使用非CPU进行编码，如显卡GPU、专用的DSP、FPGA、ASIC芯片等。性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。</li>\n<li>软编码：使用CPU进行编码。性能高，低码率下通常质量低于硬编码器，但部分产品在GPU硬件平台移植了优秀的软编码算法（如X264）的，质量基本等同于软编码。</li>\n</ul>\n<p>关于音视频压缩编码的基本原理可以参见雷神的<a href=\"http://blog.csdn.net/leixiaohua1020/article/details/28114081\">这篇文章</a>。</p>\n<h3 id=\"视频编码\"><a href=\"#视频编码\" class=\"headerlink\" title=\"视频编码\"></a>视频编码</h3><p>视频编码的主要作用是将视频像素数据（RGB，YUV等）压缩成为视频码流，从而降低视频的数据量。主要视频编码一览：</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>推出即构</th>\n<th>退出时间</th>\n<th>目前使用领域</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>HEVC(H.265)</td>\n<td>MPEG/ITU-T</td>\n<td>2013</td>\n<td>研发中</td>\n</tr>\n<tr>\n<td>H.264</td>\n<td>MPEG/ITU-T</td>\n<td>2003</td>\n<td>各个领域</td>\n</tr>\n<tr>\n<td>MPEG4</td>\n<td>MPEG</td>\n<td>2001</td>\n<td>不温不火</td>\n</tr>\n<tr>\n<td>MPEG2</td>\n<td>MPEG</td>\n<td>1994</td>\n<td>研发中</td>\n</tr>\n<tr>\n<td>VP9</td>\n<td>Google</td>\n<td>2013</td>\n<td>研发中</td>\n</tr>\n<tr>\n<td>VP8</td>\n<td>Google</td>\n<td>2008</td>\n<td>不普及</td>\n</tr>\n<tr>\n<td>VC-1</td>\n<td>Microsoft Inc.</td>\n<td>2006</td>\n<td>微软平台</td>\n</tr>\n</tbody>\n</table>\n<p>不难看出，目前主流的视频编码便是H264了，我们项目中选取的也是此编码标准。</p>\n<h3 id=\"音频编码\"><a href=\"#音频编码\" class=\"headerlink\" title=\"音频编码\"></a>音频编码</h3><p>音频编码的主要作用是将音频采样数据（PCM等）压缩成为音频码流，从而降低音频的数据量。主要音频编码一览：</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>推出即构</th>\n<th>退出时间</th>\n<th>目前使用领域</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>AAC</td>\n<td>MPEG</td>\n<td>1997</td>\n<td>各个领域（新）</td>\n</tr>\n<tr>\n<td>AC-3</td>\n<td>Dolby Inc.</td>\n<td>1992</td>\n<td>电影</td>\n</tr>\n<tr>\n<td>MP3</td>\n<td>MPEG</td>\n<td>1993</td>\n<td>各个领域（旧）</td>\n</tr>\n<tr>\n<td>WMA</td>\n<td>Microsoft Inc.</td>\n<td>1999</td>\n<td>微软平台</td>\n</tr>\n</tbody>\n</table>\n<p>那么主流的音频编码便是AAC了，项目选取的也是此编码标准。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://www.zhihu.com/question/42162310\">如何搭建一个完整的视频直播系统？</a><br><a href=\"http://www.jianshu.com/p/8436c7353296\">android音视频点/直播模块开发</a><br><a href=\"http://blog.csdn.net/leixiaohua1020/article/details/18893769\">视音频编解码技术零基础学习方法</a><br><a href=\"http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653547042&amp;idx=1&amp;sn=26d8728548a6b5b657079eeab121e283&amp;scene=1&amp;srcid=0428msEitG9LJ3JaKGaRCEjg&amp;from=groupmessage&amp;isappinstalled=0#wechat_redirect\">移动直播技术秒开优化经验</a><br><a href=\"http://dev.qq.com/topic/5811d42e7fd6ec467453bf58\">从0到1打造直播 App</a></p>"},{"title":"【Android音视频开发】- 实时采集视频并编码","date":"2016-10-20T06:54:45.000Z","_content":"\n## 前言\n通过我的上一篇文章，实时采集视频的LocalSocket方式在新的Android SDK上是跑不通的，那么便只剩下Camera了。本文将利用``Camera``来进行实时采集视频，``MediaCodec``进行硬编码来输出yuv、h264文件。\n\n## YUV\n通过Camera采集到的原始数据是YUV（NV21）格式的，何为YUV？\n\n> YUV，分为三个分量，“Y”表示明亮度（Luminance或Luma），也就是灰度值；而“U”和“V” 表示的则是色度（Chrominance或Chroma），作用是描述影像色彩及饱和度，用于指定像素的颜色。YUV是一种颜色编码方法，主要用于电视系统以及模拟视频领域，它将亮度信息（Y）与色彩信息（UV）分离，没有UV信息一样可以显示完整的图像，只不过是黑白的，这样的设计很好地解决了彩色电视机与黑白电视的兼容问题。并且，YUV不像RGB那样要求三个独立的视频信号同时传输，所以用YUV方式传送占用极少的频宽。\n\nYUV码流的存储格式其实与其采样的方式密切相关，主流的采样方式有三种，YUV4:4:4，YUV4:2:2，YUV4:2:0。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video5.jpg)\n\n1. YUV 4:4:4采样，每一个Y对应一组UV分量。\n2. YUV 4:2:2采样，每两个Y共用一组UV分量。\n3. YUV 4:2:0采样，每四个Y共用一组UV分量。\n\n这里只抛出这样一个概念，详情请参见文末的``参考``。\n\n<!-- more -->\n\n## H264\nH264作为当前最火热的编码方式，它有着特殊的分层结构。\n> H.264 的功能分为两层：视频编码层(VCL, Video Coding Layer)和网络提取层(NAL, Network Abstraction Layer)。VCL 数据即编码处理的输出，它表示被压缩编码后的视频数据 序列。在 VCL 数据传输或存储之前,这些编码的 VCL 数据，先被映射或封装进 NAL 单元中。每个 NAL 单元包括一个原始字节序列负荷(RBSP, Raw Byte Sequence Payload)、一组对应于视频编码的 NAL 头信息。RBSP 的基本结构是：在原始编码数据的后面填加了结尾比特。一个bit“1”若干比特“0”，以便字节对齐。\n\n在H264中，无论是SPS、PPS或者是slice data，都是由一个NAL unit所组成。\nNALU头结构：NALU类型(5bit)、重要性指示位(2bit)、禁止位(1bit)。\n1. NALU类型：1～12由H.264使用，24～31由H.264以外的应用使用。\n2. 重要性指示：标志该NAL单元用于重建时的重要性，值越大，越重要。\n3. 禁止位：网络发现NAL单元有比特错误时可设置该比特为1，以便接收方丢掉该单元。\n\n这里依然是抛出这样一个概念，详情请参见文末的``参考``。（因为我自己也没怎么弄懂，哈哈哈~）\n\n## 实例\n下面直接结合``Camera``与``MediaCodec``来实现视频采集与编码，并且输出yuv、h264文件。\n初始化MediaCodec:\n```\nprivate void initMediaCodec() {\n    int degree = getDegree();\n    framerate = 15;\n    bitrate = 2 * width * height * framerate / 20;\n    EncoderDebugger debugger = EncoderDebugger.debug(getApplicationContext(), width, height);\n    mConvertor = debugger.getNV21Convertor();\n    try {\n        mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());\n        MediaFormat mediaFormat;\n        if (degree == 0) {\n            mediaFormat = MediaFormat.createVideoFormat(\"video/avc\", height, width);\n        } else {\n            mediaFormat = MediaFormat.createVideoFormat(\"video/avc\", width, height);\n        }\n        mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate);\n        mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, framerate);\n        mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,\n                debugger.getEncoderColorFormat());\n        mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 1);\n        mMediaCodec.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);\n        mMediaCodec.start();\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n}\n```\n获取Camera：\n```\nprivate boolean createCamera(SurfaceHolder surfaceHolder) {\n    try {\n        mCamera = Camera.open(mCameraId);\n        Camera.Parameters parameters = mCamera.getParameters();\n        int[] max = determineMaximumSupportedFrameRate(parameters);\n        Camera.CameraInfo camInfo = new Camera.CameraInfo();\n        Camera.getCameraInfo(mCameraId, camInfo);\n        int cameraRotationOffset = camInfo.orientation;\n        int rotate = (360 + cameraRotationOffset - getDegree()) % 360;\n        parameters.setRotation(rotate);\n        parameters.setPreviewFormat(ImageFormat.NV21);\n        parameters.setPreviewSize(width, height);\n        parameters.setPreviewFpsRange(max[0], max[1]);\n        mCamera.setParameters(parameters);\n        mCamera.autoFocus(null);\n        int displayRotation;\n        displayRotation = (cameraRotationOffset - getDegree() + 360) % 360;\n        mCamera.setDisplayOrientation(displayRotation);\n        mCamera.setPreviewDisplay(surfaceHolder);\n        return true;\n    } catch (Exception e) {\n        StringWriter sw = new StringWriter();\n        PrintWriter pw = new PrintWriter(sw);\n        e.printStackTrace(pw);\n        String stack = sw.toString();\n        Toast.makeText(this, stack, Toast.LENGTH_LONG).show();\n        destroyCamera();\n        e.printStackTrace();\n        return false;\n    }\n}\n```\n采集并编码：\n```\nCamera.PreviewCallback previewCallback = new Camera.PreviewCallback() {\n    byte[] mPpsSps = new byte[0];\n\n    @Override\n    public void onPreviewFrame(byte[] data, Camera camera) {\n        // data即是NV21的数据\n        if (data == null) {\n            return;\n        }\n        ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();\n        ByteBuffer[] outputBuffers = mMediaCodec.getOutputBuffers();\n        byte[] dst;\n        Camera.Size previewSize = mCamera.getParameters().getPreviewSize();\n        if (getDegree() == 0) {\n            dst = Util.rotateNV21Degree90(data, previewSize.width, previewSize.height);\n        } else {\n            dst = data;\n        }\n        Util.save(data, 0, data.length, yuvPath, true);\n        try {\n            int bufferIndex = mMediaCodec.dequeueInputBuffer(5000000);\n            if (bufferIndex >= 0) {\n                inputBuffers[bufferIndex].clear();\n                mConvertor.convert(dst, inputBuffers[bufferIndex]);\n                mMediaCodec.queueInputBuffer(bufferIndex, 0,\n                        inputBuffers[bufferIndex].position(),\n                        System.nanoTime() / 1000, 0);\n                MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo();\n                int outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, 0);\n                while (outputBufferIndex >= 0) {\n                    ByteBuffer outputBuffer = outputBuffers[outputBufferIndex];\n                    byte[] outData = new byte[bufferInfo.size];\n                    outputBuffer.get(outData);\n                    //记录pps和sps\n                    if (outData[0] == 0 && outData[1] == 0 && outData[2] == 0 && outData[3] == 1 && outData[4] == 103) {\n                        mPpsSps = outData;\n                    } else if (outData[0] == 0 && outData[1] == 0 && outData[2] == 0 && outData[3] == 1 && outData[4] == 101) {\n                        //在关键帧前面加上pps和sps数据\n                        byte[] frameData = new byte[mPpsSps.length + outData.length];\n                        System.arraycopy(mPpsSps, 0, frameData, 0, mPpsSps.length);\n                        System.arraycopy(outData, 0, frameData, mPpsSps.length, outData.length);\n                        outData = frameData;\n                    }\n                    Util.save(outData, 0, outData.length, path, true);\n                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, false);\n                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, 0);\n                }\n            } else {\n                Log.e(\"easypusher\", \"No buffer available !\");\n            }\n        } catch (Exception e) {\n            StringWriter sw = new StringWriter();\n            PrintWriter pw = new PrintWriter(sw);\n            e.printStackTrace(pw);\n            String stack = sw.toString();\n            Log.e(\"save_log\", stack);\n            e.printStackTrace();\n        } finally {\n            mCamera.addCallbackBuffer(dst);\n        }\n    }\n\n};\n```\n获取摄像头支持的分辨率代码：\n```\npublic static void determineClosestSupportedResolution(Camera.Parameters parameters) {\n    String supportedSizesStr = \"Supported resolutions: \";\n    List<Camera.Size> supportedSizes = parameters.getSupportedPreviewSizes();\n    for (Iterator<Camera.Size> it = supportedSizes.iterator(); it.hasNext(); ) {\n        Camera.Size size = it.next();\n        supportedSizesStr += size.width + \"x\" + size.height + (it.hasNext() ? \", \" : \"\");\n    }\n    Log.e(\"TAG\", supportedSizesStr);\n}\n```\n\n后面运行，点击``开始``进行录制，再次点击结束录制，会在sdcard上生成2个文件``test_1280x720.yuv``、``test_1280x720.h264``。\n下载工具后进行查看文件便能看到录制的视频了。\nYUV工具我是用的雷神改作的一个：[修改了一个YUV/RGB播放器](http://blog.csdn.net/leixiaohua1020/article/details/50466201)。\nH264工具则是用的[VLC](http://www.videolan.org/vlc/)。\n\n[工程代码示例](https://github.com/LiJia92/spydroid-ipcamera)\n\nTip：Camera采集默认是横屏，所以竖屏采集输出的图像需要旋转90度，解决方法参见``参考``即demo中的代码。\n\n## 参考\n[Camera的简单使用浅析](http://www.cnblogs.com/raomengyang/p/4852277.html)\n[Android Camera原始帧格式转换 —— 获取Camera图像（一）](http://www.cnblogs.com/raomengyang/p/5426525.html)\n[直播必备之YUV使用总结 —— Android常用的几种格式：NV21/NV12/YV12/YUV420P的区别](http://www.cnblogs.com/raomengyang/p/5582270.html)\n[Camera](https://developer.android.com/guide/topics/media/camera.html)\n[MediaCodec](https://developer.android.com/reference/android/media/MediaCodec.html)\n[Video Rendering with 8-Bit YUV Formats](https://msdn.microsoft.com/en-us/library/aa904813.aspx)\n[YUV420SP图像的旋转](http://www.ay27.com/2014/10/09/2014-10-09-a-simple-image-rotate-function/)\n[图文详解YUV420数据格式](http://www.cnblogs.com/azraelly/archive/2013/01/01/2841269.htm)\n[Android 实时视频采集—Cameara预览采集](http://www.cnblogs.com/skyseraph/archive/2012/03/26/2418665.html)\n[H.264中如何判斷某一段是否為SPS(Sequence Parameter Set)或PPS(Picture Parameter Set)](http://brytsai.blogspot.jp/2010/02/h.html)\n[EasyPusher安卓Android手机直播推送之MediaCodec 硬编码H264格式](http://blog.csdn.net/u013758734/article/details/50834770)\n[Android屏幕直播方案](http://www.dobest.me/blog/2016/06/17/Android%E5%B1%8F%E5%B9%95%E7%9B%B4%E6%92%AD%E6%96%B9%E6%A1%88/)\n","source":"_posts/live-code-video.md","raw":"---\ntitle: 【Android音视频开发】- 实时采集视频并编码\ndate: 2016-10-20 14:54:45\ntags:\n - 直播\n---\n\n## 前言\n通过我的上一篇文章，实时采集视频的LocalSocket方式在新的Android SDK上是跑不通的，那么便只剩下Camera了。本文将利用``Camera``来进行实时采集视频，``MediaCodec``进行硬编码来输出yuv、h264文件。\n\n## YUV\n通过Camera采集到的原始数据是YUV（NV21）格式的，何为YUV？\n\n> YUV，分为三个分量，“Y”表示明亮度（Luminance或Luma），也就是灰度值；而“U”和“V” 表示的则是色度（Chrominance或Chroma），作用是描述影像色彩及饱和度，用于指定像素的颜色。YUV是一种颜色编码方法，主要用于电视系统以及模拟视频领域，它将亮度信息（Y）与色彩信息（UV）分离，没有UV信息一样可以显示完整的图像，只不过是黑白的，这样的设计很好地解决了彩色电视机与黑白电视的兼容问题。并且，YUV不像RGB那样要求三个独立的视频信号同时传输，所以用YUV方式传送占用极少的频宽。\n\nYUV码流的存储格式其实与其采样的方式密切相关，主流的采样方式有三种，YUV4:4:4，YUV4:2:2，YUV4:2:0。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/10/video5.jpg)\n\n1. YUV 4:4:4采样，每一个Y对应一组UV分量。\n2. YUV 4:2:2采样，每两个Y共用一组UV分量。\n3. YUV 4:2:0采样，每四个Y共用一组UV分量。\n\n这里只抛出这样一个概念，详情请参见文末的``参考``。\n\n<!-- more -->\n\n## H264\nH264作为当前最火热的编码方式，它有着特殊的分层结构。\n> H.264 的功能分为两层：视频编码层(VCL, Video Coding Layer)和网络提取层(NAL, Network Abstraction Layer)。VCL 数据即编码处理的输出，它表示被压缩编码后的视频数据 序列。在 VCL 数据传输或存储之前,这些编码的 VCL 数据，先被映射或封装进 NAL 单元中。每个 NAL 单元包括一个原始字节序列负荷(RBSP, Raw Byte Sequence Payload)、一组对应于视频编码的 NAL 头信息。RBSP 的基本结构是：在原始编码数据的后面填加了结尾比特。一个bit“1”若干比特“0”，以便字节对齐。\n\n在H264中，无论是SPS、PPS或者是slice data，都是由一个NAL unit所组成。\nNALU头结构：NALU类型(5bit)、重要性指示位(2bit)、禁止位(1bit)。\n1. NALU类型：1～12由H.264使用，24～31由H.264以外的应用使用。\n2. 重要性指示：标志该NAL单元用于重建时的重要性，值越大，越重要。\n3. 禁止位：网络发现NAL单元有比特错误时可设置该比特为1，以便接收方丢掉该单元。\n\n这里依然是抛出这样一个概念，详情请参见文末的``参考``。（因为我自己也没怎么弄懂，哈哈哈~）\n\n## 实例\n下面直接结合``Camera``与``MediaCodec``来实现视频采集与编码，并且输出yuv、h264文件。\n初始化MediaCodec:\n```\nprivate void initMediaCodec() {\n    int degree = getDegree();\n    framerate = 15;\n    bitrate = 2 * width * height * framerate / 20;\n    EncoderDebugger debugger = EncoderDebugger.debug(getApplicationContext(), width, height);\n    mConvertor = debugger.getNV21Convertor();\n    try {\n        mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());\n        MediaFormat mediaFormat;\n        if (degree == 0) {\n            mediaFormat = MediaFormat.createVideoFormat(\"video/avc\", height, width);\n        } else {\n            mediaFormat = MediaFormat.createVideoFormat(\"video/avc\", width, height);\n        }\n        mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate);\n        mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, framerate);\n        mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,\n                debugger.getEncoderColorFormat());\n        mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 1);\n        mMediaCodec.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);\n        mMediaCodec.start();\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n}\n```\n获取Camera：\n```\nprivate boolean createCamera(SurfaceHolder surfaceHolder) {\n    try {\n        mCamera = Camera.open(mCameraId);\n        Camera.Parameters parameters = mCamera.getParameters();\n        int[] max = determineMaximumSupportedFrameRate(parameters);\n        Camera.CameraInfo camInfo = new Camera.CameraInfo();\n        Camera.getCameraInfo(mCameraId, camInfo);\n        int cameraRotationOffset = camInfo.orientation;\n        int rotate = (360 + cameraRotationOffset - getDegree()) % 360;\n        parameters.setRotation(rotate);\n        parameters.setPreviewFormat(ImageFormat.NV21);\n        parameters.setPreviewSize(width, height);\n        parameters.setPreviewFpsRange(max[0], max[1]);\n        mCamera.setParameters(parameters);\n        mCamera.autoFocus(null);\n        int displayRotation;\n        displayRotation = (cameraRotationOffset - getDegree() + 360) % 360;\n        mCamera.setDisplayOrientation(displayRotation);\n        mCamera.setPreviewDisplay(surfaceHolder);\n        return true;\n    } catch (Exception e) {\n        StringWriter sw = new StringWriter();\n        PrintWriter pw = new PrintWriter(sw);\n        e.printStackTrace(pw);\n        String stack = sw.toString();\n        Toast.makeText(this, stack, Toast.LENGTH_LONG).show();\n        destroyCamera();\n        e.printStackTrace();\n        return false;\n    }\n}\n```\n采集并编码：\n```\nCamera.PreviewCallback previewCallback = new Camera.PreviewCallback() {\n    byte[] mPpsSps = new byte[0];\n\n    @Override\n    public void onPreviewFrame(byte[] data, Camera camera) {\n        // data即是NV21的数据\n        if (data == null) {\n            return;\n        }\n        ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();\n        ByteBuffer[] outputBuffers = mMediaCodec.getOutputBuffers();\n        byte[] dst;\n        Camera.Size previewSize = mCamera.getParameters().getPreviewSize();\n        if (getDegree() == 0) {\n            dst = Util.rotateNV21Degree90(data, previewSize.width, previewSize.height);\n        } else {\n            dst = data;\n        }\n        Util.save(data, 0, data.length, yuvPath, true);\n        try {\n            int bufferIndex = mMediaCodec.dequeueInputBuffer(5000000);\n            if (bufferIndex >= 0) {\n                inputBuffers[bufferIndex].clear();\n                mConvertor.convert(dst, inputBuffers[bufferIndex]);\n                mMediaCodec.queueInputBuffer(bufferIndex, 0,\n                        inputBuffers[bufferIndex].position(),\n                        System.nanoTime() / 1000, 0);\n                MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo();\n                int outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, 0);\n                while (outputBufferIndex >= 0) {\n                    ByteBuffer outputBuffer = outputBuffers[outputBufferIndex];\n                    byte[] outData = new byte[bufferInfo.size];\n                    outputBuffer.get(outData);\n                    //记录pps和sps\n                    if (outData[0] == 0 && outData[1] == 0 && outData[2] == 0 && outData[3] == 1 && outData[4] == 103) {\n                        mPpsSps = outData;\n                    } else if (outData[0] == 0 && outData[1] == 0 && outData[2] == 0 && outData[3] == 1 && outData[4] == 101) {\n                        //在关键帧前面加上pps和sps数据\n                        byte[] frameData = new byte[mPpsSps.length + outData.length];\n                        System.arraycopy(mPpsSps, 0, frameData, 0, mPpsSps.length);\n                        System.arraycopy(outData, 0, frameData, mPpsSps.length, outData.length);\n                        outData = frameData;\n                    }\n                    Util.save(outData, 0, outData.length, path, true);\n                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, false);\n                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, 0);\n                }\n            } else {\n                Log.e(\"easypusher\", \"No buffer available !\");\n            }\n        } catch (Exception e) {\n            StringWriter sw = new StringWriter();\n            PrintWriter pw = new PrintWriter(sw);\n            e.printStackTrace(pw);\n            String stack = sw.toString();\n            Log.e(\"save_log\", stack);\n            e.printStackTrace();\n        } finally {\n            mCamera.addCallbackBuffer(dst);\n        }\n    }\n\n};\n```\n获取摄像头支持的分辨率代码：\n```\npublic static void determineClosestSupportedResolution(Camera.Parameters parameters) {\n    String supportedSizesStr = \"Supported resolutions: \";\n    List<Camera.Size> supportedSizes = parameters.getSupportedPreviewSizes();\n    for (Iterator<Camera.Size> it = supportedSizes.iterator(); it.hasNext(); ) {\n        Camera.Size size = it.next();\n        supportedSizesStr += size.width + \"x\" + size.height + (it.hasNext() ? \", \" : \"\");\n    }\n    Log.e(\"TAG\", supportedSizesStr);\n}\n```\n\n后面运行，点击``开始``进行录制，再次点击结束录制，会在sdcard上生成2个文件``test_1280x720.yuv``、``test_1280x720.h264``。\n下载工具后进行查看文件便能看到录制的视频了。\nYUV工具我是用的雷神改作的一个：[修改了一个YUV/RGB播放器](http://blog.csdn.net/leixiaohua1020/article/details/50466201)。\nH264工具则是用的[VLC](http://www.videolan.org/vlc/)。\n\n[工程代码示例](https://github.com/LiJia92/spydroid-ipcamera)\n\nTip：Camera采集默认是横屏，所以竖屏采集输出的图像需要旋转90度，解决方法参见``参考``即demo中的代码。\n\n## 参考\n[Camera的简单使用浅析](http://www.cnblogs.com/raomengyang/p/4852277.html)\n[Android Camera原始帧格式转换 —— 获取Camera图像（一）](http://www.cnblogs.com/raomengyang/p/5426525.html)\n[直播必备之YUV使用总结 —— Android常用的几种格式：NV21/NV12/YV12/YUV420P的区别](http://www.cnblogs.com/raomengyang/p/5582270.html)\n[Camera](https://developer.android.com/guide/topics/media/camera.html)\n[MediaCodec](https://developer.android.com/reference/android/media/MediaCodec.html)\n[Video Rendering with 8-Bit YUV Formats](https://msdn.microsoft.com/en-us/library/aa904813.aspx)\n[YUV420SP图像的旋转](http://www.ay27.com/2014/10/09/2014-10-09-a-simple-image-rotate-function/)\n[图文详解YUV420数据格式](http://www.cnblogs.com/azraelly/archive/2013/01/01/2841269.htm)\n[Android 实时视频采集—Cameara预览采集](http://www.cnblogs.com/skyseraph/archive/2012/03/26/2418665.html)\n[H.264中如何判斷某一段是否為SPS(Sequence Parameter Set)或PPS(Picture Parameter Set)](http://brytsai.blogspot.jp/2010/02/h.html)\n[EasyPusher安卓Android手机直播推送之MediaCodec 硬编码H264格式](http://blog.csdn.net/u013758734/article/details/50834770)\n[Android屏幕直播方案](http://www.dobest.me/blog/2016/06/17/Android%E5%B1%8F%E5%B9%95%E7%9B%B4%E6%92%AD%E6%96%B9%E6%A1%88/)\n","slug":"live-code-video","published":1,"updated":"2016-11-21T10:01:38.574Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759j001w1cb8n67hjv1g","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>通过我的上一篇文章，实时采集视频的LocalSocket方式在新的Android SDK上是跑不通的，那么便只剩下Camera了。本文将利用<code>Camera</code>来进行实时采集视频，<code>MediaCodec</code>进行硬编码来输出yuv、h264文件。</p>\n<h2 id=\"YUV\"><a href=\"#YUV\" class=\"headerlink\" title=\"YUV\"></a>YUV</h2><p>通过Camera采集到的原始数据是YUV（NV21）格式的，何为YUV？</p>\n<blockquote>\n<p>YUV，分为三个分量，“Y”表示明亮度（Luminance或Luma），也就是灰度值；而“U”和“V” 表示的则是色度（Chrominance或Chroma），作用是描述影像色彩及饱和度，用于指定像素的颜色。YUV是一种颜色编码方法，主要用于电视系统以及模拟视频领域，它将亮度信息（Y）与色彩信息（UV）分离，没有UV信息一样可以显示完整的图像，只不过是黑白的，这样的设计很好地解决了彩色电视机与黑白电视的兼容问题。并且，YUV不像RGB那样要求三个独立的视频信号同时传输，所以用YUV方式传送占用极少的频宽。</p>\n</blockquote>\n<p>YUV码流的存储格式其实与其采样的方式密切相关，主流的采样方式有三种，YUV4:4:4，YUV4:2:2，YUV4:2:0。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video5.jpg\" alt=\"\"></p>\n<ol>\n<li>YUV 4:4:4采样，每一个Y对应一组UV分量。</li>\n<li>YUV 4:2:2采样，每两个Y共用一组UV分量。</li>\n<li>YUV 4:2:0采样，每四个Y共用一组UV分量。</li>\n</ol>\n<p>这里只抛出这样一个概念，详情请参见文末的<code>参考</code>。</p>\n<a id=\"more\"></a>\n<h2 id=\"H264\"><a href=\"#H264\" class=\"headerlink\" title=\"H264\"></a>H264</h2><p>H264作为当前最火热的编码方式，它有着特殊的分层结构。</p>\n<blockquote>\n<p>H.264 的功能分为两层：视频编码层(VCL, Video Coding Layer)和网络提取层(NAL, Network Abstraction Layer)。VCL 数据即编码处理的输出，它表示被压缩编码后的视频数据 序列。在 VCL 数据传输或存储之前,这些编码的 VCL 数据，先被映射或封装进 NAL 单元中。每个 NAL 单元包括一个原始字节序列负荷(RBSP, Raw Byte Sequence Payload)、一组对应于视频编码的 NAL 头信息。RBSP 的基本结构是：在原始编码数据的后面填加了结尾比特。一个bit“1”若干比特“0”，以便字节对齐。</p>\n</blockquote>\n<p>在H264中，无论是SPS、PPS或者是slice data，都是由一个NAL unit所组成。<br>NALU头结构：NALU类型(5bit)、重要性指示位(2bit)、禁止位(1bit)。</p>\n<ol>\n<li>NALU类型：1～12由H.264使用，24～31由H.264以外的应用使用。</li>\n<li>重要性指示：标志该NAL单元用于重建时的重要性，值越大，越重要。</li>\n<li>禁止位：网络发现NAL单元有比特错误时可设置该比特为1，以便接收方丢掉该单元。</li>\n</ol>\n<p>这里依然是抛出这样一个概念，详情请参见文末的<code>参考</code>。（因为我自己也没怎么弄懂，哈哈哈~）</p>\n<h2 id=\"实例\"><a href=\"#实例\" class=\"headerlink\" title=\"实例\"></a>实例</h2><p>下面直接结合<code>Camera</code>与<code>MediaCodec</code>来实现视频采集与编码，并且输出yuv、h264文件。<br>初始化MediaCodec:<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> initMediaCodec() &#123;</div><div class=\"line\">    <span class=\"built_in\">int</span> degree = getDegree();</div><div class=\"line\">    framerate = <span class=\"number\">15</span>;</div><div class=\"line\">    bitrate = <span class=\"number\">2</span> * <span class=\"built_in\">width</span> * <span class=\"built_in\">height</span> * framerate / <span class=\"number\">20</span>;</div><div class=\"line\">    EncoderDebugger debugger = EncoderDebugger.debug(getApplicationContext(), <span class=\"built_in\">width</span>, <span class=\"built_in\">height</span>);</div><div class=\"line\">    mConvertor = debugger.getNV21Convertor();</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());</div><div class=\"line\">        MediaFormat mediaFormat;</div><div class=\"line\">        <span class=\"keyword\">if</span> (degree == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            mediaFormat = MediaFormat.createVideoFormat(<span class=\"string\">\"video/avc\"</span>, <span class=\"built_in\">height</span>, <span class=\"built_in\">width</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            mediaFormat = MediaFormat.createVideoFormat(<span class=\"string\">\"video/avc\"</span>, <span class=\"built_in\">width</span>, <span class=\"built_in\">height</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate);</div><div class=\"line\">        mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, framerate);</div><div class=\"line\">        mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,</div><div class=\"line\">                debugger.getEncoderColorFormat());</div><div class=\"line\">        mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, <span class=\"number\">1</span>);</div><div class=\"line\">        mMediaCodec.configure(mediaFormat, <span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</div><div class=\"line\">        mMediaCodec.start();</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">        e.printStackTrace();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>获取Camera：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">private <span class=\"keyword\">boolean </span>createCamera(SurfaceHolder surfaceHolder) &#123;</div><div class=\"line\">    try &#123;</div><div class=\"line\">        mCamera = Camera.open(mCameraId)<span class=\"comment\">;</span></div><div class=\"line\">        Camera.Parameters parameters = mCamera.getParameters()<span class=\"comment\">;</span></div><div class=\"line\">        int[] max = determineMaximumSupportedFrameRate(parameters)<span class=\"comment\">;</span></div><div class=\"line\">        Camera.CameraInfo camInfo = new Camera.CameraInfo()<span class=\"comment\">;</span></div><div class=\"line\">        Camera.getCameraInfo(mCameraId, camInfo)<span class=\"comment\">;</span></div><div class=\"line\">        int cameraRotationOffset = camInfo.<span class=\"keyword\">orientation;</span></div><div class=\"line\">        int rotate = (<span class=\"number\">360</span> + cameraRotationOffset - getDegree()) % <span class=\"number\">360</span><span class=\"comment\">;</span></div><div class=\"line\">        parameters.setRotation(rotate)<span class=\"comment\">;</span></div><div class=\"line\">        parameters.setPreviewFormat(ImageFormat.NV21)<span class=\"comment\">;</span></div><div class=\"line\">        parameters.setPreviewSize(width, height)<span class=\"comment\">;</span></div><div class=\"line\">        parameters.setPreviewFpsRange(max[<span class=\"number\">0</span>], max[<span class=\"number\">1</span>])<span class=\"comment\">;</span></div><div class=\"line\">        mCamera.setParameters(parameters)<span class=\"comment\">;</span></div><div class=\"line\">        mCamera.autoFocus(null)<span class=\"comment\">;</span></div><div class=\"line\">        int <span class=\"keyword\">displayRotation;</span></div><div class=\"line\">        <span class=\"keyword\">displayRotation </span>= (cameraRotationOffset - getDegree() + <span class=\"number\">360</span>) % <span class=\"number\">360</span><span class=\"comment\">;</span></div><div class=\"line\">        mCamera.setDisplayOrientation(<span class=\"keyword\">displayRotation);</span></div><div class=\"line\">        mCamera.setPreviewDisplay(surfaceHolder)<span class=\"comment\">;</span></div><div class=\"line\">        return true<span class=\"comment\">;</span></div><div class=\"line\">    &#125; catch (Exception e) &#123;</div><div class=\"line\">        StringWriter <span class=\"keyword\">sw </span>= new StringWriter()<span class=\"comment\">;</span></div><div class=\"line\">        PrintWriter pw = new PrintWriter(<span class=\"keyword\">sw);</span></div><div class=\"line\">        e.printStackTrace(pw)<span class=\"comment\">;</span></div><div class=\"line\">        String stack = <span class=\"keyword\">sw.toString();</span></div><div class=\"line\">        Toast.makeText(this, stack, Toast.LENGTH_LONG).<span class=\"keyword\">show();</span></div><div class=\"line\">        destroyCamera()<span class=\"comment\">;</span></div><div class=\"line\">        e.printStackTrace()<span class=\"comment\">;</span></div><div class=\"line\">        return false<span class=\"comment\">;</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>采集并编码：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div></pre></td><td class=\"code\"><pre><div class=\"line\">Camera.PreviewCallback previewCallback = <span class=\"keyword\">new</span> Camera.PreviewCallback() &#123;</div><div class=\"line\">    <span class=\"built_in\">byte</span>[] mPpsSps = <span class=\"keyword\">new</span> <span class=\"built_in\">byte</span>[<span class=\"number\">0</span>];</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> onPreviewFrame(<span class=\"built_in\">byte</span>[] data, Camera <span class=\"built_in\">camera</span>) &#123;</div><div class=\"line\">        <span class=\"comment\">// data即是NV21的数据</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (data == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();</div><div class=\"line\">        ByteBuffer[] outputBuffers = mMediaCodec.getOutputBuffers();</div><div class=\"line\">        <span class=\"built_in\">byte</span>[] dst;</div><div class=\"line\">        Camera.Size previewSize = mCamera.getParameters().getPreviewSize();</div><div class=\"line\">        <span class=\"keyword\">if</span> (getDegree() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            dst = Util.rotateNV21Degree90(data, previewSize.<span class=\"built_in\">width</span>, previewSize.<span class=\"built_in\">height</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            dst = data;</div><div class=\"line\">        &#125;</div><div class=\"line\">        Util.<span class=\"built_in\">save</span>(data, <span class=\"number\">0</span>, data.length, yuvPath, <span class=\"keyword\">true</span>);</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            <span class=\"built_in\">int</span> bufferIndex = mMediaCodec.dequeueInputBuffer(<span class=\"number\">5000000</span>);</div><div class=\"line\">            <span class=\"keyword\">if</span> (bufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                inputBuffers[bufferIndex].<span class=\"built_in\">clear</span>();</div><div class=\"line\">                mConvertor.convert(dst, inputBuffers[bufferIndex]);</div><div class=\"line\">                mMediaCodec.queueInputBuffer(bufferIndex, <span class=\"number\">0</span>,</div><div class=\"line\">                        inputBuffers[bufferIndex].position(),</div><div class=\"line\">                        System.nanoTime() / <span class=\"number\">1000</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                MediaCodec.BufferInfo bufferInfo = <span class=\"keyword\">new</span> MediaCodec.BufferInfo();</div><div class=\"line\">                <span class=\"built_in\">int</span> outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, <span class=\"number\">0</span>);</div><div class=\"line\">                <span class=\"keyword\">while</span> (outputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    ByteBuffer outputBuffer = outputBuffers[outputBufferIndex];</div><div class=\"line\">                    <span class=\"built_in\">byte</span>[] outData = <span class=\"keyword\">new</span> <span class=\"built_in\">byte</span>[bufferInfo.<span class=\"built_in\">size</span>];</div><div class=\"line\">                    outputBuffer.<span class=\"built_in\">get</span>(outData);</div><div class=\"line\">                    <span class=\"comment\">//记录pps和sps</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (outData[<span class=\"number\">0</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">1</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">2</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">3</span>] == <span class=\"number\">1</span> &amp;&amp; outData[<span class=\"number\">4</span>] == <span class=\"number\">103</span>) &#123;</div><div class=\"line\">                        mPpsSps = outData;</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (outData[<span class=\"number\">0</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">1</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">2</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">3</span>] == <span class=\"number\">1</span> &amp;&amp; outData[<span class=\"number\">4</span>] == <span class=\"number\">101</span>) &#123;</div><div class=\"line\">                        <span class=\"comment\">//在关键帧前面加上pps和sps数据</span></div><div class=\"line\">                        <span class=\"built_in\">byte</span>[] frameData = <span class=\"keyword\">new</span> <span class=\"built_in\">byte</span>[mPpsSps.length + outData.length];</div><div class=\"line\">                        System.arraycopy(mPpsSps, <span class=\"number\">0</span>, frameData, <span class=\"number\">0</span>, mPpsSps.length);</div><div class=\"line\">                        System.arraycopy(outData, <span class=\"number\">0</span>, frameData, mPpsSps.length, outData.length);</div><div class=\"line\">                        outData = frameData;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    Util.<span class=\"built_in\">save</span>(outData, <span class=\"number\">0</span>, outData.length, path, <span class=\"keyword\">true</span>);</div><div class=\"line\">                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, <span class=\"keyword\">false</span>);</div><div class=\"line\">                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, <span class=\"number\">0</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                Log.e(<span class=\"string\">\"easypusher\"</span>, <span class=\"string\">\"No buffer available !\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">            StringWriter sw = <span class=\"keyword\">new</span> StringWriter();</div><div class=\"line\">            PrintWriter pw = <span class=\"keyword\">new</span> PrintWriter(sw);</div><div class=\"line\">            e.printStackTrace(pw);</div><div class=\"line\">            <span class=\"keyword\">String</span> stack = sw.toString();</div><div class=\"line\">            Log.e(<span class=\"string\">\"save_log\"</span>, stack);</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\">            mCamera.addCallbackBuffer(dst);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure></p>\n<p>获取摄像头支持的分辨率代码：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> determineClosestSupportedResolution(Camera.Parameters parameters) &#123;</div><div class=\"line\">    String supportedSizesStr = <span class=\"string\">\"Supported resolutions: \"</span>;</div><div class=\"line\">    List&lt;Camera.<span class=\"keyword\">Size</span>&gt; supportedSizes = parameters.getSupportedPreviewSizes();</div><div class=\"line\">    <span class=\"keyword\">for</span> (Iterator&lt;Camera.<span class=\"keyword\">Size</span>&gt; it = supportedSizes.iterator(); it.hasNext(); ) &#123;</div><div class=\"line\">        Camera.<span class=\"keyword\">Size</span> <span class=\"keyword\">size</span> = it.<span class=\"keyword\">next</span>();</div><div class=\"line\">        supportedSizesStr += <span class=\"keyword\">size</span>.width + <span class=\"string\">\"x\"</span> + <span class=\"keyword\">size</span>.height + (it.hasNext() ? <span class=\"string\">\", \"</span> : <span class=\"string\">\"\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    Log.e(<span class=\"string\">\"TAG\"</span>, supportedSizesStr);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>后面运行，点击<code>开始</code>进行录制，再次点击结束录制，会在sdcard上生成2个文件<code>test_1280x720.yuv</code>、<code>test_1280x720.h264</code>。<br>下载工具后进行查看文件便能看到录制的视频了。<br>YUV工具我是用的雷神改作的一个：<a href=\"http://blog.csdn.net/leixiaohua1020/article/details/50466201\" target=\"_blank\" rel=\"external\">修改了一个YUV/RGB播放器</a>。<br>H264工具则是用的<a href=\"http://www.videolan.org/vlc/\" target=\"_blank\" rel=\"external\">VLC</a>。</p>\n<p><a href=\"https://github.com/LiJia92/spydroid-ipcamera\" target=\"_blank\" rel=\"external\">工程代码示例</a></p>\n<p>Tip：Camera采集默认是横屏，所以竖屏采集输出的图像需要旋转90度，解决方法参见<code>参考</code>即demo中的代码。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://www.cnblogs.com/raomengyang/p/4852277.html\" target=\"_blank\" rel=\"external\">Camera的简单使用浅析</a><br><a href=\"http://www.cnblogs.com/raomengyang/p/5426525.html\" target=\"_blank\" rel=\"external\">Android Camera原始帧格式转换 —— 获取Camera图像（一）</a><br><a href=\"http://www.cnblogs.com/raomengyang/p/5582270.html\" target=\"_blank\" rel=\"external\">直播必备之YUV使用总结 —— Android常用的几种格式：NV21/NV12/YV12/YUV420P的区别</a><br><a href=\"https://developer.android.com/guide/topics/media/camera.html\" target=\"_blank\" rel=\"external\">Camera</a><br><a href=\"https://developer.android.com/reference/android/media/MediaCodec.html\" target=\"_blank\" rel=\"external\">MediaCodec</a><br><a href=\"https://msdn.microsoft.com/en-us/library/aa904813.aspx\" target=\"_blank\" rel=\"external\">Video Rendering with 8-Bit YUV Formats</a><br><a href=\"http://www.ay27.com/2014/10/09/2014-10-09-a-simple-image-rotate-function/\" target=\"_blank\" rel=\"external\">YUV420SP图像的旋转</a><br><a href=\"http://www.cnblogs.com/azraelly/archive/2013/01/01/2841269.htm\" target=\"_blank\" rel=\"external\">图文详解YUV420数据格式</a><br><a href=\"http://www.cnblogs.com/skyseraph/archive/2012/03/26/2418665.html\" target=\"_blank\" rel=\"external\">Android 实时视频采集—Cameara预览采集</a><br><a href=\"http://brytsai.blogspot.jp/2010/02/h.html\" target=\"_blank\" rel=\"external\">H.264中如何判斷某一段是否為SPS(Sequence Parameter Set)或PPS(Picture Parameter Set)</a><br><a href=\"http://blog.csdn.net/u013758734/article/details/50834770\" target=\"_blank\" rel=\"external\">EasyPusher安卓Android手机直播推送之MediaCodec 硬编码H264格式</a><br><a href=\"http://www.dobest.me/blog/2016/06/17/Android%E5%B1%8F%E5%B9%95%E7%9B%B4%E6%92%AD%E6%96%B9%E6%A1%88/\" target=\"_blank\" rel=\"external\">Android屏幕直播方案</a></p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>通过我的上一篇文章，实时采集视频的LocalSocket方式在新的Android SDK上是跑不通的，那么便只剩下Camera了。本文将利用<code>Camera</code>来进行实时采集视频，<code>MediaCodec</code>进行硬编码来输出yuv、h264文件。</p>\n<h2 id=\"YUV\"><a href=\"#YUV\" class=\"headerlink\" title=\"YUV\"></a>YUV</h2><p>通过Camera采集到的原始数据是YUV（NV21）格式的，何为YUV？</p>\n<blockquote>\n<p>YUV，分为三个分量，“Y”表示明亮度（Luminance或Luma），也就是灰度值；而“U”和“V” 表示的则是色度（Chrominance或Chroma），作用是描述影像色彩及饱和度，用于指定像素的颜色。YUV是一种颜色编码方法，主要用于电视系统以及模拟视频领域，它将亮度信息（Y）与色彩信息（UV）分离，没有UV信息一样可以显示完整的图像，只不过是黑白的，这样的设计很好地解决了彩色电视机与黑白电视的兼容问题。并且，YUV不像RGB那样要求三个独立的视频信号同时传输，所以用YUV方式传送占用极少的频宽。</p>\n</blockquote>\n<p>YUV码流的存储格式其实与其采样的方式密切相关，主流的采样方式有三种，YUV4:4:4，YUV4:2:2，YUV4:2:0。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/10/video5.jpg\" alt=\"\"></p>\n<ol>\n<li>YUV 4:4:4采样，每一个Y对应一组UV分量。</li>\n<li>YUV 4:2:2采样，每两个Y共用一组UV分量。</li>\n<li>YUV 4:2:0采样，每四个Y共用一组UV分量。</li>\n</ol>\n<p>这里只抛出这样一个概念，详情请参见文末的<code>参考</code>。</p>","more":"<h2 id=\"H264\"><a href=\"#H264\" class=\"headerlink\" title=\"H264\"></a>H264</h2><p>H264作为当前最火热的编码方式，它有着特殊的分层结构。</p>\n<blockquote>\n<p>H.264 的功能分为两层：视频编码层(VCL, Video Coding Layer)和网络提取层(NAL, Network Abstraction Layer)。VCL 数据即编码处理的输出，它表示被压缩编码后的视频数据 序列。在 VCL 数据传输或存储之前,这些编码的 VCL 数据，先被映射或封装进 NAL 单元中。每个 NAL 单元包括一个原始字节序列负荷(RBSP, Raw Byte Sequence Payload)、一组对应于视频编码的 NAL 头信息。RBSP 的基本结构是：在原始编码数据的后面填加了结尾比特。一个bit“1”若干比特“0”，以便字节对齐。</p>\n</blockquote>\n<p>在H264中，无论是SPS、PPS或者是slice data，都是由一个NAL unit所组成。<br>NALU头结构：NALU类型(5bit)、重要性指示位(2bit)、禁止位(1bit)。</p>\n<ol>\n<li>NALU类型：1～12由H.264使用，24～31由H.264以外的应用使用。</li>\n<li>重要性指示：标志该NAL单元用于重建时的重要性，值越大，越重要。</li>\n<li>禁止位：网络发现NAL单元有比特错误时可设置该比特为1，以便接收方丢掉该单元。</li>\n</ol>\n<p>这里依然是抛出这样一个概念，详情请参见文末的<code>参考</code>。（因为我自己也没怎么弄懂，哈哈哈~）</p>\n<h2 id=\"实例\"><a href=\"#实例\" class=\"headerlink\" title=\"实例\"></a>实例</h2><p>下面直接结合<code>Camera</code>与<code>MediaCodec</code>来实现视频采集与编码，并且输出yuv、h264文件。<br>初始化MediaCodec:<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> initMediaCodec() &#123;</div><div class=\"line\">    <span class=\"built_in\">int</span> degree = getDegree();</div><div class=\"line\">    framerate = <span class=\"number\">15</span>;</div><div class=\"line\">    bitrate = <span class=\"number\">2</span> * <span class=\"built_in\">width</span> * <span class=\"built_in\">height</span> * framerate / <span class=\"number\">20</span>;</div><div class=\"line\">    EncoderDebugger debugger = EncoderDebugger.debug(getApplicationContext(), <span class=\"built_in\">width</span>, <span class=\"built_in\">height</span>);</div><div class=\"line\">    mConvertor = debugger.getNV21Convertor();</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());</div><div class=\"line\">        MediaFormat mediaFormat;</div><div class=\"line\">        <span class=\"keyword\">if</span> (degree == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            mediaFormat = MediaFormat.createVideoFormat(<span class=\"string\">\"video/avc\"</span>, <span class=\"built_in\">height</span>, <span class=\"built_in\">width</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            mediaFormat = MediaFormat.createVideoFormat(<span class=\"string\">\"video/avc\"</span>, <span class=\"built_in\">width</span>, <span class=\"built_in\">height</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate);</div><div class=\"line\">        mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, framerate);</div><div class=\"line\">        mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,</div><div class=\"line\">                debugger.getEncoderColorFormat());</div><div class=\"line\">        mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, <span class=\"number\">1</span>);</div><div class=\"line\">        mMediaCodec.configure(mediaFormat, <span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</div><div class=\"line\">        mMediaCodec.start();</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">        e.printStackTrace();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>获取Camera：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">private <span class=\"keyword\">boolean </span>createCamera(SurfaceHolder surfaceHolder) &#123;</div><div class=\"line\">    try &#123;</div><div class=\"line\">        mCamera = Camera.open(mCameraId)<span class=\"comment\">;</span></div><div class=\"line\">        Camera.Parameters parameters = mCamera.getParameters()<span class=\"comment\">;</span></div><div class=\"line\">        int[] max = determineMaximumSupportedFrameRate(parameters)<span class=\"comment\">;</span></div><div class=\"line\">        Camera.CameraInfo camInfo = new Camera.CameraInfo()<span class=\"comment\">;</span></div><div class=\"line\">        Camera.getCameraInfo(mCameraId, camInfo)<span class=\"comment\">;</span></div><div class=\"line\">        int cameraRotationOffset = camInfo.<span class=\"keyword\">orientation;</div><div class=\"line\"></span>        int rotate = (<span class=\"number\">360</span> + cameraRotationOffset - getDegree()) % <span class=\"number\">360</span><span class=\"comment\">;</span></div><div class=\"line\">        parameters.setRotation(rotate)<span class=\"comment\">;</span></div><div class=\"line\">        parameters.setPreviewFormat(ImageFormat.NV21)<span class=\"comment\">;</span></div><div class=\"line\">        parameters.setPreviewSize(width, height)<span class=\"comment\">;</span></div><div class=\"line\">        parameters.setPreviewFpsRange(max[<span class=\"number\">0</span>], max[<span class=\"number\">1</span>])<span class=\"comment\">;</span></div><div class=\"line\">        mCamera.setParameters(parameters)<span class=\"comment\">;</span></div><div class=\"line\">        mCamera.autoFocus(null)<span class=\"comment\">;</span></div><div class=\"line\">        int <span class=\"keyword\">displayRotation;</div><div class=\"line\"></span>        <span class=\"keyword\">displayRotation </span>= (cameraRotationOffset - getDegree() + <span class=\"number\">360</span>) % <span class=\"number\">360</span><span class=\"comment\">;</span></div><div class=\"line\">        mCamera.setDisplayOrientation(<span class=\"keyword\">displayRotation);</div><div class=\"line\"></span>        mCamera.setPreviewDisplay(surfaceHolder)<span class=\"comment\">;</span></div><div class=\"line\">        return true<span class=\"comment\">;</span></div><div class=\"line\">    &#125; catch (Exception e) &#123;</div><div class=\"line\">        StringWriter <span class=\"keyword\">sw </span>= new StringWriter()<span class=\"comment\">;</span></div><div class=\"line\">        PrintWriter pw = new PrintWriter(<span class=\"keyword\">sw);</div><div class=\"line\"></span>        e.printStackTrace(pw)<span class=\"comment\">;</span></div><div class=\"line\">        String stack = <span class=\"keyword\">sw.toString();</div><div class=\"line\"></span>        Toast.makeText(this, stack, Toast.LENGTH_LONG).<span class=\"keyword\">show();</div><div class=\"line\"></span>        destroyCamera()<span class=\"comment\">;</span></div><div class=\"line\">        e.printStackTrace()<span class=\"comment\">;</span></div><div class=\"line\">        return false<span class=\"comment\">;</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>采集并编码：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div></pre></td><td class=\"code\"><pre><div class=\"line\">Camera.PreviewCallback previewCallback = <span class=\"keyword\">new</span> Camera.PreviewCallback() &#123;</div><div class=\"line\">    <span class=\"built_in\">byte</span>[] mPpsSps = <span class=\"keyword\">new</span> <span class=\"built_in\">byte</span>[<span class=\"number\">0</span>];</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> onPreviewFrame(<span class=\"built_in\">byte</span>[] data, Camera <span class=\"built_in\">camera</span>) &#123;</div><div class=\"line\">        <span class=\"comment\">// data即是NV21的数据</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (data == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();</div><div class=\"line\">        ByteBuffer[] outputBuffers = mMediaCodec.getOutputBuffers();</div><div class=\"line\">        <span class=\"built_in\">byte</span>[] dst;</div><div class=\"line\">        Camera.Size previewSize = mCamera.getParameters().getPreviewSize();</div><div class=\"line\">        <span class=\"keyword\">if</span> (getDegree() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            dst = Util.rotateNV21Degree90(data, previewSize.<span class=\"built_in\">width</span>, previewSize.<span class=\"built_in\">height</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            dst = data;</div><div class=\"line\">        &#125;</div><div class=\"line\">        Util.<span class=\"built_in\">save</span>(data, <span class=\"number\">0</span>, data.length, yuvPath, <span class=\"keyword\">true</span>);</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            <span class=\"built_in\">int</span> bufferIndex = mMediaCodec.dequeueInputBuffer(<span class=\"number\">5000000</span>);</div><div class=\"line\">            <span class=\"keyword\">if</span> (bufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                inputBuffers[bufferIndex].<span class=\"built_in\">clear</span>();</div><div class=\"line\">                mConvertor.convert(dst, inputBuffers[bufferIndex]);</div><div class=\"line\">                mMediaCodec.queueInputBuffer(bufferIndex, <span class=\"number\">0</span>,</div><div class=\"line\">                        inputBuffers[bufferIndex].position(),</div><div class=\"line\">                        System.nanoTime() / <span class=\"number\">1000</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                MediaCodec.BufferInfo bufferInfo = <span class=\"keyword\">new</span> MediaCodec.BufferInfo();</div><div class=\"line\">                <span class=\"built_in\">int</span> outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, <span class=\"number\">0</span>);</div><div class=\"line\">                <span class=\"keyword\">while</span> (outputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    ByteBuffer outputBuffer = outputBuffers[outputBufferIndex];</div><div class=\"line\">                    <span class=\"built_in\">byte</span>[] outData = <span class=\"keyword\">new</span> <span class=\"built_in\">byte</span>[bufferInfo.<span class=\"built_in\">size</span>];</div><div class=\"line\">                    outputBuffer.<span class=\"built_in\">get</span>(outData);</div><div class=\"line\">                    <span class=\"comment\">//记录pps和sps</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (outData[<span class=\"number\">0</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">1</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">2</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">3</span>] == <span class=\"number\">1</span> &amp;&amp; outData[<span class=\"number\">4</span>] == <span class=\"number\">103</span>) &#123;</div><div class=\"line\">                        mPpsSps = outData;</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (outData[<span class=\"number\">0</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">1</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">2</span>] == <span class=\"number\">0</span> &amp;&amp; outData[<span class=\"number\">3</span>] == <span class=\"number\">1</span> &amp;&amp; outData[<span class=\"number\">4</span>] == <span class=\"number\">101</span>) &#123;</div><div class=\"line\">                        <span class=\"comment\">//在关键帧前面加上pps和sps数据</span></div><div class=\"line\">                        <span class=\"built_in\">byte</span>[] frameData = <span class=\"keyword\">new</span> <span class=\"built_in\">byte</span>[mPpsSps.length + outData.length];</div><div class=\"line\">                        System.arraycopy(mPpsSps, <span class=\"number\">0</span>, frameData, <span class=\"number\">0</span>, mPpsSps.length);</div><div class=\"line\">                        System.arraycopy(outData, <span class=\"number\">0</span>, frameData, mPpsSps.length, outData.length);</div><div class=\"line\">                        outData = frameData;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    Util.<span class=\"built_in\">save</span>(outData, <span class=\"number\">0</span>, outData.length, path, <span class=\"keyword\">true</span>);</div><div class=\"line\">                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, <span class=\"keyword\">false</span>);</div><div class=\"line\">                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, <span class=\"number\">0</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                Log.e(<span class=\"string\">\"easypusher\"</span>, <span class=\"string\">\"No buffer available !\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">            StringWriter sw = <span class=\"keyword\">new</span> StringWriter();</div><div class=\"line\">            PrintWriter pw = <span class=\"keyword\">new</span> PrintWriter(sw);</div><div class=\"line\">            e.printStackTrace(pw);</div><div class=\"line\">            <span class=\"keyword\">String</span> stack = sw.toString();</div><div class=\"line\">            Log.e(<span class=\"string\">\"save_log\"</span>, stack);</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\">            mCamera.addCallbackBuffer(dst);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure></p>\n<p>获取摄像头支持的分辨率代码：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> determineClosestSupportedResolution(Camera.Parameters parameters) &#123;</div><div class=\"line\">    String supportedSizesStr = <span class=\"string\">\"Supported resolutions: \"</span>;</div><div class=\"line\">    List&lt;Camera.<span class=\"keyword\">Size</span>&gt; supportedSizes = parameters.getSupportedPreviewSizes();</div><div class=\"line\">    <span class=\"keyword\">for</span> (Iterator&lt;Camera.<span class=\"keyword\">Size</span>&gt; it = supportedSizes.iterator(); it.hasNext(); ) &#123;</div><div class=\"line\">        Camera.<span class=\"keyword\">Size</span> <span class=\"keyword\">size</span> = it.<span class=\"keyword\">next</span>();</div><div class=\"line\">        supportedSizesStr += <span class=\"keyword\">size</span>.width + <span class=\"string\">\"x\"</span> + <span class=\"keyword\">size</span>.height + (it.hasNext() ? <span class=\"string\">\", \"</span> : <span class=\"string\">\"\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    Log.e(<span class=\"string\">\"TAG\"</span>, supportedSizesStr);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>后面运行，点击<code>开始</code>进行录制，再次点击结束录制，会在sdcard上生成2个文件<code>test_1280x720.yuv</code>、<code>test_1280x720.h264</code>。<br>下载工具后进行查看文件便能看到录制的视频了。<br>YUV工具我是用的雷神改作的一个：<a href=\"http://blog.csdn.net/leixiaohua1020/article/details/50466201\">修改了一个YUV/RGB播放器</a>。<br>H264工具则是用的<a href=\"http://www.videolan.org/vlc/\">VLC</a>。</p>\n<p><a href=\"https://github.com/LiJia92/spydroid-ipcamera\">工程代码示例</a></p>\n<p>Tip：Camera采集默认是横屏，所以竖屏采集输出的图像需要旋转90度，解决方法参见<code>参考</code>即demo中的代码。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"http://www.cnblogs.com/raomengyang/p/4852277.html\">Camera的简单使用浅析</a><br><a href=\"http://www.cnblogs.com/raomengyang/p/5426525.html\">Android Camera原始帧格式转换 —— 获取Camera图像（一）</a><br><a href=\"http://www.cnblogs.com/raomengyang/p/5582270.html\">直播必备之YUV使用总结 —— Android常用的几种格式：NV21/NV12/YV12/YUV420P的区别</a><br><a href=\"https://developer.android.com/guide/topics/media/camera.html\">Camera</a><br><a href=\"https://developer.android.com/reference/android/media/MediaCodec.html\">MediaCodec</a><br><a href=\"https://msdn.microsoft.com/en-us/library/aa904813.aspx\">Video Rendering with 8-Bit YUV Formats</a><br><a href=\"http://www.ay27.com/2014/10/09/2014-10-09-a-simple-image-rotate-function/\">YUV420SP图像的旋转</a><br><a href=\"http://www.cnblogs.com/azraelly/archive/2013/01/01/2841269.htm\">图文详解YUV420数据格式</a><br><a href=\"http://www.cnblogs.com/skyseraph/archive/2012/03/26/2418665.html\">Android 实时视频采集—Cameara预览采集</a><br><a href=\"http://brytsai.blogspot.jp/2010/02/h.html\">H.264中如何判斷某一段是否為SPS(Sequence Parameter Set)或PPS(Picture Parameter Set)</a><br><a href=\"http://blog.csdn.net/u013758734/article/details/50834770\">EasyPusher安卓Android手机直播推送之MediaCodec 硬编码H264格式</a><br><a href=\"http://www.dobest.me/blog/2016/06/17/Android%E5%B1%8F%E5%B9%95%E7%9B%B4%E6%92%AD%E6%96%B9%E6%A1%88/\">Android屏幕直播方案</a></p>"},{"title":"使用Android新特性：Material Design","date":"2016-02-17T08:34:11.000Z","_content":"\n## 前言\n大年初十，相信许多人都已经过完年，在上班的路上或者已经上班了。在这里跟大家说一声：新年好~\n\n新年新气象，今天打算写一篇关于Android新特性：``Material Design``的文章。Material Design作为android 5.0的重头戏，说是新特性，但是其实已经算不上“新”了，毕竟android 6.0都出来了呢。\n\n情人节刚过，我便以“秀恩爱”为主题，做一个新特性的使用例子。废话少说，下面开撸。\n\n## 添加依赖\n使用新特性需要添加依赖：\n```\ncompile 'com.android.support:design:23.0.1'\ncompile 'com.android.support:cardview-v7:23.1.0'\ncompile 'com.android.support:recyclerview-v7:23.1.0'\n```\n<!--more-->\n\n## 新组件介绍\n\n### AppBarlayout\nAppBarLayout是继承LinearLayout实现的一个ViewGroup容器组件，它是为了Material Design设计的App Bar,支持手势滑动操作。默认的AppBarLayout是垂直方向的，它的作用是把AppBarLayout包裹的内容都作为AppBar。\n\n常用效果：将Toolbar 和Tablayout的组合部分共同构成 AppBar的效果。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design1.png)\n\n### CoordinatorLayout\nCoordinatorLayout是一个增强型的FrameLayout。它的作用有两个：\n\n 1. 作为一个布局的根布局\n 2. 最后一个为子视图之间相互协调手势效果的一个协调布局\n\n我们可以用过上滑将顶部的ToolBar移出屏幕，下滑时再显示。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design2.png)\n\n### NavigationView\n用于侧滑菜单中的menu布局。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design3.png)\n\n### FloatingActionButton\n悬浮按钮，给人一种Z轴的空间感。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design4.png)\n\n### SnackBar\n当Snackbar在显示的时候，往往出现在屏幕的底部。为了给Snackbar留出空间，浮动操作按钮需要向上移动。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design5.png)\n\n### CardView\nCardView继承自FrameLayout类，可以在一个卡片布局中一致性的显示内容，卡片可以包含圆角和阴影。CardView是一个Layout，可以布局其他View。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design6.png)\n\n### RecyclerView\nRecyclerView用于展示数据集，与ListView、GridView类似，但是它更灵活。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design7.png)\n\n### SwipeRefreshLayout\nGoogle官方推出的下拉刷新控件，使用非常简便。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design8.png)\n\n## 布局文件\n首先是activity_main布局文件：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.v4.widget.DrawerLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:id=\"@+id/drawer_layout\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\">\n\n    <include layout=\"@layout/content_main\" />\n\n    <android.support.design.widget.NavigationView\n        android:id=\"@+id/navigation\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\"\n        android:layout_gravity=\"left\" />\n\n\n</android.support.v4.widget.DrawerLayout>\n```\n看到content_main.xml：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.design.widget.CoordinatorLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:fitsSystemWindows=\"true\">\n\n    <android.support.design.widget.AppBarLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:theme=\"@style/AppTheme.AppBarOverlay\">\n\n        <android.support.v7.widget.Toolbar\n            android:id=\"@+id/toolbar\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"?attr/actionBarSize\"\n            android:background=\"?attr/colorPrimary\"\n            app:layout_scrollFlags=\"scroll|enterAlways\"\n            app:popupTheme=\"@style/ThemeOverlay.AppCompat.Light\"\n            app:theme=\"@style/ThemeOverlay.AppCompat.ActionBar\"\n            app:title=\"\" />\n\n        <android.support.design.widget.TabLayout\n            android:id=\"@+id/tab_layout\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\"\n            app:tabGravity=\"fill\"\n            app:tabIndicatorColor=\"#ffffff\" />\n\n    </android.support.design.widget.AppBarLayout>\n\n    <android.support.v4.view.ViewPager\n        android:id=\"@+id/view_pager\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        app:layout_behavior=\"@string/appbar_scrolling_view_behavior\" />\n\n    <android.support.design.widget.FloatingActionButton\n        android:id=\"@+id/floating_button\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:layout_gravity=\"bottom|end\"\n        android:layout_margin=\"@dimen/fab_margin\"\n        android:src=\"@android:drawable/ic_dialog_email\" />\n\n</android.support.design.widget.CoordinatorLayout>\n\n```\nViewPager对应的fragment布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.v4.widget.SwipeRefreshLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:id=\"@+id/swipe_refresh\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    app:layout_behavior=\"@string/appbar_scrolling_view_behavior\">\n\n    <android.support.v7.widget.RecyclerView\n        android:id=\"@+id/recycler_view\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\" />\n\n\n</android.support.v4.widget.SwipeRefreshLayout>\n\n```\nRecyclerView对应的Adapter布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.v7.widget.CardView xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"wrap_content\"\n    android:layout_gravity=\"center\"\n    app:cardCornerRadius=\"4dp\"\n    app:cardElevation=\"5dp\"\n    app:cardMaxElevation=\"10dp\"\n    app:cardPreventCornerOverlap=\"true\"\n    app:cardUseCompatPadding=\"true\">\n\n    <TextView\n        android:id=\"@+id/card_text\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"200dp\"\n        android:layout_gravity=\"center\"\n        android:gravity=\"center\"\n        android:text=\"1111\"\n        android:textColor=\"@android:color/black\"\n        android:textSize=\"30sp\" />\n\n</android.support.v7.widget.CardView>\n```\n抽屉对应的HeaderView布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"220dp\"\n    android:background=\"@drawable/ic_user_background\"\n    android:gravity=\"center\"\n    android:orientation=\"vertical\">\n\n    <ImageView\n        android:id=\"@+id/id_header_face\"\n        android:layout_width=\"120dp\"\n        android:layout_height=\"120dp\"\n        android:scaleType=\"fitXY\"\n        android:src=\"@drawable/user\" />\n\n    <TextView\n        android:id=\"@+id/id_header_authorname\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:text=\"@string/header_author_name\"\n        android:textColor=\"@android:color/black\"\n        android:textSize=\"16sp\" />\n\n    <TextView\n        android:id=\"@+id/id_header_url\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:text=\"@string/header_author_url\"\n        android:textColor=\"@android:color/black\"\n        android:textSize=\"18sp\" />\n\n\n</LinearLayout>\n```\n\n## 相关说明 ##\n\n1. 使用NavigationView时，通过``layout_gravity=\"left\"``属性控制抽屉从左边打开。\n抽屉内容填充对应于xml属性app:headerLayout与app:menu。\n```\n// 跳转到Menu的Toggle\nActionBarDrawerToggle mActionBarDrawerToggle = new ActionBarDrawerToggle(this, drawerLayout, toolbar, R.string.drawer_open, R.string.drawer_open);\nmActionBarDrawerToggle.syncState();\ndrawerLayout.setDrawerListener(mActionBarDrawerToggle);\n\n// 抽屉菜单填充内容\nnavigationView.inflateHeaderView(R.layout.header_navigation);\nnavigationView.inflateMenu(R.menu.menu_navigation);\n```\n\n2. TabLayout与ViewPager关联。\n```\ntabLayout.setTabMode(TabLayout.MODE_SCROLLABLE);\ntabLayout.setupWithViewPager(viewPager);\ntabLayout.setTabsFromPagerAdapter(myViewPagerAdapter);\n```\n\n3. SwipeRefreshLayout刷新设置颜色及刷新事件。\n```\nswipeRefreshLayout = (SwipeRefreshLayout) view.findViewById(R.id.swipe_refresh);\nswipeRefreshLayout.setColorSchemeResources(R.color.colorPrimary);\nswipeRefreshLayout.setOnRefreshListener(this);\n```\n\n4. RecyclerView设置布局及Adapter。\n```\nRecyclerView recyclerView = (RecyclerView) view.findViewById(R.id.recycler_view);\nadapter = new MyRecyclerViewAdapter(getActivity());\nRecyclerView.LayoutManager layoutManager = new LinearLayoutManager(getActivity(), LinearLayoutManager.VERTICAL, false);\nrecyclerView.setAdapter(adapter);\nrecyclerView.setLayoutManager(layoutManager);\n```\n5. CoordinatorLayout可滑动的条件。\n\n - CoordinatorLayout必须作为整个布局的父布局容器。\n - 给需要滑动的组件设置 app:layout_scrollFlags=”scroll|enterAlways” 属性。 (ToolBar)\n - 给你的可滑动的组件，也就是RecyclerView、ViewPager或者 NestedScrollView 设置属性：``app:layout_behavior=@string/appbar_scrolling_view_behavior``\n\n6. 设置的layout_scrollFlags有如下几种选项：\n\n - scroll: 所有想滚动出屏幕的view都需要设置这个flag- 没有设置这个flag的view将被固定在屏幕顶部。\n - enterAlways: 这个flag让任意向下的滚动都会导致该view变为可见，启用快速“返回模式”。\n - enterAlwaysCollapsed: 当你的视图已经设置minHeight属性又使用此标志时，你的视图只能已最小高度进入，只有当滚动视图到达顶部时才扩大到完整高度。\n - exitUntilCollapsed: 滚动退出屏幕，最后折叠在顶端。\n\n在我的布局中给Toolbar设置了app:layout_scrollFlags属性，因此，Toolbar是可以滚动出屏幕，且向下滚动有可以出现。\n\n## 最后\n最终效果：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design9.png)\n源码地址：https://github.com/LiJia92/showlove\n\nTips：本文只对这些新的特性做了最基本的说明及非常简单的使用，至于更加复杂的使用及效果，则需要在使用过程中慢慢发现、慢慢学习了。\n","source":"_posts/material-design.md","raw":"---\ntitle: 使用Android新特性：Material Design\ndate: 2016-02-17 16:34:11\ntags:\n - 日常开发\n---\n\n## 前言\n大年初十，相信许多人都已经过完年，在上班的路上或者已经上班了。在这里跟大家说一声：新年好~\n\n新年新气象，今天打算写一篇关于Android新特性：``Material Design``的文章。Material Design作为android 5.0的重头戏，说是新特性，但是其实已经算不上“新”了，毕竟android 6.0都出来了呢。\n\n情人节刚过，我便以“秀恩爱”为主题，做一个新特性的使用例子。废话少说，下面开撸。\n\n## 添加依赖\n使用新特性需要添加依赖：\n```\ncompile 'com.android.support:design:23.0.1'\ncompile 'com.android.support:cardview-v7:23.1.0'\ncompile 'com.android.support:recyclerview-v7:23.1.0'\n```\n<!--more-->\n\n## 新组件介绍\n\n### AppBarlayout\nAppBarLayout是继承LinearLayout实现的一个ViewGroup容器组件，它是为了Material Design设计的App Bar,支持手势滑动操作。默认的AppBarLayout是垂直方向的，它的作用是把AppBarLayout包裹的内容都作为AppBar。\n\n常用效果：将Toolbar 和Tablayout的组合部分共同构成 AppBar的效果。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design1.png)\n\n### CoordinatorLayout\nCoordinatorLayout是一个增强型的FrameLayout。它的作用有两个：\n\n 1. 作为一个布局的根布局\n 2. 最后一个为子视图之间相互协调手势效果的一个协调布局\n\n我们可以用过上滑将顶部的ToolBar移出屏幕，下滑时再显示。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design2.png)\n\n### NavigationView\n用于侧滑菜单中的menu布局。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design3.png)\n\n### FloatingActionButton\n悬浮按钮，给人一种Z轴的空间感。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design4.png)\n\n### SnackBar\n当Snackbar在显示的时候，往往出现在屏幕的底部。为了给Snackbar留出空间，浮动操作按钮需要向上移动。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design5.png)\n\n### CardView\nCardView继承自FrameLayout类，可以在一个卡片布局中一致性的显示内容，卡片可以包含圆角和阴影。CardView是一个Layout，可以布局其他View。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design6.png)\n\n### RecyclerView\nRecyclerView用于展示数据集，与ListView、GridView类似，但是它更灵活。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design7.png)\n\n### SwipeRefreshLayout\nGoogle官方推出的下拉刷新控件，使用非常简便。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design8.png)\n\n## 布局文件\n首先是activity_main布局文件：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.v4.widget.DrawerLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:id=\"@+id/drawer_layout\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\">\n\n    <include layout=\"@layout/content_main\" />\n\n    <android.support.design.widget.NavigationView\n        android:id=\"@+id/navigation\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\"\n        android:layout_gravity=\"left\" />\n\n\n</android.support.v4.widget.DrawerLayout>\n```\n看到content_main.xml：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.design.widget.CoordinatorLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:fitsSystemWindows=\"true\">\n\n    <android.support.design.widget.AppBarLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:theme=\"@style/AppTheme.AppBarOverlay\">\n\n        <android.support.v7.widget.Toolbar\n            android:id=\"@+id/toolbar\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"?attr/actionBarSize\"\n            android:background=\"?attr/colorPrimary\"\n            app:layout_scrollFlags=\"scroll|enterAlways\"\n            app:popupTheme=\"@style/ThemeOverlay.AppCompat.Light\"\n            app:theme=\"@style/ThemeOverlay.AppCompat.ActionBar\"\n            app:title=\"\" />\n\n        <android.support.design.widget.TabLayout\n            android:id=\"@+id/tab_layout\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\"\n            app:tabGravity=\"fill\"\n            app:tabIndicatorColor=\"#ffffff\" />\n\n    </android.support.design.widget.AppBarLayout>\n\n    <android.support.v4.view.ViewPager\n        android:id=\"@+id/view_pager\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        app:layout_behavior=\"@string/appbar_scrolling_view_behavior\" />\n\n    <android.support.design.widget.FloatingActionButton\n        android:id=\"@+id/floating_button\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:layout_gravity=\"bottom|end\"\n        android:layout_margin=\"@dimen/fab_margin\"\n        android:src=\"@android:drawable/ic_dialog_email\" />\n\n</android.support.design.widget.CoordinatorLayout>\n\n```\nViewPager对应的fragment布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.v4.widget.SwipeRefreshLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:id=\"@+id/swipe_refresh\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    app:layout_behavior=\"@string/appbar_scrolling_view_behavior\">\n\n    <android.support.v7.widget.RecyclerView\n        android:id=\"@+id/recycler_view\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\" />\n\n\n</android.support.v4.widget.SwipeRefreshLayout>\n\n```\nRecyclerView对应的Adapter布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.v7.widget.CardView xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"wrap_content\"\n    android:layout_gravity=\"center\"\n    app:cardCornerRadius=\"4dp\"\n    app:cardElevation=\"5dp\"\n    app:cardMaxElevation=\"10dp\"\n    app:cardPreventCornerOverlap=\"true\"\n    app:cardUseCompatPadding=\"true\">\n\n    <TextView\n        android:id=\"@+id/card_text\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"200dp\"\n        android:layout_gravity=\"center\"\n        android:gravity=\"center\"\n        android:text=\"1111\"\n        android:textColor=\"@android:color/black\"\n        android:textSize=\"30sp\" />\n\n</android.support.v7.widget.CardView>\n```\n抽屉对应的HeaderView布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"220dp\"\n    android:background=\"@drawable/ic_user_background\"\n    android:gravity=\"center\"\n    android:orientation=\"vertical\">\n\n    <ImageView\n        android:id=\"@+id/id_header_face\"\n        android:layout_width=\"120dp\"\n        android:layout_height=\"120dp\"\n        android:scaleType=\"fitXY\"\n        android:src=\"@drawable/user\" />\n\n    <TextView\n        android:id=\"@+id/id_header_authorname\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:text=\"@string/header_author_name\"\n        android:textColor=\"@android:color/black\"\n        android:textSize=\"16sp\" />\n\n    <TextView\n        android:id=\"@+id/id_header_url\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:text=\"@string/header_author_url\"\n        android:textColor=\"@android:color/black\"\n        android:textSize=\"18sp\" />\n\n\n</LinearLayout>\n```\n\n## 相关说明 ##\n\n1. 使用NavigationView时，通过``layout_gravity=\"left\"``属性控制抽屉从左边打开。\n抽屉内容填充对应于xml属性app:headerLayout与app:menu。\n```\n// 跳转到Menu的Toggle\nActionBarDrawerToggle mActionBarDrawerToggle = new ActionBarDrawerToggle(this, drawerLayout, toolbar, R.string.drawer_open, R.string.drawer_open);\nmActionBarDrawerToggle.syncState();\ndrawerLayout.setDrawerListener(mActionBarDrawerToggle);\n\n// 抽屉菜单填充内容\nnavigationView.inflateHeaderView(R.layout.header_navigation);\nnavigationView.inflateMenu(R.menu.menu_navigation);\n```\n\n2. TabLayout与ViewPager关联。\n```\ntabLayout.setTabMode(TabLayout.MODE_SCROLLABLE);\ntabLayout.setupWithViewPager(viewPager);\ntabLayout.setTabsFromPagerAdapter(myViewPagerAdapter);\n```\n\n3. SwipeRefreshLayout刷新设置颜色及刷新事件。\n```\nswipeRefreshLayout = (SwipeRefreshLayout) view.findViewById(R.id.swipe_refresh);\nswipeRefreshLayout.setColorSchemeResources(R.color.colorPrimary);\nswipeRefreshLayout.setOnRefreshListener(this);\n```\n\n4. RecyclerView设置布局及Adapter。\n```\nRecyclerView recyclerView = (RecyclerView) view.findViewById(R.id.recycler_view);\nadapter = new MyRecyclerViewAdapter(getActivity());\nRecyclerView.LayoutManager layoutManager = new LinearLayoutManager(getActivity(), LinearLayoutManager.VERTICAL, false);\nrecyclerView.setAdapter(adapter);\nrecyclerView.setLayoutManager(layoutManager);\n```\n5. CoordinatorLayout可滑动的条件。\n\n - CoordinatorLayout必须作为整个布局的父布局容器。\n - 给需要滑动的组件设置 app:layout_scrollFlags=”scroll|enterAlways” 属性。 (ToolBar)\n - 给你的可滑动的组件，也就是RecyclerView、ViewPager或者 NestedScrollView 设置属性：``app:layout_behavior=@string/appbar_scrolling_view_behavior``\n\n6. 设置的layout_scrollFlags有如下几种选项：\n\n - scroll: 所有想滚动出屏幕的view都需要设置这个flag- 没有设置这个flag的view将被固定在屏幕顶部。\n - enterAlways: 这个flag让任意向下的滚动都会导致该view变为可见，启用快速“返回模式”。\n - enterAlwaysCollapsed: 当你的视图已经设置minHeight属性又使用此标志时，你的视图只能已最小高度进入，只有当滚动视图到达顶部时才扩大到完整高度。\n - exitUntilCollapsed: 滚动退出屏幕，最后折叠在顶端。\n\n在我的布局中给Toolbar设置了app:layout_scrollFlags属性，因此，Toolbar是可以滚动出屏幕，且向下滚动有可以出现。\n\n## 最后\n最终效果：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design9.png)\n源码地址：https://github.com/LiJia92/showlove\n\nTips：本文只对这些新的特性做了最基本的说明及非常简单的使用，至于更加复杂的使用及效果，则需要在使用过程中慢慢发现、慢慢学习了。\n","slug":"material-design","published":1,"updated":"2016-11-21T10:01:54.257Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759l001y1cb8768il9v8","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>大年初十，相信许多人都已经过完年，在上班的路上或者已经上班了。在这里跟大家说一声：新年好~</p>\n<p>新年新气象，今天打算写一篇关于Android新特性：<code>Material Design</code>的文章。Material Design作为android 5.0的重头戏，说是新特性，但是其实已经算不上“新”了，毕竟android 6.0都出来了呢。</p>\n<p>情人节刚过，我便以“秀恩爱”为主题，做一个新特性的使用例子。废话少说，下面开撸。</p>\n<h2 id=\"添加依赖\"><a href=\"#添加依赖\" class=\"headerlink\" title=\"添加依赖\"></a>添加依赖</h2><p>使用新特性需要添加依赖：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.android.support:design:23.0.1'</span></div><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.android.support:cardview-v7:23.1.0'</span></div><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.android.support:recyclerview-v7:23.1.0'</span></div></pre></td></tr></table></figure></p>\n<a id=\"more\"></a>\n<h2 id=\"新组件介绍\"><a href=\"#新组件介绍\" class=\"headerlink\" title=\"新组件介绍\"></a>新组件介绍</h2><h3 id=\"AppBarlayout\"><a href=\"#AppBarlayout\" class=\"headerlink\" title=\"AppBarlayout\"></a>AppBarlayout</h3><p>AppBarLayout是继承LinearLayout实现的一个ViewGroup容器组件，它是为了Material Design设计的App Bar,支持手势滑动操作。默认的AppBarLayout是垂直方向的，它的作用是把AppBarLayout包裹的内容都作为AppBar。</p>\n<p>常用效果：将Toolbar 和Tablayout的组合部分共同构成 AppBar的效果。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design1.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"CoordinatorLayout\"><a href=\"#CoordinatorLayout\" class=\"headerlink\" title=\"CoordinatorLayout\"></a>CoordinatorLayout</h3><p>CoordinatorLayout是一个增强型的FrameLayout。它的作用有两个：</p>\n<ol>\n<li>作为一个布局的根布局</li>\n<li>最后一个为子视图之间相互协调手势效果的一个协调布局</li>\n</ol>\n<p>我们可以用过上滑将顶部的ToolBar移出屏幕，下滑时再显示。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design2.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"NavigationView\"><a href=\"#NavigationView\" class=\"headerlink\" title=\"NavigationView\"></a>NavigationView</h3><p>用于侧滑菜单中的menu布局。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design3.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"FloatingActionButton\"><a href=\"#FloatingActionButton\" class=\"headerlink\" title=\"FloatingActionButton\"></a>FloatingActionButton</h3><p>悬浮按钮，给人一种Z轴的空间感。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design4.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"SnackBar\"><a href=\"#SnackBar\" class=\"headerlink\" title=\"SnackBar\"></a>SnackBar</h3><p>当Snackbar在显示的时候，往往出现在屏幕的底部。为了给Snackbar留出空间，浮动操作按钮需要向上移动。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design5.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"CardView\"><a href=\"#CardView\" class=\"headerlink\" title=\"CardView\"></a>CardView</h3><p>CardView继承自FrameLayout类，可以在一个卡片布局中一致性的显示内容，卡片可以包含圆角和阴影。CardView是一个Layout，可以布局其他View。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design6.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"RecyclerView\"><a href=\"#RecyclerView\" class=\"headerlink\" title=\"RecyclerView\"></a>RecyclerView</h3><p>RecyclerView用于展示数据集，与ListView、GridView类似，但是它更灵活。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design7.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"SwipeRefreshLayout\"><a href=\"#SwipeRefreshLayout\" class=\"headerlink\" title=\"SwipeRefreshLayout\"></a>SwipeRefreshLayout</h3><p>Google官方推出的下拉刷新控件，使用非常简便。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design8.png\" alt=\"这里写图片描述\"></p>\n<h2 id=\"布局文件\"><a href=\"#布局文件\" class=\"headerlink\" title=\"布局文件\"></a>布局文件</h2><p>首先是activity_main布局文件：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">android.support.v4.widget.DrawerLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/drawer_layout\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">include</span> <span class=\"attr\">layout</span>=<span class=\"string\">\"@layout/content_main\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.NavigationView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/navigation\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"left\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">android.support.v4.widget.DrawerLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>看到content_main.xml：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.CoordinatorLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:fitsSystemWindows</span>=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.AppBarLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:theme</span>=<span class=\"string\">\"@style/AppTheme.AppBarOverlay\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">android.support.v7.widget.Toolbar</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/toolbar\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"?attr/actionBarSize\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"?attr/colorPrimary\"</span></div><div class=\"line\">            <span class=\"attr\">app:layout_scrollFlags</span>=<span class=\"string\">\"scroll|enterAlways\"</span></div><div class=\"line\">            <span class=\"attr\">app:popupTheme</span>=<span class=\"string\">\"@style/ThemeOverlay.AppCompat.Light\"</span></div><div class=\"line\">            <span class=\"attr\">app:theme</span>=<span class=\"string\">\"@style/ThemeOverlay.AppCompat.ActionBar\"</span></div><div class=\"line\">            <span class=\"attr\">app:title</span>=<span class=\"string\">\"\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.TabLayout</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/tab_layout\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">app:tabGravity</span>=<span class=\"string\">\"fill\"</span></div><div class=\"line\">            <span class=\"attr\">app:tabIndicatorColor</span>=<span class=\"string\">\"#ffffff\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">android.support.design.widget.AppBarLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.v4.view.ViewPager</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/view_pager\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">app:layout_behavior</span>=<span class=\"string\">\"@string/appbar_scrolling_view_behavior\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.FloatingActionButton</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/floating_button\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"bottom|end\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_margin</span>=<span class=\"string\">\"@dimen/fab_margin\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@android:drawable/ic_dialog_email\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">android.support.design.widget.CoordinatorLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>ViewPager对应的fragment布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">android.support.v4.widget.SwipeRefreshLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/swipe_refresh\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">app:layout_behavior</span>=<span class=\"string\">\"@string/appbar_scrolling_view_behavior\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.v7.widget.RecyclerView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/recycler_view\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">android.support.v4.widget.SwipeRefreshLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>RecyclerView对应的Adapter布局：<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?xml <span class=\"keyword\">version</span>=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span>?&gt;</div><div class=\"line\">&lt;android.support.v7.widget.CardView xmlns:android=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    xmlns:<span class=\"keyword\">app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">    android:layout_gravity=<span class=\"string\">\"center\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardCornerRadius=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardElevation=<span class=\"string\">\"5dp\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardMaxElevation=<span class=\"string\">\"10dp\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardPreventCornerOverlap=<span class=\"string\">\"true\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardUseCompatPadding=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;TextView</div><div class=\"line\">        android:id=<span class=\"string\">\"@+id/card_text\"</span></div><div class=\"line\">        android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"200dp\"</span></div><div class=\"line\">        android:layout_gravity=<span class=\"string\">\"center\"</span></div><div class=\"line\">        android:gravity=<span class=\"string\">\"center\"</span></div><div class=\"line\">        android:text=<span class=\"string\">\"1111\"</span></div><div class=\"line\">        android:textColor=<span class=\"string\">\"@android:color/black\"</span></div><div class=\"line\">        android:textSize=<span class=\"string\">\"30sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;/android.support.v7.widget.CardView&gt;</div></pre></td></tr></table></figure></p>\n<p>抽屉对应的HeaderView布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"220dp\"</span></div><div class=\"line\">    <span class=\"attr\">android:background</span>=<span class=\"string\">\"@drawable/ic_user_background\"</span></div><div class=\"line\">    <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/id_header_face\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"120dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"120dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"fitXY\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/user\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/id_header_authorname\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:text</span>=<span class=\"string\">\"@string/header_author_name\"</span></div><div class=\"line\">        <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@android:color/black\"</span></div><div class=\"line\">        <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"16sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/id_header_url\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:text</span>=<span class=\"string\">\"@string/header_author_url\"</span></div><div class=\"line\">        <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@android:color/black\"</span></div><div class=\"line\">        <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"18sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"相关说明\"><a href=\"#相关说明\" class=\"headerlink\" title=\"相关说明\"></a>相关说明</h2><ol>\n<li><p>使用NavigationView时，通过<code>layout_gravity=&quot;left&quot;</code>属性控制抽屉从左边打开。<br>抽屉内容填充对应于xml属性app:headerLayout与app:menu。</p>\n<figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 跳转到Menu的Toggle</span></div><div class=\"line\"><span class=\"type\">ActionBarDrawerToggle</span> mActionBarDrawerToggle = <span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">ActionBarDrawerToggle</span>(this, drawerLayout, toolbar, <span class=\"type\">R</span>.string.drawer_open, <span class=\"type\">R</span>.string.drawer_open);</span></div><div class=\"line\"><span class=\"title\">mActionBarDrawerToggle</span>.<span class=\"title\">syncState</span>();</div><div class=\"line\"><span class=\"title\">drawerLayout</span>.<span class=\"title\">setDrawerListener</span>(mActionBarDrawerToggle);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 抽屉菜单填充内容</span></div><div class=\"line\"><span class=\"title\">navigationView</span>.<span class=\"title\">inflateHeaderView</span>(<span class=\"type\">R</span>.layout.header_navigation);</div><div class=\"line\"><span class=\"title\">navigationView</span>.<span class=\"title\">inflateMenu</span>(<span class=\"type\">R</span>.menu.menu_navigation);</div></pre></td></tr></table></figure>\n</li>\n<li><p>TabLayout与ViewPager关联。</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">tabLayout</span><span class=\"selector-class\">.setTabMode</span>(<span class=\"selector-tag\">TabLayout</span><span class=\"selector-class\">.MODE_SCROLLABLE</span>);</div><div class=\"line\"><span class=\"selector-tag\">tabLayout</span><span class=\"selector-class\">.setupWithViewPager</span>(<span class=\"selector-tag\">viewPager</span>);</div><div class=\"line\"><span class=\"selector-tag\">tabLayout</span><span class=\"selector-class\">.setTabsFromPagerAdapter</span>(<span class=\"selector-tag\">myViewPagerAdapter</span>);</div></pre></td></tr></table></figure>\n</li>\n<li><p>SwipeRefreshLayout刷新设置颜色及刷新事件。</p>\n<figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">swipeRefreshLayout</span> = (SwipeRefreshLayout) view.findViewById(R.id.swipe_refresh)<span class=\"comment\">;</span></div><div class=\"line\">swipeRefreshLayout.setColorSchemeResources(R.color.colorPrimary)<span class=\"comment\">;</span></div><div class=\"line\">swipeRefreshLayout.setOnRefreshListener(this)<span class=\"comment\">;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>RecyclerView设置布局及Adapter。</p>\n<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">RecyclerView recyclerView = (RecyclerView) view.findViewById(R.id.recycler_view);</div><div class=\"line\">adapter = <span class=\"keyword\">new</span> <span class=\"type\">MyRecyclerViewAdapter</span>(getActivity());</div><div class=\"line\">RecyclerView.LayoutManager layoutManager = <span class=\"keyword\">new</span> <span class=\"type\">LinearLayoutManager</span>(getActivity(), LinearLayoutManager.VERTICAL, <span class=\"literal\">false</span>);</div><div class=\"line\">recyclerView.setAdapter(adapter);</div><div class=\"line\">recyclerView.setLayoutManager(layoutManager);</div></pre></td></tr></table></figure>\n</li>\n<li><p>CoordinatorLayout可滑动的条件。</p>\n<ul>\n<li>CoordinatorLayout必须作为整个布局的父布局容器。</li>\n<li>给需要滑动的组件设置 app:layout_scrollFlags=”scroll|enterAlways” 属性。 (ToolBar)</li>\n<li>给你的可滑动的组件，也就是RecyclerView、ViewPager或者 NestedScrollView 设置属性：<code>app:layout_behavior=@string/appbar_scrolling_view_behavior</code></li>\n</ul>\n</li>\n<li><p>设置的layout_scrollFlags有如下几种选项：</p>\n<ul>\n<li>scroll: 所有想滚动出屏幕的view都需要设置这个flag- 没有设置这个flag的view将被固定在屏幕顶部。</li>\n<li>enterAlways: 这个flag让任意向下的滚动都会导致该view变为可见，启用快速“返回模式”。</li>\n<li>enterAlwaysCollapsed: 当你的视图已经设置minHeight属性又使用此标志时，你的视图只能已最小高度进入，只有当滚动视图到达顶部时才扩大到完整高度。</li>\n<li>exitUntilCollapsed: 滚动退出屏幕，最后折叠在顶端。</li>\n</ul>\n</li>\n</ol>\n<p>在我的布局中给Toolbar设置了app:layout_scrollFlags属性，因此，Toolbar是可以滚动出屏幕，且向下滚动有可以出现。</p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>最终效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design9.png\" alt=\"这里写图片描述\"><br>源码地址：<a href=\"https://github.com/LiJia92/showlove\" target=\"_blank\" rel=\"external\">https://github.com/LiJia92/showlove</a></p>\n<p>Tips：本文只对这些新的特性做了最基本的说明及非常简单的使用，至于更加复杂的使用及效果，则需要在使用过程中慢慢发现、慢慢学习了。</p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>大年初十，相信许多人都已经过完年，在上班的路上或者已经上班了。在这里跟大家说一声：新年好~</p>\n<p>新年新气象，今天打算写一篇关于Android新特性：<code>Material Design</code>的文章。Material Design作为android 5.0的重头戏，说是新特性，但是其实已经算不上“新”了，毕竟android 6.0都出来了呢。</p>\n<p>情人节刚过，我便以“秀恩爱”为主题，做一个新特性的使用例子。废话少说，下面开撸。</p>\n<h2 id=\"添加依赖\"><a href=\"#添加依赖\" class=\"headerlink\" title=\"添加依赖\"></a>添加依赖</h2><p>使用新特性需要添加依赖：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.android.support:design:23.0.1'</span></div><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.android.support:cardview-v7:23.1.0'</span></div><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.android.support:recyclerview-v7:23.1.0'</span></div></pre></td></tr></table></figure></p>","more":"<h2 id=\"新组件介绍\"><a href=\"#新组件介绍\" class=\"headerlink\" title=\"新组件介绍\"></a>新组件介绍</h2><h3 id=\"AppBarlayout\"><a href=\"#AppBarlayout\" class=\"headerlink\" title=\"AppBarlayout\"></a>AppBarlayout</h3><p>AppBarLayout是继承LinearLayout实现的一个ViewGroup容器组件，它是为了Material Design设计的App Bar,支持手势滑动操作。默认的AppBarLayout是垂直方向的，它的作用是把AppBarLayout包裹的内容都作为AppBar。</p>\n<p>常用效果：将Toolbar 和Tablayout的组合部分共同构成 AppBar的效果。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design1.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"CoordinatorLayout\"><a href=\"#CoordinatorLayout\" class=\"headerlink\" title=\"CoordinatorLayout\"></a>CoordinatorLayout</h3><p>CoordinatorLayout是一个增强型的FrameLayout。它的作用有两个：</p>\n<ol>\n<li>作为一个布局的根布局</li>\n<li>最后一个为子视图之间相互协调手势效果的一个协调布局</li>\n</ol>\n<p>我们可以用过上滑将顶部的ToolBar移出屏幕，下滑时再显示。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design2.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"NavigationView\"><a href=\"#NavigationView\" class=\"headerlink\" title=\"NavigationView\"></a>NavigationView</h3><p>用于侧滑菜单中的menu布局。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design3.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"FloatingActionButton\"><a href=\"#FloatingActionButton\" class=\"headerlink\" title=\"FloatingActionButton\"></a>FloatingActionButton</h3><p>悬浮按钮，给人一种Z轴的空间感。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design4.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"SnackBar\"><a href=\"#SnackBar\" class=\"headerlink\" title=\"SnackBar\"></a>SnackBar</h3><p>当Snackbar在显示的时候，往往出现在屏幕的底部。为了给Snackbar留出空间，浮动操作按钮需要向上移动。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design5.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"CardView\"><a href=\"#CardView\" class=\"headerlink\" title=\"CardView\"></a>CardView</h3><p>CardView继承自FrameLayout类，可以在一个卡片布局中一致性的显示内容，卡片可以包含圆角和阴影。CardView是一个Layout，可以布局其他View。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design6.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"RecyclerView\"><a href=\"#RecyclerView\" class=\"headerlink\" title=\"RecyclerView\"></a>RecyclerView</h3><p>RecyclerView用于展示数据集，与ListView、GridView类似，但是它更灵活。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design7.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"SwipeRefreshLayout\"><a href=\"#SwipeRefreshLayout\" class=\"headerlink\" title=\"SwipeRefreshLayout\"></a>SwipeRefreshLayout</h3><p>Google官方推出的下拉刷新控件，使用非常简便。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design8.png\" alt=\"这里写图片描述\"></p>\n<h2 id=\"布局文件\"><a href=\"#布局文件\" class=\"headerlink\" title=\"布局文件\"></a>布局文件</h2><p>首先是activity_main布局文件：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">android.support.v4.widget.DrawerLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/drawer_layout\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">include</span> <span class=\"attr\">layout</span>=<span class=\"string\">\"@layout/content_main\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.NavigationView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/navigation\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"left\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">android.support.v4.widget.DrawerLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>看到content_main.xml：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.CoordinatorLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:fitsSystemWindows</span>=<span class=\"string\">\"true\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.AppBarLayout</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:theme</span>=<span class=\"string\">\"@style/AppTheme.AppBarOverlay\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">android.support.v7.widget.Toolbar</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/toolbar\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"?attr/actionBarSize\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"?attr/colorPrimary\"</span></div><div class=\"line\">            <span class=\"attr\">app:layout_scrollFlags</span>=<span class=\"string\">\"scroll|enterAlways\"</span></div><div class=\"line\">            <span class=\"attr\">app:popupTheme</span>=<span class=\"string\">\"@style/ThemeOverlay.AppCompat.Light\"</span></div><div class=\"line\">            <span class=\"attr\">app:theme</span>=<span class=\"string\">\"@style/ThemeOverlay.AppCompat.ActionBar\"</span></div><div class=\"line\">            <span class=\"attr\">app:title</span>=<span class=\"string\">\"\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.TabLayout</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/tab_layout\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">app:tabGravity</span>=<span class=\"string\">\"fill\"</span></div><div class=\"line\">            <span class=\"attr\">app:tabIndicatorColor</span>=<span class=\"string\">\"#ffffff\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">android.support.design.widget.AppBarLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.v4.view.ViewPager</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/view_pager\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">app:layout_behavior</span>=<span class=\"string\">\"@string/appbar_scrolling_view_behavior\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.design.widget.FloatingActionButton</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/floating_button\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"bottom|end\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_margin</span>=<span class=\"string\">\"@dimen/fab_margin\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@android:drawable/ic_dialog_email\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">android.support.design.widget.CoordinatorLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>ViewPager对应的fragment布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">android.support.v4.widget.SwipeRefreshLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/swipe_refresh\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">app:layout_behavior</span>=<span class=\"string\">\"@string/appbar_scrolling_view_behavior\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.v7.widget.RecyclerView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/recycler_view\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">android.support.v4.widget.SwipeRefreshLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>RecyclerView对应的Adapter布局：<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?xml <span class=\"keyword\">version</span>=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span>?&gt;</div><div class=\"line\">&lt;android.support.v7.widget.CardView xmlns:android=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    xmlns:<span class=\"keyword\">app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">    android:layout_gravity=<span class=\"string\">\"center\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardCornerRadius=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardElevation=<span class=\"string\">\"5dp\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardMaxElevation=<span class=\"string\">\"10dp\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardPreventCornerOverlap=<span class=\"string\">\"true\"</span></div><div class=\"line\">    <span class=\"keyword\">app</span>:cardUseCompatPadding=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;TextView</div><div class=\"line\">        android:id=<span class=\"string\">\"@+id/card_text\"</span></div><div class=\"line\">        android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"200dp\"</span></div><div class=\"line\">        android:layout_gravity=<span class=\"string\">\"center\"</span></div><div class=\"line\">        android:gravity=<span class=\"string\">\"center\"</span></div><div class=\"line\">        android:text=<span class=\"string\">\"1111\"</span></div><div class=\"line\">        android:textColor=<span class=\"string\">\"@android:color/black\"</span></div><div class=\"line\">        android:textSize=<span class=\"string\">\"30sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;/android.support.v7.widget.CardView&gt;</div></pre></td></tr></table></figure></p>\n<p>抽屉对应的HeaderView布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"220dp\"</span></div><div class=\"line\">    <span class=\"attr\">android:background</span>=<span class=\"string\">\"@drawable/ic_user_background\"</span></div><div class=\"line\">    <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/id_header_face\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"120dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"120dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"fitXY\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/user\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/id_header_authorname\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:text</span>=<span class=\"string\">\"@string/header_author_name\"</span></div><div class=\"line\">        <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@android:color/black\"</span></div><div class=\"line\">        <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"16sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/id_header_url\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:text</span>=<span class=\"string\">\"@string/header_author_url\"</span></div><div class=\"line\">        <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@android:color/black\"</span></div><div class=\"line\">        <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"18sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"相关说明\"><a href=\"#相关说明\" class=\"headerlink\" title=\"相关说明\"></a>相关说明</h2><ol>\n<li><p>使用NavigationView时，通过<code>layout_gravity=&quot;left&quot;</code>属性控制抽屉从左边打开。<br>抽屉内容填充对应于xml属性app:headerLayout与app:menu。</p>\n<figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 跳转到Menu的Toggle</span></div><div class=\"line\"><span class=\"type\">ActionBarDrawerToggle</span> mActionBarDrawerToggle = <span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">ActionBarDrawerToggle</span>(this, drawerLayout, toolbar, <span class=\"type\">R</span>.string.drawer_open, <span class=\"type\">R</span>.string.drawer_open);</div><div class=\"line\"><span class=\"title\">mActionBarDrawerToggle</span>.<span class=\"title\">syncState</span>();</div><div class=\"line\"><span class=\"title\">drawerLayout</span>.<span class=\"title\">setDrawerListener</span>(mActionBarDrawerToggle);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 抽屉菜单填充内容</span></div><div class=\"line\"><span class=\"title\">navigationView</span>.<span class=\"title\">inflateHeaderView</span>(<span class=\"type\">R</span>.layout.header_navigation);</div><div class=\"line\"><span class=\"title\">navigationView</span>.<span class=\"title\">inflateMenu</span>(<span class=\"type\">R</span>.menu.menu_navigation);</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>TabLayout与ViewPager关联。</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">tabLayout</span><span class=\"selector-class\">.setTabMode</span>(<span class=\"selector-tag\">TabLayout</span><span class=\"selector-class\">.MODE_SCROLLABLE</span>);</div><div class=\"line\"><span class=\"selector-tag\">tabLayout</span><span class=\"selector-class\">.setupWithViewPager</span>(<span class=\"selector-tag\">viewPager</span>);</div><div class=\"line\"><span class=\"selector-tag\">tabLayout</span><span class=\"selector-class\">.setTabsFromPagerAdapter</span>(<span class=\"selector-tag\">myViewPagerAdapter</span>);</div></pre></td></tr></table></figure>\n</li>\n<li><p>SwipeRefreshLayout刷新设置颜色及刷新事件。</p>\n<figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attribute\">swipeRefreshLayout</span> = (SwipeRefreshLayout) view.findViewById(R.id.swipe_refresh)<span class=\"comment\">;</span></div><div class=\"line\">swipeRefreshLayout.setColorSchemeResources(R.color.colorPrimary)<span class=\"comment\">;</span></div><div class=\"line\">swipeRefreshLayout.setOnRefreshListener(this)<span class=\"comment\">;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>RecyclerView设置布局及Adapter。</p>\n<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">RecyclerView recyclerView = (RecyclerView) view.findViewById(R.id.recycler_view);</div><div class=\"line\">adapter = <span class=\"keyword\">new</span> <span class=\"type\">MyRecyclerViewAdapter</span>(getActivity());</div><div class=\"line\">RecyclerView.LayoutManager layoutManager = <span class=\"keyword\">new</span> <span class=\"type\">LinearLayoutManager</span>(getActivity(), LinearLayoutManager.VERTICAL, <span class=\"literal\">false</span>);</div><div class=\"line\">recyclerView.setAdapter(adapter);</div><div class=\"line\">recyclerView.setLayoutManager(layoutManager);</div></pre></td></tr></table></figure>\n</li>\n<li><p>CoordinatorLayout可滑动的条件。</p>\n<ul>\n<li>CoordinatorLayout必须作为整个布局的父布局容器。</li>\n<li>给需要滑动的组件设置 app:layout_scrollFlags=”scroll|enterAlways” 属性。 (ToolBar)</li>\n<li>给你的可滑动的组件，也就是RecyclerView、ViewPager或者 NestedScrollView 设置属性：<code>app:layout_behavior=@string/appbar_scrolling_view_behavior</code></li>\n</ul>\n</li>\n<li><p>设置的layout_scrollFlags有如下几种选项：</p>\n<ul>\n<li>scroll: 所有想滚动出屏幕的view都需要设置这个flag- 没有设置这个flag的view将被固定在屏幕顶部。</li>\n<li>enterAlways: 这个flag让任意向下的滚动都会导致该view变为可见，启用快速“返回模式”。</li>\n<li>enterAlwaysCollapsed: 当你的视图已经设置minHeight属性又使用此标志时，你的视图只能已最小高度进入，只有当滚动视图到达顶部时才扩大到完整高度。</li>\n<li>exitUntilCollapsed: 滚动退出屏幕，最后折叠在顶端。</li>\n</ul>\n</li>\n</ol>\n<p>在我的布局中给Toolbar设置了app:layout_scrollFlags属性，因此，Toolbar是可以滚动出屏幕，且向下滚动有可以出现。</p>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>最终效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/material-design9.png\" alt=\"这里写图片描述\"><br>源码地址：<a href=\"https://github.com/LiJia92/showlove\">https://github.com/LiJia92/showlove</a></p>\n<p>Tips：本文只对这些新的特性做了最基本的说明及非常简单的使用，至于更加复杂的使用及效果，则需要在使用过程中慢慢发现、慢慢学习了。</p>"},{"title":"从谷歌官方TODO-MVP看MVP模式","date":"2016-06-27T07:47:01.000Z","_content":"\n## 前言\n很早之前就听说过android MVP的模式，也看过许许多多的文章，但是众说纷纭，每个人有每个人的理解，如果光看，可能并不能很深刻的理解。但是作为android界的权威，Google出了一个MVP的官方例子。若是从这个例子来看MVP模式，或许会有不一样的感悟呢？多说无益，下面开始。\n\n## 代码准备\nGithub上打开[googlesamples/android-architecture](https://github.com/googlesamples/android-architecture)，打开分支，选择``todo-mvp``（Basic Model-View-Presenter architecture），然后下载zip，解压后导入到AS中。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp3.png)\n\n<!-- more -->\n\n## 代码分析\n首先贴一张官方的MVP示意图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp1.png)\n在分析代码之前，我们先简单的运行一下App，大致有一个感觉，App里有哪些功能。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvpeffect.gif)\nok，下面进入到代码里，先上一下代码结构图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp2.png)\n可以看到分包是根据模块进行的分包，通过gif图大概可以知道分为添加（编辑）、统计、详情、主页List。\n本文只为了分析mvp的使用，所以我选取最简单的AddEditTask来进行分析。\n\n### M\nM主要是位于data包下面的类，Task是基本的bean，涉及到数据的相关操作由接口``TasksDataSource``体现。\n```\npublic interface TasksDataSource {\n\n    interface LoadTasksCallback {\n\n        void onTasksLoaded(List<Task> tasks);\n\n        void onDataNotAvailable();\n    }\n\n    interface GetTaskCallback {\n\n        void onTaskLoaded(Task task);\n\n        void onDataNotAvailable();\n    }\n\n    void getTasks(@NonNull LoadTasksCallback callback);\n\n    void getTask(@NonNull String taskId, @NonNull GetTaskCallback callback);\n\n    void saveTask(@NonNull Task task);\n\n    void completeTask(@NonNull Task task);\n\n    void completeTask(@NonNull String taskId);\n\n    void activateTask(@NonNull Task task);\n\n    void activateTask(@NonNull String taskId);\n\n    void clearCompletedTasks();\n\n    void refreshTasks();\n\n    void deleteAllTasks();\n\n    void deleteTask(@NonNull String taskId);\n}\n```\n### V\n首先是V的基类：\n```\npublic interface BaseView<T> {\n\n    void setPresenter(T presenter);\n\n}\n```\n然后看到``AddEditTaskContract``:\n```\npublic interface AddEditTaskContract {\n\n    interface View extends BaseView<Presenter> {\n\n        void showEmptyTaskError();\n\n        void showTasksList();\n\n        void setTitle(String title);\n\n        void setDescription(String description);\n\n        boolean isActive();\n    }\n\n    interface Presenter extends BasePresenter {\n\n        void saveTask(String title, String description);\n\n        void populateTask();\n    }\n}\n```\n这个类将V、P整合在了一起，这样做的好处是可以很方便的看到V、P都有哪些方法，方便后面修改。其中的``View``则是BaseView的下一层接口，它定义了View相关的一些方法。\n\n### P\nP的基类：\n```\npublic interface BasePresenter {\n\n    void start();\n\n}\n```\n然后在``AddEditTaskContract``中我们也可以看到P的具体声明。\n\n### MVP综合分析\nMVP大致的代码便是如此了，下面来看具体的实现。\n在``AddEditTaskActivity``的onCreate()方法中，我们重点看到这一句代码：\n```\nnew AddEditTaskPresenter(\n    taskId,\n    Injection.provideTasksRepository(getApplicationContext()),\n    addEditTaskFragment);\n```\n可以知道，这句代码便是创建具体的P了。\n来看下一下``AddEditTaskPresenter``的代码：\n```\n/**\n * Listens to user actions from the UI ({@link AddEditTaskFragment}), retrieves the data and updates\n * the UI as required.\n */\npublic class AddEditTaskPresenter implements AddEditTaskContract.Presenter,\n        TasksDataSource.GetTaskCallback {\n\n    @NonNull\n    private final TasksDataSource mTasksRepository;\n\n    @NonNull\n    private final AddEditTaskContract.View mAddTaskView;\n\n    @Nullable\n    private String mTaskId;\n\n    /**\n     * Creates a presenter for the add/edit view.\n     *\n     * @param taskId ID of the task to edit or null for a new task\n     * @param tasksRepository a repository of data for tasks\n     * @param addTaskView the add/edit view\n     */\n    public AddEditTaskPresenter(@Nullable String taskId, @NonNull TasksDataSource tasksRepository,\n            @NonNull AddEditTaskContract.View addTaskView) {\n        mTaskId = taskId;\n        mTasksRepository = checkNotNull(tasksRepository);\n        mAddTaskView = checkNotNull(addTaskView);\n\n        mAddTaskView.setPresenter(this);\n    }\n\n    @Override\n    public void start() {\n        if (!isNewTask()) {\n            populateTask();\n        }\n    }\n\n    @Override\n    public void saveTask(String title, String description) {\n        if (isNewTask()) {\n            createTask(title, description);\n        } else {\n            updateTask(title, description);\n        }\n    }\n\n    @Override\n    public void populateTask() {\n        if (isNewTask()) {\n            throw new RuntimeException(\"populateTask() was called but task is new.\");\n        }\n        mTasksRepository.getTask(mTaskId, this);\n    }\n\n    @Override\n    public void onTaskLoaded(Task task) {\n        // The view may not be able to handle UI updates anymore\n        if (mAddTaskView.isActive()) {\n            mAddTaskView.setTitle(task.getTitle());\n            mAddTaskView.setDescription(task.getDescription());\n        }\n    }\n\n    @Override\n    public void onDataNotAvailable() {\n        // The view may not be able to handle UI updates anymore\n        if (mAddTaskView.isActive()) {\n            mAddTaskView.showEmptyTaskError();\n        }\n    }\n\n    private boolean isNewTask() {\n        return mTaskId == null;\n    }\n\n    private void createTask(String title, String description) {\n        Task newTask = new Task(title, description);\n        if (newTask.isEmpty()) {\n            mAddTaskView.showEmptyTaskError();\n        } else {\n            mTasksRepository.saveTask(newTask);\n            mAddTaskView.showTasksList();\n        }\n    }\n\n    private void updateTask(String title, String description) {\n        if (isNewTask()) {\n            throw new RuntimeException(\"updateTask() was called but task is new.\");\n        }\n        mTasksRepository.saveTask(new Task(title, description, mTaskId));\n        mAddTaskView.showTasksList(); // After an edit, go back to the list.\n    }\n}\n```\n我们通过其构造函数，传入了一个addEditTaskFragment对象，通过其构造函数的方法，我们可以猜测：AddEditTaskFragment便是具体的V了。\n并且注意``mAddTaskView.setPresenter(this);``这句代码，即是在P创建的时候，V、P便实现了绑定。\n看到``AddEditTaskFragment``代码：\n```\npublic class AddEditTaskFragment extends Fragment implements AddEditTaskContract.View {\n\n    public static final String ARGUMENT_EDIT_TASK_ID = \"EDIT_TASK_ID\";\n\n    private AddEditTaskContract.Presenter mPresenter;\n\n    private TextView mTitle;\n\n    private TextView mDescription;\n\n    public static AddEditTaskFragment newInstance() {\n        return new AddEditTaskFragment();\n    }\n\n    public AddEditTaskFragment() {\n        // Required empty public constructor\n    }\n\n    @Override\n    public void onResume() {\n        super.onResume();\n        mPresenter.start();\n    }\n\n    @Override\n    public void setPresenter(@NonNull AddEditTaskContract.Presenter presenter) {\n        mPresenter = checkNotNull(presenter);\n    }\n\n    @Override\n    public void onActivityCreated(Bundle savedInstanceState) {\n        super.onActivityCreated(savedInstanceState);\n\n        FloatingActionButton fab =\n                (FloatingActionButton) getActivity().findViewById(R.id.fab_edit_task_done);\n        fab.setImageResource(R.drawable.ic_done);\n        fab.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                mPresenter.saveTask(mTitle.getText().toString(), mDescription.getText().toString());\n            }\n        });\n    }\n\n    @Nullable\n    @Override\n    public View onCreateView(LayoutInflater inflater, ViewGroup container,\n                             Bundle savedInstanceState) {\n        View root = inflater.inflate(R.layout.addtask_frag, container, false);\n        mTitle = (TextView) root.findViewById(R.id.add_task_title);\n        mDescription = (TextView) root.findViewById(R.id.add_task_description);\n\n        setHasOptionsMenu(true);\n        setRetainInstance(true);\n        return root;\n    }\n\n    @Override\n    public void showEmptyTaskError() {\n        Snackbar.make(mTitle, getString(R.string.empty_task_message), Snackbar.LENGTH_LONG).show();\n    }\n\n    @Override\n    public void showTasksList() {\n        getActivity().setResult(Activity.RESULT_OK);\n        getActivity().finish();\n    }\n\n    @Override\n    public void setTitle(String title) {\n        mTitle.setText(title);\n    }\n\n    @Override\n    public void setDescription(String description) {\n        mDescription.setText(description);\n    }\n\n    @Override\n    public boolean isActive() {\n        return isAdded();\n    }\n}\n```\n\n通过前面的gif图，可以猜测P中必定是有一个保存Task的方法，即``saveTask``方法，在我们点击悬浮按钮的时候会触发。即我们的操作（业务逻辑相关）会由P来执行。\n看到P中``saveTask``的具体实现，他会判断当前是否是一个新任务，若是则调用``createTask``创建新的Task，若标题与内容都为空，则会回调V的``showEmptyTaskError``方法来显示相关的UI，若不为空，则执行M的操作：``mTasksRepository.saveTask(newTask);``保存相应的数据，然后回调V的``showTasksList``方法来显示相关UI。若不是一个新的Task（编辑），则调用``updateTask``，执行M操作``mTasksRepository.saveTask``来操作数据。\n至此，一个完整的业务操作（新建或编辑一个新的Task）分析完毕。可以看到在V中，我们只调用P的相关的接口，然后实现上层V的接口就可以了。由P来调用M中的方法，来操作数据，然后通过回调来使V展示相应的界面。V与M完全分离，整套业务都由P来执行。\n最后上一张分析图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp5.png)\n\n## MVP的优缺点\n优点：\n1. 解耦。实现了Model和View真正的完全分离，再也不是Activity中一大坨代码了。\n2. 清晰。模块职责划分明显，层次清晰。\n3. 测试。在使用MVP的项目中Presenter对View是通过接口进行，在对Presenter进行不依赖UI环境的单元测试的时候。可以通过模拟一个View对象，这个对象只需要实现了View的接口即可。然后注入到Presenter中，单元测试的时候就可以完整的测试Presenter应用逻辑的正确性。\n4. 组件化。在MVP当中，View不依赖Model，这样就可以让View从特定的业务场景中脱离出来，可以说View可以做到对业务完全无知，它只需要提供一系列接口提供给上层操作，这样就可以做到高度可复用的View组件。\n\n缺点：\n1. 新增很多接口类，额外的代码复杂度及学习成本。\n2. Presenter中除了业务逻辑以外，可能还有大量的与业务无关的数据操作逻辑，会导致Presenter比较臃肿。\n\n## 测试\n在代码中，Google已经写好了测试代码：\n```\npublic class AddEditTaskPresenterTest {\n\n    @Mock\n    private TasksRepository mTasksRepository;\n\n    @Mock\n    private AddEditTaskContract.View mAddEditTaskView;\n\n    /**\n     * {@link ArgumentCaptor} is a powerful Mockito API to capture argument values and use them to\n     * perform further actions or assertions on them.\n     */\n    @Captor\n    private ArgumentCaptor<TasksDataSource.GetTaskCallback> mGetTaskCallbackCaptor;\n\n    private AddEditTaskPresenter mAddEditTaskPresenter;\n\n    @Before\n    public void setupMocksAndView() {\n        // Mockito has a very convenient way to inject mocks by using the @Mock annotation. To\n        // inject the mocks in the test the initMocks method needs to be called.\n        MockitoAnnotations.initMocks(this);\n\n        // The presenter wont't update the view unless it's active.\n        when(mAddEditTaskView.isActive()).thenReturn(true);\n    }\n\n    @Test\n    public void saveNewTaskToRepository_showsSuccessMessageUi() {\n        // Get a reference to the class under test\n        mAddEditTaskPresenter = new AddEditTaskPresenter(\"1\", mTasksRepository, mAddEditTaskView);\n\n        // When the presenter is asked to save a task\n        mAddEditTaskPresenter.saveTask(\"New Task Title\", \"Some Task Description\");\n\n        // Then a task is saved in the repository and the view updated\n        verify(mTasksRepository).saveTask(any(Task.class)); // saved to the model\n        verify(mAddEditTaskView).showTasksList(); // shown in the UI\n    }\n\n    @Test\n    public void saveTask_emptyTaskShowsErrorUi() {\n        // Get a reference to the class under test\n        mAddEditTaskPresenter = new AddEditTaskPresenter(null, mTasksRepository, mAddEditTaskView);\n\n        // When the presenter is asked to save an empty task\n        mAddEditTaskPresenter.saveTask(\"\", \"\");\n\n        // Then an empty not error is shown in the UI\n        verify(mAddEditTaskView).showEmptyTaskError();\n    }\n\n    @Test\n    public void saveExistingTaskToRepository_showsSuccessMessageUi() {\n        // Get a reference to the class under test\n        mAddEditTaskPresenter = new AddEditTaskPresenter(\"1\", mTasksRepository, mAddEditTaskView);\n\n        // When the presenter is asked to save an existing task\n        mAddEditTaskPresenter.saveTask(\"New Task Title\", \"Some Task Description\");\n\n        // Then a task is saved in the repository and the view updated\n        verify(mTasksRepository).saveTask(any(Task.class)); // saved to the model\n        verify(mAddEditTaskView).showTasksList(); // shown in the UI\n    }\n\n    @Test\n    public void populateTask_callsRepoAndUpdatesView() {\n        Task testTask = new Task(\"TITLE\", \"DESCRIPTION\");\n        // Get a reference to the class under test\n        mAddEditTaskPresenter = new AddEditTaskPresenter(testTask.getId(),\n                mTasksRepository, mAddEditTaskView);\n\n        // When the presenter is asked to populate an existing task\n        mAddEditTaskPresenter.populateTask();\n\n        // Then the task repository is queried and the view updated\n        verify(mTasksRepository).getTask(eq(testTask.getId()), mGetTaskCallbackCaptor.capture());\n\n        // Simulate callback\n        mGetTaskCallbackCaptor.getValue().onTaskLoaded(testTask);\n\n        verify(mAddEditTaskView).setTitle(testTask.getTitle());\n        verify(mAddEditTaskView).setDescription(testTask.getDescription());\n    }\n}\n```\n来执行一下吧：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp4.png)\n可以看到测试成功。\n那么假设我们采用传统的开发模式，代码全在Activity里，要怎么样测试呢？噢，想想就觉得头大了，是吗？\n\n## 总结\n通过此次Google官方例子的学习分析，让我对MVP模式有了更清晰的认识，并且我认为MVP模式的实用性很高。虽然它增加了额外的代码，但是它带来的好处是不言而喻的。在今后的开发中，我想我会尝试着使用它。\n","source":"_posts/mvp.md","raw":"---\ntitle: 从谷歌官方TODO-MVP看MVP模式\ndate: 2016-06-27 15:47:01\ntags:\n - 设计模式\n---\n\n## 前言\n很早之前就听说过android MVP的模式，也看过许许多多的文章，但是众说纷纭，每个人有每个人的理解，如果光看，可能并不能很深刻的理解。但是作为android界的权威，Google出了一个MVP的官方例子。若是从这个例子来看MVP模式，或许会有不一样的感悟呢？多说无益，下面开始。\n\n## 代码准备\nGithub上打开[googlesamples/android-architecture](https://github.com/googlesamples/android-architecture)，打开分支，选择``todo-mvp``（Basic Model-View-Presenter architecture），然后下载zip，解压后导入到AS中。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp3.png)\n\n<!-- more -->\n\n## 代码分析\n首先贴一张官方的MVP示意图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp1.png)\n在分析代码之前，我们先简单的运行一下App，大致有一个感觉，App里有哪些功能。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvpeffect.gif)\nok，下面进入到代码里，先上一下代码结构图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp2.png)\n可以看到分包是根据模块进行的分包，通过gif图大概可以知道分为添加（编辑）、统计、详情、主页List。\n本文只为了分析mvp的使用，所以我选取最简单的AddEditTask来进行分析。\n\n### M\nM主要是位于data包下面的类，Task是基本的bean，涉及到数据的相关操作由接口``TasksDataSource``体现。\n```\npublic interface TasksDataSource {\n\n    interface LoadTasksCallback {\n\n        void onTasksLoaded(List<Task> tasks);\n\n        void onDataNotAvailable();\n    }\n\n    interface GetTaskCallback {\n\n        void onTaskLoaded(Task task);\n\n        void onDataNotAvailable();\n    }\n\n    void getTasks(@NonNull LoadTasksCallback callback);\n\n    void getTask(@NonNull String taskId, @NonNull GetTaskCallback callback);\n\n    void saveTask(@NonNull Task task);\n\n    void completeTask(@NonNull Task task);\n\n    void completeTask(@NonNull String taskId);\n\n    void activateTask(@NonNull Task task);\n\n    void activateTask(@NonNull String taskId);\n\n    void clearCompletedTasks();\n\n    void refreshTasks();\n\n    void deleteAllTasks();\n\n    void deleteTask(@NonNull String taskId);\n}\n```\n### V\n首先是V的基类：\n```\npublic interface BaseView<T> {\n\n    void setPresenter(T presenter);\n\n}\n```\n然后看到``AddEditTaskContract``:\n```\npublic interface AddEditTaskContract {\n\n    interface View extends BaseView<Presenter> {\n\n        void showEmptyTaskError();\n\n        void showTasksList();\n\n        void setTitle(String title);\n\n        void setDescription(String description);\n\n        boolean isActive();\n    }\n\n    interface Presenter extends BasePresenter {\n\n        void saveTask(String title, String description);\n\n        void populateTask();\n    }\n}\n```\n这个类将V、P整合在了一起，这样做的好处是可以很方便的看到V、P都有哪些方法，方便后面修改。其中的``View``则是BaseView的下一层接口，它定义了View相关的一些方法。\n\n### P\nP的基类：\n```\npublic interface BasePresenter {\n\n    void start();\n\n}\n```\n然后在``AddEditTaskContract``中我们也可以看到P的具体声明。\n\n### MVP综合分析\nMVP大致的代码便是如此了，下面来看具体的实现。\n在``AddEditTaskActivity``的onCreate()方法中，我们重点看到这一句代码：\n```\nnew AddEditTaskPresenter(\n    taskId,\n    Injection.provideTasksRepository(getApplicationContext()),\n    addEditTaskFragment);\n```\n可以知道，这句代码便是创建具体的P了。\n来看下一下``AddEditTaskPresenter``的代码：\n```\n/**\n * Listens to user actions from the UI ({@link AddEditTaskFragment}), retrieves the data and updates\n * the UI as required.\n */\npublic class AddEditTaskPresenter implements AddEditTaskContract.Presenter,\n        TasksDataSource.GetTaskCallback {\n\n    @NonNull\n    private final TasksDataSource mTasksRepository;\n\n    @NonNull\n    private final AddEditTaskContract.View mAddTaskView;\n\n    @Nullable\n    private String mTaskId;\n\n    /**\n     * Creates a presenter for the add/edit view.\n     *\n     * @param taskId ID of the task to edit or null for a new task\n     * @param tasksRepository a repository of data for tasks\n     * @param addTaskView the add/edit view\n     */\n    public AddEditTaskPresenter(@Nullable String taskId, @NonNull TasksDataSource tasksRepository,\n            @NonNull AddEditTaskContract.View addTaskView) {\n        mTaskId = taskId;\n        mTasksRepository = checkNotNull(tasksRepository);\n        mAddTaskView = checkNotNull(addTaskView);\n\n        mAddTaskView.setPresenter(this);\n    }\n\n    @Override\n    public void start() {\n        if (!isNewTask()) {\n            populateTask();\n        }\n    }\n\n    @Override\n    public void saveTask(String title, String description) {\n        if (isNewTask()) {\n            createTask(title, description);\n        } else {\n            updateTask(title, description);\n        }\n    }\n\n    @Override\n    public void populateTask() {\n        if (isNewTask()) {\n            throw new RuntimeException(\"populateTask() was called but task is new.\");\n        }\n        mTasksRepository.getTask(mTaskId, this);\n    }\n\n    @Override\n    public void onTaskLoaded(Task task) {\n        // The view may not be able to handle UI updates anymore\n        if (mAddTaskView.isActive()) {\n            mAddTaskView.setTitle(task.getTitle());\n            mAddTaskView.setDescription(task.getDescription());\n        }\n    }\n\n    @Override\n    public void onDataNotAvailable() {\n        // The view may not be able to handle UI updates anymore\n        if (mAddTaskView.isActive()) {\n            mAddTaskView.showEmptyTaskError();\n        }\n    }\n\n    private boolean isNewTask() {\n        return mTaskId == null;\n    }\n\n    private void createTask(String title, String description) {\n        Task newTask = new Task(title, description);\n        if (newTask.isEmpty()) {\n            mAddTaskView.showEmptyTaskError();\n        } else {\n            mTasksRepository.saveTask(newTask);\n            mAddTaskView.showTasksList();\n        }\n    }\n\n    private void updateTask(String title, String description) {\n        if (isNewTask()) {\n            throw new RuntimeException(\"updateTask() was called but task is new.\");\n        }\n        mTasksRepository.saveTask(new Task(title, description, mTaskId));\n        mAddTaskView.showTasksList(); // After an edit, go back to the list.\n    }\n}\n```\n我们通过其构造函数，传入了一个addEditTaskFragment对象，通过其构造函数的方法，我们可以猜测：AddEditTaskFragment便是具体的V了。\n并且注意``mAddTaskView.setPresenter(this);``这句代码，即是在P创建的时候，V、P便实现了绑定。\n看到``AddEditTaskFragment``代码：\n```\npublic class AddEditTaskFragment extends Fragment implements AddEditTaskContract.View {\n\n    public static final String ARGUMENT_EDIT_TASK_ID = \"EDIT_TASK_ID\";\n\n    private AddEditTaskContract.Presenter mPresenter;\n\n    private TextView mTitle;\n\n    private TextView mDescription;\n\n    public static AddEditTaskFragment newInstance() {\n        return new AddEditTaskFragment();\n    }\n\n    public AddEditTaskFragment() {\n        // Required empty public constructor\n    }\n\n    @Override\n    public void onResume() {\n        super.onResume();\n        mPresenter.start();\n    }\n\n    @Override\n    public void setPresenter(@NonNull AddEditTaskContract.Presenter presenter) {\n        mPresenter = checkNotNull(presenter);\n    }\n\n    @Override\n    public void onActivityCreated(Bundle savedInstanceState) {\n        super.onActivityCreated(savedInstanceState);\n\n        FloatingActionButton fab =\n                (FloatingActionButton) getActivity().findViewById(R.id.fab_edit_task_done);\n        fab.setImageResource(R.drawable.ic_done);\n        fab.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                mPresenter.saveTask(mTitle.getText().toString(), mDescription.getText().toString());\n            }\n        });\n    }\n\n    @Nullable\n    @Override\n    public View onCreateView(LayoutInflater inflater, ViewGroup container,\n                             Bundle savedInstanceState) {\n        View root = inflater.inflate(R.layout.addtask_frag, container, false);\n        mTitle = (TextView) root.findViewById(R.id.add_task_title);\n        mDescription = (TextView) root.findViewById(R.id.add_task_description);\n\n        setHasOptionsMenu(true);\n        setRetainInstance(true);\n        return root;\n    }\n\n    @Override\n    public void showEmptyTaskError() {\n        Snackbar.make(mTitle, getString(R.string.empty_task_message), Snackbar.LENGTH_LONG).show();\n    }\n\n    @Override\n    public void showTasksList() {\n        getActivity().setResult(Activity.RESULT_OK);\n        getActivity().finish();\n    }\n\n    @Override\n    public void setTitle(String title) {\n        mTitle.setText(title);\n    }\n\n    @Override\n    public void setDescription(String description) {\n        mDescription.setText(description);\n    }\n\n    @Override\n    public boolean isActive() {\n        return isAdded();\n    }\n}\n```\n\n通过前面的gif图，可以猜测P中必定是有一个保存Task的方法，即``saveTask``方法，在我们点击悬浮按钮的时候会触发。即我们的操作（业务逻辑相关）会由P来执行。\n看到P中``saveTask``的具体实现，他会判断当前是否是一个新任务，若是则调用``createTask``创建新的Task，若标题与内容都为空，则会回调V的``showEmptyTaskError``方法来显示相关的UI，若不为空，则执行M的操作：``mTasksRepository.saveTask(newTask);``保存相应的数据，然后回调V的``showTasksList``方法来显示相关UI。若不是一个新的Task（编辑），则调用``updateTask``，执行M操作``mTasksRepository.saveTask``来操作数据。\n至此，一个完整的业务操作（新建或编辑一个新的Task）分析完毕。可以看到在V中，我们只调用P的相关的接口，然后实现上层V的接口就可以了。由P来调用M中的方法，来操作数据，然后通过回调来使V展示相应的界面。V与M完全分离，整套业务都由P来执行。\n最后上一张分析图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp5.png)\n\n## MVP的优缺点\n优点：\n1. 解耦。实现了Model和View真正的完全分离，再也不是Activity中一大坨代码了。\n2. 清晰。模块职责划分明显，层次清晰。\n3. 测试。在使用MVP的项目中Presenter对View是通过接口进行，在对Presenter进行不依赖UI环境的单元测试的时候。可以通过模拟一个View对象，这个对象只需要实现了View的接口即可。然后注入到Presenter中，单元测试的时候就可以完整的测试Presenter应用逻辑的正确性。\n4. 组件化。在MVP当中，View不依赖Model，这样就可以让View从特定的业务场景中脱离出来，可以说View可以做到对业务完全无知，它只需要提供一系列接口提供给上层操作，这样就可以做到高度可复用的View组件。\n\n缺点：\n1. 新增很多接口类，额外的代码复杂度及学习成本。\n2. Presenter中除了业务逻辑以外，可能还有大量的与业务无关的数据操作逻辑，会导致Presenter比较臃肿。\n\n## 测试\n在代码中，Google已经写好了测试代码：\n```\npublic class AddEditTaskPresenterTest {\n\n    @Mock\n    private TasksRepository mTasksRepository;\n\n    @Mock\n    private AddEditTaskContract.View mAddEditTaskView;\n\n    /**\n     * {@link ArgumentCaptor} is a powerful Mockito API to capture argument values and use them to\n     * perform further actions or assertions on them.\n     */\n    @Captor\n    private ArgumentCaptor<TasksDataSource.GetTaskCallback> mGetTaskCallbackCaptor;\n\n    private AddEditTaskPresenter mAddEditTaskPresenter;\n\n    @Before\n    public void setupMocksAndView() {\n        // Mockito has a very convenient way to inject mocks by using the @Mock annotation. To\n        // inject the mocks in the test the initMocks method needs to be called.\n        MockitoAnnotations.initMocks(this);\n\n        // The presenter wont't update the view unless it's active.\n        when(mAddEditTaskView.isActive()).thenReturn(true);\n    }\n\n    @Test\n    public void saveNewTaskToRepository_showsSuccessMessageUi() {\n        // Get a reference to the class under test\n        mAddEditTaskPresenter = new AddEditTaskPresenter(\"1\", mTasksRepository, mAddEditTaskView);\n\n        // When the presenter is asked to save a task\n        mAddEditTaskPresenter.saveTask(\"New Task Title\", \"Some Task Description\");\n\n        // Then a task is saved in the repository and the view updated\n        verify(mTasksRepository).saveTask(any(Task.class)); // saved to the model\n        verify(mAddEditTaskView).showTasksList(); // shown in the UI\n    }\n\n    @Test\n    public void saveTask_emptyTaskShowsErrorUi() {\n        // Get a reference to the class under test\n        mAddEditTaskPresenter = new AddEditTaskPresenter(null, mTasksRepository, mAddEditTaskView);\n\n        // When the presenter is asked to save an empty task\n        mAddEditTaskPresenter.saveTask(\"\", \"\");\n\n        // Then an empty not error is shown in the UI\n        verify(mAddEditTaskView).showEmptyTaskError();\n    }\n\n    @Test\n    public void saveExistingTaskToRepository_showsSuccessMessageUi() {\n        // Get a reference to the class under test\n        mAddEditTaskPresenter = new AddEditTaskPresenter(\"1\", mTasksRepository, mAddEditTaskView);\n\n        // When the presenter is asked to save an existing task\n        mAddEditTaskPresenter.saveTask(\"New Task Title\", \"Some Task Description\");\n\n        // Then a task is saved in the repository and the view updated\n        verify(mTasksRepository).saveTask(any(Task.class)); // saved to the model\n        verify(mAddEditTaskView).showTasksList(); // shown in the UI\n    }\n\n    @Test\n    public void populateTask_callsRepoAndUpdatesView() {\n        Task testTask = new Task(\"TITLE\", \"DESCRIPTION\");\n        // Get a reference to the class under test\n        mAddEditTaskPresenter = new AddEditTaskPresenter(testTask.getId(),\n                mTasksRepository, mAddEditTaskView);\n\n        // When the presenter is asked to populate an existing task\n        mAddEditTaskPresenter.populateTask();\n\n        // Then the task repository is queried and the view updated\n        verify(mTasksRepository).getTask(eq(testTask.getId()), mGetTaskCallbackCaptor.capture());\n\n        // Simulate callback\n        mGetTaskCallbackCaptor.getValue().onTaskLoaded(testTask);\n\n        verify(mAddEditTaskView).setTitle(testTask.getTitle());\n        verify(mAddEditTaskView).setDescription(testTask.getDescription());\n    }\n}\n```\n来执行一下吧：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp4.png)\n可以看到测试成功。\n那么假设我们采用传统的开发模式，代码全在Activity里，要怎么样测试呢？噢，想想就觉得头大了，是吗？\n\n## 总结\n通过此次Google官方例子的学习分析，让我对MVP模式有了更清晰的认识，并且我认为MVP模式的实用性很高。虽然它增加了额外的代码，但是它带来的好处是不言而喻的。在今后的开发中，我想我会尝试着使用它。\n","slug":"mvp","published":1,"updated":"2016-11-21T10:01:59.894Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759n00211cb8bp9jjyl9","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>很早之前就听说过android MVP的模式，也看过许许多多的文章，但是众说纷纭，每个人有每个人的理解，如果光看，可能并不能很深刻的理解。但是作为android界的权威，Google出了一个MVP的官方例子。若是从这个例子来看MVP模式，或许会有不一样的感悟呢？多说无益，下面开始。</p>\n<h2 id=\"代码准备\"><a href=\"#代码准备\" class=\"headerlink\" title=\"代码准备\"></a>代码准备</h2><p>Github上打开<a href=\"https://github.com/googlesamples/android-architecture\" target=\"_blank\" rel=\"external\">googlesamples/android-architecture</a>，打开分支，选择<code>todo-mvp</code>（Basic Model-View-Presenter architecture），然后下载zip，解压后导入到AS中。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp3.png\" alt=\"\"></p>\n<a id=\"more\"></a>\n<h2 id=\"代码分析\"><a href=\"#代码分析\" class=\"headerlink\" title=\"代码分析\"></a>代码分析</h2><p>首先贴一张官方的MVP示意图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp1.png\" alt=\"\"><br>在分析代码之前，我们先简单的运行一下App，大致有一个感觉，App里有哪些功能。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvpeffect.gif\" alt=\"\"><br>ok，下面进入到代码里，先上一下代码结构图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp2.png\" alt=\"\"><br>可以看到分包是根据模块进行的分包，通过gif图大概可以知道分为添加（编辑）、统计、详情、主页List。<br>本文只为了分析mvp的使用，所以我选取最简单的AddEditTask来进行分析。</p>\n<h3 id=\"M\"><a href=\"#M\" class=\"headerlink\" title=\"M\"></a>M</h3><p>M主要是位于data包下面的类，Task是基本的bean，涉及到数据的相关操作由接口<code>TasksDataSource</code>体现。<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">public</span> <span class=\"selector-tag\">interface</span> <span class=\"selector-tag\">TasksDataSource</span> &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">interface</span> <span class=\"selector-tag\">LoadTasksCallback</span> &#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">onTasksLoaded</span>(List&lt;Task&gt; tasks);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">onDataNotAvailable</span>();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">interface</span> <span class=\"selector-tag\">GetTaskCallback</span> &#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">onTaskLoaded</span>(Task task);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">onDataNotAvailable</span>();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">getTasks</span>(<span class=\"variable\">@NonNull</span> LoadTasksCallback callback);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">getTask</span>(<span class=\"variable\">@NonNull</span> String taskId, <span class=\"variable\">@NonNull</span> GetTaskCallback callback);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">saveTask</span>(<span class=\"variable\">@NonNull</span> Task task);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">completeTask</span>(<span class=\"variable\">@NonNull</span> Task task);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">completeTask</span>(<span class=\"variable\">@NonNull</span> String taskId);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">activateTask</span>(<span class=\"variable\">@NonNull</span> Task task);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">activateTask</span>(<span class=\"variable\">@NonNull</span> String taskId);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">clearCompletedTasks</span>();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">refreshTasks</span>();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">deleteAllTasks</span>();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">deleteTask</span>(<span class=\"variable\">@NonNull</span> String taskId);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h3 id=\"V\"><a href=\"#V\" class=\"headerlink\" title=\"V\"></a>V</h3><p>首先是V的基类：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">BaseView</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setPresenter</span><span class=\"params\">(T presenter)</span></span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后看到<code>AddEditTaskContract</code>:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">AddEditTaskContract</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">View</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseView</span>&lt;<span class=\"title\">Presenter</span>&gt; </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showEmptyTaskError</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showTasksList</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setTitle</span><span class=\"params\">(String title)</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setDescription</span><span class=\"params\">(String description)</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isActive</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Presenter</span> <span class=\"keyword\">extends</span> <span class=\"title\">BasePresenter</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">saveTask</span><span class=\"params\">(String title, String description)</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">populateTask</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这个类将V、P整合在了一起，这样做的好处是可以很方便的看到V、P都有哪些方法，方便后面修改。其中的<code>View</code>则是BaseView的下一层接口，它定义了View相关的一些方法。</p>\n<h3 id=\"P\"><a href=\"#P\" class=\"headerlink\" title=\"P\"></a>P</h3><p>P的基类：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">BasePresenter</span> &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">start</span>(<span class=\"params\"></span>)</span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后在<code>AddEditTaskContract</code>中我们也可以看到P的具体声明。</p>\n<h3 id=\"MVP综合分析\"><a href=\"#MVP综合分析\" class=\"headerlink\" title=\"MVP综合分析\"></a>MVP综合分析</h3><p>MVP大致的代码便是如此了，下面来看具体的实现。<br>在<code>AddEditTaskActivity</code>的onCreate()方法中，我们重点看到这一句代码：<br><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">new AddEditTaskPresenter(</div><div class=\"line\">    <span class=\"name\">taskId</span>,</div><div class=\"line\">    Injection.provideTasksRepository(<span class=\"name\">getApplicationContext</span>()),</div><div class=\"line\">    addEditTaskFragment)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>可以知道，这句代码便是创建具体的P了。<br>来看下一下<code>AddEditTaskPresenter</code>的代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * Listens to user actions from the UI (&#123;<span class=\"doctag\">@link</span> AddEditTaskFragment&#125;), retrieves the data and updates</div><div class=\"line\"> * the UI as required.</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AddEditTaskPresenter</span> <span class=\"keyword\">implements</span> <span class=\"title\">AddEditTaskContract</span>.<span class=\"title\">Presenter</span>,</span></div><div class=\"line\">        <span class=\"title\">TasksDataSource</span>.<span class=\"title\">GetTaskCallback</span> &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@NonNull</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TasksDataSource mTasksRepository;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@NonNull</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AddEditTaskContract.View mAddTaskView;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Nullable</span></div><div class=\"line\">    <span class=\"keyword\">private</span> String mTaskId;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * Creates a presenter for the add/edit view.</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> taskId ID of the task to edit or null for a new task</div><div class=\"line\">     * <span class=\"doctag\">@param</span> tasksRepository a repository of data for tasks</div><div class=\"line\">     * <span class=\"doctag\">@param</span> addTaskView the add/edit view</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AddEditTaskPresenter</span><span class=\"params\">(@Nullable String taskId, @NonNull TasksDataSource tasksRepository,</span></span></div><div class=\"line\">            @NonNull AddEditTaskContract.View addTaskView) &#123;</div><div class=\"line\">        mTaskId = taskId;</div><div class=\"line\">        mTasksRepository = checkNotNull(tasksRepository);</div><div class=\"line\">        mAddTaskView = checkNotNull(addTaskView);</div><div class=\"line\"></div><div class=\"line\">        mAddTaskView.setPresenter(<span class=\"keyword\">this</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (!isNewTask()) &#123;</div><div class=\"line\">            populateTask();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveTask</span><span class=\"params\">(String title, String description)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isNewTask()) &#123;</div><div class=\"line\">            createTask(title, description);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            updateTask(title, description);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">populateTask</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isNewTask()) &#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">\"populateTask() was called but task is new.\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        mTasksRepository.getTask(mTaskId, <span class=\"keyword\">this</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onTaskLoaded</span><span class=\"params\">(Task task)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// The view may not be able to handle UI updates anymore</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (mAddTaskView.isActive()) &#123;</div><div class=\"line\">            mAddTaskView.setTitle(task.getTitle());</div><div class=\"line\">            mAddTaskView.setDescription(task.getDescription());</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDataNotAvailable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// The view may not be able to handle UI updates anymore</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (mAddTaskView.isActive()) &#123;</div><div class=\"line\">            mAddTaskView.showEmptyTaskError();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isNewTask</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> mTaskId == <span class=\"keyword\">null</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">createTask</span><span class=\"params\">(String title, String description)</span> </span>&#123;</div><div class=\"line\">        Task newTask = <span class=\"keyword\">new</span> Task(title, description);</div><div class=\"line\">        <span class=\"keyword\">if</span> (newTask.isEmpty()) &#123;</div><div class=\"line\">            mAddTaskView.showEmptyTaskError();</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            mTasksRepository.saveTask(newTask);</div><div class=\"line\">            mAddTaskView.showTasksList();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">updateTask</span><span class=\"params\">(String title, String description)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isNewTask()) &#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">\"updateTask() was called but task is new.\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        mTasksRepository.saveTask(<span class=\"keyword\">new</span> Task(title, description, mTaskId));</div><div class=\"line\">        mAddTaskView.showTasksList(); <span class=\"comment\">// After an edit, go back to the list.</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>我们通过其构造函数，传入了一个addEditTaskFragment对象，通过其构造函数的方法，我们可以猜测：AddEditTaskFragment便是具体的V了。<br>并且注意<code>mAddTaskView.setPresenter(this);</code>这句代码，即是在P创建的时候，V、P便实现了绑定。<br>看到<code>AddEditTaskFragment</code>代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AddEditTaskFragment</span> <span class=\"keyword\">extends</span> <span class=\"title\">Fragment</span> <span class=\"keyword\">implements</span> <span class=\"title\">AddEditTaskContract</span>.<span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ARGUMENT_EDIT_TASK_ID = <span class=\"string\">\"EDIT_TASK_ID\"</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> AddEditTaskContract.Presenter mPresenter;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> TextView mTitle;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> TextView mDescription;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\">AddEditTaskFragment <span class=\"title\">newInstance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AddEditTaskFragment();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AddEditTaskFragment</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Required empty public constructor</span></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onResume</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onResume();</div><div class=\"line\">        mPresenter.start();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setPresenter</span><span class=\"params\">(@NonNull AddEditTaskContract.Presenter presenter)</span> </span>&#123;</div><div class=\"line\">        mPresenter = checkNotNull(presenter);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onActivityCreated</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onActivityCreated(savedInstanceState);</div><div class=\"line\"></div><div class=\"line\">        FloatingActionButton fab =</div><div class=\"line\">                (FloatingActionButton) getActivity().findViewById(R.id.fab_edit_task_done);</div><div class=\"line\">        fab.setImageResource(R.drawable.ic_done);</div><div class=\"line\">        fab.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                mPresenter.saveTask(mTitle.getText().toString(), mDescription.getText().toString());</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Nullable</span></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\">View <span class=\"title\">onCreateView</span><span class=\"params\">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class=\"line\">                             Bundle savedInstanceState) &#123;</div><div class=\"line\">        View root = inflater.inflate(R.layout.addtask_frag, container, <span class=\"keyword\">false</span>);</div><div class=\"line\">        mTitle = (TextView) root.findViewById(R.id.add_task_title);</div><div class=\"line\">        mDescription = (TextView) root.findViewById(R.id.add_task_description);</div><div class=\"line\"></div><div class=\"line\">        setHasOptionsMenu(<span class=\"keyword\">true</span>);</div><div class=\"line\">        setRetainInstance(<span class=\"keyword\">true</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> root;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showEmptyTaskError</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        Snackbar.make(mTitle, getString(R.string.empty_task_message), Snackbar.LENGTH_LONG).show();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showTasksList</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        getActivity().setResult(Activity.RESULT_OK);</div><div class=\"line\">        getActivity().finish();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setTitle</span><span class=\"params\">(String title)</span> </span>&#123;</div><div class=\"line\">        mTitle.setText(title);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setDescription</span><span class=\"params\">(String description)</span> </span>&#123;</div><div class=\"line\">        mDescription.setText(description);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isActive</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"title\">isAdded</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过前面的gif图，可以猜测P中必定是有一个保存Task的方法，即<code>saveTask</code>方法，在我们点击悬浮按钮的时候会触发。即我们的操作（业务逻辑相关）会由P来执行。<br>看到P中<code>saveTask</code>的具体实现，他会判断当前是否是一个新任务，若是则调用<code>createTask</code>创建新的Task，若标题与内容都为空，则会回调V的<code>showEmptyTaskError</code>方法来显示相关的UI，若不为空，则执行M的操作：<code>mTasksRepository.saveTask(newTask);</code>保存相应的数据，然后回调V的<code>showTasksList</code>方法来显示相关UI。若不是一个新的Task（编辑），则调用<code>updateTask</code>，执行M操作<code>mTasksRepository.saveTask</code>来操作数据。<br>至此，一个完整的业务操作（新建或编辑一个新的Task）分析完毕。可以看到在V中，我们只调用P的相关的接口，然后实现上层V的接口就可以了。由P来调用M中的方法，来操作数据，然后通过回调来使V展示相应的界面。V与M完全分离，整套业务都由P来执行。<br>最后上一张分析图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp5.png\" alt=\"\"></p>\n<h2 id=\"MVP的优缺点\"><a href=\"#MVP的优缺点\" class=\"headerlink\" title=\"MVP的优缺点\"></a>MVP的优缺点</h2><p>优点：</p>\n<ol>\n<li>解耦。实现了Model和View真正的完全分离，再也不是Activity中一大坨代码了。</li>\n<li>清晰。模块职责划分明显，层次清晰。</li>\n<li>测试。在使用MVP的项目中Presenter对View是通过接口进行，在对Presenter进行不依赖UI环境的单元测试的时候。可以通过模拟一个View对象，这个对象只需要实现了View的接口即可。然后注入到Presenter中，单元测试的时候就可以完整的测试Presenter应用逻辑的正确性。</li>\n<li>组件化。在MVP当中，View不依赖Model，这样就可以让View从特定的业务场景中脱离出来，可以说View可以做到对业务完全无知，它只需要提供一系列接口提供给上层操作，这样就可以做到高度可复用的View组件。</li>\n</ol>\n<p>缺点：</p>\n<ol>\n<li>新增很多接口类，额外的代码复杂度及学习成本。</li>\n<li>Presenter中除了业务逻辑以外，可能还有大量的与业务无关的数据操作逻辑，会导致Presenter比较臃肿。</li>\n</ol>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>在代码中，Google已经写好了测试代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AddEditTaskPresenterTest</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Mock</span></div><div class=\"line\">    <span class=\"keyword\">private</span> TasksRepository mTasksRepository;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Mock</span></div><div class=\"line\">    <span class=\"keyword\">private</span> AddEditTaskContract.View mAddEditTaskView;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * &#123;<span class=\"doctag\">@link</span> ArgumentCaptor&#125; is a powerful Mockito API to capture argument values and use them to</div><div class=\"line\">     * perform further actions or assertions on them.</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"meta\">@Captor</span></div><div class=\"line\">    <span class=\"keyword\">private</span> ArgumentCaptor&lt;TasksDataSource.GetTaskCallback&gt; mGetTaskCallbackCaptor;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> AddEditTaskPresenter mAddEditTaskPresenter;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Before</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setupMocksAndView</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Mockito has a very convenient way to inject mocks by using the @Mock annotation. To</span></div><div class=\"line\">        <span class=\"comment\">// inject the mocks in the test the initMocks method needs to be called.</span></div><div class=\"line\">        MockitoAnnotations.initMocks(<span class=\"keyword\">this</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// The presenter wont't update the view unless it's active.</span></div><div class=\"line\">        when(mAddEditTaskView.isActive()).thenReturn(<span class=\"keyword\">true</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Test</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveNewTaskToRepository_showsSuccessMessageUi</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Get a reference to the class under test</span></div><div class=\"line\">        mAddEditTaskPresenter = <span class=\"keyword\">new</span> AddEditTaskPresenter(<span class=\"string\">\"1\"</span>, mTasksRepository, mAddEditTaskView);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// When the presenter is asked to save a task</span></div><div class=\"line\">        mAddEditTaskPresenter.saveTask(<span class=\"string\">\"New Task Title\"</span>, <span class=\"string\">\"Some Task Description\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Then a task is saved in the repository and the view updated</span></div><div class=\"line\">        verify(mTasksRepository).saveTask(any(Task.class)); <span class=\"comment\">// saved to the model</span></div><div class=\"line\">        verify(mAddEditTaskView).showTasksList(); <span class=\"comment\">// shown in the UI</span></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Test</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveTask_emptyTaskShowsErrorUi</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Get a reference to the class under test</span></div><div class=\"line\">        mAddEditTaskPresenter = <span class=\"keyword\">new</span> AddEditTaskPresenter(<span class=\"keyword\">null</span>, mTasksRepository, mAddEditTaskView);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// When the presenter is asked to save an empty task</span></div><div class=\"line\">        mAddEditTaskPresenter.saveTask(<span class=\"string\">\"\"</span>, <span class=\"string\">\"\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Then an empty not error is shown in the UI</span></div><div class=\"line\">        verify(mAddEditTaskView).showEmptyTaskError();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Test</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveExistingTaskToRepository_showsSuccessMessageUi</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Get a reference to the class under test</span></div><div class=\"line\">        mAddEditTaskPresenter = <span class=\"keyword\">new</span> AddEditTaskPresenter(<span class=\"string\">\"1\"</span>, mTasksRepository, mAddEditTaskView);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// When the presenter is asked to save an existing task</span></div><div class=\"line\">        mAddEditTaskPresenter.saveTask(<span class=\"string\">\"New Task Title\"</span>, <span class=\"string\">\"Some Task Description\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Then a task is saved in the repository and the view updated</span></div><div class=\"line\">        verify(mTasksRepository).saveTask(any(Task.class)); <span class=\"comment\">// saved to the model</span></div><div class=\"line\">        verify(mAddEditTaskView).showTasksList(); <span class=\"comment\">// shown in the UI</span></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Test</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">populateTask_callsRepoAndUpdatesView</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        Task testTask = <span class=\"keyword\">new</span> Task(<span class=\"string\">\"TITLE\"</span>, <span class=\"string\">\"DESCRIPTION\"</span>);</div><div class=\"line\">        <span class=\"comment\">// Get a reference to the class under test</span></div><div class=\"line\">        mAddEditTaskPresenter = <span class=\"keyword\">new</span> AddEditTaskPresenter(testTask.getId(),</div><div class=\"line\">                mTasksRepository, mAddEditTaskView);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// When the presenter is asked to populate an existing task</span></div><div class=\"line\">        mAddEditTaskPresenter.populateTask();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Then the task repository is queried and the view updated</span></div><div class=\"line\">        verify(mTasksRepository).getTask(eq(testTask.getId()), mGetTaskCallbackCaptor.capture());</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Simulate callback</span></div><div class=\"line\">        mGetTaskCallbackCaptor.getValue().onTaskLoaded(testTask);</div><div class=\"line\"></div><div class=\"line\">        verify(mAddEditTaskView).setTitle(testTask.getTitle());</div><div class=\"line\">        verify(mAddEditTaskView).setDescription(testTask.getDescription());</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>来执行一下吧：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp4.png\" alt=\"\"><br>可以看到测试成功。<br>那么假设我们采用传统的开发模式，代码全在Activity里，要怎么样测试呢？噢，想想就觉得头大了，是吗？</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过此次Google官方例子的学习分析，让我对MVP模式有了更清晰的认识，并且我认为MVP模式的实用性很高。虽然它增加了额外的代码，但是它带来的好处是不言而喻的。在今后的开发中，我想我会尝试着使用它。</p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>很早之前就听说过android MVP的模式，也看过许许多多的文章，但是众说纷纭，每个人有每个人的理解，如果光看，可能并不能很深刻的理解。但是作为android界的权威，Google出了一个MVP的官方例子。若是从这个例子来看MVP模式，或许会有不一样的感悟呢？多说无益，下面开始。</p>\n<h2 id=\"代码准备\"><a href=\"#代码准备\" class=\"headerlink\" title=\"代码准备\"></a>代码准备</h2><p>Github上打开<a href=\"https://github.com/googlesamples/android-architecture\">googlesamples/android-architecture</a>，打开分支，选择<code>todo-mvp</code>（Basic Model-View-Presenter architecture），然后下载zip，解压后导入到AS中。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp3.png\" alt=\"\"></p>","more":"<h2 id=\"代码分析\"><a href=\"#代码分析\" class=\"headerlink\" title=\"代码分析\"></a>代码分析</h2><p>首先贴一张官方的MVP示意图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp1.png\" alt=\"\"><br>在分析代码之前，我们先简单的运行一下App，大致有一个感觉，App里有哪些功能。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvpeffect.gif\" alt=\"\"><br>ok，下面进入到代码里，先上一下代码结构图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp2.png\" alt=\"\"><br>可以看到分包是根据模块进行的分包，通过gif图大概可以知道分为添加（编辑）、统计、详情、主页List。<br>本文只为了分析mvp的使用，所以我选取最简单的AddEditTask来进行分析。</p>\n<h3 id=\"M\"><a href=\"#M\" class=\"headerlink\" title=\"M\"></a>M</h3><p>M主要是位于data包下面的类，Task是基本的bean，涉及到数据的相关操作由接口<code>TasksDataSource</code>体现。<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">public</span> <span class=\"selector-tag\">interface</span> <span class=\"selector-tag\">TasksDataSource</span> &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">interface</span> <span class=\"selector-tag\">LoadTasksCallback</span> &#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">onTasksLoaded</span>(List&lt;Task&gt; tasks);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">onDataNotAvailable</span>();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">interface</span> <span class=\"selector-tag\">GetTaskCallback</span> &#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">onTaskLoaded</span>(Task task);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">onDataNotAvailable</span>();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">getTasks</span>(<span class=\"variable\">@NonNull</span> LoadTasksCallback callback);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">getTask</span>(<span class=\"variable\">@NonNull</span> String taskId, <span class=\"variable\">@NonNull</span> GetTaskCallback callback);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">saveTask</span>(<span class=\"variable\">@NonNull</span> Task task);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">completeTask</span>(<span class=\"variable\">@NonNull</span> Task task);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">completeTask</span>(<span class=\"variable\">@NonNull</span> String taskId);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">activateTask</span>(<span class=\"variable\">@NonNull</span> Task task);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">activateTask</span>(<span class=\"variable\">@NonNull</span> String taskId);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">clearCompletedTasks</span>();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">refreshTasks</span>();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">deleteAllTasks</span>();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"selector-tag\">void</span> <span class=\"selector-tag\">deleteTask</span>(<span class=\"variable\">@NonNull</span> String taskId);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h3 id=\"V\"><a href=\"#V\" class=\"headerlink\" title=\"V\"></a>V</h3><p>首先是V的基类：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">BaseView</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setPresenter</span><span class=\"params\">(T presenter)</span></span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后看到<code>AddEditTaskContract</code>:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">AddEditTaskContract</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">View</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseView</span>&lt;<span class=\"title\">Presenter</span>&gt; </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showEmptyTaskError</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showTasksList</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setTitle</span><span class=\"params\">(String title)</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setDescription</span><span class=\"params\">(String description)</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isActive</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Presenter</span> <span class=\"keyword\">extends</span> <span class=\"title\">BasePresenter</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">saveTask</span><span class=\"params\">(String title, String description)</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">populateTask</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>这个类将V、P整合在了一起，这样做的好处是可以很方便的看到V、P都有哪些方法，方便后面修改。其中的<code>View</code>则是BaseView的下一层接口，它定义了View相关的一些方法。</p>\n<h3 id=\"P\"><a href=\"#P\" class=\"headerlink\" title=\"P\"></a>P</h3><p>P的基类：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">BasePresenter</span> &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">start</span>(<span class=\"params\"></span>)</span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后在<code>AddEditTaskContract</code>中我们也可以看到P的具体声明。</p>\n<h3 id=\"MVP综合分析\"><a href=\"#MVP综合分析\" class=\"headerlink\" title=\"MVP综合分析\"></a>MVP综合分析</h3><p>MVP大致的代码便是如此了，下面来看具体的实现。<br>在<code>AddEditTaskActivity</code>的onCreate()方法中，我们重点看到这一句代码：<br><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">new AddEditTaskPresenter(</div><div class=\"line\">    <span class=\"name\">taskId</span>,</div><div class=\"line\">    Injection.provideTasksRepository(<span class=\"name\">getApplicationContext</span>()),</div><div class=\"line\">    addEditTaskFragment)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>可以知道，这句代码便是创建具体的P了。<br>来看下一下<code>AddEditTaskPresenter</code>的代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * Listens to user actions from the UI (&#123;<span class=\"doctag\">@link</span> AddEditTaskFragment&#125;), retrieves the data and updates</div><div class=\"line\"> * the UI as required.</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AddEditTaskPresenter</span> <span class=\"keyword\">implements</span> <span class=\"title\">AddEditTaskContract</span>.<span class=\"title\">Presenter</span>,</div><div class=\"line\">        <span class=\"title\">TasksDataSource</span>.<span class=\"title\">GetTaskCallback</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@NonNull</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TasksDataSource mTasksRepository;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@NonNull</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AddEditTaskContract.View mAddTaskView;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Nullable</span></div><div class=\"line\">    <span class=\"keyword\">private</span> String mTaskId;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * Creates a presenter for the add/edit view.</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> taskId ID of the task to edit or null for a new task</div><div class=\"line\">     * <span class=\"doctag\">@param</span> tasksRepository a repository of data for tasks</div><div class=\"line\">     * <span class=\"doctag\">@param</span> addTaskView the add/edit view</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AddEditTaskPresenter</span><span class=\"params\">(@Nullable String taskId, @NonNull TasksDataSource tasksRepository,</div><div class=\"line\">            @NonNull AddEditTaskContract.View addTaskView)</span> </span>&#123;</div><div class=\"line\">        mTaskId = taskId;</div><div class=\"line\">        mTasksRepository = checkNotNull(tasksRepository);</div><div class=\"line\">        mAddTaskView = checkNotNull(addTaskView);</div><div class=\"line\"></div><div class=\"line\">        mAddTaskView.setPresenter(<span class=\"keyword\">this</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (!isNewTask()) &#123;</div><div class=\"line\">            populateTask();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveTask</span><span class=\"params\">(String title, String description)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isNewTask()) &#123;</div><div class=\"line\">            createTask(title, description);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            updateTask(title, description);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">populateTask</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isNewTask()) &#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">\"populateTask() was called but task is new.\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        mTasksRepository.getTask(mTaskId, <span class=\"keyword\">this</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onTaskLoaded</span><span class=\"params\">(Task task)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// The view may not be able to handle UI updates anymore</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (mAddTaskView.isActive()) &#123;</div><div class=\"line\">            mAddTaskView.setTitle(task.getTitle());</div><div class=\"line\">            mAddTaskView.setDescription(task.getDescription());</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onDataNotAvailable</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// The view may not be able to handle UI updates anymore</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (mAddTaskView.isActive()) &#123;</div><div class=\"line\">            mAddTaskView.showEmptyTaskError();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isNewTask</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> mTaskId == <span class=\"keyword\">null</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">createTask</span><span class=\"params\">(String title, String description)</span> </span>&#123;</div><div class=\"line\">        Task newTask = <span class=\"keyword\">new</span> Task(title, description);</div><div class=\"line\">        <span class=\"keyword\">if</span> (newTask.isEmpty()) &#123;</div><div class=\"line\">            mAddTaskView.showEmptyTaskError();</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            mTasksRepository.saveTask(newTask);</div><div class=\"line\">            mAddTaskView.showTasksList();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">updateTask</span><span class=\"params\">(String title, String description)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isNewTask()) &#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">\"updateTask() was called but task is new.\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        mTasksRepository.saveTask(<span class=\"keyword\">new</span> Task(title, description, mTaskId));</div><div class=\"line\">        mAddTaskView.showTasksList(); <span class=\"comment\">// After an edit, go back to the list.</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>我们通过其构造函数，传入了一个addEditTaskFragment对象，通过其构造函数的方法，我们可以猜测：AddEditTaskFragment便是具体的V了。<br>并且注意<code>mAddTaskView.setPresenter(this);</code>这句代码，即是在P创建的时候，V、P便实现了绑定。<br>看到<code>AddEditTaskFragment</code>代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AddEditTaskFragment</span> <span class=\"keyword\">extends</span> <span class=\"title\">Fragment</span> <span class=\"keyword\">implements</span> <span class=\"title\">AddEditTaskContract</span>.<span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ARGUMENT_EDIT_TASK_ID = <span class=\"string\">\"EDIT_TASK_ID\"</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> AddEditTaskContract.Presenter mPresenter;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> TextView mTitle;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> TextView mDescription;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\">AddEditTaskFragment <span class=\"title\">newInstance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> AddEditTaskFragment();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">AddEditTaskFragment</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Required empty public constructor</span></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onResume</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onResume();</div><div class=\"line\">        mPresenter.start();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setPresenter</span><span class=\"params\">(@NonNull AddEditTaskContract.Presenter presenter)</span> </span>&#123;</div><div class=\"line\">        mPresenter = checkNotNull(presenter);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onActivityCreated</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onActivityCreated(savedInstanceState);</div><div class=\"line\"></div><div class=\"line\">        FloatingActionButton fab =</div><div class=\"line\">                (FloatingActionButton) getActivity().findViewById(R.id.fab_edit_task_done);</div><div class=\"line\">        fab.setImageResource(R.drawable.ic_done);</div><div class=\"line\">        fab.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                mPresenter.saveTask(mTitle.getText().toString(), mDescription.getText().toString());</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Nullable</span></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\">View <span class=\"title\">onCreateView</span><span class=\"params\">(LayoutInflater inflater, ViewGroup container,</div><div class=\"line\">                             Bundle savedInstanceState)</span> </span>&#123;</div><div class=\"line\">        View root = inflater.inflate(R.layout.addtask_frag, container, <span class=\"keyword\">false</span>);</div><div class=\"line\">        mTitle = (TextView) root.findViewById(R.id.add_task_title);</div><div class=\"line\">        mDescription = (TextView) root.findViewById(R.id.add_task_description);</div><div class=\"line\"></div><div class=\"line\">        setHasOptionsMenu(<span class=\"keyword\">true</span>);</div><div class=\"line\">        setRetainInstance(<span class=\"keyword\">true</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> root;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showEmptyTaskError</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        Snackbar.make(mTitle, getString(R.string.empty_task_message), Snackbar.LENGTH_LONG).show();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">showTasksList</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        getActivity().setResult(Activity.RESULT_OK);</div><div class=\"line\">        getActivity().finish();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setTitle</span><span class=\"params\">(String title)</span> </span>&#123;</div><div class=\"line\">        mTitle.setText(title);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setDescription</span><span class=\"params\">(String description)</span> </span>&#123;</div><div class=\"line\">        mDescription.setText(description);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isActive</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"title\">isAdded</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过前面的gif图，可以猜测P中必定是有一个保存Task的方法，即<code>saveTask</code>方法，在我们点击悬浮按钮的时候会触发。即我们的操作（业务逻辑相关）会由P来执行。<br>看到P中<code>saveTask</code>的具体实现，他会判断当前是否是一个新任务，若是则调用<code>createTask</code>创建新的Task，若标题与内容都为空，则会回调V的<code>showEmptyTaskError</code>方法来显示相关的UI，若不为空，则执行M的操作：<code>mTasksRepository.saveTask(newTask);</code>保存相应的数据，然后回调V的<code>showTasksList</code>方法来显示相关UI。若不是一个新的Task（编辑），则调用<code>updateTask</code>，执行M操作<code>mTasksRepository.saveTask</code>来操作数据。<br>至此，一个完整的业务操作（新建或编辑一个新的Task）分析完毕。可以看到在V中，我们只调用P的相关的接口，然后实现上层V的接口就可以了。由P来调用M中的方法，来操作数据，然后通过回调来使V展示相应的界面。V与M完全分离，整套业务都由P来执行。<br>最后上一张分析图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp5.png\" alt=\"\"></p>\n<h2 id=\"MVP的优缺点\"><a href=\"#MVP的优缺点\" class=\"headerlink\" title=\"MVP的优缺点\"></a>MVP的优缺点</h2><p>优点：</p>\n<ol>\n<li>解耦。实现了Model和View真正的完全分离，再也不是Activity中一大坨代码了。</li>\n<li>清晰。模块职责划分明显，层次清晰。</li>\n<li>测试。在使用MVP的项目中Presenter对View是通过接口进行，在对Presenter进行不依赖UI环境的单元测试的时候。可以通过模拟一个View对象，这个对象只需要实现了View的接口即可。然后注入到Presenter中，单元测试的时候就可以完整的测试Presenter应用逻辑的正确性。</li>\n<li>组件化。在MVP当中，View不依赖Model，这样就可以让View从特定的业务场景中脱离出来，可以说View可以做到对业务完全无知，它只需要提供一系列接口提供给上层操作，这样就可以做到高度可复用的View组件。</li>\n</ol>\n<p>缺点：</p>\n<ol>\n<li>新增很多接口类，额外的代码复杂度及学习成本。</li>\n<li>Presenter中除了业务逻辑以外，可能还有大量的与业务无关的数据操作逻辑，会导致Presenter比较臃肿。</li>\n</ol>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>在代码中，Google已经写好了测试代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AddEditTaskPresenterTest</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Mock</span></div><div class=\"line\">    <span class=\"keyword\">private</span> TasksRepository mTasksRepository;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Mock</span></div><div class=\"line\">    <span class=\"keyword\">private</span> AddEditTaskContract.View mAddEditTaskView;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * &#123;<span class=\"doctag\">@link</span> ArgumentCaptor&#125; is a powerful Mockito API to capture argument values and use them to</div><div class=\"line\">     * perform further actions or assertions on them.</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"meta\">@Captor</span></div><div class=\"line\">    <span class=\"keyword\">private</span> ArgumentCaptor&lt;TasksDataSource.GetTaskCallback&gt; mGetTaskCallbackCaptor;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> AddEditTaskPresenter mAddEditTaskPresenter;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Before</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setupMocksAndView</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Mockito has a very convenient way to inject mocks by using the @Mock annotation. To</span></div><div class=\"line\">        <span class=\"comment\">// inject the mocks in the test the initMocks method needs to be called.</span></div><div class=\"line\">        MockitoAnnotations.initMocks(<span class=\"keyword\">this</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// The presenter wont't update the view unless it's active.</span></div><div class=\"line\">        when(mAddEditTaskView.isActive()).thenReturn(<span class=\"keyword\">true</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Test</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveNewTaskToRepository_showsSuccessMessageUi</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Get a reference to the class under test</span></div><div class=\"line\">        mAddEditTaskPresenter = <span class=\"keyword\">new</span> AddEditTaskPresenter(<span class=\"string\">\"1\"</span>, mTasksRepository, mAddEditTaskView);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// When the presenter is asked to save a task</span></div><div class=\"line\">        mAddEditTaskPresenter.saveTask(<span class=\"string\">\"New Task Title\"</span>, <span class=\"string\">\"Some Task Description\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Then a task is saved in the repository and the view updated</span></div><div class=\"line\">        verify(mTasksRepository).saveTask(any(Task.class)); <span class=\"comment\">// saved to the model</span></div><div class=\"line\">        verify(mAddEditTaskView).showTasksList(); <span class=\"comment\">// shown in the UI</span></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Test</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveTask_emptyTaskShowsErrorUi</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Get a reference to the class under test</span></div><div class=\"line\">        mAddEditTaskPresenter = <span class=\"keyword\">new</span> AddEditTaskPresenter(<span class=\"keyword\">null</span>, mTasksRepository, mAddEditTaskView);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// When the presenter is asked to save an empty task</span></div><div class=\"line\">        mAddEditTaskPresenter.saveTask(<span class=\"string\">\"\"</span>, <span class=\"string\">\"\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Then an empty not error is shown in the UI</span></div><div class=\"line\">        verify(mAddEditTaskView).showEmptyTaskError();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Test</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveExistingTaskToRepository_showsSuccessMessageUi</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Get a reference to the class under test</span></div><div class=\"line\">        mAddEditTaskPresenter = <span class=\"keyword\">new</span> AddEditTaskPresenter(<span class=\"string\">\"1\"</span>, mTasksRepository, mAddEditTaskView);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// When the presenter is asked to save an existing task</span></div><div class=\"line\">        mAddEditTaskPresenter.saveTask(<span class=\"string\">\"New Task Title\"</span>, <span class=\"string\">\"Some Task Description\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Then a task is saved in the repository and the view updated</span></div><div class=\"line\">        verify(mTasksRepository).saveTask(any(Task.class)); <span class=\"comment\">// saved to the model</span></div><div class=\"line\">        verify(mAddEditTaskView).showTasksList(); <span class=\"comment\">// shown in the UI</span></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Test</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">populateTask_callsRepoAndUpdatesView</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        Task testTask = <span class=\"keyword\">new</span> Task(<span class=\"string\">\"TITLE\"</span>, <span class=\"string\">\"DESCRIPTION\"</span>);</div><div class=\"line\">        <span class=\"comment\">// Get a reference to the class under test</span></div><div class=\"line\">        mAddEditTaskPresenter = <span class=\"keyword\">new</span> AddEditTaskPresenter(testTask.getId(),</div><div class=\"line\">                mTasksRepository, mAddEditTaskView);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// When the presenter is asked to populate an existing task</span></div><div class=\"line\">        mAddEditTaskPresenter.populateTask();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Then the task repository is queried and the view updated</span></div><div class=\"line\">        verify(mTasksRepository).getTask(eq(testTask.getId()), mGetTaskCallbackCaptor.capture());</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Simulate callback</span></div><div class=\"line\">        mGetTaskCallbackCaptor.getValue().onTaskLoaded(testTask);</div><div class=\"line\"></div><div class=\"line\">        verify(mAddEditTaskView).setTitle(testTask.getTitle());</div><div class=\"line\">        verify(mAddEditTaskView).setDescription(testTask.getDescription());</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>来执行一下吧：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/mvp4.png\" alt=\"\"><br>可以看到测试成功。<br>那么假设我们采用传统的开发模式，代码全在Activity里，要怎么样测试呢？噢，想想就觉得头大了，是吗？</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过此次Google官方例子的学习分析，让我对MVP模式有了更清晰的认识，并且我认为MVP模式的实用性很高。虽然它增加了额外的代码，但是它带来的好处是不言而喻的。在今后的开发中，我想我会尝试着使用它。</p>"},{"title":"Android自定义View实现弧形SeekBar（续）","date":"2016-04-28T08:13:36.000Z","_content":"\n## 问题\n在我的[上一篇文章](http://lastwarmth.site/2016/04/27/seekbar/)中，写了自定义弧形SeekBar，效果达到了自己的预期，于是高高兴兴回家了。但是后面手贱，在家里自己随意玩了玩，发现SeekBar滑动几下之后再滑动就会变得特别卡。然后查看代码，短时间内没什么头绪。\n\n没错，这个时候又要祭出我的室友了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar1.jpg)\n室友之前是做rom相关的，对于android系统工具用得很熟。然后他拿着我的手机打开开发者选项中的``GPU呈现模式分析``，运行了一下程序，滑了一会之后就这样了：\n\n<!-- more -->\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar3.png)\n我们可以看到一条绿线，这条绿线代表的是60帧，超过这条线就代表不足60帧，那么人眼看起来就会感觉卡顿，可以看到超出了好多了，难怪会很卡~。\n\n那么问题可以大致定位到``绘制View的方法不够科学``。\n\n那么怎样才能科学呢？其实我也没答案。但是大致有了一个思路：绘制好弧线和圆球之后，在滑动的时候不再重绘弧线和圆球，仅仅改变圆球的位置，这样就会少了很多的绘制操作。如此实现的话或许便能解决问题了。但也只是假设，下面开始实战。\n\n## 解决方案\n我将代码拆分成3个类：继承自FrameLayout的``ArcSeekBarParent``，``SeekBarArcView``以及``SeekBarBallView``。\nArcSeekBarParent代码：\n```\npublic class ArcSeekBarParent extends FrameLayout implements SeekBarBallView.OnSmoothScrollListener {\n\n    private PointF pointF1; // 起始点\n    private PointF pointF2; // 控制点\n    private PointF pointF3; // 终止点\n    private PointF circleCenter; // 球的坐标\n    private int top;\n    private int right;\n    private int bottom;\n    private int left;\n    private float currentX; // 当前x坐标，用于控制圆球位置\n    private final static float LEVEL = 6f; // 设置档次\n    private int currentLevel = 1; // 当前档次\n\n    private OnProgressChangedListener listener;\n\n    private SeekBarBallView ball;\n\n    public ArcSeekBarParent(Context context) {\n        super(context);\n        init();\n    }\n\n    public ArcSeekBarParent(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init();\n    }\n\n    public ArcSeekBarParent(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init();\n    }\n\n    private void init() {\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n        circleCenter = new PointF();\n    }\n\n    public void setListener(OnProgressChangedListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onFinishInflate() {\n        super.onFinishInflate();\n        ball = (SeekBarBallView) getChildAt(1);\n        ball.setListener(this);\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        this.left = left;\n        this.top = top;\n        this.right = right;\n        this.bottom = bottom;\n        pointF1.set(0, bottom - top - 30);\n        pointF2.set((right - left) / 2, -(bottom - top) / 4);\n        pointF3.set(right, bottom - top - 30);\n        currentX = (right - left) / LEVEL;\n        changeBallLayout(currentX);\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent event) {\n        switch (event.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                float downX = event.getX();\n                float downY = event.getY();\n                float distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);\n                // 计算到圆球中心的距离，考虑20的误差\n                return !(distance - (ball.getMeasuredWidth() / 2 + 20) * (ball.getMeasuredWidth() / 2 + 20) > 0);\n            case MotionEvent.ACTION_MOVE:\n                float moveX = event.getX();\n                currentX = moveX; // 通过x坐标改变圆球的位置\n                changeBallLayout(currentX);\n                currentLevel = getLevel(moveX);\n                if (listener != null) {\n                    listener.OnProgressChanged(currentLevel);\n                }\n                break;\n            default:\n                // 当手指移出或者离开View时，圆球平滑滑到最近的档次\n                ball.smoothScrollLevel((int) currentX, (int) ((right - left) / LEVEL * currentLevel - currentX));\n                break;\n        }\n        return super.onTouchEvent(event);\n    }\n\n    /**\n     * 改变球的位置\n     *\n     * @param currentX 横坐标\n     */\n    private void changeBallLayout(float currentX) {\n        float t = (currentX / (right - left));\n        float x = (1 - t) * (1 - t) * pointF1.x + 2 * (t) * (1 - t) * pointF2.x + t * t * pointF3.x;\n        float y = (1 - t) * (1 - t) * pointF1.y + 2 * (t) * (1 - t) * pointF2.y + t * t * pointF3.y;\n        circleCenter.set(x, y);\n        ball.layout((int) (circleCenter.x - ball.getMeasuredWidth() / 2), (int) (circleCenter.y - ball.getMeasuredWidth() / 2), (int) (circleCenter.x + ball.getMeasuredWidth() / 2), (int) (circleCenter.y + ball.getMeasuredWidth() / 2));\n    }\n\n    /**\n     * 计算档次\n     *\n     * @param x 横坐标\n     * @return 档次\n     */\n    private int getLevel(float x) {\n        float ratio = (x / (right - left)) * LEVEL;\n        // 计算距离哪个档次最近\n        int result = new BigDecimal(ratio).setScale(0, BigDecimal.ROUND_HALF_UP).intValue();\n        if (result < 1) {\n            result = 1;\n        } else if (result > (LEVEL - 1)) {\n            result = (int) (LEVEL - 1);\n        }\n        return result;\n    }\n\n    @Override\n    public void onSmoothScroll(int currentX) {\n        changeBallLayout(currentX);\n    }\n\n    /**\n     * 滑动接口\n     */\n    public interface OnProgressChangedListener {\n        void OnProgressChanged(int level);\n    }\n}\n```\nSeekBarArcView代码：\n```\npublic class SeekBarArcView extends View {\n\n    private Paint paint;\n    private Path path;\n    private PointF pointF1; // 起始点\n    private PointF pointF2; // 控制点\n    private PointF pointF3; // 终止点\n\n    public SeekBarArcView(Context context) {\n        super(context);\n        init();\n    }\n\n    public SeekBarArcView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init();\n    }\n\n    public SeekBarArcView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init();\n    }\n\n    private void init() {\n        paint = new Paint();\n        path = new Path();\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        pointF1.set(0, bottom - top - 30);\n        pointF2.set((right - left) / 2, -(bottom - top) / 4);\n        pointF3.set(right, bottom - top - 30);\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n\n        // 画2阶贝塞尔曲线\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.GRAY);\n        paint.setStrokeWidth(10);\n        paint.setStyle(Paint.Style.STROKE);\n        path.moveTo(pointF1.x, pointF1.y);\n        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);\n        canvas.drawPath(path, paint);\n    }\n}\n```\nSeekBarBallView代码：\n```\npublic class SeekBarBallView extends View {\n\n    private Paint paint;\n    private Scroller scroller;\n    private OnSmoothScrollListener listener;\n\n    public SeekBarBallView(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public SeekBarBallView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public SeekBarBallView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    private void init(Context context) {\n        paint = new Paint();\n        scroller = new Scroller(context);\n    }\n\n    public void setListener(OnSmoothScrollListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n        setMeasuredDimension(widthMeasureSpec, widthMeasureSpec);\n    }\n\n    @Override\n    public void computeScroll() {\n        if (scroller.computeScrollOffset()) {\n            if (listener != null) {\n                listener.onSmoothScroll(scroller.getCurrX());\n                postInvalidate();\n            }\n        }\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n        paint.reset();\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.WHITE);\n        paint.setStyle(Paint.Style.FILL);\n        canvas.drawCircle(getMeasuredWidth() / 2, getMeasuredWidth() / 2, getMeasuredWidth() / 2, paint);\n    }\n\n    /**\n     * 平滑滑动\n     *\n     * @param start    起始值\n     * @param distance 滑动距离\n     */\n    public void smoothScrollLevel(int start, int distance) {\n        scroller.startScroll(start, 0, distance, 0, 200);\n        postInvalidate();\n    }\n\n    public interface OnSmoothScrollListener {\n        void onSmoothScroll(int currentX);\n    }\n}\n```\n可以看到代码基本都是差不多的，只不过我将之前的View拆分成一个ViewGroup，绘制弧线的``SeekBarArcView``和绘制圆球的``SeekBarBallView``。在ACTION_MOVE的时候，我只是使用ball.layout()方法，即只改变圆球的layout，而没有重绘整个SeekBar。\n\n添加xml引用：\n```\n<com.android.lovesixgod.customarcseekbar.seekbar.ArcSeekBarParent\n    android:id=\"@+id/seek_bar\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"100dp\"\n    android:layout_marginTop=\"40dp\"\n    android:background=\"@color/colorAccent\">\n\n    <com.android.lovesixgod.customarcseekbar.seekbar.SeekBarArcView\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\" />\n\n    <com.android.lovesixgod.customarcseekbar.seekbar.SeekBarBallView\n        android:layout_width=\"20dp\"\n        android:layout_height=\"100dp\" />\n\n</com.android.lovesixgod.customarcseekbar.seekbar.ArcSeekBarParent>\n```\n然后运行，进行滑动。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar2.png)\n可以看到GPU分析显示的线条基本不会超过绿线，滑起来也没有明显的卡顿，问题应该算是解决了~\n\n代码已更新至[Github](https://github.com/LiJia92/CustomArcSeekBar)。\n\n## 小结\n1. 自定义View的时候尽量避免不变View的重绘。因为弧形线这个View是没有任何改变的，但是还不停地重绘，可能就会导致这样的性能问题了。\n2. Scroller的使用是针对View的，对于ViewGroup好像是无效的，所以我将Scroller写在了``SeekBarBallView``中。另外Scroller要能正常使用，在``startScroll()``以及``computeScroll()``需要``invalidate()``或者``postInvalidate``。\n3. 多使用相关工具，来观察代码的性能。\n","source":"_posts/new-seekbar.md","raw":"---\ntitle: Android自定义View实现弧形SeekBar（续）\ndate: 2016-04-28 16:13:36\ntags:\n - 自定义View\n---\n\n## 问题\n在我的[上一篇文章](http://lastwarmth.site/2016/04/27/seekbar/)中，写了自定义弧形SeekBar，效果达到了自己的预期，于是高高兴兴回家了。但是后面手贱，在家里自己随意玩了玩，发现SeekBar滑动几下之后再滑动就会变得特别卡。然后查看代码，短时间内没什么头绪。\n\n没错，这个时候又要祭出我的室友了。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar1.jpg)\n室友之前是做rom相关的，对于android系统工具用得很熟。然后他拿着我的手机打开开发者选项中的``GPU呈现模式分析``，运行了一下程序，滑了一会之后就这样了：\n\n<!-- more -->\n\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar3.png)\n我们可以看到一条绿线，这条绿线代表的是60帧，超过这条线就代表不足60帧，那么人眼看起来就会感觉卡顿，可以看到超出了好多了，难怪会很卡~。\n\n那么问题可以大致定位到``绘制View的方法不够科学``。\n\n那么怎样才能科学呢？其实我也没答案。但是大致有了一个思路：绘制好弧线和圆球之后，在滑动的时候不再重绘弧线和圆球，仅仅改变圆球的位置，这样就会少了很多的绘制操作。如此实现的话或许便能解决问题了。但也只是假设，下面开始实战。\n\n## 解决方案\n我将代码拆分成3个类：继承自FrameLayout的``ArcSeekBarParent``，``SeekBarArcView``以及``SeekBarBallView``。\nArcSeekBarParent代码：\n```\npublic class ArcSeekBarParent extends FrameLayout implements SeekBarBallView.OnSmoothScrollListener {\n\n    private PointF pointF1; // 起始点\n    private PointF pointF2; // 控制点\n    private PointF pointF3; // 终止点\n    private PointF circleCenter; // 球的坐标\n    private int top;\n    private int right;\n    private int bottom;\n    private int left;\n    private float currentX; // 当前x坐标，用于控制圆球位置\n    private final static float LEVEL = 6f; // 设置档次\n    private int currentLevel = 1; // 当前档次\n\n    private OnProgressChangedListener listener;\n\n    private SeekBarBallView ball;\n\n    public ArcSeekBarParent(Context context) {\n        super(context);\n        init();\n    }\n\n    public ArcSeekBarParent(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init();\n    }\n\n    public ArcSeekBarParent(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init();\n    }\n\n    private void init() {\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n        circleCenter = new PointF();\n    }\n\n    public void setListener(OnProgressChangedListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onFinishInflate() {\n        super.onFinishInflate();\n        ball = (SeekBarBallView) getChildAt(1);\n        ball.setListener(this);\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        this.left = left;\n        this.top = top;\n        this.right = right;\n        this.bottom = bottom;\n        pointF1.set(0, bottom - top - 30);\n        pointF2.set((right - left) / 2, -(bottom - top) / 4);\n        pointF3.set(right, bottom - top - 30);\n        currentX = (right - left) / LEVEL;\n        changeBallLayout(currentX);\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent event) {\n        switch (event.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                float downX = event.getX();\n                float downY = event.getY();\n                float distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);\n                // 计算到圆球中心的距离，考虑20的误差\n                return !(distance - (ball.getMeasuredWidth() / 2 + 20) * (ball.getMeasuredWidth() / 2 + 20) > 0);\n            case MotionEvent.ACTION_MOVE:\n                float moveX = event.getX();\n                currentX = moveX; // 通过x坐标改变圆球的位置\n                changeBallLayout(currentX);\n                currentLevel = getLevel(moveX);\n                if (listener != null) {\n                    listener.OnProgressChanged(currentLevel);\n                }\n                break;\n            default:\n                // 当手指移出或者离开View时，圆球平滑滑到最近的档次\n                ball.smoothScrollLevel((int) currentX, (int) ((right - left) / LEVEL * currentLevel - currentX));\n                break;\n        }\n        return super.onTouchEvent(event);\n    }\n\n    /**\n     * 改变球的位置\n     *\n     * @param currentX 横坐标\n     */\n    private void changeBallLayout(float currentX) {\n        float t = (currentX / (right - left));\n        float x = (1 - t) * (1 - t) * pointF1.x + 2 * (t) * (1 - t) * pointF2.x + t * t * pointF3.x;\n        float y = (1 - t) * (1 - t) * pointF1.y + 2 * (t) * (1 - t) * pointF2.y + t * t * pointF3.y;\n        circleCenter.set(x, y);\n        ball.layout((int) (circleCenter.x - ball.getMeasuredWidth() / 2), (int) (circleCenter.y - ball.getMeasuredWidth() / 2), (int) (circleCenter.x + ball.getMeasuredWidth() / 2), (int) (circleCenter.y + ball.getMeasuredWidth() / 2));\n    }\n\n    /**\n     * 计算档次\n     *\n     * @param x 横坐标\n     * @return 档次\n     */\n    private int getLevel(float x) {\n        float ratio = (x / (right - left)) * LEVEL;\n        // 计算距离哪个档次最近\n        int result = new BigDecimal(ratio).setScale(0, BigDecimal.ROUND_HALF_UP).intValue();\n        if (result < 1) {\n            result = 1;\n        } else if (result > (LEVEL - 1)) {\n            result = (int) (LEVEL - 1);\n        }\n        return result;\n    }\n\n    @Override\n    public void onSmoothScroll(int currentX) {\n        changeBallLayout(currentX);\n    }\n\n    /**\n     * 滑动接口\n     */\n    public interface OnProgressChangedListener {\n        void OnProgressChanged(int level);\n    }\n}\n```\nSeekBarArcView代码：\n```\npublic class SeekBarArcView extends View {\n\n    private Paint paint;\n    private Path path;\n    private PointF pointF1; // 起始点\n    private PointF pointF2; // 控制点\n    private PointF pointF3; // 终止点\n\n    public SeekBarArcView(Context context) {\n        super(context);\n        init();\n    }\n\n    public SeekBarArcView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init();\n    }\n\n    public SeekBarArcView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init();\n    }\n\n    private void init() {\n        paint = new Paint();\n        path = new Path();\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        pointF1.set(0, bottom - top - 30);\n        pointF2.set((right - left) / 2, -(bottom - top) / 4);\n        pointF3.set(right, bottom - top - 30);\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n\n        // 画2阶贝塞尔曲线\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.GRAY);\n        paint.setStrokeWidth(10);\n        paint.setStyle(Paint.Style.STROKE);\n        path.moveTo(pointF1.x, pointF1.y);\n        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);\n        canvas.drawPath(path, paint);\n    }\n}\n```\nSeekBarBallView代码：\n```\npublic class SeekBarBallView extends View {\n\n    private Paint paint;\n    private Scroller scroller;\n    private OnSmoothScrollListener listener;\n\n    public SeekBarBallView(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public SeekBarBallView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public SeekBarBallView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    private void init(Context context) {\n        paint = new Paint();\n        scroller = new Scroller(context);\n    }\n\n    public void setListener(OnSmoothScrollListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n        setMeasuredDimension(widthMeasureSpec, widthMeasureSpec);\n    }\n\n    @Override\n    public void computeScroll() {\n        if (scroller.computeScrollOffset()) {\n            if (listener != null) {\n                listener.onSmoothScroll(scroller.getCurrX());\n                postInvalidate();\n            }\n        }\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n        paint.reset();\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.WHITE);\n        paint.setStyle(Paint.Style.FILL);\n        canvas.drawCircle(getMeasuredWidth() / 2, getMeasuredWidth() / 2, getMeasuredWidth() / 2, paint);\n    }\n\n    /**\n     * 平滑滑动\n     *\n     * @param start    起始值\n     * @param distance 滑动距离\n     */\n    public void smoothScrollLevel(int start, int distance) {\n        scroller.startScroll(start, 0, distance, 0, 200);\n        postInvalidate();\n    }\n\n    public interface OnSmoothScrollListener {\n        void onSmoothScroll(int currentX);\n    }\n}\n```\n可以看到代码基本都是差不多的，只不过我将之前的View拆分成一个ViewGroup，绘制弧线的``SeekBarArcView``和绘制圆球的``SeekBarBallView``。在ACTION_MOVE的时候，我只是使用ball.layout()方法，即只改变圆球的layout，而没有重绘整个SeekBar。\n\n添加xml引用：\n```\n<com.android.lovesixgod.customarcseekbar.seekbar.ArcSeekBarParent\n    android:id=\"@+id/seek_bar\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"100dp\"\n    android:layout_marginTop=\"40dp\"\n    android:background=\"@color/colorAccent\">\n\n    <com.android.lovesixgod.customarcseekbar.seekbar.SeekBarArcView\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\" />\n\n    <com.android.lovesixgod.customarcseekbar.seekbar.SeekBarBallView\n        android:layout_width=\"20dp\"\n        android:layout_height=\"100dp\" />\n\n</com.android.lovesixgod.customarcseekbar.seekbar.ArcSeekBarParent>\n```\n然后运行，进行滑动。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar2.png)\n可以看到GPU分析显示的线条基本不会超过绿线，滑起来也没有明显的卡顿，问题应该算是解决了~\n\n代码已更新至[Github](https://github.com/LiJia92/CustomArcSeekBar)。\n\n## 小结\n1. 自定义View的时候尽量避免不变View的重绘。因为弧形线这个View是没有任何改变的，但是还不停地重绘，可能就会导致这样的性能问题了。\n2. Scroller的使用是针对View的，对于ViewGroup好像是无效的，所以我将Scroller写在了``SeekBarBallView``中。另外Scroller要能正常使用，在``startScroll()``以及``computeScroll()``需要``invalidate()``或者``postInvalidate``。\n3. 多使用相关工具，来观察代码的性能。\n","slug":"new-seekbar","published":1,"updated":"2016-11-21T10:02:03.995Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759p00231cb8lf7c8an9","content":"<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>在我的<a href=\"http://lastwarmth.site/2016/04/27/seekbar/\" target=\"_blank\" rel=\"external\">上一篇文章</a>中，写了自定义弧形SeekBar，效果达到了自己的预期，于是高高兴兴回家了。但是后面手贱，在家里自己随意玩了玩，发现SeekBar滑动几下之后再滑动就会变得特别卡。然后查看代码，短时间内没什么头绪。</p>\n<p>没错，这个时候又要祭出我的室友了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar1.jpg\" alt=\"\"><br>室友之前是做rom相关的，对于android系统工具用得很熟。然后他拿着我的手机打开开发者选项中的<code>GPU呈现模式分析</code>，运行了一下程序，滑了一会之后就这样了：</p>\n<a id=\"more\"></a>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar3.png\" alt=\"\"><br>我们可以看到一条绿线，这条绿线代表的是60帧，超过这条线就代表不足60帧，那么人眼看起来就会感觉卡顿，可以看到超出了好多了，难怪会很卡~。</p>\n<p>那么问题可以大致定位到<code>绘制View的方法不够科学</code>。</p>\n<p>那么怎样才能科学呢？其实我也没答案。但是大致有了一个思路：绘制好弧线和圆球之后，在滑动的时候不再重绘弧线和圆球，仅仅改变圆球的位置，这样就会少了很多的绘制操作。如此实现的话或许便能解决问题了。但也只是假设，下面开始实战。</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>我将代码拆分成3个类：继承自FrameLayout的<code>ArcSeekBarParent</code>，<code>SeekBarArcView</code>以及<code>SeekBarBallView</code>。<br>ArcSeekBarParent代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ArcSeekBarParent</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrameLayout</span> <span class=\"keyword\">implements</span> <span class=\"title\">SeekBarBallView</span>.<span class=\"title\">OnSmoothScrollListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1; <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2; <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3; <span class=\"comment\">// 终止点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF circleCenter; <span class=\"comment\">// 球的坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> top;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> right;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> bottom;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> left;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> currentX; <span class=\"comment\">// 当前x坐标，用于控制圆球位置</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">float</span> LEVEL = <span class=\"number\">6</span>f; <span class=\"comment\">// 设置档次</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> currentLevel = <span class=\"number\">1</span>; <span class=\"comment\">// 当前档次</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> OnProgressChangedListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> SeekBarBallView ball;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        circleCenter = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnProgressChangedListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onFinishInflate</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onFinishInflate();</div><div class=\"line\">        ball = (SeekBarBallView) getChildAt(<span class=\"number\">1</span>);</div><div class=\"line\">        ball.setListener(<span class=\"keyword\">this</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        <span class=\"keyword\">this</span>.left = left;</div><div class=\"line\">        <span class=\"keyword\">this</span>.top = top;</div><div class=\"line\">        <span class=\"keyword\">this</span>.right = right;</div><div class=\"line\">        <span class=\"keyword\">this</span>.bottom = bottom;</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">4</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        currentX = (right - left) / LEVEL;</div><div class=\"line\">        changeBallLayout(currentX);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (event.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                <span class=\"keyword\">float</span> downX = event.getX();</div><div class=\"line\">                <span class=\"keyword\">float</span> downY = event.getY();</div><div class=\"line\">                <span class=\"keyword\">float</span> distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);</div><div class=\"line\">                <span class=\"comment\">// 计算到圆球中心的距离，考虑20的误差</span></div><div class=\"line\">                <span class=\"keyword\">return</span> !(distance - (ball.getMeasuredWidth() / <span class=\"number\">2</span> + <span class=\"number\">20</span>) * (ball.getMeasuredWidth() / <span class=\"number\">2</span> + <span class=\"number\">20</span>) &gt; <span class=\"number\">0</span>);</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = event.getX();</div><div class=\"line\">                currentX = moveX; <span class=\"comment\">// 通过x坐标改变圆球的位置</span></div><div class=\"line\">                changeBallLayout(currentX);</div><div class=\"line\">                currentLevel = getLevel(moveX);</div><div class=\"line\">                <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    listener.OnProgressChanged(currentLevel);</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">default</span>:</div><div class=\"line\">                // 当手指移出或者离开View时，圆球平滑滑到最近的档次</div><div class=\"line\">                ball.smoothScrollLevel((<span class=\"keyword\">int</span>) currentX, (<span class=\"keyword\">int</span>) ((right - left) / LEVEL * currentLevel - currentX));</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 改变球的位置</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> currentX 横坐标</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">changeBallLayout</span><span class=\"params\">(<span class=\"keyword\">float</span> currentX)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> t = (currentX / (right - left));</div><div class=\"line\">        <span class=\"keyword\">float</span> x = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.x + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.x + t * t * pointF3.x;</div><div class=\"line\">        <span class=\"keyword\">float</span> y = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.y + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.y + t * t * pointF3.y;</div><div class=\"line\">        circleCenter.set(x, y);</div><div class=\"line\">        ball.layout((<span class=\"keyword\">int</span>) (circleCenter.x - ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.y - ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.x + ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.y + ball.getMeasuredWidth() / <span class=\"number\">2</span>));</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 计算档次</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> x 横坐标</div><div class=\"line\">     * <span class=\"doctag\">@return</span> 档次</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getLevel</span><span class=\"params\">(<span class=\"keyword\">float</span> x)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> ratio = (x / (right - left)) * LEVEL;</div><div class=\"line\">        <span class=\"comment\">// 计算距离哪个档次最近</span></div><div class=\"line\">        <span class=\"keyword\">int</span> result = <span class=\"keyword\">new</span> BigDecimal(ratio).setScale(<span class=\"number\">0</span>, BigDecimal.ROUND_HALF_UP).intValue();</div><div class=\"line\">        <span class=\"keyword\">if</span> (result &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\">            result = <span class=\"number\">1</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (result &gt; (LEVEL - <span class=\"number\">1</span>)) &#123;</div><div class=\"line\">            result = (<span class=\"keyword\">int</span>) (LEVEL - <span class=\"number\">1</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> result;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onSmoothScroll</span><span class=\"params\">(<span class=\"keyword\">int</span> currentX)</span> </span>&#123;</div><div class=\"line\">        changeBallLayout(currentX);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 滑动接口</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnProgressChangedListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>SeekBarArcView代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SeekBarArcView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Path path;</div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1; <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2; <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3; <span class=\"comment\">// 终止点</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarArcView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarArcView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarArcView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        path = <span class=\"keyword\">new</span> Path();</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">4</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画2阶贝塞尔曲线</span></div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.GRAY);</div><div class=\"line\">        paint.setStrokeWidth(<span class=\"number\">10</span>);</div><div class=\"line\">        paint.setStyle(Paint.Style.STROKE);</div><div class=\"line\">        path.moveTo(pointF1.x, pointF1.y);</div><div class=\"line\">        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);</div><div class=\"line\">        canvas.drawPath(path, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>SeekBarBallView代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SeekBarBallView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller scroller;</div><div class=\"line\">    <span class=\"keyword\">private</span> OnSmoothScrollListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarBallView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarBallView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarBallView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        scroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnSmoothScrollListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onMeasure</span><span class=\"params\">(<span class=\"keyword\">int</span> widthMeasureSpec, <span class=\"keyword\">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class=\"line\">        setMeasuredDimension(widthMeasureSpec, widthMeasureSpec);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scroller.computeScrollOffset()) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                listener.onSmoothScroll(scroller.getCurrX());</div><div class=\"line\">                postInvalidate();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">        paint.reset();</div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.WHITE);</div><div class=\"line\">        paint.setStyle(Paint.Style.FILL);</div><div class=\"line\">        canvas.drawCircle(getMeasuredWidth() / <span class=\"number\">2</span>, getMeasuredWidth() / <span class=\"number\">2</span>, getMeasuredWidth() / <span class=\"number\">2</span>, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 平滑滑动</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> start    起始值</div><div class=\"line\">     * <span class=\"doctag\">@param</span> distance 滑动距离</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">smoothScrollLevel</span><span class=\"params\">(<span class=\"keyword\">int</span> start, <span class=\"keyword\">int</span> distance)</span> </span>&#123;</div><div class=\"line\">        scroller.startScroll(start, <span class=\"number\">0</span>, distance, <span class=\"number\">0</span>, <span class=\"number\">200</span>);</div><div class=\"line\">        postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnSmoothScrollListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onSmoothScroll</span><span class=\"params\">(<span class=\"keyword\">int</span> currentX)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到代码基本都是差不多的，只不过我将之前的View拆分成一个ViewGroup，绘制弧线的<code>SeekBarArcView</code>和绘制圆球的<code>SeekBarBallView</code>。在ACTION_MOVE的时候，我只是使用ball.layout()方法，即只改变圆球的layout，而没有重绘整个SeekBar。</p>\n<p>添加xml引用：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.customarcseekbar</span><span class=\"selector-class\">.seekbar</span><span class=\"selector-class\">.ArcSeekBarParent</span></div><div class=\"line\">    android:id=<span class=\"string\">\"@+id/seek_bar\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"100dp\"</span></div><div class=\"line\">    android:layout_marginTop=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">    android:<span class=\"attribute\">background</span>=<span class=\"string\">\"@color/colorAccent\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.customarcseekbar</span><span class=\"selector-class\">.seekbar</span><span class=\"selector-class\">.SeekBarArcView</span></div><div class=\"line\">        android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"match_parent\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.customarcseekbar</span><span class=\"selector-class\">.seekbar</span><span class=\"selector-class\">.SeekBarBallView</span></div><div class=\"line\">        android:layout_width=<span class=\"string\">\"20dp\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"100dp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;/com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.customarcseekbar</span><span class=\"selector-class\">.seekbar</span><span class=\"selector-class\">.ArcSeekBarParent</span>&gt;</div></pre></td></tr></table></figure></p>\n<p>然后运行，进行滑动。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar2.png\" alt=\"\"><br>可以看到GPU分析显示的线条基本不会超过绿线，滑起来也没有明显的卡顿，问题应该算是解决了~</p>\n<p>代码已更新至<a href=\"https://github.com/LiJia92/CustomArcSeekBar\" target=\"_blank\" rel=\"external\">Github</a>。</p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ol>\n<li>自定义View的时候尽量避免不变View的重绘。因为弧形线这个View是没有任何改变的，但是还不停地重绘，可能就会导致这样的性能问题了。</li>\n<li>Scroller的使用是针对View的，对于ViewGroup好像是无效的，所以我将Scroller写在了<code>SeekBarBallView</code>中。另外Scroller要能正常使用，在<code>startScroll()</code>以及<code>computeScroll()</code>需要<code>invalidate()</code>或者<code>postInvalidate</code>。</li>\n<li>多使用相关工具，来观察代码的性能。</li>\n</ol>\n","excerpt":"<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>在我的<a href=\"http://lastwarmth.site/2016/04/27/seekbar/\">上一篇文章</a>中，写了自定义弧形SeekBar，效果达到了自己的预期，于是高高兴兴回家了。但是后面手贱，在家里自己随意玩了玩，发现SeekBar滑动几下之后再滑动就会变得特别卡。然后查看代码，短时间内没什么头绪。</p>\n<p>没错，这个时候又要祭出我的室友了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar1.jpg\" alt=\"\"><br>室友之前是做rom相关的，对于android系统工具用得很熟。然后他拿着我的手机打开开发者选项中的<code>GPU呈现模式分析</code>，运行了一下程序，滑了一会之后就这样了：</p>","more":"<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar3.png\" alt=\"\"><br>我们可以看到一条绿线，这条绿线代表的是60帧，超过这条线就代表不足60帧，那么人眼看起来就会感觉卡顿，可以看到超出了好多了，难怪会很卡~。</p>\n<p>那么问题可以大致定位到<code>绘制View的方法不够科学</code>。</p>\n<p>那么怎样才能科学呢？其实我也没答案。但是大致有了一个思路：绘制好弧线和圆球之后，在滑动的时候不再重绘弧线和圆球，仅仅改变圆球的位置，这样就会少了很多的绘制操作。如此实现的话或许便能解决问题了。但也只是假设，下面开始实战。</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><p>我将代码拆分成3个类：继承自FrameLayout的<code>ArcSeekBarParent</code>，<code>SeekBarArcView</code>以及<code>SeekBarBallView</code>。<br>ArcSeekBarParent代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ArcSeekBarParent</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrameLayout</span> <span class=\"keyword\">implements</span> <span class=\"title\">SeekBarBallView</span>.<span class=\"title\">OnSmoothScrollListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1; <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2; <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3; <span class=\"comment\">// 终止点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF circleCenter; <span class=\"comment\">// 球的坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> top;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> right;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> bottom;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> left;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> currentX; <span class=\"comment\">// 当前x坐标，用于控制圆球位置</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">float</span> LEVEL = <span class=\"number\">6</span>f; <span class=\"comment\">// 设置档次</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> currentLevel = <span class=\"number\">1</span>; <span class=\"comment\">// 当前档次</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> OnProgressChangedListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> SeekBarBallView ball;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArcSeekBarParent</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        circleCenter = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnProgressChangedListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onFinishInflate</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onFinishInflate();</div><div class=\"line\">        ball = (SeekBarBallView) getChildAt(<span class=\"number\">1</span>);</div><div class=\"line\">        ball.setListener(<span class=\"keyword\">this</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        <span class=\"keyword\">this</span>.left = left;</div><div class=\"line\">        <span class=\"keyword\">this</span>.top = top;</div><div class=\"line\">        <span class=\"keyword\">this</span>.right = right;</div><div class=\"line\">        <span class=\"keyword\">this</span>.bottom = bottom;</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">4</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        currentX = (right - left) / LEVEL;</div><div class=\"line\">        changeBallLayout(currentX);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (event.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                <span class=\"keyword\">float</span> downX = event.getX();</div><div class=\"line\">                <span class=\"keyword\">float</span> downY = event.getY();</div><div class=\"line\">                <span class=\"keyword\">float</span> distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);</div><div class=\"line\">                <span class=\"comment\">// 计算到圆球中心的距离，考虑20的误差</span></div><div class=\"line\">                <span class=\"keyword\">return</span> !(distance - (ball.getMeasuredWidth() / <span class=\"number\">2</span> + <span class=\"number\">20</span>) * (ball.getMeasuredWidth() / <span class=\"number\">2</span> + <span class=\"number\">20</span>) &gt; <span class=\"number\">0</span>);</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = event.getX();</div><div class=\"line\">                currentX = moveX; <span class=\"comment\">// 通过x坐标改变圆球的位置</span></div><div class=\"line\">                changeBallLayout(currentX);</div><div class=\"line\">                currentLevel = getLevel(moveX);</div><div class=\"line\">                <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    listener.OnProgressChanged(currentLevel);</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">default</span>:</div><div class=\"line\">                // 当手指移出或者离开View时，圆球平滑滑到最近的档次</div><div class=\"line\">                ball.smoothScrollLevel((<span class=\"keyword\">int</span>) currentX, (<span class=\"keyword\">int</span>) ((right - left) / LEVEL * currentLevel - currentX));</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 改变球的位置</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> currentX 横坐标</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">changeBallLayout</span><span class=\"params\">(<span class=\"keyword\">float</span> currentX)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> t = (currentX / (right - left));</div><div class=\"line\">        <span class=\"keyword\">float</span> x = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.x + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.x + t * t * pointF3.x;</div><div class=\"line\">        <span class=\"keyword\">float</span> y = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.y + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.y + t * t * pointF3.y;</div><div class=\"line\">        circleCenter.set(x, y);</div><div class=\"line\">        ball.layout((<span class=\"keyword\">int</span>) (circleCenter.x - ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.y - ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.x + ball.getMeasuredWidth() / <span class=\"number\">2</span>), (<span class=\"keyword\">int</span>) (circleCenter.y + ball.getMeasuredWidth() / <span class=\"number\">2</span>));</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 计算档次</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> x 横坐标</div><div class=\"line\">     * <span class=\"doctag\">@return</span> 档次</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getLevel</span><span class=\"params\">(<span class=\"keyword\">float</span> x)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> ratio = (x / (right - left)) * LEVEL;</div><div class=\"line\">        <span class=\"comment\">// 计算距离哪个档次最近</span></div><div class=\"line\">        <span class=\"keyword\">int</span> result = <span class=\"keyword\">new</span> BigDecimal(ratio).setScale(<span class=\"number\">0</span>, BigDecimal.ROUND_HALF_UP).intValue();</div><div class=\"line\">        <span class=\"keyword\">if</span> (result &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\">            result = <span class=\"number\">1</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (result &gt; (LEVEL - <span class=\"number\">1</span>)) &#123;</div><div class=\"line\">            result = (<span class=\"keyword\">int</span>) (LEVEL - <span class=\"number\">1</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> result;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onSmoothScroll</span><span class=\"params\">(<span class=\"keyword\">int</span> currentX)</span> </span>&#123;</div><div class=\"line\">        changeBallLayout(currentX);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 滑动接口</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnProgressChangedListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>SeekBarArcView代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SeekBarArcView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Path path;</div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1; <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2; <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3; <span class=\"comment\">// 终止点</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarArcView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarArcView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarArcView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        path = <span class=\"keyword\">new</span> Path();</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">4</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top - <span class=\"number\">30</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画2阶贝塞尔曲线</span></div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.GRAY);</div><div class=\"line\">        paint.setStrokeWidth(<span class=\"number\">10</span>);</div><div class=\"line\">        paint.setStyle(Paint.Style.STROKE);</div><div class=\"line\">        path.moveTo(pointF1.x, pointF1.y);</div><div class=\"line\">        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);</div><div class=\"line\">        canvas.drawPath(path, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>SeekBarBallView代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SeekBarBallView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller scroller;</div><div class=\"line\">    <span class=\"keyword\">private</span> OnSmoothScrollListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarBallView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarBallView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SeekBarBallView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        scroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnSmoothScrollListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onMeasure</span><span class=\"params\">(<span class=\"keyword\">int</span> widthMeasureSpec, <span class=\"keyword\">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class=\"line\">        setMeasuredDimension(widthMeasureSpec, widthMeasureSpec);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scroller.computeScrollOffset()) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                listener.onSmoothScroll(scroller.getCurrX());</div><div class=\"line\">                postInvalidate();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">        paint.reset();</div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.WHITE);</div><div class=\"line\">        paint.setStyle(Paint.Style.FILL);</div><div class=\"line\">        canvas.drawCircle(getMeasuredWidth() / <span class=\"number\">2</span>, getMeasuredWidth() / <span class=\"number\">2</span>, getMeasuredWidth() / <span class=\"number\">2</span>, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 平滑滑动</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> start    起始值</div><div class=\"line\">     * <span class=\"doctag\">@param</span> distance 滑动距离</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">smoothScrollLevel</span><span class=\"params\">(<span class=\"keyword\">int</span> start, <span class=\"keyword\">int</span> distance)</span> </span>&#123;</div><div class=\"line\">        scroller.startScroll(start, <span class=\"number\">0</span>, distance, <span class=\"number\">0</span>, <span class=\"number\">200</span>);</div><div class=\"line\">        postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnSmoothScrollListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onSmoothScroll</span><span class=\"params\">(<span class=\"keyword\">int</span> currentX)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到代码基本都是差不多的，只不过我将之前的View拆分成一个ViewGroup，绘制弧线的<code>SeekBarArcView</code>和绘制圆球的<code>SeekBarBallView</code>。在ACTION_MOVE的时候，我只是使用ball.layout()方法，即只改变圆球的layout，而没有重绘整个SeekBar。</p>\n<p>添加xml引用：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.customarcseekbar</span><span class=\"selector-class\">.seekbar</span><span class=\"selector-class\">.ArcSeekBarParent</span></div><div class=\"line\">    android:id=<span class=\"string\">\"@+id/seek_bar\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"100dp\"</span></div><div class=\"line\">    android:layout_marginTop=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">    android:<span class=\"attribute\">background</span>=<span class=\"string\">\"@color/colorAccent\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.customarcseekbar</span><span class=\"selector-class\">.seekbar</span><span class=\"selector-class\">.SeekBarArcView</span></div><div class=\"line\">        android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"match_parent\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.customarcseekbar</span><span class=\"selector-class\">.seekbar</span><span class=\"selector-class\">.SeekBarBallView</span></div><div class=\"line\">        android:layout_width=<span class=\"string\">\"20dp\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"100dp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;/com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.lovesixgod</span><span class=\"selector-class\">.customarcseekbar</span><span class=\"selector-class\">.seekbar</span><span class=\"selector-class\">.ArcSeekBarParent</span>&gt;</div></pre></td></tr></table></figure></p>\n<p>然后运行，进行滑动。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/new-seekbar2.png\" alt=\"\"><br>可以看到GPU分析显示的线条基本不会超过绿线，滑起来也没有明显的卡顿，问题应该算是解决了~</p>\n<p>代码已更新至<a href=\"https://github.com/LiJia92/CustomArcSeekBar\">Github</a>。</p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ol>\n<li>自定义View的时候尽量避免不变View的重绘。因为弧形线这个View是没有任何改变的，但是还不停地重绘，可能就会导致这样的性能问题了。</li>\n<li>Scroller的使用是针对View的，对于ViewGroup好像是无效的，所以我将Scroller写在了<code>SeekBarBallView</code>中。另外Scroller要能正常使用，在<code>startScroll()</code>以及<code>computeScroll()</code>需要<code>invalidate()</code>或者<code>postInvalidate</code>。</li>\n<li>多使用相关工具，来观察代码的性能。</li>\n</ol>"},{"title":"Android Studio中使用.9（Nine Patch）图","date":"2015-11-23T02:09:38.000Z","_content":"\n本文主要结合Android Studio讲述一下.9图片的原理与使用。\n\n---\n## 原理\n在Android的设计过程中，为了适配不同的手机分辨率，图片大多需要拉伸或者压缩，这样就出现了可以任意调整大小的一种图片格式“.9.png”。这种图片是用于Android开发的一种特殊的图片格式，它的好处在于可以用简单的方式把一张图片中哪些区域可以拉伸，哪些区域不可以拉伸设定好，同时可以把显示内容区域的位置标示清楚。\n\n.9图片相比普通图片，在四条边会多出1px的空隙，我们在这1px的空隙中画上黑线，即可控制图片怎么拉伸，内容区域的位置。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch1.png)\n讲解一下四条边的作用：\n\n 1. Top，图中1所示，是控制图片可横向拉伸的区域。\n 2. Left，图中2所示，是控制图片可纵向拉伸的区域。\n 3. Right&Botton，图中的3与4，结合起来控制内容显示的区域。\n\n<!--more-->\n\n---\n## 使用\n我们在Android Studio中新建一个项目，选择一张普通图片，置于drawable目录下。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch2.png)\n\n下面我们将它改为.9图片。在Android Studio中使用.9图很简单：<font color=red>直接将图片名称以\".9.png\"结束。\n使用.9图必须注意一点：文件的后缀名必须是.9.png，不能是.png或者是.9.png.png，这样的命名都会导致编译失败。</font>\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch3.png)\n\n将名称改好之后，重新打开图片，可以看到图片下面会有2个Tab，切换到``9-Patch``即可配置.9图片了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch4.png)\n\n下面做如下配置：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch5.png)\n\n在右边的效果图中，纵向只拉伸了Left所画黑线对应的区域，横向只拉伸了Top所画黑线对应的区域。至于Right与Bottom，我们可以通过勾选下方的Show content让其显示内容区域。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch6.png)\n\n可以看到，这里上下左右四条黑边的作用确实如原理中所说。\n图中效果很难看，改成这样：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch7.png)\n看起来效果还不错，这样我们可以尽情的配置图片该如何拉伸，针对不同分辨率，以达到一个更好的效果。\n\n## 解惑\n起初对Right与Bottom这2条边限定的内容区域不太了解，便做了个小测试。\n将2条边改成如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch8.png)\n然后布局文件里引入一个TextView，将background设置为此.9图片。\n```\n<TextView\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:layout_centerInParent=\"true\"\n        android:background=\"@drawable/ninepatch\"\n        android:text=\"Hello World!\" />\n```\n运行后的效果：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch9.png)\n可以看到“Hello World！”显示在了图片的右下方。\nRight与Bottom这2条边限定的内容区域所起的作用便一目了然了。\n","source":"_posts/nine-patch.md","raw":"---\ntitle: Android Studio中使用.9（Nine Patch）图\ndate: 2015-11-23 10:09:38\ntags:\n - android studio\n - 日常开发\n---\n\n本文主要结合Android Studio讲述一下.9图片的原理与使用。\n\n---\n## 原理\n在Android的设计过程中，为了适配不同的手机分辨率，图片大多需要拉伸或者压缩，这样就出现了可以任意调整大小的一种图片格式“.9.png”。这种图片是用于Android开发的一种特殊的图片格式，它的好处在于可以用简单的方式把一张图片中哪些区域可以拉伸，哪些区域不可以拉伸设定好，同时可以把显示内容区域的位置标示清楚。\n\n.9图片相比普通图片，在四条边会多出1px的空隙，我们在这1px的空隙中画上黑线，即可控制图片怎么拉伸，内容区域的位置。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch1.png)\n讲解一下四条边的作用：\n\n 1. Top，图中1所示，是控制图片可横向拉伸的区域。\n 2. Left，图中2所示，是控制图片可纵向拉伸的区域。\n 3. Right&Botton，图中的3与4，结合起来控制内容显示的区域。\n\n<!--more-->\n\n---\n## 使用\n我们在Android Studio中新建一个项目，选择一张普通图片，置于drawable目录下。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch2.png)\n\n下面我们将它改为.9图片。在Android Studio中使用.9图很简单：<font color=red>直接将图片名称以\".9.png\"结束。\n使用.9图必须注意一点：文件的后缀名必须是.9.png，不能是.png或者是.9.png.png，这样的命名都会导致编译失败。</font>\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch3.png)\n\n将名称改好之后，重新打开图片，可以看到图片下面会有2个Tab，切换到``9-Patch``即可配置.9图片了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch4.png)\n\n下面做如下配置：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch5.png)\n\n在右边的效果图中，纵向只拉伸了Left所画黑线对应的区域，横向只拉伸了Top所画黑线对应的区域。至于Right与Bottom，我们可以通过勾选下方的Show content让其显示内容区域。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch6.png)\n\n可以看到，这里上下左右四条黑边的作用确实如原理中所说。\n图中效果很难看，改成这样：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch7.png)\n看起来效果还不错，这样我们可以尽情的配置图片该如何拉伸，针对不同分辨率，以达到一个更好的效果。\n\n## 解惑\n起初对Right与Bottom这2条边限定的内容区域不太了解，便做了个小测试。\n将2条边改成如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch8.png)\n然后布局文件里引入一个TextView，将background设置为此.9图片。\n```\n<TextView\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:layout_centerInParent=\"true\"\n        android:background=\"@drawable/ninepatch\"\n        android:text=\"Hello World!\" />\n```\n运行后的效果：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch9.png)\n可以看到“Hello World！”显示在了图片的右下方。\nRight与Bottom这2条边限定的内容区域所起的作用便一目了然了。\n","slug":"nine-patch","published":1,"updated":"2016-11-21T10:02:08.900Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759q00261cb810vu5jri","content":"<p>本文主要结合Android Studio讲述一下.9图片的原理与使用。</p>\n<hr>\n<h2 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h2><p>在Android的设计过程中，为了适配不同的手机分辨率，图片大多需要拉伸或者压缩，这样就出现了可以任意调整大小的一种图片格式“.9.png”。这种图片是用于Android开发的一种特殊的图片格式，它的好处在于可以用简单的方式把一张图片中哪些区域可以拉伸，哪些区域不可以拉伸设定好，同时可以把显示内容区域的位置标示清楚。</p>\n<p>.9图片相比普通图片，在四条边会多出1px的空隙，我们在这1px的空隙中画上黑线，即可控制图片怎么拉伸，内容区域的位置。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch1.png\" alt=\"这里写图片描述\"><br>讲解一下四条边的作用：</p>\n<ol>\n<li>Top，图中1所示，是控制图片可横向拉伸的区域。</li>\n<li>Left，图中2所示，是控制图片可纵向拉伸的区域。</li>\n<li>Right&amp;Botton，图中的3与4，结合起来控制内容显示的区域。</li>\n</ol>\n<a id=\"more\"></a>\n<hr>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>我们在Android Studio中新建一个项目，选择一张普通图片，置于drawable目录下。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch2.png\" alt=\"这里写图片描述\"></p>\n<p>下面我们将它改为.9图片。在Android Studio中使用.9图很简单：<font color=\"red\">直接将图片名称以”.9.png”结束。<br>使用.9图必须注意一点：文件的后缀名必须是.9.png，不能是.png或者是.9.png.png，这样的命名都会导致编译失败。</font><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch3.png\" alt=\"这里写图片描述\"></p>\n<p>将名称改好之后，重新打开图片，可以看到图片下面会有2个Tab，切换到<code>9-Patch</code>即可配置.9图片了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch4.png\" alt=\"这里写图片描述\"></p>\n<p>下面做如下配置：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch5.png\" alt=\"这里写图片描述\"></p>\n<p>在右边的效果图中，纵向只拉伸了Left所画黑线对应的区域，横向只拉伸了Top所画黑线对应的区域。至于Right与Bottom，我们可以通过勾选下方的Show content让其显示内容区域。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch6.png\" alt=\"这里写图片描述\"></p>\n<p>可以看到，这里上下左右四条黑边的作用确实如原理中所说。<br>图中效果很难看，改成这样：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch7.png\" alt=\"这里写图片描述\"><br>看起来效果还不错，这样我们可以尽情的配置图片该如何拉伸，针对不同分辨率，以达到一个更好的效果。</p>\n<h2 id=\"解惑\"><a href=\"#解惑\" class=\"headerlink\" title=\"解惑\"></a>解惑</h2><p>起初对Right与Bottom这2条边限定的内容区域不太了解，便做了个小测试。<br>将2条边改成如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch8.png\" alt=\"这里写图片描述\"><br>然后布局文件里引入一个TextView，将background设置为此.9图片。<br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;TextView</div><div class=\"line\">        android:layout_width=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        android:layout_centerInParent=<span class=\"string\">\"true\"</span></div><div class=\"line\">        android:<span class=\"built_in\">background</span>=<span class=\"string\">\"@drawable/ninepatch\"</span></div><div class=\"line\">        android:<span class=\"built_in\">text</span>=<span class=\"string\">\"Hello World!\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>运行后的效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch9.png\" alt=\"这里写图片描述\"><br>可以看到“Hello World！”显示在了图片的右下方。<br>Right与Bottom这2条边限定的内容区域所起的作用便一目了然了。</p>\n","excerpt":"<p>本文主要结合Android Studio讲述一下.9图片的原理与使用。</p>\n<hr>\n<h2 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h2><p>在Android的设计过程中，为了适配不同的手机分辨率，图片大多需要拉伸或者压缩，这样就出现了可以任意调整大小的一种图片格式“.9.png”。这种图片是用于Android开发的一种特殊的图片格式，它的好处在于可以用简单的方式把一张图片中哪些区域可以拉伸，哪些区域不可以拉伸设定好，同时可以把显示内容区域的位置标示清楚。</p>\n<p>.9图片相比普通图片，在四条边会多出1px的空隙，我们在这1px的空隙中画上黑线，即可控制图片怎么拉伸，内容区域的位置。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch1.png\" alt=\"这里写图片描述\"><br>讲解一下四条边的作用：</p>\n<ol>\n<li>Top，图中1所示，是控制图片可横向拉伸的区域。</li>\n<li>Left，图中2所示，是控制图片可纵向拉伸的区域。</li>\n<li>Right&amp;Botton，图中的3与4，结合起来控制内容显示的区域。</li>\n</ol>","more":"<hr>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>我们在Android Studio中新建一个项目，选择一张普通图片，置于drawable目录下。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch2.png\" alt=\"这里写图片描述\"></p>\n<p>下面我们将它改为.9图片。在Android Studio中使用.9图很简单：<font color=red>直接将图片名称以”.9.png”结束。<br>使用.9图必须注意一点：文件的后缀名必须是.9.png，不能是.png或者是.9.png.png，这样的命名都会导致编译失败。</font><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch3.png\" alt=\"这里写图片描述\"></p>\n<p>将名称改好之后，重新打开图片，可以看到图片下面会有2个Tab，切换到<code>9-Patch</code>即可配置.9图片了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch4.png\" alt=\"这里写图片描述\"></p>\n<p>下面做如下配置：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch5.png\" alt=\"这里写图片描述\"></p>\n<p>在右边的效果图中，纵向只拉伸了Left所画黑线对应的区域，横向只拉伸了Top所画黑线对应的区域。至于Right与Bottom，我们可以通过勾选下方的Show content让其显示内容区域。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch6.png\" alt=\"这里写图片描述\"></p>\n<p>可以看到，这里上下左右四条黑边的作用确实如原理中所说。<br>图中效果很难看，改成这样：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch7.png\" alt=\"这里写图片描述\"><br>看起来效果还不错，这样我们可以尽情的配置图片该如何拉伸，针对不同分辨率，以达到一个更好的效果。</p>\n<h2 id=\"解惑\"><a href=\"#解惑\" class=\"headerlink\" title=\"解惑\"></a>解惑</h2><p>起初对Right与Bottom这2条边限定的内容区域不太了解，便做了个小测试。<br>将2条边改成如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch8.png\" alt=\"这里写图片描述\"><br>然后布局文件里引入一个TextView，将background设置为此.9图片。<br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;TextView</div><div class=\"line\">        android:layout_width=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        android:layout_height=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        android:layout_centerInParent=<span class=\"string\">\"true\"</span></div><div class=\"line\">        android:<span class=\"built_in\">background</span>=<span class=\"string\">\"@drawable/ninepatch\"</span></div><div class=\"line\">        android:<span class=\"built_in\">text</span>=<span class=\"string\">\"Hello World!\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>运行后的效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/nine-patch9.png\" alt=\"这里写图片描述\"><br>可以看到“Hello World！”显示在了图片的右下方。<br>Right与Bottom这2条边限定的内容区域所起的作用便一目了然了。</p>"},{"title":"Android Notification使用小记","date":"2016-01-11T12:46:50.000Z","_content":"\n## 介绍\n最近的项目中，需要用到Notification。上一下效果图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/notification1.png)\n\n首先，学习一下关于Notification的基本知识。\n\n状态通知栏主要涉及到2个类：  Notification 和 NotificationManager 。\nNotification为通知信息类，它里面对应了通知栏的各个属性。\nNotificationManager ：  是状态栏通知的管理类，负责发通知、清除通知等操作。\n注意：NotificationManager 是一个系统Service，必须通过 getSystemService(NOTIFICATION_SERVICE)方法来获取：\n```\nmNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);\n```\n自定义Notification大致分为以下几步：\n\n 1. 自定义布局；\n 2. 使用NotificationCompat.Builder创建Notification。使用RemoteViews填充自定义布局，然后通过setContent()添加到Builder中；\n 3. 使用广播，添加按钮点击事件；\n 4. NotificationManager.notify()将Notification显示到手机状态栏。\n\n下面结合代码进行说明。\n\n<!--more-->\n\n## 代码\n第一步，对应于Notification的布局文件：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:gravity=\"center\"\n    android:orientation=\"horizontal\">\n\n    <ImageView\n        android:id=\"@+id/music_cover\"\n        android:layout_width=\"64dp\"\n        android:layout_height=\"wrap_content\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/mia\" />\n\n    <LinearLayout\n        android:layout_width=\"0dp\"\n        android:layout_height=\"match_parent\"\n        android:layout_weight=\"1\"\n        android:gravity=\"center\"\n        android:orientation=\"vertical\">\n\n        <TextView\n            android:id=\"@+id/music_name\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:ellipsize=\"end\"\n            android:singleLine=\"true\"\n            android:text=\"无与伦比的美丽\" />\n\n        <TextView\n            android:id=\"@+id/singer_name\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:ellipsize=\"end\"\n            android:singleLine=\"true\"\n            android:text=\"苏打绿\" />\n    </LinearLayout>\n\n    <ImageView\n        android:id=\"@+id/pause\"\n        android:layout_width=\"48dp\"\n        android:layout_height=\"wrap_content\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/button_pause\" />\n\n    <ImageView\n        android:id=\"@+id/play\"\n        android:layout_width=\"48dp\"\n        android:layout_height=\"wrap_content\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/button_play\"\n        android:visibility=\"gone\" />\n\n    <ImageView\n        android:id=\"@+id/next\"\n        android:layout_width=\"48dp\"\n        android:layout_height=\"wrap_content\"\n        android:layout_marginLeft=\"8dp\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/btn_next\" />\n\n    <ImageView\n        android:id=\"@+id/delete\"\n        android:layout_width=\"48dp\"\n        android:layout_height=\"wrap_content\"\n        android:layout_marginLeft=\"8dp\"\n        android:layout_marginRight=\"8dp\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/search_delete\" />\n\n\n</LinearLayout>\n\n\n```\n布局文件很简单，不做过多叙述。\n\n再来看到Notification的创建。\n```\npublic class PlayerService extends Service {\n    // 广播Action\n    private final static String NOTIFICATION_PLAY_ACTION = \"com.notifications.intent.action.PlayClick\";\n    private final static String NOTIFICATION_PAUSE_ACTION = \"com.notifications.intent.action.PauseClick\";\n    private final static String NOTIFICATION_NEXT_ACTION = \"com.notifications.intent.action.NextClick\";\n    private final static String NOTIFICATION_DELETE_ACTION = \"com.notifications.intent.action.DeleteClick\";\n    // 自定义Notification\n    private NotificationManager mNotificationManager = null;\n    private PendingIntent contentIntent;\n    private NotificationCompat.Builder builder;\n    private Notification notification;\n    private RemoteViews contentView; // 自定义Notification，接收布局\n    private PlayerService service = this;\n    private BroadcastReceiver onClickReceiver; // 注册广播接收点击事件\n\n    @Override\n    public void onCreate() {\n        mNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);\n        contentIntent = PendingIntent.getActivity(this, 0, new Intent(this, MusicPlayActivity.class), 0);\n        contentView = new RemoteViews(getPackageName(), R.layout.custom_notification);\n        builder = new NotificationCompat.Builder(this);\n        notification = builder\n                .setContentIntent(contentIntent)\n                .setWhen(System.currentTimeMillis())\n                .setSmallIcon(R.drawable.mia)\n                .setContent(contentView)\n                .build();\n        notification.flags = Notification.FLAG_NO_CLEAR; // 注意Flag，会影响是否能cancel\n\n        // 播放\n        Intent playIntent = new Intent(NOTIFICATION_PLAY_ACTION);\n        PendingIntent play = PendingIntent.getBroadcast(this, 0, playIntent, 0);\n        contentView.setOnClickPendingIntent(R.id.play, play);\n        // 暂停\n        Intent pauseIntent = new Intent(NOTIFICATION_PAUSE_ACTION);\n        PendingIntent pause = PendingIntent.getBroadcast(this, 0, pauseIntent, 0);\n        contentView.setOnClickPendingIntent(R.id.pause, pause);\n        // 下一首\n        Intent nextIntent = new Intent(NOTIFICATION_NEXT_ACTION);\n        PendingIntent next = PendingIntent.getBroadcast(this, 0, nextIntent, 0);\n        contentView.setOnClickPendingIntent(R.id.next, next);\n        // 关闭\n        Intent deleteIntent = new Intent(NOTIFICATION_DELETE_ACTION);\n        final PendingIntent delete = PendingIntent.getBroadcast(this, 0, deleteIntent, 0);\n        contentView.setOnClickPendingIntent(R.id.delete, delete);\n\n        // Notification中按钮点击事件需注册广播\n        onClickReceiver = new BroadcastReceiver() {\n            @Override\n            public void onReceive(Context context, Intent intent) {\n                String action = intent.getAction();\n                switch (action) {\n                    case NOTIFICATION_PLAY_ACTION:\n                        contentView.setViewVisibility(R.id.play, View.GONE);\n                        contentView.setViewVisibility(R.id.pause, View.VISIBLE);\n                        if (!service.isPlaying()) {\n                            service.resume(); // 继续播放\n                        }\n                        mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);\n                        break;\n                    case NOTIFICATION_PAUSE_ACTION:\n                        contentView.setViewVisibility(R.id.pause, View.GONE);\n                        contentView.setViewVisibility(R.id.play, View.VISIBLE);\n                        if (service.isPlaying()) {\n                            service.pause(); // 暂停\n                        }\n                        mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);\n                        break;\n                    case NOTIFICATION_NEXT_ACTION:\n                        service.next(); // 下一首\n                        break;\n                    case NOTIFICATION_DELETE_ACTION:\n                        service.stop();\n                        break;\n                    default:\n                        break;\n                }\n            }\n        };\n        IntentFilter filter = new IntentFilter();\n        filter.addAction(NOTIFICATION_PLAY_ACTION);\n        filter.addAction(NOTIFICATION_PAUSE_ACTION);\n        filter.addAction(NOTIFICATION_NEXT_ACTION);\n        filter.addAction(NOTIFICATION_DELETE_ACTION);\n        registerReceiver(onClickReceiver, filter);\n    }\n\n```\n播放音乐使用的自然是Service了。于是我定义了PlayerService继承自Service，声明相应的变量，然后在onCreate()中进行初始化。\n\n我们可以看到，代码中使用``RemoteViews``填充了布局，并将其设置到Notification创建的Builder中。\n\nRemoteViews不同于View，它不能通过findViewById()来获取View控件。它里面的控件的点击事件必须通过``setOnClickPendingIntent()``来进行设置。它有2个参数，1个是控件ID，另外1个是进行处理的PendingIntent。PendingIntent的创建必须通过广播的方式来实现。重复下上面的代码：\n```\nIntent playIntent = new Intent(NOTIFICATION_PLAY_ACTION);\nPendingIntent play = PendingIntent.getBroadcast(this, 0, playIntent, 0);\ncontentView.setOnClickPendingIntent(R.id.play, play);\n```\n然后在广播的onReceive()方法中，判断是哪个控件被点击。然后执行相应的逻辑。\n\n记得广播一定要先注册才能使用。\n\n最后，便是将Notification显示到手机了。\n```\nfinal Track track = getCurrentEntry().getTrack();\nImageLoader.getInstance().loadImage(track.getUrl(), new SimpleImageLoadingListener() {\n                @Override\n                public void onLoadingComplete(String imageUri, View view, Bitmap loadedImage) {\n                    contentView.setImageViewBitmap(R.id.music_cover, loadedImage);\n                    contentView.setTextViewText(R.id.music_name, track.getName());\n                    contentView.setTextViewText(R.id.singer_name, track.getSinger());\n                    mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);\n                }\n            });\n```\nTrack是我进行音乐播放的一个Model类。包含一些播放音乐的基本信息。这里我是通过的Universal-Image-Loader进行图片加载。在其加载成功后的回调中，通过``setTextViewText()``等类似方法给控件设值。也是有2个参数，第1个是控件Id，第二个便是要设置的值。\n最后通过``mNotificationManager.notify(PLAYING_NOTIFY_ID, notification)``将Notification显示到手机。\n\n经过上述几个步骤，自定义Notification便能显示到手机了，并且具备点击事件。\n\n## Tips\n\n 1. 自定义布局仅支持FrameLayout、LinearLayout、RelativeLayout三种布局控件和AnalogClock、Chronometer、Button、ImageButton、ImageView、ProgressBar、TextView、ViewFlipper、ListView、GridView、StackView和AdapterViewFlipper这些显示控件，不支持这些类的子类或Android提供的其他控件，否则会引起ClassNotFoundException异常。\n之前播放的按钮打算用ToggleButton，使用之后发现显示不了，后面才找到原因。\n 2. Notification属于系统级别的组件，使用了RemoteViews的setViewVisibility()、setTextViewText()等方法后，必须通知系统重绘才能更新UI，最简单的方式就是重新notify一下。只要传入的Id一样，就会覆盖掉之前的通知。\n在播放、暂停按钮切换的时候，就碰到这个问题，一直不能显示，加上notify语句后就能正常执行了。\n 3. 关于Notification的取消。\n使用``mNotificationManager.cancel(PLAYING_NOTIFY_ID)``即可。但是一定要注意Notification的flag。这里补充下Notification的标识符。\n提醒标志符成员：\nNotification.FLAG_SHOW_LIGHTS              //三色灯提醒，在使用三色灯提醒时候必须加该标志符\nNotification.FLAG_ONGOING_EVENT          //发起正在运行事件（活动中）\nNotification.FLAG_INSISTENT   //让声音、振动无限循环，直到用户响应 （取消或者打开）\nNotification.FLAG_ONLY_ALERT_ONCE  //发起Notification后，铃声和震动均只执行一次\nNotification.FLAG_AUTO_CANCEL      //用户单击通知后自动消失\nNotification.FLAG_NO_CLEAR          //只有全部清除时，Notification才会清除 ，不清楚该通知(QQ的通知无法清除，就是用的这个)\nNotification.FLAG_FOREGROUND_SERVICE    //表示正在运行的服务\n我当时使用的FLAG_FOREGROUND_SERVICE，导致cancel一直关闭不了Notification，更换flag后就能关闭了。\n","source":"_posts/notification.md","raw":"---\ntitle: Android Notification使用小记\ndate: 2016-01-11 20:46:50\ntags:\n - 日常开发\n---\n\n## 介绍\n最近的项目中，需要用到Notification。上一下效果图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/notification1.png)\n\n首先，学习一下关于Notification的基本知识。\n\n状态通知栏主要涉及到2个类：  Notification 和 NotificationManager 。\nNotification为通知信息类，它里面对应了通知栏的各个属性。\nNotificationManager ：  是状态栏通知的管理类，负责发通知、清除通知等操作。\n注意：NotificationManager 是一个系统Service，必须通过 getSystemService(NOTIFICATION_SERVICE)方法来获取：\n```\nmNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);\n```\n自定义Notification大致分为以下几步：\n\n 1. 自定义布局；\n 2. 使用NotificationCompat.Builder创建Notification。使用RemoteViews填充自定义布局，然后通过setContent()添加到Builder中；\n 3. 使用广播，添加按钮点击事件；\n 4. NotificationManager.notify()将Notification显示到手机状态栏。\n\n下面结合代码进行说明。\n\n<!--more-->\n\n## 代码\n第一步，对应于Notification的布局文件：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:gravity=\"center\"\n    android:orientation=\"horizontal\">\n\n    <ImageView\n        android:id=\"@+id/music_cover\"\n        android:layout_width=\"64dp\"\n        android:layout_height=\"wrap_content\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/mia\" />\n\n    <LinearLayout\n        android:layout_width=\"0dp\"\n        android:layout_height=\"match_parent\"\n        android:layout_weight=\"1\"\n        android:gravity=\"center\"\n        android:orientation=\"vertical\">\n\n        <TextView\n            android:id=\"@+id/music_name\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:ellipsize=\"end\"\n            android:singleLine=\"true\"\n            android:text=\"无与伦比的美丽\" />\n\n        <TextView\n            android:id=\"@+id/singer_name\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:ellipsize=\"end\"\n            android:singleLine=\"true\"\n            android:text=\"苏打绿\" />\n    </LinearLayout>\n\n    <ImageView\n        android:id=\"@+id/pause\"\n        android:layout_width=\"48dp\"\n        android:layout_height=\"wrap_content\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/button_pause\" />\n\n    <ImageView\n        android:id=\"@+id/play\"\n        android:layout_width=\"48dp\"\n        android:layout_height=\"wrap_content\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/button_play\"\n        android:visibility=\"gone\" />\n\n    <ImageView\n        android:id=\"@+id/next\"\n        android:layout_width=\"48dp\"\n        android:layout_height=\"wrap_content\"\n        android:layout_marginLeft=\"8dp\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/btn_next\" />\n\n    <ImageView\n        android:id=\"@+id/delete\"\n        android:layout_width=\"48dp\"\n        android:layout_height=\"wrap_content\"\n        android:layout_marginLeft=\"8dp\"\n        android:layout_marginRight=\"8dp\"\n        android:scaleType=\"centerCrop\"\n        android:src=\"@drawable/search_delete\" />\n\n\n</LinearLayout>\n\n\n```\n布局文件很简单，不做过多叙述。\n\n再来看到Notification的创建。\n```\npublic class PlayerService extends Service {\n    // 广播Action\n    private final static String NOTIFICATION_PLAY_ACTION = \"com.notifications.intent.action.PlayClick\";\n    private final static String NOTIFICATION_PAUSE_ACTION = \"com.notifications.intent.action.PauseClick\";\n    private final static String NOTIFICATION_NEXT_ACTION = \"com.notifications.intent.action.NextClick\";\n    private final static String NOTIFICATION_DELETE_ACTION = \"com.notifications.intent.action.DeleteClick\";\n    // 自定义Notification\n    private NotificationManager mNotificationManager = null;\n    private PendingIntent contentIntent;\n    private NotificationCompat.Builder builder;\n    private Notification notification;\n    private RemoteViews contentView; // 自定义Notification，接收布局\n    private PlayerService service = this;\n    private BroadcastReceiver onClickReceiver; // 注册广播接收点击事件\n\n    @Override\n    public void onCreate() {\n        mNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);\n        contentIntent = PendingIntent.getActivity(this, 0, new Intent(this, MusicPlayActivity.class), 0);\n        contentView = new RemoteViews(getPackageName(), R.layout.custom_notification);\n        builder = new NotificationCompat.Builder(this);\n        notification = builder\n                .setContentIntent(contentIntent)\n                .setWhen(System.currentTimeMillis())\n                .setSmallIcon(R.drawable.mia)\n                .setContent(contentView)\n                .build();\n        notification.flags = Notification.FLAG_NO_CLEAR; // 注意Flag，会影响是否能cancel\n\n        // 播放\n        Intent playIntent = new Intent(NOTIFICATION_PLAY_ACTION);\n        PendingIntent play = PendingIntent.getBroadcast(this, 0, playIntent, 0);\n        contentView.setOnClickPendingIntent(R.id.play, play);\n        // 暂停\n        Intent pauseIntent = new Intent(NOTIFICATION_PAUSE_ACTION);\n        PendingIntent pause = PendingIntent.getBroadcast(this, 0, pauseIntent, 0);\n        contentView.setOnClickPendingIntent(R.id.pause, pause);\n        // 下一首\n        Intent nextIntent = new Intent(NOTIFICATION_NEXT_ACTION);\n        PendingIntent next = PendingIntent.getBroadcast(this, 0, nextIntent, 0);\n        contentView.setOnClickPendingIntent(R.id.next, next);\n        // 关闭\n        Intent deleteIntent = new Intent(NOTIFICATION_DELETE_ACTION);\n        final PendingIntent delete = PendingIntent.getBroadcast(this, 0, deleteIntent, 0);\n        contentView.setOnClickPendingIntent(R.id.delete, delete);\n\n        // Notification中按钮点击事件需注册广播\n        onClickReceiver = new BroadcastReceiver() {\n            @Override\n            public void onReceive(Context context, Intent intent) {\n                String action = intent.getAction();\n                switch (action) {\n                    case NOTIFICATION_PLAY_ACTION:\n                        contentView.setViewVisibility(R.id.play, View.GONE);\n                        contentView.setViewVisibility(R.id.pause, View.VISIBLE);\n                        if (!service.isPlaying()) {\n                            service.resume(); // 继续播放\n                        }\n                        mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);\n                        break;\n                    case NOTIFICATION_PAUSE_ACTION:\n                        contentView.setViewVisibility(R.id.pause, View.GONE);\n                        contentView.setViewVisibility(R.id.play, View.VISIBLE);\n                        if (service.isPlaying()) {\n                            service.pause(); // 暂停\n                        }\n                        mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);\n                        break;\n                    case NOTIFICATION_NEXT_ACTION:\n                        service.next(); // 下一首\n                        break;\n                    case NOTIFICATION_DELETE_ACTION:\n                        service.stop();\n                        break;\n                    default:\n                        break;\n                }\n            }\n        };\n        IntentFilter filter = new IntentFilter();\n        filter.addAction(NOTIFICATION_PLAY_ACTION);\n        filter.addAction(NOTIFICATION_PAUSE_ACTION);\n        filter.addAction(NOTIFICATION_NEXT_ACTION);\n        filter.addAction(NOTIFICATION_DELETE_ACTION);\n        registerReceiver(onClickReceiver, filter);\n    }\n\n```\n播放音乐使用的自然是Service了。于是我定义了PlayerService继承自Service，声明相应的变量，然后在onCreate()中进行初始化。\n\n我们可以看到，代码中使用``RemoteViews``填充了布局，并将其设置到Notification创建的Builder中。\n\nRemoteViews不同于View，它不能通过findViewById()来获取View控件。它里面的控件的点击事件必须通过``setOnClickPendingIntent()``来进行设置。它有2个参数，1个是控件ID，另外1个是进行处理的PendingIntent。PendingIntent的创建必须通过广播的方式来实现。重复下上面的代码：\n```\nIntent playIntent = new Intent(NOTIFICATION_PLAY_ACTION);\nPendingIntent play = PendingIntent.getBroadcast(this, 0, playIntent, 0);\ncontentView.setOnClickPendingIntent(R.id.play, play);\n```\n然后在广播的onReceive()方法中，判断是哪个控件被点击。然后执行相应的逻辑。\n\n记得广播一定要先注册才能使用。\n\n最后，便是将Notification显示到手机了。\n```\nfinal Track track = getCurrentEntry().getTrack();\nImageLoader.getInstance().loadImage(track.getUrl(), new SimpleImageLoadingListener() {\n                @Override\n                public void onLoadingComplete(String imageUri, View view, Bitmap loadedImage) {\n                    contentView.setImageViewBitmap(R.id.music_cover, loadedImage);\n                    contentView.setTextViewText(R.id.music_name, track.getName());\n                    contentView.setTextViewText(R.id.singer_name, track.getSinger());\n                    mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);\n                }\n            });\n```\nTrack是我进行音乐播放的一个Model类。包含一些播放音乐的基本信息。这里我是通过的Universal-Image-Loader进行图片加载。在其加载成功后的回调中，通过``setTextViewText()``等类似方法给控件设值。也是有2个参数，第1个是控件Id，第二个便是要设置的值。\n最后通过``mNotificationManager.notify(PLAYING_NOTIFY_ID, notification)``将Notification显示到手机。\n\n经过上述几个步骤，自定义Notification便能显示到手机了，并且具备点击事件。\n\n## Tips\n\n 1. 自定义布局仅支持FrameLayout、LinearLayout、RelativeLayout三种布局控件和AnalogClock、Chronometer、Button、ImageButton、ImageView、ProgressBar、TextView、ViewFlipper、ListView、GridView、StackView和AdapterViewFlipper这些显示控件，不支持这些类的子类或Android提供的其他控件，否则会引起ClassNotFoundException异常。\n之前播放的按钮打算用ToggleButton，使用之后发现显示不了，后面才找到原因。\n 2. Notification属于系统级别的组件，使用了RemoteViews的setViewVisibility()、setTextViewText()等方法后，必须通知系统重绘才能更新UI，最简单的方式就是重新notify一下。只要传入的Id一样，就会覆盖掉之前的通知。\n在播放、暂停按钮切换的时候，就碰到这个问题，一直不能显示，加上notify语句后就能正常执行了。\n 3. 关于Notification的取消。\n使用``mNotificationManager.cancel(PLAYING_NOTIFY_ID)``即可。但是一定要注意Notification的flag。这里补充下Notification的标识符。\n提醒标志符成员：\nNotification.FLAG_SHOW_LIGHTS              //三色灯提醒，在使用三色灯提醒时候必须加该标志符\nNotification.FLAG_ONGOING_EVENT          //发起正在运行事件（活动中）\nNotification.FLAG_INSISTENT   //让声音、振动无限循环，直到用户响应 （取消或者打开）\nNotification.FLAG_ONLY_ALERT_ONCE  //发起Notification后，铃声和震动均只执行一次\nNotification.FLAG_AUTO_CANCEL      //用户单击通知后自动消失\nNotification.FLAG_NO_CLEAR          //只有全部清除时，Notification才会清除 ，不清楚该通知(QQ的通知无法清除，就是用的这个)\nNotification.FLAG_FOREGROUND_SERVICE    //表示正在运行的服务\n我当时使用的FLAG_FOREGROUND_SERVICE，导致cancel一直关闭不了Notification，更换flag后就能关闭了。\n","slug":"notification","published":1,"updated":"2016-11-21T10:02:13.972Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759s00281cb8jshjzrhi","content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>最近的项目中，需要用到Notification。上一下效果图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/notification1.png\" alt=\"这里写图片描述\"></p>\n<p>首先，学习一下关于Notification的基本知识。</p>\n<p>状态通知栏主要涉及到2个类：  Notification 和 NotificationManager 。<br>Notification为通知信息类，它里面对应了通知栏的各个属性。<br>NotificationManager ：  是状态栏通知的管理类，负责发通知、清除通知等操作。<br>注意：NotificationManager 是一个系统Service，必须通过 getSystemService(NOTIFICATION_SERVICE)方法来获取：<br><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mNotificationManager = (<span class=\"name\">NotificationManager</span>) getSystemService(<span class=\"name\">NOTIFICATION_SERVICE</span>)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>自定义Notification大致分为以下几步：</p>\n<ol>\n<li>自定义布局；</li>\n<li>使用NotificationCompat.Builder创建Notification。使用RemoteViews填充自定义布局，然后通过setContent()添加到Builder中；</li>\n<li>使用广播，添加按钮点击事件；</li>\n<li>NotificationManager.notify()将Notification显示到手机状态栏。</li>\n</ol>\n<p>下面结合代码进行说明。</p>\n<a id=\"more\"></a>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>第一步，对应于Notification的布局文件：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/music_cover\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"64dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/mia\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"0dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_weight</span>=<span class=\"string\">\"1\"</span></div><div class=\"line\">        <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/music_name\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:ellipsize</span>=<span class=\"string\">\"end\"</span></div><div class=\"line\">            <span class=\"attr\">android:singleLine</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"无与伦比的美丽\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/singer_name\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:ellipsize</span>=<span class=\"string\">\"end\"</span></div><div class=\"line\">            <span class=\"attr\">android:singleLine</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"苏打绿\"</span> /&gt;</div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/pause\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"48dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/button_pause\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/play\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"48dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/button_play\"</span></div><div class=\"line\">        <span class=\"attr\">android:visibility</span>=<span class=\"string\">\"gone\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/next\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"48dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/btn_next\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/delete\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"48dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginRight</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/search_delete\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>布局文件很简单，不做过多叙述。</p>\n<p>再来看到Notification的创建。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PlayerService</span> <span class=\"keyword\">extends</span> <span class=\"title\">Service</span> </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// 广播Action</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> String NOTIFICATION_PLAY_ACTION = <span class=\"string\">\"com.notifications.intent.action.PlayClick\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> String NOTIFICATION_PAUSE_ACTION = <span class=\"string\">\"com.notifications.intent.action.PauseClick\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> String NOTIFICATION_NEXT_ACTION = <span class=\"string\">\"com.notifications.intent.action.NextClick\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> String NOTIFICATION_DELETE_ACTION = <span class=\"string\">\"com.notifications.intent.action.DeleteClick\"</span>;</div><div class=\"line\">    <span class=\"comment\">// 自定义Notification</span></div><div class=\"line\">    <span class=\"keyword\">private</span> NotificationManager mNotificationManager = <span class=\"keyword\">null</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> PendingIntent contentIntent;</div><div class=\"line\">    <span class=\"keyword\">private</span> NotificationCompat.Builder builder;</div><div class=\"line\">    <span class=\"keyword\">private</span> Notification notification;</div><div class=\"line\">    <span class=\"keyword\">private</span> RemoteViews contentView; <span class=\"comment\">// 自定义Notification，接收布局</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PlayerService service = <span class=\"keyword\">this</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> BroadcastReceiver onClickReceiver; <span class=\"comment\">// 注册广播接收点击事件</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        mNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</div><div class=\"line\">        contentIntent = PendingIntent.getActivity(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, <span class=\"keyword\">new</span> Intent(<span class=\"keyword\">this</span>, MusicPlayActivity.class), <span class=\"number\">0</span>);</div><div class=\"line\">        contentView = <span class=\"keyword\">new</span> RemoteViews(getPackageName(), R.layout.custom_notification);</div><div class=\"line\">        builder = <span class=\"keyword\">new</span> NotificationCompat.Builder(<span class=\"keyword\">this</span>);</div><div class=\"line\">        notification = builder</div><div class=\"line\">                .setContentIntent(contentIntent)</div><div class=\"line\">                .setWhen(System.currentTimeMillis())</div><div class=\"line\">                .setSmallIcon(R.drawable.mia)</div><div class=\"line\">                .setContent(contentView)</div><div class=\"line\">                .build();</div><div class=\"line\">        notification.flags = Notification.FLAG_NO_CLEAR; <span class=\"comment\">// 注意Flag，会影响是否能cancel</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 播放</span></div><div class=\"line\">        Intent playIntent = <span class=\"keyword\">new</span> Intent(NOTIFICATION_PLAY_ACTION);</div><div class=\"line\">        PendingIntent play = PendingIntent.getBroadcast(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, playIntent, <span class=\"number\">0</span>);</div><div class=\"line\">        contentView.setOnClickPendingIntent(R.id.play, play);</div><div class=\"line\">        <span class=\"comment\">// 暂停</span></div><div class=\"line\">        Intent pauseIntent = <span class=\"keyword\">new</span> Intent(NOTIFICATION_PAUSE_ACTION);</div><div class=\"line\">        PendingIntent pause = PendingIntent.getBroadcast(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, pauseIntent, <span class=\"number\">0</span>);</div><div class=\"line\">        contentView.setOnClickPendingIntent(R.id.pause, pause);</div><div class=\"line\">        <span class=\"comment\">// 下一首</span></div><div class=\"line\">        Intent nextIntent = <span class=\"keyword\">new</span> Intent(NOTIFICATION_NEXT_ACTION);</div><div class=\"line\">        PendingIntent next = PendingIntent.getBroadcast(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, nextIntent, <span class=\"number\">0</span>);</div><div class=\"line\">        contentView.setOnClickPendingIntent(R.id.next, next);</div><div class=\"line\">        <span class=\"comment\">// 关闭</span></div><div class=\"line\">        Intent deleteIntent = <span class=\"keyword\">new</span> Intent(NOTIFICATION_DELETE_ACTION);</div><div class=\"line\">        <span class=\"keyword\">final</span> PendingIntent delete = PendingIntent.getBroadcast(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, deleteIntent, <span class=\"number\">0</span>);</div><div class=\"line\">        contentView.setOnClickPendingIntent(R.id.delete, delete);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Notification中按钮点击事件需注册广播</span></div><div class=\"line\">        onClickReceiver = <span class=\"keyword\">new</span> BroadcastReceiver() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onReceive</span><span class=\"params\">(Context context, Intent intent)</span> </span>&#123;</div><div class=\"line\">                String action = intent.getAction();</div><div class=\"line\">                <span class=\"keyword\">switch</span> (action) &#123;</div><div class=\"line\">                    <span class=\"keyword\">case</span> NOTIFICATION_PLAY_ACTION:</div><div class=\"line\">                        contentView.setViewVisibility(R.id.play, View.GONE);</div><div class=\"line\">                        contentView.setViewVisibility(R.id.pause, View.VISIBLE);</div><div class=\"line\">                        <span class=\"keyword\">if</span> (!service.isPlaying()) &#123;</div><div class=\"line\">                            service.resume(); <span class=\"comment\">// 继续播放</span></div><div class=\"line\">                        &#125;</div><div class=\"line\">                        mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> NOTIFICATION_PAUSE_ACTION:</div><div class=\"line\">                        contentView.setViewVisibility(R.id.pause, View.GONE);</div><div class=\"line\">                        contentView.setViewVisibility(R.id.play, View.VISIBLE);</div><div class=\"line\">                        <span class=\"keyword\">if</span> (service.isPlaying()) &#123;</div><div class=\"line\">                            service.pause(); <span class=\"comment\">// 暂停</span></div><div class=\"line\">                        &#125;</div><div class=\"line\">                        mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> NOTIFICATION_NEXT_ACTION:</div><div class=\"line\">                        service.next(); <span class=\"comment\">// 下一首</span></div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> NOTIFICATION_DELETE_ACTION:</div><div class=\"line\">                        service.stop();</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                    <span class=\"keyword\">default</span>:</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;;</div><div class=\"line\">        IntentFilter filter = <span class=\"keyword\">new</span> IntentFilter();</div><div class=\"line\">        filter.addAction(NOTIFICATION_PLAY_ACTION);</div><div class=\"line\">        filter.addAction(NOTIFICATION_PAUSE_ACTION);</div><div class=\"line\">        filter.addAction(NOTIFICATION_NEXT_ACTION);</div><div class=\"line\">        filter.addAction(NOTIFICATION_DELETE_ACTION);</div><div class=\"line\">        registerReceiver(onClickReceiver, filter);</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>播放音乐使用的自然是Service了。于是我定义了PlayerService继承自Service，声明相应的变量，然后在onCreate()中进行初始化。</p>\n<p>我们可以看到，代码中使用<code>RemoteViews</code>填充了布局，并将其设置到Notification创建的Builder中。</p>\n<p>RemoteViews不同于View，它不能通过findViewById()来获取View控件。它里面的控件的点击事件必须通过<code>setOnClickPendingIntent()</code>来进行设置。它有2个参数，1个是控件ID，另外1个是进行处理的PendingIntent。PendingIntent的创建必须通过广播的方式来实现。重复下上面的代码：<br><figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"type\">Intent</span> playIntent = <span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">Intent</span>(<span class=\"type\">NOTIFICATION_PLAY_ACTION</span>);</span></div><div class=\"line\"><span class=\"title\">PendingIntent</span> <span class=\"title\">play</span> = <span class=\"title\">PendingIntent</span>.<span class=\"title\">getBroadcast</span>(this, <span class=\"number\">0</span>, playIntent, <span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"title\">contentView</span>.<span class=\"title\">setOnClickPendingIntent</span>(<span class=\"type\">R</span>.id.play, play);</div></pre></td></tr></table></figure></p>\n<p>然后在广播的onReceive()方法中，判断是哪个控件被点击。然后执行相应的逻辑。</p>\n<p>记得广播一定要先注册才能使用。</p>\n<p>最后，便是将Notification显示到手机了。<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">final Track track = getCurrentEntry().getTrack()<span class=\"comment\">;</span></div><div class=\"line\">ImageLoader.getInstance().loadImage(track.getUrl(), new SimpleImageLoadingListener() &#123;</div><div class=\"line\">                @Override</div><div class=\"line\">                public void onLoadingComplete(String imageUri, View view, <span class=\"keyword\">Bitmap </span>loadedImage) &#123;</div><div class=\"line\">                    contentView.setImageViewBitmap(R.id.music_cover, loadedImage)<span class=\"comment\">;</span></div><div class=\"line\">                    contentView.setTextViewText(R.id.music_name, track.getName())<span class=\"comment\">;</span></div><div class=\"line\">                    contentView.setTextViewText(R.id.singer_name, track.getSinger())<span class=\"comment\">;</span></div><div class=\"line\">                    mNotificationManager.notify(PLAYING_NOTIFY_ID, notification)<span class=\"comment\">;</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>Track是我进行音乐播放的一个Model类。包含一些播放音乐的基本信息。这里我是通过的Universal-Image-Loader进行图片加载。在其加载成功后的回调中，通过<code>setTextViewText()</code>等类似方法给控件设值。也是有2个参数，第1个是控件Id，第二个便是要设置的值。<br>最后通过<code>mNotificationManager.notify(PLAYING_NOTIFY_ID, notification)</code>将Notification显示到手机。</p>\n<p>经过上述几个步骤，自定义Notification便能显示到手机了，并且具备点击事件。</p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><ol>\n<li>自定义布局仅支持FrameLayout、LinearLayout、RelativeLayout三种布局控件和AnalogClock、Chronometer、Button、ImageButton、ImageView、ProgressBar、TextView、ViewFlipper、ListView、GridView、StackView和AdapterViewFlipper这些显示控件，不支持这些类的子类或Android提供的其他控件，否则会引起ClassNotFoundException异常。<br>之前播放的按钮打算用ToggleButton，使用之后发现显示不了，后面才找到原因。</li>\n<li>Notification属于系统级别的组件，使用了RemoteViews的setViewVisibility()、setTextViewText()等方法后，必须通知系统重绘才能更新UI，最简单的方式就是重新notify一下。只要传入的Id一样，就会覆盖掉之前的通知。<br>在播放、暂停按钮切换的时候，就碰到这个问题，一直不能显示，加上notify语句后就能正常执行了。</li>\n<li>关于Notification的取消。<br>使用<code>mNotificationManager.cancel(PLAYING_NOTIFY_ID)</code>即可。但是一定要注意Notification的flag。这里补充下Notification的标识符。<br>提醒标志符成员：<br>Notification.FLAG_SHOW_LIGHTS              //三色灯提醒，在使用三色灯提醒时候必须加该标志符<br>Notification.FLAG_ONGOING_EVENT          //发起正在运行事件（活动中）<br>Notification.FLAG_INSISTENT   //让声音、振动无限循环，直到用户响应 （取消或者打开）<br>Notification.FLAG_ONLY_ALERT_ONCE  //发起Notification后，铃声和震动均只执行一次<br>Notification.FLAG_AUTO_CANCEL      //用户单击通知后自动消失<br>Notification.FLAG_NO_CLEAR          //只有全部清除时，Notification才会清除 ，不清楚该通知(QQ的通知无法清除，就是用的这个)<br>Notification.FLAG_FOREGROUND_SERVICE    //表示正在运行的服务<br>我当时使用的FLAG_FOREGROUND_SERVICE，导致cancel一直关闭不了Notification，更换flag后就能关闭了。</li>\n</ol>\n","excerpt":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>最近的项目中，需要用到Notification。上一下效果图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/notification1.png\" alt=\"这里写图片描述\"></p>\n<p>首先，学习一下关于Notification的基本知识。</p>\n<p>状态通知栏主要涉及到2个类：  Notification 和 NotificationManager 。<br>Notification为通知信息类，它里面对应了通知栏的各个属性。<br>NotificationManager ：  是状态栏通知的管理类，负责发通知、清除通知等操作。<br>注意：NotificationManager 是一个系统Service，必须通过 getSystemService(NOTIFICATION_SERVICE)方法来获取：<br><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mNotificationManager = (<span class=\"name\">NotificationManager</span>) getSystemService(<span class=\"name\">NOTIFICATION_SERVICE</span>)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>自定义Notification大致分为以下几步：</p>\n<ol>\n<li>自定义布局；</li>\n<li>使用NotificationCompat.Builder创建Notification。使用RemoteViews填充自定义布局，然后通过setContent()添加到Builder中；</li>\n<li>使用广播，添加按钮点击事件；</li>\n<li>NotificationManager.notify()将Notification显示到手机状态栏。</li>\n</ol>\n<p>下面结合代码进行说明。</p>","more":"<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>第一步，对应于Notification的布局文件：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/music_cover\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"64dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/mia\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"0dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_weight</span>=<span class=\"string\">\"1\"</span></div><div class=\"line\">        <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/music_name\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:ellipsize</span>=<span class=\"string\">\"end\"</span></div><div class=\"line\">            <span class=\"attr\">android:singleLine</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"无与伦比的美丽\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/singer_name\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:ellipsize</span>=<span class=\"string\">\"end\"</span></div><div class=\"line\">            <span class=\"attr\">android:singleLine</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"苏打绿\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/pause\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"48dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/button_pause\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/play\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"48dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/button_play\"</span></div><div class=\"line\">        <span class=\"attr\">android:visibility</span>=<span class=\"string\">\"gone\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/next\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"48dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/btn_next\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/delete\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"48dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_marginRight</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">        <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/search_delete\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>布局文件很简单，不做过多叙述。</p>\n<p>再来看到Notification的创建。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PlayerService</span> <span class=\"keyword\">extends</span> <span class=\"title\">Service</span> </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// 广播Action</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> String NOTIFICATION_PLAY_ACTION = <span class=\"string\">\"com.notifications.intent.action.PlayClick\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> String NOTIFICATION_PAUSE_ACTION = <span class=\"string\">\"com.notifications.intent.action.PauseClick\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> String NOTIFICATION_NEXT_ACTION = <span class=\"string\">\"com.notifications.intent.action.NextClick\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> String NOTIFICATION_DELETE_ACTION = <span class=\"string\">\"com.notifications.intent.action.DeleteClick\"</span>;</div><div class=\"line\">    <span class=\"comment\">// 自定义Notification</span></div><div class=\"line\">    <span class=\"keyword\">private</span> NotificationManager mNotificationManager = <span class=\"keyword\">null</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> PendingIntent contentIntent;</div><div class=\"line\">    <span class=\"keyword\">private</span> NotificationCompat.Builder builder;</div><div class=\"line\">    <span class=\"keyword\">private</span> Notification notification;</div><div class=\"line\">    <span class=\"keyword\">private</span> RemoteViews contentView; <span class=\"comment\">// 自定义Notification，接收布局</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PlayerService service = <span class=\"keyword\">this</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> BroadcastReceiver onClickReceiver; <span class=\"comment\">// 注册广播接收点击事件</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        mNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</div><div class=\"line\">        contentIntent = PendingIntent.getActivity(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, <span class=\"keyword\">new</span> Intent(<span class=\"keyword\">this</span>, MusicPlayActivity.class), <span class=\"number\">0</span>);</div><div class=\"line\">        contentView = <span class=\"keyword\">new</span> RemoteViews(getPackageName(), R.layout.custom_notification);</div><div class=\"line\">        builder = <span class=\"keyword\">new</span> NotificationCompat.Builder(<span class=\"keyword\">this</span>);</div><div class=\"line\">        notification = builder</div><div class=\"line\">                .setContentIntent(contentIntent)</div><div class=\"line\">                .setWhen(System.currentTimeMillis())</div><div class=\"line\">                .setSmallIcon(R.drawable.mia)</div><div class=\"line\">                .setContent(contentView)</div><div class=\"line\">                .build();</div><div class=\"line\">        notification.flags = Notification.FLAG_NO_CLEAR; <span class=\"comment\">// 注意Flag，会影响是否能cancel</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 播放</span></div><div class=\"line\">        Intent playIntent = <span class=\"keyword\">new</span> Intent(NOTIFICATION_PLAY_ACTION);</div><div class=\"line\">        PendingIntent play = PendingIntent.getBroadcast(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, playIntent, <span class=\"number\">0</span>);</div><div class=\"line\">        contentView.setOnClickPendingIntent(R.id.play, play);</div><div class=\"line\">        <span class=\"comment\">// 暂停</span></div><div class=\"line\">        Intent pauseIntent = <span class=\"keyword\">new</span> Intent(NOTIFICATION_PAUSE_ACTION);</div><div class=\"line\">        PendingIntent pause = PendingIntent.getBroadcast(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, pauseIntent, <span class=\"number\">0</span>);</div><div class=\"line\">        contentView.setOnClickPendingIntent(R.id.pause, pause);</div><div class=\"line\">        <span class=\"comment\">// 下一首</span></div><div class=\"line\">        Intent nextIntent = <span class=\"keyword\">new</span> Intent(NOTIFICATION_NEXT_ACTION);</div><div class=\"line\">        PendingIntent next = PendingIntent.getBroadcast(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, nextIntent, <span class=\"number\">0</span>);</div><div class=\"line\">        contentView.setOnClickPendingIntent(R.id.next, next);</div><div class=\"line\">        <span class=\"comment\">// 关闭</span></div><div class=\"line\">        Intent deleteIntent = <span class=\"keyword\">new</span> Intent(NOTIFICATION_DELETE_ACTION);</div><div class=\"line\">        <span class=\"keyword\">final</span> PendingIntent delete = PendingIntent.getBroadcast(<span class=\"keyword\">this</span>, <span class=\"number\">0</span>, deleteIntent, <span class=\"number\">0</span>);</div><div class=\"line\">        contentView.setOnClickPendingIntent(R.id.delete, delete);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Notification中按钮点击事件需注册广播</span></div><div class=\"line\">        onClickReceiver = <span class=\"keyword\">new</span> BroadcastReceiver() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onReceive</span><span class=\"params\">(Context context, Intent intent)</span> </span>&#123;</div><div class=\"line\">                String action = intent.getAction();</div><div class=\"line\">                <span class=\"keyword\">switch</span> (action) &#123;</div><div class=\"line\">                    <span class=\"keyword\">case</span> NOTIFICATION_PLAY_ACTION:</div><div class=\"line\">                        contentView.setViewVisibility(R.id.play, View.GONE);</div><div class=\"line\">                        contentView.setViewVisibility(R.id.pause, View.VISIBLE);</div><div class=\"line\">                        <span class=\"keyword\">if</span> (!service.isPlaying()) &#123;</div><div class=\"line\">                            service.resume(); <span class=\"comment\">// 继续播放</span></div><div class=\"line\">                        &#125;</div><div class=\"line\">                        mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> NOTIFICATION_PAUSE_ACTION:</div><div class=\"line\">                        contentView.setViewVisibility(R.id.pause, View.GONE);</div><div class=\"line\">                        contentView.setViewVisibility(R.id.play, View.VISIBLE);</div><div class=\"line\">                        <span class=\"keyword\">if</span> (service.isPlaying()) &#123;</div><div class=\"line\">                            service.pause(); <span class=\"comment\">// 暂停</span></div><div class=\"line\">                        &#125;</div><div class=\"line\">                        mNotificationManager.notify(PLAYING_NOTIFY_ID, notification);</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> NOTIFICATION_NEXT_ACTION:</div><div class=\"line\">                        service.next(); <span class=\"comment\">// 下一首</span></div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> NOTIFICATION_DELETE_ACTION:</div><div class=\"line\">                        service.stop();</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                    <span class=\"keyword\">default</span>:</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;;</div><div class=\"line\">        IntentFilter filter = <span class=\"keyword\">new</span> IntentFilter();</div><div class=\"line\">        filter.addAction(NOTIFICATION_PLAY_ACTION);</div><div class=\"line\">        filter.addAction(NOTIFICATION_PAUSE_ACTION);</div><div class=\"line\">        filter.addAction(NOTIFICATION_NEXT_ACTION);</div><div class=\"line\">        filter.addAction(NOTIFICATION_DELETE_ACTION);</div><div class=\"line\">        registerReceiver(onClickReceiver, filter);</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>播放音乐使用的自然是Service了。于是我定义了PlayerService继承自Service，声明相应的变量，然后在onCreate()中进行初始化。</p>\n<p>我们可以看到，代码中使用<code>RemoteViews</code>填充了布局，并将其设置到Notification创建的Builder中。</p>\n<p>RemoteViews不同于View，它不能通过findViewById()来获取View控件。它里面的控件的点击事件必须通过<code>setOnClickPendingIntent()</code>来进行设置。它有2个参数，1个是控件ID，另外1个是进行处理的PendingIntent。PendingIntent的创建必须通过广播的方式来实现。重复下上面的代码：<br><figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"type\">Intent</span> playIntent = <span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">Intent</span>(<span class=\"type\">NOTIFICATION_PLAY_ACTION</span>);</div><div class=\"line\"><span class=\"title\">PendingIntent</span> <span class=\"title\">play</span> = <span class=\"title\">PendingIntent</span>.<span class=\"title\">getBroadcast</span>(this, <span class=\"number\">0</span>, playIntent, <span class=\"number\">0</span>);</div><div class=\"line\"><span class=\"title\">contentView</span>.<span class=\"title\">setOnClickPendingIntent</span>(<span class=\"type\">R</span>.id.play, play);</span></div></pre></td></tr></table></figure></p>\n<p>然后在广播的onReceive()方法中，判断是哪个控件被点击。然后执行相应的逻辑。</p>\n<p>记得广播一定要先注册才能使用。</p>\n<p>最后，便是将Notification显示到手机了。<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">final Track track = getCurrentEntry().getTrack()<span class=\"comment\">;</span></div><div class=\"line\">ImageLoader.getInstance().loadImage(track.getUrl(), new SimpleImageLoadingListener() &#123;</div><div class=\"line\">                @Override</div><div class=\"line\">                public void onLoadingComplete(String imageUri, View view, <span class=\"keyword\">Bitmap </span>loadedImage) &#123;</div><div class=\"line\">                    contentView.setImageViewBitmap(R.id.music_cover, loadedImage)<span class=\"comment\">;</span></div><div class=\"line\">                    contentView.setTextViewText(R.id.music_name, track.getName())<span class=\"comment\">;</span></div><div class=\"line\">                    contentView.setTextViewText(R.id.singer_name, track.getSinger())<span class=\"comment\">;</span></div><div class=\"line\">                    mNotificationManager.notify(PLAYING_NOTIFY_ID, notification)<span class=\"comment\">;</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>Track是我进行音乐播放的一个Model类。包含一些播放音乐的基本信息。这里我是通过的Universal-Image-Loader进行图片加载。在其加载成功后的回调中，通过<code>setTextViewText()</code>等类似方法给控件设值。也是有2个参数，第1个是控件Id，第二个便是要设置的值。<br>最后通过<code>mNotificationManager.notify(PLAYING_NOTIFY_ID, notification)</code>将Notification显示到手机。</p>\n<p>经过上述几个步骤，自定义Notification便能显示到手机了，并且具备点击事件。</p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><ol>\n<li>自定义布局仅支持FrameLayout、LinearLayout、RelativeLayout三种布局控件和AnalogClock、Chronometer、Button、ImageButton、ImageView、ProgressBar、TextView、ViewFlipper、ListView、GridView、StackView和AdapterViewFlipper这些显示控件，不支持这些类的子类或Android提供的其他控件，否则会引起ClassNotFoundException异常。<br>之前播放的按钮打算用ToggleButton，使用之后发现显示不了，后面才找到原因。</li>\n<li>Notification属于系统级别的组件，使用了RemoteViews的setViewVisibility()、setTextViewText()等方法后，必须通知系统重绘才能更新UI，最简单的方式就是重新notify一下。只要传入的Id一样，就会覆盖掉之前的通知。<br>在播放、暂停按钮切换的时候，就碰到这个问题，一直不能显示，加上notify语句后就能正常执行了。</li>\n<li>关于Notification的取消。<br>使用<code>mNotificationManager.cancel(PLAYING_NOTIFY_ID)</code>即可。但是一定要注意Notification的flag。这里补充下Notification的标识符。<br>提醒标志符成员：<br>Notification.FLAG_SHOW_LIGHTS              //三色灯提醒，在使用三色灯提醒时候必须加该标志符<br>Notification.FLAG_ONGOING_EVENT          //发起正在运行事件（活动中）<br>Notification.FLAG_INSISTENT   //让声音、振动无限循环，直到用户响应 （取消或者打开）<br>Notification.FLAG_ONLY_ALERT_ONCE  //发起Notification后，铃声和震动均只执行一次<br>Notification.FLAG_AUTO_CANCEL      //用户单击通知后自动消失<br>Notification.FLAG_NO_CLEAR          //只有全部清除时，Notification才会清除 ，不清楚该通知(QQ的通知无法清除，就是用的这个)<br>Notification.FLAG_FOREGROUND_SERVICE    //表示正在运行的服务<br>我当时使用的FLAG_FOREGROUND_SERVICE，导致cancel一直关闭不了Notification，更换flag后就能关闭了。</li>\n</ol>"},{"title":"Android仿QQ空间浏览图片","date":"2015-12-08T09:09:39.000Z","_content":"\n## 前言\n最近的项目中需要用到类似QQ空间那样的图片浏览功能，于是Google了一波，发现使用ViewPager与PhotoView即可实现。有了思路便开撸了。\n\n## 代码\n首先，我们定义一个用于展示原图的Activity。\n```\npublic class ImageBrowseActivity extends Activity {\n\n    // ViewPager对象\n    private ViewPager mViewPager;\n    // 原图url路径List\n    private List<String> imagePath;\n    // 当前显示的位置\n    private int position;\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_images_view);\n        // 获取参数\n        this.position = getIntent().getIntExtra(\"position\", 0);\n        this.imagePath = getIntent().getStringArrayListExtra(\"imagePath\");\n        mViewPager = (ViewPager) findViewById(R.id.images_view);\n        // 设置左右两列缓存的数目\n        mViewPager.setOffscreenPageLimit(2);\n        // 添加Adapter\n        PagerAdapter adapter = new ImageBrowseAdapter(this, imagePath);\n        mViewPager.setAdapter(adapter);\n        mViewPager.setCurrentItem(position);\n    }\n}\n```\n\n<!--more-->\n\n布局如下：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:background=\"#000000\"\n    android:orientation=\"vertical\">\n\n    <android.support.v4.view.ViewPager\n        android:id=\"@+id/images_view\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:layout_gravity=\"center\" />\n\n</FrameLayout>\n```\nActivity比较简单，不做过多赘述。下面看看ImageBrowseAdapter怎么实现的。\nImageBrowseAdapter代码如下：\n```\npublic class ImageBrowseAdapter extends PagerAdapter {\n\n    PhotoViewAttacher mAttacher;\n    private Context context;\n    private List<String> imagePath;\n\n    public ImageBrowseAdapter(Context context, List<String> urls) {\n        this.context = context;\n        this.imagePath = urls;\n    }\n\n    @Override\n    public int getCount() {\n        return imagePath.size();\n    }\n\n    @Override\n    public boolean isViewFromObject(View view, Object o) {\n        return view == o;\n    }\n\n    @Override\n    public void destroyItem(ViewGroup view, int position, Object object) {\n        view.removeView((View) object);\n    }\n\n    @Override\n    public Object instantiateItem(ViewGroup view, int position) {\n        ImageView imageView = new ImageView(context);\n        new DownloadImageTask(context, imageView).execute(imagePath.get(position));\n        view.addView(imageView);\n        return imageView;\n    }\n\n    private class DownloadImageTask extends BaseAsyncTask<String, Void, Bitmap> {\n        ImageView bmImage;\n\n        public DownloadImageTask(Context context, ImageView bmImage) {\n            super(context);\n            this.bmImage = bmImage;\n        }\n\n        @Override\n        protected void onPreExecute() {\n\n        }\n\n        protected Bitmap doInBackground(String... urls) {\n            String path = urls[0];\n            Bitmap result = null;\n            try {\n                BitmapFactory.Options options = new BitmapFactory.Options();\n                //先设置为true，获取bitmap宽度、高度\n                options.inJustDecodeBounds = true;\n                InputStream in = new java.net.URL(path).openStream();\n                result = BitmapFactory.decodeStream(in, null, options);\n                in.close();\n                resetOptions(options);\n                //后设置为false，加载进内存显示\n                options.inJustDecodeBounds = false;\n                // InputStream在读取完之后就到结尾了，需要再次打开才能重新读取，否则下面的result将返回null\n                in = new java.net.URL(path).openStream();\n                result = BitmapFactory.decodeStream(in, null, options);\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n            return result;\n        }\n\n        protected void onPostExecute(Bitmap result) {\n            if (result != null) {\n                bmImage.setImageBitmap(result);\n                // PhotoViewAttacher绑定ImageView\n                mAttacher = new PhotoViewAttacher(bmImage);\n            }\n        }\n    }\n\n    /**\n     * 设置inSampleSize参数\n     *\n     * @param options\n     * @return\n     */\n    public void resetOptions(BitmapFactory.Options options) {\n        DisplayMetrics dm = context.getResources().getDisplayMetrics();\n        int width = dm.widthPixels / 2;\n        int height = dm.heightPixels / 2;\n        options.inSampleSize = (options.outWidth / width > options.outHeight / height) ?\n                options.outWidth / width : options.outHeight / height;\n    }\n\n}\n```\n在Adapter中，我为了求简便，直接在instantiateItem()中新建ImageView实例，然后传入到DownloadImageTask异步任务中进行下载，下载完成后更新，然后将PhotoViewAttacher与ImageView实例绑定。示例中没有使用PhoteView这个类，主要是用到了PhotoViewAttacher这个类。\n\n我们会有一个显示缩略图的列表，给列表的Item设置如下点击事件：\n```\n@Override\npublic void ImageClicked(ArrayList<String> imagePath, int position) {\n    Intent intent = new Intent(getActivity(), ImageBrowseActivity.class);\n    intent.putExtra(\"position\", position);\n    intent.putStringArrayListExtra(\"imagePath\", imagePath);\n    startActivity(intent);\n}\n```\nimagePath是原图的路径数组，position代表当前显示第几张。\n点击事件设置好之后，便能实现网络图片浏览功能了。下面上效果图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/12/picture-view1.png)\n\n## 小结\n\n - 使用ViewPager来实现大图左右滑动。\n - 使用PhotoView开源库实现图片的缩放，移动等特性，[点击传送PhotoView开源库](https://github.com/chrisbanes/PhotoView)。\n\n## 问题\n\n - 在使用PhotoView与ViewPager结合进行滑动显示的时候，会打出``ImageView no longer exists. You should not use this PhotoViewAttacher any more.``的Log，算不上错误，是个Warning，网上查找的解决办法是[修改cleapUp方法](https://github.com/chrisbanes/PhotoView/issues/67)。\n - 自己手贱，传了一些手机拍摄的“高清大图”，没滑2张就OOM了。也算是个契机让自己了解下Bitmap的内存优化。故在示例中会有resetOptions()方法以及这样的代码片段：\n```\n...\n\nBitmapFactory.Options options = new BitmapFactory.Options();\n                //先设置为true，获取bitmap宽度、高度\n                options.inJustDecodeBounds = true;\n                InputStream in = new java.net.URL(path).openStream();\n                result = BitmapFactory.decodeStream(in, null, options);\n                in.close();\n                resetOptions(options);\n                //后设置为false，加载进内存显示\n                options.inJustDecodeBounds = false;\n                // InputStream在读取完之后就到结尾了，需要再次打开才能重新读取，否则下面的result将返回null\n                in = new java.net.URL(path).openStream();\n                result = BitmapFactory.decodeStream(in, null, options);\n\n...\n```\nBitmap是OOM的一大凶器，所以碰到大图我们需要压缩。压缩可以通过设置BitmapFactory.Options，来生成压缩后的图片，主要是inSampleSize参数的设置。resetOptions()方法便是进行设置inSampleSize参数的，方法内部的具体逻辑则需要根据项目业务的需求来制定了。\n\n另外，在第二次BitmapFactory.decodeStream()时，若不进行其他处理，会返回null，后面查询原因，是InputStream流在访问后，内部指针会指到尾部，相当于是传入的in是空的。所以需要添加一句``in = new java.net.URL(path).openStream();``，重新打开in，然后再使用decodeStream方法，返回bitmap。\n","source":"_posts/picture-view.md","raw":"---\ntitle: Android仿QQ空间浏览图片\ndate: 2015-12-08 17:09:39\ntags:\n - 日常开发\n---\n\n## 前言\n最近的项目中需要用到类似QQ空间那样的图片浏览功能，于是Google了一波，发现使用ViewPager与PhotoView即可实现。有了思路便开撸了。\n\n## 代码\n首先，我们定义一个用于展示原图的Activity。\n```\npublic class ImageBrowseActivity extends Activity {\n\n    // ViewPager对象\n    private ViewPager mViewPager;\n    // 原图url路径List\n    private List<String> imagePath;\n    // 当前显示的位置\n    private int position;\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_images_view);\n        // 获取参数\n        this.position = getIntent().getIntExtra(\"position\", 0);\n        this.imagePath = getIntent().getStringArrayListExtra(\"imagePath\");\n        mViewPager = (ViewPager) findViewById(R.id.images_view);\n        // 设置左右两列缓存的数目\n        mViewPager.setOffscreenPageLimit(2);\n        // 添加Adapter\n        PagerAdapter adapter = new ImageBrowseAdapter(this, imagePath);\n        mViewPager.setAdapter(adapter);\n        mViewPager.setCurrentItem(position);\n    }\n}\n```\n\n<!--more-->\n\n布局如下：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:background=\"#000000\"\n    android:orientation=\"vertical\">\n\n    <android.support.v4.view.ViewPager\n        android:id=\"@+id/images_view\"\n        android:layout_width=\"wrap_content\"\n        android:layout_height=\"wrap_content\"\n        android:layout_gravity=\"center\" />\n\n</FrameLayout>\n```\nActivity比较简单，不做过多赘述。下面看看ImageBrowseAdapter怎么实现的。\nImageBrowseAdapter代码如下：\n```\npublic class ImageBrowseAdapter extends PagerAdapter {\n\n    PhotoViewAttacher mAttacher;\n    private Context context;\n    private List<String> imagePath;\n\n    public ImageBrowseAdapter(Context context, List<String> urls) {\n        this.context = context;\n        this.imagePath = urls;\n    }\n\n    @Override\n    public int getCount() {\n        return imagePath.size();\n    }\n\n    @Override\n    public boolean isViewFromObject(View view, Object o) {\n        return view == o;\n    }\n\n    @Override\n    public void destroyItem(ViewGroup view, int position, Object object) {\n        view.removeView((View) object);\n    }\n\n    @Override\n    public Object instantiateItem(ViewGroup view, int position) {\n        ImageView imageView = new ImageView(context);\n        new DownloadImageTask(context, imageView).execute(imagePath.get(position));\n        view.addView(imageView);\n        return imageView;\n    }\n\n    private class DownloadImageTask extends BaseAsyncTask<String, Void, Bitmap> {\n        ImageView bmImage;\n\n        public DownloadImageTask(Context context, ImageView bmImage) {\n            super(context);\n            this.bmImage = bmImage;\n        }\n\n        @Override\n        protected void onPreExecute() {\n\n        }\n\n        protected Bitmap doInBackground(String... urls) {\n            String path = urls[0];\n            Bitmap result = null;\n            try {\n                BitmapFactory.Options options = new BitmapFactory.Options();\n                //先设置为true，获取bitmap宽度、高度\n                options.inJustDecodeBounds = true;\n                InputStream in = new java.net.URL(path).openStream();\n                result = BitmapFactory.decodeStream(in, null, options);\n                in.close();\n                resetOptions(options);\n                //后设置为false，加载进内存显示\n                options.inJustDecodeBounds = false;\n                // InputStream在读取完之后就到结尾了，需要再次打开才能重新读取，否则下面的result将返回null\n                in = new java.net.URL(path).openStream();\n                result = BitmapFactory.decodeStream(in, null, options);\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n            return result;\n        }\n\n        protected void onPostExecute(Bitmap result) {\n            if (result != null) {\n                bmImage.setImageBitmap(result);\n                // PhotoViewAttacher绑定ImageView\n                mAttacher = new PhotoViewAttacher(bmImage);\n            }\n        }\n    }\n\n    /**\n     * 设置inSampleSize参数\n     *\n     * @param options\n     * @return\n     */\n    public void resetOptions(BitmapFactory.Options options) {\n        DisplayMetrics dm = context.getResources().getDisplayMetrics();\n        int width = dm.widthPixels / 2;\n        int height = dm.heightPixels / 2;\n        options.inSampleSize = (options.outWidth / width > options.outHeight / height) ?\n                options.outWidth / width : options.outHeight / height;\n    }\n\n}\n```\n在Adapter中，我为了求简便，直接在instantiateItem()中新建ImageView实例，然后传入到DownloadImageTask异步任务中进行下载，下载完成后更新，然后将PhotoViewAttacher与ImageView实例绑定。示例中没有使用PhoteView这个类，主要是用到了PhotoViewAttacher这个类。\n\n我们会有一个显示缩略图的列表，给列表的Item设置如下点击事件：\n```\n@Override\npublic void ImageClicked(ArrayList<String> imagePath, int position) {\n    Intent intent = new Intent(getActivity(), ImageBrowseActivity.class);\n    intent.putExtra(\"position\", position);\n    intent.putStringArrayListExtra(\"imagePath\", imagePath);\n    startActivity(intent);\n}\n```\nimagePath是原图的路径数组，position代表当前显示第几张。\n点击事件设置好之后，便能实现网络图片浏览功能了。下面上效果图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/12/picture-view1.png)\n\n## 小结\n\n - 使用ViewPager来实现大图左右滑动。\n - 使用PhotoView开源库实现图片的缩放，移动等特性，[点击传送PhotoView开源库](https://github.com/chrisbanes/PhotoView)。\n\n## 问题\n\n - 在使用PhotoView与ViewPager结合进行滑动显示的时候，会打出``ImageView no longer exists. You should not use this PhotoViewAttacher any more.``的Log，算不上错误，是个Warning，网上查找的解决办法是[修改cleapUp方法](https://github.com/chrisbanes/PhotoView/issues/67)。\n - 自己手贱，传了一些手机拍摄的“高清大图”，没滑2张就OOM了。也算是个契机让自己了解下Bitmap的内存优化。故在示例中会有resetOptions()方法以及这样的代码片段：\n```\n...\n\nBitmapFactory.Options options = new BitmapFactory.Options();\n                //先设置为true，获取bitmap宽度、高度\n                options.inJustDecodeBounds = true;\n                InputStream in = new java.net.URL(path).openStream();\n                result = BitmapFactory.decodeStream(in, null, options);\n                in.close();\n                resetOptions(options);\n                //后设置为false，加载进内存显示\n                options.inJustDecodeBounds = false;\n                // InputStream在读取完之后就到结尾了，需要再次打开才能重新读取，否则下面的result将返回null\n                in = new java.net.URL(path).openStream();\n                result = BitmapFactory.decodeStream(in, null, options);\n\n...\n```\nBitmap是OOM的一大凶器，所以碰到大图我们需要压缩。压缩可以通过设置BitmapFactory.Options，来生成压缩后的图片，主要是inSampleSize参数的设置。resetOptions()方法便是进行设置inSampleSize参数的，方法内部的具体逻辑则需要根据项目业务的需求来制定了。\n\n另外，在第二次BitmapFactory.decodeStream()时，若不进行其他处理，会返回null，后面查询原因，是InputStream流在访问后，内部指针会指到尾部，相当于是传入的in是空的。所以需要添加一句``in = new java.net.URL(path).openStream();``，重新打开in，然后再使用decodeStream方法，返回bitmap。\n","slug":"picture-view","published":1,"updated":"2016-11-21T10:02:21.704Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759v002a1cb857ju7gw3","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近的项目中需要用到类似QQ空间那样的图片浏览功能，于是Google了一波，发现使用ViewPager与PhotoView即可实现。有了思路便开撸了。</p>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>首先，我们定义一个用于展示原图的Activity。<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ImageBrowseActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">Activity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// ViewPager对象</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">ViewPager</span> mViewPager;</div><div class=\"line\">    <span class=\"comment\">// 原图url路径List</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">List</span>&lt;<span class=\"type\">String</span>&gt; imagePath;</div><div class=\"line\">    <span class=\"comment\">// 当前显示的位置</span></div><div class=\"line\">    <span class=\"keyword\">private</span> int position;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onCreate(<span class=\"type\">Bundle</span> savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(<span class=\"type\">R</span>.layout.activity_images_view);</div><div class=\"line\">        <span class=\"comment\">// 获取参数</span></div><div class=\"line\">        <span class=\"keyword\">this</span>.position = getIntent().getIntExtra(<span class=\"string\">\"position\"</span>, <span class=\"number\">0</span>);</div><div class=\"line\">        <span class=\"keyword\">this</span>.imagePath = getIntent().getStringArrayListExtra(<span class=\"string\">\"imagePath\"</span>);</div><div class=\"line\">        mViewPager = (<span class=\"type\">ViewPager</span>) findViewById(<span class=\"type\">R</span>.id.images_view);</div><div class=\"line\">        <span class=\"comment\">// 设置左右两列缓存的数目</span></div><div class=\"line\">        mViewPager.setOffscreenPageLimit(<span class=\"number\">2</span>);</div><div class=\"line\">        <span class=\"comment\">// 添加Adapter</span></div><div class=\"line\">        <span class=\"type\">PagerAdapter</span> adapter = <span class=\"keyword\">new</span> <span class=\"type\">ImageBrowseAdapter</span>(<span class=\"keyword\">this</span>, imagePath);</div><div class=\"line\">        mViewPager.setAdapter(adapter);</div><div class=\"line\">        mViewPager.setCurrentItem(position);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<a id=\"more\"></a>\n<p>布局如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:background</span>=<span class=\"string\">\"#000000\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.v4.view.ViewPager</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/images_view\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>Activity比较简单，不做过多赘述。下面看看ImageBrowseAdapter怎么实现的。<br>ImageBrowseAdapter代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ImageBrowseAdapter</span> <span class=\"keyword\">extends</span> <span class=\"title\">PagerAdapter</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    PhotoViewAttacher mAttacher;</div><div class=\"line\">    <span class=\"keyword\">private</span> Context context;</div><div class=\"line\">    <span class=\"keyword\">private</span> List&lt;String&gt; imagePath;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ImageBrowseAdapter</span><span class=\"params\">(Context context, List&lt;String&gt; urls)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.context = context;</div><div class=\"line\">        <span class=\"keyword\">this</span>.imagePath = urls;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getCount</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> imagePath.size();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isViewFromObject</span><span class=\"params\">(View view, Object o)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> view == o;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">destroyItem</span><span class=\"params\">(ViewGroup view, <span class=\"keyword\">int</span> position, Object object)</span> </span>&#123;</div><div class=\"line\">        view.removeView((View) object);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">instantiateItem</span><span class=\"params\">(ViewGroup view, <span class=\"keyword\">int</span> position)</span> </span>&#123;</div><div class=\"line\">        ImageView imageView = <span class=\"keyword\">new</span> ImageView(context);</div><div class=\"line\">        <span class=\"keyword\">new</span> DownloadImageTask(context, imageView).execute(imagePath.get(position));</div><div class=\"line\">        view.addView(imageView);</div><div class=\"line\">        <span class=\"keyword\">return</span> imageView;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DownloadImageTask</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseAsyncTask</span>&lt;<span class=\"title\">String</span>, <span class=\"title\">Void</span>, <span class=\"title\">Bitmap</span>&gt; </span>&#123;</div><div class=\"line\">        ImageView bmImage;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DownloadImageTask</span><span class=\"params\">(Context context, ImageView bmImage)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">super</span>(context);</div><div class=\"line\">            <span class=\"keyword\">this</span>.bmImage = bmImage;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onPreExecute</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> Bitmap <span class=\"title\">doInBackground</span><span class=\"params\">(String... urls)</span> </span>&#123;</div><div class=\"line\">            String path = urls[<span class=\"number\">0</span>];</div><div class=\"line\">            Bitmap result = <span class=\"keyword\">null</span>;</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                BitmapFactory.Options options = <span class=\"keyword\">new</span> BitmapFactory.Options();</div><div class=\"line\">                <span class=\"comment\">//先设置为true，获取bitmap宽度、高度</span></div><div class=\"line\">                options.inJustDecodeBounds = <span class=\"keyword\">true</span>;</div><div class=\"line\">                InputStream in = <span class=\"keyword\">new</span> java.net.URL(path).openStream();</div><div class=\"line\">                result = BitmapFactory.decodeStream(in, <span class=\"keyword\">null</span>, options);</div><div class=\"line\">                in.close();</div><div class=\"line\">                resetOptions(options);</div><div class=\"line\">                <span class=\"comment\">//后设置为false，加载进内存显示</span></div><div class=\"line\">                options.inJustDecodeBounds = <span class=\"keyword\">false</span>;</div><div class=\"line\">                <span class=\"comment\">// InputStream在读取完之后就到结尾了，需要再次打开才能重新读取，否则下面的result将返回null</span></div><div class=\"line\">                in = <span class=\"keyword\">new</span> java.net.URL(path).openStream();</div><div class=\"line\">                result = BitmapFactory.decodeStream(in, <span class=\"keyword\">null</span>, options);</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">return</span> result;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onPostExecute</span><span class=\"params\">(Bitmap result)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (result != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                bmImage.setImageBitmap(result);</div><div class=\"line\">                <span class=\"comment\">// PhotoViewAttacher绑定ImageView</span></div><div class=\"line\">                mAttacher = <span class=\"keyword\">new</span> PhotoViewAttacher(bmImage);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 设置inSampleSize参数</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> options</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">resetOptions</span><span class=\"params\">(BitmapFactory.Options options)</span> </span>&#123;</div><div class=\"line\">        DisplayMetrics dm = context.getResources().getDisplayMetrics();</div><div class=\"line\">        <span class=\"keyword\">int</span> width = dm.widthPixels / <span class=\"number\">2</span>;</div><div class=\"line\">        <span class=\"keyword\">int</span> height = dm.heightPixels / <span class=\"number\">2</span>;</div><div class=\"line\">        options.inSampleSize = (options.outWidth / width &gt; options.outHeight / height) ?</div><div class=\"line\">                options.outWidth / width : options.outHeight / height;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>在Adapter中，我为了求简便，直接在instantiateItem()中新建ImageView实例，然后传入到DownloadImageTask异步任务中进行下载，下载完成后更新，然后将PhotoViewAttacher与ImageView实例绑定。示例中没有使用PhoteView这个类，主要是用到了PhotoViewAttacher这个类。</p>\n<p>我们会有一个显示缩略图的列表，给列表的Item设置如下点击事件：<br><figure class=\"highlight fortran\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">@Override</div><div class=\"line\"><span class=\"keyword\">public</span> void ImageClicked(ArrayList&lt;String&gt; imagePath, <span class=\"built_in\">int</span> <span class=\"keyword\">position</span>) &#123;</div><div class=\"line\">    <span class=\"keyword\">Intent</span> <span class=\"keyword\">intent</span> = new <span class=\"keyword\">Intent</span>(getActivity(), ImageBrowseActivity.<span class=\"keyword\">class</span>);</div><div class=\"line\">    <span class=\"keyword\">intent</span>.putExtra(<span class=\"string\">\"position\"</span>, <span class=\"keyword\">position</span>);</div><div class=\"line\">    <span class=\"keyword\">intent</span>.putStringArrayListExtra(<span class=\"string\">\"imagePath\"</span>, imagePath);</div><div class=\"line\">    startActivity(<span class=\"keyword\">intent</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>imagePath是原图的路径数组，position代表当前显示第几张。<br>点击事件设置好之后，便能实现网络图片浏览功能了。下面上效果图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/12/picture-view1.png\" alt=\"这里写图片描述\"></p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ul>\n<li>使用ViewPager来实现大图左右滑动。</li>\n<li>使用PhotoView开源库实现图片的缩放，移动等特性，<a href=\"https://github.com/chrisbanes/PhotoView\" target=\"_blank\" rel=\"external\">点击传送PhotoView开源库</a>。</li>\n</ul>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><ul>\n<li>在使用PhotoView与ViewPager结合进行滑动显示的时候，会打出<code>ImageView no longer exists. You should not use this PhotoViewAttacher any more.</code>的Log，算不上错误，是个Warning，网上查找的解决办法是<a href=\"https://github.com/chrisbanes/PhotoView/issues/67\" target=\"_blank\" rel=\"external\">修改cleapUp方法</a>。</li>\n<li>自己手贱，传了一些手机拍摄的“高清大图”，没滑2张就OOM了。也算是个契机让自己了解下Bitmap的内存优化。故在示例中会有resetOptions()方法以及这样的代码片段：<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">...</div><div class=\"line\"></div><div class=\"line\">BitmapFactory.<span class=\"keyword\">Options</span> <span class=\"keyword\">options</span> = <span class=\"keyword\">new</span> BitmapFactory.<span class=\"keyword\">Options</span>();</div><div class=\"line\">                <span class=\"comment\">//先设置为true，获取bitmap宽度、高度</span></div><div class=\"line\">                <span class=\"keyword\">options</span>.inJustDecodeBounds = <span class=\"keyword\">true</span>;</div><div class=\"line\">                InputStream in = <span class=\"keyword\">new</span> java.net.URL(path).openStream();</div><div class=\"line\">                result = BitmapFactory.decodeStream(in, <span class=\"keyword\">null</span>, <span class=\"keyword\">options</span>);</div><div class=\"line\">                in.close();</div><div class=\"line\">                resetOptions(<span class=\"keyword\">options</span>);</div><div class=\"line\">                <span class=\"comment\">//后设置为false，加载进内存显示</span></div><div class=\"line\">                <span class=\"keyword\">options</span>.inJustDecodeBounds = <span class=\"keyword\">false</span>;</div><div class=\"line\">                <span class=\"comment\">// InputStream在读取完之后就到结尾了，需要再次打开才能重新读取，否则下面的result将返回null</span></div><div class=\"line\">                in = <span class=\"keyword\">new</span> java.net.URL(path).openStream();</div><div class=\"line\">                result = BitmapFactory.decodeStream(in, <span class=\"keyword\">null</span>, <span class=\"keyword\">options</span>);</div><div class=\"line\"></div><div class=\"line\">...</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Bitmap是OOM的一大凶器，所以碰到大图我们需要压缩。压缩可以通过设置BitmapFactory.Options，来生成压缩后的图片，主要是inSampleSize参数的设置。resetOptions()方法便是进行设置inSampleSize参数的，方法内部的具体逻辑则需要根据项目业务的需求来制定了。</p>\n<p>另外，在第二次BitmapFactory.decodeStream()时，若不进行其他处理，会返回null，后面查询原因，是InputStream流在访问后，内部指针会指到尾部，相当于是传入的in是空的。所以需要添加一句<code>in = new java.net.URL(path).openStream();</code>，重新打开in，然后再使用decodeStream方法，返回bitmap。</p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近的项目中需要用到类似QQ空间那样的图片浏览功能，于是Google了一波，发现使用ViewPager与PhotoView即可实现。有了思路便开撸了。</p>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>首先，我们定义一个用于展示原图的Activity。<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ImageBrowseActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">Activity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// ViewPager对象</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">ViewPager</span> mViewPager;</div><div class=\"line\">    <span class=\"comment\">// 原图url路径List</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">List</span>&lt;<span class=\"type\">String</span>&gt; imagePath;</div><div class=\"line\">    <span class=\"comment\">// 当前显示的位置</span></div><div class=\"line\">    <span class=\"keyword\">private</span> int position;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onCreate(<span class=\"type\">Bundle</span> savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(<span class=\"type\">R</span>.layout.activity_images_view);</div><div class=\"line\">        <span class=\"comment\">// 获取参数</span></div><div class=\"line\">        <span class=\"keyword\">this</span>.position = getIntent().getIntExtra(<span class=\"string\">\"position\"</span>, <span class=\"number\">0</span>);</div><div class=\"line\">        <span class=\"keyword\">this</span>.imagePath = getIntent().getStringArrayListExtra(<span class=\"string\">\"imagePath\"</span>);</div><div class=\"line\">        mViewPager = (<span class=\"type\">ViewPager</span>) findViewById(<span class=\"type\">R</span>.id.images_view);</div><div class=\"line\">        <span class=\"comment\">// 设置左右两列缓存的数目</span></div><div class=\"line\">        mViewPager.setOffscreenPageLimit(<span class=\"number\">2</span>);</div><div class=\"line\">        <span class=\"comment\">// 添加Adapter</span></div><div class=\"line\">        <span class=\"type\">PagerAdapter</span> adapter = <span class=\"keyword\">new</span> <span class=\"type\">ImageBrowseAdapter</span>(<span class=\"keyword\">this</span>, imagePath);</div><div class=\"line\">        mViewPager.setAdapter(adapter);</div><div class=\"line\">        mViewPager.setCurrentItem(position);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>","more":"<p>布局如下：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:background</span>=<span class=\"string\">\"#000000\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">android.support.v4.view.ViewPager</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/images_view\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>Activity比较简单，不做过多赘述。下面看看ImageBrowseAdapter怎么实现的。<br>ImageBrowseAdapter代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ImageBrowseAdapter</span> <span class=\"keyword\">extends</span> <span class=\"title\">PagerAdapter</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    PhotoViewAttacher mAttacher;</div><div class=\"line\">    <span class=\"keyword\">private</span> Context context;</div><div class=\"line\">    <span class=\"keyword\">private</span> List&lt;String&gt; imagePath;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ImageBrowseAdapter</span><span class=\"params\">(Context context, List&lt;String&gt; urls)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.context = context;</div><div class=\"line\">        <span class=\"keyword\">this</span>.imagePath = urls;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getCount</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> imagePath.size();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isViewFromObject</span><span class=\"params\">(View view, Object o)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> view == o;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">destroyItem</span><span class=\"params\">(ViewGroup view, <span class=\"keyword\">int</span> position, Object object)</span> </span>&#123;</div><div class=\"line\">        view.removeView((View) object);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">instantiateItem</span><span class=\"params\">(ViewGroup view, <span class=\"keyword\">int</span> position)</span> </span>&#123;</div><div class=\"line\">        ImageView imageView = <span class=\"keyword\">new</span> ImageView(context);</div><div class=\"line\">        <span class=\"keyword\">new</span> DownloadImageTask(context, imageView).execute(imagePath.get(position));</div><div class=\"line\">        view.addView(imageView);</div><div class=\"line\">        <span class=\"keyword\">return</span> imageView;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DownloadImageTask</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseAsyncTask</span>&lt;<span class=\"title\">String</span>, <span class=\"title\">Void</span>, <span class=\"title\">Bitmap</span>&gt; </span>&#123;</div><div class=\"line\">        ImageView bmImage;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DownloadImageTask</span><span class=\"params\">(Context context, ImageView bmImage)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">super</span>(context);</div><div class=\"line\">            <span class=\"keyword\">this</span>.bmImage = bmImage;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onPreExecute</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> Bitmap <span class=\"title\">doInBackground</span><span class=\"params\">(String... urls)</span> </span>&#123;</div><div class=\"line\">            String path = urls[<span class=\"number\">0</span>];</div><div class=\"line\">            Bitmap result = <span class=\"keyword\">null</span>;</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                BitmapFactory.Options options = <span class=\"keyword\">new</span> BitmapFactory.Options();</div><div class=\"line\">                <span class=\"comment\">//先设置为true，获取bitmap宽度、高度</span></div><div class=\"line\">                options.inJustDecodeBounds = <span class=\"keyword\">true</span>;</div><div class=\"line\">                InputStream in = <span class=\"keyword\">new</span> java.net.URL(path).openStream();</div><div class=\"line\">                result = BitmapFactory.decodeStream(in, <span class=\"keyword\">null</span>, options);</div><div class=\"line\">                in.close();</div><div class=\"line\">                resetOptions(options);</div><div class=\"line\">                <span class=\"comment\">//后设置为false，加载进内存显示</span></div><div class=\"line\">                options.inJustDecodeBounds = <span class=\"keyword\">false</span>;</div><div class=\"line\">                <span class=\"comment\">// InputStream在读取完之后就到结尾了，需要再次打开才能重新读取，否则下面的result将返回null</span></div><div class=\"line\">                in = <span class=\"keyword\">new</span> java.net.URL(path).openStream();</div><div class=\"line\">                result = BitmapFactory.decodeStream(in, <span class=\"keyword\">null</span>, options);</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">return</span> result;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onPostExecute</span><span class=\"params\">(Bitmap result)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (result != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                bmImage.setImageBitmap(result);</div><div class=\"line\">                <span class=\"comment\">// PhotoViewAttacher绑定ImageView</span></div><div class=\"line\">                mAttacher = <span class=\"keyword\">new</span> PhotoViewAttacher(bmImage);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 设置inSampleSize参数</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> options</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">resetOptions</span><span class=\"params\">(BitmapFactory.Options options)</span> </span>&#123;</div><div class=\"line\">        DisplayMetrics dm = context.getResources().getDisplayMetrics();</div><div class=\"line\">        <span class=\"keyword\">int</span> width = dm.widthPixels / <span class=\"number\">2</span>;</div><div class=\"line\">        <span class=\"keyword\">int</span> height = dm.heightPixels / <span class=\"number\">2</span>;</div><div class=\"line\">        options.inSampleSize = (options.outWidth / width &gt; options.outHeight / height) ?</div><div class=\"line\">                options.outWidth / width : options.outHeight / height;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>在Adapter中，我为了求简便，直接在instantiateItem()中新建ImageView实例，然后传入到DownloadImageTask异步任务中进行下载，下载完成后更新，然后将PhotoViewAttacher与ImageView实例绑定。示例中没有使用PhoteView这个类，主要是用到了PhotoViewAttacher这个类。</p>\n<p>我们会有一个显示缩略图的列表，给列表的Item设置如下点击事件：<br><figure class=\"highlight fortran\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">@Override</div><div class=\"line\"><span class=\"keyword\">public</span> void ImageClicked(ArrayList&lt;String&gt; imagePath, <span class=\"built_in\">int</span> <span class=\"keyword\">position</span>) &#123;</div><div class=\"line\">    <span class=\"keyword\">Intent</span> <span class=\"keyword\">intent</span> = new <span class=\"keyword\">Intent</span>(getActivity(), ImageBrowseActivity.<span class=\"keyword\">class</span>);</div><div class=\"line\">    <span class=\"keyword\">intent</span>.putExtra(<span class=\"string\">\"position\"</span>, <span class=\"keyword\">position</span>);</div><div class=\"line\">    <span class=\"keyword\">intent</span>.putStringArrayListExtra(<span class=\"string\">\"imagePath\"</span>, imagePath);</div><div class=\"line\">    startActivity(<span class=\"keyword\">intent</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>imagePath是原图的路径数组，position代表当前显示第几张。<br>点击事件设置好之后，便能实现网络图片浏览功能了。下面上效果图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/12/picture-view1.png\" alt=\"这里写图片描述\"></p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ul>\n<li>使用ViewPager来实现大图左右滑动。</li>\n<li>使用PhotoView开源库实现图片的缩放，移动等特性，<a href=\"https://github.com/chrisbanes/PhotoView\">点击传送PhotoView开源库</a>。</li>\n</ul>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><ul>\n<li>在使用PhotoView与ViewPager结合进行滑动显示的时候，会打出<code>ImageView no longer exists. You should not use this PhotoViewAttacher any more.</code>的Log，算不上错误，是个Warning，网上查找的解决办法是<a href=\"https://github.com/chrisbanes/PhotoView/issues/67\">修改cleapUp方法</a>。</li>\n<li>自己手贱，传了一些手机拍摄的“高清大图”，没滑2张就OOM了。也算是个契机让自己了解下Bitmap的内存优化。故在示例中会有resetOptions()方法以及这样的代码片段：<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">...</div><div class=\"line\"></div><div class=\"line\">BitmapFactory.<span class=\"keyword\">Options</span> <span class=\"keyword\">options</span> = <span class=\"keyword\">new</span> BitmapFactory.<span class=\"keyword\">Options</span>();</div><div class=\"line\">                <span class=\"comment\">//先设置为true，获取bitmap宽度、高度</span></div><div class=\"line\">                <span class=\"keyword\">options</span>.inJustDecodeBounds = <span class=\"keyword\">true</span>;</div><div class=\"line\">                InputStream in = <span class=\"keyword\">new</span> java.net.URL(path).openStream();</div><div class=\"line\">                result = BitmapFactory.decodeStream(in, <span class=\"keyword\">null</span>, <span class=\"keyword\">options</span>);</div><div class=\"line\">                in.close();</div><div class=\"line\">                resetOptions(<span class=\"keyword\">options</span>);</div><div class=\"line\">                <span class=\"comment\">//后设置为false，加载进内存显示</span></div><div class=\"line\">                <span class=\"keyword\">options</span>.inJustDecodeBounds = <span class=\"keyword\">false</span>;</div><div class=\"line\">                <span class=\"comment\">// InputStream在读取完之后就到结尾了，需要再次打开才能重新读取，否则下面的result将返回null</span></div><div class=\"line\">                in = <span class=\"keyword\">new</span> java.net.URL(path).openStream();</div><div class=\"line\">                result = BitmapFactory.decodeStream(in, <span class=\"keyword\">null</span>, <span class=\"keyword\">options</span>);</div><div class=\"line\"></div><div class=\"line\">...</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Bitmap是OOM的一大凶器，所以碰到大图我们需要压缩。压缩可以通过设置BitmapFactory.Options，来生成压缩后的图片，主要是inSampleSize参数的设置。resetOptions()方法便是进行设置inSampleSize参数的，方法内部的具体逻辑则需要根据项目业务的需求来制定了。</p>\n<p>另外，在第二次BitmapFactory.decodeStream()时，若不进行其他处理，会返回null，后面查询原因，是InputStream流在访问后，内部指针会指到尾部，相当于是传入的in是空的。所以需要添加一句<code>in = new java.net.URL(path).openStream();</code>，重新打开in，然后再使用decodeStream方法，返回bitmap。</p>"},{"title":"Android实现照片墙背景","date":"2016-02-17T09:34:49.000Z","_content":"\n项目开发中，有一个这样的需求：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/photo-wall1.png)\n在个人主页里会有12张图片的背景墙。这12张图片由服务器返回，会不定时刷新。\n\n---\n## 第一种方案\n起初，自己的实现思路是：xml直接定义12个ImageView，然后在接收到图片路径后，再进行异步加载。\n\n显然，这种方法是肯定可以的，但是却显得不“优雅”。而且后续可能会对这整个背景墙有个缩放的动画之类的，那么再实现起来便会比较复杂了。\n\n## 第二种方案\n\n之后，我想到了GridView，显然也是可以的，在得到图片路径后传入到Adapter中即可。比起方案一稍微“优雅”些，但是也是很难将这个背景墙当成一个整体，进行将来可能会添加的动画特效需求。\n\n## 第三种方案\n\n最后，我想到，既然要当成一整个整体，那么自定义View或许是个不错的办法。\n\n<!--more-->\n\n### 思路\n思路是这样的：\n\n 1. 首先ImageView展示初始图片；\n 2. 下载图片；\n 3. 所有图片下载完成后刷新View，显示下载的图片墙。\n\n下面上代码。\n\n### 代码\n自定义ImageView：\n```\npublic class JointImageView extends ImageView {\n\n    private Paint mPaint;// 画笔\n    private List<Bitmap> bitmaps;// 位图\n    private List<Rect> rectList; // 正方形画bitmap\n    private int width; // 边长\n    private static int pictureInRow = 4; // 每一行显示4张图片\n\n\n    public JointImageView(Context context) {\n        super(context);\n    }\n\n    public JointImageView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        mPaint = new Paint(Paint.ANTI_ALIAS_FLAG);\n    }\n\n    /**\n     * 设置Bitmap数据\n     *\n     * @param bitmaps\n     */\n    public void setBitmaps(List<Bitmap> bitmaps) {\n        this.bitmaps = bitmaps;\n        width = getMeasuredWidth() / pictureInRow;\n        createRect();\n        postInvalidate(); // 在设置Bitmaps之后重绘\n    }\n\n    private void createRect() { // 计算12个矩形的坐标\n        rectList = new ArrayList<>(AppConfigs.PROFILE_PICTURE_NUM);\n        for (int i = 0; i < AppConfigs.PROFILE_PICTURE_NUM; i++) {\n            Rect rect = new Rect((i % pictureInRow) * width, (i / pictureInRow) * width,\n                    (i % pictureInRow + 1) * width, (i / pictureInRow + 1) * width);\n            rectList.add(rect);\n        }\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        if (bitmaps == null) {\n            super.onDraw(canvas);\n        } else {\n            for (int i = 0; i < bitmaps.size(); i++) {\n                if (bitmaps.get(i) != null) {\n                    canvas.drawBitmap(bitmaps.get(i), null, rectList.get(i), mPaint); // 画图\n                }\n            }\n        }\n    }\n\n}\n\n```\n布局文件中使用：\n```\n<com.android.widget.JointImageView\n    android:id=\"@+id/my_profile_background\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:scaleType=\"centerCrop\"\n    android:src=\"@drawable/background\" />\n```\n项目中使用的Universal-Image-Loader三方库进行图片的加载。\n\n下载图片的异步任务代码：\n```\nprivate class BitmapLoaderTask extends AsyncTask<String[], Integer, List<Bitmap>> {\n\n    private List<Bitmap> bitmaps;\n\n    public BitmapLoaderTask() {\n        bitmaps = new ArrayList<>(AppConfigs.PROFILE_PICTURE_NUM);\n    }\n\n    @Override\n    protected List<Bitmap> doInBackground(String[]... params) {\n        ImageSize imageSize = new ImageSize(80, 80); // 图片压缩到80*80的大小\n        for (int i = 0; i < params[0].length && i < AppConfigs.PROFILE_PICTURE_NUM; i++) {\n            // 使用UIL同步下载图片的方法下载图片，存到bitmap数组\n            Bitmap bitmap = ImageLoader.getInstance().loadImageSync(params[0][i], imageSize);\n            bitmaps.add(bitmap);\n        }\n        return bitmaps;\n    }\n\n    @Override\n    protected void onPostExecute(List<Bitmap> bitmaps) {\n        // 全部下载完毕，通知View进行重绘\n        if (bitmaps != null && bitmaps.size() == AppConfigs.PROFILE_PICTURE_NUM) {\n            profileBackground.setBitmaps(bitmaps);\n        }\n    }\n\n    @Override\n    protected void onCancelled() {\n        super.onCancelled();\n    }\n}\n```\n通过方案三，在实现当下需求的同时，也可以作为一个单独的View，在将来拓展可能的缩放等特效动画。\n\n但是也有一个缺点：必须所有的图片下载完毕才进行刷新。\n\n当然，也可以将刷新策略调整成下载一张刷新一次，这个就得看具体的需求了。\n\n## 题外话\n对于图片中的阴影效果，我们可以采用alpha背景来实现。也可以通过色彩矩阵在绘制的时候进行调整。\n\n通过alpha背景实现很简单，在FrameLayout上遮罩一个View，alpha设置成相应的值即可。\n```\n<View\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:alpha=\"0.7\"\n    android:background=\"#000000\" />\n```\n通过色彩矩阵就得不停的调整了。\n```\n// 生成色彩矩阵  \nColorMatrix colorMatrix = new ColorMatrix(new float[]{  \n        0.5F, 0, 0, 0, 0,  \n        0, 0.5F, 0, 0, 0,  \n        0, 0, 0.5F, 0, 0,  \n        0, 0, 0, 1, 0,  \n});  \nmPaint.setColorFilter(new ColorMatrixColorFilter(colorMatrix));  // 画笔设置色彩矩阵，这样再绘制的时候就会有效果了\n```\n","source":"_posts/photo-wall.md","raw":"---\ntitle: Android实现照片墙背景\ndate: 2016-02-17 17:34:49\ntags:\n - 自定义View\n---\n\n项目开发中，有一个这样的需求：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/02/photo-wall1.png)\n在个人主页里会有12张图片的背景墙。这12张图片由服务器返回，会不定时刷新。\n\n---\n## 第一种方案\n起初，自己的实现思路是：xml直接定义12个ImageView，然后在接收到图片路径后，再进行异步加载。\n\n显然，这种方法是肯定可以的，但是却显得不“优雅”。而且后续可能会对这整个背景墙有个缩放的动画之类的，那么再实现起来便会比较复杂了。\n\n## 第二种方案\n\n之后，我想到了GridView，显然也是可以的，在得到图片路径后传入到Adapter中即可。比起方案一稍微“优雅”些，但是也是很难将这个背景墙当成一个整体，进行将来可能会添加的动画特效需求。\n\n## 第三种方案\n\n最后，我想到，既然要当成一整个整体，那么自定义View或许是个不错的办法。\n\n<!--more-->\n\n### 思路\n思路是这样的：\n\n 1. 首先ImageView展示初始图片；\n 2. 下载图片；\n 3. 所有图片下载完成后刷新View，显示下载的图片墙。\n\n下面上代码。\n\n### 代码\n自定义ImageView：\n```\npublic class JointImageView extends ImageView {\n\n    private Paint mPaint;// 画笔\n    private List<Bitmap> bitmaps;// 位图\n    private List<Rect> rectList; // 正方形画bitmap\n    private int width; // 边长\n    private static int pictureInRow = 4; // 每一行显示4张图片\n\n\n    public JointImageView(Context context) {\n        super(context);\n    }\n\n    public JointImageView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        mPaint = new Paint(Paint.ANTI_ALIAS_FLAG);\n    }\n\n    /**\n     * 设置Bitmap数据\n     *\n     * @param bitmaps\n     */\n    public void setBitmaps(List<Bitmap> bitmaps) {\n        this.bitmaps = bitmaps;\n        width = getMeasuredWidth() / pictureInRow;\n        createRect();\n        postInvalidate(); // 在设置Bitmaps之后重绘\n    }\n\n    private void createRect() { // 计算12个矩形的坐标\n        rectList = new ArrayList<>(AppConfigs.PROFILE_PICTURE_NUM);\n        for (int i = 0; i < AppConfigs.PROFILE_PICTURE_NUM; i++) {\n            Rect rect = new Rect((i % pictureInRow) * width, (i / pictureInRow) * width,\n                    (i % pictureInRow + 1) * width, (i / pictureInRow + 1) * width);\n            rectList.add(rect);\n        }\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        if (bitmaps == null) {\n            super.onDraw(canvas);\n        } else {\n            for (int i = 0; i < bitmaps.size(); i++) {\n                if (bitmaps.get(i) != null) {\n                    canvas.drawBitmap(bitmaps.get(i), null, rectList.get(i), mPaint); // 画图\n                }\n            }\n        }\n    }\n\n}\n\n```\n布局文件中使用：\n```\n<com.android.widget.JointImageView\n    android:id=\"@+id/my_profile_background\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:scaleType=\"centerCrop\"\n    android:src=\"@drawable/background\" />\n```\n项目中使用的Universal-Image-Loader三方库进行图片的加载。\n\n下载图片的异步任务代码：\n```\nprivate class BitmapLoaderTask extends AsyncTask<String[], Integer, List<Bitmap>> {\n\n    private List<Bitmap> bitmaps;\n\n    public BitmapLoaderTask() {\n        bitmaps = new ArrayList<>(AppConfigs.PROFILE_PICTURE_NUM);\n    }\n\n    @Override\n    protected List<Bitmap> doInBackground(String[]... params) {\n        ImageSize imageSize = new ImageSize(80, 80); // 图片压缩到80*80的大小\n        for (int i = 0; i < params[0].length && i < AppConfigs.PROFILE_PICTURE_NUM; i++) {\n            // 使用UIL同步下载图片的方法下载图片，存到bitmap数组\n            Bitmap bitmap = ImageLoader.getInstance().loadImageSync(params[0][i], imageSize);\n            bitmaps.add(bitmap);\n        }\n        return bitmaps;\n    }\n\n    @Override\n    protected void onPostExecute(List<Bitmap> bitmaps) {\n        // 全部下载完毕，通知View进行重绘\n        if (bitmaps != null && bitmaps.size() == AppConfigs.PROFILE_PICTURE_NUM) {\n            profileBackground.setBitmaps(bitmaps);\n        }\n    }\n\n    @Override\n    protected void onCancelled() {\n        super.onCancelled();\n    }\n}\n```\n通过方案三，在实现当下需求的同时，也可以作为一个单独的View，在将来拓展可能的缩放等特效动画。\n\n但是也有一个缺点：必须所有的图片下载完毕才进行刷新。\n\n当然，也可以将刷新策略调整成下载一张刷新一次，这个就得看具体的需求了。\n\n## 题外话\n对于图片中的阴影效果，我们可以采用alpha背景来实现。也可以通过色彩矩阵在绘制的时候进行调整。\n\n通过alpha背景实现很简单，在FrameLayout上遮罩一个View，alpha设置成相应的值即可。\n```\n<View\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:alpha=\"0.7\"\n    android:background=\"#000000\" />\n```\n通过色彩矩阵就得不停的调整了。\n```\n// 生成色彩矩阵  \nColorMatrix colorMatrix = new ColorMatrix(new float[]{  \n        0.5F, 0, 0, 0, 0,  \n        0, 0.5F, 0, 0, 0,  \n        0, 0, 0.5F, 0, 0,  \n        0, 0, 0, 1, 0,  \n});  \nmPaint.setColorFilter(new ColorMatrixColorFilter(colorMatrix));  // 画笔设置色彩矩阵，这样再绘制的时候就会有效果了\n```\n","slug":"photo-wall","published":1,"updated":"2016-11-21T10:02:17.917Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759w002c1cb8qgh1wky3","content":"<p>项目开发中，有一个这样的需求：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/photo-wall1.png\" alt=\"这里写图片描述\"><br>在个人主页里会有12张图片的背景墙。这12张图片由服务器返回，会不定时刷新。</p>\n<hr>\n<h2 id=\"第一种方案\"><a href=\"#第一种方案\" class=\"headerlink\" title=\"第一种方案\"></a>第一种方案</h2><p>起初，自己的实现思路是：xml直接定义12个ImageView，然后在接收到图片路径后，再进行异步加载。</p>\n<p>显然，这种方法是肯定可以的，但是却显得不“优雅”。而且后续可能会对这整个背景墙有个缩放的动画之类的，那么再实现起来便会比较复杂了。</p>\n<h2 id=\"第二种方案\"><a href=\"#第二种方案\" class=\"headerlink\" title=\"第二种方案\"></a>第二种方案</h2><p>之后，我想到了GridView，显然也是可以的，在得到图片路径后传入到Adapter中即可。比起方案一稍微“优雅”些，但是也是很难将这个背景墙当成一个整体，进行将来可能会添加的动画特效需求。</p>\n<h2 id=\"第三种方案\"><a href=\"#第三种方案\" class=\"headerlink\" title=\"第三种方案\"></a>第三种方案</h2><p>最后，我想到，既然要当成一整个整体，那么自定义View或许是个不错的办法。</p>\n<a id=\"more\"></a>\n<h3 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h3><p>思路是这样的：</p>\n<ol>\n<li>首先ImageView展示初始图片；</li>\n<li>下载图片；</li>\n<li>所有图片下载完成后刷新View，显示下载的图片墙。</li>\n</ol>\n<p>下面上代码。</p>\n<h3 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h3><p>自定义ImageView：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> class JointImageView extends ImageView &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint mPaint;<span class=\"comment\">// 画笔</span></div><div class=\"line\">    <span class=\"keyword\">private</span> List&lt;Bitmap&gt; bitmaps;<span class=\"comment\">// 位图</span></div><div class=\"line\">    <span class=\"keyword\">private</span> List&lt;Rect&gt; rectList; <span class=\"comment\">// 正方形画bitmap</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"built_in\">int</span> <span class=\"built_in\">width</span>; <span class=\"comment\">// 边长</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"built_in\">int</span> pictureInRow = <span class=\"number\">4</span>; <span class=\"comment\">// 每一行显示4张图片</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> JointImageView(Context context) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> JointImageView(Context context, AttributeSet attrs) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        mPaint = <span class=\"keyword\">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 设置Bitmap数据</div><div class=\"line\">     *</div><div class=\"line\">     * @param bitmaps</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> setBitmaps(List&lt;Bitmap&gt; bitmaps) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.bitmaps = bitmaps;</div><div class=\"line\">        <span class=\"built_in\">width</span> = getMeasuredWidth() / pictureInRow;</div><div class=\"line\">        createRect();</div><div class=\"line\">        postInvalidate(); <span class=\"comment\">// 在设置Bitmaps之后重绘</span></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> createRect() &#123; <span class=\"comment\">// 计算12个矩形的坐标</span></div><div class=\"line\">        rectList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(AppConfigs.PROFILE_PICTURE_NUM);</div><div class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"built_in\">int</span> i = <span class=\"number\">0</span>; i &lt; AppConfigs.PROFILE_PICTURE_NUM; i++) &#123;</div><div class=\"line\">            Rect <span class=\"built_in\">rect</span> = <span class=\"keyword\">new</span> Rect((i % pictureInRow) * <span class=\"built_in\">width</span>, (i / pictureInRow) * <span class=\"built_in\">width</span>,</div><div class=\"line\">                    (i % pictureInRow + <span class=\"number\">1</span>) * <span class=\"built_in\">width</span>, (i / pictureInRow + <span class=\"number\">1</span>) * <span class=\"built_in\">width</span>);</div><div class=\"line\">            rectList.<span class=\"built_in\">add</span>(<span class=\"built_in\">rect</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onDraw(Canvas canvas) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (bitmaps == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"built_in\">int</span> i = <span class=\"number\">0</span>; i &lt; bitmaps.<span class=\"built_in\">size</span>(); i++) &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (bitmaps.<span class=\"built_in\">get</span>(i) != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    canvas.drawBitmap(bitmaps.<span class=\"built_in\">get</span>(i), <span class=\"keyword\">null</span>, rectList.<span class=\"built_in\">get</span>(i), mPaint); <span class=\"comment\">// 画图</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>布局文件中使用：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.widget</span><span class=\"selector-class\">.JointImageView</span></div><div class=\"line\">    android:id=<span class=\"string\">\"@+id/my_profile_background\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:scaleType=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">    android:src=<span class=\"string\">\"@drawable/background\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>项目中使用的Universal-Image-Loader三方库进行图片的加载。</p>\n<p>下载图片的异步任务代码：<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BitmapLoaderTask</span> <span class=\"keyword\">extends</span> <span class=\"title\">AsyncTask&lt;String</span>[], <span class=\"title\">Integer</span>, <span class=\"title\">List&lt;Bitmap&gt;&gt;</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">List</span>&lt;<span class=\"type\">Bitmap</span>&gt; bitmaps;</div><div class=\"line\"></div><div class=\"line\">    public <span class=\"type\">BitmapLoaderTask</span>() &#123;</div><div class=\"line\">        bitmaps = <span class=\"keyword\">new</span> <span class=\"type\">ArrayList</span>&lt;&gt;(<span class=\"type\">AppConfigs</span>.<span class=\"type\">PROFILE_PICTURE_NUM</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">List</span>&lt;<span class=\"type\">Bitmap</span>&gt; doInBackground(<span class=\"type\">String</span>[]... params) &#123;</div><div class=\"line\">        <span class=\"type\">ImageSize</span> imageSize = <span class=\"keyword\">new</span> <span class=\"type\">ImageSize</span>(<span class=\"number\">80</span>, <span class=\"number\">80</span>); <span class=\"comment\">// 图片压缩到80*80的大小</span></div><div class=\"line\">        <span class=\"keyword\">for</span> (int i = <span class=\"number\">0</span>; i &lt; params[<span class=\"number\">0</span>].length &amp;&amp; i &lt; <span class=\"type\">AppConfigs</span>.<span class=\"type\">PROFILE_PICTURE_NUM</span>; i++) &#123;</div><div class=\"line\">            <span class=\"comment\">// 使用UIL同步下载图片的方法下载图片，存到bitmap数组</span></div><div class=\"line\">            <span class=\"type\">Bitmap</span> bitmap = <span class=\"type\">ImageLoader</span>.getInstance().loadImageSync(params[<span class=\"number\">0</span>][i], imageSize);</div><div class=\"line\">            bitmaps.add(bitmap);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> bitmaps;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onPostExecute(<span class=\"type\">List</span>&lt;<span class=\"type\">Bitmap</span>&gt; bitmaps) &#123;</div><div class=\"line\">        <span class=\"comment\">// 全部下载完毕，通知View进行重绘</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (bitmaps != <span class=\"literal\">null</span> &amp;&amp; bitmaps.size() == <span class=\"type\">AppConfigs</span>.<span class=\"type\">PROFILE_PICTURE_NUM</span>) &#123;</div><div class=\"line\">            profileBackground.setBitmaps(bitmaps);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onCancelled() &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCancelled();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过方案三，在实现当下需求的同时，也可以作为一个单独的View，在将来拓展可能的缩放等特效动画。</p>\n<p>但是也有一个缺点：必须所有的图片下载完毕才进行刷新。</p>\n<p>当然，也可以将刷新策略调整成下载一张刷新一次，这个就得看具体的需求了。</p>\n<h2 id=\"题外话\"><a href=\"#题外话\" class=\"headerlink\" title=\"题外话\"></a>题外话</h2><p>对于图片中的阴影效果，我们可以采用alpha背景来实现。也可以通过色彩矩阵在绘制的时候进行调整。</p>\n<p>通过alpha背景实现很简单，在FrameLayout上遮罩一个View，alpha设置成相应的值即可。<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;View</div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:<span class=\"built_in\">alpha</span>=<span class=\"string\">\"0.7\"</span></div><div class=\"line\">    android:<span class=\"built_in\">background</span>=<span class=\"string\">\"#000000\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>通过色彩矩阵就得不停的调整了。<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 生成色彩矩阵  </span></div><div class=\"line\">ColorMatrix colorMatrix = new ColorMatrix(new <span class=\"type\">float</span>[]&#123;  </div><div class=\"line\">        <span class=\"number\">0.5</span>F, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>,  </div><div class=\"line\">        <span class=\"number\">0</span>, <span class=\"number\">0.5</span>F, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>,  </div><div class=\"line\">        <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0.5</span>F, <span class=\"number\">0</span>, <span class=\"number\">0</span>,  </div><div class=\"line\">        <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>,  </div><div class=\"line\">&#125;);  </div><div class=\"line\">mPaint.setColorFilter(new ColorMatrixColorFilter(colorMatrix));  <span class=\"comment\">// 画笔设置色彩矩阵，这样再绘制的时候就会有效果了</span></div></pre></td></tr></table></figure></p>\n","excerpt":"<p>项目开发中，有一个这样的需求：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/02/photo-wall1.png\" alt=\"这里写图片描述\"><br>在个人主页里会有12张图片的背景墙。这12张图片由服务器返回，会不定时刷新。</p>\n<hr>\n<h2 id=\"第一种方案\"><a href=\"#第一种方案\" class=\"headerlink\" title=\"第一种方案\"></a>第一种方案</h2><p>起初，自己的实现思路是：xml直接定义12个ImageView，然后在接收到图片路径后，再进行异步加载。</p>\n<p>显然，这种方法是肯定可以的，但是却显得不“优雅”。而且后续可能会对这整个背景墙有个缩放的动画之类的，那么再实现起来便会比较复杂了。</p>\n<h2 id=\"第二种方案\"><a href=\"#第二种方案\" class=\"headerlink\" title=\"第二种方案\"></a>第二种方案</h2><p>之后，我想到了GridView，显然也是可以的，在得到图片路径后传入到Adapter中即可。比起方案一稍微“优雅”些，但是也是很难将这个背景墙当成一个整体，进行将来可能会添加的动画特效需求。</p>\n<h2 id=\"第三种方案\"><a href=\"#第三种方案\" class=\"headerlink\" title=\"第三种方案\"></a>第三种方案</h2><p>最后，我想到，既然要当成一整个整体，那么自定义View或许是个不错的办法。</p>","more":"<h3 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h3><p>思路是这样的：</p>\n<ol>\n<li>首先ImageView展示初始图片；</li>\n<li>下载图片；</li>\n<li>所有图片下载完成后刷新View，显示下载的图片墙。</li>\n</ol>\n<p>下面上代码。</p>\n<h3 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h3><p>自定义ImageView：<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> class JointImageView extends ImageView &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Paint mPaint;<span class=\"comment\">// 画笔</span></div><div class=\"line\">    <span class=\"keyword\">private</span> List&lt;Bitmap&gt; bitmaps;<span class=\"comment\">// 位图</span></div><div class=\"line\">    <span class=\"keyword\">private</span> List&lt;Rect&gt; rectList; <span class=\"comment\">// 正方形画bitmap</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"built_in\">int</span> <span class=\"built_in\">width</span>; <span class=\"comment\">// 边长</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"built_in\">int</span> pictureInRow = <span class=\"number\">4</span>; <span class=\"comment\">// 每一行显示4张图片</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> JointImageView(Context context) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> JointImageView(Context context, AttributeSet attrs) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        mPaint = <span class=\"keyword\">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 设置Bitmap数据</div><div class=\"line\">     *</div><div class=\"line\">     * @param bitmaps</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> setBitmaps(List&lt;Bitmap&gt; bitmaps) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.bitmaps = bitmaps;</div><div class=\"line\">        <span class=\"built_in\">width</span> = getMeasuredWidth() / pictureInRow;</div><div class=\"line\">        createRect();</div><div class=\"line\">        postInvalidate(); <span class=\"comment\">// 在设置Bitmaps之后重绘</span></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> createRect() &#123; <span class=\"comment\">// 计算12个矩形的坐标</span></div><div class=\"line\">        rectList = <span class=\"keyword\">new</span> ArrayList&lt;&gt;(AppConfigs.PROFILE_PICTURE_NUM);</div><div class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"built_in\">int</span> i = <span class=\"number\">0</span>; i &lt; AppConfigs.PROFILE_PICTURE_NUM; i++) &#123;</div><div class=\"line\">            Rect <span class=\"built_in\">rect</span> = <span class=\"keyword\">new</span> Rect((i % pictureInRow) * <span class=\"built_in\">width</span>, (i / pictureInRow) * <span class=\"built_in\">width</span>,</div><div class=\"line\">                    (i % pictureInRow + <span class=\"number\">1</span>) * <span class=\"built_in\">width</span>, (i / pictureInRow + <span class=\"number\">1</span>) * <span class=\"built_in\">width</span>);</div><div class=\"line\">            rectList.<span class=\"built_in\">add</span>(<span class=\"built_in\">rect</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> onDraw(Canvas canvas) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (bitmaps == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"built_in\">int</span> i = <span class=\"number\">0</span>; i &lt; bitmaps.<span class=\"built_in\">size</span>(); i++) &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (bitmaps.<span class=\"built_in\">get</span>(i) != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    canvas.drawBitmap(bitmaps.<span class=\"built_in\">get</span>(i), <span class=\"keyword\">null</span>, rectList.<span class=\"built_in\">get</span>(i), mPaint); <span class=\"comment\">// 画图</span></div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>布局文件中使用：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;com<span class=\"selector-class\">.android</span><span class=\"selector-class\">.widget</span><span class=\"selector-class\">.JointImageView</span></div><div class=\"line\">    android:id=<span class=\"string\">\"@+id/my_profile_background\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:scaleType=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">    android:src=<span class=\"string\">\"@drawable/background\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>项目中使用的Universal-Image-Loader三方库进行图片的加载。</p>\n<p>下载图片的异步任务代码：<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BitmapLoaderTask</span> <span class=\"keyword\">extends</span> <span class=\"title\">AsyncTask&lt;String</span>[], <span class=\"title\">Integer</span>, <span class=\"title\">List&lt;Bitmap&gt;&gt;</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">List</span>&lt;<span class=\"type\">Bitmap</span>&gt; bitmaps;</div><div class=\"line\"></div><div class=\"line\">    public <span class=\"type\">BitmapLoaderTask</span>() &#123;</div><div class=\"line\">        bitmaps = <span class=\"keyword\">new</span> <span class=\"type\">ArrayList</span>&lt;&gt;(<span class=\"type\">AppConfigs</span>.<span class=\"type\">PROFILE_PICTURE_NUM</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">List</span>&lt;<span class=\"type\">Bitmap</span>&gt; doInBackground(<span class=\"type\">String</span>[]... params) &#123;</div><div class=\"line\">        <span class=\"type\">ImageSize</span> imageSize = <span class=\"keyword\">new</span> <span class=\"type\">ImageSize</span>(<span class=\"number\">80</span>, <span class=\"number\">80</span>); <span class=\"comment\">// 图片压缩到80*80的大小</span></div><div class=\"line\">        <span class=\"keyword\">for</span> (int i = <span class=\"number\">0</span>; i &lt; params[<span class=\"number\">0</span>].length &amp;&amp; i &lt; <span class=\"type\">AppConfigs</span>.<span class=\"type\">PROFILE_PICTURE_NUM</span>; i++) &#123;</div><div class=\"line\">            <span class=\"comment\">// 使用UIL同步下载图片的方法下载图片，存到bitmap数组</span></div><div class=\"line\">            <span class=\"type\">Bitmap</span> bitmap = <span class=\"type\">ImageLoader</span>.getInstance().loadImageSync(params[<span class=\"number\">0</span>][i], imageSize);</div><div class=\"line\">            bitmaps.add(bitmap);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> bitmaps;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onPostExecute(<span class=\"type\">List</span>&lt;<span class=\"type\">Bitmap</span>&gt; bitmaps) &#123;</div><div class=\"line\">        <span class=\"comment\">// 全部下载完毕，通知View进行重绘</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (bitmaps != <span class=\"literal\">null</span> &amp;&amp; bitmaps.size() == <span class=\"type\">AppConfigs</span>.<span class=\"type\">PROFILE_PICTURE_NUM</span>) &#123;</div><div class=\"line\">            profileBackground.setBitmaps(bitmaps);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onCancelled() &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCancelled();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过方案三，在实现当下需求的同时，也可以作为一个单独的View，在将来拓展可能的缩放等特效动画。</p>\n<p>但是也有一个缺点：必须所有的图片下载完毕才进行刷新。</p>\n<p>当然，也可以将刷新策略调整成下载一张刷新一次，这个就得看具体的需求了。</p>\n<h2 id=\"题外话\"><a href=\"#题外话\" class=\"headerlink\" title=\"题外话\"></a>题外话</h2><p>对于图片中的阴影效果，我们可以采用alpha背景来实现。也可以通过色彩矩阵在绘制的时候进行调整。</p>\n<p>通过alpha背景实现很简单，在FrameLayout上遮罩一个View，alpha设置成相应的值即可。<br><figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;View</div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:<span class=\"built_in\">alpha</span>=<span class=\"string\">\"0.7\"</span></div><div class=\"line\">    android:<span class=\"built_in\">background</span>=<span class=\"string\">\"#000000\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>通过色彩矩阵就得不停的调整了。<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 生成色彩矩阵  </span></div><div class=\"line\">ColorMatrix colorMatrix = new ColorMatrix(new <span class=\"type\">float</span>[]&#123;  </div><div class=\"line\">        <span class=\"number\">0.5</span>F, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>,  </div><div class=\"line\">        <span class=\"number\">0</span>, <span class=\"number\">0.5</span>F, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>,  </div><div class=\"line\">        <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0.5</span>F, <span class=\"number\">0</span>, <span class=\"number\">0</span>,  </div><div class=\"line\">        <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>,  </div><div class=\"line\">&#125;);  </div><div class=\"line\">mPaint.setColorFilter(new ColorMatrixColorFilter(colorMatrix));  <span class=\"comment\">// 画笔设置色彩矩阵，这样再绘制的时候就会有效果了</span></div></pre></td></tr></table></figure></p>"},{"title":"React Native For Android初探-问题小结","date":"2016-01-19T03:38:48.000Z","_content":"\n在[上一篇文章](http://lijia92.github.io/2016/01/15/react-native/)中，我介绍了React Native For Android的基本使用。这篇文章重点介绍一下使用过程中碰到的问题以及解决办法。\n\n## 真机运行白屏\n在执行``react-native run-android``指令编译安装apk到真机之后，运行程序，发现程序白屏，感觉像ANR一样。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips1.png)\n解决方法：手机设置中打开应用管理，选择我们安装的应用。然后点击权限管理，将显示悬浮框设置为允许。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips2.png)\n白屏问题便能解决了。\n\n<!--more-->\n\n## 真机运行提示Unable to download JS bundle\n在我们解决完白屏问题之后，重新运行程序，发现程序能运行了，但是报错了：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips3.png)\n点击Reload JS后，提示Unable to download JS bundle：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips4.png)\n解决方法：摇晃设备或按Menu键，可以打开调试菜单，点击DevSettings，选Debug server host for device，输入你的正在运行packager的那台电脑的``局域网IP加:8081``（同时要保证手机和电脑在同一网段，且没有防火墙阻拦），再按back键返回，再次打开Menu键，在调试菜单中选择Reload JS，就可以看到运行的结果了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips5.png)\n\n## Chrome调试JS\n\n 1. 安装拓展程序``React Developer Tools``。\n 2. 在模拟器或真机菜单中选择Debug JS，打开调试开关。\n 3. Chrome打开：``http://localhost:8081/debugger-ui``，按F12打开开发者工具便能进行调试。\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips6.png)\n","source":"_posts/react-native-tips.md","raw":"---\ntitle: React Native For Android初探-问题小结\ndate: 2016-01-19 11:38:48\ntags:\n - hybrid开发\n---\n\n在[上一篇文章](http://lijia92.github.io/2016/01/15/react-native/)中，我介绍了React Native For Android的基本使用。这篇文章重点介绍一下使用过程中碰到的问题以及解决办法。\n\n## 真机运行白屏\n在执行``react-native run-android``指令编译安装apk到真机之后，运行程序，发现程序白屏，感觉像ANR一样。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips1.png)\n解决方法：手机设置中打开应用管理，选择我们安装的应用。然后点击权限管理，将显示悬浮框设置为允许。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips2.png)\n白屏问题便能解决了。\n\n<!--more-->\n\n## 真机运行提示Unable to download JS bundle\n在我们解决完白屏问题之后，重新运行程序，发现程序能运行了，但是报错了：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips3.png)\n点击Reload JS后，提示Unable to download JS bundle：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips4.png)\n解决方法：摇晃设备或按Menu键，可以打开调试菜单，点击DevSettings，选Debug server host for device，输入你的正在运行packager的那台电脑的``局域网IP加:8081``（同时要保证手机和电脑在同一网段，且没有防火墙阻拦），再按back键返回，再次打开Menu键，在调试菜单中选择Reload JS，就可以看到运行的结果了。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips5.png)\n\n## Chrome调试JS\n\n 1. 安装拓展程序``React Developer Tools``。\n 2. 在模拟器或真机菜单中选择Debug JS，打开调试开关。\n 3. Chrome打开：``http://localhost:8081/debugger-ui``，按F12打开开发者工具便能进行调试。\n\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips6.png)\n","slug":"react-native-tips","published":1,"updated":"2016-11-21T10:02:38.256Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759x002e1cb8nbl6dxkl","content":"<p>在<a href=\"http://lijia92.github.io/2016/01/15/react-native/\">上一篇文章</a>中，我介绍了React Native For Android的基本使用。这篇文章重点介绍一下使用过程中碰到的问题以及解决办法。</p>\n<h2 id=\"真机运行白屏\"><a href=\"#真机运行白屏\" class=\"headerlink\" title=\"真机运行白屏\"></a>真机运行白屏</h2><p>在执行<code>react-native run-android</code>指令编译安装apk到真机之后，运行程序，发现程序白屏，感觉像ANR一样。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips1.png\" alt=\"这里写图片描述\"><br>解决方法：手机设置中打开应用管理，选择我们安装的应用。然后点击权限管理，将显示悬浮框设置为允许。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips2.png\" alt=\"这里写图片描述\"><br>白屏问题便能解决了。</p>\n<a id=\"more\"></a>\n<h2 id=\"真机运行提示Unable-to-download-JS-bundle\"><a href=\"#真机运行提示Unable-to-download-JS-bundle\" class=\"headerlink\" title=\"真机运行提示Unable to download JS bundle\"></a>真机运行提示Unable to download JS bundle</h2><p>在我们解决完白屏问题之后，重新运行程序，发现程序能运行了，但是报错了：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips3.png\" alt=\"这里写图片描述\"><br>点击Reload JS后，提示Unable to download JS bundle：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips4.png\" alt=\"这里写图片描述\"><br>解决方法：摇晃设备或按Menu键，可以打开调试菜单，点击DevSettings，选Debug server host for device，输入你的正在运行packager的那台电脑的<code>局域网IP加:8081</code>（同时要保证手机和电脑在同一网段，且没有防火墙阻拦），再按back键返回，再次打开Menu键，在调试菜单中选择Reload JS，就可以看到运行的结果了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips5.png\" alt=\"这里写图片描述\"></p>\n<h2 id=\"Chrome调试JS\"><a href=\"#Chrome调试JS\" class=\"headerlink\" title=\"Chrome调试JS\"></a>Chrome调试JS</h2><ol>\n<li>安装拓展程序<code>React Developer Tools</code>。</li>\n<li>在模拟器或真机菜单中选择Debug JS，打开调试开关。</li>\n<li>Chrome打开：<code>http://localhost:8081/debugger-ui</code>，按F12打开开发者工具便能进行调试。</li>\n</ol>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips6.png\" alt=\"这里写图片描述\"></p>\n","excerpt":"<p>在<a href=\"http://lijia92.github.io/2016/01/15/react-native/\">上一篇文章</a>中，我介绍了React Native For Android的基本使用。这篇文章重点介绍一下使用过程中碰到的问题以及解决办法。</p>\n<h2 id=\"真机运行白屏\"><a href=\"#真机运行白屏\" class=\"headerlink\" title=\"真机运行白屏\"></a>真机运行白屏</h2><p>在执行<code>react-native run-android</code>指令编译安装apk到真机之后，运行程序，发现程序白屏，感觉像ANR一样。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips1.png\" alt=\"这里写图片描述\"><br>解决方法：手机设置中打开应用管理，选择我们安装的应用。然后点击权限管理，将显示悬浮框设置为允许。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips2.png\" alt=\"这里写图片描述\"><br>白屏问题便能解决了。</p>","more":"<h2 id=\"真机运行提示Unable-to-download-JS-bundle\"><a href=\"#真机运行提示Unable-to-download-JS-bundle\" class=\"headerlink\" title=\"真机运行提示Unable to download JS bundle\"></a>真机运行提示Unable to download JS bundle</h2><p>在我们解决完白屏问题之后，重新运行程序，发现程序能运行了，但是报错了：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips3.png\" alt=\"这里写图片描述\"><br>点击Reload JS后，提示Unable to download JS bundle：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips4.png\" alt=\"这里写图片描述\"><br>解决方法：摇晃设备或按Menu键，可以打开调试菜单，点击DevSettings，选Debug server host for device，输入你的正在运行packager的那台电脑的<code>局域网IP加:8081</code>（同时要保证手机和电脑在同一网段，且没有防火墙阻拦），再按back键返回，再次打开Menu键，在调试菜单中选择Reload JS，就可以看到运行的结果了。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips5.png\" alt=\"这里写图片描述\"></p>\n<h2 id=\"Chrome调试JS\"><a href=\"#Chrome调试JS\" class=\"headerlink\" title=\"Chrome调试JS\"></a>Chrome调试JS</h2><ol>\n<li>安装拓展程序<code>React Developer Tools</code>。</li>\n<li>在模拟器或真机菜单中选择Debug JS，打开调试开关。</li>\n<li>Chrome打开：<code>http://localhost:8081/debugger-ui</code>，按F12打开开发者工具便能进行调试。</li>\n</ol>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native-tips6.png\" alt=\"这里写图片描述\"></p>"},{"title":"android PopupWindow在控件上方显示","date":"2016-06-02T08:26:54.000Z","_content":"\n项目中有这样一个需求：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow1.png)\n\n用户点击送礼物，会弹出一个礼物选择对话框，然后在选择一个礼物之后，可以选择礼物数量，按照图中的意思，选择数量很自然的想到了用``PopupWindow``来做了。但是这里有一个问题就是：弹出来的数量选择框是需要在数量显示栏的上方的。\n\n如果是在下方，那很简单，直接``popupWindow.showAsDropDown(v);``即可。但若是在上方，则需要自己计算坐标了，然后通过``showAtLocation()``方法来显示。\n\n<!-- more -->\n\n首先贴一下大致的布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"wrap_content\"\n    android:orientation=\"vertical\">\n\n    <FrameLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\">\n\n        <com.miamusic.android.live.ui.widget.CertainScaleImageView\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\"\n            android:scaleType=\"centerCrop\"\n            android:src=\"@drawable/gift_background\"\n            android:visibility=\"visible\"\n            app:radio=\"0.667\" />\n\n        <com.miamusic.android.live.ui.widget.WrapContentViewPager\n            android:id=\"@+id/gift_view_pager\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\" />\n\n    </FrameLayout>\n\n    <LinearLayout\n        android:id=\"@+id/gift_recharge_layout\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:background=\"#000000\"\n        android:gravity=\"center\"\n        android:orientation=\"horizontal\"\n        android:paddingBottom=\"24dp\"\n        android:paddingLeft=\"16dp\"\n        android:paddingRight=\"16dp\"\n        android:paddingTop=\"24dp\">\n\n        <TextView\n            android:id=\"@+id/gift_remain_coin\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:drawablePadding=\"2dp\"\n            android:drawableRight=\"@drawable/m_coin_small\"\n            android:minWidth=\"24dp\"\n            android:textColor=\"#C4AF94\"\n            android:textSize=\"15sp\" />\n\n        <TextView\n            android:id=\"@+id/gift_recharge\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:gravity=\"center\"\n            android:paddingBottom=\"4dp\"\n            android:paddingLeft=\"8dp\"\n            android:paddingTop=\"4dp\"\n            android:text=\"充值 >\"\n            android:textColor=\"@color/white\"\n            android:textSize=\"14sp\" />\n\n        <android.support.v4.widget.Space\n            android:layout_width=\"0dp\"\n            android:layout_height=\"match_parent\"\n            android:layout_weight=\"1\" />\n\n        <LinearLayout\n            android:id=\"@+id/choose_gift_count\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:background=\"@drawable/follow_button_background\"\n            android:gravity=\"center\"\n            android:paddingBottom=\"8dp\"\n            android:paddingLeft=\"12dp\"\n            android:paddingRight=\"12dp\"\n            android:paddingTop=\"8dp\"\n            android:visibility=\"visible\">\n\n            <TextView\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:gravity=\"center\"\n                android:text=\"数量\"\n                android:textColor=\"@color/white\"\n                android:textSize=\"14sp\" />\n\n            <TextView\n                android:id=\"@+id/send_gift_count\"\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:layout_marginLeft=\"4dp\"\n                android:gravity=\"left\"\n                android:text=\"1\"\n                android:textColor=\"@color/white\"\n                android:textSize=\"14sp\" />\n\n            <ImageView\n                android:layout_width=\"16dp\"\n                android:layout_height=\"16dp\"\n                android:src=\"@drawable/btn_up_white\" />\n\n        </LinearLayout>\n\n        <TextView\n            android:id=\"@+id/gift_send\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"wrap_content\"\n            android:layout_gravity=\"center\"\n            android:layout_marginLeft=\"16dp\"\n            android:background=\"@drawable/reward_album\"\n            android:gravity=\"center\"\n            android:paddingBottom=\"8dp\"\n            android:paddingTop=\"8dp\"\n            android:text=\"送礼物\"\n            android:textColor=\"@color/black\"\n            android:textSize=\"14sp\" />\n\n    </LinearLayout>\n\n</LinearLayout>\n```\n对应界面的预览如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow4.png)\n\n这里贴一下Android中的坐标体系：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow3.png)\n根据这个图，再来计算坐标值。\n\n这里我在图中做了一下标注：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow2.png)\npopupwindow的y坐标应该是``1的高度 + 2的高度 - popupwindow的高度``。\n\n1的高度即是gift_recharge_layout对应view.getTop()，2的高度即是choose_gift_count对应view.getTop()。\n\npopupwindow的高度，我们通过调用一次``measure()``方法然后通过``getMeasuredHeight()``获取。\n\n那么最终popupwindow的y坐标便计算出来了，横坐标的计算比较简单，就不多说了。x、y计算完之后通过``showAtLocation``进行设置即可。\n\n下面给下示例的片段代码：\n```\npopupParent = (LinearLayout) findViewById(R.id.gift_recharge_layout);\nchooseCount.setOnClickListener(new View.OnClickListener() {\n    @Override\n    public void onClick(View v) {\n        final View convertView = LayoutInflater.from(mContext).inflate(R.layout.choose_count_popup_window, null);\n        ListView listView = (ListView) convertView.findViewById(R.id.count_list);\n        listView.setAdapter(new CountAdapter());\n        // 弹出PopupWindow\n        final PopupWindow popupWindow = new PopupWindow(convertView, LinearLayout.LayoutParams.WRAP_CONTENT, LinearLayout.LayoutParams.WRAP_CONTENT, true);\n        popupWindow.setTouchable(true);\n        popupWindow.setBackgroundDrawable(mContext.getResources().getDrawable(\n                android.R.color.transparent));\n        // 执行measure操作，以便后面获取高宽\n        convertView.measure(View.MeasureSpec.UNSPECIFIED, View.MeasureSpec.UNSPECIFIED);\n        int x = v.getLeft();\n        // 对应2的高度\n        int y1 = v.getTop();\n        // 对应1的高度\n        int y2 = popupParent.getTop();\n        // 设置PopupWindow显示的位置，\n        popupWindow.showAsDropDown(v);\n        popupWindow.showAtLocation(v, Gravity.NO_GRAVITY, x + v.getMeasuredWidth() / 2 - convertView.getMeasuredWidth() / 2, (y1 + y2 - 10) - convertView.getMeasuredHeight());\n\n        listView.setOnItemClickListener(new AdapterView.OnItemClickListener() {\n            @Override\n            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {\n                popupWindow.dismiss();\n                sendCount.setText(counts[position]);\n            }\n        });\n    }\n});\n```\n","source":"_posts/popupwindow.md","raw":"---\ntitle: android PopupWindow在控件上方显示\ndate: 2016-06-02 16:26:54\ntags:\n - 日常开发\n---\n\n项目中有这样一个需求：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow1.png)\n\n用户点击送礼物，会弹出一个礼物选择对话框，然后在选择一个礼物之后，可以选择礼物数量，按照图中的意思，选择数量很自然的想到了用``PopupWindow``来做了。但是这里有一个问题就是：弹出来的数量选择框是需要在数量显示栏的上方的。\n\n如果是在下方，那很简单，直接``popupWindow.showAsDropDown(v);``即可。但若是在上方，则需要自己计算坐标了，然后通过``showAtLocation()``方法来显示。\n\n<!-- more -->\n\n首先贴一下大致的布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"wrap_content\"\n    android:orientation=\"vertical\">\n\n    <FrameLayout\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\">\n\n        <com.miamusic.android.live.ui.widget.CertainScaleImageView\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\"\n            android:scaleType=\"centerCrop\"\n            android:src=\"@drawable/gift_background\"\n            android:visibility=\"visible\"\n            app:radio=\"0.667\" />\n\n        <com.miamusic.android.live.ui.widget.WrapContentViewPager\n            android:id=\"@+id/gift_view_pager\"\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"wrap_content\" />\n\n    </FrameLayout>\n\n    <LinearLayout\n        android:id=\"@+id/gift_recharge_layout\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:background=\"#000000\"\n        android:gravity=\"center\"\n        android:orientation=\"horizontal\"\n        android:paddingBottom=\"24dp\"\n        android:paddingLeft=\"16dp\"\n        android:paddingRight=\"16dp\"\n        android:paddingTop=\"24dp\">\n\n        <TextView\n            android:id=\"@+id/gift_remain_coin\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:drawablePadding=\"2dp\"\n            android:drawableRight=\"@drawable/m_coin_small\"\n            android:minWidth=\"24dp\"\n            android:textColor=\"#C4AF94\"\n            android:textSize=\"15sp\" />\n\n        <TextView\n            android:id=\"@+id/gift_recharge\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:gravity=\"center\"\n            android:paddingBottom=\"4dp\"\n            android:paddingLeft=\"8dp\"\n            android:paddingTop=\"4dp\"\n            android:text=\"充值 >\"\n            android:textColor=\"@color/white\"\n            android:textSize=\"14sp\" />\n\n        <android.support.v4.widget.Space\n            android:layout_width=\"0dp\"\n            android:layout_height=\"match_parent\"\n            android:layout_weight=\"1\" />\n\n        <LinearLayout\n            android:id=\"@+id/choose_gift_count\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:background=\"@drawable/follow_button_background\"\n            android:gravity=\"center\"\n            android:paddingBottom=\"8dp\"\n            android:paddingLeft=\"12dp\"\n            android:paddingRight=\"12dp\"\n            android:paddingTop=\"8dp\"\n            android:visibility=\"visible\">\n\n            <TextView\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:gravity=\"center\"\n                android:text=\"数量\"\n                android:textColor=\"@color/white\"\n                android:textSize=\"14sp\" />\n\n            <TextView\n                android:id=\"@+id/send_gift_count\"\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:layout_marginLeft=\"4dp\"\n                android:gravity=\"left\"\n                android:text=\"1\"\n                android:textColor=\"@color/white\"\n                android:textSize=\"14sp\" />\n\n            <ImageView\n                android:layout_width=\"16dp\"\n                android:layout_height=\"16dp\"\n                android:src=\"@drawable/btn_up_white\" />\n\n        </LinearLayout>\n\n        <TextView\n            android:id=\"@+id/gift_send\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"wrap_content\"\n            android:layout_gravity=\"center\"\n            android:layout_marginLeft=\"16dp\"\n            android:background=\"@drawable/reward_album\"\n            android:gravity=\"center\"\n            android:paddingBottom=\"8dp\"\n            android:paddingTop=\"8dp\"\n            android:text=\"送礼物\"\n            android:textColor=\"@color/black\"\n            android:textSize=\"14sp\" />\n\n    </LinearLayout>\n\n</LinearLayout>\n```\n对应界面的预览如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow4.png)\n\n这里贴一下Android中的坐标体系：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow3.png)\n根据这个图，再来计算坐标值。\n\n这里我在图中做了一下标注：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow2.png)\npopupwindow的y坐标应该是``1的高度 + 2的高度 - popupwindow的高度``。\n\n1的高度即是gift_recharge_layout对应view.getTop()，2的高度即是choose_gift_count对应view.getTop()。\n\npopupwindow的高度，我们通过调用一次``measure()``方法然后通过``getMeasuredHeight()``获取。\n\n那么最终popupwindow的y坐标便计算出来了，横坐标的计算比较简单，就不多说了。x、y计算完之后通过``showAtLocation``进行设置即可。\n\n下面给下示例的片段代码：\n```\npopupParent = (LinearLayout) findViewById(R.id.gift_recharge_layout);\nchooseCount.setOnClickListener(new View.OnClickListener() {\n    @Override\n    public void onClick(View v) {\n        final View convertView = LayoutInflater.from(mContext).inflate(R.layout.choose_count_popup_window, null);\n        ListView listView = (ListView) convertView.findViewById(R.id.count_list);\n        listView.setAdapter(new CountAdapter());\n        // 弹出PopupWindow\n        final PopupWindow popupWindow = new PopupWindow(convertView, LinearLayout.LayoutParams.WRAP_CONTENT, LinearLayout.LayoutParams.WRAP_CONTENT, true);\n        popupWindow.setTouchable(true);\n        popupWindow.setBackgroundDrawable(mContext.getResources().getDrawable(\n                android.R.color.transparent));\n        // 执行measure操作，以便后面获取高宽\n        convertView.measure(View.MeasureSpec.UNSPECIFIED, View.MeasureSpec.UNSPECIFIED);\n        int x = v.getLeft();\n        // 对应2的高度\n        int y1 = v.getTop();\n        // 对应1的高度\n        int y2 = popupParent.getTop();\n        // 设置PopupWindow显示的位置，\n        popupWindow.showAsDropDown(v);\n        popupWindow.showAtLocation(v, Gravity.NO_GRAVITY, x + v.getMeasuredWidth() / 2 - convertView.getMeasuredWidth() / 2, (y1 + y2 - 10) - convertView.getMeasuredHeight());\n\n        listView.setOnItemClickListener(new AdapterView.OnItemClickListener() {\n            @Override\n            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {\n                popupWindow.dismiss();\n                sendCount.setText(counts[position]);\n            }\n        });\n    }\n});\n```\n","slug":"popupwindow","published":1,"updated":"2016-11-21T10:02:27.476Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e759z002g1cb8m8fddsqw","content":"<p>项目中有这样一个需求：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow1.png\" alt=\"\"></p>\n<p>用户点击送礼物，会弹出一个礼物选择对话框，然后在选择一个礼物之后，可以选择礼物数量，按照图中的意思，选择数量很自然的想到了用<code>PopupWindow</code>来做了。但是这里有一个问题就是：弹出来的数量选择框是需要在数量显示栏的上方的。</p>\n<p>如果是在下方，那很简单，直接<code>popupWindow.showAsDropDown(v);</code>即可。但若是在上方，则需要自己计算坐标了，然后通过<code>showAtLocation()</code>方法来显示。</p>\n<a id=\"more\"></a>\n<p>首先贴一下大致的布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">com.miamusic.android.live.ui.widget.CertainScaleImageView</span></span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">            <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/gift_background\"</span></div><div class=\"line\">            <span class=\"attr\">android:visibility</span>=<span class=\"string\">\"visible\"</span></div><div class=\"line\">            <span class=\"attr\">app:radio</span>=<span class=\"string\">\"0.667\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">com.miamusic.android.live.ui.widget.WrapContentViewPager</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_view_pager\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_recharge_layout\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:background</span>=<span class=\"string\">\"#000000\"</span></div><div class=\"line\">        <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"24dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingLeft</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingRight</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"24dp\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_remain_coin\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:drawablePadding</span>=<span class=\"string\">\"2dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:drawableRight</span>=<span class=\"string\">\"@drawable/m_coin_small\"</span></div><div class=\"line\">            <span class=\"attr\">android:minWidth</span>=<span class=\"string\">\"24dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"#C4AF94\"</span></div><div class=\"line\">            <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"15sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_recharge\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingLeft</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"充值 &gt;\"</span></div><div class=\"line\">            <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">            <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"14sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">android.support.v4.widget.Space</span></span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"0dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_weight</span>=<span class=\"string\">\"1\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/choose_gift_count\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@drawable/follow_button_background\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingLeft</span>=<span class=\"string\">\"12dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingRight</span>=<span class=\"string\">\"12dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:visibility</span>=<span class=\"string\">\"visible\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"数量\"</span></div><div class=\"line\">                <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">                <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"14sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/send_gift_count\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"left\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"1\"</span></div><div class=\"line\">                <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">                <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"14sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/btn_up_white\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_send\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@drawable/reward_album\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"送礼物\"</span></div><div class=\"line\">            <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/black\"</span></div><div class=\"line\">            <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"14sp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>对应界面的预览如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow4.png\" alt=\"\"></p>\n<p>这里贴一下Android中的坐标体系：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow3.png\" alt=\"\"><br>根据这个图，再来计算坐标值。</p>\n<p>这里我在图中做了一下标注：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow2.png\" alt=\"\"><br>popupwindow的y坐标应该是<code>1的高度 + 2的高度 - popupwindow的高度</code>。</p>\n<p>1的高度即是gift_recharge_layout对应view.getTop()，2的高度即是choose_gift_count对应view.getTop()。</p>\n<p>popupwindow的高度，我们通过调用一次<code>measure()</code>方法然后通过<code>getMeasuredHeight()</code>获取。</p>\n<p>那么最终popupwindow的y坐标便计算出来了，横坐标的计算比较简单，就不多说了。x、y计算完之后通过<code>showAtLocation</code>进行设置即可。</p>\n<p>下面给下示例的片段代码：<br><figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\">popupParent = (<span class=\"type\">LinearLayout</span>) findViewById(<span class=\"type\">R</span>.id.gift_recharge_layout);</div><div class=\"line\">chooseCount.setOnClickListener(<span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">View</span>.<span class=\"title\">OnClickListener</span>() &#123;</span></div><div class=\"line\">    @<span class=\"title\">Override</span></div><div class=\"line\">    <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">onClick</span>(<span class=\"type\">View</span> v) &#123;</div><div class=\"line\">        <span class=\"title\">final</span> <span class=\"title\">View</span> <span class=\"title\">convertView</span> = <span class=\"title\">LayoutInflater</span>.<span class=\"title\">from</span>(mContext).<span class=\"title\">inflate</span>(<span class=\"type\">R</span>.layout.choose_count_popup_window, null);</div><div class=\"line\">        <span class=\"title\">ListView</span> <span class=\"title\">listView</span> = (<span class=\"type\">ListView</span>) <span class=\"title\">convertView</span>.<span class=\"title\">findViewById</span>(<span class=\"type\">R</span>.id.count_list);</div><div class=\"line\">        <span class=\"title\">listView</span>.<span class=\"title\">setAdapter</span>(new <span class=\"type\">CountAdapter</span>());</div><div class=\"line\">        <span class=\"comment\">// 弹出PopupWindow</span></div><div class=\"line\">        <span class=\"title\">final</span> <span class=\"title\">PopupWindow</span> <span class=\"title\">popupWindow</span> = <span class=\"title\">new</span> <span class=\"title\">PopupWindow</span>(convertView, <span class=\"type\">LinearLayout</span>.<span class=\"type\">LayoutParams</span>.<span class=\"type\">WRAP_CONTENT</span>, <span class=\"type\">LinearLayout</span>.<span class=\"type\">LayoutParams</span>.<span class=\"type\">WRAP_CONTENT</span>, true);</div><div class=\"line\">        <span class=\"title\">popupWindow</span>.<span class=\"title\">setTouchable</span>(true);</div><div class=\"line\">        <span class=\"title\">popupWindow</span>.<span class=\"title\">setBackgroundDrawable</span>(mContext.getResources().<span class=\"title\">getDrawable</span>(</div><div class=\"line\">                android.<span class=\"type\">R</span>.color.transparent));</div><div class=\"line\">        <span class=\"comment\">// 执行measure操作，以便后面获取高宽</span></div><div class=\"line\">        <span class=\"title\">convertView</span>.<span class=\"title\">measure</span>(<span class=\"type\">View</span>.<span class=\"type\">MeasureSpec</span>.<span class=\"type\">UNSPECIFIED</span>, <span class=\"type\">View</span>.<span class=\"type\">MeasureSpec</span>.<span class=\"type\">UNSPECIFIED</span>);</div><div class=\"line\">        <span class=\"title\">int</span> <span class=\"title\">x</span> = <span class=\"title\">v</span>.<span class=\"title\">getLeft</span>();</div><div class=\"line\">        <span class=\"comment\">// 对应2的高度</span></div><div class=\"line\">        <span class=\"title\">int</span> <span class=\"title\">y1</span> = <span class=\"title\">v</span>.<span class=\"title\">getTop</span>();</div><div class=\"line\">        <span class=\"comment\">// 对应1的高度</span></div><div class=\"line\">        <span class=\"title\">int</span> <span class=\"title\">y2</span> = <span class=\"title\">popupParent</span>.<span class=\"title\">getTop</span>();</div><div class=\"line\">        <span class=\"comment\">// 设置PopupWindow显示的位置，</span></div><div class=\"line\">        <span class=\"title\">popupWindow</span>.<span class=\"title\">showAsDropDown</span>(v);</div><div class=\"line\">        <span class=\"title\">popupWindow</span>.<span class=\"title\">showAtLocation</span>(v, <span class=\"type\">Gravity</span>.<span class=\"type\">NO_GRAVITY</span>, x + v.getMeasuredWidth() / 2 - <span class=\"title\">convertView</span>.<span class=\"title\">getMeasuredWidth</span>() / 2, (y1 + y2 - <span class=\"number\">10</span>) - <span class=\"title\">convertView</span>.<span class=\"title\">getMeasuredHeight</span>());</div><div class=\"line\"></div><div class=\"line\">        <span class=\"title\">listView</span>.<span class=\"title\">setOnItemClickListener</span>(new <span class=\"type\">AdapterView</span>.<span class=\"type\">OnItemClickListener</span>() &#123;</div><div class=\"line\">            @<span class=\"title\">Override</span></div><div class=\"line\">            <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">onItemClick</span>(<span class=\"type\">AdapterView</span>&lt;?&gt; parent, <span class=\"type\">View</span> view, int position, long id) &#123;</div><div class=\"line\">                <span class=\"title\">popupWindow</span>.<span class=\"title\">dismiss</span>();</div><div class=\"line\">                <span class=\"title\">sendCount</span>.<span class=\"title\">setText</span>(counts[position]);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n","excerpt":"<p>项目中有这样一个需求：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow1.png\" alt=\"\"></p>\n<p>用户点击送礼物，会弹出一个礼物选择对话框，然后在选择一个礼物之后，可以选择礼物数量，按照图中的意思，选择数量很自然的想到了用<code>PopupWindow</code>来做了。但是这里有一个问题就是：弹出来的数量选择框是需要在数量显示栏的上方的。</p>\n<p>如果是在下方，那很简单，直接<code>popupWindow.showAsDropDown(v);</code>即可。但若是在上方，则需要自己计算坐标了，然后通过<code>showAtLocation()</code>方法来显示。</p>","more":"<p>首先贴一下大致的布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">com.miamusic.android.live.ui.widget.CertainScaleImageView</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:scaleType</span>=<span class=\"string\">\"centerCrop\"</span></div><div class=\"line\">            <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/gift_background\"</span></div><div class=\"line\">            <span class=\"attr\">android:visibility</span>=<span class=\"string\">\"visible\"</span></div><div class=\"line\">            <span class=\"attr\">app:radio</span>=<span class=\"string\">\"0.667\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">com.miamusic.android.live.ui.widget.WrapContentViewPager</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_view_pager\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_recharge_layout\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:background</span>=<span class=\"string\">\"#000000\"</span></div><div class=\"line\">        <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"24dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingLeft</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingRight</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"24dp\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_remain_coin\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:drawablePadding</span>=<span class=\"string\">\"2dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:drawableRight</span>=<span class=\"string\">\"@drawable/m_coin_small\"</span></div><div class=\"line\">            <span class=\"attr\">android:minWidth</span>=<span class=\"string\">\"24dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"#C4AF94\"</span></div><div class=\"line\">            <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"15sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_recharge\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingLeft</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"充值 &gt;\"</span></div><div class=\"line\">            <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">            <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"14sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">android.support.v4.widget.Space</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"0dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_weight</span>=<span class=\"string\">\"1\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/choose_gift_count\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@drawable/follow_button_background\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingLeft</span>=<span class=\"string\">\"12dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingRight</span>=<span class=\"string\">\"12dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:visibility</span>=<span class=\"string\">\"visible\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"数量\"</span></div><div class=\"line\">                <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">                <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"14sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/send_gift_count\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"left\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"1\"</span></div><div class=\"line\">                <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/white\"</span></div><div class=\"line\">                <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"14sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ImageView</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:src</span>=<span class=\"string\">\"@drawable/btn_up_white\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/gift_send\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@drawable/reward_album\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"送礼物\"</span></div><div class=\"line\">            <span class=\"attr\">android:textColor</span>=<span class=\"string\">\"@color/black\"</span></div><div class=\"line\">            <span class=\"attr\">android:textSize</span>=<span class=\"string\">\"14sp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>对应界面的预览如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow4.png\" alt=\"\"></p>\n<p>这里贴一下Android中的坐标体系：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow3.png\" alt=\"\"><br>根据这个图，再来计算坐标值。</p>\n<p>这里我在图中做了一下标注：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/popupwindow2.png\" alt=\"\"><br>popupwindow的y坐标应该是<code>1的高度 + 2的高度 - popupwindow的高度</code>。</p>\n<p>1的高度即是gift_recharge_layout对应view.getTop()，2的高度即是choose_gift_count对应view.getTop()。</p>\n<p>popupwindow的高度，我们通过调用一次<code>measure()</code>方法然后通过<code>getMeasuredHeight()</code>获取。</p>\n<p>那么最终popupwindow的y坐标便计算出来了，横坐标的计算比较简单，就不多说了。x、y计算完之后通过<code>showAtLocation</code>进行设置即可。</p>\n<p>下面给下示例的片段代码：<br><figure class=\"highlight pony\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\">popupParent = (<span class=\"type\">LinearLayout</span>) findViewById(<span class=\"type\">R</span>.id.gift_recharge_layout);</div><div class=\"line\">chooseCount.setOnClickListener(<span class=\"function\"><span class=\"keyword\">new</span> <span class=\"title\">View</span>.<span class=\"title\">OnClickListener</span>() &#123;</div><div class=\"line\">    @<span class=\"title\">Override</span></div><div class=\"line\">    <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">onClick</span>(<span class=\"type\">View</span> v) &#123;</div><div class=\"line\">        <span class=\"title\">final</span> <span class=\"title\">View</span> <span class=\"title\">convertView</span> = <span class=\"title\">LayoutInflater</span>.<span class=\"title\">from</span>(mContext).<span class=\"title\">inflate</span>(<span class=\"type\">R</span>.layout.choose_count_popup_window, null);</div><div class=\"line\">        <span class=\"title\">ListView</span> <span class=\"title\">listView</span> = (<span class=\"type\">ListView</span>) <span class=\"title\">convertView</span>.<span class=\"title\">findViewById</span>(<span class=\"type\">R</span>.id.count_list);</div><div class=\"line\">        <span class=\"title\">listView</span>.<span class=\"title\">setAdapter</span>(new <span class=\"type\">CountAdapter</span>());</div><div class=\"line\">        <span class=\"comment\">// 弹出PopupWindow</span></div><div class=\"line\">        <span class=\"title\">final</span> <span class=\"title\">PopupWindow</span> <span class=\"title\">popupWindow</span> = <span class=\"title\">new</span> <span class=\"title\">PopupWindow</span>(convertView, <span class=\"type\">LinearLayout</span>.<span class=\"type\">LayoutParams</span>.<span class=\"type\">WRAP_CONTENT</span>, <span class=\"type\">LinearLayout</span>.<span class=\"type\">LayoutParams</span>.<span class=\"type\">WRAP_CONTENT</span>, true);</div><div class=\"line\">        <span class=\"title\">popupWindow</span>.<span class=\"title\">setTouchable</span>(true);</div><div class=\"line\">        <span class=\"title\">popupWindow</span>.<span class=\"title\">setBackgroundDrawable</span>(mContext.getResources().<span class=\"title\">getDrawable</span>(</div><div class=\"line\">                android.<span class=\"type\">R</span>.color.transparent));</div><div class=\"line\">        <span class=\"comment\">// 执行measure操作，以便后面获取高宽</span></div><div class=\"line\">        <span class=\"title\">convertView</span>.<span class=\"title\">measure</span>(<span class=\"type\">View</span>.<span class=\"type\">MeasureSpec</span>.<span class=\"type\">UNSPECIFIED</span>, <span class=\"type\">View</span>.<span class=\"type\">MeasureSpec</span>.<span class=\"type\">UNSPECIFIED</span>);</div><div class=\"line\">        <span class=\"title\">int</span> <span class=\"title\">x</span> = <span class=\"title\">v</span>.<span class=\"title\">getLeft</span>();</div><div class=\"line\">        <span class=\"comment\">// 对应2的高度</span></div><div class=\"line\">        <span class=\"title\">int</span> <span class=\"title\">y1</span> = <span class=\"title\">v</span>.<span class=\"title\">getTop</span>();</div><div class=\"line\">        <span class=\"comment\">// 对应1的高度</span></div><div class=\"line\">        <span class=\"title\">int</span> <span class=\"title\">y2</span> = <span class=\"title\">popupParent</span>.<span class=\"title\">getTop</span>();</div><div class=\"line\">        <span class=\"comment\">// 设置PopupWindow显示的位置，</span></div><div class=\"line\">        <span class=\"title\">popupWindow</span>.<span class=\"title\">showAsDropDown</span>(v);</div><div class=\"line\">        <span class=\"title\">popupWindow</span>.<span class=\"title\">showAtLocation</span>(v, <span class=\"type\">Gravity</span>.<span class=\"type\">NO_GRAVITY</span>, x + v.getMeasuredWidth() / 2 - <span class=\"title\">convertView</span>.<span class=\"title\">getMeasuredWidth</span>() / 2, (y1 + y2 - <span class=\"number\">10</span>) - <span class=\"title\">convertView</span>.<span class=\"title\">getMeasuredHeight</span>());</div><div class=\"line\"></div><div class=\"line\">        <span class=\"title\">listView</span>.<span class=\"title\">setOnItemClickListener</span>(new <span class=\"type\">AdapterView</span>.<span class=\"type\">OnItemClickListener</span>() &#123;</div><div class=\"line\">            @<span class=\"title\">Override</span></div><div class=\"line\">            <span class=\"title\">public</span> <span class=\"title\">void</span> <span class=\"title\">onItemClick</span>(<span class=\"type\">AdapterView</span>&lt;?&gt; parent, <span class=\"type\">View</span> view, int position, long id) &#123;</div><div class=\"line\">                <span class=\"title\">popupWindow</span>.<span class=\"title\">dismiss</span>();</div><div class=\"line\">                <span class=\"title\">sendCount</span>.<span class=\"title\">setText</span>(counts[position]);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</span></div></pre></td></tr></table></figure></p>"},{"title":"React Native For Android初探","date":"2016-01-15T09:20:02.000Z","_content":"\n## 介绍\nFacebook 在 [React.js Conf 2015](http://conf.reactjs.com/) 大会上推出了基于 JavaScript 的开源框架 [React Native](https://facebook.github.io/react-native/)。React Native 结合了 Web 应用和 Native 应用的优势，可以使用 JavaScript 来开发 iOS 和 Android 原生应用。在 JavaScript 中用 React 抽象操作系统原生的 UI 组件，代替 DOM 元素来渲染等。\n\n>React Native enables you to build world-class application experiences on native platforms using a consistent developer experience based on JavaScript and React. The focus of React Native is on developer efficiency across all the platforms you care about — learn once, write anywhere. Facebook uses React Native in multiple production apps and will continue investing in React Native.\n\nReact Native 使你能够使用基于 JavaScript 和 React 一致的开发体验在本地平台上构建世界一流的应用程序体验。React Native 把重点放在所有开发人员关心的平台的开发效率上——开发者只需学习一种语言就能轻易为任何平台高效地编写代码。Facebook 在多个应用程序产品中使用了 React Native，并将继续为 React Native 投资。\n\n对于不太了解React Native是什么以及Facebook为什么要创建React Native，可以先看看[这篇博客](https://code.facebook.com/posts/1014532261909640/react-native-bringing-modern-web-techniques-to-mobile/)。\n\nFacebook 于 2015 年 9 月 15 日发布了 React Native for Android， 把 Web 和原生平台的 JavaScript 开发技术扩展到了 Google 的流行移动平台--Android。\n\n最近项目技术负责人说可能以后我们也会使用这套框架进行App开发，所以便预先学习一下，顺便做下笔记，分享给大家。\n\n<!--more-->\n\n## 实践\n### 安装Node.js\nreact native依赖Node.js，第一步便是下载Node.js。去官网下载，对应电脑系统版本。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native1.png)\n我是Win 10，下载的64位。下载完成后，直接安装。\n\n可以随意创建一个一个test.js，来测试Node.js是否安装成功。\n```\nvar http = require(\"http\");\n\nhttp.createServer(function(req, res) {\n  res.writeHead( 200 , {\"Content-Type\":\"text/html\"});\n  res.write(\"<h1>Node.js</h1>\");\n  res.write(\"<p>Hello World</p>\");\n  res.end(\"\");\n}).listen(8080);\nconsole.log(\"HTTP server is listening at port 8080.\");\n```\n然后进入到响应的目录，执行cmd，键入命令：``node test.js``，然后浏览器打开\"localhost:8080\"，显示如下则是安装成功。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native2.png)\n\n### 安装native环境\n使用npm指令安装``react-native-cli``。打开命令行，执行指令：\n```\nnpm install -g react-native-cli\n```\n``react-native-cli``是用来开发React Native的命令行工具。你需要使用npm来安装它。上面这行代码将会帮助你在terminal中安装react-native命令。这行cmd命令只需要执行一次，后面便可持续使用。\n\n下面便可以开始创建我们的React Native项目了。\n\n### 创建项目\n创建好自己的文件夹之后，cmd命令进入文件夹，执行命令：\n```\nreact-native init HelloWorld\n```\nHelloWorld便是项目名，可自己随意取。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native3.png)\n执行完毕之后便会生成HelloWorld文件夹。目录结构是这样的：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native4.png)\n可以看到生成的项目既包含IOS，也包含Android。因为我是Android开发，所以就暂时不管IOS了。\n\n### 运行项目\n在命令行执行完毕之后，我们会看到To run your app on Android的提示。进入到HelloWorld文件夹，执行命令：\n```\nreact-native run-android\n```\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native5.png)\n图上所示便是在进行编译，准备安装了。\n编译成功后，安装运行，界面如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native6.png)\n提示不能下载JS bundle。这里我们注意一下编译时的黄色提示：``Starting the packager in a new window is not supported on Windows yet.Please start it manually using 'react-native start'.``就是说不支持在Windows上自动开启packager，需要我们自己先启动。\n\n照着提示来，执行命令：\n```\nreact-native start\n```\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native7.png)\n可以看到React packager ready.\n\nOK，再来运行我们的程序。\n此时界面变显示正常了：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native8.png)\n同时React packager会打印一些信息：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native9.png)\n很多东西都还不懂，暂时就先不管了，后面再慢慢了解，至少现在看起来没出什么错。\n\n## js代码初探\n下面便来研究一下显示到界面上的内容到底是怎么来的。\n\n看到HelloWolrd文件夹下有index.android.js文件，编辑器打开，看到的代码是这样的：\n```\n/**\n * Sample React Native App\n * https://github.com/facebook/react-native\n */\n'use strict';\nimport React, {\n  AppRegistry,\n  Component,\n  StyleSheet,\n  Text,\n  View\n} from 'react-native';\n\nclass HelloWorld extends Component {\n  render() {\n    return (\n      <View style={styles.container}>\n        <Text style={styles.welcome}>\n          Welcome to React Native!\n        </Text>\n        <Text style={styles.instructions}>\n          To get started, edit index.android.js\n        </Text>\n        <Text style={styles.instructions}>\n          Shake or press menu button for dev menu\n        </Text>\n      </View>\n    );\n  }\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#F5FCFF',\n  },\n  welcome: {\n    fontSize: 20,\n    textAlign: 'center',\n    margin: 10,\n  },\n  instructions: {\n    textAlign: 'center',\n    color: '#333333',\n    marginBottom: 5,\n  },\n});\n\nAppRegistry.registerComponent('HelloWorld', () => HelloWorld);\n```\n此时，对着代码与界面，我们便可以大胆的猜测界面上显示的文字就是HelloWorld class中对应的3个Text标签了。下面尝试一下：\n\nHelloWorld class代码改成如下：\n```\nclass HelloWorld extends Component {\n  render() {\n    return (\n      <View style={styles.container}>\n        <Text style={styles.welcome}>\n          Hello World!\n        </Text>\n      </View>\n    );\n  }\n}\n```\n我们把之前3个Text标签去掉，写一个显示Hello World的Text标签。那么改好之后如何看到效果呢？？？请注意，这便是React Native框架非常厉害的地方，你不需要重新编译安装apk，更新包等操作，直接虚拟机点出Menu，点击Roload JS即可实现更新：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native10.png)\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native11.png)\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native12.png)\n可以看到，界面确实是变成了我们预想的样子。\n\n下面我从官网复制了一份index.android.js代码：\n```\n/**\n * Sample React Native App\n * https://github.com/facebook/react-native\n */\n'use strict';\n\nvar React = require('react-native');\nvar {\n  AppRegistry,\n  Image,\n  ListView,\n  StyleSheet,\n  Text,\n  View,\n} = React;\n\nvar API_KEY = '7waqfqbprs7pajbz28mqf6vz';\nvar API_URL = 'http://api.rottentomatoes.com/api/public/v1.0/lists/movies/in_theaters.json';\nvar PAGE_SIZE = 25;\nvar PARAMS = '?apikey=' + API_KEY + '&page_limit=' + PAGE_SIZE;\nvar REQUEST_URL = API_URL + PARAMS;\n\nvar AwesomeProject = React.createClass({\n  getInitialState: function() {\n    return {\n      dataSource: new ListView.DataSource({\n        rowHasChanged: (row1, row2) => row1 !== row2,\n      }),\n      loaded: false,\n    };\n  },\n\n  componentDidMount: function() {\n    this.fetchData();\n  },\n\n  fetchData: function() {\n    fetch(REQUEST_URL)\n      .then((response) => response.json())\n      .then((responseData) => {\n        this.setState({\n          dataSource: this.state.dataSource.cloneWithRows(responseData.movies),\n          loaded: true,\n        });\n      })\n      .done();\n  },\n\n  render: function() {\n    if (!this.state.loaded) {\n      return this.renderLoadingView();\n    }\n\n    return (\n      <ListView\n        dataSource={this.state.dataSource}\n        renderRow={this.renderMovie}\n        style={styles.listView}\n      />\n    );\n  },\n\n  renderLoadingView: function() {\n    return (\n      <View style={styles.container}>\n        <Text>\n          Loading movies...\n        </Text>\n      </View>\n    );\n  },\n\n  renderMovie: function(movie) {\n    return (\n      <View style={styles.container}>\n        <Image\n          source={{uri: movie.posters.thumbnail}}\n          style={styles.thumbnail}\n        />\n        <View style={styles.rightContainer}>\n          <Text style={styles.title}>{movie.title}</Text>\n          <Text style={styles.year}>{movie.year}</Text>\n        </View>\n      </View>\n    );\n  },\n});\n\nvar styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    flexDirection: 'row',\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#F5FCFF',\n  },\n  rightContainer: {\n    flex: 1,\n  },\n  title: {\n    fontSize: 20,\n    marginBottom: 8,\n    textAlign: 'center',\n  },\n  year: {\n    textAlign: 'center',\n  },\n  thumbnail: {\n    width: 53,\n    height: 81,\n  },\n  listView: {\n    paddingTop: 20,\n    backgroundColor: '#F5FCFF',\n  },\n});\n\nAppRegistry.registerComponent('AwesomeProject', () => AwesomeProject);\n```\n然后Reload JS，界面如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native13.png)\n呀，出错了。我们看到是在registerComponent的时候出错了。想起来我们的项目名称是HelloWorld，将最后一句代码改掉。\n```\nAppRegistry.registerComponent('HelloWorld', () => AwesomeProject);\n```\nReload JS。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native14.png)\n加载完毕后的显示界面：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native15.png)\n但是将代码改成：\n```\nAppRegistry.registerComponent('HelloWorld', () => HelloWorld);\n```\n执行又出错了：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native16.png)\n看来东西不能乱改呀，至于是什么原因，就放在以后慢慢去发现去解决了。另外这种JS代码的写法也是需要在实践中慢慢积累，学习，才能逐步掌握。\n\n今天就到这里了，代码都是自动生成的，便不上传了。Have a nice weekend~\n","source":"_posts/react-native.md","raw":"---\ntitle: React Native For Android初探\ndate: 2016-01-15 17:20:02\ntags:\n - hybrid开发\n---\n\n## 介绍\nFacebook 在 [React.js Conf 2015](http://conf.reactjs.com/) 大会上推出了基于 JavaScript 的开源框架 [React Native](https://facebook.github.io/react-native/)。React Native 结合了 Web 应用和 Native 应用的优势，可以使用 JavaScript 来开发 iOS 和 Android 原生应用。在 JavaScript 中用 React 抽象操作系统原生的 UI 组件，代替 DOM 元素来渲染等。\n\n>React Native enables you to build world-class application experiences on native platforms using a consistent developer experience based on JavaScript and React. The focus of React Native is on developer efficiency across all the platforms you care about — learn once, write anywhere. Facebook uses React Native in multiple production apps and will continue investing in React Native.\n\nReact Native 使你能够使用基于 JavaScript 和 React 一致的开发体验在本地平台上构建世界一流的应用程序体验。React Native 把重点放在所有开发人员关心的平台的开发效率上——开发者只需学习一种语言就能轻易为任何平台高效地编写代码。Facebook 在多个应用程序产品中使用了 React Native，并将继续为 React Native 投资。\n\n对于不太了解React Native是什么以及Facebook为什么要创建React Native，可以先看看[这篇博客](https://code.facebook.com/posts/1014532261909640/react-native-bringing-modern-web-techniques-to-mobile/)。\n\nFacebook 于 2015 年 9 月 15 日发布了 React Native for Android， 把 Web 和原生平台的 JavaScript 开发技术扩展到了 Google 的流行移动平台--Android。\n\n最近项目技术负责人说可能以后我们也会使用这套框架进行App开发，所以便预先学习一下，顺便做下笔记，分享给大家。\n\n<!--more-->\n\n## 实践\n### 安装Node.js\nreact native依赖Node.js，第一步便是下载Node.js。去官网下载，对应电脑系统版本。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native1.png)\n我是Win 10，下载的64位。下载完成后，直接安装。\n\n可以随意创建一个一个test.js，来测试Node.js是否安装成功。\n```\nvar http = require(\"http\");\n\nhttp.createServer(function(req, res) {\n  res.writeHead( 200 , {\"Content-Type\":\"text/html\"});\n  res.write(\"<h1>Node.js</h1>\");\n  res.write(\"<p>Hello World</p>\");\n  res.end(\"\");\n}).listen(8080);\nconsole.log(\"HTTP server is listening at port 8080.\");\n```\n然后进入到响应的目录，执行cmd，键入命令：``node test.js``，然后浏览器打开\"localhost:8080\"，显示如下则是安装成功。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native2.png)\n\n### 安装native环境\n使用npm指令安装``react-native-cli``。打开命令行，执行指令：\n```\nnpm install -g react-native-cli\n```\n``react-native-cli``是用来开发React Native的命令行工具。你需要使用npm来安装它。上面这行代码将会帮助你在terminal中安装react-native命令。这行cmd命令只需要执行一次，后面便可持续使用。\n\n下面便可以开始创建我们的React Native项目了。\n\n### 创建项目\n创建好自己的文件夹之后，cmd命令进入文件夹，执行命令：\n```\nreact-native init HelloWorld\n```\nHelloWorld便是项目名，可自己随意取。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native3.png)\n执行完毕之后便会生成HelloWorld文件夹。目录结构是这样的：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native4.png)\n可以看到生成的项目既包含IOS，也包含Android。因为我是Android开发，所以就暂时不管IOS了。\n\n### 运行项目\n在命令行执行完毕之后，我们会看到To run your app on Android的提示。进入到HelloWorld文件夹，执行命令：\n```\nreact-native run-android\n```\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native5.png)\n图上所示便是在进行编译，准备安装了。\n编译成功后，安装运行，界面如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native6.png)\n提示不能下载JS bundle。这里我们注意一下编译时的黄色提示：``Starting the packager in a new window is not supported on Windows yet.Please start it manually using 'react-native start'.``就是说不支持在Windows上自动开启packager，需要我们自己先启动。\n\n照着提示来，执行命令：\n```\nreact-native start\n```\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native7.png)\n可以看到React packager ready.\n\nOK，再来运行我们的程序。\n此时界面变显示正常了：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native8.png)\n同时React packager会打印一些信息：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native9.png)\n很多东西都还不懂，暂时就先不管了，后面再慢慢了解，至少现在看起来没出什么错。\n\n## js代码初探\n下面便来研究一下显示到界面上的内容到底是怎么来的。\n\n看到HelloWolrd文件夹下有index.android.js文件，编辑器打开，看到的代码是这样的：\n```\n/**\n * Sample React Native App\n * https://github.com/facebook/react-native\n */\n'use strict';\nimport React, {\n  AppRegistry,\n  Component,\n  StyleSheet,\n  Text,\n  View\n} from 'react-native';\n\nclass HelloWorld extends Component {\n  render() {\n    return (\n      <View style={styles.container}>\n        <Text style={styles.welcome}>\n          Welcome to React Native!\n        </Text>\n        <Text style={styles.instructions}>\n          To get started, edit index.android.js\n        </Text>\n        <Text style={styles.instructions}>\n          Shake or press menu button for dev menu\n        </Text>\n      </View>\n    );\n  }\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#F5FCFF',\n  },\n  welcome: {\n    fontSize: 20,\n    textAlign: 'center',\n    margin: 10,\n  },\n  instructions: {\n    textAlign: 'center',\n    color: '#333333',\n    marginBottom: 5,\n  },\n});\n\nAppRegistry.registerComponent('HelloWorld', () => HelloWorld);\n```\n此时，对着代码与界面，我们便可以大胆的猜测界面上显示的文字就是HelloWorld class中对应的3个Text标签了。下面尝试一下：\n\nHelloWorld class代码改成如下：\n```\nclass HelloWorld extends Component {\n  render() {\n    return (\n      <View style={styles.container}>\n        <Text style={styles.welcome}>\n          Hello World!\n        </Text>\n      </View>\n    );\n  }\n}\n```\n我们把之前3个Text标签去掉，写一个显示Hello World的Text标签。那么改好之后如何看到效果呢？？？请注意，这便是React Native框架非常厉害的地方，你不需要重新编译安装apk，更新包等操作，直接虚拟机点出Menu，点击Roload JS即可实现更新：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native10.png)\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native11.png)\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native12.png)\n可以看到，界面确实是变成了我们预想的样子。\n\n下面我从官网复制了一份index.android.js代码：\n```\n/**\n * Sample React Native App\n * https://github.com/facebook/react-native\n */\n'use strict';\n\nvar React = require('react-native');\nvar {\n  AppRegistry,\n  Image,\n  ListView,\n  StyleSheet,\n  Text,\n  View,\n} = React;\n\nvar API_KEY = '7waqfqbprs7pajbz28mqf6vz';\nvar API_URL = 'http://api.rottentomatoes.com/api/public/v1.0/lists/movies/in_theaters.json';\nvar PAGE_SIZE = 25;\nvar PARAMS = '?apikey=' + API_KEY + '&page_limit=' + PAGE_SIZE;\nvar REQUEST_URL = API_URL + PARAMS;\n\nvar AwesomeProject = React.createClass({\n  getInitialState: function() {\n    return {\n      dataSource: new ListView.DataSource({\n        rowHasChanged: (row1, row2) => row1 !== row2,\n      }),\n      loaded: false,\n    };\n  },\n\n  componentDidMount: function() {\n    this.fetchData();\n  },\n\n  fetchData: function() {\n    fetch(REQUEST_URL)\n      .then((response) => response.json())\n      .then((responseData) => {\n        this.setState({\n          dataSource: this.state.dataSource.cloneWithRows(responseData.movies),\n          loaded: true,\n        });\n      })\n      .done();\n  },\n\n  render: function() {\n    if (!this.state.loaded) {\n      return this.renderLoadingView();\n    }\n\n    return (\n      <ListView\n        dataSource={this.state.dataSource}\n        renderRow={this.renderMovie}\n        style={styles.listView}\n      />\n    );\n  },\n\n  renderLoadingView: function() {\n    return (\n      <View style={styles.container}>\n        <Text>\n          Loading movies...\n        </Text>\n      </View>\n    );\n  },\n\n  renderMovie: function(movie) {\n    return (\n      <View style={styles.container}>\n        <Image\n          source={{uri: movie.posters.thumbnail}}\n          style={styles.thumbnail}\n        />\n        <View style={styles.rightContainer}>\n          <Text style={styles.title}>{movie.title}</Text>\n          <Text style={styles.year}>{movie.year}</Text>\n        </View>\n      </View>\n    );\n  },\n});\n\nvar styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    flexDirection: 'row',\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#F5FCFF',\n  },\n  rightContainer: {\n    flex: 1,\n  },\n  title: {\n    fontSize: 20,\n    marginBottom: 8,\n    textAlign: 'center',\n  },\n  year: {\n    textAlign: 'center',\n  },\n  thumbnail: {\n    width: 53,\n    height: 81,\n  },\n  listView: {\n    paddingTop: 20,\n    backgroundColor: '#F5FCFF',\n  },\n});\n\nAppRegistry.registerComponent('AwesomeProject', () => AwesomeProject);\n```\n然后Reload JS，界面如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native13.png)\n呀，出错了。我们看到是在registerComponent的时候出错了。想起来我们的项目名称是HelloWorld，将最后一句代码改掉。\n```\nAppRegistry.registerComponent('HelloWorld', () => AwesomeProject);\n```\nReload JS。\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native14.png)\n加载完毕后的显示界面：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native15.png)\n但是将代码改成：\n```\nAppRegistry.registerComponent('HelloWorld', () => HelloWorld);\n```\n执行又出错了：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native16.png)\n看来东西不能乱改呀，至于是什么原因，就放在以后慢慢去发现去解决了。另外这种JS代码的写法也是需要在实践中慢慢积累，学习，才能逐步掌握。\n\n今天就到这里了，代码都是自动生成的，便不上传了。Have a nice weekend~\n","slug":"react-native","published":1,"updated":"2016-11-21T10:02:41.588Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75a0002i1cb88ikjvpjx","content":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>Facebook 在 <a href=\"http://conf.reactjs.com/\" target=\"_blank\" rel=\"external\">React.js Conf 2015</a> 大会上推出了基于 JavaScript 的开源框架 <a href=\"https://facebook.github.io/react-native/\" target=\"_blank\" rel=\"external\">React Native</a>。React Native 结合了 Web 应用和 Native 应用的优势，可以使用 JavaScript 来开发 iOS 和 Android 原生应用。在 JavaScript 中用 React 抽象操作系统原生的 UI 组件，代替 DOM 元素来渲染等。</p>\n<blockquote>\n<p>React Native enables you to build world-class application experiences on native platforms using a consistent developer experience based on JavaScript and React. The focus of React Native is on developer efficiency across all the platforms you care about — learn once, write anywhere. Facebook uses React Native in multiple production apps and will continue investing in React Native.</p>\n</blockquote>\n<p>React Native 使你能够使用基于 JavaScript 和 React 一致的开发体验在本地平台上构建世界一流的应用程序体验。React Native 把重点放在所有开发人员关心的平台的开发效率上——开发者只需学习一种语言就能轻易为任何平台高效地编写代码。Facebook 在多个应用程序产品中使用了 React Native，并将继续为 React Native 投资。</p>\n<p>对于不太了解React Native是什么以及Facebook为什么要创建React Native，可以先看看<a href=\"https://code.facebook.com/posts/1014532261909640/react-native-bringing-modern-web-techniques-to-mobile/\" target=\"_blank\" rel=\"external\">这篇博客</a>。</p>\n<p>Facebook 于 2015 年 9 月 15 日发布了 React Native for Android， 把 Web 和原生平台的 JavaScript 开发技术扩展到了 Google 的流行移动平台–Android。</p>\n<p>最近项目技术负责人说可能以后我们也会使用这套框架进行App开发，所以便预先学习一下，顺便做下笔记，分享给大家。</p>\n<a id=\"more\"></a>\n<h2 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h2><h3 id=\"安装Node-js\"><a href=\"#安装Node-js\" class=\"headerlink\" title=\"安装Node.js\"></a>安装Node.js</h3><p>react native依赖Node.js，第一步便是下载Node.js。去官网下载，对应电脑系统版本。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native1.png\" alt=\"这里写图片描述\"><br>我是Win 10，下载的64位。下载完成后，直接安装。</p>\n<p>可以随意创建一个一个test.js，来测试Node.js是否安装成功。<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">var http = require(<span class=\"string\">\"http\"</span>)<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">http.createServer(function(req, res) &#123;</div><div class=\"line\">  res.writeHead( <span class=\"number\">200</span> , &#123;<span class=\"string\">\"Content-Type\"</span>:<span class=\"string\">\"text/html\"</span>&#125;)<span class=\"comment\">;</span></div><div class=\"line\">  res.write(<span class=\"string\">\"&lt;h1&gt;Node.js&lt;/h1&gt;\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">  res.write(<span class=\"string\">\"&lt;p&gt;Hello World&lt;/p&gt;\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">  res<span class=\"meta\">.end</span>(<span class=\"string\">\"\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">&#125;).listen(<span class=\"number\">8080</span>)<span class=\"comment\">;</span></div><div class=\"line\">console.log(<span class=\"string\">\"HTTP server is listening at port 8080.\"</span>)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>然后进入到响应的目录，执行cmd，键入命令：<code>node test.js</code>，然后浏览器打开”localhost:8080”，显示如下则是安装成功。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native2.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"安装native环境\"><a href=\"#安装native环境\" class=\"headerlink\" title=\"安装native环境\"></a>安装native环境</h3><p>使用npm指令安装<code>react-native-cli</code>。打开命令行，执行指令：<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">npm</span> install -g react-<span class=\"keyword\">native</span>-cli</div></pre></td></tr></table></figure></p>\n<p><code>react-native-cli</code>是用来开发React Native的命令行工具。你需要使用npm来安装它。上面这行代码将会帮助你在terminal中安装react-native命令。这行cmd命令只需要执行一次，后面便可持续使用。</p>\n<p>下面便可以开始创建我们的React Native项目了。</p>\n<h3 id=\"创建项目\"><a href=\"#创建项目\" class=\"headerlink\" title=\"创建项目\"></a>创建项目</h3><p>创建好自己的文件夹之后，cmd命令进入文件夹，执行命令：<br><figure class=\"highlight actionscript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">react-<span class=\"keyword\">native</span> init HelloWorld</div></pre></td></tr></table></figure></p>\n<p>HelloWorld便是项目名，可自己随意取。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native3.png\" alt=\"这里写图片描述\"><br>执行完毕之后便会生成HelloWorld文件夹。目录结构是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native4.png\" alt=\"这里写图片描述\"><br>可以看到生成的项目既包含IOS，也包含Android。因为我是Android开发，所以就暂时不管IOS了。</p>\n<h3 id=\"运行项目\"><a href=\"#运行项目\" class=\"headerlink\" title=\"运行项目\"></a>运行项目</h3><p>在命令行执行完毕之后，我们会看到To run your app on Android的提示。进入到HelloWorld文件夹，执行命令：<br><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">react-native <span class=\"keyword\">run</span><span class=\"bash\">-android</span></div></pre></td></tr></table></figure></p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native5.png\" alt=\"这里写图片描述\"><br>图上所示便是在进行编译，准备安装了。<br>编译成功后，安装运行，界面如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native6.png\" alt=\"这里写图片描述\"><br>提示不能下载JS bundle。这里我们注意一下编译时的黄色提示：<code>Starting the packager in a new window is not supported on Windows yet.Please start it manually using &#39;react-native start&#39;.</code>就是说不支持在Windows上自动开启packager，需要我们自己先启动。</p>\n<p>照着提示来，执行命令：<br><figure class=\"highlight actionscript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">react-<span class=\"keyword\">native</span> start</div></pre></td></tr></table></figure></p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native7.png\" alt=\"这里写图片描述\"><br>可以看到React packager ready.</p>\n<p>OK，再来运行我们的程序。<br>此时界面变显示正常了：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native8.png\" alt=\"这里写图片描述\"><br>同时React packager会打印一些信息：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native9.png\" alt=\"这里写图片描述\"><br>很多东西都还不懂，暂时就先不管了，后面再慢慢了解，至少现在看起来没出什么错。</p>\n<h2 id=\"js代码初探\"><a href=\"#js代码初探\" class=\"headerlink\" title=\"js代码初探\"></a>js代码初探</h2><p>下面便来研究一下显示到界面上的内容到底是怎么来的。</p>\n<p>看到HelloWolrd文件夹下有index.android.js文件，编辑器打开，看到的代码是这样的：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * Sample React Native App</div><div class=\"line\"> * https://github.com/facebook/react-native</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"meta\">'use strict'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> React, &#123;</div><div class=\"line\">  AppRegistry,</div><div class=\"line\">  Component,</div><div class=\"line\">  StyleSheet,</div><div class=\"line\">  Text,</div><div class=\"line\">  View</div><div class=\"line\">&#125; <span class=\"keyword\">from</span> <span class=\"string\">'react-native'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HelloWorld</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</div><div class=\"line\">  render() &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">View</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.container&#125;</span>&gt;</span></span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.welcome&#125;</span>&gt;</span></div><div class=\"line\">          Welcome to React Native!</div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.instructions&#125;</span>&gt;</span></div><div class=\"line\">          To get started, edit index.android.js</div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.instructions&#125;</span>&gt;</span></div><div class=\"line\">          Shake or press menu button for dev menu</div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></div><div class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">View</span>&gt;</span></div><div class=\"line\">    );</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">const</span> styles = StyleSheet.create(&#123;</div><div class=\"line\">  <span class=\"attr\">container</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">flex</span>: <span class=\"number\">1</span>,</div><div class=\"line\">    <span class=\"attr\">justifyContent</span>: <span class=\"string\">'center'</span>,</div><div class=\"line\">    <span class=\"attr\">alignItems</span>: <span class=\"string\">'center'</span>,</div><div class=\"line\">    <span class=\"attr\">backgroundColor</span>: <span class=\"string\">'#F5FCFF'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">welcome</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">fontSize</span>: <span class=\"number\">20</span>,</div><div class=\"line\">    <span class=\"attr\">textAlign</span>: <span class=\"string\">'center'</span>,</div><div class=\"line\">    <span class=\"attr\">margin</span>: <span class=\"number\">10</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">instructions</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">textAlign</span>: <span class=\"string\">'center'</span>,</div><div class=\"line\">    <span class=\"attr\">color</span>: <span class=\"string\">'#333333'</span>,</div><div class=\"line\">    <span class=\"attr\">marginBottom</span>: <span class=\"number\">5</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">AppRegistry.registerComponent(<span class=\"string\">'HelloWorld'</span>, () =&gt; HelloWorld);</div></pre></td></tr></table></figure></p>\n<p>此时，对着代码与界面，我们便可以大胆的猜测界面上显示的文字就是HelloWorld class中对应的3个Text标签了。下面尝试一下：</p>\n<p>HelloWorld class代码改成如下：<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HelloWorld</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</div><div class=\"line\">  render() &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      &lt;<span class=\"type\">View</span> style=&#123;styles.container&#125;&gt;</div><div class=\"line\">        &lt;<span class=\"type\">Text</span> style=&#123;styles.welcome&#125;&gt;</div><div class=\"line\">          <span class=\"type\">Hello</span> <span class=\"type\">World</span>!</div><div class=\"line\">        &lt;/<span class=\"type\">Text</span>&gt;</div><div class=\"line\">      &lt;/<span class=\"type\">View</span>&gt;</div><div class=\"line\">    );</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>我们把之前3个Text标签去掉，写一个显示Hello World的Text标签。那么改好之后如何看到效果呢？？？请注意，这便是React Native框架非常厉害的地方，你不需要重新编译安装apk，更新包等操作，直接虚拟机点出Menu，点击Roload JS即可实现更新：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native10.png\" alt=\"这里写图片描述\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native11.png\" alt=\"这里写图片描述\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native12.png\" alt=\"这里写图片描述\"><br>可以看到，界面确实是变成了我们预想的样子。</p>\n<p>下面我从官网复制了一份index.android.js代码：<br><figure class=\"highlight actionscript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * Sample React Native App</div><div class=\"line\"> * https://github.com/facebook/react-native</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"string\">'use strict'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> React = require(<span class=\"string\">'react-native'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> &#123;</div><div class=\"line\">  AppRegistry,</div><div class=\"line\">  Image,</div><div class=\"line\">  ListView,</div><div class=\"line\">  StyleSheet,</div><div class=\"line\">  Text,</div><div class=\"line\">  View,</div><div class=\"line\">&#125; = React;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> API_KEY = <span class=\"string\">'7waqfqbprs7pajbz28mqf6vz'</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> API_URL = <span class=\"string\">'http://api.rottentomatoes.com/api/public/v1.0/lists/movies/in_theaters.json'</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> PAGE_SIZE = <span class=\"number\">25</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> PARAMS = <span class=\"string\">'?apikey='</span> + API_KEY + <span class=\"string\">'&amp;page_limit='</span> + PAGE_SIZE;</div><div class=\"line\"><span class=\"keyword\">var</span> REQUEST_URL = API_URL + PARAMS;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> AwesomeProject = React.createClass(&#123;</div><div class=\"line\">  getInitialState: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> &#123;</div><div class=\"line\">      dataSource: <span class=\"keyword\">new</span> ListView.DataSource(&#123;</div><div class=\"line\">        rowHasChanged: (row1, row2) =&gt; row1 !== row2,</div><div class=\"line\">      &#125;),</div><div class=\"line\">      loaded: <span class=\"literal\">false</span>,</div><div class=\"line\">    &#125;;</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  componentDidMount: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">this</span>.fetchData();</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  fetchData: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    fetch(REQUEST_URL)</div><div class=\"line\">      .then((response) =&gt; response.json())</div><div class=\"line\">      .then((responseData) =&gt; &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.setState(&#123;</div><div class=\"line\">          dataSource: <span class=\"keyword\">this</span>.state.dataSource.cloneWithRows(responseData.movies),</div><div class=\"line\">          loaded: <span class=\"literal\">true</span>,</div><div class=\"line\">        &#125;);</div><div class=\"line\">      &#125;)</div><div class=\"line\">      .done();</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  render: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.state.loaded) &#123;</div><div class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.renderLoadingView();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      &lt;ListView</div><div class=\"line\">        dataSource=&#123;<span class=\"keyword\">this</span>.state.dataSource&#125;</div><div class=\"line\">        renderRow=&#123;<span class=\"keyword\">this</span>.renderMovie&#125;</div><div class=\"line\">        style=&#123;styles.listView&#125;</div><div class=\"line\">      /&gt;</div><div class=\"line\">    );</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  renderLoadingView: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      &lt;View style=&#123;styles.container&#125;&gt;</div><div class=\"line\">        &lt;Text&gt;</div><div class=\"line\">          Loading movies...</div><div class=\"line\">        &lt;/Text&gt;</div><div class=\"line\">      &lt;/View&gt;</div><div class=\"line\">    );</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  renderMovie: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">(movie)</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      &lt;View style=&#123;styles.container&#125;&gt;</div><div class=\"line\">        &lt;Image</div><div class=\"line\">          source=&#123;&#123;uri: movie.posters.thumbnail&#125;&#125;</div><div class=\"line\">          style=&#123;styles.thumbnail&#125;</div><div class=\"line\">        /&gt;</div><div class=\"line\">        &lt;View style=&#123;styles.rightContainer&#125;&gt;</div><div class=\"line\">          &lt;Text style=&#123;styles.title&#125;&gt;&#123;movie.title&#125;&lt;/Text&gt;</div><div class=\"line\">          &lt;Text style=&#123;styles.year&#125;&gt;&#123;movie.year&#125;&lt;/Text&gt;</div><div class=\"line\">        &lt;/View&gt;</div><div class=\"line\">      &lt;/View&gt;</div><div class=\"line\">    );</div><div class=\"line\">  &#125;,</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> styles = StyleSheet.create(&#123;</div><div class=\"line\">  container: &#123;</div><div class=\"line\">    flex: <span class=\"number\">1</span>,</div><div class=\"line\">    flexDirection: <span class=\"string\">'row'</span>,</div><div class=\"line\">    justifyContent: <span class=\"string\">'center'</span>,</div><div class=\"line\">    alignItems: <span class=\"string\">'center'</span>,</div><div class=\"line\">    backgroundColor: <span class=\"string\">'#F5FCFF'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  rightContainer: &#123;</div><div class=\"line\">    flex: <span class=\"number\">1</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  title: &#123;</div><div class=\"line\">    fontSize: <span class=\"number\">20</span>,</div><div class=\"line\">    marginBottom: <span class=\"number\">8</span>,</div><div class=\"line\">    textAlign: <span class=\"string\">'center'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  year: &#123;</div><div class=\"line\">    textAlign: <span class=\"string\">'center'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  thumbnail: &#123;</div><div class=\"line\">    width: <span class=\"number\">53</span>,</div><div class=\"line\">    height: <span class=\"number\">81</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  listView: &#123;</div><div class=\"line\">    paddingTop: <span class=\"number\">20</span>,</div><div class=\"line\">    backgroundColor: <span class=\"string\">'#F5FCFF'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">AppRegistry.registerComponent(<span class=\"string\">'AwesomeProject'</span>, () =&gt; AwesomeProject);</div></pre></td></tr></table></figure></p>\n<p>然后Reload JS，界面如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native13.png\" alt=\"这里写图片描述\"><br>呀，出错了。我们看到是在registerComponent的时候出错了。想起来我们的项目名称是HelloWorld，将最后一句代码改掉。<br><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">AppRegistry.registerComponent(<span class=\"string\">'HelloWorld'</span>, <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> AwesomeProject);</div></pre></td></tr></table></figure></p>\n<p>Reload JS。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native14.png\" alt=\"这里写图片描述\"><br>加载完毕后的显示界面：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native15.png\" alt=\"这里写图片描述\"><br>但是将代码改成：<br><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">AppRegistry.registerComponent(<span class=\"string\">'HelloWorld'</span>, <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> HelloWorld);</div></pre></td></tr></table></figure></p>\n<p>执行又出错了：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native16.png\" alt=\"这里写图片描述\"><br>看来东西不能乱改呀，至于是什么原因，就放在以后慢慢去发现去解决了。另外这种JS代码的写法也是需要在实践中慢慢积累，学习，才能逐步掌握。</p>\n<p>今天就到这里了，代码都是自动生成的，便不上传了。Have a nice weekend~</p>\n","excerpt":"<h2 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>Facebook 在 <a href=\"http://conf.reactjs.com/\">React.js Conf 2015</a> 大会上推出了基于 JavaScript 的开源框架 <a href=\"https://facebook.github.io/react-native/\">React Native</a>。React Native 结合了 Web 应用和 Native 应用的优势，可以使用 JavaScript 来开发 iOS 和 Android 原生应用。在 JavaScript 中用 React 抽象操作系统原生的 UI 组件，代替 DOM 元素来渲染等。</p>\n<blockquote>\n<p>React Native enables you to build world-class application experiences on native platforms using a consistent developer experience based on JavaScript and React. The focus of React Native is on developer efficiency across all the platforms you care about — learn once, write anywhere. Facebook uses React Native in multiple production apps and will continue investing in React Native.</p>\n</blockquote>\n<p>React Native 使你能够使用基于 JavaScript 和 React 一致的开发体验在本地平台上构建世界一流的应用程序体验。React Native 把重点放在所有开发人员关心的平台的开发效率上——开发者只需学习一种语言就能轻易为任何平台高效地编写代码。Facebook 在多个应用程序产品中使用了 React Native，并将继续为 React Native 投资。</p>\n<p>对于不太了解React Native是什么以及Facebook为什么要创建React Native，可以先看看<a href=\"https://code.facebook.com/posts/1014532261909640/react-native-bringing-modern-web-techniques-to-mobile/\">这篇博客</a>。</p>\n<p>Facebook 于 2015 年 9 月 15 日发布了 React Native for Android， 把 Web 和原生平台的 JavaScript 开发技术扩展到了 Google 的流行移动平台–Android。</p>\n<p>最近项目技术负责人说可能以后我们也会使用这套框架进行App开发，所以便预先学习一下，顺便做下笔记，分享给大家。</p>","more":"<h2 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h2><h3 id=\"安装Node-js\"><a href=\"#安装Node-js\" class=\"headerlink\" title=\"安装Node.js\"></a>安装Node.js</h3><p>react native依赖Node.js，第一步便是下载Node.js。去官网下载，对应电脑系统版本。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native1.png\" alt=\"这里写图片描述\"><br>我是Win 10，下载的64位。下载完成后，直接安装。</p>\n<p>可以随意创建一个一个test.js，来测试Node.js是否安装成功。<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">var http = require(<span class=\"string\">\"http\"</span>)<span class=\"comment\">;</span></div><div class=\"line\"></div><div class=\"line\">http.createServer(function(req, res) &#123;</div><div class=\"line\">  res.writeHead( <span class=\"number\">200</span> , &#123;<span class=\"string\">\"Content-Type\"</span>:<span class=\"string\">\"text/html\"</span>&#125;)<span class=\"comment\">;</span></div><div class=\"line\">  res.write(<span class=\"string\">\"&lt;h1&gt;Node.js&lt;/h1&gt;\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">  res.write(<span class=\"string\">\"&lt;p&gt;Hello World&lt;/p&gt;\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">  res<span class=\"meta\">.end</span>(<span class=\"string\">\"\"</span>)<span class=\"comment\">;</span></div><div class=\"line\">&#125;).listen(<span class=\"number\">8080</span>)<span class=\"comment\">;</span></div><div class=\"line\">console.log(<span class=\"string\">\"HTTP server is listening at port 8080.\"</span>)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>然后进入到响应的目录，执行cmd，键入命令：<code>node test.js</code>，然后浏览器打开”localhost:8080”，显示如下则是安装成功。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native2.png\" alt=\"这里写图片描述\"></p>\n<h3 id=\"安装native环境\"><a href=\"#安装native环境\" class=\"headerlink\" title=\"安装native环境\"></a>安装native环境</h3><p>使用npm指令安装<code>react-native-cli</code>。打开命令行，执行指令：<br><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">npm</span> install -g react-<span class=\"keyword\">native</span>-cli</div></pre></td></tr></table></figure></p>\n<p><code>react-native-cli</code>是用来开发React Native的命令行工具。你需要使用npm来安装它。上面这行代码将会帮助你在terminal中安装react-native命令。这行cmd命令只需要执行一次，后面便可持续使用。</p>\n<p>下面便可以开始创建我们的React Native项目了。</p>\n<h3 id=\"创建项目\"><a href=\"#创建项目\" class=\"headerlink\" title=\"创建项目\"></a>创建项目</h3><p>创建好自己的文件夹之后，cmd命令进入文件夹，执行命令：<br><figure class=\"highlight actionscript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">react-<span class=\"keyword\">native</span> init HelloWorld</div></pre></td></tr></table></figure></p>\n<p>HelloWorld便是项目名，可自己随意取。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native3.png\" alt=\"这里写图片描述\"><br>执行完毕之后便会生成HelloWorld文件夹。目录结构是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native4.png\" alt=\"这里写图片描述\"><br>可以看到生成的项目既包含IOS，也包含Android。因为我是Android开发，所以就暂时不管IOS了。</p>\n<h3 id=\"运行项目\"><a href=\"#运行项目\" class=\"headerlink\" title=\"运行项目\"></a>运行项目</h3><p>在命令行执行完毕之后，我们会看到To run your app on Android的提示。进入到HelloWorld文件夹，执行命令：<br><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">react-native <span class=\"keyword\">run</span><span class=\"bash\">-android</span></div></pre></td></tr></table></figure></p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native5.png\" alt=\"这里写图片描述\"><br>图上所示便是在进行编译，准备安装了。<br>编译成功后，安装运行，界面如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native6.png\" alt=\"这里写图片描述\"><br>提示不能下载JS bundle。这里我们注意一下编译时的黄色提示：<code>Starting the packager in a new window is not supported on Windows yet.Please start it manually using &#39;react-native start&#39;.</code>就是说不支持在Windows上自动开启packager，需要我们自己先启动。</p>\n<p>照着提示来，执行命令：<br><figure class=\"highlight actionscript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">react-<span class=\"keyword\">native</span> start</div></pre></td></tr></table></figure></p>\n<p><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native7.png\" alt=\"这里写图片描述\"><br>可以看到React packager ready.</p>\n<p>OK，再来运行我们的程序。<br>此时界面变显示正常了：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native8.png\" alt=\"这里写图片描述\"><br>同时React packager会打印一些信息：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native9.png\" alt=\"这里写图片描述\"><br>很多东西都还不懂，暂时就先不管了，后面再慢慢了解，至少现在看起来没出什么错。</p>\n<h2 id=\"js代码初探\"><a href=\"#js代码初探\" class=\"headerlink\" title=\"js代码初探\"></a>js代码初探</h2><p>下面便来研究一下显示到界面上的内容到底是怎么来的。</p>\n<p>看到HelloWolrd文件夹下有index.android.js文件，编辑器打开，看到的代码是这样的：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * Sample React Native App</div><div class=\"line\"> * https://github.com/facebook/react-native</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"meta\">'use strict'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> React, &#123;</div><div class=\"line\">  AppRegistry,</div><div class=\"line\">  Component,</div><div class=\"line\">  StyleSheet,</div><div class=\"line\">  Text,</div><div class=\"line\">  View</div><div class=\"line\">&#125; <span class=\"keyword\">from</span> <span class=\"string\">'react-native'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HelloWorld</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</div><div class=\"line\">  render() &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      <span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">View</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.container&#125;</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.welcome&#125;</span>&gt;</span></div><div class=\"line\">          Welcome to React Native!</div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.instructions&#125;</span>&gt;</span></div><div class=\"line\">          To get started, edit index.android.js</div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.instructions&#125;</span>&gt;</span></div><div class=\"line\">          Shake or press menu button for dev menu</div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></div><div class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">View</span>&gt;</span></span></div><div class=\"line\">    );</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">const</span> styles = StyleSheet.create(&#123;</div><div class=\"line\">  <span class=\"attr\">container</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">flex</span>: <span class=\"number\">1</span>,</div><div class=\"line\">    <span class=\"attr\">justifyContent</span>: <span class=\"string\">'center'</span>,</div><div class=\"line\">    <span class=\"attr\">alignItems</span>: <span class=\"string\">'center'</span>,</div><div class=\"line\">    <span class=\"attr\">backgroundColor</span>: <span class=\"string\">'#F5FCFF'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">welcome</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">fontSize</span>: <span class=\"number\">20</span>,</div><div class=\"line\">    <span class=\"attr\">textAlign</span>: <span class=\"string\">'center'</span>,</div><div class=\"line\">    <span class=\"attr\">margin</span>: <span class=\"number\">10</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">instructions</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">textAlign</span>: <span class=\"string\">'center'</span>,</div><div class=\"line\">    <span class=\"attr\">color</span>: <span class=\"string\">'#333333'</span>,</div><div class=\"line\">    <span class=\"attr\">marginBottom</span>: <span class=\"number\">5</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">AppRegistry.registerComponent(<span class=\"string\">'HelloWorld'</span>, () =&gt; HelloWorld);</div></pre></td></tr></table></figure></p>\n<p>此时，对着代码与界面，我们便可以大胆的猜测界面上显示的文字就是HelloWorld class中对应的3个Text标签了。下面尝试一下：</p>\n<p>HelloWorld class代码改成如下：<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HelloWorld</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</div><div class=\"line\">  render() &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      &lt;<span class=\"type\">View</span> style=&#123;styles.container&#125;&gt;</div><div class=\"line\">        &lt;<span class=\"type\">Text</span> style=&#123;styles.welcome&#125;&gt;</div><div class=\"line\">          <span class=\"type\">Hello</span> <span class=\"type\">World</span>!</div><div class=\"line\">        &lt;/<span class=\"type\">Text</span>&gt;</div><div class=\"line\">      &lt;/<span class=\"type\">View</span>&gt;</div><div class=\"line\">    );</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>我们把之前3个Text标签去掉，写一个显示Hello World的Text标签。那么改好之后如何看到效果呢？？？请注意，这便是React Native框架非常厉害的地方，你不需要重新编译安装apk，更新包等操作，直接虚拟机点出Menu，点击Roload JS即可实现更新：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native10.png\" alt=\"这里写图片描述\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native11.png\" alt=\"这里写图片描述\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native12.png\" alt=\"这里写图片描述\"><br>可以看到，界面确实是变成了我们预想的样子。</p>\n<p>下面我从官网复制了一份index.android.js代码：<br><figure class=\"highlight actionscript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * Sample React Native App</div><div class=\"line\"> * https://github.com/facebook/react-native</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"string\">'use strict'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> React = require(<span class=\"string\">'react-native'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> &#123;</div><div class=\"line\">  AppRegistry,</div><div class=\"line\">  Image,</div><div class=\"line\">  ListView,</div><div class=\"line\">  StyleSheet,</div><div class=\"line\">  Text,</div><div class=\"line\">  View,</div><div class=\"line\">&#125; = React;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> API_KEY = <span class=\"string\">'7waqfqbprs7pajbz28mqf6vz'</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> API_URL = <span class=\"string\">'http://api.rottentomatoes.com/api/public/v1.0/lists/movies/in_theaters.json'</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> PAGE_SIZE = <span class=\"number\">25</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> PARAMS = <span class=\"string\">'?apikey='</span> + API_KEY + <span class=\"string\">'&amp;page_limit='</span> + PAGE_SIZE;</div><div class=\"line\"><span class=\"keyword\">var</span> REQUEST_URL = API_URL + PARAMS;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> AwesomeProject = React.createClass(&#123;</div><div class=\"line\">  getInitialState: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> &#123;</div><div class=\"line\">      dataSource: <span class=\"keyword\">new</span> ListView.DataSource(&#123;</div><div class=\"line\">        rowHasChanged: (row1, row2) =&gt; row1 !== row2,</div><div class=\"line\">      &#125;),</div><div class=\"line\">      loaded: <span class=\"literal\">false</span>,</div><div class=\"line\">    &#125;;</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  componentDidMount: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">this</span>.fetchData();</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  fetchData: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    fetch(REQUEST_URL)</div><div class=\"line\">      .then((response) =&gt; response.json())</div><div class=\"line\">      .then((responseData) =&gt; &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.setState(&#123;</div><div class=\"line\">          dataSource: <span class=\"keyword\">this</span>.state.dataSource.cloneWithRows(responseData.movies),</div><div class=\"line\">          loaded: <span class=\"literal\">true</span>,</div><div class=\"line\">        &#125;);</div><div class=\"line\">      &#125;)</div><div class=\"line\">      .done();</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  render: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.state.loaded) &#123;</div><div class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.renderLoadingView();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      &lt;ListView</div><div class=\"line\">        dataSource=&#123;<span class=\"keyword\">this</span>.state.dataSource&#125;</div><div class=\"line\">        renderRow=&#123;<span class=\"keyword\">this</span>.renderMovie&#125;</div><div class=\"line\">        style=&#123;styles.listView&#125;</div><div class=\"line\">      /&gt;</div><div class=\"line\">    );</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  renderLoadingView: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      &lt;View style=&#123;styles.container&#125;&gt;</div><div class=\"line\">        &lt;Text&gt;</div><div class=\"line\">          Loading movies...</div><div class=\"line\">        &lt;/Text&gt;</div><div class=\"line\">      &lt;/View&gt;</div><div class=\"line\">    );</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  renderMovie: <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">(movie)</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (</div><div class=\"line\">      &lt;View style=&#123;styles.container&#125;&gt;</div><div class=\"line\">        &lt;Image</div><div class=\"line\">          source=&#123;&#123;uri: movie.posters.thumbnail&#125;&#125;</div><div class=\"line\">          style=&#123;styles.thumbnail&#125;</div><div class=\"line\">        /&gt;</div><div class=\"line\">        &lt;View style=&#123;styles.rightContainer&#125;&gt;</div><div class=\"line\">          &lt;Text style=&#123;styles.title&#125;&gt;&#123;movie.title&#125;&lt;/Text&gt;</div><div class=\"line\">          &lt;Text style=&#123;styles.year&#125;&gt;&#123;movie.year&#125;&lt;/Text&gt;</div><div class=\"line\">        &lt;/View&gt;</div><div class=\"line\">      &lt;/View&gt;</div><div class=\"line\">    );</div><div class=\"line\">  &#125;,</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> styles = StyleSheet.create(&#123;</div><div class=\"line\">  container: &#123;</div><div class=\"line\">    flex: <span class=\"number\">1</span>,</div><div class=\"line\">    flexDirection: <span class=\"string\">'row'</span>,</div><div class=\"line\">    justifyContent: <span class=\"string\">'center'</span>,</div><div class=\"line\">    alignItems: <span class=\"string\">'center'</span>,</div><div class=\"line\">    backgroundColor: <span class=\"string\">'#F5FCFF'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  rightContainer: &#123;</div><div class=\"line\">    flex: <span class=\"number\">1</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  title: &#123;</div><div class=\"line\">    fontSize: <span class=\"number\">20</span>,</div><div class=\"line\">    marginBottom: <span class=\"number\">8</span>,</div><div class=\"line\">    textAlign: <span class=\"string\">'center'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  year: &#123;</div><div class=\"line\">    textAlign: <span class=\"string\">'center'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  thumbnail: &#123;</div><div class=\"line\">    width: <span class=\"number\">53</span>,</div><div class=\"line\">    height: <span class=\"number\">81</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">  listView: &#123;</div><div class=\"line\">    paddingTop: <span class=\"number\">20</span>,</div><div class=\"line\">    backgroundColor: <span class=\"string\">'#F5FCFF'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">AppRegistry.registerComponent(<span class=\"string\">'AwesomeProject'</span>, () =&gt; AwesomeProject);</div></pre></td></tr></table></figure></p>\n<p>然后Reload JS，界面如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native13.png\" alt=\"这里写图片描述\"><br>呀，出错了。我们看到是在registerComponent的时候出错了。想起来我们的项目名称是HelloWorld，将最后一句代码改掉。<br><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">AppRegistry.registerComponent(<span class=\"string\">'HelloWorld'</span>, <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> AwesomeProject);</div></pre></td></tr></table></figure></p>\n<p>Reload JS。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native14.png\" alt=\"这里写图片描述\"><br>加载完毕后的显示界面：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native15.png\" alt=\"这里写图片描述\"><br>但是将代码改成：<br><figure class=\"highlight coffeescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">AppRegistry.registerComponent(<span class=\"string\">'HelloWorld'</span>, <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> HelloWorld);</div></pre></td></tr></table></figure></p>\n<p>执行又出错了：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/01/react-native16.png\" alt=\"这里写图片描述\"><br>看来东西不能乱改呀，至于是什么原因，就放在以后慢慢去发现去解决了。另外这种JS代码的写法也是需要在实践中慢慢积累，学习，才能逐步掌握。</p>\n<p>今天就到这里了，代码都是自动生成的，便不上传了。Have a nice weekend~</p>"},{"title":"Java反射实现接口","date":"2015-10-28T04:00:03.000Z","_content":"\n之前做过一个插件，综合了移动MM，移动和游戏，沃商店等一些计费SDK。将这些计费SDK提供的接口全部整合，最后由插件提供一套接口。通过后台配置，来让游戏使用某种计费SDK。游戏开发商接入计费的时候，只需要调用插件提供的一套接口即可。因为不可能保证游戏会包含所有的计费SDK的代码，所以插件内部只能利用反射来实现。通过反射来获取类，获取方法进行调用是比较简单的。\n\n但是有个问题困扰了我很久：计费SDK都有提供回调接口，使游戏开发商在计费成功或失败进行回调，那么如何通过反射来实现这些回调接口，进行调用呢？通过一段时间的摸索，知道了一种解决方法：使用`Proxy`类与`InvocationHandler`接口。\n\n---\n\n下面通过一个例子进行讲解。\n\n<!--more-->\n\n1. 首先以计费SDK为例子写一个library工程，提供一个方法和一个回调接口：\n```\npackage com.lastwarmth.library;\n\npublic class MyLibrary {\n\n\tpublic interface Callback {\n\t\tvoid doCallback();\n\t}\n\n\tpublic void mainMethod(Callback callback) {\n\t\tSystem.out.println(\"doing main...\");\n\t\tcallback.doCallback();\n\t}\n}\n```\n2. 新建MyTest工程，编写类实现InvocationHandler：\n```\npackage com.lastwarmth.demo;\n\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\n\npublic class MyHandler implements InvocationHandler{\n\n\t@Override\n\tpublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n\t\tSystem.out.println(\"doing callback...\");\n\t\treturn null;\n\t}\n\n}\n\n```\n3. MyTest工程测试代码：\n```\npackage com.lastwarmth.demo;\n\nimport java.lang.reflect.InvocationTargetException;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\n\npublic class MyTest {\n\n\tpublic static void main(String[] args) {\n\t\ttry {\n\t\t\tClass<?> mClass = Class.forName(\"com.lastwarmth.library.MyLibrary\");\n\t\t\tClass<?> mCallback = Class.forName(\"com.lastwarmth.library.MyLibrary$Callback\");\n\t\t\tMyHandler mHandler = new MyHandler();\n\t\t\tObject mObj = Proxy.newProxyInstance(MyTest.class.getClassLoader(), new Class[] { mCallback }, mHandler);\n\t\t\tMethod mMethod = mClass.getDeclaredMethod(\"mainMethod\", new Class[] { mCallback });\n\t\t\tmMethod.invoke(mClass.newInstance(), new Object[] { mObj });\n\t\t} catch (ClassNotFoundException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (NoSuchMethodException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (SecurityException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (IllegalAccessException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (IllegalArgumentException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (InvocationTargetException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (InstantiationException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t}\n\n\t}\n\n}\n\n```\n4. 将MyLibrary打成jar包，引入到MyTest的build path中，或者直接将java代码考到MyTest工程下（若不这样做，运行会抛出异常，但不会致使程序崩溃）。然后运行，控制台输出结果：\n```\ndoing main...\ndoing callback...\n```\n说明MyTest类通过反射获取到了MyLibrary类中的Callback接口，并实现调用。\n代码比较简单，就不作过多讲述了。\n\n---\n总结：\n<font color=red>java.lang.reflect.Proxy：</font>这是 Java 动态代理机制的主类，它提供了一组静态方法来为一组接口动态地生成代理类及其对象。\n\n- static InvocationHandler getInvocationHandler(Object proxy)：该方法用于获取指定代理对象所关联的调用处理器\n\n- static Class getProxyClass(ClassLoader loader, Class[] interfaces) ：该方法用于获取关联于指定类装载器和一组接口的动态代理类的类对象\n\n- static boolean isProxyClass(Class cl)：该方法用于判断指定类对象是否是一个动态代理类\n\n- static Object newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)：该方法用于为指定类装载器、一组接口及调用处理器生成动态代理类实例\n文中采用第4个方法，获取到了实现接口Callback的实例。\n\n<font color=red>java.lang.reflect.InvocationHandler：</font>这是调用处理器接口，它自定义了一个 invoke 方法，用于集中处理在动态代理类对象上的方法调用，通常在该方法中实现对委托类的代理访问。\n\n- Object invoke(Object proxy, Method method, Object[] args)：该方法负责集中处理动态代理类上的所有方法调用。第一个参数是代理类实例，第二个参数是被调用的方法对象。第三个方法是调用参数。调用处理器根据这三个参数进行预处理或分派到委托类实例上反射执行。\n\n在本文中，并没有代理类。直接在invoke方法中写入我们继承Callback接口需要实现的方法内容即可。\n通过`Proxy`类与`InvocationHandler`接口，即可完成反射实现接口的功能了。\n","source":"_posts/reflect-interface.md","raw":"---\ntitle: Java反射实现接口\ndate: 2015-10-28 12:00:03\ntags:\n - java\n---\n\n之前做过一个插件，综合了移动MM，移动和游戏，沃商店等一些计费SDK。将这些计费SDK提供的接口全部整合，最后由插件提供一套接口。通过后台配置，来让游戏使用某种计费SDK。游戏开发商接入计费的时候，只需要调用插件提供的一套接口即可。因为不可能保证游戏会包含所有的计费SDK的代码，所以插件内部只能利用反射来实现。通过反射来获取类，获取方法进行调用是比较简单的。\n\n但是有个问题困扰了我很久：计费SDK都有提供回调接口，使游戏开发商在计费成功或失败进行回调，那么如何通过反射来实现这些回调接口，进行调用呢？通过一段时间的摸索，知道了一种解决方法：使用`Proxy`类与`InvocationHandler`接口。\n\n---\n\n下面通过一个例子进行讲解。\n\n<!--more-->\n\n1. 首先以计费SDK为例子写一个library工程，提供一个方法和一个回调接口：\n```\npackage com.lastwarmth.library;\n\npublic class MyLibrary {\n\n\tpublic interface Callback {\n\t\tvoid doCallback();\n\t}\n\n\tpublic void mainMethod(Callback callback) {\n\t\tSystem.out.println(\"doing main...\");\n\t\tcallback.doCallback();\n\t}\n}\n```\n2. 新建MyTest工程，编写类实现InvocationHandler：\n```\npackage com.lastwarmth.demo;\n\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\n\npublic class MyHandler implements InvocationHandler{\n\n\t@Override\n\tpublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n\t\tSystem.out.println(\"doing callback...\");\n\t\treturn null;\n\t}\n\n}\n\n```\n3. MyTest工程测试代码：\n```\npackage com.lastwarmth.demo;\n\nimport java.lang.reflect.InvocationTargetException;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\n\npublic class MyTest {\n\n\tpublic static void main(String[] args) {\n\t\ttry {\n\t\t\tClass<?> mClass = Class.forName(\"com.lastwarmth.library.MyLibrary\");\n\t\t\tClass<?> mCallback = Class.forName(\"com.lastwarmth.library.MyLibrary$Callback\");\n\t\t\tMyHandler mHandler = new MyHandler();\n\t\t\tObject mObj = Proxy.newProxyInstance(MyTest.class.getClassLoader(), new Class[] { mCallback }, mHandler);\n\t\t\tMethod mMethod = mClass.getDeclaredMethod(\"mainMethod\", new Class[] { mCallback });\n\t\t\tmMethod.invoke(mClass.newInstance(), new Object[] { mObj });\n\t\t} catch (ClassNotFoundException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (NoSuchMethodException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (SecurityException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (IllegalAccessException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (IllegalArgumentException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (InvocationTargetException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (InstantiationException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t}\n\n\t}\n\n}\n\n```\n4. 将MyLibrary打成jar包，引入到MyTest的build path中，或者直接将java代码考到MyTest工程下（若不这样做，运行会抛出异常，但不会致使程序崩溃）。然后运行，控制台输出结果：\n```\ndoing main...\ndoing callback...\n```\n说明MyTest类通过反射获取到了MyLibrary类中的Callback接口，并实现调用。\n代码比较简单，就不作过多讲述了。\n\n---\n总结：\n<font color=red>java.lang.reflect.Proxy：</font>这是 Java 动态代理机制的主类，它提供了一组静态方法来为一组接口动态地生成代理类及其对象。\n\n- static InvocationHandler getInvocationHandler(Object proxy)：该方法用于获取指定代理对象所关联的调用处理器\n\n- static Class getProxyClass(ClassLoader loader, Class[] interfaces) ：该方法用于获取关联于指定类装载器和一组接口的动态代理类的类对象\n\n- static boolean isProxyClass(Class cl)：该方法用于判断指定类对象是否是一个动态代理类\n\n- static Object newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)：该方法用于为指定类装载器、一组接口及调用处理器生成动态代理类实例\n文中采用第4个方法，获取到了实现接口Callback的实例。\n\n<font color=red>java.lang.reflect.InvocationHandler：</font>这是调用处理器接口，它自定义了一个 invoke 方法，用于集中处理在动态代理类对象上的方法调用，通常在该方法中实现对委托类的代理访问。\n\n- Object invoke(Object proxy, Method method, Object[] args)：该方法负责集中处理动态代理类上的所有方法调用。第一个参数是代理类实例，第二个参数是被调用的方法对象。第三个方法是调用参数。调用处理器根据这三个参数进行预处理或分派到委托类实例上反射执行。\n\n在本文中，并没有代理类。直接在invoke方法中写入我们继承Callback接口需要实现的方法内容即可。\n通过`Proxy`类与`InvocationHandler`接口，即可完成反射实现接口的功能了。\n","slug":"reflect-interface","published":1,"updated":"2016-11-21T10:02:45.020Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75a1002k1cb8873oh5jv","content":"<p>之前做过一个插件，综合了移动MM，移动和游戏，沃商店等一些计费SDK。将这些计费SDK提供的接口全部整合，最后由插件提供一套接口。通过后台配置，来让游戏使用某种计费SDK。游戏开发商接入计费的时候，只需要调用插件提供的一套接口即可。因为不可能保证游戏会包含所有的计费SDK的代码，所以插件内部只能利用反射来实现。通过反射来获取类，获取方法进行调用是比较简单的。</p>\n<p>但是有个问题困扰了我很久：计费SDK都有提供回调接口，使游戏开发商在计费成功或失败进行回调，那么如何通过反射来实现这些回调接口，进行调用呢？通过一段时间的摸索，知道了一种解决方法：使用<code>Proxy</code>类与<code>InvocationHandler</code>接口。</p>\n<hr>\n<p>下面通过一个例子进行讲解。</p>\n<a id=\"more\"></a>\n<ol>\n<li><p>首先以计费SDK为例子写一个library工程，提供一个方法和一个回调接口：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">package com.lastwarmth.library;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">MyLibrary</span> &#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">Callback</span> &#123;</div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doCallback</span>(<span class=\"params\"></span>)</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">mainMethod</span>(<span class=\"params\">Callback callback</span>) </span>&#123;</div><div class=\"line\">\t\tSystem.<span class=\"keyword\">out</span>.println(<span class=\"string\">\"doing main...\"</span>);</div><div class=\"line\">\t\tcallback.doCallback();</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n</li>\n<li><p>新建MyTest工程，编写类实现InvocationHandler：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> com.lastwarmth.demo;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.InvocationHandler;</div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">InvocationHandler</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</div><div class=\"line\">\t\tSystem.out.println(<span class=\"string\">\"doing callback...\"</span>);</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n</li>\n<li><p>MyTest工程测试代码：</p>\n<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> com.lastwarmth.demo;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.InvocationTargetException;</div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Proxy;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyTest</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> void main(<span class=\"keyword\">String</span>[] args) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tClass&lt;?&gt; mClass = Class.forName(<span class=\"string\">\"com.lastwarmth.library.MyLibrary\"</span>);</div><div class=\"line\">\t\t\tClass&lt;?&gt; mCallback = Class.forName(<span class=\"string\">\"com.lastwarmth.library.MyLibrary$Callback\"</span>);</div><div class=\"line\">\t\t\tMyHandler mHandler = <span class=\"keyword\">new</span> <span class=\"type\">MyHandler</span>();</div><div class=\"line\">\t\t\tObject mObj = Proxy.<span class=\"keyword\">new</span><span class=\"type\">ProxyInstance</span>(MyTest.class.getClassLoader(), <span class=\"keyword\">new</span> <span class=\"type\">Class</span>[] &#123; mCallback &#125;, mHandler);</div><div class=\"line\">\t\t\tMethod mMethod = mClass.getDeclaredMethod(<span class=\"string\">\"mainMethod\"</span>, <span class=\"keyword\">new</span> <span class=\"type\">Class</span>[] &#123; mCallback &#125;);</div><div class=\"line\">\t\t\tmMethod.invoke(mClass.<span class=\"keyword\">new</span><span class=\"type\">Instance</span>(), <span class=\"keyword\">new</span> <span class=\"type\">Object</span>[] &#123; mObj &#125;);</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (NoSuchMethodException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (SecurityException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IllegalAccessException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IllegalArgumentException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (InvocationTargetException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (InstantiationException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n</li>\n<li><p>将MyLibrary打成jar包，引入到MyTest的build path中，或者直接将java代码考到MyTest工程下（若不这样做，运行会抛出异常，但不会致使程序崩溃）。然后运行，控制台输出结果：</p>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"title\">doing</span></span> main...</div><div class=\"line\"><span class=\"function\"><span class=\"title\">doing</span></span> callback...</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>说明MyTest类通过反射获取到了MyLibrary类中的Callback接口，并实现调用。<br>代码比较简单，就不作过多讲述了。</p>\n<hr>\n<p>总结：</p>\n<p><font color=\"red\">java.lang.reflect.Proxy：</font>这是 Java 动态代理机制的主类，它提供了一组静态方法来为一组接口动态地生成代理类及其对象。</p>\n<ul>\n<li><p>static InvocationHandler getInvocationHandler(Object proxy)：该方法用于获取指定代理对象所关联的调用处理器</p>\n</li>\n<li><p>static Class getProxyClass(ClassLoader loader, Class[] interfaces) ：该方法用于获取关联于指定类装载器和一组接口的动态代理类的类对象</p>\n</li>\n<li><p>static boolean isProxyClass(Class cl)：该方法用于判断指定类对象是否是一个动态代理类</p>\n</li>\n<li><p>static Object newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)：该方法用于为指定类装载器、一组接口及调用处理器生成动态代理类实例<br>文中采用第4个方法，获取到了实现接口Callback的实例。</p>\n</li>\n</ul>\n<p><font color=\"red\">java.lang.reflect.InvocationHandler：</font>这是调用处理器接口，它自定义了一个 invoke 方法，用于集中处理在动态代理类对象上的方法调用，通常在该方法中实现对委托类的代理访问。</p>\n<ul>\n<li>Object invoke(Object proxy, Method method, Object[] args)：该方法负责集中处理动态代理类上的所有方法调用。第一个参数是代理类实例，第二个参数是被调用的方法对象。第三个方法是调用参数。调用处理器根据这三个参数进行预处理或分派到委托类实例上反射执行。</li>\n</ul>\n<p>在本文中，并没有代理类。直接在invoke方法中写入我们继承Callback接口需要实现的方法内容即可。<br>通过<code>Proxy</code>类与<code>InvocationHandler</code>接口，即可完成反射实现接口的功能了。</p>\n","excerpt":"<p>之前做过一个插件，综合了移动MM，移动和游戏，沃商店等一些计费SDK。将这些计费SDK提供的接口全部整合，最后由插件提供一套接口。通过后台配置，来让游戏使用某种计费SDK。游戏开发商接入计费的时候，只需要调用插件提供的一套接口即可。因为不可能保证游戏会包含所有的计费SDK的代码，所以插件内部只能利用反射来实现。通过反射来获取类，获取方法进行调用是比较简单的。</p>\n<p>但是有个问题困扰了我很久：计费SDK都有提供回调接口，使游戏开发商在计费成功或失败进行回调，那么如何通过反射来实现这些回调接口，进行调用呢？通过一段时间的摸索，知道了一种解决方法：使用<code>Proxy</code>类与<code>InvocationHandler</code>接口。</p>\n<hr>\n<p>下面通过一个例子进行讲解。</p>","more":"<ol>\n<li><p>首先以计费SDK为例子写一个library工程，提供一个方法和一个回调接口：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">package com.lastwarmth.library;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">MyLibrary</span> &#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">Callback</span> &#123;</div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doCallback</span>(<span class=\"params\"></span>)</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">mainMethod</span>(<span class=\"params\">Callback callback</span>) </span>&#123;</div><div class=\"line\">\t\tSystem.<span class=\"keyword\">out</span>.println(<span class=\"string\">\"doing main...\"</span>);</div><div class=\"line\">\t\tcallback.doCallback();</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n</li>\n<li><p>新建MyTest工程，编写类实现InvocationHandler：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> com.lastwarmth.demo;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.InvocationHandler;</div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">InvocationHandler</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</div><div class=\"line\">\t\tSystem.out.println(<span class=\"string\">\"doing callback...\"</span>);</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n</li>\n<li><p>MyTest工程测试代码：</p>\n<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> com.lastwarmth.demo;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.InvocationTargetException;</div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</div><div class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Proxy;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyTest</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> void main(<span class=\"keyword\">String</span>[] args) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\tClass&lt;?&gt; mClass = Class.forName(<span class=\"string\">\"com.lastwarmth.library.MyLibrary\"</span>);</div><div class=\"line\">\t\t\tClass&lt;?&gt; mCallback = Class.forName(<span class=\"string\">\"com.lastwarmth.library.MyLibrary$Callback\"</span>);</div><div class=\"line\">\t\t\tMyHandler mHandler = <span class=\"keyword\">new</span> <span class=\"type\">MyHandler</span>();</div><div class=\"line\">\t\t\tObject mObj = Proxy.<span class=\"keyword\">new</span><span class=\"type\">ProxyInstance</span>(MyTest.class.getClassLoader(), <span class=\"keyword\">new</span> <span class=\"type\">Class</span>[] &#123; mCallback &#125;, mHandler);</div><div class=\"line\">\t\t\tMethod mMethod = mClass.getDeclaredMethod(<span class=\"string\">\"mainMethod\"</span>, <span class=\"keyword\">new</span> <span class=\"type\">Class</span>[] &#123; mCallback &#125;);</div><div class=\"line\">\t\t\tmMethod.invoke(mClass.<span class=\"keyword\">new</span><span class=\"type\">Instance</span>(), <span class=\"keyword\">new</span> <span class=\"type\">Object</span>[] &#123; mObj &#125;);</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (NoSuchMethodException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (SecurityException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IllegalAccessException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (IllegalArgumentException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (InvocationTargetException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (InstantiationException e) &#123;</div><div class=\"line\">\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></div><div class=\"line\">\t\t\te.printStackTrace();</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n</li>\n<li><p>将MyLibrary打成jar包，引入到MyTest的build path中，或者直接将java代码考到MyTest工程下（若不这样做，运行会抛出异常，但不会致使程序崩溃）。然后运行，控制台输出结果：</p>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"title\">doing</span></span> main...</div><div class=\"line\"><span class=\"function\"><span class=\"title\">doing</span></span> callback...</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>说明MyTest类通过反射获取到了MyLibrary类中的Callback接口，并实现调用。<br>代码比较简单，就不作过多讲述了。</p>\n<hr>\n<p>总结：</p>\n<p><font color=red>java.lang.reflect.Proxy：</font>这是 Java 动态代理机制的主类，它提供了一组静态方法来为一组接口动态地生成代理类及其对象。</p>\n<ul>\n<li><p>static InvocationHandler getInvocationHandler(Object proxy)：该方法用于获取指定代理对象所关联的调用处理器</p>\n</li>\n<li><p>static Class getProxyClass(ClassLoader loader, Class[] interfaces) ：该方法用于获取关联于指定类装载器和一组接口的动态代理类的类对象</p>\n</li>\n<li><p>static boolean isProxyClass(Class cl)：该方法用于判断指定类对象是否是一个动态代理类</p>\n</li>\n<li><p>static Object newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)：该方法用于为指定类装载器、一组接口及调用处理器生成动态代理类实例<br>文中采用第4个方法，获取到了实现接口Callback的实例。</p>\n</li>\n</ul>\n<p><font color=red>java.lang.reflect.InvocationHandler：</font>这是调用处理器接口，它自定义了一个 invoke 方法，用于集中处理在动态代理类对象上的方法调用，通常在该方法中实现对委托类的代理访问。</p>\n<ul>\n<li>Object invoke(Object proxy, Method method, Object[] args)：该方法负责集中处理动态代理类上的所有方法调用。第一个参数是代理类实例，第二个参数是被调用的方法对象。第三个方法是调用参数。调用处理器根据这三个参数进行预处理或分派到委托类实例上反射执行。</li>\n</ul>\n<p>在本文中，并没有代理类。直接在invoke方法中写入我们继承Callback接口需要实现的方法内容即可。<br>通过<code>Proxy</code>类与<code>InvocationHandler</code>接口，即可完成反射实现接口的功能了。</p>"},{"title":"Android自定义View实现弧形SeekBar","date":"2016-04-27T05:53:19.000Z","_content":"\n## 前言\n项目开发中有这样一个需求：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar4.png)\n通过滑动SeekBar来控制打赏金额，金额设置5个档次。\n\n看到设计稿的时候，除了自定义View想不到什么更好的方法了。自定义View一直是我的短板，内心总会有点抗拒，总感觉自己做不出来。最近一段时间，也是有意无意的练习自定义View。最后决定还是用自定义View来实现这次的需求。\n\n根据设计图，我分为3个步骤：\n1. 画弧线。\n2. 画圆球。\n3. 触摸事件的处理，并提供对外接口。\n\n<!-- more -->\n\n## 画弧线\n### 圆弧\n起初的想法是根据自定义View的宽高，创建一个正方形，然后画一个内切圆，截取其中的一段圆弧。大致就是这样的：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar1.png)\n假设这样的圆存在，那么对于View的宽高有一个要求:\n假定宽为a，高为b，x为半径。取一个直角三角形，勾股定理能得出这样的公式：\n```\n(a/2)*(a/2) + (x-b)*(x-b) = x*x;\n```\n化简得到:\n```\nx = b/2 + (a*a) / (8*b)\n```\n假设若成立，那么``x-b>0``,得到\n```\na > 2b\n```\n即对View的宽高有一个这样的硬性要求，才能符合预期。\n\n另外，后续还需要画圆球，圆球的圆心肯定是需要在弧线上的，那么我每次画圆球时，圆心的坐标都需要通过三角函数来获得，会显得比较麻烦。考虑再三便放弃这种做法了。\n\n### 抛物线\n晚上下班回家，跟室友讨论了一波这个问题，我室友当场来了个：``抛物线``。后面一想：卧槽？确实可以啊。直接确定3个点，就能确定抛物线的公式了，这样对于后续画圆球，求圆心的坐标也非常简单。于是打算第二天来做一波。\n\n第二天。\n\n网上一查，没查到android关于画抛物线的方法。我的内心：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar3.jpg)\n于是便也放弃了这种做法。\n\n### 贝塞尔\n网上查阅资料的时候，关于弧线说的最多的就是利用贝塞尔曲线。\n关于贝塞尔曲线的更多介绍可以参考[这篇文章](http://blog.csdn.net/androidzhaoxiaogang/article/details/8680330)。\n\n二阶贝塞尔曲线符合我的情况，于是选取的二阶贝塞尔曲线。\n贝塞尔曲线的关键代码如下：\n```\npath.moveTo(pointF1.x, pointF1.y);\npath.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);\ncanvas.drawPath(path, paint);\n```\npointF1是起始点，pointF2是控制点，pointF3是终止点。\n采用贝塞尔曲线实现的效果还不错，只是控制点是不在曲线上的，曲线无法与View的顶部相切，但也无伤大雅了。\n\n## 画圆球\n画圆球就比较简单了，计算出圆心坐标直接画圆即可。\n```\n// 二阶贝塞尔曲线公式计算坐标\nfloat t = (currentX / (right - left));\nfloat x = (1 - t) * (1 - t) * pointF1.x + 2 * (t) * (1 - t) * pointF2.x + t * t * pointF3.x;\nfloat y = (1 - t) * (1 - t) * pointF1.y + 2 * (t) * (1 - t) * pointF2.y + t * t * pointF3.y;\ncircleCenter.set(x, y);\npaint.reset();\npaint.setFlags(Paint.ANTI_ALIAS_FLAG);\npaint.setColor(Color.WHITE);\npaint.setStyle(Paint.Style.FILL);\ncanvas.drawCircle(x, y, RADIUS, paint);\n```\n二阶贝塞尔曲线的公式是这样的：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar2.png)\n我们把当前的横坐标currentX对于View宽度的比例作为t。\n\n## 触摸事件处理&对外接口\n触摸事件无非就是重写``onTouchEvent``，这里我只对横坐标做了处理，只要横着滑，就能滑动圆球了，并没有处理纵坐标。\n1. ACTION_DOWN：判断点下的坐标是否在圆球返回内（我设置了20的误差），若不在圆球内，则直接返回false，那么后续就不会接收ACTION_MOVE等其他事件了。若在则返回true，接收后续的ACTION_MOVE等事件。\n2. ACTION_MOVE：获取x坐标，然后设置currentX，重绘。对外的接口也是在这里调用。\n3. default：当手指移出或者离开View时，利用Scroller使圆球平滑滑到距离最近的档次。\n\n下面上完整代码：\n```\npublic class CustomArcSeekBar extends View {\n\n    private Scroller scroller;\n    private Paint paint;\n    private Path path;\n    private PointF pointF1; // 起始点\n    private PointF pointF2; // 控制点\n    private PointF pointF3; // 终止点\n    private PointF circleCenter; // 圆心的坐标\n    private int top;\n    private int right;\n    private int bottom;\n    private int left;\n    private float currentX; // 当前x坐标，用于控制圆球位置\n    private int currentLevel; // 当前档次\n    private OnProgressChangedListener listener;\n\n    private final static float RADIUS = 30f; // 圆球半径\n    private final static float LEVEL = 6f; // 设置档次\n\n    public CustomArcSeekBar(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public CustomArcSeekBar(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public CustomArcSeekBar(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    private void init(Context context) {\n        paint = new Paint();\n        path = new Path();\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n        circleCenter = new PointF();\n        scroller = new Scroller(context);\n    }\n\n    @Override\n    public void computeScroll() {\n        if (scroller.computeScrollOffset()) {\n            currentX = scroller.getCurrX();\n            postInvalidate();\n        }\n    }\n\n    public void setListener(OnProgressChangedListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        this.left = left;\n        this.top = top;\n        this.right = right;\n        this.bottom = bottom;\n        pointF1.set(0, bottom - top);\n        pointF2.set((right - left) / 2, -(bottom - top) / 2);\n        pointF3.set(right, bottom - top);\n        currentX = (right - left) / LEVEL;\n        currentLevel = 1;\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n\n        // 画2阶贝塞尔曲线\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.GRAY);\n        paint.setStrokeWidth(10);\n        paint.setStyle(Paint.Style.STROKE);\n        path.moveTo(pointF1.x, pointF1.y);\n        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);\n        canvas.drawPath(path, paint);\n\n        // 通过x坐标，计算圆心的坐标，画圆\n        float t = (currentX / (right - left));\n        float x = (1 - t) * (1 - t) * pointF1.x + 2 * (t) * (1 - t) * pointF2.x + t * t * pointF3.x;\n        float y = (1 - t) * (1 - t) * pointF1.y + 2 * (t) * (1 - t) * pointF2.y + t * t * pointF3.y;\n        circleCenter.set(x, y);\n        paint.reset();\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.WHITE);\n        paint.setStyle(Paint.Style.FILL);\n        canvas.drawCircle(x, y, RADIUS, paint);\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent event) {\n        switch (event.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                float downX = event.getX();\n                float downY = event.getY();\n                float distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);\n                // 计算到圆球中心的距离，考虑20的误差\n                return !(distance - (RADIUS + 20) * (RADIUS + 20) > 0);\n            case MotionEvent.ACTION_MOVE:\n                float moveX = event.getX();\n                currentX = moveX; // 通过x坐标重绘圆球\n                invalidate();\n                currentLevel = getLevel(moveX);\n                if (listener != null) {\n                    listener.OnProgressChanged(currentLevel);\n                }\n                break;\n            default:\n                // 当手指移出或者离开View时，圆球平滑滑到最近的档次\n                scroller.startScroll((int) currentX, 0, (int) ((right - left) / LEVEL * currentLevel - currentX), 0, 200);\n                postInvalidate();\n                break;\n        }\n        return super.onTouchEvent(event);\n    }\n\n    /**\n     * 计算档次\n     *\n     * @param x 横坐标\n     * @return 档次\n     */\n    private int getLevel(float x) {\n        float ratio = (x / (right - left)) * LEVEL;\n        // 计算距离哪个档次最近\n        int result = new BigDecimal(ratio).setScale(0, BigDecimal.ROUND_HALF_UP).intValue();\n        if (result < 1) {\n            result = 1;\n        } else if (result > (LEVEL - 1)) {\n            result = (int) (LEVEL - 1);\n        }\n        return result;\n    }\n\n    /**\n     * 滑动接口\n     */\n    public interface OnProgressChangedListener {\n        void OnProgressChanged(int level);\n    }\n}\n```\n## 使用\n在代码中使用，非常简单，在布局文件中引用：\n```\n<com.lastwarmth.viewstudy.CustomArcSeekBar\n    android:id=\"@+id/seek_bar\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"100dp\"\n    android:layout_marginTop=\"40dp\"\n    android:background=\"@color/colorAccent\" />\n\n<TextView\n    android:id=\"@+id/seek_bar_progress\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:gravity=\"center\"\n    android:text=\"1\"\n    android:textSize=\"30sp\" />\n```\n代码中：\n```\nfinal TextView textView = (TextView) findViewById(R.id.seek_bar_progress);\nCustomArcSeekBar seekBar = (CustomArcSeekBar) findViewById(R.id.seek_bar);\nseekBar.setListener(new CustomArcSeekBar.OnProgressChangedListener() {\n    @Override\n    public void OnProgressChanged(int level) {\n        textView.setText(String.valueOf(level));\n    }\n});\n```\n最终效果：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbareffect.gif)\n算是达到我的预期。\n\n<font size=5>[源码链接](https://github.com/LiJia92/CustomArcSeekBar)</font>\n\n## 小结\n1. 自定义View在绘制矩形、圆等图形时，使用的坐标是要相对于View本身的，而不是相对于屏幕的坐标。\n2. 使用贝塞尔曲线能获得不错的曲线效果。\n3. Paint在画完1个东西之后记得reset，然后重新设置值，不然画笔的属性一样，得到的效果就不对。\n","source":"_posts/seekbar.md","raw":"---\ntitle: Android自定义View实现弧形SeekBar\ndate: 2016-04-27 13:53:19\ntags:\n - 自定义View\n---\n\n## 前言\n项目开发中有这样一个需求：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar4.png)\n通过滑动SeekBar来控制打赏金额，金额设置5个档次。\n\n看到设计稿的时候，除了自定义View想不到什么更好的方法了。自定义View一直是我的短板，内心总会有点抗拒，总感觉自己做不出来。最近一段时间，也是有意无意的练习自定义View。最后决定还是用自定义View来实现这次的需求。\n\n根据设计图，我分为3个步骤：\n1. 画弧线。\n2. 画圆球。\n3. 触摸事件的处理，并提供对外接口。\n\n<!-- more -->\n\n## 画弧线\n### 圆弧\n起初的想法是根据自定义View的宽高，创建一个正方形，然后画一个内切圆，截取其中的一段圆弧。大致就是这样的：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar1.png)\n假设这样的圆存在，那么对于View的宽高有一个要求:\n假定宽为a，高为b，x为半径。取一个直角三角形，勾股定理能得出这样的公式：\n```\n(a/2)*(a/2) + (x-b)*(x-b) = x*x;\n```\n化简得到:\n```\nx = b/2 + (a*a) / (8*b)\n```\n假设若成立，那么``x-b>0``,得到\n```\na > 2b\n```\n即对View的宽高有一个这样的硬性要求，才能符合预期。\n\n另外，后续还需要画圆球，圆球的圆心肯定是需要在弧线上的，那么我每次画圆球时，圆心的坐标都需要通过三角函数来获得，会显得比较麻烦。考虑再三便放弃这种做法了。\n\n### 抛物线\n晚上下班回家，跟室友讨论了一波这个问题，我室友当场来了个：``抛物线``。后面一想：卧槽？确实可以啊。直接确定3个点，就能确定抛物线的公式了，这样对于后续画圆球，求圆心的坐标也非常简单。于是打算第二天来做一波。\n\n第二天。\n\n网上一查，没查到android关于画抛物线的方法。我的内心：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar3.jpg)\n于是便也放弃了这种做法。\n\n### 贝塞尔\n网上查阅资料的时候，关于弧线说的最多的就是利用贝塞尔曲线。\n关于贝塞尔曲线的更多介绍可以参考[这篇文章](http://blog.csdn.net/androidzhaoxiaogang/article/details/8680330)。\n\n二阶贝塞尔曲线符合我的情况，于是选取的二阶贝塞尔曲线。\n贝塞尔曲线的关键代码如下：\n```\npath.moveTo(pointF1.x, pointF1.y);\npath.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);\ncanvas.drawPath(path, paint);\n```\npointF1是起始点，pointF2是控制点，pointF3是终止点。\n采用贝塞尔曲线实现的效果还不错，只是控制点是不在曲线上的，曲线无法与View的顶部相切，但也无伤大雅了。\n\n## 画圆球\n画圆球就比较简单了，计算出圆心坐标直接画圆即可。\n```\n// 二阶贝塞尔曲线公式计算坐标\nfloat t = (currentX / (right - left));\nfloat x = (1 - t) * (1 - t) * pointF1.x + 2 * (t) * (1 - t) * pointF2.x + t * t * pointF3.x;\nfloat y = (1 - t) * (1 - t) * pointF1.y + 2 * (t) * (1 - t) * pointF2.y + t * t * pointF3.y;\ncircleCenter.set(x, y);\npaint.reset();\npaint.setFlags(Paint.ANTI_ALIAS_FLAG);\npaint.setColor(Color.WHITE);\npaint.setStyle(Paint.Style.FILL);\ncanvas.drawCircle(x, y, RADIUS, paint);\n```\n二阶贝塞尔曲线的公式是这样的：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar2.png)\n我们把当前的横坐标currentX对于View宽度的比例作为t。\n\n## 触摸事件处理&对外接口\n触摸事件无非就是重写``onTouchEvent``，这里我只对横坐标做了处理，只要横着滑，就能滑动圆球了，并没有处理纵坐标。\n1. ACTION_DOWN：判断点下的坐标是否在圆球返回内（我设置了20的误差），若不在圆球内，则直接返回false，那么后续就不会接收ACTION_MOVE等其他事件了。若在则返回true，接收后续的ACTION_MOVE等事件。\n2. ACTION_MOVE：获取x坐标，然后设置currentX，重绘。对外的接口也是在这里调用。\n3. default：当手指移出或者离开View时，利用Scroller使圆球平滑滑到距离最近的档次。\n\n下面上完整代码：\n```\npublic class CustomArcSeekBar extends View {\n\n    private Scroller scroller;\n    private Paint paint;\n    private Path path;\n    private PointF pointF1; // 起始点\n    private PointF pointF2; // 控制点\n    private PointF pointF3; // 终止点\n    private PointF circleCenter; // 圆心的坐标\n    private int top;\n    private int right;\n    private int bottom;\n    private int left;\n    private float currentX; // 当前x坐标，用于控制圆球位置\n    private int currentLevel; // 当前档次\n    private OnProgressChangedListener listener;\n\n    private final static float RADIUS = 30f; // 圆球半径\n    private final static float LEVEL = 6f; // 设置档次\n\n    public CustomArcSeekBar(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public CustomArcSeekBar(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public CustomArcSeekBar(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    private void init(Context context) {\n        paint = new Paint();\n        path = new Path();\n        pointF1 = new PointF();\n        pointF2 = new PointF();\n        pointF3 = new PointF();\n        circleCenter = new PointF();\n        scroller = new Scroller(context);\n    }\n\n    @Override\n    public void computeScroll() {\n        if (scroller.computeScrollOffset()) {\n            currentX = scroller.getCurrX();\n            postInvalidate();\n        }\n    }\n\n    public void setListener(OnProgressChangedListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right, int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        this.left = left;\n        this.top = top;\n        this.right = right;\n        this.bottom = bottom;\n        pointF1.set(0, bottom - top);\n        pointF2.set((right - left) / 2, -(bottom - top) / 2);\n        pointF3.set(right, bottom - top);\n        currentX = (right - left) / LEVEL;\n        currentLevel = 1;\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n\n        // 画2阶贝塞尔曲线\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.GRAY);\n        paint.setStrokeWidth(10);\n        paint.setStyle(Paint.Style.STROKE);\n        path.moveTo(pointF1.x, pointF1.y);\n        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);\n        canvas.drawPath(path, paint);\n\n        // 通过x坐标，计算圆心的坐标，画圆\n        float t = (currentX / (right - left));\n        float x = (1 - t) * (1 - t) * pointF1.x + 2 * (t) * (1 - t) * pointF2.x + t * t * pointF3.x;\n        float y = (1 - t) * (1 - t) * pointF1.y + 2 * (t) * (1 - t) * pointF2.y + t * t * pointF3.y;\n        circleCenter.set(x, y);\n        paint.reset();\n        paint.setFlags(Paint.ANTI_ALIAS_FLAG);\n        paint.setColor(Color.WHITE);\n        paint.setStyle(Paint.Style.FILL);\n        canvas.drawCircle(x, y, RADIUS, paint);\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent event) {\n        switch (event.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                float downX = event.getX();\n                float downY = event.getY();\n                float distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);\n                // 计算到圆球中心的距离，考虑20的误差\n                return !(distance - (RADIUS + 20) * (RADIUS + 20) > 0);\n            case MotionEvent.ACTION_MOVE:\n                float moveX = event.getX();\n                currentX = moveX; // 通过x坐标重绘圆球\n                invalidate();\n                currentLevel = getLevel(moveX);\n                if (listener != null) {\n                    listener.OnProgressChanged(currentLevel);\n                }\n                break;\n            default:\n                // 当手指移出或者离开View时，圆球平滑滑到最近的档次\n                scroller.startScroll((int) currentX, 0, (int) ((right - left) / LEVEL * currentLevel - currentX), 0, 200);\n                postInvalidate();\n                break;\n        }\n        return super.onTouchEvent(event);\n    }\n\n    /**\n     * 计算档次\n     *\n     * @param x 横坐标\n     * @return 档次\n     */\n    private int getLevel(float x) {\n        float ratio = (x / (right - left)) * LEVEL;\n        // 计算距离哪个档次最近\n        int result = new BigDecimal(ratio).setScale(0, BigDecimal.ROUND_HALF_UP).intValue();\n        if (result < 1) {\n            result = 1;\n        } else if (result > (LEVEL - 1)) {\n            result = (int) (LEVEL - 1);\n        }\n        return result;\n    }\n\n    /**\n     * 滑动接口\n     */\n    public interface OnProgressChangedListener {\n        void OnProgressChanged(int level);\n    }\n}\n```\n## 使用\n在代码中使用，非常简单，在布局文件中引用：\n```\n<com.lastwarmth.viewstudy.CustomArcSeekBar\n    android:id=\"@+id/seek_bar\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"100dp\"\n    android:layout_marginTop=\"40dp\"\n    android:background=\"@color/colorAccent\" />\n\n<TextView\n    android:id=\"@+id/seek_bar_progress\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:gravity=\"center\"\n    android:text=\"1\"\n    android:textSize=\"30sp\" />\n```\n代码中：\n```\nfinal TextView textView = (TextView) findViewById(R.id.seek_bar_progress);\nCustomArcSeekBar seekBar = (CustomArcSeekBar) findViewById(R.id.seek_bar);\nseekBar.setListener(new CustomArcSeekBar.OnProgressChangedListener() {\n    @Override\n    public void OnProgressChanged(int level) {\n        textView.setText(String.valueOf(level));\n    }\n});\n```\n最终效果：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbareffect.gif)\n算是达到我的预期。\n\n<font size=5>[源码链接](https://github.com/LiJia92/CustomArcSeekBar)</font>\n\n## 小结\n1. 自定义View在绘制矩形、圆等图形时，使用的坐标是要相对于View本身的，而不是相对于屏幕的坐标。\n2. 使用贝塞尔曲线能获得不错的曲线效果。\n3. Paint在画完1个东西之后记得reset，然后重新设置值，不然画笔的属性一样，得到的效果就不对。\n","slug":"seekbar","published":1,"updated":"2016-11-21T10:02:55.908Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75a2002m1cb89pcwccm3","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>项目开发中有这样一个需求：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar4.png\" alt=\"\"><br>通过滑动SeekBar来控制打赏金额，金额设置5个档次。</p>\n<p>看到设计稿的时候，除了自定义View想不到什么更好的方法了。自定义View一直是我的短板，内心总会有点抗拒，总感觉自己做不出来。最近一段时间，也是有意无意的练习自定义View。最后决定还是用自定义View来实现这次的需求。</p>\n<p>根据设计图，我分为3个步骤：</p>\n<ol>\n<li>画弧线。</li>\n<li>画圆球。</li>\n<li>触摸事件的处理，并提供对外接口。</li>\n</ol>\n<a id=\"more\"></a>\n<h2 id=\"画弧线\"><a href=\"#画弧线\" class=\"headerlink\" title=\"画弧线\"></a>画弧线</h2><h3 id=\"圆弧\"><a href=\"#圆弧\" class=\"headerlink\" title=\"圆弧\"></a>圆弧</h3><p>起初的想法是根据自定义View的宽高，创建一个正方形，然后画一个内切圆，截取其中的一段圆弧。大致就是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar1.png\" alt=\"\"><br>假设这样的圆存在，那么对于View的宽高有一个要求:<br>假定宽为a，高为b，x为半径。取一个直角三角形，勾股定理能得出这样的公式：<br><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">(<span class=\"name\">a/2</span>)*(<span class=\"name\">a/2</span>) + (<span class=\"name\">x-b</span>)*(<span class=\"name\">x-b</span>) = x*x<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>化简得到:<br><figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">x = b/<span class=\"number\">2</span> + <span class=\"comment\">(a*a)</span> / <span class=\"comment\">(8*b)</span></div></pre></td></tr></table></figure></p>\n<p>假设若成立，那么<code>x-b&gt;0</code>,得到<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">a</span> &gt; <span class=\"number\">2</span>b</div></pre></td></tr></table></figure></p>\n<p>即对View的宽高有一个这样的硬性要求，才能符合预期。</p>\n<p>另外，后续还需要画圆球，圆球的圆心肯定是需要在弧线上的，那么我每次画圆球时，圆心的坐标都需要通过三角函数来获得，会显得比较麻烦。考虑再三便放弃这种做法了。</p>\n<h3 id=\"抛物线\"><a href=\"#抛物线\" class=\"headerlink\" title=\"抛物线\"></a>抛物线</h3><p>晚上下班回家，跟室友讨论了一波这个问题，我室友当场来了个：<code>抛物线</code>。后面一想：卧槽？确实可以啊。直接确定3个点，就能确定抛物线的公式了，这样对于后续画圆球，求圆心的坐标也非常简单。于是打算第二天来做一波。</p>\n<p>第二天。</p>\n<p>网上一查，没查到android关于画抛物线的方法。我的内心：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar3.jpg\" alt=\"\"><br>于是便也放弃了这种做法。</p>\n<h3 id=\"贝塞尔\"><a href=\"#贝塞尔\" class=\"headerlink\" title=\"贝塞尔\"></a>贝塞尔</h3><p>网上查阅资料的时候，关于弧线说的最多的就是利用贝塞尔曲线。<br>关于贝塞尔曲线的更多介绍可以参考<a href=\"http://blog.csdn.net/androidzhaoxiaogang/article/details/8680330\" target=\"_blank\" rel=\"external\">这篇文章</a>。</p>\n<p>二阶贝塞尔曲线符合我的情况，于是选取的二阶贝塞尔曲线。<br>贝塞尔曲线的关键代码如下：<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">path</span><span class=\"selector-class\">.moveTo</span>(<span class=\"selector-tag\">pointF1</span><span class=\"selector-class\">.x</span>, <span class=\"selector-tag\">pointF1</span><span class=\"selector-class\">.y</span>);</div><div class=\"line\"><span class=\"selector-tag\">path</span><span class=\"selector-class\">.quadTo</span>(<span class=\"selector-tag\">pointF2</span><span class=\"selector-class\">.x</span>, <span class=\"selector-tag\">pointF2</span><span class=\"selector-class\">.y</span>, <span class=\"selector-tag\">pointF3</span><span class=\"selector-class\">.x</span>, <span class=\"selector-tag\">pointF3</span><span class=\"selector-class\">.y</span>);</div><div class=\"line\"><span class=\"selector-tag\">canvas</span><span class=\"selector-class\">.drawPath</span>(<span class=\"selector-tag\">path</span>, <span class=\"selector-tag\">paint</span>);</div></pre></td></tr></table></figure></p>\n<p>pointF1是起始点，pointF2是控制点，pointF3是终止点。<br>采用贝塞尔曲线实现的效果还不错，只是控制点是不在曲线上的，曲线无法与View的顶部相切，但也无伤大雅了。</p>\n<h2 id=\"画圆球\"><a href=\"#画圆球\" class=\"headerlink\" title=\"画圆球\"></a>画圆球</h2><p>画圆球就比较简单了，计算出圆心坐标直接画圆即可。<br><figure class=\"highlight excel\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">// 二阶贝塞尔曲线公式计算坐标</div><div class=\"line\">float <span class=\"built_in\">t</span> = (currentX / (<span class=\"built_in\">right</span> - <span class=\"built_in\">left</span>));</div><div class=\"line\">float x = (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * pointF1.x + <span class=\"number\">2</span> * (<span class=\"built_in\">t</span>) * (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * pointF2.x + <span class=\"built_in\">t</span> * <span class=\"built_in\">t</span> * pointF3.x;</div><div class=\"line\">float y = (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * pointF1.y + <span class=\"number\">2</span> * (<span class=\"built_in\">t</span>) * (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * pointF2.y + <span class=\"built_in\">t</span> * <span class=\"built_in\">t</span> * pointF3.y;</div><div class=\"line\">circleCenter.set(x, y);</div><div class=\"line\">paint.reset();</div><div class=\"line\">paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">paint.setColor(Color.WHITE);</div><div class=\"line\">paint.setStyle(Paint.Style.FILL);</div><div class=\"line\">canvas.drawCircle(x, y, RADIUS, paint);</div></pre></td></tr></table></figure></p>\n<p>二阶贝塞尔曲线的公式是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar2.png\" alt=\"\"><br>我们把当前的横坐标currentX对于View宽度的比例作为t。</p>\n<h2 id=\"触摸事件处理-amp-对外接口\"><a href=\"#触摸事件处理-amp-对外接口\" class=\"headerlink\" title=\"触摸事件处理&amp;对外接口\"></a>触摸事件处理&amp;对外接口</h2><p>触摸事件无非就是重写<code>onTouchEvent</code>，这里我只对横坐标做了处理，只要横着滑，就能滑动圆球了，并没有处理纵坐标。</p>\n<ol>\n<li>ACTION_DOWN：判断点下的坐标是否在圆球返回内（我设置了20的误差），若不在圆球内，则直接返回false，那么后续就不会接收ACTION_MOVE等其他事件了。若在则返回true，接收后续的ACTION_MOVE等事件。</li>\n<li>ACTION_MOVE：获取x坐标，然后设置currentX，重绘。对外的接口也是在这里调用。</li>\n<li>default：当手指移出或者离开View时，利用Scroller使圆球平滑滑到距离最近的档次。</li>\n</ol>\n<p>下面上完整代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomArcSeekBar</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller scroller;</div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Path path;</div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1; <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2; <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3; <span class=\"comment\">// 终止点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF circleCenter; <span class=\"comment\">// 圆心的坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> top;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> right;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> bottom;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> left;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> currentX; <span class=\"comment\">// 当前x坐标，用于控制圆球位置</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> currentLevel; <span class=\"comment\">// 当前档次</span></div><div class=\"line\">    <span class=\"keyword\">private</span> OnProgressChangedListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">float</span> RADIUS = <span class=\"number\">30</span>f; <span class=\"comment\">// 圆球半径</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">float</span> LEVEL = <span class=\"number\">6</span>f; <span class=\"comment\">// 设置档次</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomArcSeekBar</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomArcSeekBar</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomArcSeekBar</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        path = <span class=\"keyword\">new</span> Path();</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        circleCenter = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        scroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scroller.computeScrollOffset()) &#123;</div><div class=\"line\">            currentX = scroller.getCurrX();</div><div class=\"line\">            postInvalidate();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnProgressChangedListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        <span class=\"keyword\">this</span>.left = left;</div><div class=\"line\">        <span class=\"keyword\">this</span>.top = top;</div><div class=\"line\">        <span class=\"keyword\">this</span>.right = right;</div><div class=\"line\">        <span class=\"keyword\">this</span>.bottom = bottom;</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">2</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top);</div><div class=\"line\">        currentX = (right - left) / LEVEL;</div><div class=\"line\">        currentLevel = <span class=\"number\">1</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画2阶贝塞尔曲线</span></div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.GRAY);</div><div class=\"line\">        paint.setStrokeWidth(<span class=\"number\">10</span>);</div><div class=\"line\">        paint.setStyle(Paint.Style.STROKE);</div><div class=\"line\">        path.moveTo(pointF1.x, pointF1.y);</div><div class=\"line\">        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);</div><div class=\"line\">        canvas.drawPath(path, paint);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 通过x坐标，计算圆心的坐标，画圆</span></div><div class=\"line\">        <span class=\"keyword\">float</span> t = (currentX / (right - left));</div><div class=\"line\">        <span class=\"keyword\">float</span> x = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.x + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.x + t * t * pointF3.x;</div><div class=\"line\">        <span class=\"keyword\">float</span> y = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.y + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.y + t * t * pointF3.y;</div><div class=\"line\">        circleCenter.set(x, y);</div><div class=\"line\">        paint.reset();</div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.WHITE);</div><div class=\"line\">        paint.setStyle(Paint.Style.FILL);</div><div class=\"line\">        canvas.drawCircle(x, y, RADIUS, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (event.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                <span class=\"keyword\">float</span> downX = event.getX();</div><div class=\"line\">                <span class=\"keyword\">float</span> downY = event.getY();</div><div class=\"line\">                <span class=\"keyword\">float</span> distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);</div><div class=\"line\">                <span class=\"comment\">// 计算到圆球中心的距离，考虑20的误差</span></div><div class=\"line\">                <span class=\"keyword\">return</span> !(distance - (RADIUS + <span class=\"number\">20</span>) * (RADIUS + <span class=\"number\">20</span>) &gt; <span class=\"number\">0</span>);</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = event.getX();</div><div class=\"line\">                currentX = moveX; <span class=\"comment\">// 通过x坐标重绘圆球</span></div><div class=\"line\">                invalidate();</div><div class=\"line\">                currentLevel = getLevel(moveX);</div><div class=\"line\">                <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    listener.OnProgressChanged(currentLevel);</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">default</span>:</div><div class=\"line\">                // 当手指移出或者离开View时，圆球平滑滑到最近的档次</div><div class=\"line\">                scroller.startScroll((<span class=\"keyword\">int</span>) currentX, 0, (<span class=\"keyword\">int</span>) ((right - left) / LEVEL * currentLevel - currentX), 0, 200);</div><div class=\"line\">                postInvalidate();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 计算档次</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> x 横坐标</div><div class=\"line\">     * <span class=\"doctag\">@return</span> 档次</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getLevel</span><span class=\"params\">(<span class=\"keyword\">float</span> x)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> ratio = (x / (right - left)) * LEVEL;</div><div class=\"line\">        <span class=\"comment\">// 计算距离哪个档次最近</span></div><div class=\"line\">        <span class=\"keyword\">int</span> result = <span class=\"keyword\">new</span> BigDecimal(ratio).setScale(<span class=\"number\">0</span>, BigDecimal.ROUND_HALF_UP).intValue();</div><div class=\"line\">        <span class=\"keyword\">if</span> (result &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\">            result = <span class=\"number\">1</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (result &gt; (LEVEL - <span class=\"number\">1</span>)) &#123;</div><div class=\"line\">            result = (<span class=\"keyword\">int</span>) (LEVEL - <span class=\"number\">1</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> result;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 滑动接口</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnProgressChangedListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>在代码中使用，非常简单，在布局文件中引用：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;com<span class=\"selector-class\">.lastwarmth</span><span class=\"selector-class\">.viewstudy</span><span class=\"selector-class\">.CustomArcSeekBar</span></div><div class=\"line\">    android:id=<span class=\"string\">\"@+id/seek_bar\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"100dp\"</span></div><div class=\"line\">    android:layout_marginTop=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">    android:<span class=\"attribute\">background</span>=<span class=\"string\">\"@color/colorAccent\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;TextView</div><div class=\"line\">    android:id=<span class=\"string\">\"@+id/seek_bar_progress\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:gravity=<span class=\"string\">\"center\"</span></div><div class=\"line\">    android:text=<span class=\"string\">\"1\"</span></div><div class=\"line\">    android:textSize=<span class=\"string\">\"30sp\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>代码中：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">final</span> TextView textView = (TextView) findViewById(R.id.seek_bar_progress);</div><div class=\"line\">CustomArcSeekBar seekBar = (CustomArcSeekBar) findViewById(R.id.seek_bar);</div><div class=\"line\">seekBar.setListener(<span class=\"keyword\">new</span> CustomArcSeekBar.OnProgressChangedListener() &#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span> </span>&#123;</div><div class=\"line\">        textView.setText(String.valueOf(level));</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>最终效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbareffect.gif\" alt=\"\"><br>算是达到我的预期。</p>\n<font size=\"5\"><a href=\"https://github.com/LiJia92/CustomArcSeekBar\" target=\"_blank\" rel=\"external\">源码链接</a></font>\n\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ol>\n<li>自定义View在绘制矩形、圆等图形时，使用的坐标是要相对于View本身的，而不是相对于屏幕的坐标。</li>\n<li>使用贝塞尔曲线能获得不错的曲线效果。</li>\n<li>Paint在画完1个东西之后记得reset，然后重新设置值，不然画笔的属性一样，得到的效果就不对。</li>\n</ol>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>项目开发中有这样一个需求：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar4.png\" alt=\"\"><br>通过滑动SeekBar来控制打赏金额，金额设置5个档次。</p>\n<p>看到设计稿的时候，除了自定义View想不到什么更好的方法了。自定义View一直是我的短板，内心总会有点抗拒，总感觉自己做不出来。最近一段时间，也是有意无意的练习自定义View。最后决定还是用自定义View来实现这次的需求。</p>\n<p>根据设计图，我分为3个步骤：</p>\n<ol>\n<li>画弧线。</li>\n<li>画圆球。</li>\n<li>触摸事件的处理，并提供对外接口。</li>\n</ol>","more":"<h2 id=\"画弧线\"><a href=\"#画弧线\" class=\"headerlink\" title=\"画弧线\"></a>画弧线</h2><h3 id=\"圆弧\"><a href=\"#圆弧\" class=\"headerlink\" title=\"圆弧\"></a>圆弧</h3><p>起初的想法是根据自定义View的宽高，创建一个正方形，然后画一个内切圆，截取其中的一段圆弧。大致就是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar1.png\" alt=\"\"><br>假设这样的圆存在，那么对于View的宽高有一个要求:<br>假定宽为a，高为b，x为半径。取一个直角三角形，勾股定理能得出这样的公式：<br><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">(<span class=\"name\">a/2</span>)*(<span class=\"name\">a/2</span>) + (<span class=\"name\">x-b</span>)*(<span class=\"name\">x-b</span>) = x*x<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>化简得到:<br><figure class=\"highlight gcode\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">x = b/<span class=\"number\">2</span> + <span class=\"comment\">(a*a)</span> / <span class=\"comment\">(8*b)</span></div></pre></td></tr></table></figure></p>\n<p>假设若成立，那么<code>x-b&gt;0</code>,得到<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">a</span> &gt; <span class=\"number\">2</span>b</div></pre></td></tr></table></figure></p>\n<p>即对View的宽高有一个这样的硬性要求，才能符合预期。</p>\n<p>另外，后续还需要画圆球，圆球的圆心肯定是需要在弧线上的，那么我每次画圆球时，圆心的坐标都需要通过三角函数来获得，会显得比较麻烦。考虑再三便放弃这种做法了。</p>\n<h3 id=\"抛物线\"><a href=\"#抛物线\" class=\"headerlink\" title=\"抛物线\"></a>抛物线</h3><p>晚上下班回家，跟室友讨论了一波这个问题，我室友当场来了个：<code>抛物线</code>。后面一想：卧槽？确实可以啊。直接确定3个点，就能确定抛物线的公式了，这样对于后续画圆球，求圆心的坐标也非常简单。于是打算第二天来做一波。</p>\n<p>第二天。</p>\n<p>网上一查，没查到android关于画抛物线的方法。我的内心：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar3.jpg\" alt=\"\"><br>于是便也放弃了这种做法。</p>\n<h3 id=\"贝塞尔\"><a href=\"#贝塞尔\" class=\"headerlink\" title=\"贝塞尔\"></a>贝塞尔</h3><p>网上查阅资料的时候，关于弧线说的最多的就是利用贝塞尔曲线。<br>关于贝塞尔曲线的更多介绍可以参考<a href=\"http://blog.csdn.net/androidzhaoxiaogang/article/details/8680330\">这篇文章</a>。</p>\n<p>二阶贝塞尔曲线符合我的情况，于是选取的二阶贝塞尔曲线。<br>贝塞尔曲线的关键代码如下：<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">path</span><span class=\"selector-class\">.moveTo</span>(<span class=\"selector-tag\">pointF1</span><span class=\"selector-class\">.x</span>, <span class=\"selector-tag\">pointF1</span><span class=\"selector-class\">.y</span>);</div><div class=\"line\"><span class=\"selector-tag\">path</span><span class=\"selector-class\">.quadTo</span>(<span class=\"selector-tag\">pointF2</span><span class=\"selector-class\">.x</span>, <span class=\"selector-tag\">pointF2</span><span class=\"selector-class\">.y</span>, <span class=\"selector-tag\">pointF3</span><span class=\"selector-class\">.x</span>, <span class=\"selector-tag\">pointF3</span><span class=\"selector-class\">.y</span>);</div><div class=\"line\"><span class=\"selector-tag\">canvas</span><span class=\"selector-class\">.drawPath</span>(<span class=\"selector-tag\">path</span>, <span class=\"selector-tag\">paint</span>);</div></pre></td></tr></table></figure></p>\n<p>pointF1是起始点，pointF2是控制点，pointF3是终止点。<br>采用贝塞尔曲线实现的效果还不错，只是控制点是不在曲线上的，曲线无法与View的顶部相切，但也无伤大雅了。</p>\n<h2 id=\"画圆球\"><a href=\"#画圆球\" class=\"headerlink\" title=\"画圆球\"></a>画圆球</h2><p>画圆球就比较简单了，计算出圆心坐标直接画圆即可。<br><figure class=\"highlight excel\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">// 二阶贝塞尔曲线公式计算坐标</div><div class=\"line\">float <span class=\"built_in\">t</span> = (currentX / (<span class=\"built_in\">right</span> - <span class=\"built_in\">left</span>));</div><div class=\"line\">float x = (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * pointF1.x + <span class=\"number\">2</span> * (<span class=\"built_in\">t</span>) * (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * pointF2.x + <span class=\"built_in\">t</span> * <span class=\"built_in\">t</span> * pointF3.x;</div><div class=\"line\">float y = (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * pointF1.y + <span class=\"number\">2</span> * (<span class=\"built_in\">t</span>) * (<span class=\"number\">1</span> - <span class=\"built_in\">t</span>) * pointF2.y + <span class=\"built_in\">t</span> * <span class=\"built_in\">t</span> * pointF3.y;</div><div class=\"line\">circleCenter.set(x, y);</div><div class=\"line\">paint.reset();</div><div class=\"line\">paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">paint.setColor(Color.WHITE);</div><div class=\"line\">paint.setStyle(Paint.Style.FILL);</div><div class=\"line\">canvas.drawCircle(x, y, RADIUS, paint);</div></pre></td></tr></table></figure></p>\n<p>二阶贝塞尔曲线的公式是这样的：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbar2.png\" alt=\"\"><br>我们把当前的横坐标currentX对于View宽度的比例作为t。</p>\n<h2 id=\"触摸事件处理-amp-对外接口\"><a href=\"#触摸事件处理-amp-对外接口\" class=\"headerlink\" title=\"触摸事件处理&amp;对外接口\"></a>触摸事件处理&amp;对外接口</h2><p>触摸事件无非就是重写<code>onTouchEvent</code>，这里我只对横坐标做了处理，只要横着滑，就能滑动圆球了，并没有处理纵坐标。</p>\n<ol>\n<li>ACTION_DOWN：判断点下的坐标是否在圆球返回内（我设置了20的误差），若不在圆球内，则直接返回false，那么后续就不会接收ACTION_MOVE等其他事件了。若在则返回true，接收后续的ACTION_MOVE等事件。</li>\n<li>ACTION_MOVE：获取x坐标，然后设置currentX，重绘。对外的接口也是在这里调用。</li>\n<li>default：当手指移出或者离开View时，利用Scroller使圆球平滑滑到距离最近的档次。</li>\n</ol>\n<p>下面上完整代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomArcSeekBar</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller scroller;</div><div class=\"line\">    <span class=\"keyword\">private</span> Paint paint;</div><div class=\"line\">    <span class=\"keyword\">private</span> Path path;</div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF1; <span class=\"comment\">// 起始点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF2; <span class=\"comment\">// 控制点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF pointF3; <span class=\"comment\">// 终止点</span></div><div class=\"line\">    <span class=\"keyword\">private</span> PointF circleCenter; <span class=\"comment\">// 圆心的坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> top;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> right;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> bottom;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> left;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> currentX; <span class=\"comment\">// 当前x坐标，用于控制圆球位置</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> currentLevel; <span class=\"comment\">// 当前档次</span></div><div class=\"line\">    <span class=\"keyword\">private</span> OnProgressChangedListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">float</span> RADIUS = <span class=\"number\">30</span>f; <span class=\"comment\">// 圆球半径</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">float</span> LEVEL = <span class=\"number\">6</span>f; <span class=\"comment\">// 设置档次</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomArcSeekBar</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomArcSeekBar</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomArcSeekBar</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        paint = <span class=\"keyword\">new</span> Paint();</div><div class=\"line\">        path = <span class=\"keyword\">new</span> Path();</div><div class=\"line\">        pointF1 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF2 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        pointF3 = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        circleCenter = <span class=\"keyword\">new</span> PointF();</div><div class=\"line\">        scroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (scroller.computeScrollOffset()) &#123;</div><div class=\"line\">            currentX = scroller.getCurrX();</div><div class=\"line\">            postInvalidate();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(OnProgressChangedListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right, <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        <span class=\"keyword\">this</span>.left = left;</div><div class=\"line\">        <span class=\"keyword\">this</span>.top = top;</div><div class=\"line\">        <span class=\"keyword\">this</span>.right = right;</div><div class=\"line\">        <span class=\"keyword\">this</span>.bottom = bottom;</div><div class=\"line\">        pointF1.set(<span class=\"number\">0</span>, bottom - top);</div><div class=\"line\">        pointF2.set((right - left) / <span class=\"number\">2</span>, -(bottom - top) / <span class=\"number\">2</span>);</div><div class=\"line\">        pointF3.set(right, bottom - top);</div><div class=\"line\">        currentX = (right - left) / LEVEL;</div><div class=\"line\">        currentLevel = <span class=\"number\">1</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 画2阶贝塞尔曲线</span></div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.GRAY);</div><div class=\"line\">        paint.setStrokeWidth(<span class=\"number\">10</span>);</div><div class=\"line\">        paint.setStyle(Paint.Style.STROKE);</div><div class=\"line\">        path.moveTo(pointF1.x, pointF1.y);</div><div class=\"line\">        path.quadTo(pointF2.x, pointF2.y, pointF3.x, pointF3.y);</div><div class=\"line\">        canvas.drawPath(path, paint);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 通过x坐标，计算圆心的坐标，画圆</span></div><div class=\"line\">        <span class=\"keyword\">float</span> t = (currentX / (right - left));</div><div class=\"line\">        <span class=\"keyword\">float</span> x = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.x + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.x + t * t * pointF3.x;</div><div class=\"line\">        <span class=\"keyword\">float</span> y = (<span class=\"number\">1</span> - t) * (<span class=\"number\">1</span> - t) * pointF1.y + <span class=\"number\">2</span> * (t) * (<span class=\"number\">1</span> - t) * pointF2.y + t * t * pointF3.y;</div><div class=\"line\">        circleCenter.set(x, y);</div><div class=\"line\">        paint.reset();</div><div class=\"line\">        paint.setFlags(Paint.ANTI_ALIAS_FLAG);</div><div class=\"line\">        paint.setColor(Color.WHITE);</div><div class=\"line\">        paint.setStyle(Paint.Style.FILL);</div><div class=\"line\">        canvas.drawCircle(x, y, RADIUS, paint);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (event.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                <span class=\"keyword\">float</span> downX = event.getX();</div><div class=\"line\">                <span class=\"keyword\">float</span> downY = event.getY();</div><div class=\"line\">                <span class=\"keyword\">float</span> distance = (downX - circleCenter.x) * (downX - circleCenter.x) + (downY - circleCenter.y) * (downY - circleCenter.y);</div><div class=\"line\">                <span class=\"comment\">// 计算到圆球中心的距离，考虑20的误差</span></div><div class=\"line\">                <span class=\"keyword\">return</span> !(distance - (RADIUS + <span class=\"number\">20</span>) * (RADIUS + <span class=\"number\">20</span>) &gt; <span class=\"number\">0</span>);</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = event.getX();</div><div class=\"line\">                currentX = moveX; <span class=\"comment\">// 通过x坐标重绘圆球</span></div><div class=\"line\">                invalidate();</div><div class=\"line\">                currentLevel = getLevel(moveX);</div><div class=\"line\">                <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    listener.OnProgressChanged(currentLevel);</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">default</span>:</div><div class=\"line\">                // 当手指移出或者离开View时，圆球平滑滑到最近的档次</div><div class=\"line\">                scroller.startScroll((<span class=\"keyword\">int</span>) currentX, 0, (<span class=\"keyword\">int</span>) ((right - left) / LEVEL * currentLevel - currentX), 0, 200);</div><div class=\"line\">                postInvalidate();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 计算档次</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> x 横坐标</div><div class=\"line\">     * <span class=\"doctag\">@return</span> 档次</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getLevel</span><span class=\"params\">(<span class=\"keyword\">float</span> x)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">float</span> ratio = (x / (right - left)) * LEVEL;</div><div class=\"line\">        <span class=\"comment\">// 计算距离哪个档次最近</span></div><div class=\"line\">        <span class=\"keyword\">int</span> result = <span class=\"keyword\">new</span> BigDecimal(ratio).setScale(<span class=\"number\">0</span>, BigDecimal.ROUND_HALF_UP).intValue();</div><div class=\"line\">        <span class=\"keyword\">if</span> (result &lt; <span class=\"number\">1</span>) &#123;</div><div class=\"line\">            result = <span class=\"number\">1</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (result &gt; (LEVEL - <span class=\"number\">1</span>)) &#123;</div><div class=\"line\">            result = (<span class=\"keyword\">int</span>) (LEVEL - <span class=\"number\">1</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> result;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 滑动接口</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnProgressChangedListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>在代码中使用，非常简单，在布局文件中引用：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;com<span class=\"selector-class\">.lastwarmth</span><span class=\"selector-class\">.viewstudy</span><span class=\"selector-class\">.CustomArcSeekBar</span></div><div class=\"line\">    android:id=<span class=\"string\">\"@+id/seek_bar\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"100dp\"</span></div><div class=\"line\">    android:layout_marginTop=<span class=\"string\">\"40dp\"</span></div><div class=\"line\">    android:<span class=\"attribute\">background</span>=<span class=\"string\">\"@color/colorAccent\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;TextView</div><div class=\"line\">    android:id=<span class=\"string\">\"@+id/seek_bar_progress\"</span></div><div class=\"line\">    android:layout_width=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:layout_height=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    android:gravity=<span class=\"string\">\"center\"</span></div><div class=\"line\">    android:text=<span class=\"string\">\"1\"</span></div><div class=\"line\">    android:textSize=<span class=\"string\">\"30sp\"</span> /&gt;</div></pre></td></tr></table></figure></p>\n<p>代码中：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">final</span> TextView textView = (TextView) findViewById(R.id.seek_bar_progress);</div><div class=\"line\">CustomArcSeekBar seekBar = (CustomArcSeekBar) findViewById(R.id.seek_bar);</div><div class=\"line\">seekBar.setListener(<span class=\"keyword\">new</span> CustomArcSeekBar.OnProgressChangedListener() &#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnProgressChanged</span><span class=\"params\">(<span class=\"keyword\">int</span> level)</span> </span>&#123;</div><div class=\"line\">        textView.setText(String.valueOf(level));</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>最终效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/seekbareffect.gif\" alt=\"\"><br>算是达到我的预期。</p>\n<font size=5><a href=\"https://github.com/LiJia92/CustomArcSeekBar\">源码链接</a></font>\n\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ol>\n<li>自定义View在绘制矩形、圆等图形时，使用的坐标是要相对于View本身的，而不是相对于屏幕的坐标。</li>\n<li>使用贝塞尔曲线能获得不错的曲线效果。</li>\n<li>Paint在画完1个东西之后记得reset，然后重新设置值，不然画笔的属性一样，得到的效果就不对。</li>\n</ol>"},{"title":"Android仿美团下拉刷新","date":"2016-04-18T08:07:15.000Z","_content":"\n在之前看过一篇文章[Android自定义控件之仿美团下拉刷新](http://blog.csdn.net/nugongahou110/article/details/49557875)，就是实现仿美团下拉刷新。一直对ListView等控件的下拉刷新的了解程度，可能也就停留在``用HeaderView来实现，然后重写onTouchEvent``，但是具体应该是怎样的呢？一直没有实际动手自己写过，于是抽空自己照着这篇博客自己写了一遍，以加深自己的理解。我对原博客进行摘录，重点写出一些对自己帮助大的内容。\n\n## 刷新状态\n一般下拉刷新应该都是会有三种状态：下拉刷新、松开刷新、正在刷新。\n### 下拉刷新\n实现思路：自定义View，通过设置进度值进行缩放。\n用SeekBar来模仿一下下拉距离的进度。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview3.gif)\n\n<!-- more -->\n\n自定义View代码：\n```\npublic class RefreshFirstView extends View {\n\n    private Bitmap firstBitmap;\n    private Bitmap endBitmap;\n    private float mCurrentProgress;\n    private int measuredWidth;\n    private int measuredHeight;\n    private Bitmap scaledBitmap;\n\n    public RefreshFirstView(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public RefreshFirstView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public RefreshFirstView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    private void init(Context context) {\n        firstBitmap = Bitmap.createBitmap(BitmapFactory.decodeResource(context.getResources(), R.drawable.pull_image));\n        endBitmap = Bitmap.createBitmap(BitmapFactory.decodeResource(getResources(), R.drawable.pull_end_image_frame_05));\n    }\n\n    @Override\n    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n        setMeasuredDimension(measureWidth(widthMeasureSpec), measureWidth(widthMeasureSpec) * endBitmap.getHeight() / endBitmap.getWidth());\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right,\n                            int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        measuredWidth = getMeasuredWidth();\n        measuredHeight = getMeasuredHeight();\n        //根据第二阶段娃娃宽高  给椭圆形图片进行等比例的缩放\n        scaledBitmap = Bitmap.createScaledBitmap(firstBitmap, measuredWidth, measuredWidth * firstBitmap.getHeight() / firstBitmap.getWidth(), true);\n    }\n\n    private int measureWidth(int widMeasureSpec) {\n        int result;\n        int size = MeasureSpec.getSize(widMeasureSpec);\n        int mode = MeasureSpec.getMode(widMeasureSpec);\n        if (mode == MeasureSpec.EXACTLY) {\n            result = size;\n        } else {\n            result = endBitmap.getWidth();\n            if (mode == MeasureSpec.AT_MOST) {\n                result = Math.min(result, size);\n            }\n        }\n        return result;\n    }\n\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n        // 通过画布缩放，控制View缩放\n        canvas.scale(mCurrentProgress, mCurrentProgress, measuredWidth / 2, measuredHeight / 2);\n        canvas.drawBitmap(scaledBitmap, 0, measuredHeight / 4, null);\n    }\n\n    public void setCurrentProgress(float currentProgress) {\n        this.mCurrentProgress = currentProgress;\n    }\n\n}\n```\n### 松开刷新\n这里主要是一个帧动画。\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<animation-list xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:oneshot=\"true\">\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_01\"\n        android:duration=\"100\" />\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_02\"\n        android:duration=\"100\" />\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_03\"\n        android:duration=\"100\" />\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_04\"\n        android:duration=\"100\" />\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_05\"\n        android:duration=\"100\" />\n</animation-list>\n```\n### 正在刷新\n与松开刷新一样，也是一个帧动画，这里便不做赘述。\n\n三种状态通过自定义View，重写onMeasure来确保三个状态的View的宽高保持一致。\n\n## 下拉刷新的实现\n先贴一下原博客的代码：\n```\npublic class MeiTuanListView extends ListView implements AbsListView.OnScrollListener{\n    private static final int DONE = 0;\n    private static final int PULL_TO_REFRESH = 1;\n    private static final int RELEASE_TO_REFRESH = 2;\n    private static final int REFRESHING = 3;\n    private static final int RATIO = 3;\n    private LinearLayout headerView;\n    private int headerViewHeight;\n    private float startY;\n    private float offsetY;\n    private TextView tv_pull_to_refresh;\n    private OnMeiTuanRefreshListener mOnRefreshListener;\n    private int state;\n    private int mFirstVisibleItem;\n    private boolean isRecord;\n    private boolean isEnd;\n    private boolean isRefreable;\n    private FrameLayout mAnimContainer;\n    private Animation animation;\n    private SimpleDateFormat format;\n    private MeiTuanRefreshFirstStepView mFirstView;\n    private MeiTuanRefreshSecondStepView mSecondView;\n    private AnimationDrawable secondAnim;\n    private MeiTuanRefreshThirdStepView mThirdView;\n    private AnimationDrawable thirdAnim;\n\n    public MeiTuanListView(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public MeiTuanListView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public MeiTuanListView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    public interface OnMeiTuanRefreshListener{\n        void onRefresh();\n    }\n\n    /**\n     * 回调接口，想实现下拉刷新的listview实现此接口\n     * @param onRefreshListener\n     */\n    public void setOnMeiTuanRefreshListener(OnMeiTuanRefreshListener onRefreshListener){\n        mOnRefreshListener = onRefreshListener;\n        isRefreable = true;\n    }\n\n    /**\n     * 刷新完毕，从主线程发送过来，并且改变headerView的状态和文字动画信息\n     */\n    public void setOnRefreshComplete(){\n        //一定要将isEnd设置为true，以便于下次的下拉刷新\n        isEnd = true;\n        state = DONE;\n\n        changeHeaderByState(state);\n    }\n\n    private void init(Context context) {\n        setOverScrollMode(View.OVER_SCROLL_NEVER);\n        setOnScrollListener(this);\n\n        headerView = (LinearLayout) LayoutInflater.from(context).inflate(R.layout.meituan_item, null, false);\n        mFirstView = (MeiTuanRefreshFirstStepView) headerView.findViewById(R.id.first_view);\n        tv_pull_to_refresh = (TextView) headerView.findViewById(R.id.tv_pull_to_refresh);\n        mSecondView = (MeiTuanRefreshSecondStepView) headerView.findViewById(R.id.second_view);\n        mSecondView.setBackgroundResource(R.drawable.pull_to_refresh_second_anim);\n        secondAnim = (AnimationDrawable) mSecondView.getBackground();\n        mThirdView = (MeiTuanRefreshThirdStepView) headerView.findViewById(R.id.third_view);\n        mThirdView.setBackgroundResource(R.drawable.pull_to_refresh_third_anim);\n        thirdAnim = (AnimationDrawable) mThirdView.getBackground();\n\n        measureView(headerView);\n        addHeaderView(headerView);\n        headerViewHeight = headerView.getMeasuredHeight();\n        headerView.setPadding(0, -headerViewHeight, 0, 0);\n        Log.i(\"zhangqi\",\"headerViewHeight=\"+headerViewHeight);\n\n        state = DONE;\n        isEnd = true;\n        isRefreable = false;\n    }\n\n\n\n\n    @Override\n    public void onScrollStateChanged(AbsListView absListView, int i) {\n    }\n    @Override\n    public void onScroll(AbsListView absListView, int firstVisibleItem, int visibleItemCount, int totalItemCount) {\n        mFirstVisibleItem = firstVisibleItem;\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent ev) {\n        if (isEnd) {//如果现在时结束的状态，即刷新完毕了，可以再次刷新了，在onRefreshComplete中设置\n            if (isRefreable) {//如果现在是可刷新状态   在setOnMeiTuanListener中设置为true\n                switch (ev.getAction()){\n                    //用户按下\n                case MotionEvent.ACTION_DOWN:\n                    //如果当前是在listview顶部并且没有记录y坐标\n                    if (mFirstVisibleItem == 0 && !isRecord) {\n                        //将isRecord置为true，说明现在已记录y坐标\n                        isRecord = true;\n                        //将当前y坐标赋值给startY起始y坐标\n                        startY = ev.getY();\n                    }\n                    break;\n                //用户滑动\n                case MotionEvent.ACTION_MOVE:\n                    //再次得到y坐标，用来和startY相减来计算offsetY位移值\n                    float tempY = ev.getY();\n                    //再起判断一下是否为listview顶部并且没有记录y坐标\n                    if (mFirstVisibleItem == 0 && !isRecord) {\n                        isRecord = true;\n                        startY = tempY;\n                    }\n                    //如果当前状态不是正在刷新的状态，并且已经记录了y坐标\n                    if (state!=REFRESHING && isRecord ) {\n                        //计算y的偏移量\n                        offsetY = tempY - startY;\n                        //计算当前滑动的高度\n                        float currentHeight = (-headerViewHeight+offsetY/3);\n                        //用当前滑动的高度和头部headerView的总高度进行比 计算出当前滑动的百分比 0到1\n                        float currentProgress = 1+currentHeight/headerViewHeight;\n                        //如果当前百分比大于1了，将其设置为1，目的是让第一个状态的椭圆不再继续变大\n                        if (currentProgress>=1) {\n                            currentProgress = 1;\n                        }\n                        //如果当前的状态是放开刷新，并且已经记录y坐标\n                        if (state == RELEASE_TO_REFRESH && isRecord) {\n                            setSelection(0);\n                            //如果当前滑动的距离小于headerView的总高度\n                            if (-headerViewHeight+offsetY/RATIO<0) {\n                                //将状态置为下拉刷新状态\n                                state = PULL_TO_REFRESH;\n                                //根据状态改变headerView，主要是更新动画和文字等信息\n                                changeHeaderByState(state);\n                                //如果当前y的位移值小于0，即为headerView隐藏了\n                            }else if (offsetY<=0) {\n                                //将状态变为done\n                                state = DONE;\n                                //根据状态改变headerView，主要是更新动画和文字等信息\n                                changeHeaderByState(state);\n                            }\n                        }\n                        //如果当前状态为下拉刷新并且已经记录y坐标\n                        if (state == PULL_TO_REFRESH && isRecord) {\n                            setSelection(0);\n                            //如果下拉距离大于等于headerView的总高度\n                            if (-headerViewHeight+offsetY/RATIO>=0) {\n                                //将状态变为放开刷新\n                                state = RELEASE_TO_REFRESH;\n                                //根据状态改变headerView，主要是更新动画和文字等信息\n                                changeHeaderByState(state);\n                                //如果当前y的位移值小于0，即为headerView隐藏了\n                            }else if (offsetY<=0) {\n                                //将状态变为done\n                                state = DONE;\n                                //根据状态改变headerView，主要是更新动画和文字等信息\n                                changeHeaderByState(state);\n                            }\n                        }\n                        //如果当前状态为done并且已经记录y坐标\n                        if (state == DONE && isRecord) {\n                            //如果位移值大于0\n                            if (offsetY>=0) {\n                                //将状态改为下拉刷新状态\n                                state = PULL_TO_REFRESH;\n                            }\n                        }\n                        //如果为下拉刷新状态\n                        if (state == PULL_TO_REFRESH) {\n                            //则改变headerView的padding来实现下拉的效果\n                            headerView.setPadding(0,(int)(-headerViewHeight+offsetY/RATIO) ,0,0);\n                            //给第一个状态的View设置当前进度值\n                            mFirstView.setCurrentProgress(currentProgress);\n                            //重画\n                            mFirstView.postInvalidate();\n                        }\n                        //如果为放开刷新状态\n                        if (state == RELEASE_TO_REFRESH) {\n                            //改变headerView的padding值\n                            headerView.setPadding(0,(int)(-headerViewHeight+offsetY/RATIO) ,0, 0);\n                            //给第一个状态的View设置当前进度值\n                            mFirstView.setCurrentProgress(currentProgress);\n                            //重画\n                            mFirstView.postInvalidate();\n                        }\n                    }\n                    break;\n                //当用户手指抬起时\n                case MotionEvent.ACTION_UP:\n                    //如果当前状态为下拉刷新状态\n                    if (state == PULL_TO_REFRESH) {\n                        //平滑的隐藏headerView\n                        this.smoothScrollBy((int)(-headerViewHeight+offsetY/RATIO)+headerViewHeight, 500);\n                        //根据状态改变headerView\n                        changeHeaderByState(state);\n                    }\n                    //如果当前状态为放开刷新\n                    if (state == RELEASE_TO_REFRESH) {\n                        //平滑的滑到正好显示headerView\n                        this.smoothScrollBy((int)(-headerViewHeight+offsetY/RATIO), 500);\n                        //将当前状态设置为正在刷新\n                        state = REFRESHING;\n                        //回调接口的onRefresh方法\n                        mOnRefreshListener.onRefresh();\n                        //根据状态改变headerView\n                        changeHeaderByState(state);\n                    }\n                    //这一套手势执行完，一定别忘了将记录y坐标的isRecord改为false，以便于下一次手势的执行\n                    isRecord = false;\n                    break;\n                }\n\n            }\n        }\n        return super.onTouchEvent(ev);\n    }\n\n    /**\n     * 根据状态改变headerView的动画和文字显示\n     * @param state\n     */\n    private void changeHeaderByState(int state){\n        switch (state) {\n        case DONE://如果的隐藏的状态\n            //设置headerView的padding为隐藏\n            headerView.setPadding(0, -headerViewHeight, 0, 0);\n            //第一状态的view显示出来\n            mFirstView.setVisibility(View.VISIBLE);\n            //第二状态的view隐藏起来\n            mSecondView.setVisibility(View.GONE);\n            //停止第二状态的动画\n            secondAnim.stop();\n            //第三状态的view隐藏起来\n            mThirdView.setVisibility(View.GONE);\n            //停止第三状态的动画\n            thirdAnim.stop();\n            break;\n        case RELEASE_TO_REFRESH://当前状态为放开刷新\n            //文字显示为放开刷新\n            tv_pull_to_refresh.setText(\"放开刷新\");\n            //第一状态view隐藏起来\n            mFirstView.setVisibility(View.GONE);\n            //第二状态view显示出来\n            mSecondView.setVisibility(View.VISIBLE);\n            //播放第二状态的动画\n            secondAnim.start();\n            //第三状态view隐藏起来\n            mThirdView.setVisibility(View.GONE);\n            //停止第三状态的动画\n            thirdAnim.stop();\n            break;\n        case PULL_TO_REFRESH://当前状态为下拉刷新\n            //设置文字为下拉刷新\n            tv_pull_to_refresh.setText(\"下拉刷新\");\n            //第一状态view显示出来\n            mFirstView.setVisibility(View.VISIBLE);\n            //第二状态view隐藏起来\n            mSecondView.setVisibility(View.GONE);\n            //第二状态动画停止\n            secondAnim.stop();\n            //第三状态view隐藏起来\n            mThirdView.setVisibility(View.GONE);\n            //第三状态动画停止\n            thirdAnim.stop();\n            break;\n        case REFRESHING://当前状态为正在刷新\n            //文字设置为正在刷新\n            tv_pull_to_refresh.setText(\"正在刷新\");\n            //第一状态view隐藏起来\n            mFirstView.setVisibility(View.GONE);\n            //第三状态view显示出来\n            mThirdView.setVisibility(View.VISIBLE);\n            //第二状态view隐藏起来\n            mSecondView.setVisibility(View.GONE);\n            //停止第二状态动画\n            secondAnim.stop();\n            //启动第三状态view\n            thirdAnim.start();\n            break;\n        default:\n            break;\n        }\n    }\n\n\n    private void measureView(View child) {\n        ViewGroup.LayoutParams p = child.getLayoutParams();\n        if (p == null) {\n            p = new ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,\n                    ViewGroup.LayoutParams.WRAP_CONTENT);\n        }\n        int childWidthSpec = ViewGroup.getChildMeasureSpec(0, 0 + 0, p.width);\n        int lpHeight = p.height;\n        int childHeightSpec;\n        if (lpHeight > 0) {\n            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,\n                    MeasureSpec.EXACTLY);\n        } else {\n            childHeightSpec = MeasureSpec.makeMeasureSpec(0,\n                    MeasureSpec.UNSPECIFIED);\n        }\n        child.measure(childWidthSpec, childHeightSpec);\n    }\n\n\n}\n```\n代码中已经有了很详细的注释了，看起来应该会比较轻松。\n\n## 改进\n写完之后运行，发现有2个地方可以改进。\n### 下拉白块\n在下拉刷新的时候，若下拉的高度很高，那么松开刷新后，再次下拉，会出现很大的一个空白块，影响视觉。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview4.gif)\n导致该问题的原因是在``RELEASE_TO_REFRESH``状态下``ACTION_UP``时，只是利用smoothScrollBy滑动到headerView的显示位置。但是此时，headerView的paddingTop属性依然是``ACTION_MOVE``中设置的``headerView.setPadding(0,(int)(-headerViewHeight+offsetY/RATIO) ,0, 0);``，其值跟offsetY有关，offsetY越大，那么paddingTop值就会越大，导致再次下拉会出现很大的空白块。\n\n改进办法：利用Scroller滑动辅助类替换smoothScrollBy，在滑动的过程中不停设置headerView的paddingTop值。当滑动结束时，headerView的paddingTop正好等于0，即刚刚好显示。\n### 刷新结束后立刻消失\n刷新结束后，会直接设置headerView的paddingTop为-headerViewHeight，导致headerView立刻不可见，会显得比较突兀。\n\n改进办法：依然是利用Scroller类滑动辅助类，通过滑动动画使headerView不可见。\n改进后，我的代码是这样的:\n```\npublic class RefreshListView extends ListView implements ListView.OnScrollListener {\n    /**\n     * 刷新四种状态\n     */\n    public final static int DONE = 0; // 刷新完成\n    public final static int PULL_TO_REFRESH = 1; // 下拉刷新\n    public final static int RELEASE_TO_REFRESH = 2; // 松开刷新\n    public final static int REFRESHING = 3; // 正在刷新\n\n    private static final int RATIO = 3; // 滑动的比例值\n    private int state; // 当前的状态\n    private boolean isRefreshable; // 是否可刷新\n    private boolean isRecord; // 是否开始准备下拉刷新\n    private boolean refreshEnd; // 是否刷新结束\n    private int mFirstVisibleItem; // 当前第一个可见Item\n    private LinearLayout headerView; // 头布局\n    private TextView refreshText; // 刷新文字说明\n    private RefreshFirstView firstView; // 下拉刷新\n    private RefreshSecondView secondView; // 松开刷新\n    private RefreshThirdView thirdView; // 正在刷新\n    private AnimationDrawable secondAnim; // secondView对应的动画\n    private AnimationDrawable thirdAnim; // thirdView对应的动画\n    private int headerViewHeight; // 头布局的高度\n    private float startY; // 起始Y坐标\n    private float offsetY; // Y坐标上的偏移量\n    private OnRefreshListener refreshListener; // 回调接口\n    // 滑动类\n    private Scroller mScroller = null;\n\n    public RefreshListView(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public RefreshListView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public RefreshListView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    public void setRefreshListener(OnRefreshListener refreshListener) {\n        this.refreshListener = refreshListener;\n        isRefreshable = true;\n    }\n\n    /**\n     * 初始化\n     *\n     * @param context\n     */\n    private void init(Context context) {\n        setOverScrollMode(View.OVER_SCROLL_NEVER);\n        setOnScrollListener(this);\n\n        mScroller = new Scroller(context);\n\n        headerView = (LinearLayout) LayoutInflater.from(context).inflate(R.layout.list_header, this, false);\n        refreshText = (TextView) headerView.findViewById(R.id.pull_to_refresh);\n        firstView = (RefreshFirstView) headerView.findViewById(R.id.first_view);\n        secondView = (RefreshSecondView) headerView.findViewById(R.id.second_view);\n        thirdView = (RefreshThirdView) headerView.findViewById(R.id.third_view);\n        secondAnim = (AnimationDrawable) secondView.getBackground();\n        thirdAnim = (AnimationDrawable) thirdView.getBackground();\n\n        measureView(headerView);\n        addHeaderView(headerView);\n        headerViewHeight = headerView.getMeasuredHeight();\n        headerView.setPadding(0, -headerViewHeight, 0, 0); // 全局通过设置headerView的paddingTop来控制内部View的显示\n\n        state = DONE;\n        isRefreshable = false;\n        isRecord = false;\n    }\n\n    @Override\n    public void computeScroll() {\n        if (mScroller.computeScrollOffset()) {\n            setPaddingTop(mScroller.getCurrY());\n        }\n    }\n\n    private void setPaddingTop(int paddingTop) {\n        headerView.setPadding(0, paddingTop, 0, 0);\n        headerView.postInvalidate();\n    }\n\n    @Override\n    public void onScrollStateChanged(AbsListView view, int scrollState) {\n\n    }\n\n    @Override\n    public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCount, int totalItemCount) {\n        mFirstVisibleItem = firstVisibleItem;\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent ev) {\n        if (isRefreshable) {//如果现在是可刷新状态   在setOnMeiTuanListener中设置为true\n            switch (ev.getAction()) {\n                //用户按下\n                case MotionEvent.ACTION_DOWN:\n                    if (mFirstVisibleItem == 0 && !isRecord) {\n                        //将isRecord置为true，说明现在已记录y坐标\n                        isRecord = true;\n                        startY = ev.getY();\n                    }\n                    break;\n                //用户滑动\n                case MotionEvent.ACTION_MOVE:\n                    //再次得到y坐标，用来和startY相减来计算offsetY位移值\n                    float tempY = ev.getY();\n                    //再判断一次\n                    if (mFirstVisibleItem == 0 && !isRecord) {\n                        isRecord = true;\n                        startY = tempY;\n                    }\n                    //如果当前状态不是正在刷新的状态，并且已经记录了y坐标\n                    if (state != REFRESHING && isRecord) {\n                        //计算y的偏移量\n                        offsetY = tempY - startY;\n                        //计算当前滑动的高度\n                        float currentHeight = (-headerViewHeight + offsetY / 3);\n                        //用当前滑动的高度和头部headerView的总高度进行比 计算出当前滑动的百分比 0到1\n                        float currentProgress = 1 + currentHeight / headerViewHeight;\n                        //如果当前百分比大于1了，将其设置为1，目的是让第一个状态的椭圆不再继续变大\n                        if (currentProgress >= 1) {\n                            currentProgress = 1;\n                        }\n                        //如果当前的状态是放开刷新，并且已经记录y坐标\n                        if (state == RELEASE_TO_REFRESH && isRecord) {\n                            setSelection(0);\n                            //如果当前滑动的距离小于headerView的总高度\n                            if (-headerViewHeight + offsetY / RATIO < 0) {\n                                //将状态置为下拉刷新状态\n                                state = PULL_TO_REFRESH;\n                                changeHeaderByState(state);\n                                //如果当前y的位移值小于0，即为headerView隐藏了\n                            } else if (offsetY <= 0) {\n                                //将状态变为done\n                                state = DONE;\n                                changeHeaderByState(state);\n                            }\n                        }\n                        //如果当前状态为下拉刷新并且已经记录y坐标\n                        if (state == PULL_TO_REFRESH && isRecord) {\n                            setSelection(0);\n                            //如果下拉距离大于等于headerView的总高度\n                            if (-headerViewHeight + offsetY / RATIO >= 0) {\n                                //将状态变为放开刷新\n                                state = RELEASE_TO_REFRESH;\n                                changeHeaderByState(state);\n                                //如果当前y的位移值小于0，即为headerView隐藏了\n                            } else if (offsetY <= 0) {\n                                //将状态变为done\n                                state = DONE;\n                                changeHeaderByState(state);\n                            }\n                        }\n                        //如果当前状态为done并且已经记录y坐标\n                        if (state == DONE && isRecord) {\n                            //如果位移值大于0\n                            if (offsetY >= 0) {\n                                //将状态改为下拉刷新状态\n                                state = PULL_TO_REFRESH;\n                            }\n                        }\n                        //如果为下拉刷新状态\n                        if (state == PULL_TO_REFRESH) {\n                            //则改变headerView的padding来实现下拉的效果\n                            headerView.setPadding(0, (int) (-headerViewHeight + offsetY / RATIO), 0, 0);\n                            //给第一个状态的View设置当前进度值\n                            firstView.setCurrentProgress(currentProgress);\n                            //重画\n                            firstView.postInvalidate();\n                        }\n                        //如果为放开刷新状态\n                        if (state == RELEASE_TO_REFRESH) {\n                            //改变headerView的padding值\n                            headerView.setPadding(0, (int) (-headerViewHeight + offsetY / RATIO), 0, 0);\n                            //给第一个状态的View设置当前进度值\n                            firstView.setCurrentProgress(currentProgress);\n                            //重画\n                            firstView.postInvalidate();\n                        }\n                    }\n                    break;\n                default:\n                    //如果当前状态为下拉刷新状态\n                    if (state == PULL_TO_REFRESH) {\n                        //平滑的隐藏headerView\n                        this.smoothScrollBy((int) (-headerViewHeight + offsetY / RATIO) + headerViewHeight, 500);\n                        changeHeaderByState(state);\n                    }\n                    //如果当前状态为放开刷新\n                    if (state == RELEASE_TO_REFRESH) {\n                        //平滑的滑到正好显示headerView\n//                        this.smoothScrollBy((int) (-headerViewHeight + offsetY / RATIO), 500);\n                        mScroller.startScroll(0, (int) (-headerViewHeight + offsetY / RATIO), 0, (int) (headerViewHeight - offsetY / RATIO), 500);\n                        //将当前状态设置为正在刷新\n                        state = REFRESHING;\n                        //回调接口的onRefresh方法\n                        changeHeaderByState(state);\n                        if (refreshListener != null) {\n                            refreshListener.onRefresh();\n                        }\n                    }\n                    //一套操作执行完，重置状态\n                    isRecord = false;\n                    break;\n            }\n\n        }\n        return super.onTouchEvent(ev);\n    }\n\n    /**\n     * 根据state改变HeaderView\n     *\n     * @param state\n     */\n    private void changeHeaderByState(int state) {\n        switch (state) {\n            case DONE:\n                if (refreshEnd) { // 如果是刷新结束，则慢慢滚动消失\n                    mScroller.startScroll(0, 0, 0, -headerViewHeight, 500);\n                    refreshEnd = false;\n                } else {\n                    headerView.setPadding(0, -headerViewHeight, 0, 0);\n                }\n                firstView.setVisibility(VISIBLE);\n                secondView.setVisibility(GONE);\n                secondAnim.stop();\n                thirdView.setVisibility(GONE);\n                thirdAnim.stop();\n                break;\n            case PULL_TO_REFRESH:\n                refreshText.setText(\"下拉刷新\");\n                firstView.setVisibility(View.VISIBLE);\n                secondView.setVisibility(View.GONE);\n                secondAnim.stop();\n                thirdView.setVisibility(View.GONE);\n                thirdAnim.stop();\n                break;\n            case RELEASE_TO_REFRESH:\n                refreshText.setText(\"放开刷新\");\n                firstView.setVisibility(View.GONE);\n                secondView.setVisibility(View.VISIBLE);\n                secondAnim.start();\n                thirdView.setVisibility(View.GONE);\n                thirdAnim.stop();\n                break;\n            case REFRESHING:\n                refreshText.setText(\"正在刷新\");\n                firstView.setVisibility(View.GONE);\n                thirdView.setVisibility(View.VISIBLE);\n                secondView.setVisibility(View.GONE);\n                secondAnim.stop();\n                thirdAnim.start();\n                break;\n            default:\n                break;\n\n        }\n    }\n\n    /**\n     * 在init时View尚未绘制，为了获取HeaderView的高度，需要此方法提前绘制\n     *\n     * @param child\n     */\n    private void measureView(View child) {\n        ViewGroup.LayoutParams p = child.getLayoutParams();\n        if (p == null) {\n            p = new ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,\n                    ViewGroup.LayoutParams.WRAP_CONTENT);\n        }\n        int childWidthSpec = ViewGroup.getChildMeasureSpec(0, 0 + 0, p.width);\n        int lpHeight = p.height;\n        int childHeightSpec;\n        if (lpHeight > 0) {\n            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,\n                    MeasureSpec.EXACTLY);\n        } else {\n            childHeightSpec = MeasureSpec.makeMeasureSpec(0,\n                    MeasureSpec.UNSPECIFIED);\n        }\n        child.measure(childWidthSpec, childHeightSpec);\n    }\n\n    /**\n     * 刷新结束后的回调，重置状态\n     */\n    public void setOnRefreshComplete() {\n        state = DONE;\n        refreshEnd = true;\n        changeHeaderByState(state);\n    }\n\n    /**\n     * 刷新回调接口\n     */\n    public interface OnRefreshListener {\n        void onRefresh();\n    }\n}\n```\n\n## 讨论\n在原博客中有这样的讨论：setOnRefreshComplete没必要暴露，隐藏在ListView里面更好。\n\n个人觉得也确实是这样，我们使用下拉刷新只会关心onRefresh，对于setOnRefreshComplete是不关心的。\n但是setOnRefreshComplete是必须要在onRefresh执行完之后才会执行，对于ListView它是不知道onRefresh在何时结束的，所以如果非要隐藏setOnRefreshComplete，我暂时没想到好的实现方案。\n\n后面我找了一下下拉刷新相关的库，都有类似setOnRefreshComplete的方法。\nXListView：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview1.png)\nSwipeRefreshLayout:\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview2.png)\n希望有想法的大神不吝赐教~\n\n## 感受\n1. 对于自己记忆中模棱两可的知识一定要自己动手做一遍，以加深印象。\n2. 可以通过缩放canvas，来实现自定义view的缩放。\n3. 通过设置paddingTop值来控制headerView的显示。\n4. 在查看XListView相关源码的时候，发现它是这样在View还没显示的时候获取高度的：\n```\nmHeaderView.getViewTreeObserver().addOnGlobalLayoutListener(\n\t\tnew OnGlobalLayoutListener() {\n\t\t@Override\n\t\tpublic void onGlobalLayout() {\n\t\t\tmHeaderViewHeight = mHeaderViewContent.getHeight();\n\t\t\tgetViewTreeObserver().removeGlobalOnLayoutListener(this);\n\t\t}\n});\n```\n5. onTouchEvent里的事件处理是非常繁杂的，当时自己写滑动删除的ListView时也重写过onTouchEvent，一定要细心。\n\n## 我的代码\n代码已上传至[我的Github](https://github.com/LiJia92/MyRefreshListView)。\n\n## 参考文章\n[Android自定义控件之仿美团下拉刷新](http://blog.csdn.net/nugongahou110/article/details/49557875)\n","source":"_posts/refresh-listview.md","raw":"---\ntitle: Android仿美团下拉刷新\ndate: 2016-04-18 16:07:15\ntags:\n - 自定义View\n---\n\n在之前看过一篇文章[Android自定义控件之仿美团下拉刷新](http://blog.csdn.net/nugongahou110/article/details/49557875)，就是实现仿美团下拉刷新。一直对ListView等控件的下拉刷新的了解程度，可能也就停留在``用HeaderView来实现，然后重写onTouchEvent``，但是具体应该是怎样的呢？一直没有实际动手自己写过，于是抽空自己照着这篇博客自己写了一遍，以加深自己的理解。我对原博客进行摘录，重点写出一些对自己帮助大的内容。\n\n## 刷新状态\n一般下拉刷新应该都是会有三种状态：下拉刷新、松开刷新、正在刷新。\n### 下拉刷新\n实现思路：自定义View，通过设置进度值进行缩放。\n用SeekBar来模仿一下下拉距离的进度。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview3.gif)\n\n<!-- more -->\n\n自定义View代码：\n```\npublic class RefreshFirstView extends View {\n\n    private Bitmap firstBitmap;\n    private Bitmap endBitmap;\n    private float mCurrentProgress;\n    private int measuredWidth;\n    private int measuredHeight;\n    private Bitmap scaledBitmap;\n\n    public RefreshFirstView(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public RefreshFirstView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public RefreshFirstView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    private void init(Context context) {\n        firstBitmap = Bitmap.createBitmap(BitmapFactory.decodeResource(context.getResources(), R.drawable.pull_image));\n        endBitmap = Bitmap.createBitmap(BitmapFactory.decodeResource(getResources(), R.drawable.pull_end_image_frame_05));\n    }\n\n    @Override\n    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n        setMeasuredDimension(measureWidth(widthMeasureSpec), measureWidth(widthMeasureSpec) * endBitmap.getHeight() / endBitmap.getWidth());\n    }\n\n    @Override\n    protected void onLayout(boolean changed, int left, int top, int right,\n                            int bottom) {\n        super.onLayout(changed, left, top, right, bottom);\n        measuredWidth = getMeasuredWidth();\n        measuredHeight = getMeasuredHeight();\n        //根据第二阶段娃娃宽高  给椭圆形图片进行等比例的缩放\n        scaledBitmap = Bitmap.createScaledBitmap(firstBitmap, measuredWidth, measuredWidth * firstBitmap.getHeight() / firstBitmap.getWidth(), true);\n    }\n\n    private int measureWidth(int widMeasureSpec) {\n        int result;\n        int size = MeasureSpec.getSize(widMeasureSpec);\n        int mode = MeasureSpec.getMode(widMeasureSpec);\n        if (mode == MeasureSpec.EXACTLY) {\n            result = size;\n        } else {\n            result = endBitmap.getWidth();\n            if (mode == MeasureSpec.AT_MOST) {\n                result = Math.min(result, size);\n            }\n        }\n        return result;\n    }\n\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n        // 通过画布缩放，控制View缩放\n        canvas.scale(mCurrentProgress, mCurrentProgress, measuredWidth / 2, measuredHeight / 2);\n        canvas.drawBitmap(scaledBitmap, 0, measuredHeight / 4, null);\n    }\n\n    public void setCurrentProgress(float currentProgress) {\n        this.mCurrentProgress = currentProgress;\n    }\n\n}\n```\n### 松开刷新\n这里主要是一个帧动画。\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<animation-list xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:oneshot=\"true\">\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_01\"\n        android:duration=\"100\" />\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_02\"\n        android:duration=\"100\" />\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_03\"\n        android:duration=\"100\" />\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_04\"\n        android:duration=\"100\" />\n    <item\n        android:drawable=\"@drawable/pull_end_image_frame_05\"\n        android:duration=\"100\" />\n</animation-list>\n```\n### 正在刷新\n与松开刷新一样，也是一个帧动画，这里便不做赘述。\n\n三种状态通过自定义View，重写onMeasure来确保三个状态的View的宽高保持一致。\n\n## 下拉刷新的实现\n先贴一下原博客的代码：\n```\npublic class MeiTuanListView extends ListView implements AbsListView.OnScrollListener{\n    private static final int DONE = 0;\n    private static final int PULL_TO_REFRESH = 1;\n    private static final int RELEASE_TO_REFRESH = 2;\n    private static final int REFRESHING = 3;\n    private static final int RATIO = 3;\n    private LinearLayout headerView;\n    private int headerViewHeight;\n    private float startY;\n    private float offsetY;\n    private TextView tv_pull_to_refresh;\n    private OnMeiTuanRefreshListener mOnRefreshListener;\n    private int state;\n    private int mFirstVisibleItem;\n    private boolean isRecord;\n    private boolean isEnd;\n    private boolean isRefreable;\n    private FrameLayout mAnimContainer;\n    private Animation animation;\n    private SimpleDateFormat format;\n    private MeiTuanRefreshFirstStepView mFirstView;\n    private MeiTuanRefreshSecondStepView mSecondView;\n    private AnimationDrawable secondAnim;\n    private MeiTuanRefreshThirdStepView mThirdView;\n    private AnimationDrawable thirdAnim;\n\n    public MeiTuanListView(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public MeiTuanListView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public MeiTuanListView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    public interface OnMeiTuanRefreshListener{\n        void onRefresh();\n    }\n\n    /**\n     * 回调接口，想实现下拉刷新的listview实现此接口\n     * @param onRefreshListener\n     */\n    public void setOnMeiTuanRefreshListener(OnMeiTuanRefreshListener onRefreshListener){\n        mOnRefreshListener = onRefreshListener;\n        isRefreable = true;\n    }\n\n    /**\n     * 刷新完毕，从主线程发送过来，并且改变headerView的状态和文字动画信息\n     */\n    public void setOnRefreshComplete(){\n        //一定要将isEnd设置为true，以便于下次的下拉刷新\n        isEnd = true;\n        state = DONE;\n\n        changeHeaderByState(state);\n    }\n\n    private void init(Context context) {\n        setOverScrollMode(View.OVER_SCROLL_NEVER);\n        setOnScrollListener(this);\n\n        headerView = (LinearLayout) LayoutInflater.from(context).inflate(R.layout.meituan_item, null, false);\n        mFirstView = (MeiTuanRefreshFirstStepView) headerView.findViewById(R.id.first_view);\n        tv_pull_to_refresh = (TextView) headerView.findViewById(R.id.tv_pull_to_refresh);\n        mSecondView = (MeiTuanRefreshSecondStepView) headerView.findViewById(R.id.second_view);\n        mSecondView.setBackgroundResource(R.drawable.pull_to_refresh_second_anim);\n        secondAnim = (AnimationDrawable) mSecondView.getBackground();\n        mThirdView = (MeiTuanRefreshThirdStepView) headerView.findViewById(R.id.third_view);\n        mThirdView.setBackgroundResource(R.drawable.pull_to_refresh_third_anim);\n        thirdAnim = (AnimationDrawable) mThirdView.getBackground();\n\n        measureView(headerView);\n        addHeaderView(headerView);\n        headerViewHeight = headerView.getMeasuredHeight();\n        headerView.setPadding(0, -headerViewHeight, 0, 0);\n        Log.i(\"zhangqi\",\"headerViewHeight=\"+headerViewHeight);\n\n        state = DONE;\n        isEnd = true;\n        isRefreable = false;\n    }\n\n\n\n\n    @Override\n    public void onScrollStateChanged(AbsListView absListView, int i) {\n    }\n    @Override\n    public void onScroll(AbsListView absListView, int firstVisibleItem, int visibleItemCount, int totalItemCount) {\n        mFirstVisibleItem = firstVisibleItem;\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent ev) {\n        if (isEnd) {//如果现在时结束的状态，即刷新完毕了，可以再次刷新了，在onRefreshComplete中设置\n            if (isRefreable) {//如果现在是可刷新状态   在setOnMeiTuanListener中设置为true\n                switch (ev.getAction()){\n                    //用户按下\n                case MotionEvent.ACTION_DOWN:\n                    //如果当前是在listview顶部并且没有记录y坐标\n                    if (mFirstVisibleItem == 0 && !isRecord) {\n                        //将isRecord置为true，说明现在已记录y坐标\n                        isRecord = true;\n                        //将当前y坐标赋值给startY起始y坐标\n                        startY = ev.getY();\n                    }\n                    break;\n                //用户滑动\n                case MotionEvent.ACTION_MOVE:\n                    //再次得到y坐标，用来和startY相减来计算offsetY位移值\n                    float tempY = ev.getY();\n                    //再起判断一下是否为listview顶部并且没有记录y坐标\n                    if (mFirstVisibleItem == 0 && !isRecord) {\n                        isRecord = true;\n                        startY = tempY;\n                    }\n                    //如果当前状态不是正在刷新的状态，并且已经记录了y坐标\n                    if (state!=REFRESHING && isRecord ) {\n                        //计算y的偏移量\n                        offsetY = tempY - startY;\n                        //计算当前滑动的高度\n                        float currentHeight = (-headerViewHeight+offsetY/3);\n                        //用当前滑动的高度和头部headerView的总高度进行比 计算出当前滑动的百分比 0到1\n                        float currentProgress = 1+currentHeight/headerViewHeight;\n                        //如果当前百分比大于1了，将其设置为1，目的是让第一个状态的椭圆不再继续变大\n                        if (currentProgress>=1) {\n                            currentProgress = 1;\n                        }\n                        //如果当前的状态是放开刷新，并且已经记录y坐标\n                        if (state == RELEASE_TO_REFRESH && isRecord) {\n                            setSelection(0);\n                            //如果当前滑动的距离小于headerView的总高度\n                            if (-headerViewHeight+offsetY/RATIO<0) {\n                                //将状态置为下拉刷新状态\n                                state = PULL_TO_REFRESH;\n                                //根据状态改变headerView，主要是更新动画和文字等信息\n                                changeHeaderByState(state);\n                                //如果当前y的位移值小于0，即为headerView隐藏了\n                            }else if (offsetY<=0) {\n                                //将状态变为done\n                                state = DONE;\n                                //根据状态改变headerView，主要是更新动画和文字等信息\n                                changeHeaderByState(state);\n                            }\n                        }\n                        //如果当前状态为下拉刷新并且已经记录y坐标\n                        if (state == PULL_TO_REFRESH && isRecord) {\n                            setSelection(0);\n                            //如果下拉距离大于等于headerView的总高度\n                            if (-headerViewHeight+offsetY/RATIO>=0) {\n                                //将状态变为放开刷新\n                                state = RELEASE_TO_REFRESH;\n                                //根据状态改变headerView，主要是更新动画和文字等信息\n                                changeHeaderByState(state);\n                                //如果当前y的位移值小于0，即为headerView隐藏了\n                            }else if (offsetY<=0) {\n                                //将状态变为done\n                                state = DONE;\n                                //根据状态改变headerView，主要是更新动画和文字等信息\n                                changeHeaderByState(state);\n                            }\n                        }\n                        //如果当前状态为done并且已经记录y坐标\n                        if (state == DONE && isRecord) {\n                            //如果位移值大于0\n                            if (offsetY>=0) {\n                                //将状态改为下拉刷新状态\n                                state = PULL_TO_REFRESH;\n                            }\n                        }\n                        //如果为下拉刷新状态\n                        if (state == PULL_TO_REFRESH) {\n                            //则改变headerView的padding来实现下拉的效果\n                            headerView.setPadding(0,(int)(-headerViewHeight+offsetY/RATIO) ,0,0);\n                            //给第一个状态的View设置当前进度值\n                            mFirstView.setCurrentProgress(currentProgress);\n                            //重画\n                            mFirstView.postInvalidate();\n                        }\n                        //如果为放开刷新状态\n                        if (state == RELEASE_TO_REFRESH) {\n                            //改变headerView的padding值\n                            headerView.setPadding(0,(int)(-headerViewHeight+offsetY/RATIO) ,0, 0);\n                            //给第一个状态的View设置当前进度值\n                            mFirstView.setCurrentProgress(currentProgress);\n                            //重画\n                            mFirstView.postInvalidate();\n                        }\n                    }\n                    break;\n                //当用户手指抬起时\n                case MotionEvent.ACTION_UP:\n                    //如果当前状态为下拉刷新状态\n                    if (state == PULL_TO_REFRESH) {\n                        //平滑的隐藏headerView\n                        this.smoothScrollBy((int)(-headerViewHeight+offsetY/RATIO)+headerViewHeight, 500);\n                        //根据状态改变headerView\n                        changeHeaderByState(state);\n                    }\n                    //如果当前状态为放开刷新\n                    if (state == RELEASE_TO_REFRESH) {\n                        //平滑的滑到正好显示headerView\n                        this.smoothScrollBy((int)(-headerViewHeight+offsetY/RATIO), 500);\n                        //将当前状态设置为正在刷新\n                        state = REFRESHING;\n                        //回调接口的onRefresh方法\n                        mOnRefreshListener.onRefresh();\n                        //根据状态改变headerView\n                        changeHeaderByState(state);\n                    }\n                    //这一套手势执行完，一定别忘了将记录y坐标的isRecord改为false，以便于下一次手势的执行\n                    isRecord = false;\n                    break;\n                }\n\n            }\n        }\n        return super.onTouchEvent(ev);\n    }\n\n    /**\n     * 根据状态改变headerView的动画和文字显示\n     * @param state\n     */\n    private void changeHeaderByState(int state){\n        switch (state) {\n        case DONE://如果的隐藏的状态\n            //设置headerView的padding为隐藏\n            headerView.setPadding(0, -headerViewHeight, 0, 0);\n            //第一状态的view显示出来\n            mFirstView.setVisibility(View.VISIBLE);\n            //第二状态的view隐藏起来\n            mSecondView.setVisibility(View.GONE);\n            //停止第二状态的动画\n            secondAnim.stop();\n            //第三状态的view隐藏起来\n            mThirdView.setVisibility(View.GONE);\n            //停止第三状态的动画\n            thirdAnim.stop();\n            break;\n        case RELEASE_TO_REFRESH://当前状态为放开刷新\n            //文字显示为放开刷新\n            tv_pull_to_refresh.setText(\"放开刷新\");\n            //第一状态view隐藏起来\n            mFirstView.setVisibility(View.GONE);\n            //第二状态view显示出来\n            mSecondView.setVisibility(View.VISIBLE);\n            //播放第二状态的动画\n            secondAnim.start();\n            //第三状态view隐藏起来\n            mThirdView.setVisibility(View.GONE);\n            //停止第三状态的动画\n            thirdAnim.stop();\n            break;\n        case PULL_TO_REFRESH://当前状态为下拉刷新\n            //设置文字为下拉刷新\n            tv_pull_to_refresh.setText(\"下拉刷新\");\n            //第一状态view显示出来\n            mFirstView.setVisibility(View.VISIBLE);\n            //第二状态view隐藏起来\n            mSecondView.setVisibility(View.GONE);\n            //第二状态动画停止\n            secondAnim.stop();\n            //第三状态view隐藏起来\n            mThirdView.setVisibility(View.GONE);\n            //第三状态动画停止\n            thirdAnim.stop();\n            break;\n        case REFRESHING://当前状态为正在刷新\n            //文字设置为正在刷新\n            tv_pull_to_refresh.setText(\"正在刷新\");\n            //第一状态view隐藏起来\n            mFirstView.setVisibility(View.GONE);\n            //第三状态view显示出来\n            mThirdView.setVisibility(View.VISIBLE);\n            //第二状态view隐藏起来\n            mSecondView.setVisibility(View.GONE);\n            //停止第二状态动画\n            secondAnim.stop();\n            //启动第三状态view\n            thirdAnim.start();\n            break;\n        default:\n            break;\n        }\n    }\n\n\n    private void measureView(View child) {\n        ViewGroup.LayoutParams p = child.getLayoutParams();\n        if (p == null) {\n            p = new ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,\n                    ViewGroup.LayoutParams.WRAP_CONTENT);\n        }\n        int childWidthSpec = ViewGroup.getChildMeasureSpec(0, 0 + 0, p.width);\n        int lpHeight = p.height;\n        int childHeightSpec;\n        if (lpHeight > 0) {\n            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,\n                    MeasureSpec.EXACTLY);\n        } else {\n            childHeightSpec = MeasureSpec.makeMeasureSpec(0,\n                    MeasureSpec.UNSPECIFIED);\n        }\n        child.measure(childWidthSpec, childHeightSpec);\n    }\n\n\n}\n```\n代码中已经有了很详细的注释了，看起来应该会比较轻松。\n\n## 改进\n写完之后运行，发现有2个地方可以改进。\n### 下拉白块\n在下拉刷新的时候，若下拉的高度很高，那么松开刷新后，再次下拉，会出现很大的一个空白块，影响视觉。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview4.gif)\n导致该问题的原因是在``RELEASE_TO_REFRESH``状态下``ACTION_UP``时，只是利用smoothScrollBy滑动到headerView的显示位置。但是此时，headerView的paddingTop属性依然是``ACTION_MOVE``中设置的``headerView.setPadding(0,(int)(-headerViewHeight+offsetY/RATIO) ,0, 0);``，其值跟offsetY有关，offsetY越大，那么paddingTop值就会越大，导致再次下拉会出现很大的空白块。\n\n改进办法：利用Scroller滑动辅助类替换smoothScrollBy，在滑动的过程中不停设置headerView的paddingTop值。当滑动结束时，headerView的paddingTop正好等于0，即刚刚好显示。\n### 刷新结束后立刻消失\n刷新结束后，会直接设置headerView的paddingTop为-headerViewHeight，导致headerView立刻不可见，会显得比较突兀。\n\n改进办法：依然是利用Scroller类滑动辅助类，通过滑动动画使headerView不可见。\n改进后，我的代码是这样的:\n```\npublic class RefreshListView extends ListView implements ListView.OnScrollListener {\n    /**\n     * 刷新四种状态\n     */\n    public final static int DONE = 0; // 刷新完成\n    public final static int PULL_TO_REFRESH = 1; // 下拉刷新\n    public final static int RELEASE_TO_REFRESH = 2; // 松开刷新\n    public final static int REFRESHING = 3; // 正在刷新\n\n    private static final int RATIO = 3; // 滑动的比例值\n    private int state; // 当前的状态\n    private boolean isRefreshable; // 是否可刷新\n    private boolean isRecord; // 是否开始准备下拉刷新\n    private boolean refreshEnd; // 是否刷新结束\n    private int mFirstVisibleItem; // 当前第一个可见Item\n    private LinearLayout headerView; // 头布局\n    private TextView refreshText; // 刷新文字说明\n    private RefreshFirstView firstView; // 下拉刷新\n    private RefreshSecondView secondView; // 松开刷新\n    private RefreshThirdView thirdView; // 正在刷新\n    private AnimationDrawable secondAnim; // secondView对应的动画\n    private AnimationDrawable thirdAnim; // thirdView对应的动画\n    private int headerViewHeight; // 头布局的高度\n    private float startY; // 起始Y坐标\n    private float offsetY; // Y坐标上的偏移量\n    private OnRefreshListener refreshListener; // 回调接口\n    // 滑动类\n    private Scroller mScroller = null;\n\n    public RefreshListView(Context context) {\n        super(context);\n        init(context);\n    }\n\n    public RefreshListView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        init(context);\n    }\n\n    public RefreshListView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n        init(context);\n    }\n\n    public void setRefreshListener(OnRefreshListener refreshListener) {\n        this.refreshListener = refreshListener;\n        isRefreshable = true;\n    }\n\n    /**\n     * 初始化\n     *\n     * @param context\n     */\n    private void init(Context context) {\n        setOverScrollMode(View.OVER_SCROLL_NEVER);\n        setOnScrollListener(this);\n\n        mScroller = new Scroller(context);\n\n        headerView = (LinearLayout) LayoutInflater.from(context).inflate(R.layout.list_header, this, false);\n        refreshText = (TextView) headerView.findViewById(R.id.pull_to_refresh);\n        firstView = (RefreshFirstView) headerView.findViewById(R.id.first_view);\n        secondView = (RefreshSecondView) headerView.findViewById(R.id.second_view);\n        thirdView = (RefreshThirdView) headerView.findViewById(R.id.third_view);\n        secondAnim = (AnimationDrawable) secondView.getBackground();\n        thirdAnim = (AnimationDrawable) thirdView.getBackground();\n\n        measureView(headerView);\n        addHeaderView(headerView);\n        headerViewHeight = headerView.getMeasuredHeight();\n        headerView.setPadding(0, -headerViewHeight, 0, 0); // 全局通过设置headerView的paddingTop来控制内部View的显示\n\n        state = DONE;\n        isRefreshable = false;\n        isRecord = false;\n    }\n\n    @Override\n    public void computeScroll() {\n        if (mScroller.computeScrollOffset()) {\n            setPaddingTop(mScroller.getCurrY());\n        }\n    }\n\n    private void setPaddingTop(int paddingTop) {\n        headerView.setPadding(0, paddingTop, 0, 0);\n        headerView.postInvalidate();\n    }\n\n    @Override\n    public void onScrollStateChanged(AbsListView view, int scrollState) {\n\n    }\n\n    @Override\n    public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCount, int totalItemCount) {\n        mFirstVisibleItem = firstVisibleItem;\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent ev) {\n        if (isRefreshable) {//如果现在是可刷新状态   在setOnMeiTuanListener中设置为true\n            switch (ev.getAction()) {\n                //用户按下\n                case MotionEvent.ACTION_DOWN:\n                    if (mFirstVisibleItem == 0 && !isRecord) {\n                        //将isRecord置为true，说明现在已记录y坐标\n                        isRecord = true;\n                        startY = ev.getY();\n                    }\n                    break;\n                //用户滑动\n                case MotionEvent.ACTION_MOVE:\n                    //再次得到y坐标，用来和startY相减来计算offsetY位移值\n                    float tempY = ev.getY();\n                    //再判断一次\n                    if (mFirstVisibleItem == 0 && !isRecord) {\n                        isRecord = true;\n                        startY = tempY;\n                    }\n                    //如果当前状态不是正在刷新的状态，并且已经记录了y坐标\n                    if (state != REFRESHING && isRecord) {\n                        //计算y的偏移量\n                        offsetY = tempY - startY;\n                        //计算当前滑动的高度\n                        float currentHeight = (-headerViewHeight + offsetY / 3);\n                        //用当前滑动的高度和头部headerView的总高度进行比 计算出当前滑动的百分比 0到1\n                        float currentProgress = 1 + currentHeight / headerViewHeight;\n                        //如果当前百分比大于1了，将其设置为1，目的是让第一个状态的椭圆不再继续变大\n                        if (currentProgress >= 1) {\n                            currentProgress = 1;\n                        }\n                        //如果当前的状态是放开刷新，并且已经记录y坐标\n                        if (state == RELEASE_TO_REFRESH && isRecord) {\n                            setSelection(0);\n                            //如果当前滑动的距离小于headerView的总高度\n                            if (-headerViewHeight + offsetY / RATIO < 0) {\n                                //将状态置为下拉刷新状态\n                                state = PULL_TO_REFRESH;\n                                changeHeaderByState(state);\n                                //如果当前y的位移值小于0，即为headerView隐藏了\n                            } else if (offsetY <= 0) {\n                                //将状态变为done\n                                state = DONE;\n                                changeHeaderByState(state);\n                            }\n                        }\n                        //如果当前状态为下拉刷新并且已经记录y坐标\n                        if (state == PULL_TO_REFRESH && isRecord) {\n                            setSelection(0);\n                            //如果下拉距离大于等于headerView的总高度\n                            if (-headerViewHeight + offsetY / RATIO >= 0) {\n                                //将状态变为放开刷新\n                                state = RELEASE_TO_REFRESH;\n                                changeHeaderByState(state);\n                                //如果当前y的位移值小于0，即为headerView隐藏了\n                            } else if (offsetY <= 0) {\n                                //将状态变为done\n                                state = DONE;\n                                changeHeaderByState(state);\n                            }\n                        }\n                        //如果当前状态为done并且已经记录y坐标\n                        if (state == DONE && isRecord) {\n                            //如果位移值大于0\n                            if (offsetY >= 0) {\n                                //将状态改为下拉刷新状态\n                                state = PULL_TO_REFRESH;\n                            }\n                        }\n                        //如果为下拉刷新状态\n                        if (state == PULL_TO_REFRESH) {\n                            //则改变headerView的padding来实现下拉的效果\n                            headerView.setPadding(0, (int) (-headerViewHeight + offsetY / RATIO), 0, 0);\n                            //给第一个状态的View设置当前进度值\n                            firstView.setCurrentProgress(currentProgress);\n                            //重画\n                            firstView.postInvalidate();\n                        }\n                        //如果为放开刷新状态\n                        if (state == RELEASE_TO_REFRESH) {\n                            //改变headerView的padding值\n                            headerView.setPadding(0, (int) (-headerViewHeight + offsetY / RATIO), 0, 0);\n                            //给第一个状态的View设置当前进度值\n                            firstView.setCurrentProgress(currentProgress);\n                            //重画\n                            firstView.postInvalidate();\n                        }\n                    }\n                    break;\n                default:\n                    //如果当前状态为下拉刷新状态\n                    if (state == PULL_TO_REFRESH) {\n                        //平滑的隐藏headerView\n                        this.smoothScrollBy((int) (-headerViewHeight + offsetY / RATIO) + headerViewHeight, 500);\n                        changeHeaderByState(state);\n                    }\n                    //如果当前状态为放开刷新\n                    if (state == RELEASE_TO_REFRESH) {\n                        //平滑的滑到正好显示headerView\n//                        this.smoothScrollBy((int) (-headerViewHeight + offsetY / RATIO), 500);\n                        mScroller.startScroll(0, (int) (-headerViewHeight + offsetY / RATIO), 0, (int) (headerViewHeight - offsetY / RATIO), 500);\n                        //将当前状态设置为正在刷新\n                        state = REFRESHING;\n                        //回调接口的onRefresh方法\n                        changeHeaderByState(state);\n                        if (refreshListener != null) {\n                            refreshListener.onRefresh();\n                        }\n                    }\n                    //一套操作执行完，重置状态\n                    isRecord = false;\n                    break;\n            }\n\n        }\n        return super.onTouchEvent(ev);\n    }\n\n    /**\n     * 根据state改变HeaderView\n     *\n     * @param state\n     */\n    private void changeHeaderByState(int state) {\n        switch (state) {\n            case DONE:\n                if (refreshEnd) { // 如果是刷新结束，则慢慢滚动消失\n                    mScroller.startScroll(0, 0, 0, -headerViewHeight, 500);\n                    refreshEnd = false;\n                } else {\n                    headerView.setPadding(0, -headerViewHeight, 0, 0);\n                }\n                firstView.setVisibility(VISIBLE);\n                secondView.setVisibility(GONE);\n                secondAnim.stop();\n                thirdView.setVisibility(GONE);\n                thirdAnim.stop();\n                break;\n            case PULL_TO_REFRESH:\n                refreshText.setText(\"下拉刷新\");\n                firstView.setVisibility(View.VISIBLE);\n                secondView.setVisibility(View.GONE);\n                secondAnim.stop();\n                thirdView.setVisibility(View.GONE);\n                thirdAnim.stop();\n                break;\n            case RELEASE_TO_REFRESH:\n                refreshText.setText(\"放开刷新\");\n                firstView.setVisibility(View.GONE);\n                secondView.setVisibility(View.VISIBLE);\n                secondAnim.start();\n                thirdView.setVisibility(View.GONE);\n                thirdAnim.stop();\n                break;\n            case REFRESHING:\n                refreshText.setText(\"正在刷新\");\n                firstView.setVisibility(View.GONE);\n                thirdView.setVisibility(View.VISIBLE);\n                secondView.setVisibility(View.GONE);\n                secondAnim.stop();\n                thirdAnim.start();\n                break;\n            default:\n                break;\n\n        }\n    }\n\n    /**\n     * 在init时View尚未绘制，为了获取HeaderView的高度，需要此方法提前绘制\n     *\n     * @param child\n     */\n    private void measureView(View child) {\n        ViewGroup.LayoutParams p = child.getLayoutParams();\n        if (p == null) {\n            p = new ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,\n                    ViewGroup.LayoutParams.WRAP_CONTENT);\n        }\n        int childWidthSpec = ViewGroup.getChildMeasureSpec(0, 0 + 0, p.width);\n        int lpHeight = p.height;\n        int childHeightSpec;\n        if (lpHeight > 0) {\n            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,\n                    MeasureSpec.EXACTLY);\n        } else {\n            childHeightSpec = MeasureSpec.makeMeasureSpec(0,\n                    MeasureSpec.UNSPECIFIED);\n        }\n        child.measure(childWidthSpec, childHeightSpec);\n    }\n\n    /**\n     * 刷新结束后的回调，重置状态\n     */\n    public void setOnRefreshComplete() {\n        state = DONE;\n        refreshEnd = true;\n        changeHeaderByState(state);\n    }\n\n    /**\n     * 刷新回调接口\n     */\n    public interface OnRefreshListener {\n        void onRefresh();\n    }\n}\n```\n\n## 讨论\n在原博客中有这样的讨论：setOnRefreshComplete没必要暴露，隐藏在ListView里面更好。\n\n个人觉得也确实是这样，我们使用下拉刷新只会关心onRefresh，对于setOnRefreshComplete是不关心的。\n但是setOnRefreshComplete是必须要在onRefresh执行完之后才会执行，对于ListView它是不知道onRefresh在何时结束的，所以如果非要隐藏setOnRefreshComplete，我暂时没想到好的实现方案。\n\n后面我找了一下下拉刷新相关的库，都有类似setOnRefreshComplete的方法。\nXListView：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview1.png)\nSwipeRefreshLayout:\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview2.png)\n希望有想法的大神不吝赐教~\n\n## 感受\n1. 对于自己记忆中模棱两可的知识一定要自己动手做一遍，以加深印象。\n2. 可以通过缩放canvas，来实现自定义view的缩放。\n3. 通过设置paddingTop值来控制headerView的显示。\n4. 在查看XListView相关源码的时候，发现它是这样在View还没显示的时候获取高度的：\n```\nmHeaderView.getViewTreeObserver().addOnGlobalLayoutListener(\n\t\tnew OnGlobalLayoutListener() {\n\t\t@Override\n\t\tpublic void onGlobalLayout() {\n\t\t\tmHeaderViewHeight = mHeaderViewContent.getHeight();\n\t\t\tgetViewTreeObserver().removeGlobalOnLayoutListener(this);\n\t\t}\n});\n```\n5. onTouchEvent里的事件处理是非常繁杂的，当时自己写滑动删除的ListView时也重写过onTouchEvent，一定要细心。\n\n## 我的代码\n代码已上传至[我的Github](https://github.com/LiJia92/MyRefreshListView)。\n\n## 参考文章\n[Android自定义控件之仿美团下拉刷新](http://blog.csdn.net/nugongahou110/article/details/49557875)\n","slug":"refresh-listview","published":1,"updated":"2016-11-21T10:02:48.543Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75a5002p1cb8kzxvsjhz","content":"<p>在之前看过一篇文章<a href=\"http://blog.csdn.net/nugongahou110/article/details/49557875\" target=\"_blank\" rel=\"external\">Android自定义控件之仿美团下拉刷新</a>，就是实现仿美团下拉刷新。一直对ListView等控件的下拉刷新的了解程度，可能也就停留在<code>用HeaderView来实现，然后重写onTouchEvent</code>，但是具体应该是怎样的呢？一直没有实际动手自己写过，于是抽空自己照着这篇博客自己写了一遍，以加深自己的理解。我对原博客进行摘录，重点写出一些对自己帮助大的内容。</p>\n<h2 id=\"刷新状态\"><a href=\"#刷新状态\" class=\"headerlink\" title=\"刷新状态\"></a>刷新状态</h2><p>一般下拉刷新应该都是会有三种状态：下拉刷新、松开刷新、正在刷新。</p>\n<h3 id=\"下拉刷新\"><a href=\"#下拉刷新\" class=\"headerlink\" title=\"下拉刷新\"></a>下拉刷新</h3><p>实现思路：自定义View，通过设置进度值进行缩放。<br>用SeekBar来模仿一下下拉距离的进度。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview3.gif\" alt=\"\"></p>\n<a id=\"more\"></a>\n<p>自定义View代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RefreshFirstView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Bitmap firstBitmap;</div><div class=\"line\">    <span class=\"keyword\">private</span> Bitmap endBitmap;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> mCurrentProgress;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> measuredWidth;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> measuredHeight;</div><div class=\"line\">    <span class=\"keyword\">private</span> Bitmap scaledBitmap;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshFirstView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshFirstView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshFirstView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        firstBitmap = Bitmap.createBitmap(BitmapFactory.decodeResource(context.getResources(), R.drawable.pull_image));</div><div class=\"line\">        endBitmap = Bitmap.createBitmap(BitmapFactory.decodeResource(getResources(), R.drawable.pull_end_image_frame_05));</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onMeasure</span><span class=\"params\">(<span class=\"keyword\">int</span> widthMeasureSpec, <span class=\"keyword\">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class=\"line\">        setMeasuredDimension(measureWidth(widthMeasureSpec), measureWidth(widthMeasureSpec) * endBitmap.getHeight() / endBitmap.getWidth());</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right,</span></span></div><div class=\"line\">                            <span class=\"keyword\">int</span> bottom) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        measuredWidth = getMeasuredWidth();</div><div class=\"line\">        measuredHeight = getMeasuredHeight();</div><div class=\"line\">        <span class=\"comment\">//根据第二阶段娃娃宽高  给椭圆形图片进行等比例的缩放</span></div><div class=\"line\">        scaledBitmap = Bitmap.createScaledBitmap(firstBitmap, measuredWidth, measuredWidth * firstBitmap.getHeight() / firstBitmap.getWidth(), <span class=\"keyword\">true</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">measureWidth</span><span class=\"params\">(<span class=\"keyword\">int</span> widMeasureSpec)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">int</span> result;</div><div class=\"line\">        <span class=\"keyword\">int</span> size = MeasureSpec.getSize(widMeasureSpec);</div><div class=\"line\">        <span class=\"keyword\">int</span> mode = MeasureSpec.getMode(widMeasureSpec);</div><div class=\"line\">        <span class=\"keyword\">if</span> (mode == MeasureSpec.EXACTLY) &#123;</div><div class=\"line\">            result = size;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            result = endBitmap.getWidth();</div><div class=\"line\">            <span class=\"keyword\">if</span> (mode == MeasureSpec.AT_MOST) &#123;</div><div class=\"line\">                result = Math.min(result, size);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> result;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">        <span class=\"comment\">// 通过画布缩放，控制View缩放</span></div><div class=\"line\">        canvas.scale(mCurrentProgress, mCurrentProgress, measuredWidth / <span class=\"number\">2</span>, measuredHeight / <span class=\"number\">2</span>);</div><div class=\"line\">        canvas.drawBitmap(scaledBitmap, <span class=\"number\">0</span>, measuredHeight / <span class=\"number\">4</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setCurrentProgress</span><span class=\"params\">(<span class=\"keyword\">float</span> currentProgress)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.mCurrentProgress = currentProgress;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h3 id=\"松开刷新\"><a href=\"#松开刷新\" class=\"headerlink\" title=\"松开刷新\"></a>松开刷新</h3><p>这里主要是一个帧动画。<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">animation-list</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:oneshot</span>=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_01\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_02\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_03\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_04\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_05\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">animation-list</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<h3 id=\"正在刷新\"><a href=\"#正在刷新\" class=\"headerlink\" title=\"正在刷新\"></a>正在刷新</h3><p>与松开刷新一样，也是一个帧动画，这里便不做赘述。</p>\n<p>三种状态通过自定义View，重写onMeasure来确保三个状态的View的宽高保持一致。</p>\n<h2 id=\"下拉刷新的实现\"><a href=\"#下拉刷新的实现\" class=\"headerlink\" title=\"下拉刷新的实现\"></a>下拉刷新的实现</h2><p>先贴一下原博客的代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div><div class=\"line\">295</div><div class=\"line\">296</div><div class=\"line\">297</div><div class=\"line\">298</div><div class=\"line\">299</div><div class=\"line\">300</div><div class=\"line\">301</div><div class=\"line\">302</div><div class=\"line\">303</div><div class=\"line\">304</div><div class=\"line\">305</div><div class=\"line\">306</div><div class=\"line\">307</div><div class=\"line\">308</div><div class=\"line\">309</div><div class=\"line\">310</div><div class=\"line\">311</div><div class=\"line\">312</div><div class=\"line\">313</div><div class=\"line\">314</div><div class=\"line\">315</div><div class=\"line\">316</div><div class=\"line\">317</div><div class=\"line\">318</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MeiTuanListView</span> <span class=\"keyword\">extends</span> <span class=\"title\">ListView</span> <span class=\"keyword\">implements</span> <span class=\"title\">AbsListView</span>.<span class=\"title\">OnScrollListener</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DONE = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> PULL_TO_REFRESH = <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> RELEASE_TO_REFRESH = <span class=\"number\">2</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> REFRESHING = <span class=\"number\">3</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> RATIO = <span class=\"number\">3</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> LinearLayout headerView;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> headerViewHeight;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> startY;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> offsetY;</div><div class=\"line\">    <span class=\"keyword\">private</span> TextView tv_pull_to_refresh;</div><div class=\"line\">    <span class=\"keyword\">private</span> OnMeiTuanRefreshListener mOnRefreshListener;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> state;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mFirstVisibleItem;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isRecord;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isEnd;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isRefreable;</div><div class=\"line\">    <span class=\"keyword\">private</span> FrameLayout mAnimContainer;</div><div class=\"line\">    <span class=\"keyword\">private</span> Animation animation;</div><div class=\"line\">    <span class=\"keyword\">private</span> SimpleDateFormat format;</div><div class=\"line\">    <span class=\"keyword\">private</span> MeiTuanRefreshFirstStepView mFirstView;</div><div class=\"line\">    <span class=\"keyword\">private</span> MeiTuanRefreshSecondStepView mSecondView;</div><div class=\"line\">    <span class=\"keyword\">private</span> AnimationDrawable secondAnim;</div><div class=\"line\">    <span class=\"keyword\">private</span> MeiTuanRefreshThirdStepView mThirdView;</div><div class=\"line\">    <span class=\"keyword\">private</span> AnimationDrawable thirdAnim;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MeiTuanListView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MeiTuanListView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MeiTuanListView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnMeiTuanRefreshListener</span></span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onRefresh</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 回调接口，想实现下拉刷新的listview实现此接口</div><div class=\"line\">     * <span class=\"doctag\">@param</span> onRefreshListener</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setOnMeiTuanRefreshListener</span><span class=\"params\">(OnMeiTuanRefreshListener onRefreshListener)</span></span>&#123;</div><div class=\"line\">        mOnRefreshListener = onRefreshListener;</div><div class=\"line\">        isRefreable = <span class=\"keyword\">true</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 刷新完毕，从主线程发送过来，并且改变headerView的状态和文字动画信息</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setOnRefreshComplete</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">        <span class=\"comment\">//一定要将isEnd设置为true，以便于下次的下拉刷新</span></div><div class=\"line\">        isEnd = <span class=\"keyword\">true</span>;</div><div class=\"line\">        state = DONE;</div><div class=\"line\"></div><div class=\"line\">        changeHeaderByState(state);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        setOverScrollMode(View.OVER_SCROLL_NEVER);</div><div class=\"line\">        setOnScrollListener(<span class=\"keyword\">this</span>);</div><div class=\"line\"></div><div class=\"line\">        headerView = (LinearLayout) LayoutInflater.from(context).inflate(R.layout.meituan_item, <span class=\"keyword\">null</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\">        mFirstView = (MeiTuanRefreshFirstStepView) headerView.findViewById(R.id.first_view);</div><div class=\"line\">        tv_pull_to_refresh = (TextView) headerView.findViewById(R.id.tv_pull_to_refresh);</div><div class=\"line\">        mSecondView = (MeiTuanRefreshSecondStepView) headerView.findViewById(R.id.second_view);</div><div class=\"line\">        mSecondView.setBackgroundResource(R.drawable.pull_to_refresh_second_anim);</div><div class=\"line\">        secondAnim = (AnimationDrawable) mSecondView.getBackground();</div><div class=\"line\">        mThirdView = (MeiTuanRefreshThirdStepView) headerView.findViewById(R.id.third_view);</div><div class=\"line\">        mThirdView.setBackgroundResource(R.drawable.pull_to_refresh_third_anim);</div><div class=\"line\">        thirdAnim = (AnimationDrawable) mThirdView.getBackground();</div><div class=\"line\"></div><div class=\"line\">        measureView(headerView);</div><div class=\"line\">        addHeaderView(headerView);</div><div class=\"line\">        headerViewHeight = headerView.getMeasuredHeight();</div><div class=\"line\">        headerView.setPadding(<span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">        Log.i(<span class=\"string\">\"zhangqi\"</span>,<span class=\"string\">\"headerViewHeight=\"</span>+headerViewHeight);</div><div class=\"line\"></div><div class=\"line\">        state = DONE;</div><div class=\"line\">        isEnd = <span class=\"keyword\">true</span>;</div><div class=\"line\">        isRefreable = <span class=\"keyword\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onScrollStateChanged</span><span class=\"params\">(AbsListView absListView, <span class=\"keyword\">int</span> i)</span> </span>&#123;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onScroll</span><span class=\"params\">(AbsListView absListView, <span class=\"keyword\">int</span> firstVisibleItem, <span class=\"keyword\">int</span> visibleItemCount, <span class=\"keyword\">int</span> totalItemCount)</span> </span>&#123;</div><div class=\"line\">        mFirstVisibleItem = firstVisibleItem;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isEnd) &#123;<span class=\"comment\">//如果现在时结束的状态，即刷新完毕了，可以再次刷新了，在onRefreshComplete中设置</span></div><div class=\"line\">            <span class=\"keyword\">if</span> (isRefreable) &#123;<span class=\"comment\">//如果现在是可刷新状态   在setOnMeiTuanListener中设置为true</span></div><div class=\"line\">                <span class=\"keyword\">switch</span> (ev.getAction())&#123;</div><div class=\"line\">                    <span class=\"comment\">//用户按下</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                    <span class=\"comment\">//如果当前是在listview顶部并且没有记录y坐标</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (mFirstVisibleItem == <span class=\"number\">0</span> &amp;&amp; !isRecord) &#123;</div><div class=\"line\">                        <span class=\"comment\">//将isRecord置为true，说明现在已记录y坐标</span></div><div class=\"line\">                        isRecord = <span class=\"keyword\">true</span>;</div><div class=\"line\">                        <span class=\"comment\">//将当前y坐标赋值给startY起始y坐标</span></div><div class=\"line\">                        startY = ev.getY();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"comment\">//用户滑动</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                    <span class=\"comment\">//再次得到y坐标，用来和startY相减来计算offsetY位移值</span></div><div class=\"line\">                    <span class=\"keyword\">float</span> tempY = ev.getY();</div><div class=\"line\">                    <span class=\"comment\">//再起判断一下是否为listview顶部并且没有记录y坐标</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (mFirstVisibleItem == <span class=\"number\">0</span> &amp;&amp; !isRecord) &#123;</div><div class=\"line\">                        isRecord = <span class=\"keyword\">true</span>;</div><div class=\"line\">                        startY = tempY;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态不是正在刷新的状态，并且已经记录了y坐标</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state!=REFRESHING &amp;&amp; isRecord ) &#123;</div><div class=\"line\">                        <span class=\"comment\">//计算y的偏移量</span></div><div class=\"line\">                        offsetY = tempY - startY;</div><div class=\"line\">                        <span class=\"comment\">//计算当前滑动的高度</span></div><div class=\"line\">                        <span class=\"keyword\">float</span> currentHeight = (-headerViewHeight+offsetY/<span class=\"number\">3</span>);</div><div class=\"line\">                        <span class=\"comment\">//用当前滑动的高度和头部headerView的总高度进行比 计算出当前滑动的百分比 0到1</span></div><div class=\"line\">                        <span class=\"keyword\">float</span> currentProgress = <span class=\"number\">1</span>+currentHeight/headerViewHeight;</div><div class=\"line\">                        <span class=\"comment\">//如果当前百分比大于1了，将其设置为1，目的是让第一个状态的椭圆不再继续变大</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (currentProgress&gt;=<span class=\"number\">1</span>) &#123;</div><div class=\"line\">                            currentProgress = <span class=\"number\">1</span>;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前的状态是放开刷新，并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            setSelection(<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//如果当前滑动的距离小于headerView的总高度</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (-headerViewHeight+offsetY/RATIO&lt;<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态置为下拉刷新状态</span></div><div class=\"line\">                                state = PULL_TO_REFRESH;</div><div class=\"line\">                                <span class=\"comment\">//根据状态改变headerView，主要是更新动画和文字等信息</span></div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                                <span class=\"comment\">//如果当前y的位移值小于0，即为headerView隐藏了</span></div><div class=\"line\">                            &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offsetY&lt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为done</span></div><div class=\"line\">                                state = DONE;</div><div class=\"line\">                                <span class=\"comment\">//根据状态改变headerView，主要是更新动画和文字等信息</span></div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前状态为下拉刷新并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            setSelection(<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//如果下拉距离大于等于headerView的总高度</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (-headerViewHeight+offsetY/RATIO&gt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为放开刷新</span></div><div class=\"line\">                                state = RELEASE_TO_REFRESH;</div><div class=\"line\">                                <span class=\"comment\">//根据状态改变headerView，主要是更新动画和文字等信息</span></div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                                <span class=\"comment\">//如果当前y的位移值小于0，即为headerView隐藏了</span></div><div class=\"line\">                            &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offsetY&lt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为done</span></div><div class=\"line\">                                state = DONE;</div><div class=\"line\">                                <span class=\"comment\">//根据状态改变headerView，主要是更新动画和文字等信息</span></div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前状态为done并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == DONE &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            <span class=\"comment\">//如果位移值大于0</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (offsetY&gt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态改为下拉刷新状态</span></div><div class=\"line\">                                state = PULL_TO_REFRESH;</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果为下拉刷新状态</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH) &#123;</div><div class=\"line\">                            <span class=\"comment\">//则改变headerView的padding来实现下拉的效果</span></div><div class=\"line\">                            headerView.setPadding(<span class=\"number\">0</span>,(<span class=\"keyword\">int</span>)(-headerViewHeight+offsetY/RATIO) ,<span class=\"number\">0</span>,<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//给第一个状态的View设置当前进度值</span></div><div class=\"line\">                            mFirstView.setCurrentProgress(currentProgress);</div><div class=\"line\">                            <span class=\"comment\">//重画</span></div><div class=\"line\">                            mFirstView.postInvalidate();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果为放开刷新状态</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH) &#123;</div><div class=\"line\">                            <span class=\"comment\">//改变headerView的padding值</span></div><div class=\"line\">                            headerView.setPadding(<span class=\"number\">0</span>,(<span class=\"keyword\">int</span>)(-headerViewHeight+offsetY/RATIO) ,<span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//给第一个状态的View设置当前进度值</span></div><div class=\"line\">                            mFirstView.setCurrentProgress(currentProgress);</div><div class=\"line\">                            <span class=\"comment\">//重画</span></div><div class=\"line\">                            mFirstView.postInvalidate();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"comment\">//当用户手指抬起时</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态为下拉刷新状态</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH) &#123;</div><div class=\"line\">                        <span class=\"comment\">//平滑的隐藏headerView</span></div><div class=\"line\">                        <span class=\"keyword\">this</span>.smoothScrollBy((<span class=\"keyword\">int</span>)(-headerViewHeight+offsetY/RATIO)+headerViewHeight, <span class=\"number\">500</span>);</div><div class=\"line\">                        <span class=\"comment\">//根据状态改变headerView</span></div><div class=\"line\">                        changeHeaderByState(state);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态为放开刷新</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH) &#123;</div><div class=\"line\">                        <span class=\"comment\">//平滑的滑到正好显示headerView</span></div><div class=\"line\">                        <span class=\"keyword\">this</span>.smoothScrollBy((<span class=\"keyword\">int</span>)(-headerViewHeight+offsetY/RATIO), <span class=\"number\">500</span>);</div><div class=\"line\">                        <span class=\"comment\">//将当前状态设置为正在刷新</span></div><div class=\"line\">                        state = REFRESHING;</div><div class=\"line\">                        <span class=\"comment\">//回调接口的onRefresh方法</span></div><div class=\"line\">                        mOnRefreshListener.onRefresh();</div><div class=\"line\">                        <span class=\"comment\">//根据状态改变headerView</span></div><div class=\"line\">                        changeHeaderByState(state);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//这一套手势执行完，一定别忘了将记录y坐标的isRecord改为false，以便于下一次手势的执行</span></div><div class=\"line\">                    isRecord = <span class=\"keyword\">false</span>;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.onTouchEvent(ev);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 根据状态改变headerView的动画和文字显示</div><div class=\"line\">     * <span class=\"doctag\">@param</span> state</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">changeHeaderByState</span><span class=\"params\">(<span class=\"keyword\">int</span> state)</span></span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (state) &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> DONE:<span class=\"comment\">//如果的隐藏的状态</span></div><div class=\"line\">            <span class=\"comment\">//设置headerView的padding为隐藏</span></div><div class=\"line\">            headerView.setPadding(<span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">            <span class=\"comment\">//第一状态的view显示出来</span></div><div class=\"line\">            mFirstView.setVisibility(View.VISIBLE);</div><div class=\"line\">            <span class=\"comment\">//第二状态的view隐藏起来</span></div><div class=\"line\">            mSecondView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//停止第二状态的动画</span></div><div class=\"line\">            secondAnim.stop();</div><div class=\"line\">            <span class=\"comment\">//第三状态的view隐藏起来</span></div><div class=\"line\">            mThirdView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//停止第三状态的动画</span></div><div class=\"line\">            thirdAnim.stop();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> RELEASE_TO_REFRESH:<span class=\"comment\">//当前状态为放开刷新</span></div><div class=\"line\">            <span class=\"comment\">//文字显示为放开刷新</span></div><div class=\"line\">            tv_pull_to_refresh.setText(<span class=\"string\">\"放开刷新\"</span>);</div><div class=\"line\">            <span class=\"comment\">//第一状态view隐藏起来</span></div><div class=\"line\">            mFirstView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//第二状态view显示出来</span></div><div class=\"line\">            mSecondView.setVisibility(View.VISIBLE);</div><div class=\"line\">            <span class=\"comment\">//播放第二状态的动画</span></div><div class=\"line\">            secondAnim.start();</div><div class=\"line\">            <span class=\"comment\">//第三状态view隐藏起来</span></div><div class=\"line\">            mThirdView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//停止第三状态的动画</span></div><div class=\"line\">            thirdAnim.stop();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> PULL_TO_REFRESH:<span class=\"comment\">//当前状态为下拉刷新</span></div><div class=\"line\">            <span class=\"comment\">//设置文字为下拉刷新</span></div><div class=\"line\">            tv_pull_to_refresh.setText(<span class=\"string\">\"下拉刷新\"</span>);</div><div class=\"line\">            <span class=\"comment\">//第一状态view显示出来</span></div><div class=\"line\">            mFirstView.setVisibility(View.VISIBLE);</div><div class=\"line\">            <span class=\"comment\">//第二状态view隐藏起来</span></div><div class=\"line\">            mSecondView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//第二状态动画停止</span></div><div class=\"line\">            secondAnim.stop();</div><div class=\"line\">            <span class=\"comment\">//第三状态view隐藏起来</span></div><div class=\"line\">            mThirdView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//第三状态动画停止</span></div><div class=\"line\">            thirdAnim.stop();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> REFRESHING:<span class=\"comment\">//当前状态为正在刷新</span></div><div class=\"line\">            <span class=\"comment\">//文字设置为正在刷新</span></div><div class=\"line\">            tv_pull_to_refresh.setText(<span class=\"string\">\"正在刷新\"</span>);</div><div class=\"line\">            <span class=\"comment\">//第一状态view隐藏起来</span></div><div class=\"line\">            mFirstView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//第三状态view显示出来</span></div><div class=\"line\">            mThirdView.setVisibility(View.VISIBLE);</div><div class=\"line\">            <span class=\"comment\">//第二状态view隐藏起来</span></div><div class=\"line\">            mSecondView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//停止第二状态动画</span></div><div class=\"line\">            secondAnim.stop();</div><div class=\"line\">            <span class=\"comment\">//启动第三状态view</span></div><div class=\"line\">            thirdAnim.start();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">default</span>:</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">measureView</span><span class=\"params\">(View child)</span> </span>&#123;</div><div class=\"line\">        ViewGroup.LayoutParams p = child.getLayoutParams();</div><div class=\"line\">        <span class=\"keyword\">if</span> (p == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            p = <span class=\"keyword\">new</span> ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,</div><div class=\"line\">                    ViewGroup.LayoutParams.WRAP_CONTENT);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(<span class=\"number\">0</span>, <span class=\"number\">0</span> + <span class=\"number\">0</span>, p.width);</div><div class=\"line\">        <span class=\"keyword\">int</span> lpHeight = p.height;</div><div class=\"line\">        <span class=\"keyword\">int</span> childHeightSpec;</div><div class=\"line\">        <span class=\"keyword\">if</span> (lpHeight &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,</div><div class=\"line\">                    MeasureSpec.EXACTLY);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            childHeightSpec = MeasureSpec.makeMeasureSpec(<span class=\"number\">0</span>,</div><div class=\"line\">                    MeasureSpec.UNSPECIFIED);</div><div class=\"line\">        &#125;</div><div class=\"line\">        child.measure(childWidthSpec, childHeightSpec);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>代码中已经有了很详细的注释了，看起来应该会比较轻松。</p>\n<h2 id=\"改进\"><a href=\"#改进\" class=\"headerlink\" title=\"改进\"></a>改进</h2><p>写完之后运行，发现有2个地方可以改进。</p>\n<h3 id=\"下拉白块\"><a href=\"#下拉白块\" class=\"headerlink\" title=\"下拉白块\"></a>下拉白块</h3><p>在下拉刷新的时候，若下拉的高度很高，那么松开刷新后，再次下拉，会出现很大的一个空白块，影响视觉。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview4.gif\" alt=\"\"><br>导致该问题的原因是在<code>RELEASE_TO_REFRESH</code>状态下<code>ACTION_UP</code>时，只是利用smoothScrollBy滑动到headerView的显示位置。但是此时，headerView的paddingTop属性依然是<code>ACTION_MOVE</code>中设置的<code>headerView.setPadding(0,(int)(-headerViewHeight+offsetY/RATIO) ,0, 0);</code>，其值跟offsetY有关，offsetY越大，那么paddingTop值就会越大，导致再次下拉会出现很大的空白块。</p>\n<p>改进办法：利用Scroller滑动辅助类替换smoothScrollBy，在滑动的过程中不停设置headerView的paddingTop值。当滑动结束时，headerView的paddingTop正好等于0，即刚刚好显示。</p>\n<h3 id=\"刷新结束后立刻消失\"><a href=\"#刷新结束后立刻消失\" class=\"headerlink\" title=\"刷新结束后立刻消失\"></a>刷新结束后立刻消失</h3><p>刷新结束后，会直接设置headerView的paddingTop为-headerViewHeight，导致headerView立刻不可见，会显得比较突兀。</p>\n<p>改进办法：依然是利用Scroller类滑动辅助类，通过滑动动画使headerView不可见。<br>改进后，我的代码是这样的:<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div><div class=\"line\">295</div><div class=\"line\">296</div><div class=\"line\">297</div><div class=\"line\">298</div><div class=\"line\">299</div><div class=\"line\">300</div><div class=\"line\">301</div><div class=\"line\">302</div><div class=\"line\">303</div><div class=\"line\">304</div><div class=\"line\">305</div><div class=\"line\">306</div><div class=\"line\">307</div><div class=\"line\">308</div><div class=\"line\">309</div><div class=\"line\">310</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RefreshListView</span> <span class=\"keyword\">extends</span> <span class=\"title\">ListView</span> <span class=\"keyword\">implements</span> <span class=\"title\">ListView</span>.<span class=\"title\">OnScrollListener</span> </span>&#123;</div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 刷新四种状态</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> DONE = <span class=\"number\">0</span>; <span class=\"comment\">// 刷新完成</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> PULL_TO_REFRESH = <span class=\"number\">1</span>; <span class=\"comment\">// 下拉刷新</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> RELEASE_TO_REFRESH = <span class=\"number\">2</span>; <span class=\"comment\">// 松开刷新</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> REFRESHING = <span class=\"number\">3</span>; <span class=\"comment\">// 正在刷新</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> RATIO = <span class=\"number\">3</span>; <span class=\"comment\">// 滑动的比例值</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> state; <span class=\"comment\">// 当前的状态</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isRefreshable; <span class=\"comment\">// 是否可刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isRecord; <span class=\"comment\">// 是否开始准备下拉刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> refreshEnd; <span class=\"comment\">// 是否刷新结束</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mFirstVisibleItem; <span class=\"comment\">// 当前第一个可见Item</span></div><div class=\"line\">    <span class=\"keyword\">private</span> LinearLayout headerView; <span class=\"comment\">// 头布局</span></div><div class=\"line\">    <span class=\"keyword\">private</span> TextView refreshText; <span class=\"comment\">// 刷新文字说明</span></div><div class=\"line\">    <span class=\"keyword\">private</span> RefreshFirstView firstView; <span class=\"comment\">// 下拉刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> RefreshSecondView secondView; <span class=\"comment\">// 松开刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> RefreshThirdView thirdView; <span class=\"comment\">// 正在刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> AnimationDrawable secondAnim; <span class=\"comment\">// secondView对应的动画</span></div><div class=\"line\">    <span class=\"keyword\">private</span> AnimationDrawable thirdAnim; <span class=\"comment\">// thirdView对应的动画</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> headerViewHeight; <span class=\"comment\">// 头布局的高度</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> startY; <span class=\"comment\">// 起始Y坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> offsetY; <span class=\"comment\">// Y坐标上的偏移量</span></div><div class=\"line\">    <span class=\"keyword\">private</span> OnRefreshListener refreshListener; <span class=\"comment\">// 回调接口</span></div><div class=\"line\">    <span class=\"comment\">// 滑动类</span></div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller mScroller = <span class=\"keyword\">null</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshListView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshListView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshListView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setRefreshListener</span><span class=\"params\">(OnRefreshListener refreshListener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.refreshListener = refreshListener;</div><div class=\"line\">        isRefreshable = <span class=\"keyword\">true</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 初始化</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> context</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        setOverScrollMode(View.OVER_SCROLL_NEVER);</div><div class=\"line\">        setOnScrollListener(<span class=\"keyword\">this</span>);</div><div class=\"line\"></div><div class=\"line\">        mScroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\"></div><div class=\"line\">        headerView = (LinearLayout) LayoutInflater.from(context).inflate(R.layout.list_header, <span class=\"keyword\">this</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\">        refreshText = (TextView) headerView.findViewById(R.id.pull_to_refresh);</div><div class=\"line\">        firstView = (RefreshFirstView) headerView.findViewById(R.id.first_view);</div><div class=\"line\">        secondView = (RefreshSecondView) headerView.findViewById(R.id.second_view);</div><div class=\"line\">        thirdView = (RefreshThirdView) headerView.findViewById(R.id.third_view);</div><div class=\"line\">        secondAnim = (AnimationDrawable) secondView.getBackground();</div><div class=\"line\">        thirdAnim = (AnimationDrawable) thirdView.getBackground();</div><div class=\"line\"></div><div class=\"line\">        measureView(headerView);</div><div class=\"line\">        addHeaderView(headerView);</div><div class=\"line\">        headerViewHeight = headerView.getMeasuredHeight();</div><div class=\"line\">        headerView.setPadding(<span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">0</span>, <span class=\"number\">0</span>); <span class=\"comment\">// 全局通过设置headerView的paddingTop来控制内部View的显示</span></div><div class=\"line\"></div><div class=\"line\">        state = DONE;</div><div class=\"line\">        isRefreshable = <span class=\"keyword\">false</span>;</div><div class=\"line\">        isRecord = <span class=\"keyword\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (mScroller.computeScrollOffset()) &#123;</div><div class=\"line\">            setPaddingTop(mScroller.getCurrY());</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setPaddingTop</span><span class=\"params\">(<span class=\"keyword\">int</span> paddingTop)</span> </span>&#123;</div><div class=\"line\">        headerView.setPadding(<span class=\"number\">0</span>, paddingTop, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">        headerView.postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScrollStateChanged</span><span class=\"params\">(AbsListView view, <span class=\"keyword\">int</span> scrollState)</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScroll</span><span class=\"params\">(AbsListView view, <span class=\"keyword\">int</span> firstVisibleItem, <span class=\"keyword\">int</span> visibleItemCount, <span class=\"keyword\">int</span> totalItemCount)</span> </span>&#123;</div><div class=\"line\">        mFirstVisibleItem = firstVisibleItem;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isRefreshable) &#123;<span class=\"comment\">//如果现在是可刷新状态   在setOnMeiTuanListener中设置为true</span></div><div class=\"line\">            <span class=\"keyword\">switch</span> (ev.getAction()) &#123;</div><div class=\"line\">                <span class=\"comment\">//用户按下</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                    <span class=\"keyword\">if</span> (mFirstVisibleItem == 0 &amp;&amp; !isRecord) &#123;</div><div class=\"line\">                        <span class=\"comment\">//将isRecord置为true，说明现在已记录y坐标</span></div><div class=\"line\">                        isRecord = <span class=\"keyword\">true</span>;</div><div class=\"line\">                        startY = ev.getY();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"comment\">//用户滑动</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                    //再次得到y坐标，用来和startY相减来计算offsetY位移值</div><div class=\"line\">                    <span class=\"keyword\">float</span> tempY = ev.getY();</div><div class=\"line\">                    <span class=\"comment\">//再判断一次</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (mFirstVisibleItem == <span class=\"number\">0</span> &amp;&amp; !isRecord) &#123;</div><div class=\"line\">                        isRecord = <span class=\"keyword\">true</span>;</div><div class=\"line\">                        startY = tempY;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态不是正在刷新的状态，并且已经记录了y坐标</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state != REFRESHING &amp;&amp; isRecord) &#123;</div><div class=\"line\">                        <span class=\"comment\">//计算y的偏移量</span></div><div class=\"line\">                        offsetY = tempY - startY;</div><div class=\"line\">                        <span class=\"comment\">//计算当前滑动的高度</span></div><div class=\"line\">                        <span class=\"keyword\">float</span> currentHeight = (-headerViewHeight + offsetY / <span class=\"number\">3</span>);</div><div class=\"line\">                        <span class=\"comment\">//用当前滑动的高度和头部headerView的总高度进行比 计算出当前滑动的百分比 0到1</span></div><div class=\"line\">                        <span class=\"keyword\">float</span> currentProgress = <span class=\"number\">1</span> + currentHeight / headerViewHeight;</div><div class=\"line\">                        <span class=\"comment\">//如果当前百分比大于1了，将其设置为1，目的是让第一个状态的椭圆不再继续变大</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (currentProgress &gt;= <span class=\"number\">1</span>) &#123;</div><div class=\"line\">                            currentProgress = <span class=\"number\">1</span>;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前的状态是放开刷新，并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            setSelection(<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//如果当前滑动的距离小于headerView的总高度</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (-headerViewHeight + offsetY / RATIO &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态置为下拉刷新状态</span></div><div class=\"line\">                                state = PULL_TO_REFRESH;</div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                                <span class=\"comment\">//如果当前y的位移值小于0，即为headerView隐藏了</span></div><div class=\"line\">                            &#125; <span class=\"function\"><span class=\"keyword\">else</span> <span class=\"title\">if</span> <span class=\"params\">(offsetY &lt;= <span class=\"number\">0</span>)</span> </span>&#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为done</span></div><div class=\"line\">                                state = DONE;</div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前状态为下拉刷新并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            setSelection(<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//如果下拉距离大于等于headerView的总高度</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (-headerViewHeight + offsetY / RATIO &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为放开刷新</span></div><div class=\"line\">                                state = RELEASE_TO_REFRESH;</div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                                <span class=\"comment\">//如果当前y的位移值小于0，即为headerView隐藏了</span></div><div class=\"line\">                            &#125; <span class=\"function\"><span class=\"keyword\">else</span> <span class=\"title\">if</span> <span class=\"params\">(offsetY &lt;= <span class=\"number\">0</span>)</span> </span>&#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为done</span></div><div class=\"line\">                                state = DONE;</div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前状态为done并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == DONE &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            <span class=\"comment\">//如果位移值大于0</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (offsetY &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态改为下拉刷新状态</span></div><div class=\"line\">                                state = PULL_TO_REFRESH;</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果为下拉刷新状态</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH) &#123;</div><div class=\"line\">                            <span class=\"comment\">//则改变headerView的padding来实现下拉的效果</span></div><div class=\"line\">                            headerView.setPadding(<span class=\"number\">0</span>, (<span class=\"keyword\">int</span>) (-headerViewHeight + offsetY / RATIO), <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//给第一个状态的View设置当前进度值</span></div><div class=\"line\">                            firstView.setCurrentProgress(currentProgress);</div><div class=\"line\">                            <span class=\"comment\">//重画</span></div><div class=\"line\">                            firstView.postInvalidate();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果为放开刷新状态</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH) &#123;</div><div class=\"line\">                            <span class=\"comment\">//改变headerView的padding值</span></div><div class=\"line\">                            headerView.setPadding(<span class=\"number\">0</span>, (<span class=\"keyword\">int</span>) (-headerViewHeight + offsetY / RATIO), <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//给第一个状态的View设置当前进度值</span></div><div class=\"line\">                            firstView.setCurrentProgress(currentProgress);</div><div class=\"line\">                            <span class=\"comment\">//重画</span></div><div class=\"line\">                            firstView.postInvalidate();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"keyword\">default</span>:</div><div class=\"line\">                    //如果当前状态为下拉刷新状态</div><div class=\"line\">                    <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH) &#123;</div><div class=\"line\">                        <span class=\"comment\">//平滑的隐藏headerView</span></div><div class=\"line\">                        <span class=\"keyword\">this</span>.smoothScrollBy((<span class=\"keyword\">int</span>) (-headerViewHeight + offsetY / RATIO) + headerViewHeight, <span class=\"number\">500</span>);</div><div class=\"line\">                        changeHeaderByState(state);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态为放开刷新</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH) &#123;</div><div class=\"line\">                        <span class=\"comment\">//平滑的滑到正好显示headerView</span></div><div class=\"line\"><span class=\"comment\">//                        this.smoothScrollBy((int) (-headerViewHeight + offsetY / RATIO), 500);</span></div><div class=\"line\">                        mScroller.startScroll(<span class=\"number\">0</span>, (<span class=\"keyword\">int</span>) (-headerViewHeight + offsetY / RATIO), <span class=\"number\">0</span>, (<span class=\"keyword\">int</span>) (headerViewHeight - offsetY / RATIO), <span class=\"number\">500</span>);</div><div class=\"line\">                        <span class=\"comment\">//将当前状态设置为正在刷新</span></div><div class=\"line\">                        state = REFRESHING;</div><div class=\"line\">                        <span class=\"comment\">//回调接口的onRefresh方法</span></div><div class=\"line\">                        changeHeaderByState(state);</div><div class=\"line\">                        <span class=\"keyword\">if</span> (refreshListener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                            refreshListener.onRefresh();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//一套操作执行完，重置状态</span></div><div class=\"line\">                    isRecord = <span class=\"keyword\">false</span>;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 根据state改变HeaderView</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> state</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">changeHeaderByState</span><span class=\"params\">(<span class=\"keyword\">int</span> state)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (state) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> DONE:</div><div class=\"line\">                <span class=\"keyword\">if</span> (refreshEnd) &#123; <span class=\"comment\">// 如果是刷新结束，则慢慢滚动消失</span></div><div class=\"line\">                    mScroller.startScroll(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">500</span>);</div><div class=\"line\">                    refreshEnd = <span class=\"keyword\">false</span>;</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    headerView.setPadding(<span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">                firstView.setVisibility(VISIBLE);</div><div class=\"line\">                secondView.setVisibility(GONE);</div><div class=\"line\">                secondAnim.stop();</div><div class=\"line\">                thirdView.setVisibility(GONE);</div><div class=\"line\">                thirdAnim.stop();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> PULL_TO_REFRESH:</div><div class=\"line\">                refreshText.setText(<span class=\"string\">\"下拉刷新\"</span>);</div><div class=\"line\">                firstView.setVisibility(View.VISIBLE);</div><div class=\"line\">                secondView.setVisibility(View.GONE);</div><div class=\"line\">                secondAnim.stop();</div><div class=\"line\">                thirdView.setVisibility(View.GONE);</div><div class=\"line\">                thirdAnim.stop();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> RELEASE_TO_REFRESH:</div><div class=\"line\">                refreshText.setText(<span class=\"string\">\"放开刷新\"</span>);</div><div class=\"line\">                firstView.setVisibility(View.GONE);</div><div class=\"line\">                secondView.setVisibility(View.VISIBLE);</div><div class=\"line\">                secondAnim.start();</div><div class=\"line\">                thirdView.setVisibility(View.GONE);</div><div class=\"line\">                thirdAnim.stop();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> REFRESHING:</div><div class=\"line\">                refreshText.setText(<span class=\"string\">\"正在刷新\"</span>);</div><div class=\"line\">                firstView.setVisibility(View.GONE);</div><div class=\"line\">                thirdView.setVisibility(View.VISIBLE);</div><div class=\"line\">                secondView.setVisibility(View.GONE);</div><div class=\"line\">                secondAnim.stop();</div><div class=\"line\">                thirdAnim.start();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">default</span>:</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\"></div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 在init时View尚未绘制，为了获取HeaderView的高度，需要此方法提前绘制</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> child</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">measureView</span><span class=\"params\">(View child)</span> </span>&#123;</div><div class=\"line\">        ViewGroup.LayoutParams p = child.getLayoutParams();</div><div class=\"line\">        <span class=\"keyword\">if</span> (p == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            p = <span class=\"keyword\">new</span> ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,</div><div class=\"line\">                    ViewGroup.LayoutParams.WRAP_CONTENT);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(<span class=\"number\">0</span>, <span class=\"number\">0</span> + <span class=\"number\">0</span>, p.width);</div><div class=\"line\">        <span class=\"keyword\">int</span> lpHeight = p.height;</div><div class=\"line\">        <span class=\"keyword\">int</span> childHeightSpec;</div><div class=\"line\">        <span class=\"keyword\">if</span> (lpHeight &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,</div><div class=\"line\">                    MeasureSpec.EXACTLY);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            childHeightSpec = MeasureSpec.makeMeasureSpec(<span class=\"number\">0</span>,</div><div class=\"line\">                    MeasureSpec.UNSPECIFIED);</div><div class=\"line\">        &#125;</div><div class=\"line\">        child.measure(childWidthSpec, childHeightSpec);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 刷新结束后的回调，重置状态</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setOnRefreshComplete</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        state = DONE;</div><div class=\"line\">        refreshEnd = <span class=\"keyword\">true</span>;</div><div class=\"line\">        changeHeaderByState(state);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 刷新回调接口</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnRefreshListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onRefresh</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"讨论\"><a href=\"#讨论\" class=\"headerlink\" title=\"讨论\"></a>讨论</h2><p>在原博客中有这样的讨论：setOnRefreshComplete没必要暴露，隐藏在ListView里面更好。</p>\n<p>个人觉得也确实是这样，我们使用下拉刷新只会关心onRefresh，对于setOnRefreshComplete是不关心的。<br>但是setOnRefreshComplete是必须要在onRefresh执行完之后才会执行，对于ListView它是不知道onRefresh在何时结束的，所以如果非要隐藏setOnRefreshComplete，我暂时没想到好的实现方案。</p>\n<p>后面我找了一下下拉刷新相关的库，都有类似setOnRefreshComplete的方法。<br>XListView：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview1.png\" alt=\"\"><br>SwipeRefreshLayout:<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview2.png\" alt=\"\"><br>希望有想法的大神不吝赐教~</p>\n<h2 id=\"感受\"><a href=\"#感受\" class=\"headerlink\" title=\"感受\"></a>感受</h2><ol>\n<li>对于自己记忆中模棱两可的知识一定要自己动手做一遍，以加深印象。</li>\n<li>可以通过缩放canvas，来实现自定义view的缩放。</li>\n<li>通过设置paddingTop值来控制headerView的显示。</li>\n<li><p>在查看XListView相关源码的时候，发现它是这样在View还没显示的时候获取高度的：</p>\n<figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">mHeaderView.getViewTreeObserver().addOnGlobalLayoutListener(</div><div class=\"line\">\t\t<span class=\"keyword\">new</span> OnGlobalLayoutListener() &#123;</div><div class=\"line\">\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onGlobalLayout</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\t\tmHeaderViewHeight = mHeaderViewContent.getHeight();</div><div class=\"line\">\t\t\tgetViewTreeObserver().removeGlobalOnLayoutListener(<span class=\"keyword\">this</span>);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n</li>\n<li><p>onTouchEvent里的事件处理是非常繁杂的，当时自己写滑动删除的ListView时也重写过onTouchEvent，一定要细心。</p>\n</li>\n</ol>\n<h2 id=\"我的代码\"><a href=\"#我的代码\" class=\"headerlink\" title=\"我的代码\"></a>我的代码</h2><p>代码已上传至<a href=\"https://github.com/LiJia92/MyRefreshListView\" target=\"_blank\" rel=\"external\">我的Github</a>。</p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"http://blog.csdn.net/nugongahou110/article/details/49557875\" target=\"_blank\" rel=\"external\">Android自定义控件之仿美团下拉刷新</a></p>\n","excerpt":"<p>在之前看过一篇文章<a href=\"http://blog.csdn.net/nugongahou110/article/details/49557875\">Android自定义控件之仿美团下拉刷新</a>，就是实现仿美团下拉刷新。一直对ListView等控件的下拉刷新的了解程度，可能也就停留在<code>用HeaderView来实现，然后重写onTouchEvent</code>，但是具体应该是怎样的呢？一直没有实际动手自己写过，于是抽空自己照着这篇博客自己写了一遍，以加深自己的理解。我对原博客进行摘录，重点写出一些对自己帮助大的内容。</p>\n<h2 id=\"刷新状态\"><a href=\"#刷新状态\" class=\"headerlink\" title=\"刷新状态\"></a>刷新状态</h2><p>一般下拉刷新应该都是会有三种状态：下拉刷新、松开刷新、正在刷新。</p>\n<h3 id=\"下拉刷新\"><a href=\"#下拉刷新\" class=\"headerlink\" title=\"下拉刷新\"></a>下拉刷新</h3><p>实现思路：自定义View，通过设置进度值进行缩放。<br>用SeekBar来模仿一下下拉距离的进度。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview3.gif\" alt=\"\"></p>","more":"<p>自定义View代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RefreshFirstView</span> <span class=\"keyword\">extends</span> <span class=\"title\">View</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> Bitmap firstBitmap;</div><div class=\"line\">    <span class=\"keyword\">private</span> Bitmap endBitmap;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> mCurrentProgress;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> measuredWidth;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> measuredHeight;</div><div class=\"line\">    <span class=\"keyword\">private</span> Bitmap scaledBitmap;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshFirstView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshFirstView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshFirstView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        firstBitmap = Bitmap.createBitmap(BitmapFactory.decodeResource(context.getResources(), R.drawable.pull_image));</div><div class=\"line\">        endBitmap = Bitmap.createBitmap(BitmapFactory.decodeResource(getResources(), R.drawable.pull_end_image_frame_05));</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onMeasure</span><span class=\"params\">(<span class=\"keyword\">int</span> widthMeasureSpec, <span class=\"keyword\">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class=\"line\">        setMeasuredDimension(measureWidth(widthMeasureSpec), measureWidth(widthMeasureSpec) * endBitmap.getHeight() / endBitmap.getWidth());</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onLayout</span><span class=\"params\">(<span class=\"keyword\">boolean</span> changed, <span class=\"keyword\">int</span> left, <span class=\"keyword\">int</span> top, <span class=\"keyword\">int</span> right,</div><div class=\"line\">                            <span class=\"keyword\">int</span> bottom)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onLayout(changed, left, top, right, bottom);</div><div class=\"line\">        measuredWidth = getMeasuredWidth();</div><div class=\"line\">        measuredHeight = getMeasuredHeight();</div><div class=\"line\">        <span class=\"comment\">//根据第二阶段娃娃宽高  给椭圆形图片进行等比例的缩放</span></div><div class=\"line\">        scaledBitmap = Bitmap.createScaledBitmap(firstBitmap, measuredWidth, measuredWidth * firstBitmap.getHeight() / firstBitmap.getWidth(), <span class=\"keyword\">true</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">measureWidth</span><span class=\"params\">(<span class=\"keyword\">int</span> widMeasureSpec)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">int</span> result;</div><div class=\"line\">        <span class=\"keyword\">int</span> size = MeasureSpec.getSize(widMeasureSpec);</div><div class=\"line\">        <span class=\"keyword\">int</span> mode = MeasureSpec.getMode(widMeasureSpec);</div><div class=\"line\">        <span class=\"keyword\">if</span> (mode == MeasureSpec.EXACTLY) &#123;</div><div class=\"line\">            result = size;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            result = endBitmap.getWidth();</div><div class=\"line\">            <span class=\"keyword\">if</span> (mode == MeasureSpec.AT_MOST) &#123;</div><div class=\"line\">                result = Math.min(result, size);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> result;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">        <span class=\"comment\">// 通过画布缩放，控制View缩放</span></div><div class=\"line\">        canvas.scale(mCurrentProgress, mCurrentProgress, measuredWidth / <span class=\"number\">2</span>, measuredHeight / <span class=\"number\">2</span>);</div><div class=\"line\">        canvas.drawBitmap(scaledBitmap, <span class=\"number\">0</span>, measuredHeight / <span class=\"number\">4</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setCurrentProgress</span><span class=\"params\">(<span class=\"keyword\">float</span> currentProgress)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.mCurrentProgress = currentProgress;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h3 id=\"松开刷新\"><a href=\"#松开刷新\" class=\"headerlink\" title=\"松开刷新\"></a>松开刷新</h3><p>这里主要是一个帧动画。<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">animation-list</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:oneshot</span>=<span class=\"string\">\"true\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_01\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_02\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_03\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_04\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span></div><div class=\"line\">        <span class=\"attr\">android:drawable</span>=<span class=\"string\">\"@drawable/pull_end_image_frame_05\"</span></div><div class=\"line\">        <span class=\"attr\">android:duration</span>=<span class=\"string\">\"100\"</span> /&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">animation-list</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<h3 id=\"正在刷新\"><a href=\"#正在刷新\" class=\"headerlink\" title=\"正在刷新\"></a>正在刷新</h3><p>与松开刷新一样，也是一个帧动画，这里便不做赘述。</p>\n<p>三种状态通过自定义View，重写onMeasure来确保三个状态的View的宽高保持一致。</p>\n<h2 id=\"下拉刷新的实现\"><a href=\"#下拉刷新的实现\" class=\"headerlink\" title=\"下拉刷新的实现\"></a>下拉刷新的实现</h2><p>先贴一下原博客的代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div><div class=\"line\">295</div><div class=\"line\">296</div><div class=\"line\">297</div><div class=\"line\">298</div><div class=\"line\">299</div><div class=\"line\">300</div><div class=\"line\">301</div><div class=\"line\">302</div><div class=\"line\">303</div><div class=\"line\">304</div><div class=\"line\">305</div><div class=\"line\">306</div><div class=\"line\">307</div><div class=\"line\">308</div><div class=\"line\">309</div><div class=\"line\">310</div><div class=\"line\">311</div><div class=\"line\">312</div><div class=\"line\">313</div><div class=\"line\">314</div><div class=\"line\">315</div><div class=\"line\">316</div><div class=\"line\">317</div><div class=\"line\">318</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MeiTuanListView</span> <span class=\"keyword\">extends</span> <span class=\"title\">ListView</span> <span class=\"keyword\">implements</span> <span class=\"title\">AbsListView</span>.<span class=\"title\">OnScrollListener</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DONE = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> PULL_TO_REFRESH = <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> RELEASE_TO_REFRESH = <span class=\"number\">2</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> REFRESHING = <span class=\"number\">3</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> RATIO = <span class=\"number\">3</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> LinearLayout headerView;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> headerViewHeight;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> startY;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> offsetY;</div><div class=\"line\">    <span class=\"keyword\">private</span> TextView tv_pull_to_refresh;</div><div class=\"line\">    <span class=\"keyword\">private</span> OnMeiTuanRefreshListener mOnRefreshListener;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> state;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mFirstVisibleItem;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isRecord;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isEnd;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isRefreable;</div><div class=\"line\">    <span class=\"keyword\">private</span> FrameLayout mAnimContainer;</div><div class=\"line\">    <span class=\"keyword\">private</span> Animation animation;</div><div class=\"line\">    <span class=\"keyword\">private</span> SimpleDateFormat format;</div><div class=\"line\">    <span class=\"keyword\">private</span> MeiTuanRefreshFirstStepView mFirstView;</div><div class=\"line\">    <span class=\"keyword\">private</span> MeiTuanRefreshSecondStepView mSecondView;</div><div class=\"line\">    <span class=\"keyword\">private</span> AnimationDrawable secondAnim;</div><div class=\"line\">    <span class=\"keyword\">private</span> MeiTuanRefreshThirdStepView mThirdView;</div><div class=\"line\">    <span class=\"keyword\">private</span> AnimationDrawable thirdAnim;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MeiTuanListView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MeiTuanListView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MeiTuanListView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnMeiTuanRefreshListener</span></span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onRefresh</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 回调接口，想实现下拉刷新的listview实现此接口</div><div class=\"line\">     * <span class=\"doctag\">@param</span> onRefreshListener</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setOnMeiTuanRefreshListener</span><span class=\"params\">(OnMeiTuanRefreshListener onRefreshListener)</span></span>&#123;</div><div class=\"line\">        mOnRefreshListener = onRefreshListener;</div><div class=\"line\">        isRefreable = <span class=\"keyword\">true</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 刷新完毕，从主线程发送过来，并且改变headerView的状态和文字动画信息</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setOnRefreshComplete</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">        <span class=\"comment\">//一定要将isEnd设置为true，以便于下次的下拉刷新</span></div><div class=\"line\">        isEnd = <span class=\"keyword\">true</span>;</div><div class=\"line\">        state = DONE;</div><div class=\"line\"></div><div class=\"line\">        changeHeaderByState(state);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        setOverScrollMode(View.OVER_SCROLL_NEVER);</div><div class=\"line\">        setOnScrollListener(<span class=\"keyword\">this</span>);</div><div class=\"line\"></div><div class=\"line\">        headerView = (LinearLayout) LayoutInflater.from(context).inflate(R.layout.meituan_item, <span class=\"keyword\">null</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\">        mFirstView = (MeiTuanRefreshFirstStepView) headerView.findViewById(R.id.first_view);</div><div class=\"line\">        tv_pull_to_refresh = (TextView) headerView.findViewById(R.id.tv_pull_to_refresh);</div><div class=\"line\">        mSecondView = (MeiTuanRefreshSecondStepView) headerView.findViewById(R.id.second_view);</div><div class=\"line\">        mSecondView.setBackgroundResource(R.drawable.pull_to_refresh_second_anim);</div><div class=\"line\">        secondAnim = (AnimationDrawable) mSecondView.getBackground();</div><div class=\"line\">        mThirdView = (MeiTuanRefreshThirdStepView) headerView.findViewById(R.id.third_view);</div><div class=\"line\">        mThirdView.setBackgroundResource(R.drawable.pull_to_refresh_third_anim);</div><div class=\"line\">        thirdAnim = (AnimationDrawable) mThirdView.getBackground();</div><div class=\"line\"></div><div class=\"line\">        measureView(headerView);</div><div class=\"line\">        addHeaderView(headerView);</div><div class=\"line\">        headerViewHeight = headerView.getMeasuredHeight();</div><div class=\"line\">        headerView.setPadding(<span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">        Log.i(<span class=\"string\">\"zhangqi\"</span>,<span class=\"string\">\"headerViewHeight=\"</span>+headerViewHeight);</div><div class=\"line\"></div><div class=\"line\">        state = DONE;</div><div class=\"line\">        isEnd = <span class=\"keyword\">true</span>;</div><div class=\"line\">        isRefreable = <span class=\"keyword\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onScrollStateChanged</span><span class=\"params\">(AbsListView absListView, <span class=\"keyword\">int</span> i)</span> </span>&#123;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onScroll</span><span class=\"params\">(AbsListView absListView, <span class=\"keyword\">int</span> firstVisibleItem, <span class=\"keyword\">int</span> visibleItemCount, <span class=\"keyword\">int</span> totalItemCount)</span> </span>&#123;</div><div class=\"line\">        mFirstVisibleItem = firstVisibleItem;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isEnd) &#123;<span class=\"comment\">//如果现在时结束的状态，即刷新完毕了，可以再次刷新了，在onRefreshComplete中设置</span></div><div class=\"line\">            <span class=\"keyword\">if</span> (isRefreable) &#123;<span class=\"comment\">//如果现在是可刷新状态   在setOnMeiTuanListener中设置为true</span></div><div class=\"line\">                <span class=\"keyword\">switch</span> (ev.getAction())&#123;</div><div class=\"line\">                    <span class=\"comment\">//用户按下</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                    <span class=\"comment\">//如果当前是在listview顶部并且没有记录y坐标</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (mFirstVisibleItem == <span class=\"number\">0</span> &amp;&amp; !isRecord) &#123;</div><div class=\"line\">                        <span class=\"comment\">//将isRecord置为true，说明现在已记录y坐标</span></div><div class=\"line\">                        isRecord = <span class=\"keyword\">true</span>;</div><div class=\"line\">                        <span class=\"comment\">//将当前y坐标赋值给startY起始y坐标</span></div><div class=\"line\">                        startY = ev.getY();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"comment\">//用户滑动</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                    <span class=\"comment\">//再次得到y坐标，用来和startY相减来计算offsetY位移值</span></div><div class=\"line\">                    <span class=\"keyword\">float</span> tempY = ev.getY();</div><div class=\"line\">                    <span class=\"comment\">//再起判断一下是否为listview顶部并且没有记录y坐标</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (mFirstVisibleItem == <span class=\"number\">0</span> &amp;&amp; !isRecord) &#123;</div><div class=\"line\">                        isRecord = <span class=\"keyword\">true</span>;</div><div class=\"line\">                        startY = tempY;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态不是正在刷新的状态，并且已经记录了y坐标</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state!=REFRESHING &amp;&amp; isRecord ) &#123;</div><div class=\"line\">                        <span class=\"comment\">//计算y的偏移量</span></div><div class=\"line\">                        offsetY = tempY - startY;</div><div class=\"line\">                        <span class=\"comment\">//计算当前滑动的高度</span></div><div class=\"line\">                        <span class=\"keyword\">float</span> currentHeight = (-headerViewHeight+offsetY/<span class=\"number\">3</span>);</div><div class=\"line\">                        <span class=\"comment\">//用当前滑动的高度和头部headerView的总高度进行比 计算出当前滑动的百分比 0到1</span></div><div class=\"line\">                        <span class=\"keyword\">float</span> currentProgress = <span class=\"number\">1</span>+currentHeight/headerViewHeight;</div><div class=\"line\">                        <span class=\"comment\">//如果当前百分比大于1了，将其设置为1，目的是让第一个状态的椭圆不再继续变大</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (currentProgress&gt;=<span class=\"number\">1</span>) &#123;</div><div class=\"line\">                            currentProgress = <span class=\"number\">1</span>;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前的状态是放开刷新，并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            setSelection(<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//如果当前滑动的距离小于headerView的总高度</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (-headerViewHeight+offsetY/RATIO&lt;<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态置为下拉刷新状态</span></div><div class=\"line\">                                state = PULL_TO_REFRESH;</div><div class=\"line\">                                <span class=\"comment\">//根据状态改变headerView，主要是更新动画和文字等信息</span></div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                                <span class=\"comment\">//如果当前y的位移值小于0，即为headerView隐藏了</span></div><div class=\"line\">                            &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offsetY&lt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为done</span></div><div class=\"line\">                                state = DONE;</div><div class=\"line\">                                <span class=\"comment\">//根据状态改变headerView，主要是更新动画和文字等信息</span></div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前状态为下拉刷新并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            setSelection(<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//如果下拉距离大于等于headerView的总高度</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (-headerViewHeight+offsetY/RATIO&gt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为放开刷新</span></div><div class=\"line\">                                state = RELEASE_TO_REFRESH;</div><div class=\"line\">                                <span class=\"comment\">//根据状态改变headerView，主要是更新动画和文字等信息</span></div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                                <span class=\"comment\">//如果当前y的位移值小于0，即为headerView隐藏了</span></div><div class=\"line\">                            &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (offsetY&lt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为done</span></div><div class=\"line\">                                state = DONE;</div><div class=\"line\">                                <span class=\"comment\">//根据状态改变headerView，主要是更新动画和文字等信息</span></div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前状态为done并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == DONE &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            <span class=\"comment\">//如果位移值大于0</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (offsetY&gt;=<span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态改为下拉刷新状态</span></div><div class=\"line\">                                state = PULL_TO_REFRESH;</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果为下拉刷新状态</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH) &#123;</div><div class=\"line\">                            <span class=\"comment\">//则改变headerView的padding来实现下拉的效果</span></div><div class=\"line\">                            headerView.setPadding(<span class=\"number\">0</span>,(<span class=\"keyword\">int</span>)(-headerViewHeight+offsetY/RATIO) ,<span class=\"number\">0</span>,<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//给第一个状态的View设置当前进度值</span></div><div class=\"line\">                            mFirstView.setCurrentProgress(currentProgress);</div><div class=\"line\">                            <span class=\"comment\">//重画</span></div><div class=\"line\">                            mFirstView.postInvalidate();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果为放开刷新状态</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH) &#123;</div><div class=\"line\">                            <span class=\"comment\">//改变headerView的padding值</span></div><div class=\"line\">                            headerView.setPadding(<span class=\"number\">0</span>,(<span class=\"keyword\">int</span>)(-headerViewHeight+offsetY/RATIO) ,<span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//给第一个状态的View设置当前进度值</span></div><div class=\"line\">                            mFirstView.setCurrentProgress(currentProgress);</div><div class=\"line\">                            <span class=\"comment\">//重画</span></div><div class=\"line\">                            mFirstView.postInvalidate();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"comment\">//当用户手指抬起时</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态为下拉刷新状态</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH) &#123;</div><div class=\"line\">                        <span class=\"comment\">//平滑的隐藏headerView</span></div><div class=\"line\">                        <span class=\"keyword\">this</span>.smoothScrollBy((<span class=\"keyword\">int</span>)(-headerViewHeight+offsetY/RATIO)+headerViewHeight, <span class=\"number\">500</span>);</div><div class=\"line\">                        <span class=\"comment\">//根据状态改变headerView</span></div><div class=\"line\">                        changeHeaderByState(state);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态为放开刷新</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH) &#123;</div><div class=\"line\">                        <span class=\"comment\">//平滑的滑到正好显示headerView</span></div><div class=\"line\">                        <span class=\"keyword\">this</span>.smoothScrollBy((<span class=\"keyword\">int</span>)(-headerViewHeight+offsetY/RATIO), <span class=\"number\">500</span>);</div><div class=\"line\">                        <span class=\"comment\">//将当前状态设置为正在刷新</span></div><div class=\"line\">                        state = REFRESHING;</div><div class=\"line\">                        <span class=\"comment\">//回调接口的onRefresh方法</span></div><div class=\"line\">                        mOnRefreshListener.onRefresh();</div><div class=\"line\">                        <span class=\"comment\">//根据状态改变headerView</span></div><div class=\"line\">                        changeHeaderByState(state);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//这一套手势执行完，一定别忘了将记录y坐标的isRecord改为false，以便于下一次手势的执行</span></div><div class=\"line\">                    isRecord = <span class=\"keyword\">false</span>;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.onTouchEvent(ev);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 根据状态改变headerView的动画和文字显示</div><div class=\"line\">     * <span class=\"doctag\">@param</span> state</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">changeHeaderByState</span><span class=\"params\">(<span class=\"keyword\">int</span> state)</span></span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (state) &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> DONE:<span class=\"comment\">//如果的隐藏的状态</span></div><div class=\"line\">            <span class=\"comment\">//设置headerView的padding为隐藏</span></div><div class=\"line\">            headerView.setPadding(<span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">            <span class=\"comment\">//第一状态的view显示出来</span></div><div class=\"line\">            mFirstView.setVisibility(View.VISIBLE);</div><div class=\"line\">            <span class=\"comment\">//第二状态的view隐藏起来</span></div><div class=\"line\">            mSecondView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//停止第二状态的动画</span></div><div class=\"line\">            secondAnim.stop();</div><div class=\"line\">            <span class=\"comment\">//第三状态的view隐藏起来</span></div><div class=\"line\">            mThirdView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//停止第三状态的动画</span></div><div class=\"line\">            thirdAnim.stop();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> RELEASE_TO_REFRESH:<span class=\"comment\">//当前状态为放开刷新</span></div><div class=\"line\">            <span class=\"comment\">//文字显示为放开刷新</span></div><div class=\"line\">            tv_pull_to_refresh.setText(<span class=\"string\">\"放开刷新\"</span>);</div><div class=\"line\">            <span class=\"comment\">//第一状态view隐藏起来</span></div><div class=\"line\">            mFirstView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//第二状态view显示出来</span></div><div class=\"line\">            mSecondView.setVisibility(View.VISIBLE);</div><div class=\"line\">            <span class=\"comment\">//播放第二状态的动画</span></div><div class=\"line\">            secondAnim.start();</div><div class=\"line\">            <span class=\"comment\">//第三状态view隐藏起来</span></div><div class=\"line\">            mThirdView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//停止第三状态的动画</span></div><div class=\"line\">            thirdAnim.stop();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> PULL_TO_REFRESH:<span class=\"comment\">//当前状态为下拉刷新</span></div><div class=\"line\">            <span class=\"comment\">//设置文字为下拉刷新</span></div><div class=\"line\">            tv_pull_to_refresh.setText(<span class=\"string\">\"下拉刷新\"</span>);</div><div class=\"line\">            <span class=\"comment\">//第一状态view显示出来</span></div><div class=\"line\">            mFirstView.setVisibility(View.VISIBLE);</div><div class=\"line\">            <span class=\"comment\">//第二状态view隐藏起来</span></div><div class=\"line\">            mSecondView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//第二状态动画停止</span></div><div class=\"line\">            secondAnim.stop();</div><div class=\"line\">            <span class=\"comment\">//第三状态view隐藏起来</span></div><div class=\"line\">            mThirdView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//第三状态动画停止</span></div><div class=\"line\">            thirdAnim.stop();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> REFRESHING:<span class=\"comment\">//当前状态为正在刷新</span></div><div class=\"line\">            <span class=\"comment\">//文字设置为正在刷新</span></div><div class=\"line\">            tv_pull_to_refresh.setText(<span class=\"string\">\"正在刷新\"</span>);</div><div class=\"line\">            <span class=\"comment\">//第一状态view隐藏起来</span></div><div class=\"line\">            mFirstView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//第三状态view显示出来</span></div><div class=\"line\">            mThirdView.setVisibility(View.VISIBLE);</div><div class=\"line\">            <span class=\"comment\">//第二状态view隐藏起来</span></div><div class=\"line\">            mSecondView.setVisibility(View.GONE);</div><div class=\"line\">            <span class=\"comment\">//停止第二状态动画</span></div><div class=\"line\">            secondAnim.stop();</div><div class=\"line\">            <span class=\"comment\">//启动第三状态view</span></div><div class=\"line\">            thirdAnim.start();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">default</span>:</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">measureView</span><span class=\"params\">(View child)</span> </span>&#123;</div><div class=\"line\">        ViewGroup.LayoutParams p = child.getLayoutParams();</div><div class=\"line\">        <span class=\"keyword\">if</span> (p == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            p = <span class=\"keyword\">new</span> ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,</div><div class=\"line\">                    ViewGroup.LayoutParams.WRAP_CONTENT);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(<span class=\"number\">0</span>, <span class=\"number\">0</span> + <span class=\"number\">0</span>, p.width);</div><div class=\"line\">        <span class=\"keyword\">int</span> lpHeight = p.height;</div><div class=\"line\">        <span class=\"keyword\">int</span> childHeightSpec;</div><div class=\"line\">        <span class=\"keyword\">if</span> (lpHeight &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,</div><div class=\"line\">                    MeasureSpec.EXACTLY);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            childHeightSpec = MeasureSpec.makeMeasureSpec(<span class=\"number\">0</span>,</div><div class=\"line\">                    MeasureSpec.UNSPECIFIED);</div><div class=\"line\">        &#125;</div><div class=\"line\">        child.measure(childWidthSpec, childHeightSpec);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>代码中已经有了很详细的注释了，看起来应该会比较轻松。</p>\n<h2 id=\"改进\"><a href=\"#改进\" class=\"headerlink\" title=\"改进\"></a>改进</h2><p>写完之后运行，发现有2个地方可以改进。</p>\n<h3 id=\"下拉白块\"><a href=\"#下拉白块\" class=\"headerlink\" title=\"下拉白块\"></a>下拉白块</h3><p>在下拉刷新的时候，若下拉的高度很高，那么松开刷新后，再次下拉，会出现很大的一个空白块，影响视觉。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview4.gif\" alt=\"\"><br>导致该问题的原因是在<code>RELEASE_TO_REFRESH</code>状态下<code>ACTION_UP</code>时，只是利用smoothScrollBy滑动到headerView的显示位置。但是此时，headerView的paddingTop属性依然是<code>ACTION_MOVE</code>中设置的<code>headerView.setPadding(0,(int)(-headerViewHeight+offsetY/RATIO) ,0, 0);</code>，其值跟offsetY有关，offsetY越大，那么paddingTop值就会越大，导致再次下拉会出现很大的空白块。</p>\n<p>改进办法：利用Scroller滑动辅助类替换smoothScrollBy，在滑动的过程中不停设置headerView的paddingTop值。当滑动结束时，headerView的paddingTop正好等于0，即刚刚好显示。</p>\n<h3 id=\"刷新结束后立刻消失\"><a href=\"#刷新结束后立刻消失\" class=\"headerlink\" title=\"刷新结束后立刻消失\"></a>刷新结束后立刻消失</h3><p>刷新结束后，会直接设置headerView的paddingTop为-headerViewHeight，导致headerView立刻不可见，会显得比较突兀。</p>\n<p>改进办法：依然是利用Scroller类滑动辅助类，通过滑动动画使headerView不可见。<br>改进后，我的代码是这样的:<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div><div class=\"line\">295</div><div class=\"line\">296</div><div class=\"line\">297</div><div class=\"line\">298</div><div class=\"line\">299</div><div class=\"line\">300</div><div class=\"line\">301</div><div class=\"line\">302</div><div class=\"line\">303</div><div class=\"line\">304</div><div class=\"line\">305</div><div class=\"line\">306</div><div class=\"line\">307</div><div class=\"line\">308</div><div class=\"line\">309</div><div class=\"line\">310</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RefreshListView</span> <span class=\"keyword\">extends</span> <span class=\"title\">ListView</span> <span class=\"keyword\">implements</span> <span class=\"title\">ListView</span>.<span class=\"title\">OnScrollListener</span> </span>&#123;</div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 刷新四种状态</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> DONE = <span class=\"number\">0</span>; <span class=\"comment\">// 刷新完成</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> PULL_TO_REFRESH = <span class=\"number\">1</span>; <span class=\"comment\">// 下拉刷新</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> RELEASE_TO_REFRESH = <span class=\"number\">2</span>; <span class=\"comment\">// 松开刷新</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> REFRESHING = <span class=\"number\">3</span>; <span class=\"comment\">// 正在刷新</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> RATIO = <span class=\"number\">3</span>; <span class=\"comment\">// 滑动的比例值</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> state; <span class=\"comment\">// 当前的状态</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isRefreshable; <span class=\"comment\">// 是否可刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isRecord; <span class=\"comment\">// 是否开始准备下拉刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> refreshEnd; <span class=\"comment\">// 是否刷新结束</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mFirstVisibleItem; <span class=\"comment\">// 当前第一个可见Item</span></div><div class=\"line\">    <span class=\"keyword\">private</span> LinearLayout headerView; <span class=\"comment\">// 头布局</span></div><div class=\"line\">    <span class=\"keyword\">private</span> TextView refreshText; <span class=\"comment\">// 刷新文字说明</span></div><div class=\"line\">    <span class=\"keyword\">private</span> RefreshFirstView firstView; <span class=\"comment\">// 下拉刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> RefreshSecondView secondView; <span class=\"comment\">// 松开刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> RefreshThirdView thirdView; <span class=\"comment\">// 正在刷新</span></div><div class=\"line\">    <span class=\"keyword\">private</span> AnimationDrawable secondAnim; <span class=\"comment\">// secondView对应的动画</span></div><div class=\"line\">    <span class=\"keyword\">private</span> AnimationDrawable thirdAnim; <span class=\"comment\">// thirdView对应的动画</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> headerViewHeight; <span class=\"comment\">// 头布局的高度</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> startY; <span class=\"comment\">// 起始Y坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> offsetY; <span class=\"comment\">// Y坐标上的偏移量</span></div><div class=\"line\">    <span class=\"keyword\">private</span> OnRefreshListener refreshListener; <span class=\"comment\">// 回调接口</span></div><div class=\"line\">    <span class=\"comment\">// 滑动类</span></div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller mScroller = <span class=\"keyword\">null</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshListView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshListView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RefreshListView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">        init(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setRefreshListener</span><span class=\"params\">(OnRefreshListener refreshListener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.refreshListener = refreshListener;</div><div class=\"line\">        isRefreshable = <span class=\"keyword\">true</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 初始化</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> context</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        setOverScrollMode(View.OVER_SCROLL_NEVER);</div><div class=\"line\">        setOnScrollListener(<span class=\"keyword\">this</span>);</div><div class=\"line\"></div><div class=\"line\">        mScroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\"></div><div class=\"line\">        headerView = (LinearLayout) LayoutInflater.from(context).inflate(R.layout.list_header, <span class=\"keyword\">this</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\">        refreshText = (TextView) headerView.findViewById(R.id.pull_to_refresh);</div><div class=\"line\">        firstView = (RefreshFirstView) headerView.findViewById(R.id.first_view);</div><div class=\"line\">        secondView = (RefreshSecondView) headerView.findViewById(R.id.second_view);</div><div class=\"line\">        thirdView = (RefreshThirdView) headerView.findViewById(R.id.third_view);</div><div class=\"line\">        secondAnim = (AnimationDrawable) secondView.getBackground();</div><div class=\"line\">        thirdAnim = (AnimationDrawable) thirdView.getBackground();</div><div class=\"line\"></div><div class=\"line\">        measureView(headerView);</div><div class=\"line\">        addHeaderView(headerView);</div><div class=\"line\">        headerViewHeight = headerView.getMeasuredHeight();</div><div class=\"line\">        headerView.setPadding(<span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">0</span>, <span class=\"number\">0</span>); <span class=\"comment\">// 全局通过设置headerView的paddingTop来控制内部View的显示</span></div><div class=\"line\"></div><div class=\"line\">        state = DONE;</div><div class=\"line\">        isRefreshable = <span class=\"keyword\">false</span>;</div><div class=\"line\">        isRecord = <span class=\"keyword\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (mScroller.computeScrollOffset()) &#123;</div><div class=\"line\">            setPaddingTop(mScroller.getCurrY());</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setPaddingTop</span><span class=\"params\">(<span class=\"keyword\">int</span> paddingTop)</span> </span>&#123;</div><div class=\"line\">        headerView.setPadding(<span class=\"number\">0</span>, paddingTop, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">        headerView.postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScrollStateChanged</span><span class=\"params\">(AbsListView view, <span class=\"keyword\">int</span> scrollState)</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onScroll</span><span class=\"params\">(AbsListView view, <span class=\"keyword\">int</span> firstVisibleItem, <span class=\"keyword\">int</span> visibleItemCount, <span class=\"keyword\">int</span> totalItemCount)</span> </span>&#123;</div><div class=\"line\">        mFirstVisibleItem = firstVisibleItem;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (isRefreshable) &#123;<span class=\"comment\">//如果现在是可刷新状态   在setOnMeiTuanListener中设置为true</span></div><div class=\"line\">            <span class=\"keyword\">switch</span> (ev.getAction()) &#123;</div><div class=\"line\">                <span class=\"comment\">//用户按下</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                    <span class=\"keyword\">if</span> (mFirstVisibleItem == 0 &amp;&amp; !isRecord) &#123;</div><div class=\"line\">                        <span class=\"comment\">//将isRecord置为true，说明现在已记录y坐标</span></div><div class=\"line\">                        isRecord = <span class=\"keyword\">true</span>;</div><div class=\"line\">                        startY = ev.getY();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"comment\">//用户滑动</span></div><div class=\"line\">                <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                    //再次得到y坐标，用来和startY相减来计算offsetY位移值</div><div class=\"line\">                    <span class=\"keyword\">float</span> tempY = ev.getY();</div><div class=\"line\">                    <span class=\"comment\">//再判断一次</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (mFirstVisibleItem == <span class=\"number\">0</span> &amp;&amp; !isRecord) &#123;</div><div class=\"line\">                        isRecord = <span class=\"keyword\">true</span>;</div><div class=\"line\">                        startY = tempY;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态不是正在刷新的状态，并且已经记录了y坐标</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state != REFRESHING &amp;&amp; isRecord) &#123;</div><div class=\"line\">                        <span class=\"comment\">//计算y的偏移量</span></div><div class=\"line\">                        offsetY = tempY - startY;</div><div class=\"line\">                        <span class=\"comment\">//计算当前滑动的高度</span></div><div class=\"line\">                        <span class=\"keyword\">float</span> currentHeight = (-headerViewHeight + offsetY / <span class=\"number\">3</span>);</div><div class=\"line\">                        <span class=\"comment\">//用当前滑动的高度和头部headerView的总高度进行比 计算出当前滑动的百分比 0到1</span></div><div class=\"line\">                        <span class=\"keyword\">float</span> currentProgress = <span class=\"number\">1</span> + currentHeight / headerViewHeight;</div><div class=\"line\">                        <span class=\"comment\">//如果当前百分比大于1了，将其设置为1，目的是让第一个状态的椭圆不再继续变大</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (currentProgress &gt;= <span class=\"number\">1</span>) &#123;</div><div class=\"line\">                            currentProgress = <span class=\"number\">1</span>;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前的状态是放开刷新，并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            setSelection(<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//如果当前滑动的距离小于headerView的总高度</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (-headerViewHeight + offsetY / RATIO &lt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态置为下拉刷新状态</span></div><div class=\"line\">                                state = PULL_TO_REFRESH;</div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                                <span class=\"comment\">//如果当前y的位移值小于0，即为headerView隐藏了</span></div><div class=\"line\">                            &#125; <span class=\"function\"><span class=\"keyword\">else</span> <span class=\"title\">if</span> <span class=\"params\">(offsetY &lt;= <span class=\"number\">0</span>)</span> </span>&#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为done</span></div><div class=\"line\">                                state = DONE;</div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前状态为下拉刷新并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            setSelection(<span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//如果下拉距离大于等于headerView的总高度</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (-headerViewHeight + offsetY / RATIO &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为放开刷新</span></div><div class=\"line\">                                state = RELEASE_TO_REFRESH;</div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                                <span class=\"comment\">//如果当前y的位移值小于0，即为headerView隐藏了</span></div><div class=\"line\">                            &#125; <span class=\"function\"><span class=\"keyword\">else</span> <span class=\"title\">if</span> <span class=\"params\">(offsetY &lt;= <span class=\"number\">0</span>)</span> </span>&#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态变为done</span></div><div class=\"line\">                                state = DONE;</div><div class=\"line\">                                changeHeaderByState(state);</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果当前状态为done并且已经记录y坐标</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == DONE &amp;&amp; isRecord) &#123;</div><div class=\"line\">                            <span class=\"comment\">//如果位移值大于0</span></div><div class=\"line\">                            <span class=\"keyword\">if</span> (offsetY &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                                <span class=\"comment\">//将状态改为下拉刷新状态</span></div><div class=\"line\">                                state = PULL_TO_REFRESH;</div><div class=\"line\">                            &#125;</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果为下拉刷新状态</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH) &#123;</div><div class=\"line\">                            <span class=\"comment\">//则改变headerView的padding来实现下拉的效果</span></div><div class=\"line\">                            headerView.setPadding(<span class=\"number\">0</span>, (<span class=\"keyword\">int</span>) (-headerViewHeight + offsetY / RATIO), <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//给第一个状态的View设置当前进度值</span></div><div class=\"line\">                            firstView.setCurrentProgress(currentProgress);</div><div class=\"line\">                            <span class=\"comment\">//重画</span></div><div class=\"line\">                            firstView.postInvalidate();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                        <span class=\"comment\">//如果为放开刷新状态</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH) &#123;</div><div class=\"line\">                            <span class=\"comment\">//改变headerView的padding值</span></div><div class=\"line\">                            headerView.setPadding(<span class=\"number\">0</span>, (<span class=\"keyword\">int</span>) (-headerViewHeight + offsetY / RATIO), <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                            <span class=\"comment\">//给第一个状态的View设置当前进度值</span></div><div class=\"line\">                            firstView.setCurrentProgress(currentProgress);</div><div class=\"line\">                            <span class=\"comment\">//重画</span></div><div class=\"line\">                            firstView.postInvalidate();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                <span class=\"keyword\">default</span>:</div><div class=\"line\">                    //如果当前状态为下拉刷新状态</div><div class=\"line\">                    <span class=\"keyword\">if</span> (state == PULL_TO_REFRESH) &#123;</div><div class=\"line\">                        <span class=\"comment\">//平滑的隐藏headerView</span></div><div class=\"line\">                        <span class=\"keyword\">this</span>.smoothScrollBy((<span class=\"keyword\">int</span>) (-headerViewHeight + offsetY / RATIO) + headerViewHeight, <span class=\"number\">500</span>);</div><div class=\"line\">                        changeHeaderByState(state);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//如果当前状态为放开刷新</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (state == RELEASE_TO_REFRESH) &#123;</div><div class=\"line\">                        <span class=\"comment\">//平滑的滑到正好显示headerView</span></div><div class=\"line\"><span class=\"comment\">//                        this.smoothScrollBy((int) (-headerViewHeight + offsetY / RATIO), 500);</span></div><div class=\"line\">                        mScroller.startScroll(<span class=\"number\">0</span>, (<span class=\"keyword\">int</span>) (-headerViewHeight + offsetY / RATIO), <span class=\"number\">0</span>, (<span class=\"keyword\">int</span>) (headerViewHeight - offsetY / RATIO), <span class=\"number\">500</span>);</div><div class=\"line\">                        <span class=\"comment\">//将当前状态设置为正在刷新</span></div><div class=\"line\">                        state = REFRESHING;</div><div class=\"line\">                        <span class=\"comment\">//回调接口的onRefresh方法</span></div><div class=\"line\">                        changeHeaderByState(state);</div><div class=\"line\">                        <span class=\"keyword\">if</span> (refreshListener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                            refreshListener.onRefresh();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"comment\">//一套操作执行完，重置状态</span></div><div class=\"line\">                    isRecord = <span class=\"keyword\">false</span>;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 根据state改变HeaderView</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> state</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">changeHeaderByState</span><span class=\"params\">(<span class=\"keyword\">int</span> state)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (state) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> DONE:</div><div class=\"line\">                <span class=\"keyword\">if</span> (refreshEnd) &#123; <span class=\"comment\">// 如果是刷新结束，则慢慢滚动消失</span></div><div class=\"line\">                    mScroller.startScroll(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">500</span>);</div><div class=\"line\">                    refreshEnd = <span class=\"keyword\">false</span>;</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    headerView.setPadding(<span class=\"number\">0</span>, -headerViewHeight, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">                firstView.setVisibility(VISIBLE);</div><div class=\"line\">                secondView.setVisibility(GONE);</div><div class=\"line\">                secondAnim.stop();</div><div class=\"line\">                thirdView.setVisibility(GONE);</div><div class=\"line\">                thirdAnim.stop();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> PULL_TO_REFRESH:</div><div class=\"line\">                refreshText.setText(<span class=\"string\">\"下拉刷新\"</span>);</div><div class=\"line\">                firstView.setVisibility(View.VISIBLE);</div><div class=\"line\">                secondView.setVisibility(View.GONE);</div><div class=\"line\">                secondAnim.stop();</div><div class=\"line\">                thirdView.setVisibility(View.GONE);</div><div class=\"line\">                thirdAnim.stop();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> RELEASE_TO_REFRESH:</div><div class=\"line\">                refreshText.setText(<span class=\"string\">\"放开刷新\"</span>);</div><div class=\"line\">                firstView.setVisibility(View.GONE);</div><div class=\"line\">                secondView.setVisibility(View.VISIBLE);</div><div class=\"line\">                secondAnim.start();</div><div class=\"line\">                thirdView.setVisibility(View.GONE);</div><div class=\"line\">                thirdAnim.stop();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> REFRESHING:</div><div class=\"line\">                refreshText.setText(<span class=\"string\">\"正在刷新\"</span>);</div><div class=\"line\">                firstView.setVisibility(View.GONE);</div><div class=\"line\">                thirdView.setVisibility(View.VISIBLE);</div><div class=\"line\">                secondView.setVisibility(View.GONE);</div><div class=\"line\">                secondAnim.stop();</div><div class=\"line\">                thirdAnim.start();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">default</span>:</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\"></div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 在init时View尚未绘制，为了获取HeaderView的高度，需要此方法提前绘制</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> child</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">measureView</span><span class=\"params\">(View child)</span> </span>&#123;</div><div class=\"line\">        ViewGroup.LayoutParams p = child.getLayoutParams();</div><div class=\"line\">        <span class=\"keyword\">if</span> (p == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            p = <span class=\"keyword\">new</span> ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,</div><div class=\"line\">                    ViewGroup.LayoutParams.WRAP_CONTENT);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(<span class=\"number\">0</span>, <span class=\"number\">0</span> + <span class=\"number\">0</span>, p.width);</div><div class=\"line\">        <span class=\"keyword\">int</span> lpHeight = p.height;</div><div class=\"line\">        <span class=\"keyword\">int</span> childHeightSpec;</div><div class=\"line\">        <span class=\"keyword\">if</span> (lpHeight &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,</div><div class=\"line\">                    MeasureSpec.EXACTLY);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            childHeightSpec = MeasureSpec.makeMeasureSpec(<span class=\"number\">0</span>,</div><div class=\"line\">                    MeasureSpec.UNSPECIFIED);</div><div class=\"line\">        &#125;</div><div class=\"line\">        child.measure(childWidthSpec, childHeightSpec);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 刷新结束后的回调，重置状态</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setOnRefreshComplete</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        state = DONE;</div><div class=\"line\">        refreshEnd = <span class=\"keyword\">true</span>;</div><div class=\"line\">        changeHeaderByState(state);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 刷新回调接口</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">OnRefreshListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onRefresh</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"讨论\"><a href=\"#讨论\" class=\"headerlink\" title=\"讨论\"></a>讨论</h2><p>在原博客中有这样的讨论：setOnRefreshComplete没必要暴露，隐藏在ListView里面更好。</p>\n<p>个人觉得也确实是这样，我们使用下拉刷新只会关心onRefresh，对于setOnRefreshComplete是不关心的。<br>但是setOnRefreshComplete是必须要在onRefresh执行完之后才会执行，对于ListView它是不知道onRefresh在何时结束的，所以如果非要隐藏setOnRefreshComplete，我暂时没想到好的实现方案。</p>\n<p>后面我找了一下下拉刷新相关的库，都有类似setOnRefreshComplete的方法。<br>XListView：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview1.png\" alt=\"\"><br>SwipeRefreshLayout:<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/refresh-listview2.png\" alt=\"\"><br>希望有想法的大神不吝赐教~</p>\n<h2 id=\"感受\"><a href=\"#感受\" class=\"headerlink\" title=\"感受\"></a>感受</h2><ol>\n<li>对于自己记忆中模棱两可的知识一定要自己动手做一遍，以加深印象。</li>\n<li>可以通过缩放canvas，来实现自定义view的缩放。</li>\n<li>通过设置paddingTop值来控制headerView的显示。</li>\n<li><p>在查看XListView相关源码的时候，发现它是这样在View还没显示的时候获取高度的：</p>\n<figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">mHeaderView.getViewTreeObserver().addOnGlobalLayoutListener(</div><div class=\"line\">\t\t<span class=\"keyword\">new</span> OnGlobalLayoutListener() &#123;</div><div class=\"line\">\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onGlobalLayout</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\t\tmHeaderViewHeight = mHeaderViewContent.getHeight();</div><div class=\"line\">\t\t\tgetViewTreeObserver().removeGlobalOnLayoutListener(<span class=\"keyword\">this</span>);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n</li>\n<li><p>onTouchEvent里的事件处理是非常繁杂的，当时自己写滑动删除的ListView时也重写过onTouchEvent，一定要细心。</p>\n</li>\n</ol>\n<h2 id=\"我的代码\"><a href=\"#我的代码\" class=\"headerlink\" title=\"我的代码\"></a>我的代码</h2><p>代码已上传至<a href=\"https://github.com/LiJia92/MyRefreshListView\">我的Github</a>。</p>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"http://blog.csdn.net/nugongahou110/article/details/49557875\">Android自定义控件之仿美团下拉刷新</a></p>"},{"title":"Android实现简易轻量下载器：单线程任务队列","date":"2016-02-23T03:40:10.000Z","_content":"\n最近的项目是一个与音乐相关的App，其中有一个功能：收藏喜欢的歌曲，在wifi的环境下自动下载。\n\n考虑到音乐歌曲都是3、4Mb的小文件，断点下载的功能便不需要了。因此只需要实现一个特别轻量、简单的下载管理类，进行管理即可。\n\n最初的思路便是任务队列，单线程顺序执行，一个文件接着一个文件进行下载。\n\n之前看过AsyncTask的部分源码，其设计与我的想法类似，于是便借鉴着AsyncTask的源码，实现了一个特别简单、轻量的下载管理类。\n\n<!--more-->\n\n源码如下：\n```\npublic class MyDownloadManager {\n\n    private static final String TAG = \"MyDownloadManager\";\n    private File downloadDir; // 文件保存路径\n    private static MyDownloadManager instance; // 单例\n\n    // 单线程任务队列\n    public static Executor executor;\n    private static final ThreadFactory sThreadFactory = new ThreadFactory() {\n        private final AtomicInteger mCount = new AtomicInteger(1);\n\n        public Thread newThread(Runnable r) {\n            return new Thread(r, \"MyDownloadManager #\" + mCount.getAndIncrement());\n        }\n    };\n    private static final BlockingQueue<Runnable> sPoolWorkQueue = new LinkedBlockingQueue<>(128);\n    public static final Executor THREAD_POOL_EXECUTOR = new ThreadPoolExecutor(1, 1, 1,\n            TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);\n\n\n    private MyDownloadManager() {\n        // 初始化下载路径\n        downloadDir = new File(AndroidCacheUtils.getCacheDirFile(MiaApplication.getInstance()), \"download\");\n        if (!downloadDir.exists()) {\n            downloadDir.mkdirs();\n        }\n        executor = new SerialExecutor();\n    }\n\n    /**\n     * 顺序执行下载任务\n     */\n    private static class SerialExecutor implements Executor {\n        final ArrayDeque<Runnable> mTasks = new ArrayDeque<Runnable>();\n        Runnable mActive;\n\n        public synchronized void execute(final Runnable r) {\n            mTasks.offer(new Runnable() {\n                public void run() {\n                    try {\n                        r.run();\n                    } finally {\n                        scheduleNext();\n                    }\n                }\n            });\n            if (mActive == null) {\n                scheduleNext();\n            }\n        }\n\n        protected synchronized void scheduleNext() {\n            if ((mActive = mTasks.poll()) != null) {\n                THREAD_POOL_EXECUTOR.execute(mActive);\n            }\n        }\n    }\n\n    /**\n     * 获取单例对象\n     *\n     * @return\n     */\n    public static MyDownloadManager getInstance() {\n        if (instance == null) {\n            instance = new MyDownloadManager();\n        }\n        return instance;\n    }\n\n    /**\n     * 添加下载任务\n     *\n     * @param path\n     */\n    public void addDownloadTask(final String path) {\n        executor.execute(new Runnable() {\n            @Override\n            public void run() {\n                download(path);\n            }\n        });\n    }\n\n    /**\n     * 下载文件\n     *\n     * @param path\n     */\n    private void download(String path) {\n        String fileName = AndroidMD5.MD5(path);\n        File savePath = new File(downloadDir, fileName); // 下载文件路径\n        File finallyPath = new File(downloadDir, fileName + \".mp3\"); // 下载完成后加入.mp3后缀\n        if (finallyPath.exists()) { // 文件存在则已下载\n            Log.i(TAG, \"file is existed\");\n            return;\n        }\n        if (AndroidNetWorkUtils.isWifiDataEnable(MiaApplication.getInstance())) { // 如果是Wifi则开始下载\n            if (savePath.exists() && savePath.delete()) { // 如果之前存在文件，证明没有下载完成，删掉重新创建\n                savePath = new File(downloadDir, fileName);\n            }\n            Log.i(TAG, \"download start\");\n            try {\n                byte[] bs = new byte[1024];\n                int len;\n                URL url = new URL(path);\n                InputStream is = url.openStream();\n                OutputStream os = new FileOutputStream(savePath);\n                while ((len = is.read(bs)) != -1) {\n                    os.write(bs, 0, len);\n                }\n                os.close();\n                is.close();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n            if (savePath.renameTo(finallyPath)) { // 下载完成后重命名为.mp3文件\n                Log.i(TAG, \"download end\");\n                EventBus.getDefault().post(new DownloadDoneEvent(path));\n            }\n        } else { // 不是wifi则不下载\n            Log.i(TAG, \"not wifi net, stop download\");\n        }\n\n    }\n\n    /**\n     * 添加删除任务\n     *\n     * @param path\n     */\n    public void addDeleteTask(final String path) {\n        executor.execute(new Runnable() {\n            @Override\n            public void run() {\n                delete(path);\n            }\n        });\n    }\n\n    /**\n     * 删除本地文件\n     *\n     * @param path\n     */\n    private void delete(String path) {\n        String fileName = AndroidMD5.MD5(path);\n        File savePath = new File(downloadDir, fileName + \".mp3\");\n        Log.i(TAG, savePath.getPath());\n        if (savePath.exists()) {\n            if (savePath.delete()) {\n                Log.i(TAG, \"file is deleted\");\n            }\n        }\n    }\n\n    /**\n     * 返回下载路径\n     *\n     * @return\n     */\n    public File getDownloadDir() {\n        return downloadDir;\n    }\n}\n```\n我们看到``public static final Executor THREAD_POOL_EXECUTOR = new ThreadPoolExecutor(1, 1, 1,TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);``，这句代码便是创建一个线程池。其方法源码及参数说明：\n```\n/**\n     * Creates a new {@code ThreadPoolExecutor} with the given initial\n     * parameters and default rejected execution handler.\n     *\n     * @param corePoolSize the number of threads to keep in the pool, even\n     *        if they are idle, unless {@code allowCoreThreadTimeOut} is set\n     * @param maximumPoolSize the maximum number of threads to allow in the\n     *        pool\n     * @param keepAliveTime when the number of threads is greater than\n     *        the core, this is the maximum time that excess idle threads\n     *        will wait for new tasks before terminating.\n     * @param unit the time unit for the {@code keepAliveTime} argument\n     * @param workQueue the queue to use for holding tasks before they are\n     *        executed.  This queue will hold only the {@code Runnable}\n     *        tasks submitted by the {@code execute} method.\n     * @param threadFactory the factory to use when the executor\n     *        creates a new thread\n     * @throws IllegalArgumentException if one of the following holds:<br>\n     *         {@code corePoolSize < 0}<br>\n     *         {@code keepAliveTime < 0}<br>\n     *         {@code maximumPoolSize <= 0}<br>\n     *         {@code maximumPoolSize < corePoolSize}\n     * @throws NullPointerException if {@code workQueue}\n     *         or {@code threadFactory} is null\n     */\n    public ThreadPoolExecutor(int corePoolSize,\n                              int maximumPoolSize,\n                              long keepAliveTime,\n                              TimeUnit unit,\n                              BlockingQueue<Runnable> workQueue,\n                              ThreadFactory threadFactory) {\n        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,\n             threadFactory, defaultHandler);\n    }\n```\n这里我前三个参数传的都是1，既是最多只有1个线程。sPoolWorkQueue参数则是一个容量为128的任务队列，既最多能存放128个任务。\n\n下面我们看到``SerialExecutor``的代码，它有一个Runnable队列mTasks ，不断的接受Runnable对象，并通过poll操作，每次取出顶部的Runnable进行执行。结合创建的单一线程池，便实现了我需要的简易、轻量的下载器。\n","source":"_posts/single-thread-queue.md","raw":"---\ntitle: Android实现简易轻量下载器：单线程任务队列\ndate: 2016-02-23 11:40:10\ntags:\n - 日常开发\n - java\n---\n\n最近的项目是一个与音乐相关的App，其中有一个功能：收藏喜欢的歌曲，在wifi的环境下自动下载。\n\n考虑到音乐歌曲都是3、4Mb的小文件，断点下载的功能便不需要了。因此只需要实现一个特别轻量、简单的下载管理类，进行管理即可。\n\n最初的思路便是任务队列，单线程顺序执行，一个文件接着一个文件进行下载。\n\n之前看过AsyncTask的部分源码，其设计与我的想法类似，于是便借鉴着AsyncTask的源码，实现了一个特别简单、轻量的下载管理类。\n\n<!--more-->\n\n源码如下：\n```\npublic class MyDownloadManager {\n\n    private static final String TAG = \"MyDownloadManager\";\n    private File downloadDir; // 文件保存路径\n    private static MyDownloadManager instance; // 单例\n\n    // 单线程任务队列\n    public static Executor executor;\n    private static final ThreadFactory sThreadFactory = new ThreadFactory() {\n        private final AtomicInteger mCount = new AtomicInteger(1);\n\n        public Thread newThread(Runnable r) {\n            return new Thread(r, \"MyDownloadManager #\" + mCount.getAndIncrement());\n        }\n    };\n    private static final BlockingQueue<Runnable> sPoolWorkQueue = new LinkedBlockingQueue<>(128);\n    public static final Executor THREAD_POOL_EXECUTOR = new ThreadPoolExecutor(1, 1, 1,\n            TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);\n\n\n    private MyDownloadManager() {\n        // 初始化下载路径\n        downloadDir = new File(AndroidCacheUtils.getCacheDirFile(MiaApplication.getInstance()), \"download\");\n        if (!downloadDir.exists()) {\n            downloadDir.mkdirs();\n        }\n        executor = new SerialExecutor();\n    }\n\n    /**\n     * 顺序执行下载任务\n     */\n    private static class SerialExecutor implements Executor {\n        final ArrayDeque<Runnable> mTasks = new ArrayDeque<Runnable>();\n        Runnable mActive;\n\n        public synchronized void execute(final Runnable r) {\n            mTasks.offer(new Runnable() {\n                public void run() {\n                    try {\n                        r.run();\n                    } finally {\n                        scheduleNext();\n                    }\n                }\n            });\n            if (mActive == null) {\n                scheduleNext();\n            }\n        }\n\n        protected synchronized void scheduleNext() {\n            if ((mActive = mTasks.poll()) != null) {\n                THREAD_POOL_EXECUTOR.execute(mActive);\n            }\n        }\n    }\n\n    /**\n     * 获取单例对象\n     *\n     * @return\n     */\n    public static MyDownloadManager getInstance() {\n        if (instance == null) {\n            instance = new MyDownloadManager();\n        }\n        return instance;\n    }\n\n    /**\n     * 添加下载任务\n     *\n     * @param path\n     */\n    public void addDownloadTask(final String path) {\n        executor.execute(new Runnable() {\n            @Override\n            public void run() {\n                download(path);\n            }\n        });\n    }\n\n    /**\n     * 下载文件\n     *\n     * @param path\n     */\n    private void download(String path) {\n        String fileName = AndroidMD5.MD5(path);\n        File savePath = new File(downloadDir, fileName); // 下载文件路径\n        File finallyPath = new File(downloadDir, fileName + \".mp3\"); // 下载完成后加入.mp3后缀\n        if (finallyPath.exists()) { // 文件存在则已下载\n            Log.i(TAG, \"file is existed\");\n            return;\n        }\n        if (AndroidNetWorkUtils.isWifiDataEnable(MiaApplication.getInstance())) { // 如果是Wifi则开始下载\n            if (savePath.exists() && savePath.delete()) { // 如果之前存在文件，证明没有下载完成，删掉重新创建\n                savePath = new File(downloadDir, fileName);\n            }\n            Log.i(TAG, \"download start\");\n            try {\n                byte[] bs = new byte[1024];\n                int len;\n                URL url = new URL(path);\n                InputStream is = url.openStream();\n                OutputStream os = new FileOutputStream(savePath);\n                while ((len = is.read(bs)) != -1) {\n                    os.write(bs, 0, len);\n                }\n                os.close();\n                is.close();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n            if (savePath.renameTo(finallyPath)) { // 下载完成后重命名为.mp3文件\n                Log.i(TAG, \"download end\");\n                EventBus.getDefault().post(new DownloadDoneEvent(path));\n            }\n        } else { // 不是wifi则不下载\n            Log.i(TAG, \"not wifi net, stop download\");\n        }\n\n    }\n\n    /**\n     * 添加删除任务\n     *\n     * @param path\n     */\n    public void addDeleteTask(final String path) {\n        executor.execute(new Runnable() {\n            @Override\n            public void run() {\n                delete(path);\n            }\n        });\n    }\n\n    /**\n     * 删除本地文件\n     *\n     * @param path\n     */\n    private void delete(String path) {\n        String fileName = AndroidMD5.MD5(path);\n        File savePath = new File(downloadDir, fileName + \".mp3\");\n        Log.i(TAG, savePath.getPath());\n        if (savePath.exists()) {\n            if (savePath.delete()) {\n                Log.i(TAG, \"file is deleted\");\n            }\n        }\n    }\n\n    /**\n     * 返回下载路径\n     *\n     * @return\n     */\n    public File getDownloadDir() {\n        return downloadDir;\n    }\n}\n```\n我们看到``public static final Executor THREAD_POOL_EXECUTOR = new ThreadPoolExecutor(1, 1, 1,TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);``，这句代码便是创建一个线程池。其方法源码及参数说明：\n```\n/**\n     * Creates a new {@code ThreadPoolExecutor} with the given initial\n     * parameters and default rejected execution handler.\n     *\n     * @param corePoolSize the number of threads to keep in the pool, even\n     *        if they are idle, unless {@code allowCoreThreadTimeOut} is set\n     * @param maximumPoolSize the maximum number of threads to allow in the\n     *        pool\n     * @param keepAliveTime when the number of threads is greater than\n     *        the core, this is the maximum time that excess idle threads\n     *        will wait for new tasks before terminating.\n     * @param unit the time unit for the {@code keepAliveTime} argument\n     * @param workQueue the queue to use for holding tasks before they are\n     *        executed.  This queue will hold only the {@code Runnable}\n     *        tasks submitted by the {@code execute} method.\n     * @param threadFactory the factory to use when the executor\n     *        creates a new thread\n     * @throws IllegalArgumentException if one of the following holds:<br>\n     *         {@code corePoolSize < 0}<br>\n     *         {@code keepAliveTime < 0}<br>\n     *         {@code maximumPoolSize <= 0}<br>\n     *         {@code maximumPoolSize < corePoolSize}\n     * @throws NullPointerException if {@code workQueue}\n     *         or {@code threadFactory} is null\n     */\n    public ThreadPoolExecutor(int corePoolSize,\n                              int maximumPoolSize,\n                              long keepAliveTime,\n                              TimeUnit unit,\n                              BlockingQueue<Runnable> workQueue,\n                              ThreadFactory threadFactory) {\n        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,\n             threadFactory, defaultHandler);\n    }\n```\n这里我前三个参数传的都是1，既是最多只有1个线程。sPoolWorkQueue参数则是一个容量为128的任务队列，既最多能存放128个任务。\n\n下面我们看到``SerialExecutor``的代码，它有一个Runnable队列mTasks ，不断的接受Runnable对象，并通过poll操作，每次取出顶部的Runnable进行执行。结合创建的单一线程池，便实现了我需要的简易、轻量的下载器。\n","slug":"single-thread-queue","published":1,"updated":"2016-11-21T10:03:00.117Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75a6002r1cb8w1jtar04","content":"<p>最近的项目是一个与音乐相关的App，其中有一个功能：收藏喜欢的歌曲，在wifi的环境下自动下载。</p>\n<p>考虑到音乐歌曲都是3、4Mb的小文件，断点下载的功能便不需要了。因此只需要实现一个特别轻量、简单的下载管理类，进行管理即可。</p>\n<p>最初的思路便是任务队列，单线程顺序执行，一个文件接着一个文件进行下载。</p>\n<p>之前看过AsyncTask的部分源码，其设计与我的想法类似，于是便借鉴着AsyncTask的源码，实现了一个特别简单、轻量的下载管理类。</p>\n<a id=\"more\"></a>\n<p>源码如下：<br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> MyDownloadManager &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> final <span class=\"keyword\">String</span> TAG = <span class=\"string\">\"MyDownloadManager\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"built_in\">File</span> downloadDir; <span class=\"comment\">// 文件保存路径</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> MyDownloadManager instance; <span class=\"comment\">// 单例</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// 单线程任务队列</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Executor executor;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> final ThreadFactory sThreadFactory = <span class=\"keyword\">new</span> ThreadFactory() &#123;</div><div class=\"line\">        <span class=\"keyword\">private</span> final AtomicInteger mCount = <span class=\"keyword\">new</span> AtomicInteger(<span class=\"number\">1</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">public</span> Thread newThread(Runnable r) &#123;</div><div class=\"line\">            <span class=\"built_in\">return</span> <span class=\"keyword\">new</span> Thread(r, <span class=\"string\">\"MyDownloadManager #\"</span> + mCount.getAndIncrement());</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> final BlockingQueue&lt;Runnable&gt; sPoolWorkQueue = <span class=\"keyword\">new</span> LinkedBlockingQueue&lt;&gt;(<span class=\"number\">128</span>);</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> final Executor THREAD_POOL_EXECUTOR = <span class=\"keyword\">new</span> ThreadPoolExecutor(<span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>,</div><div class=\"line\">            TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> MyDownloadManager() &#123;</div><div class=\"line\">        <span class=\"comment\">// 初始化下载路径</span></div><div class=\"line\">        downloadDir = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(AndroidCacheUtils.getCacheDirFile(MiaApplication.getInstance()), <span class=\"string\">\"download\"</span>);</div><div class=\"line\">        <span class=\"built_in\">if</span> (!downloadDir.<span class=\"built_in\">exists</span>()) &#123;</div><div class=\"line\">            downloadDir.mkdirs();</div><div class=\"line\">        &#125;</div><div class=\"line\">        executor = <span class=\"keyword\">new</span> SerialExecutor();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 顺序执行下载任务</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> SerialExecutor implements Executor &#123;</div><div class=\"line\">        final ArrayDeque&lt;Runnable&gt; mTasks = <span class=\"keyword\">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class=\"line\">        Runnable mActive;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">public</span> synchronized <span class=\"keyword\">void</span> execute(final Runnable r) &#123;</div><div class=\"line\">            mTasks.offer(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">                <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"built_in\">run</span>() &#123;</div><div class=\"line\">                    <span class=\"built_in\">try</span> &#123;</div><div class=\"line\">                        r.<span class=\"built_in\">run</span>();</div><div class=\"line\">                    &#125; finally &#123;</div><div class=\"line\">                        scheduleNext();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;);</div><div class=\"line\">            <span class=\"built_in\">if</span> (mActive == null) &#123;</div><div class=\"line\">                scheduleNext();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">protected</span> synchronized <span class=\"keyword\">void</span> scheduleNext() &#123;</div><div class=\"line\">            <span class=\"built_in\">if</span> ((mActive = mTasks.poll()) != null) &#123;</div><div class=\"line\">                THREAD_POOL_EXECUTOR.execute(mActive);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 获取单例对象</div><div class=\"line\">     *</div><div class=\"line\">     * @return</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> MyDownloadManager getInstance() &#123;</div><div class=\"line\">        <span class=\"built_in\">if</span> (instance == null) &#123;</div><div class=\"line\">            instance = <span class=\"keyword\">new</span> MyDownloadManager();</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"built_in\">return</span> instance;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 添加下载任务</div><div class=\"line\">     *</div><div class=\"line\">     * @param path</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> addDownloadTask(final <span class=\"keyword\">String</span> path) &#123;</div><div class=\"line\">        executor.execute(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"built_in\">run</span>() &#123;</div><div class=\"line\">                download(path);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 下载文件</div><div class=\"line\">     *</div><div class=\"line\">     * @param path</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> download(<span class=\"keyword\">String</span> path) &#123;</div><div class=\"line\">        <span class=\"keyword\">String</span> fileName = AndroidMD5.MD5(path);</div><div class=\"line\">        <span class=\"built_in\">File</span> savePath = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(downloadDir, fileName); <span class=\"comment\">// 下载文件路径</span></div><div class=\"line\">        <span class=\"built_in\">File</span> finallyPath = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(downloadDir, fileName + <span class=\"string\">\".mp3\"</span>); <span class=\"comment\">// 下载完成后加入.mp3后缀</span></div><div class=\"line\">        <span class=\"built_in\">if</span> (finallyPath.<span class=\"built_in\">exists</span>()) &#123; <span class=\"comment\">// 文件存在则已下载</span></div><div class=\"line\">            Log.i(TAG, <span class=\"string\">\"file is existed\"</span>);</div><div class=\"line\">            <span class=\"built_in\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"built_in\">if</span> (AndroidNetWorkUtils.isWifiDataEnable(MiaApplication.getInstance())) &#123; <span class=\"comment\">// 如果是Wifi则开始下载</span></div><div class=\"line\">            <span class=\"built_in\">if</span> (savePath.<span class=\"built_in\">exists</span>() &amp;&amp; savePath.<span class=\"keyword\">delete</span>()) &#123; <span class=\"comment\">// 如果之前存在文件，证明没有下载完成，删掉重新创建</span></div><div class=\"line\">                savePath = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(downloadDir, fileName);</div><div class=\"line\">            &#125;</div><div class=\"line\">            Log.i(TAG, <span class=\"string\">\"download start\"</span>);</div><div class=\"line\">            <span class=\"built_in\">try</span> &#123;</div><div class=\"line\">                <span class=\"keyword\">byte</span>[] bs = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</div><div class=\"line\">                <span class=\"keyword\">int</span> len;</div><div class=\"line\">                URL url = <span class=\"keyword\">new</span> URL(path);</div><div class=\"line\">                InputStream is = url.openStream();</div><div class=\"line\">                OutputStream os = <span class=\"keyword\">new</span> FileOutputStream(savePath);</div><div class=\"line\">                <span class=\"built_in\">while</span> ((len = is.<span class=\"built_in\">read</span>(bs)) != <span class=\"number\">-1</span>) &#123;</div><div class=\"line\">                    os.<span class=\"built_in\">write</span>(bs, <span class=\"number\">0</span>, len);</div><div class=\"line\">                &#125;</div><div class=\"line\">                os.<span class=\"built_in\">close</span>();</div><div class=\"line\">                is.<span class=\"built_in\">close</span>();</div><div class=\"line\">            &#125; <span class=\"built_in\">catch</span> (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"built_in\">if</span> (savePath.renameTo(finallyPath)) &#123; <span class=\"comment\">// 下载完成后重命名为.mp3文件</span></div><div class=\"line\">                Log.i(TAG, <span class=\"string\">\"download end\"</span>);</div><div class=\"line\">                EventBus.getDefault().post(<span class=\"keyword\">new</span> DownloadDoneEvent(path));</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"built_in\">else</span> &#123; <span class=\"comment\">// 不是wifi则不下载</span></div><div class=\"line\">            Log.i(TAG, <span class=\"string\">\"not wifi net, stop download\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 添加删除任务</div><div class=\"line\">     *</div><div class=\"line\">     * @param path</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> addDeleteTask(final <span class=\"keyword\">String</span> path) &#123;</div><div class=\"line\">        executor.execute(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"built_in\">run</span>() &#123;</div><div class=\"line\">                <span class=\"keyword\">delete</span>(path);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 删除本地文件</div><div class=\"line\">     *</div><div class=\"line\">     * @param path</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"keyword\">delete</span>(<span class=\"keyword\">String</span> path) &#123;</div><div class=\"line\">        <span class=\"keyword\">String</span> fileName = AndroidMD5.MD5(path);</div><div class=\"line\">        <span class=\"built_in\">File</span> savePath = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(downloadDir, fileName + <span class=\"string\">\".mp3\"</span>);</div><div class=\"line\">        Log.i(TAG, savePath.getPath());</div><div class=\"line\">        <span class=\"built_in\">if</span> (savePath.<span class=\"built_in\">exists</span>()) &#123;</div><div class=\"line\">            <span class=\"built_in\">if</span> (savePath.<span class=\"keyword\">delete</span>()) &#123;</div><div class=\"line\">                Log.i(TAG, <span class=\"string\">\"file is deleted\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 返回下载路径</div><div class=\"line\">     *</div><div class=\"line\">     * @return</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">File</span> getDownloadDir() &#123;</div><div class=\"line\">        <span class=\"built_in\">return</span> downloadDir;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>我们看到<code>public static final Executor THREAD_POOL_EXECUTOR = new ThreadPoolExecutor(1, 1, 1,TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</code>，这句代码便是创建一个线程池。其方法源码及参数说明：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\">     * Creates a new &#123;<span class=\"doctag\">@code</span> ThreadPoolExecutor&#125; with the given initial</div><div class=\"line\">     * parameters and default rejected execution handler.</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> corePoolSize the number of threads to keep in the pool, even</div><div class=\"line\">     *        if they are idle, unless &#123;<span class=\"doctag\">@code</span> allowCoreThreadTimeOut&#125; is set</div><div class=\"line\">     * <span class=\"doctag\">@param</span> maximumPoolSize the maximum number of threads to allow in the</div><div class=\"line\">     *        pool</div><div class=\"line\">     * <span class=\"doctag\">@param</span> keepAliveTime when the number of threads is greater than</div><div class=\"line\">     *        the core, this is the maximum time that excess idle threads</div><div class=\"line\">     *        will wait for new tasks before terminating.</div><div class=\"line\">     * <span class=\"doctag\">@param</span> unit the time unit for the &#123;<span class=\"doctag\">@code</span> keepAliveTime&#125; argument</div><div class=\"line\">     * <span class=\"doctag\">@param</span> workQueue the queue to use for holding tasks before they are</div><div class=\"line\">     *        executed.  This queue will hold only the &#123;<span class=\"doctag\">@code</span> Runnable&#125;</div><div class=\"line\">     *        tasks submitted by the &#123;<span class=\"doctag\">@code</span> execute&#125; method.</div><div class=\"line\">     * <span class=\"doctag\">@param</span> threadFactory the factory to use when the executor</div><div class=\"line\">     *        creates a new thread</div><div class=\"line\">     * <span class=\"doctag\">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</div><div class=\"line\">     *         &#123;<span class=\"doctag\">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</div><div class=\"line\">     *         &#123;<span class=\"doctag\">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</div><div class=\"line\">     *         &#123;<span class=\"doctag\">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</div><div class=\"line\">     *         &#123;<span class=\"doctag\">@code</span> maximumPoolSize &lt; corePoolSize&#125;</div><div class=\"line\">     * <span class=\"doctag\">@throws</span> NullPointerException if &#123;<span class=\"doctag\">@code</span> workQueue&#125;</div><div class=\"line\">     *         or &#123;<span class=\"doctag\">@code</span> threadFactory&#125; is null</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ThreadPoolExecutor</span><span class=\"params\">(<span class=\"keyword\">int</span> corePoolSize,</span></span></div><div class=\"line\">                              <span class=\"keyword\">int</span> maximumPoolSize,</div><div class=\"line\">                              <span class=\"keyword\">long</span> keepAliveTime,</div><div class=\"line\">                              TimeUnit unit,</div><div class=\"line\">                              BlockingQueue&lt;Runnable&gt; workQueue,</div><div class=\"line\">                              ThreadFactory threadFactory) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</div><div class=\"line\">             threadFactory, defaultHandler);</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>这里我前三个参数传的都是1，既是最多只有1个线程。sPoolWorkQueue参数则是一个容量为128的任务队列，既最多能存放128个任务。</p>\n<p>下面我们看到<code>SerialExecutor</code>的代码，它有一个Runnable队列mTasks ，不断的接受Runnable对象，并通过poll操作，每次取出顶部的Runnable进行执行。结合创建的单一线程池，便实现了我需要的简易、轻量的下载器。</p>\n","excerpt":"<p>最近的项目是一个与音乐相关的App，其中有一个功能：收藏喜欢的歌曲，在wifi的环境下自动下载。</p>\n<p>考虑到音乐歌曲都是3、4Mb的小文件，断点下载的功能便不需要了。因此只需要实现一个特别轻量、简单的下载管理类，进行管理即可。</p>\n<p>最初的思路便是任务队列，单线程顺序执行，一个文件接着一个文件进行下载。</p>\n<p>之前看过AsyncTask的部分源码，其设计与我的想法类似，于是便借鉴着AsyncTask的源码，实现了一个特别简单、轻量的下载管理类。</p>","more":"<p>源码如下：<br><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> MyDownloadManager &#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> final <span class=\"keyword\">String</span> TAG = <span class=\"string\">\"MyDownloadManager\"</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"built_in\">File</span> downloadDir; <span class=\"comment\">// 文件保存路径</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> MyDownloadManager instance; <span class=\"comment\">// 单例</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// 单线程任务队列</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Executor executor;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> final ThreadFactory sThreadFactory = <span class=\"keyword\">new</span> ThreadFactory() &#123;</div><div class=\"line\">        <span class=\"keyword\">private</span> final AtomicInteger mCount = <span class=\"keyword\">new</span> AtomicInteger(<span class=\"number\">1</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">public</span> Thread newThread(Runnable r) &#123;</div><div class=\"line\">            <span class=\"built_in\">return</span> <span class=\"keyword\">new</span> Thread(r, <span class=\"string\">\"MyDownloadManager #\"</span> + mCount.getAndIncrement());</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> final BlockingQueue&lt;Runnable&gt; sPoolWorkQueue = <span class=\"keyword\">new</span> LinkedBlockingQueue&lt;&gt;(<span class=\"number\">128</span>);</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> final Executor THREAD_POOL_EXECUTOR = <span class=\"keyword\">new</span> ThreadPoolExecutor(<span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>,</div><div class=\"line\">            TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> MyDownloadManager() &#123;</div><div class=\"line\">        <span class=\"comment\">// 初始化下载路径</span></div><div class=\"line\">        downloadDir = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(AndroidCacheUtils.getCacheDirFile(MiaApplication.getInstance()), <span class=\"string\">\"download\"</span>);</div><div class=\"line\">        <span class=\"built_in\">if</span> (!downloadDir.<span class=\"built_in\">exists</span>()) &#123;</div><div class=\"line\">            downloadDir.mkdirs();</div><div class=\"line\">        &#125;</div><div class=\"line\">        executor = <span class=\"keyword\">new</span> SerialExecutor();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 顺序执行下载任务</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> SerialExecutor implements Executor &#123;</div><div class=\"line\">        final ArrayDeque&lt;Runnable&gt; mTasks = <span class=\"keyword\">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class=\"line\">        Runnable mActive;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">public</span> synchronized <span class=\"keyword\">void</span> execute(final Runnable r) &#123;</div><div class=\"line\">            mTasks.offer(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">                <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"built_in\">run</span>() &#123;</div><div class=\"line\">                    <span class=\"built_in\">try</span> &#123;</div><div class=\"line\">                        r.<span class=\"built_in\">run</span>();</div><div class=\"line\">                    &#125; finally &#123;</div><div class=\"line\">                        scheduleNext();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;);</div><div class=\"line\">            <span class=\"built_in\">if</span> (mActive == null) &#123;</div><div class=\"line\">                scheduleNext();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">protected</span> synchronized <span class=\"keyword\">void</span> scheduleNext() &#123;</div><div class=\"line\">            <span class=\"built_in\">if</span> ((mActive = mTasks.poll()) != null) &#123;</div><div class=\"line\">                THREAD_POOL_EXECUTOR.execute(mActive);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 获取单例对象</div><div class=\"line\">     *</div><div class=\"line\">     * @return</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> MyDownloadManager getInstance() &#123;</div><div class=\"line\">        <span class=\"built_in\">if</span> (instance == null) &#123;</div><div class=\"line\">            instance = <span class=\"keyword\">new</span> MyDownloadManager();</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"built_in\">return</span> instance;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 添加下载任务</div><div class=\"line\">     *</div><div class=\"line\">     * @param path</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> addDownloadTask(final <span class=\"keyword\">String</span> path) &#123;</div><div class=\"line\">        executor.execute(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"built_in\">run</span>() &#123;</div><div class=\"line\">                download(path);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 下载文件</div><div class=\"line\">     *</div><div class=\"line\">     * @param path</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> download(<span class=\"keyword\">String</span> path) &#123;</div><div class=\"line\">        <span class=\"keyword\">String</span> fileName = AndroidMD5.MD5(path);</div><div class=\"line\">        <span class=\"built_in\">File</span> savePath = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(downloadDir, fileName); <span class=\"comment\">// 下载文件路径</span></div><div class=\"line\">        <span class=\"built_in\">File</span> finallyPath = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(downloadDir, fileName + <span class=\"string\">\".mp3\"</span>); <span class=\"comment\">// 下载完成后加入.mp3后缀</span></div><div class=\"line\">        <span class=\"built_in\">if</span> (finallyPath.<span class=\"built_in\">exists</span>()) &#123; <span class=\"comment\">// 文件存在则已下载</span></div><div class=\"line\">            Log.i(TAG, <span class=\"string\">\"file is existed\"</span>);</div><div class=\"line\">            <span class=\"built_in\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"built_in\">if</span> (AndroidNetWorkUtils.isWifiDataEnable(MiaApplication.getInstance())) &#123; <span class=\"comment\">// 如果是Wifi则开始下载</span></div><div class=\"line\">            <span class=\"built_in\">if</span> (savePath.<span class=\"built_in\">exists</span>() &amp;&amp; savePath.<span class=\"keyword\">delete</span>()) &#123; <span class=\"comment\">// 如果之前存在文件，证明没有下载完成，删掉重新创建</span></div><div class=\"line\">                savePath = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(downloadDir, fileName);</div><div class=\"line\">            &#125;</div><div class=\"line\">            Log.i(TAG, <span class=\"string\">\"download start\"</span>);</div><div class=\"line\">            <span class=\"built_in\">try</span> &#123;</div><div class=\"line\">                <span class=\"keyword\">byte</span>[] bs = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</div><div class=\"line\">                <span class=\"keyword\">int</span> len;</div><div class=\"line\">                URL url = <span class=\"keyword\">new</span> URL(path);</div><div class=\"line\">                InputStream is = url.openStream();</div><div class=\"line\">                OutputStream os = <span class=\"keyword\">new</span> FileOutputStream(savePath);</div><div class=\"line\">                <span class=\"built_in\">while</span> ((len = is.<span class=\"built_in\">read</span>(bs)) != <span class=\"number\">-1</span>) &#123;</div><div class=\"line\">                    os.<span class=\"built_in\">write</span>(bs, <span class=\"number\">0</span>, len);</div><div class=\"line\">                &#125;</div><div class=\"line\">                os.<span class=\"built_in\">close</span>();</div><div class=\"line\">                is.<span class=\"built_in\">close</span>();</div><div class=\"line\">            &#125; <span class=\"built_in\">catch</span> (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"built_in\">if</span> (savePath.renameTo(finallyPath)) &#123; <span class=\"comment\">// 下载完成后重命名为.mp3文件</span></div><div class=\"line\">                Log.i(TAG, <span class=\"string\">\"download end\"</span>);</div><div class=\"line\">                EventBus.getDefault().post(<span class=\"keyword\">new</span> DownloadDoneEvent(path));</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"built_in\">else</span> &#123; <span class=\"comment\">// 不是wifi则不下载</span></div><div class=\"line\">            Log.i(TAG, <span class=\"string\">\"not wifi net, stop download\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 添加删除任务</div><div class=\"line\">     *</div><div class=\"line\">     * @param path</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> addDeleteTask(final <span class=\"keyword\">String</span> path) &#123;</div><div class=\"line\">        executor.execute(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"built_in\">run</span>() &#123;</div><div class=\"line\">                <span class=\"keyword\">delete</span>(path);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 删除本地文件</div><div class=\"line\">     *</div><div class=\"line\">     * @param path</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"keyword\">delete</span>(<span class=\"keyword\">String</span> path) &#123;</div><div class=\"line\">        <span class=\"keyword\">String</span> fileName = AndroidMD5.MD5(path);</div><div class=\"line\">        <span class=\"built_in\">File</span> savePath = <span class=\"keyword\">new</span> <span class=\"built_in\">File</span>(downloadDir, fileName + <span class=\"string\">\".mp3\"</span>);</div><div class=\"line\">        Log.i(TAG, savePath.getPath());</div><div class=\"line\">        <span class=\"built_in\">if</span> (savePath.<span class=\"built_in\">exists</span>()) &#123;</div><div class=\"line\">            <span class=\"built_in\">if</span> (savePath.<span class=\"keyword\">delete</span>()) &#123;</div><div class=\"line\">                Log.i(TAG, <span class=\"string\">\"file is deleted\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 返回下载路径</div><div class=\"line\">     *</div><div class=\"line\">     * @return</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"built_in\">File</span> getDownloadDir() &#123;</div><div class=\"line\">        <span class=\"built_in\">return</span> downloadDir;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>我们看到<code>public static final Executor THREAD_POOL_EXECUTOR = new ThreadPoolExecutor(1, 1, 1,TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</code>，这句代码便是创建一个线程池。其方法源码及参数说明：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\">     * Creates a new &#123;<span class=\"doctag\">@code</span> ThreadPoolExecutor&#125; with the given initial</div><div class=\"line\">     * parameters and default rejected execution handler.</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> corePoolSize the number of threads to keep in the pool, even</div><div class=\"line\">     *        if they are idle, unless &#123;<span class=\"doctag\">@code</span> allowCoreThreadTimeOut&#125; is set</div><div class=\"line\">     * <span class=\"doctag\">@param</span> maximumPoolSize the maximum number of threads to allow in the</div><div class=\"line\">     *        pool</div><div class=\"line\">     * <span class=\"doctag\">@param</span> keepAliveTime when the number of threads is greater than</div><div class=\"line\">     *        the core, this is the maximum time that excess idle threads</div><div class=\"line\">     *        will wait for new tasks before terminating.</div><div class=\"line\">     * <span class=\"doctag\">@param</span> unit the time unit for the &#123;<span class=\"doctag\">@code</span> keepAliveTime&#125; argument</div><div class=\"line\">     * <span class=\"doctag\">@param</span> workQueue the queue to use for holding tasks before they are</div><div class=\"line\">     *        executed.  This queue will hold only the &#123;<span class=\"doctag\">@code</span> Runnable&#125;</div><div class=\"line\">     *        tasks submitted by the &#123;<span class=\"doctag\">@code</span> execute&#125; method.</div><div class=\"line\">     * <span class=\"doctag\">@param</span> threadFactory the factory to use when the executor</div><div class=\"line\">     *        creates a new thread</div><div class=\"line\">     * <span class=\"doctag\">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</div><div class=\"line\">     *         &#123;<span class=\"doctag\">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</div><div class=\"line\">     *         &#123;<span class=\"doctag\">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</div><div class=\"line\">     *         &#123;<span class=\"doctag\">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</div><div class=\"line\">     *         &#123;<span class=\"doctag\">@code</span> maximumPoolSize &lt; corePoolSize&#125;</div><div class=\"line\">     * <span class=\"doctag\">@throws</span> NullPointerException if &#123;<span class=\"doctag\">@code</span> workQueue&#125;</div><div class=\"line\">     *         or &#123;<span class=\"doctag\">@code</span> threadFactory&#125; is null</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ThreadPoolExecutor</span><span class=\"params\">(<span class=\"keyword\">int</span> corePoolSize,</div><div class=\"line\">                              <span class=\"keyword\">int</span> maximumPoolSize,</div><div class=\"line\">                              <span class=\"keyword\">long</span> keepAliveTime,</div><div class=\"line\">                              TimeUnit unit,</div><div class=\"line\">                              BlockingQueue&lt;Runnable&gt; workQueue,</div><div class=\"line\">                              ThreadFactory threadFactory)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</div><div class=\"line\">             threadFactory, defaultHandler);</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>这里我前三个参数传的都是1，既是最多只有1个线程。sPoolWorkQueue参数则是一个容量为128的任务队列，既最多能存放128个任务。</p>\n<p>下面我们看到<code>SerialExecutor</code>的代码，它有一个Runnable队列mTasks ，不断的接受Runnable对象，并通过poll操作，每次取出顶部的Runnable进行执行。结合创建的单一线程池，便实现了我需要的简易、轻量的下载器。</p>"},{"title":"Retrofit初识","date":"2016-06-23T07:33:45.000Z","_content":"\n## 前言\n在这个技术日新月累的今天，各种新的轮子层出不穷。网络这块，从``HttpClient``到``android-async-http``，再到``Volley``。当下比较火的网络框架``Retrofit``也是受到了很多开发者的热爱。虽然项目中并没有使用到``Retrofit``，但抱着学习的态度，我还是打算接触一下，算是有个了解。说不定后面的开发中会用到呢？\n\n## Retrofit概述\n``Retrofit``是一个 RESTful 的 HTTP 网络请求框架的封装。注意这里并没有说它是网络请求框架，主要原因在于网络请求的工作并不是``Retrofit``来完成的。``Retrofit 2.0``开始内置``OkHttp``，前者专注于接口的封装，后者专注于网络请求的高效，二者分工协作。\n我们的应用程序通过``Retrofit``请求网络，实际上是使用``Retrofit``接口层封装请求参数、Header、Url等信息，之后由``OkHttp``完成后续的请求操作，在服务端返回数据之后，``OkHttp``将原始的结果交给``Retrofit``，后者根据用户的需求对结果进行解析的过程。所谓``Retrofit``，其实就是``Retrofitting OkHttp``了。\n\n<!-- more -->\n\n## Hello Retrofit\n废话不多说，直接撸代码。\n\n新建项目，添加依赖：\n```\ncompile 'com.squareup.retrofit2:retrofit:2.1.0'             //Retrofit2所需要的包\ncompile 'com.squareup.retrofit2:converter-scalars:2.1.0'    //ConverterFactory的String依赖包\n```\n\n我找了一个天气API，用作示例中的网络请求。\n```\nhttp://weatherapi.market.xiaomi.com/wtr-v2/temp/realtime?cityId=101010100\n```\n101010100代表的是北京市，这个接口会返回北京的实时天气。\n\nOK，下面开始写请求的API了。\n\n定义如下接口：\n```\npublic interface RequestService {\n    @GET(\"realtime\")\n    Call<String> getString(@Query(\"cityId\") String cityId);\n}\n```\n\n然后在Activity中添加代码：\n```\nbutton.setOnClickListener(new View.OnClickListener() {\n    @Override\n    public void onClick(View v) {\n        Retrofit retrofit = new Retrofit.Builder()\n                .baseUrl(\"http://weatherapi.market.xiaomi.com/wtr-v2/temp/\")\n                .addConverterFactory(ScalarsConverterFactory.create())\n                .build();\n        RequestService requestService = retrofit.create(RequestService.class);\n        Call<String> call = requestService.getString(\"101010100\");\n        call.enqueue(new Callback<String>() {\n            @Override\n            public void onResponse(Call<String> call, Response<String> response) {\n                Log.e(\"TAG\", \"成功：\" + response.body().toString());\n            }\n\n            @Override\n            public void onFailure(Call<String> call, Throwable t) {\n                Log.e(\"TAG\", \"失败\");\n            }\n        });\n\n    }\n});\n```\n运行代码，点击按钮。会发现Log中有如下的Log：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/retrofit1.png)\n\n可见，网络请求成功。\n\n## 相关说明\n1. ``Retrofit``支持的协议包括``GET``/``POST``/``PUT``/``DELETE``/``HEAD``/``PATCH``，当然你也可以直接用HTTP来自定义请求,这些协议均以注解的形式进行配置。\n2. 使用``ScalarsConverterFactory``可使返回值转化成String。\n3. ``Retrofit``使用``@Query``来添加请求参数，示例中发送的请求实际就是``http://weatherapi.market.xiaomi.com/wtr-v2/temp/realtime?cityId=101010100``，通过``@Query``添加了``cityId``参数。\n4. ``Retrofit``还有``@path``注解，直接与baseUrl整合成一个完整的请求。举个例子，采用相对路径：\n```\npath = \"apath\"，baseUrl = \"http://host:port/a/b/\"\n那么最后发送的请求 url = \"http://host:port/a/b/apath\"\n```\n\n当然，``Retrofit``还有很多功能以及用法，以及背后它为什么如此受宠的原因，都有待慢慢学习。\nIt's just the beginning！\n","source":"_posts/retrofit.md","raw":"---\ntitle: Retrofit初识\ndate: 2016-06-23 15:33:45\ntags:\n - sdk\n---\n\n## 前言\n在这个技术日新月累的今天，各种新的轮子层出不穷。网络这块，从``HttpClient``到``android-async-http``，再到``Volley``。当下比较火的网络框架``Retrofit``也是受到了很多开发者的热爱。虽然项目中并没有使用到``Retrofit``，但抱着学习的态度，我还是打算接触一下，算是有个了解。说不定后面的开发中会用到呢？\n\n## Retrofit概述\n``Retrofit``是一个 RESTful 的 HTTP 网络请求框架的封装。注意这里并没有说它是网络请求框架，主要原因在于网络请求的工作并不是``Retrofit``来完成的。``Retrofit 2.0``开始内置``OkHttp``，前者专注于接口的封装，后者专注于网络请求的高效，二者分工协作。\n我们的应用程序通过``Retrofit``请求网络，实际上是使用``Retrofit``接口层封装请求参数、Header、Url等信息，之后由``OkHttp``完成后续的请求操作，在服务端返回数据之后，``OkHttp``将原始的结果交给``Retrofit``，后者根据用户的需求对结果进行解析的过程。所谓``Retrofit``，其实就是``Retrofitting OkHttp``了。\n\n<!-- more -->\n\n## Hello Retrofit\n废话不多说，直接撸代码。\n\n新建项目，添加依赖：\n```\ncompile 'com.squareup.retrofit2:retrofit:2.1.0'             //Retrofit2所需要的包\ncompile 'com.squareup.retrofit2:converter-scalars:2.1.0'    //ConverterFactory的String依赖包\n```\n\n我找了一个天气API，用作示例中的网络请求。\n```\nhttp://weatherapi.market.xiaomi.com/wtr-v2/temp/realtime?cityId=101010100\n```\n101010100代表的是北京市，这个接口会返回北京的实时天气。\n\nOK，下面开始写请求的API了。\n\n定义如下接口：\n```\npublic interface RequestService {\n    @GET(\"realtime\")\n    Call<String> getString(@Query(\"cityId\") String cityId);\n}\n```\n\n然后在Activity中添加代码：\n```\nbutton.setOnClickListener(new View.OnClickListener() {\n    @Override\n    public void onClick(View v) {\n        Retrofit retrofit = new Retrofit.Builder()\n                .baseUrl(\"http://weatherapi.market.xiaomi.com/wtr-v2/temp/\")\n                .addConverterFactory(ScalarsConverterFactory.create())\n                .build();\n        RequestService requestService = retrofit.create(RequestService.class);\n        Call<String> call = requestService.getString(\"101010100\");\n        call.enqueue(new Callback<String>() {\n            @Override\n            public void onResponse(Call<String> call, Response<String> response) {\n                Log.e(\"TAG\", \"成功：\" + response.body().toString());\n            }\n\n            @Override\n            public void onFailure(Call<String> call, Throwable t) {\n                Log.e(\"TAG\", \"失败\");\n            }\n        });\n\n    }\n});\n```\n运行代码，点击按钮。会发现Log中有如下的Log：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/06/retrofit1.png)\n\n可见，网络请求成功。\n\n## 相关说明\n1. ``Retrofit``支持的协议包括``GET``/``POST``/``PUT``/``DELETE``/``HEAD``/``PATCH``，当然你也可以直接用HTTP来自定义请求,这些协议均以注解的形式进行配置。\n2. 使用``ScalarsConverterFactory``可使返回值转化成String。\n3. ``Retrofit``使用``@Query``来添加请求参数，示例中发送的请求实际就是``http://weatherapi.market.xiaomi.com/wtr-v2/temp/realtime?cityId=101010100``，通过``@Query``添加了``cityId``参数。\n4. ``Retrofit``还有``@path``注解，直接与baseUrl整合成一个完整的请求。举个例子，采用相对路径：\n```\npath = \"apath\"，baseUrl = \"http://host:port/a/b/\"\n那么最后发送的请求 url = \"http://host:port/a/b/apath\"\n```\n\n当然，``Retrofit``还有很多功能以及用法，以及背后它为什么如此受宠的原因，都有待慢慢学习。\nIt's just the beginning！\n","slug":"retrofit","published":1,"updated":"2016-11-21T10:02:52.349Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75a8002t1cb8k4oeuwno","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在这个技术日新月累的今天，各种新的轮子层出不穷。网络这块，从<code>HttpClient</code>到<code>android-async-http</code>，再到<code>Volley</code>。当下比较火的网络框架<code>Retrofit</code>也是受到了很多开发者的热爱。虽然项目中并没有使用到<code>Retrofit</code>，但抱着学习的态度，我还是打算接触一下，算是有个了解。说不定后面的开发中会用到呢？</p>\n<h2 id=\"Retrofit概述\"><a href=\"#Retrofit概述\" class=\"headerlink\" title=\"Retrofit概述\"></a>Retrofit概述</h2><p><code>Retrofit</code>是一个 RESTful 的 HTTP 网络请求框架的封装。注意这里并没有说它是网络请求框架，主要原因在于网络请求的工作并不是<code>Retrofit</code>来完成的。<code>Retrofit 2.0</code>开始内置<code>OkHttp</code>，前者专注于接口的封装，后者专注于网络请求的高效，二者分工协作。<br>我们的应用程序通过<code>Retrofit</code>请求网络，实际上是使用<code>Retrofit</code>接口层封装请求参数、Header、Url等信息，之后由<code>OkHttp</code>完成后续的请求操作，在服务端返回数据之后，<code>OkHttp</code>将原始的结果交给<code>Retrofit</code>，后者根据用户的需求对结果进行解析的过程。所谓<code>Retrofit</code>，其实就是<code>Retrofitting OkHttp</code>了。</p>\n<a id=\"more\"></a>\n<h2 id=\"Hello-Retrofit\"><a href=\"#Hello-Retrofit\" class=\"headerlink\" title=\"Hello Retrofit\"></a>Hello Retrofit</h2><p>废话不多说，直接撸代码。</p>\n<p>新建项目，添加依赖：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.squareup.retrofit2:retrofit:2.1.0'</span>             <span class=\"comment\">//Retrofit2所需要的包</span></div><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.squareup.retrofit2:converter-scalars:2.1.0'</span>    <span class=\"comment\">//ConverterFactory的String依赖包</span></div></pre></td></tr></table></figure></p>\n<p>我找了一个天气API，用作示例中的网络请求。<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">http:<span class=\"regexp\">//</span>weatherapi.market.xiaomi.com<span class=\"regexp\">/wtr-v2/</span>temp<span class=\"regexp\">/realtime?cityId=101010100</span></div></pre></td></tr></table></figure></p>\n<p>101010100代表的是北京市，这个接口会返回北京的实时天气。</p>\n<p>OK，下面开始写请求的API了。</p>\n<p>定义如下接口：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">public</span> <span class=\"selector-tag\">interface</span> <span class=\"selector-tag\">RequestService</span> &#123;</div><div class=\"line\">    <span class=\"variable\">@GET</span>(<span class=\"string\">\"realtime\"</span>)</div><div class=\"line\">    Call&lt;String&gt; getString(<span class=\"variable\">@Query</span>(<span class=\"string\">\"cityId\"</span>) String cityId);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后在Activity中添加代码：<br><figure class=\"highlight vbscript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">button.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">public</span> void onClick(View v) &#123;</div><div class=\"line\">        Retrofit retrofit = <span class=\"keyword\">new</span> Retrofit.Builder()</div><div class=\"line\">                .baseUrl(<span class=\"string\">\"http://weatherapi.market.xiaomi.com/wtr-v2/temp/\"</span>)</div><div class=\"line\">                .addConverterFactory(ScalarsConverterFactory.create())</div><div class=\"line\">                .build();</div><div class=\"line\">        RequestService requestService = retrofit.create(RequestService.<span class=\"keyword\">class</span>);</div><div class=\"line\">        <span class=\"keyword\">Call</span>&lt;<span class=\"built_in\">String</span>&gt; <span class=\"keyword\">call</span> = requestService.getString(<span class=\"string\">\"101010100\"</span>);</div><div class=\"line\">        <span class=\"keyword\">call</span>.enqueue(<span class=\"keyword\">new</span> Callback&lt;<span class=\"built_in\">String</span>&gt;() &#123;</div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> void onResponse(<span class=\"keyword\">Call</span>&lt;<span class=\"built_in\">String</span>&gt; <span class=\"keyword\">call</span>, <span class=\"built_in\">Response</span>&lt;<span class=\"built_in\">String</span>&gt; <span class=\"built_in\">response</span>) &#123;</div><div class=\"line\">                <span class=\"built_in\">Log</span>.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"成功：\"</span> + <span class=\"built_in\">response</span>.body().toString());</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> void onFailure(<span class=\"keyword\">Call</span>&lt;<span class=\"built_in\">String</span>&gt; <span class=\"keyword\">call</span>, Throwable t) &#123;</div><div class=\"line\">                <span class=\"built_in\">Log</span>.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"失败\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>运行代码，点击按钮。会发现Log中有如下的Log：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/retrofit1.png\" alt=\"\"></p>\n<p>可见，网络请求成功。</p>\n<h2 id=\"相关说明\"><a href=\"#相关说明\" class=\"headerlink\" title=\"相关说明\"></a>相关说明</h2><ol>\n<li><code>Retrofit</code>支持的协议包括<code>GET</code>/<code>POST</code>/<code>PUT</code>/<code>DELETE</code>/<code>HEAD</code>/<code>PATCH</code>，当然你也可以直接用HTTP来自定义请求,这些协议均以注解的形式进行配置。</li>\n<li>使用<code>ScalarsConverterFactory</code>可使返回值转化成String。</li>\n<li><code>Retrofit</code>使用<code>@Query</code>来添加请求参数，示例中发送的请求实际就是<code>http://weatherapi.market.xiaomi.com/wtr-v2/temp/realtime?cityId=101010100</code>，通过<code>@Query</code>添加了<code>cityId</code>参数。</li>\n<li><code>Retrofit</code>还有<code>@path</code>注解，直接与baseUrl整合成一个完整的请求。举个例子，采用相对路径：<figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">path</span> = <span class=\"string\">\"apath\"</span>，<span class=\"attr\">baseUrl</span> = <span class=\"string\">\"http://host:port/a/b/\"</span></div><div class=\"line\">那么最后发送的请求 <span class=\"attr\">url</span> = <span class=\"string\">\"http://host:port/a/b/apath\"</span></div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>当然，<code>Retrofit</code>还有很多功能以及用法，以及背后它为什么如此受宠的原因，都有待慢慢学习。<br>It’s just the beginning！</p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在这个技术日新月累的今天，各种新的轮子层出不穷。网络这块，从<code>HttpClient</code>到<code>android-async-http</code>，再到<code>Volley</code>。当下比较火的网络框架<code>Retrofit</code>也是受到了很多开发者的热爱。虽然项目中并没有使用到<code>Retrofit</code>，但抱着学习的态度，我还是打算接触一下，算是有个了解。说不定后面的开发中会用到呢？</p>\n<h2 id=\"Retrofit概述\"><a href=\"#Retrofit概述\" class=\"headerlink\" title=\"Retrofit概述\"></a>Retrofit概述</h2><p><code>Retrofit</code>是一个 RESTful 的 HTTP 网络请求框架的封装。注意这里并没有说它是网络请求框架，主要原因在于网络请求的工作并不是<code>Retrofit</code>来完成的。<code>Retrofit 2.0</code>开始内置<code>OkHttp</code>，前者专注于接口的封装，后者专注于网络请求的高效，二者分工协作。<br>我们的应用程序通过<code>Retrofit</code>请求网络，实际上是使用<code>Retrofit</code>接口层封装请求参数、Header、Url等信息，之后由<code>OkHttp</code>完成后续的请求操作，在服务端返回数据之后，<code>OkHttp</code>将原始的结果交给<code>Retrofit</code>，后者根据用户的需求对结果进行解析的过程。所谓<code>Retrofit</code>，其实就是<code>Retrofitting OkHttp</code>了。</p>","more":"<h2 id=\"Hello-Retrofit\"><a href=\"#Hello-Retrofit\" class=\"headerlink\" title=\"Hello Retrofit\"></a>Hello Retrofit</h2><p>废话不多说，直接撸代码。</p>\n<p>新建项目，添加依赖：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.squareup.retrofit2:retrofit:2.1.0'</span>             <span class=\"comment\">//Retrofit2所需要的包</span></div><div class=\"line\"><span class=\"keyword\">compile</span> <span class=\"string\">'com.squareup.retrofit2:converter-scalars:2.1.0'</span>    <span class=\"comment\">//ConverterFactory的String依赖包</span></div></pre></td></tr></table></figure></p>\n<p>我找了一个天气API，用作示例中的网络请求。<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">http:<span class=\"regexp\">//</span>weatherapi.market.xiaomi.com<span class=\"regexp\">/wtr-v2/</span>temp<span class=\"regexp\">/realtime?cityId=101010100</span></div></pre></td></tr></table></figure></p>\n<p>101010100代表的是北京市，这个接口会返回北京的实时天气。</p>\n<p>OK，下面开始写请求的API了。</p>\n<p>定义如下接口：<br><figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">public</span> <span class=\"selector-tag\">interface</span> <span class=\"selector-tag\">RequestService</span> &#123;</div><div class=\"line\">    <span class=\"variable\">@GET</span>(<span class=\"string\">\"realtime\"</span>)</div><div class=\"line\">    Call&lt;String&gt; getString(<span class=\"variable\">@Query</span>(<span class=\"string\">\"cityId\"</span>) String cityId);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>然后在Activity中添加代码：<br><figure class=\"highlight vbscript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">button.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">    @Override</div><div class=\"line\">    <span class=\"keyword\">public</span> void onClick(View v) &#123;</div><div class=\"line\">        Retrofit retrofit = <span class=\"keyword\">new</span> Retrofit.Builder()</div><div class=\"line\">                .baseUrl(<span class=\"string\">\"http://weatherapi.market.xiaomi.com/wtr-v2/temp/\"</span>)</div><div class=\"line\">                .addConverterFactory(ScalarsConverterFactory.create())</div><div class=\"line\">                .build();</div><div class=\"line\">        RequestService requestService = retrofit.create(RequestService.<span class=\"keyword\">class</span>);</div><div class=\"line\">        <span class=\"keyword\">Call</span>&lt;<span class=\"built_in\">String</span>&gt; <span class=\"keyword\">call</span> = requestService.getString(<span class=\"string\">\"101010100\"</span>);</div><div class=\"line\">        <span class=\"keyword\">call</span>.enqueue(<span class=\"keyword\">new</span> Callback&lt;<span class=\"built_in\">String</span>&gt;() &#123;</div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> void onResponse(<span class=\"keyword\">Call</span>&lt;<span class=\"built_in\">String</span>&gt; <span class=\"keyword\">call</span>, <span class=\"built_in\">Response</span>&lt;<span class=\"built_in\">String</span>&gt; <span class=\"built_in\">response</span>) &#123;</div><div class=\"line\">                <span class=\"built_in\">Log</span>.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"成功：\"</span> + <span class=\"built_in\">response</span>.body().toString());</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            @Override</div><div class=\"line\">            <span class=\"keyword\">public</span> void onFailure(<span class=\"keyword\">Call</span>&lt;<span class=\"built_in\">String</span>&gt; <span class=\"keyword\">call</span>, Throwable t) &#123;</div><div class=\"line\">                <span class=\"built_in\">Log</span>.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"失败\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>运行代码，点击按钮。会发现Log中有如下的Log：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/06/retrofit1.png\" alt=\"\"></p>\n<p>可见，网络请求成功。</p>\n<h2 id=\"相关说明\"><a href=\"#相关说明\" class=\"headerlink\" title=\"相关说明\"></a>相关说明</h2><ol>\n<li><code>Retrofit</code>支持的协议包括<code>GET</code>/<code>POST</code>/<code>PUT</code>/<code>DELETE</code>/<code>HEAD</code>/<code>PATCH</code>，当然你也可以直接用HTTP来自定义请求,这些协议均以注解的形式进行配置。</li>\n<li>使用<code>ScalarsConverterFactory</code>可使返回值转化成String。</li>\n<li><code>Retrofit</code>使用<code>@Query</code>来添加请求参数，示例中发送的请求实际就是<code>http://weatherapi.market.xiaomi.com/wtr-v2/temp/realtime?cityId=101010100</code>，通过<code>@Query</code>添加了<code>cityId</code>参数。</li>\n<li><code>Retrofit</code>还有<code>@path</code>注解，直接与baseUrl整合成一个完整的请求。举个例子，采用相对路径：<figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">path</span> = <span class=\"string\">\"apath\"</span>，<span class=\"attr\">baseUrl</span> = <span class=\"string\">\"http://host:port/a/b/\"</span></div><div class=\"line\">那么最后发送的请求 <span class=\"attr\">url</span> = <span class=\"string\">\"http://host:port/a/b/apath\"</span></div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>当然，<code>Retrofit</code>还有很多功能以及用法，以及背后它为什么如此受宠的原因，都有待慢慢学习。<br>It’s just the beginning！</p>"},{"title":"Android直播利用Socket传输实时数据","date":"2016-11-16T01:52:34.000Z","_content":"\n## 前言\n通过前面一段时间的摸索，iOS的Multipeer Connectivity与Android的Wifi-Direct并不兼容，一些三方可能都是需要连接热点才能实现跨平台传输。热点是需要连接到同一个网络环境下的，那么考虑下Socket是否可行呢？理论上，应该是没问题的。为了验证，我这边便开始Android端的测试，至于跨平台就得等到iOS那边一起合作来验证了。\n\n## Socket连接\n这里分一个Client（采集实时数据），一个server（接收数据进行处理）这样的两个角色。在一个局域网下，他们要互相建立连接首先便是要能互相发现。我的方案是：Server监听一个端口，Client发送一个绑定端口的广播（UDP），广播信息包含Client的ip，Server再收到广播之后，利用收到的ip发送一个单播到Client，单播信息包含Server的ip，Client收到之后便知道Server的ip了，那么便可以建立连接了。\n\n<!-- more -->\n\n获取ip：\n```\nprivate static String getIP(Context application) {\n    WifiManager wifiManager = (WifiManager) application.getSystemService(Context.WIFI_SERVICE);\n    if (!wifiManager.isWifiEnabled()) {\n        try {\n            for (Enumeration<NetworkInterface> en = NetworkInterface.getNetworkInterfaces(); en.hasMoreElements(); ) {\n                NetworkInterface intf = en.nextElement();\n                for (Enumeration<InetAddress> enumIpAddr = intf.getInetAddresses(); enumIpAddr.hasMoreElements(); ) {\n                    InetAddress inetAddress = enumIpAddr.nextElement();\n                    if (!inetAddress.isLoopbackAddress()) {\n                        return inetAddress.getHostAddress();\n                    }\n                }\n            }\n        } catch (SocketException e) {\n            e.printStackTrace();\n        }\n    } else {\n        WifiInfo wifiInfo = wifiManager.getConnectionInfo();\n        int ipAddress = wifiInfo.getIpAddress();\n        String ip = intToIp(ipAddress);\n        return ip;\n    }\n    return null;\n}\n\nprivate static String intToIp(int i) {\n    return (i & 0xFF) + \".\" +\n            ((i >> 8) & 0xFF) + \".\" +\n            ((i >> 16) & 0xFF) + \".\" +\n            (i >> 24 & 0xFF);\n}\n```\nServer监听端口：\n```\npublic void startListening() {\n    stop = false;\n    mHandler.post(new Runnable() {\n        @Override\n        public void run() {\n            try {\n                byte[] buf = new byte[1024];\n                DatagramSocket ds = new DatagramSocket(LISTENING_PORT);\n                DatagramPacket dp = new DatagramPacket(buf, buf.length);\n                String ip = getIP(MyApplication.getApplication());\n                Log.e(\"TAG\", \"startListening:\" + ip);\n                ds.receive(dp);\n                ds.close();\n                StringBuffer sb = new StringBuffer();\n                int i;\n                for (i = 0; i < 1024; i++) {\n                    if (buf[i] == 0) {\n                        break;\n                    }\n                    sb.append((char) buf[i]);\n                }\n                sendIpBroadcast(sb.toString());\n                setupServer();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }\n    });\n}\n```\n上面代码会在ds.receive(dp)阻塞，直到收到消息。\nClient发送广播：\n```\npublic void sendIpBroadcast() {\n    mHandler.post(new Runnable() {\n        @Override\n        public void run() {\n            final String message = getIP(MyApplication.getApplication());\n            try {\n                InetAddress adds = InetAddress.getByName(BROADCAST_IP);\n                DatagramSocket ds = new DatagramSocket();\n                DatagramPacket dp = new DatagramPacket(message.getBytes(),\n                        message.length(), adds, LISTENING_PORT);\n                ds.send(dp);\n                ds.close();\n                startListening();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }\n    });\n}\n```\nClient将自己的ip通过UDP广播发送出来，同时监听一个端口，用于接收Server发出的广播（带Server ip）。Server的ds.receive(dp)执行，获取到Client ip之后，便是发送自身的ip，以及建立ServerSocket。\n```\nprivate void setupServer() {\n    mHandler.post(new Runnable() {\n        @Override\n        public void run() {\n            try {\n                mServerSocket = new ServerSocket(SERVER_PORT);\n                while (!stop) {\n                    Socket socket = mServerSocket.accept();\n                    socketList.add(socket);\n                    new Thread(new MyServerRunnable(socket)).start();\n                }\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }\n    });\n}\n```\nmServerSocket.accept()也是个阻塞方法，直到有Client连接进来。\nClient通过监听收到Server ip，之后便是建立连接了。\n```\nprivate void connect(final String serverIp) {\n    mHandler.post(new Runnable() {\n        @Override\n        public void run() {\n            try {\n                socket = new Socket(serverIp, SERVER_PORT);\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }\n    });\n}\n```\n通过``socket = new Socket(serverIp, SERVER_PORT);``即可建立连接了（也是阻塞方法）。\n\n## 时间对齐\n对于直播这种实时传递音视频数据的需求，在传递数据的时候都是需要打上时间戳的，用于计算超时。但是在不同手机上的时钟表现是不一样的，所以需要选取一个标准，这里我选用Server的时间。那么Client的时间如何与Server的时间对齐呢？我的方案是：Client发送本身时间到Server，Server在收到请求后回复自身的时间到Client，Client记录下发送请求的时间，与收到回复的时间。记发送请求的时间为C1，收到回复的时间为C2，Server回复的时间为S1。我们假定网络是稳定的，那么便能得到如下结论：\n> (C1 + C2) / 2  ==>  S1\n即Client在（C1 + C2）/ 2这个时刻，Server的时间是S1.\n\n记后续发请求的时间为C'，记此时Server的时间为S'，那么便会有如下公式：\n> C' - (C1 + C2) / 2 = S' - S1 (Client与Server同时流逝的时间是一致的)\n==>  S' = C' - (C1 + C2)/2 + S1  ==> S' = C' - C2 + (C2-C1) / 2 + S1\n\n如此在Client每次发送实时音视频数据时，便可依据Client此刻的时间计算出Server端的时间，打上时间戳后传递到Server端，Server端收到后可以与Server此刻的时间对比，来进行超时的计算或其他的一些处理。\n这里姑且理解``delta = (C2-C1) / 2``为Client传递数据到Server的时间。这个时间越小，对齐得便越精准。所以需要多发送几次请求，然后取最小的delta。另外发送请求的时候包上时间数据，模拟收发的数据量是一致的。\n\n## 传递H264数据\n通过我之前的文章，已经可以采集到H264的数据了，格式是byte数组，那么要如何通过Socket传递到Server呢？我之前是利用``BufferedWriter``的write(String msg)方法，new String(byte[] data)。服务端在收到后通过String.getBytes()还原byte[]，但是将这种数据传递到MediaCodec进行解码，输出不出正确的视频。所以后面干脆就直接利用DataOutputStream传递byte[]数组了。\n解码代码：\n```\nprivate void initMediaDecode() {\n    Log.e(\"TAG\", \"initMediaDecode\");\n    MediaFormat format = MediaFormat.createVideoFormat(\"video/avc\", 1280, 720);\n    try {\n        decoder = MediaCodec.createDecoderByType(\"video/avc\");\n        // 直接输出到surfaceView\n        decoder.configure(format, surfaceView.getHolder().getSurface(), null, 0);\n        decoder.start();\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n\n    new DecodeThread().start();\n}\n\nprivate class DecodeThread extends Thread {\n\n    MediaCodec.BufferInfo mBufferInfo;\n    int mCount = 0;\n\n    public DecodeThread() {\n        mBufferInfo = new MediaCodec.BufferInfo();\n    }\n\n    @Override\n    public void run() {\n        while (true) {\n            try {\n                if (h264data.size() > 0) {\n                    byte[] data = h264data.get(0);\n                    h264data.remove(0);\n                    Log.e(\"Media\", \"save to file data size:\" + data.length);\n                    // 保存数据到文件\n                    // Util.save(data, 0, data.length, path, true);\n\n                    ByteBuffer[] inputBuffers = decoder.getInputBuffers();\n                    int inputBufferIndex = decoder.dequeueInputBuffer(100);\n                    if (inputBufferIndex >= 0) {\n                        ByteBuffer inputBuffer = inputBuffers[inputBufferIndex];\n                        inputBuffer.clear();\n                        inputBuffer.put(data);\n                        decoder.queueInputBuffer(inputBufferIndex, 0, data.length, mCount * TIME_INTERNAL, 0);\n                    }\n\n                    // Get output buffer index\n                    int outputBufferIndex = decoder.dequeueOutputBuffer(mBufferInfo, 100);\n                    while (outputBufferIndex >= 0) {\n                        Log.e(\"Media\", \"onFrame index:\" + outputBufferIndex);\n                        decoder.releaseOutputBuffer(outputBufferIndex, true);\n                        outputBufferIndex = decoder.dequeueOutputBuffer(mBufferInfo, 0);\n                    }\n                } else {\n                    sleep(TIME_INTERNAL);\n                }\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n        }\n    }\n}\n```\n通过此种解码，发现解码的视频花屏，但是存入到文件中再打开则是比较清晰流畅的，估计是解码有问题。\n\n\n[Demo代码](https://github.com/LiJia92/SocketDemo)\n","source":"_posts/socket.md","raw":"---\ntitle: Android直播利用Socket传输实时数据\ndate: 2016-11-16 09:52:34\ntags:\n - 直播\n - java\n---\n\n## 前言\n通过前面一段时间的摸索，iOS的Multipeer Connectivity与Android的Wifi-Direct并不兼容，一些三方可能都是需要连接热点才能实现跨平台传输。热点是需要连接到同一个网络环境下的，那么考虑下Socket是否可行呢？理论上，应该是没问题的。为了验证，我这边便开始Android端的测试，至于跨平台就得等到iOS那边一起合作来验证了。\n\n## Socket连接\n这里分一个Client（采集实时数据），一个server（接收数据进行处理）这样的两个角色。在一个局域网下，他们要互相建立连接首先便是要能互相发现。我的方案是：Server监听一个端口，Client发送一个绑定端口的广播（UDP），广播信息包含Client的ip，Server再收到广播之后，利用收到的ip发送一个单播到Client，单播信息包含Server的ip，Client收到之后便知道Server的ip了，那么便可以建立连接了。\n\n<!-- more -->\n\n获取ip：\n```\nprivate static String getIP(Context application) {\n    WifiManager wifiManager = (WifiManager) application.getSystemService(Context.WIFI_SERVICE);\n    if (!wifiManager.isWifiEnabled()) {\n        try {\n            for (Enumeration<NetworkInterface> en = NetworkInterface.getNetworkInterfaces(); en.hasMoreElements(); ) {\n                NetworkInterface intf = en.nextElement();\n                for (Enumeration<InetAddress> enumIpAddr = intf.getInetAddresses(); enumIpAddr.hasMoreElements(); ) {\n                    InetAddress inetAddress = enumIpAddr.nextElement();\n                    if (!inetAddress.isLoopbackAddress()) {\n                        return inetAddress.getHostAddress();\n                    }\n                }\n            }\n        } catch (SocketException e) {\n            e.printStackTrace();\n        }\n    } else {\n        WifiInfo wifiInfo = wifiManager.getConnectionInfo();\n        int ipAddress = wifiInfo.getIpAddress();\n        String ip = intToIp(ipAddress);\n        return ip;\n    }\n    return null;\n}\n\nprivate static String intToIp(int i) {\n    return (i & 0xFF) + \".\" +\n            ((i >> 8) & 0xFF) + \".\" +\n            ((i >> 16) & 0xFF) + \".\" +\n            (i >> 24 & 0xFF);\n}\n```\nServer监听端口：\n```\npublic void startListening() {\n    stop = false;\n    mHandler.post(new Runnable() {\n        @Override\n        public void run() {\n            try {\n                byte[] buf = new byte[1024];\n                DatagramSocket ds = new DatagramSocket(LISTENING_PORT);\n                DatagramPacket dp = new DatagramPacket(buf, buf.length);\n                String ip = getIP(MyApplication.getApplication());\n                Log.e(\"TAG\", \"startListening:\" + ip);\n                ds.receive(dp);\n                ds.close();\n                StringBuffer sb = new StringBuffer();\n                int i;\n                for (i = 0; i < 1024; i++) {\n                    if (buf[i] == 0) {\n                        break;\n                    }\n                    sb.append((char) buf[i]);\n                }\n                sendIpBroadcast(sb.toString());\n                setupServer();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }\n    });\n}\n```\n上面代码会在ds.receive(dp)阻塞，直到收到消息。\nClient发送广播：\n```\npublic void sendIpBroadcast() {\n    mHandler.post(new Runnable() {\n        @Override\n        public void run() {\n            final String message = getIP(MyApplication.getApplication());\n            try {\n                InetAddress adds = InetAddress.getByName(BROADCAST_IP);\n                DatagramSocket ds = new DatagramSocket();\n                DatagramPacket dp = new DatagramPacket(message.getBytes(),\n                        message.length(), adds, LISTENING_PORT);\n                ds.send(dp);\n                ds.close();\n                startListening();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }\n    });\n}\n```\nClient将自己的ip通过UDP广播发送出来，同时监听一个端口，用于接收Server发出的广播（带Server ip）。Server的ds.receive(dp)执行，获取到Client ip之后，便是发送自身的ip，以及建立ServerSocket。\n```\nprivate void setupServer() {\n    mHandler.post(new Runnable() {\n        @Override\n        public void run() {\n            try {\n                mServerSocket = new ServerSocket(SERVER_PORT);\n                while (!stop) {\n                    Socket socket = mServerSocket.accept();\n                    socketList.add(socket);\n                    new Thread(new MyServerRunnable(socket)).start();\n                }\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }\n    });\n}\n```\nmServerSocket.accept()也是个阻塞方法，直到有Client连接进来。\nClient通过监听收到Server ip，之后便是建立连接了。\n```\nprivate void connect(final String serverIp) {\n    mHandler.post(new Runnable() {\n        @Override\n        public void run() {\n            try {\n                socket = new Socket(serverIp, SERVER_PORT);\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }\n    });\n}\n```\n通过``socket = new Socket(serverIp, SERVER_PORT);``即可建立连接了（也是阻塞方法）。\n\n## 时间对齐\n对于直播这种实时传递音视频数据的需求，在传递数据的时候都是需要打上时间戳的，用于计算超时。但是在不同手机上的时钟表现是不一样的，所以需要选取一个标准，这里我选用Server的时间。那么Client的时间如何与Server的时间对齐呢？我的方案是：Client发送本身时间到Server，Server在收到请求后回复自身的时间到Client，Client记录下发送请求的时间，与收到回复的时间。记发送请求的时间为C1，收到回复的时间为C2，Server回复的时间为S1。我们假定网络是稳定的，那么便能得到如下结论：\n> (C1 + C2) / 2  ==>  S1\n即Client在（C1 + C2）/ 2这个时刻，Server的时间是S1.\n\n记后续发请求的时间为C'，记此时Server的时间为S'，那么便会有如下公式：\n> C' - (C1 + C2) / 2 = S' - S1 (Client与Server同时流逝的时间是一致的)\n==>  S' = C' - (C1 + C2)/2 + S1  ==> S' = C' - C2 + (C2-C1) / 2 + S1\n\n如此在Client每次发送实时音视频数据时，便可依据Client此刻的时间计算出Server端的时间，打上时间戳后传递到Server端，Server端收到后可以与Server此刻的时间对比，来进行超时的计算或其他的一些处理。\n这里姑且理解``delta = (C2-C1) / 2``为Client传递数据到Server的时间。这个时间越小，对齐得便越精准。所以需要多发送几次请求，然后取最小的delta。另外发送请求的时候包上时间数据，模拟收发的数据量是一致的。\n\n## 传递H264数据\n通过我之前的文章，已经可以采集到H264的数据了，格式是byte数组，那么要如何通过Socket传递到Server呢？我之前是利用``BufferedWriter``的write(String msg)方法，new String(byte[] data)。服务端在收到后通过String.getBytes()还原byte[]，但是将这种数据传递到MediaCodec进行解码，输出不出正确的视频。所以后面干脆就直接利用DataOutputStream传递byte[]数组了。\n解码代码：\n```\nprivate void initMediaDecode() {\n    Log.e(\"TAG\", \"initMediaDecode\");\n    MediaFormat format = MediaFormat.createVideoFormat(\"video/avc\", 1280, 720);\n    try {\n        decoder = MediaCodec.createDecoderByType(\"video/avc\");\n        // 直接输出到surfaceView\n        decoder.configure(format, surfaceView.getHolder().getSurface(), null, 0);\n        decoder.start();\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n\n    new DecodeThread().start();\n}\n\nprivate class DecodeThread extends Thread {\n\n    MediaCodec.BufferInfo mBufferInfo;\n    int mCount = 0;\n\n    public DecodeThread() {\n        mBufferInfo = new MediaCodec.BufferInfo();\n    }\n\n    @Override\n    public void run() {\n        while (true) {\n            try {\n                if (h264data.size() > 0) {\n                    byte[] data = h264data.get(0);\n                    h264data.remove(0);\n                    Log.e(\"Media\", \"save to file data size:\" + data.length);\n                    // 保存数据到文件\n                    // Util.save(data, 0, data.length, path, true);\n\n                    ByteBuffer[] inputBuffers = decoder.getInputBuffers();\n                    int inputBufferIndex = decoder.dequeueInputBuffer(100);\n                    if (inputBufferIndex >= 0) {\n                        ByteBuffer inputBuffer = inputBuffers[inputBufferIndex];\n                        inputBuffer.clear();\n                        inputBuffer.put(data);\n                        decoder.queueInputBuffer(inputBufferIndex, 0, data.length, mCount * TIME_INTERNAL, 0);\n                    }\n\n                    // Get output buffer index\n                    int outputBufferIndex = decoder.dequeueOutputBuffer(mBufferInfo, 100);\n                    while (outputBufferIndex >= 0) {\n                        Log.e(\"Media\", \"onFrame index:\" + outputBufferIndex);\n                        decoder.releaseOutputBuffer(outputBufferIndex, true);\n                        outputBufferIndex = decoder.dequeueOutputBuffer(mBufferInfo, 0);\n                    }\n                } else {\n                    sleep(TIME_INTERNAL);\n                }\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n        }\n    }\n}\n```\n通过此种解码，发现解码的视频花屏，但是存入到文件中再打开则是比较清晰流畅的，估计是解码有问题。\n\n\n[Demo代码](https://github.com/LiJia92/SocketDemo)\n","slug":"socket","published":1,"updated":"2016-11-21T10:03:22.225Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75a9002v1cb82ffhamz0","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>通过前面一段时间的摸索，iOS的Multipeer Connectivity与Android的Wifi-Direct并不兼容，一些三方可能都是需要连接热点才能实现跨平台传输。热点是需要连接到同一个网络环境下的，那么考虑下Socket是否可行呢？理论上，应该是没问题的。为了验证，我这边便开始Android端的测试，至于跨平台就得等到iOS那边一起合作来验证了。</p>\n<h2 id=\"Socket连接\"><a href=\"#Socket连接\" class=\"headerlink\" title=\"Socket连接\"></a>Socket连接</h2><p>这里分一个Client（采集实时数据），一个server（接收数据进行处理）这样的两个角色。在一个局域网下，他们要互相建立连接首先便是要能互相发现。我的方案是：Server监听一个端口，Client发送一个绑定端口的广播（UDP），广播信息包含Client的ip，Server再收到广播之后，利用收到的ip发送一个单播到Client，单播信息包含Server的ip，Client收到之后便知道Server的ip了，那么便可以建立连接了。</p>\n<a id=\"more\"></a>\n<p>获取ip：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"function\">String <span class=\"title\">getIP</span><span class=\"params\">(Context application)</span> </span>&#123;</div><div class=\"line\">    WifiManager wifiManager = (WifiManager) application.getSystemService(Context.WIFI_SERVICE);</div><div class=\"line\">    <span class=\"keyword\">if</span> (!wifiManager.isWifiEnabled()) &#123;</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">for</span> (Enumeration&lt;NetworkInterface&gt; en = NetworkInterface.getNetworkInterfaces(); en.hasMoreElements(); ) &#123;</div><div class=\"line\">                NetworkInterface intf = en.nextElement();</div><div class=\"line\">                <span class=\"keyword\">for</span> (Enumeration&lt;InetAddress&gt; enumIpAddr = intf.getInetAddresses(); enumIpAddr.hasMoreElements(); ) &#123;</div><div class=\"line\">                    InetAddress inetAddress = enumIpAddr.nextElement();</div><div class=\"line\">                    <span class=\"keyword\">if</span> (!inetAddress.isLoopbackAddress()) &#123;</div><div class=\"line\">                        <span class=\"function\"><span class=\"keyword\">return</span> inetAddress.<span class=\"title\">getHostAddress</span><span class=\"params\">()</span></span>;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SocketException e) &#123;</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        WifiInfo wifiInfo = wifiManager.getConnectionInfo();</div><div class=\"line\">        <span class=\"keyword\">int</span> ipAddress = wifiInfo.getIpAddress();</div><div class=\"line\">        String ip = intToIp(ipAddress);</div><div class=\"line\">        <span class=\"keyword\">return</span> ip;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"function\">String <span class=\"title\">intToIp</span><span class=\"params\">(<span class=\"keyword\">int</span> i)</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (i &amp; <span class=\"number\">0xFF</span>) + <span class=\"string\">\".\"</span> +</div><div class=\"line\">            ((i &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) + <span class=\"string\">\".\"</span> +</div><div class=\"line\">            ((i &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) + <span class=\"string\">\".\"</span> +</div><div class=\"line\">            (i &gt;&gt; <span class=\"number\">24</span> &amp; <span class=\"number\">0xFF</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>Server监听端口：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\">public void startListening() &#123;</div><div class=\"line\">    stop = false<span class=\"comment\">;</span></div><div class=\"line\">    mHandler.post(new Runnable() &#123;</div><div class=\"line\">        @Override</div><div class=\"line\">        public void run() &#123;</div><div class=\"line\">            try &#123;</div><div class=\"line\">                <span class=\"keyword\">byte[] </span><span class=\"keyword\">buf </span>= new <span class=\"keyword\">byte[1024];</span></div><div class=\"line\">                DatagramSocket ds = new DatagramSocket(LISTENING_PORT)<span class=\"comment\">;</span></div><div class=\"line\">                DatagramPacket dp = new DatagramPacket(<span class=\"keyword\">buf, </span><span class=\"keyword\">buf.length);</span></div><div class=\"line\">                String ip = getIP(MyApplication.getApplication())<span class=\"comment\">;</span></div><div class=\"line\">                Log.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"startListening:\"</span> + ip)<span class=\"comment\">;</span></div><div class=\"line\">                ds.receive(dp)<span class=\"comment\">;</span></div><div class=\"line\">                ds.<span class=\"keyword\">close();</span></div><div class=\"line\">                StringBuffer <span class=\"keyword\">sb </span>= new StringBuffer()<span class=\"comment\">;</span></div><div class=\"line\">                int i<span class=\"comment\">;</span></div><div class=\"line\">                for (i = <span class=\"number\">0</span><span class=\"comment\">; i &lt; 1024; i++) &#123;</span></div><div class=\"line\">                    if (<span class=\"keyword\">buf[i] </span>== <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                        <span class=\"keyword\">break;</span></div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">sb.append((char) </span><span class=\"keyword\">buf[i]);</span></div><div class=\"line\">                &#125;</div><div class=\"line\">                sendIpBroadcast(<span class=\"keyword\">sb.toString());</span></div><div class=\"line\">                setupServer()<span class=\"comment\">;</span></div><div class=\"line\">            &#125; catch (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace()<span class=\"comment\">;</span></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;)<span class=\"comment\">;</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>上面代码会在ds.receive(dp)阻塞，直到收到消息。<br>Client发送广播：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">sendIpBroadcast</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">final</span> String message = getIP(MyApplication.getApplication());</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                InetAddress adds = InetAddress.getByName(BROADCAST_IP);</div><div class=\"line\">                DatagramSocket ds = <span class=\"keyword\">new</span> DatagramSocket();</div><div class=\"line\">                DatagramPacket dp = <span class=\"keyword\">new</span> DatagramPacket(message.getBytes(),</div><div class=\"line\">                        message.length(), adds, LISTENING_PORT);</div><div class=\"line\">                ds.send(dp);</div><div class=\"line\">                ds.close();</div><div class=\"line\">                startListening();</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>Client将自己的ip通过UDP广播发送出来，同时监听一个端口，用于接收Server发出的广播（带Server ip）。Server的ds.receive(dp)执行，获取到Client ip之后，便是发送自身的ip，以及建立ServerSocket。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setupServer</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                mServerSocket = <span class=\"keyword\">new</span> ServerSocket(SERVER_PORT);</div><div class=\"line\">                <span class=\"keyword\">while</span> (!stop) &#123;</div><div class=\"line\">                    Socket socket = mServerSocket.accept();</div><div class=\"line\">                    socketList.add(socket);</div><div class=\"line\">                    <span class=\"keyword\">new</span> Thread(<span class=\"keyword\">new</span> MyServerRunnable(socket)).start();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>mServerSocket.accept()也是个阻塞方法，直到有Client连接进来。<br>Client通过监听收到Server ip，之后便是建立连接了。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">connect</span><span class=\"params\">(<span class=\"keyword\">final</span> String serverIp)</span> </span>&#123;</div><div class=\"line\">    mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                socket = <span class=\"keyword\">new</span> Socket(serverIp, SERVER_PORT);</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过<code>socket = new Socket(serverIp, SERVER_PORT);</code>即可建立连接了（也是阻塞方法）。</p>\n<h2 id=\"时间对齐\"><a href=\"#时间对齐\" class=\"headerlink\" title=\"时间对齐\"></a>时间对齐</h2><p>对于直播这种实时传递音视频数据的需求，在传递数据的时候都是需要打上时间戳的，用于计算超时。但是在不同手机上的时钟表现是不一样的，所以需要选取一个标准，这里我选用Server的时间。那么Client的时间如何与Server的时间对齐呢？我的方案是：Client发送本身时间到Server，Server在收到请求后回复自身的时间到Client，Client记录下发送请求的时间，与收到回复的时间。记发送请求的时间为C1，收到回复的时间为C2，Server回复的时间为S1。我们假定网络是稳定的，那么便能得到如下结论：</p>\n<blockquote>\n<p>(C1 + C2) / 2  ==&gt;  S1<br>即Client在（C1 + C2）/ 2这个时刻，Server的时间是S1.</p>\n</blockquote>\n<p>记后续发请求的时间为C’，记此时Server的时间为S’，那么便会有如下公式：</p>\n<blockquote>\n<p>C’ - (C1 + C2) / 2 = S’ - S1 (Client与Server同时流逝的时间是一致的)<br>==&gt;  S’ = C’ - (C1 + C2)/2 + S1  ==&gt; S’ = C’ - C2 + (C2-C1) / 2 + S1</p>\n</blockquote>\n<p>如此在Client每次发送实时音视频数据时，便可依据Client此刻的时间计算出Server端的时间，打上时间戳后传递到Server端，Server端收到后可以与Server此刻的时间对比，来进行超时的计算或其他的一些处理。<br>这里姑且理解<code>delta = (C2-C1) / 2</code>为Client传递数据到Server的时间。这个时间越小，对齐得便越精准。所以需要多发送几次请求，然后取最小的delta。另外发送请求的时候包上时间数据，模拟收发的数据量是一致的。</p>\n<h2 id=\"传递H264数据\"><a href=\"#传递H264数据\" class=\"headerlink\" title=\"传递H264数据\"></a>传递H264数据</h2><p>通过我之前的文章，已经可以采集到H264的数据了，格式是byte数组，那么要如何通过Socket传递到Server呢？我之前是利用<code>BufferedWriter</code>的write(String msg)方法，new String(byte[] data)。服务端在收到后通过String.getBytes()还原byte[]，但是将这种数据传递到MediaCodec进行解码，输出不出正确的视频。所以后面干脆就直接利用DataOutputStream传递byte[]数组了。<br>解码代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initMediaDecode</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    Log.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"initMediaDecode\"</span>);</div><div class=\"line\">    MediaFormat format = MediaFormat.createVideoFormat(<span class=\"string\">\"video/avc\"</span>, <span class=\"number\">1280</span>, <span class=\"number\">720</span>);</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        decoder = MediaCodec.createDecoderByType(<span class=\"string\">\"video/avc\"</span>);</div><div class=\"line\">        <span class=\"comment\">// 直接输出到surfaceView</span></div><div class=\"line\">        decoder.configure(format, surfaceView.getHolder().getSurface(), <span class=\"keyword\">null</span>, <span class=\"number\">0</span>);</div><div class=\"line\">        decoder.start();</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">        e.printStackTrace();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">new</span> DecodeThread().start();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DecodeThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">Thread</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    MediaCodec.BufferInfo mBufferInfo;</div><div class=\"line\">    <span class=\"keyword\">int</span> mCount = <span class=\"number\">0</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DecodeThread</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        mBufferInfo = <span class=\"keyword\">new</span> MediaCodec.BufferInfo();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (h264data.size() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    <span class=\"keyword\">byte</span>[] data = h264data.get(<span class=\"number\">0</span>);</div><div class=\"line\">                    h264data.remove(<span class=\"number\">0</span>);</div><div class=\"line\">                    Log.e(<span class=\"string\">\"Media\"</span>, <span class=\"string\">\"save to file data size:\"</span> + data.length);</div><div class=\"line\">                    <span class=\"comment\">// 保存数据到文件</span></div><div class=\"line\">                    <span class=\"comment\">// Util.save(data, 0, data.length, path, true);</span></div><div class=\"line\"></div><div class=\"line\">                    ByteBuffer[] inputBuffers = decoder.getInputBuffers();</div><div class=\"line\">                    <span class=\"keyword\">int</span> inputBufferIndex = decoder.dequeueInputBuffer(<span class=\"number\">100</span>);</div><div class=\"line\">                    <span class=\"keyword\">if</span> (inputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                        ByteBuffer inputBuffer = inputBuffers[inputBufferIndex];</div><div class=\"line\">                        inputBuffer.clear();</div><div class=\"line\">                        inputBuffer.put(data);</div><div class=\"line\">                        decoder.queueInputBuffer(inputBufferIndex, <span class=\"number\">0</span>, data.length, mCount * TIME_INTERNAL, <span class=\"number\">0</span>);</div><div class=\"line\">                    &#125;</div><div class=\"line\"></div><div class=\"line\">                    <span class=\"comment\">// Get output buffer index</span></div><div class=\"line\">                    <span class=\"keyword\">int</span> outputBufferIndex = decoder.dequeueOutputBuffer(mBufferInfo, <span class=\"number\">100</span>);</div><div class=\"line\">                    <span class=\"keyword\">while</span> (outputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                        Log.e(<span class=\"string\">\"Media\"</span>, <span class=\"string\">\"onFrame index:\"</span> + outputBufferIndex);</div><div class=\"line\">                        decoder.releaseOutputBuffer(outputBufferIndex, <span class=\"keyword\">true</span>);</div><div class=\"line\">                        outputBufferIndex = decoder.dequeueOutputBuffer(mBufferInfo, <span class=\"number\">0</span>);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    sleep(TIME_INTERNAL);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过此种解码，发现解码的视频花屏，但是存入到文件中再打开则是比较清晰流畅的，估计是解码有问题。</p>\n<p><a href=\"https://github.com/LiJia92/SocketDemo\" target=\"_blank\" rel=\"external\">Demo代码</a></p>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>通过前面一段时间的摸索，iOS的Multipeer Connectivity与Android的Wifi-Direct并不兼容，一些三方可能都是需要连接热点才能实现跨平台传输。热点是需要连接到同一个网络环境下的，那么考虑下Socket是否可行呢？理论上，应该是没问题的。为了验证，我这边便开始Android端的测试，至于跨平台就得等到iOS那边一起合作来验证了。</p>\n<h2 id=\"Socket连接\"><a href=\"#Socket连接\" class=\"headerlink\" title=\"Socket连接\"></a>Socket连接</h2><p>这里分一个Client（采集实时数据），一个server（接收数据进行处理）这样的两个角色。在一个局域网下，他们要互相建立连接首先便是要能互相发现。我的方案是：Server监听一个端口，Client发送一个绑定端口的广播（UDP），广播信息包含Client的ip，Server再收到广播之后，利用收到的ip发送一个单播到Client，单播信息包含Server的ip，Client收到之后便知道Server的ip了，那么便可以建立连接了。</p>","more":"<p>获取ip：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"function\">String <span class=\"title\">getIP</span><span class=\"params\">(Context application)</span> </span>&#123;</div><div class=\"line\">    WifiManager wifiManager = (WifiManager) application.getSystemService(Context.WIFI_SERVICE);</div><div class=\"line\">    <span class=\"keyword\">if</span> (!wifiManager.isWifiEnabled()) &#123;</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">for</span> (Enumeration&lt;NetworkInterface&gt; en = NetworkInterface.getNetworkInterfaces(); en.hasMoreElements(); ) &#123;</div><div class=\"line\">                NetworkInterface intf = en.nextElement();</div><div class=\"line\">                <span class=\"keyword\">for</span> (Enumeration&lt;InetAddress&gt; enumIpAddr = intf.getInetAddresses(); enumIpAddr.hasMoreElements(); ) &#123;</div><div class=\"line\">                    InetAddress inetAddress = enumIpAddr.nextElement();</div><div class=\"line\">                    <span class=\"keyword\">if</span> (!inetAddress.isLoopbackAddress()) &#123;</div><div class=\"line\">                        <span class=\"function\"><span class=\"keyword\">return</span> inetAddress.<span class=\"title\">getHostAddress</span><span class=\"params\">()</span></span>;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SocketException e) &#123;</div><div class=\"line\">            e.printStackTrace();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        WifiInfo wifiInfo = wifiManager.getConnectionInfo();</div><div class=\"line\">        <span class=\"keyword\">int</span> ipAddress = wifiInfo.getIpAddress();</div><div class=\"line\">        String ip = intToIp(ipAddress);</div><div class=\"line\">        <span class=\"keyword\">return</span> ip;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"function\">String <span class=\"title\">intToIp</span><span class=\"params\">(<span class=\"keyword\">int</span> i)</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> (i &amp; <span class=\"number\">0xFF</span>) + <span class=\"string\">\".\"</span> +</div><div class=\"line\">            ((i &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) + <span class=\"string\">\".\"</span> +</div><div class=\"line\">            ((i &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) + <span class=\"string\">\".\"</span> +</div><div class=\"line\">            (i &gt;&gt; <span class=\"number\">24</span> &amp; <span class=\"number\">0xFF</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>Server监听端口：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\">public void startListening() &#123;</div><div class=\"line\">    stop = false<span class=\"comment\">;</span></div><div class=\"line\">    mHandler.post(new Runnable() &#123;</div><div class=\"line\">        @Override</div><div class=\"line\">        public void run() &#123;</div><div class=\"line\">            try &#123;</div><div class=\"line\">                <span class=\"keyword\">byte[] </span><span class=\"keyword\">buf </span>= new <span class=\"keyword\">byte[1024];</div><div class=\"line\"></span>                DatagramSocket ds = new DatagramSocket(LISTENING_PORT)<span class=\"comment\">;</span></div><div class=\"line\">                DatagramPacket dp = new DatagramPacket(<span class=\"keyword\">buf, </span><span class=\"keyword\">buf.length);</div><div class=\"line\"></span>                String ip = getIP(MyApplication.getApplication())<span class=\"comment\">;</span></div><div class=\"line\">                Log.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"startListening:\"</span> + ip)<span class=\"comment\">;</span></div><div class=\"line\">                ds.receive(dp)<span class=\"comment\">;</span></div><div class=\"line\">                ds.<span class=\"keyword\">close();</div><div class=\"line\"></span>                StringBuffer <span class=\"keyword\">sb </span>= new StringBuffer()<span class=\"comment\">;</span></div><div class=\"line\">                int i<span class=\"comment\">;</span></div><div class=\"line\">                for (i = <span class=\"number\">0</span><span class=\"comment\">; i &lt; 1024; i++) &#123;</span></div><div class=\"line\">                    if (<span class=\"keyword\">buf[i] </span>== <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                        <span class=\"keyword\">break;</div><div class=\"line\"></span>                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">sb.append((char) </span><span class=\"keyword\">buf[i]);</div><div class=\"line\"></span>                &#125;</div><div class=\"line\">                sendIpBroadcast(<span class=\"keyword\">sb.toString());</div><div class=\"line\"></span>                setupServer()<span class=\"comment\">;</span></div><div class=\"line\">            &#125; catch (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace()<span class=\"comment\">;</span></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;)<span class=\"comment\">;</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>上面代码会在ds.receive(dp)阻塞，直到收到消息。<br>Client发送广播：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">sendIpBroadcast</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">final</span> String message = getIP(MyApplication.getApplication());</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                InetAddress adds = InetAddress.getByName(BROADCAST_IP);</div><div class=\"line\">                DatagramSocket ds = <span class=\"keyword\">new</span> DatagramSocket();</div><div class=\"line\">                DatagramPacket dp = <span class=\"keyword\">new</span> DatagramPacket(message.getBytes(),</div><div class=\"line\">                        message.length(), adds, LISTENING_PORT);</div><div class=\"line\">                ds.send(dp);</div><div class=\"line\">                ds.close();</div><div class=\"line\">                startListening();</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>Client将自己的ip通过UDP广播发送出来，同时监听一个端口，用于接收Server发出的广播（带Server ip）。Server的ds.receive(dp)执行，获取到Client ip之后，便是发送自身的ip，以及建立ServerSocket。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setupServer</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                mServerSocket = <span class=\"keyword\">new</span> ServerSocket(SERVER_PORT);</div><div class=\"line\">                <span class=\"keyword\">while</span> (!stop) &#123;</div><div class=\"line\">                    Socket socket = mServerSocket.accept();</div><div class=\"line\">                    socketList.add(socket);</div><div class=\"line\">                    <span class=\"keyword\">new</span> Thread(<span class=\"keyword\">new</span> MyServerRunnable(socket)).start();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>mServerSocket.accept()也是个阻塞方法，直到有Client连接进来。<br>Client通过监听收到Server ip，之后便是建立连接了。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">connect</span><span class=\"params\">(<span class=\"keyword\">final</span> String serverIp)</span> </span>&#123;</div><div class=\"line\">    mHandler.post(<span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                socket = <span class=\"keyword\">new</span> Socket(serverIp, SERVER_PORT);</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过<code>socket = new Socket(serverIp, SERVER_PORT);</code>即可建立连接了（也是阻塞方法）。</p>\n<h2 id=\"时间对齐\"><a href=\"#时间对齐\" class=\"headerlink\" title=\"时间对齐\"></a>时间对齐</h2><p>对于直播这种实时传递音视频数据的需求，在传递数据的时候都是需要打上时间戳的，用于计算超时。但是在不同手机上的时钟表现是不一样的，所以需要选取一个标准，这里我选用Server的时间。那么Client的时间如何与Server的时间对齐呢？我的方案是：Client发送本身时间到Server，Server在收到请求后回复自身的时间到Client，Client记录下发送请求的时间，与收到回复的时间。记发送请求的时间为C1，收到回复的时间为C2，Server回复的时间为S1。我们假定网络是稳定的，那么便能得到如下结论：</p>\n<blockquote>\n<p>(C1 + C2) / 2  ==&gt;  S1<br>即Client在（C1 + C2）/ 2这个时刻，Server的时间是S1.</p>\n</blockquote>\n<p>记后续发请求的时间为C’，记此时Server的时间为S’，那么便会有如下公式：</p>\n<blockquote>\n<p>C’ - (C1 + C2) / 2 = S’ - S1 (Client与Server同时流逝的时间是一致的)<br>==&gt;  S’ = C’ - (C1 + C2)/2 + S1  ==&gt; S’ = C’ - C2 + (C2-C1) / 2 + S1</p>\n</blockquote>\n<p>如此在Client每次发送实时音视频数据时，便可依据Client此刻的时间计算出Server端的时间，打上时间戳后传递到Server端，Server端收到后可以与Server此刻的时间对比，来进行超时的计算或其他的一些处理。<br>这里姑且理解<code>delta = (C2-C1) / 2</code>为Client传递数据到Server的时间。这个时间越小，对齐得便越精准。所以需要多发送几次请求，然后取最小的delta。另外发送请求的时候包上时间数据，模拟收发的数据量是一致的。</p>\n<h2 id=\"传递H264数据\"><a href=\"#传递H264数据\" class=\"headerlink\" title=\"传递H264数据\"></a>传递H264数据</h2><p>通过我之前的文章，已经可以采集到H264的数据了，格式是byte数组，那么要如何通过Socket传递到Server呢？我之前是利用<code>BufferedWriter</code>的write(String msg)方法，new String(byte[] data)。服务端在收到后通过String.getBytes()还原byte[]，但是将这种数据传递到MediaCodec进行解码，输出不出正确的视频。所以后面干脆就直接利用DataOutputStream传递byte[]数组了。<br>解码代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">initMediaDecode</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    Log.e(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"initMediaDecode\"</span>);</div><div class=\"line\">    MediaFormat format = MediaFormat.createVideoFormat(<span class=\"string\">\"video/avc\"</span>, <span class=\"number\">1280</span>, <span class=\"number\">720</span>);</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        decoder = MediaCodec.createDecoderByType(<span class=\"string\">\"video/avc\"</span>);</div><div class=\"line\">        <span class=\"comment\">// 直接输出到surfaceView</span></div><div class=\"line\">        decoder.configure(format, surfaceView.getHolder().getSurface(), <span class=\"keyword\">null</span>, <span class=\"number\">0</span>);</div><div class=\"line\">        decoder.start();</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</div><div class=\"line\">        e.printStackTrace();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">new</span> DecodeThread().start();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DecodeThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">Thread</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    MediaCodec.BufferInfo mBufferInfo;</div><div class=\"line\">    <span class=\"keyword\">int</span> mCount = <span class=\"number\">0</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DecodeThread</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        mBufferInfo = <span class=\"keyword\">new</span> MediaCodec.BufferInfo();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (h264data.size() &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                    <span class=\"keyword\">byte</span>[] data = h264data.get(<span class=\"number\">0</span>);</div><div class=\"line\">                    h264data.remove(<span class=\"number\">0</span>);</div><div class=\"line\">                    Log.e(<span class=\"string\">\"Media\"</span>, <span class=\"string\">\"save to file data size:\"</span> + data.length);</div><div class=\"line\">                    <span class=\"comment\">// 保存数据到文件</span></div><div class=\"line\">                    <span class=\"comment\">// Util.save(data, 0, data.length, path, true);</span></div><div class=\"line\"></div><div class=\"line\">                    ByteBuffer[] inputBuffers = decoder.getInputBuffers();</div><div class=\"line\">                    <span class=\"keyword\">int</span> inputBufferIndex = decoder.dequeueInputBuffer(<span class=\"number\">100</span>);</div><div class=\"line\">                    <span class=\"keyword\">if</span> (inputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                        ByteBuffer inputBuffer = inputBuffers[inputBufferIndex];</div><div class=\"line\">                        inputBuffer.clear();</div><div class=\"line\">                        inputBuffer.put(data);</div><div class=\"line\">                        decoder.queueInputBuffer(inputBufferIndex, <span class=\"number\">0</span>, data.length, mCount * TIME_INTERNAL, <span class=\"number\">0</span>);</div><div class=\"line\">                    &#125;</div><div class=\"line\"></div><div class=\"line\">                    <span class=\"comment\">// Get output buffer index</span></div><div class=\"line\">                    <span class=\"keyword\">int</span> outputBufferIndex = decoder.dequeueOutputBuffer(mBufferInfo, <span class=\"number\">100</span>);</div><div class=\"line\">                    <span class=\"keyword\">while</span> (outputBufferIndex &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                        Log.e(<span class=\"string\">\"Media\"</span>, <span class=\"string\">\"onFrame index:\"</span> + outputBufferIndex);</div><div class=\"line\">                        decoder.releaseOutputBuffer(outputBufferIndex, <span class=\"keyword\">true</span>);</div><div class=\"line\">                        outputBufferIndex = decoder.dequeueOutputBuffer(mBufferInfo, <span class=\"number\">0</span>);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    sleep(TIME_INTERNAL);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\">                e.printStackTrace();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过此种解码，发现解码的视频花屏，但是存入到文件中再打开则是比较清晰流畅的，估计是解码有问题。</p>\n<p><a href=\"https://github.com/LiJia92/SocketDemo\">Demo代码</a></p>"},{"title":"Android状态栏小记","date":"2016-08-04T06:29:46.000Z","_content":"\n最近做了一个需求：在全屏看视频的时候，点击空白处，显示状态栏。距离最后一次点击5秒后，自动收起状态栏。\n最后做出的效果如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar1.gif)\n\n<!-- more -->\n\n## 状态栏显示与隐藏\n首先状态栏的显示与隐藏代码如下：\n```\nprivate void showOperation() {\n    isShowing = true;\n    handler.removeCallbacks(showOrHide);\n    handler.postDelayed(showOrHide, 5000);\n    // 显示状态栏\n    WindowManager.LayoutParams attr = getWindow().getAttributes();\n    attr.flags &= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);\n    getWindow().setAttributes(attr);\n    getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n\n    top.setTranslationY(getStatusBarHeight());\n}\n\n/**\n * 获取状态栏高度\n */\npublic int getStatusBarHeight() {\n    int result = 0;\n    int resourceId = getResources().getIdentifier(\"status_bar_height\", \"dimen\", \"android\");\n    if (resourceId > 0) {\n        result = getResources().getDimensionPixelSize(resourceId);\n    }\n    return result;\n}\n\n/**\n * 隐藏状态栏\n */\nprivate void hideOperation() {\n    isShowing = false;\n    // 隐藏状态栏\n    WindowManager.LayoutParams lp = getWindow().getAttributes();\n    lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;\n    getWindow().setAttributes(lp);\n    getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n\n    top.setTranslationY(0);\n}\n```\n使用handler来进行自动收起，在每次有效操作时，刷新时间重新数5秒。\n```\nprivate Runnable showOrHide = new Runnable() {\n    @Override\n    public void run() {\n        hideOperation();\n    }\n};\n\nhandler.removeCallbacks(showOrHide);\nhandler.postDelayed(showOrHide, 5000);\n```\n\n## 全屏透明状态栏\n首先在Application的Theme里，我进行的如下配置：\n```\n<style name=\"AppTheme\" parent=\"Theme.AppCompat.Light.DarkActionBar\">\n    <!-- Customize your theme here. -->\n    <item name=\"colorPrimary\">@color/colorPrimary</item>\n    <item name=\"colorPrimaryDark\">@color/live_gray_bg</item>\n    <item name=\"colorAccent\">@color/colorAccent</item>\n    <item name=\"windowNoTitle\">true</item>\n    <item name=\"android:windowNoTitle\">true</item>\n    <item name=\"android:windowFullscreen\">true</item>\n</style>\n```\n整个App所有界面都是``FullScreen``的，``colorPrimaryDark``是状态栏的颜色，我这里设置的是``#4d000000``，一个带透明度的黑色,该属性只在``android5.0及以上``有效。\n然后在activity的onCreate里，在setContentView()之前，调用如下代码：\n```\nif (Build.VERSION.SDK_INT > 16) {\n    getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n            | View.SYSTEM_UI_LAYOUT_FLAGS | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION);\n}\n```\n针对View的各种FLAG这里列一下说明：\n1. View.SYSTEM_UI_FLAG_VISIBLE：显示状态栏，Activity不全屏显示(恢复到有状态的正常情况)；\n2. View.INVISIBLE：隐藏状态栏，同时Activity会伸展全屏显示；\n3. View.SYSTEM_UI_FLAG_FULLSCREEN：Activity全屏显示，且状态栏被隐藏覆盖掉；\n4. View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN：Activity全屏显示，但状态栏不会被隐藏覆盖，状态栏依然可见，Activity顶端布局部分会被状态遮住；\n5. View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION：效果同View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN；\n6. View.SYSTEM_UI_LAYOUT_FLAGS：效果同View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN；\n7. View.SYSTEM_UI_FLAG_HIDE_NAVIGATION：隐藏虚拟按键(导航栏)。有些手机会用虚拟按键来代替物理按键；\n8. View.SYSTEM_UI_FLAG_LOW_PROFILE：状态栏显示处于低能显示状态(low profile模式)，状态栏上一些图标显示会被隐藏。\n\n## 状态栏显示时布局调整\n通过上面的代码，这样整个状态栏就是按照我设置的颜色来显示了，他会直接覆盖在我们的布局上。\n那么问题来了，当状态栏显示的时候，他会盖在我们的布局上，那么如果布局顶部有View，那么就会被遮盖住，要如何解决呢？\n网上查了很多，说是在activity的根布局设置属性``android:fitsSystemWindows=\"true\"``，确实，设置后就不会遮盖在布局了，但是它会单独占据空间，设置的半透明的黑色背景也无作用了，另外界面会被压缩，然后屏幕会跳一下。\n发个图感受一下：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar2.gif)\n可以看到界面会跳，而且视频这种具有一定长宽比的可能会自适应，导致黑边，所以这不是一个解决方案，所以我没有添加这个属性。\n那么到底要怎么解决呢？\n其实是一个很笨的方法，上面的代码已经写到了：``在状态栏显示的时候，直接将被挡住的View下移``。\n即上面代码中的：\n```\ntop.setTranslationY(getStatusBarHeight());\ntop.setTranslationY(0);\n```\n在这里也可以添加动画，使效果更柔和一点。\n\n## 疑问\n在android4.4上达不到半透明这样的效果，设置的``colorPrimaryDark``是不起作用的，他会是一整个黑条（黑色和rom有关吧），看起来效果就会差一些了，不知道该要怎么解决，望了解的朋友可以指导一下~\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar3.gif)\nTip：找到很多修改颜色的文章，但是都是用到了``android:fitsSystemWindows=\"true\"``属性，故不是我的解决方案~\n","source":"_posts/statusbar.md","raw":"---\ntitle: Android状态栏小记\ndate: 2016-08-04 14:29:46\ntags:\n - 日常开发\n---\n\n最近做了一个需求：在全屏看视频的时候，点击空白处，显示状态栏。距离最后一次点击5秒后，自动收起状态栏。\n最后做出的效果如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar1.gif)\n\n<!-- more -->\n\n## 状态栏显示与隐藏\n首先状态栏的显示与隐藏代码如下：\n```\nprivate void showOperation() {\n    isShowing = true;\n    handler.removeCallbacks(showOrHide);\n    handler.postDelayed(showOrHide, 5000);\n    // 显示状态栏\n    WindowManager.LayoutParams attr = getWindow().getAttributes();\n    attr.flags &= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);\n    getWindow().setAttributes(attr);\n    getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n\n    top.setTranslationY(getStatusBarHeight());\n}\n\n/**\n * 获取状态栏高度\n */\npublic int getStatusBarHeight() {\n    int result = 0;\n    int resourceId = getResources().getIdentifier(\"status_bar_height\", \"dimen\", \"android\");\n    if (resourceId > 0) {\n        result = getResources().getDimensionPixelSize(resourceId);\n    }\n    return result;\n}\n\n/**\n * 隐藏状态栏\n */\nprivate void hideOperation() {\n    isShowing = false;\n    // 隐藏状态栏\n    WindowManager.LayoutParams lp = getWindow().getAttributes();\n    lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;\n    getWindow().setAttributes(lp);\n    getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n\n    top.setTranslationY(0);\n}\n```\n使用handler来进行自动收起，在每次有效操作时，刷新时间重新数5秒。\n```\nprivate Runnable showOrHide = new Runnable() {\n    @Override\n    public void run() {\n        hideOperation();\n    }\n};\n\nhandler.removeCallbacks(showOrHide);\nhandler.postDelayed(showOrHide, 5000);\n```\n\n## 全屏透明状态栏\n首先在Application的Theme里，我进行的如下配置：\n```\n<style name=\"AppTheme\" parent=\"Theme.AppCompat.Light.DarkActionBar\">\n    <!-- Customize your theme here. -->\n    <item name=\"colorPrimary\">@color/colorPrimary</item>\n    <item name=\"colorPrimaryDark\">@color/live_gray_bg</item>\n    <item name=\"colorAccent\">@color/colorAccent</item>\n    <item name=\"windowNoTitle\">true</item>\n    <item name=\"android:windowNoTitle\">true</item>\n    <item name=\"android:windowFullscreen\">true</item>\n</style>\n```\n整个App所有界面都是``FullScreen``的，``colorPrimaryDark``是状态栏的颜色，我这里设置的是``#4d000000``，一个带透明度的黑色,该属性只在``android5.0及以上``有效。\n然后在activity的onCreate里，在setContentView()之前，调用如下代码：\n```\nif (Build.VERSION.SDK_INT > 16) {\n    getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n            | View.SYSTEM_UI_LAYOUT_FLAGS | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION);\n}\n```\n针对View的各种FLAG这里列一下说明：\n1. View.SYSTEM_UI_FLAG_VISIBLE：显示状态栏，Activity不全屏显示(恢复到有状态的正常情况)；\n2. View.INVISIBLE：隐藏状态栏，同时Activity会伸展全屏显示；\n3. View.SYSTEM_UI_FLAG_FULLSCREEN：Activity全屏显示，且状态栏被隐藏覆盖掉；\n4. View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN：Activity全屏显示，但状态栏不会被隐藏覆盖，状态栏依然可见，Activity顶端布局部分会被状态遮住；\n5. View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION：效果同View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN；\n6. View.SYSTEM_UI_LAYOUT_FLAGS：效果同View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN；\n7. View.SYSTEM_UI_FLAG_HIDE_NAVIGATION：隐藏虚拟按键(导航栏)。有些手机会用虚拟按键来代替物理按键；\n8. View.SYSTEM_UI_FLAG_LOW_PROFILE：状态栏显示处于低能显示状态(low profile模式)，状态栏上一些图标显示会被隐藏。\n\n## 状态栏显示时布局调整\n通过上面的代码，这样整个状态栏就是按照我设置的颜色来显示了，他会直接覆盖在我们的布局上。\n那么问题来了，当状态栏显示的时候，他会盖在我们的布局上，那么如果布局顶部有View，那么就会被遮盖住，要如何解决呢？\n网上查了很多，说是在activity的根布局设置属性``android:fitsSystemWindows=\"true\"``，确实，设置后就不会遮盖在布局了，但是它会单独占据空间，设置的半透明的黑色背景也无作用了，另外界面会被压缩，然后屏幕会跳一下。\n发个图感受一下：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar2.gif)\n可以看到界面会跳，而且视频这种具有一定长宽比的可能会自适应，导致黑边，所以这不是一个解决方案，所以我没有添加这个属性。\n那么到底要怎么解决呢？\n其实是一个很笨的方法，上面的代码已经写到了：``在状态栏显示的时候，直接将被挡住的View下移``。\n即上面代码中的：\n```\ntop.setTranslationY(getStatusBarHeight());\ntop.setTranslationY(0);\n```\n在这里也可以添加动画，使效果更柔和一点。\n\n## 疑问\n在android4.4上达不到半透明这样的效果，设置的``colorPrimaryDark``是不起作用的，他会是一整个黑条（黑色和rom有关吧），看起来效果就会差一些了，不知道该要怎么解决，望了解的朋友可以指导一下~\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar3.gif)\nTip：找到很多修改颜色的文章，但是都是用到了``android:fitsSystemWindows=\"true\"``属性，故不是我的解决方案~\n","slug":"statusbar","published":1,"updated":"2016-11-21T10:03:26.623Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75aa002x1cb8rnkwh2gp","content":"<p>最近做了一个需求：在全屏看视频的时候，点击空白处，显示状态栏。距离最后一次点击5秒后，自动收起状态栏。<br>最后做出的效果如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar1.gif\" alt=\"\"></p>\n<a id=\"more\"></a>\n<h2 id=\"状态栏显示与隐藏\"><a href=\"#状态栏显示与隐藏\" class=\"headerlink\" title=\"状态栏显示与隐藏\"></a>状态栏显示与隐藏</h2><p>首先状态栏的显示与隐藏代码如下：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">showOperation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    isShowing = <span class=\"literal\">true</span>;</div><div class=\"line\">    handler.removeCallbacks(showOrHide);</div><div class=\"line\">    handler.postDelayed(showOrHide, <span class=\"number\">5000</span>);</div><div class=\"line\">    <span class=\"comment\">// 显示状态栏</span></div><div class=\"line\">    WindowManager.LayoutParams attr = getWindow().getAttributes();</div><div class=\"line\">    attr.flags &amp;= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);</div><div class=\"line\">    getWindow().setAttributes(attr);</div><div class=\"line\">    getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div><div class=\"line\"></div><div class=\"line\">    top.setTranslationY(getStatusBarHeight());</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 获取状态栏高度</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getStatusBarHeight</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">int</span> result = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">int</span> resourceId = getResources().getIdentifier(<span class=\"string\">\"status_bar_height\"</span>, <span class=\"string\">\"dimen\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (resourceId &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        result = getResources().getDimensionPixelSize(resourceId);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> result;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 隐藏状态栏</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">hideOperation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    isShowing = <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"comment\">// 隐藏状态栏</span></div><div class=\"line\">    WindowManager.LayoutParams lp = getWindow().getAttributes();</div><div class=\"line\">    lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;</div><div class=\"line\">    getWindow().setAttributes(lp);</div><div class=\"line\">    getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div><div class=\"line\"></div><div class=\"line\">    top.setTranslationY(<span class=\"number\">0</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>使用handler来进行自动收起，在每次有效操作时，刷新时间重新数5秒。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> Runnable showOrHide = <span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        hideOperation();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">handler</span>.removeCallbacks(showOrHide);</div><div class=\"line\"><span class=\"keyword\">handler</span>.postDelayed(showOrHide, <span class=\"number\">5000</span>);</div></pre></td></tr></table></figure></p>\n<h2 id=\"全屏透明状态栏\"><a href=\"#全屏透明状态栏\" class=\"headerlink\" title=\"全屏透明状态栏\"></a>全屏透明状态栏</h2><p>首先在Application的Theme里，我进行的如下配置：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">name</span>=<span class=\"string\">\"AppTheme\"</span> <span class=\"attr\">parent</span>=<span class=\"string\">\"Theme.AppCompat.Light.DarkActionBar\"</span>&gt;</span><span class=\"xml\"></span></div><div class=\"line\">    <span class=\"comment\">&lt;!-- Customize your theme here. --&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"colorPrimary\"</span>&gt;</span>@color/colorPrimary<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"colorPrimaryDark\"</span>&gt;</span>@color/live_gray_bg<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"colorAccent\"</span>&gt;</span>@color/colorAccent<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"windowNoTitle\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"android:windowNoTitle\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"android:windowFullscreen\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>整个App所有界面都是<code>FullScreen</code>的，<code>colorPrimaryDark</code>是状态栏的颜色，我这里设置的是<code>#4d000000</code>，一个带透明度的黑色,该属性只在<code>android5.0及以上</code>有效。<br>然后在activity的onCreate里，在setContentView()之前，调用如下代码：<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">if</span> (Build.<span class=\"keyword\">VERSION</span>.SDK_INT &gt; 16) &#123;</div><div class=\"line\">    getWindow().getDecorView().setSystemUiVisibility(<span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">            | <span class=\"keyword\">View</span>.SYSTEM_UI_LAYOUT_FLAGS | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class=\"line\">            | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>针对View的各种FLAG这里列一下说明：</p>\n<ol>\n<li>View.SYSTEM_UI_FLAG_VISIBLE：显示状态栏，Activity不全屏显示(恢复到有状态的正常情况)；</li>\n<li>View.INVISIBLE：隐藏状态栏，同时Activity会伸展全屏显示；</li>\n<li>View.SYSTEM_UI_FLAG_FULLSCREEN：Activity全屏显示，且状态栏被隐藏覆盖掉；</li>\n<li>View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN：Activity全屏显示，但状态栏不会被隐藏覆盖，状态栏依然可见，Activity顶端布局部分会被状态遮住；</li>\n<li>View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION：效果同View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN；</li>\n<li>View.SYSTEM_UI_LAYOUT_FLAGS：效果同View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN；</li>\n<li>View.SYSTEM_UI_FLAG_HIDE_NAVIGATION：隐藏虚拟按键(导航栏)。有些手机会用虚拟按键来代替物理按键；</li>\n<li>View.SYSTEM_UI_FLAG_LOW_PROFILE：状态栏显示处于低能显示状态(low profile模式)，状态栏上一些图标显示会被隐藏。</li>\n</ol>\n<h2 id=\"状态栏显示时布局调整\"><a href=\"#状态栏显示时布局调整\" class=\"headerlink\" title=\"状态栏显示时布局调整\"></a>状态栏显示时布局调整</h2><p>通过上面的代码，这样整个状态栏就是按照我设置的颜色来显示了，他会直接覆盖在我们的布局上。<br>那么问题来了，当状态栏显示的时候，他会盖在我们的布局上，那么如果布局顶部有View，那么就会被遮盖住，要如何解决呢？<br>网上查了很多，说是在activity的根布局设置属性<code>android:fitsSystemWindows=&quot;true&quot;</code>，确实，设置后就不会遮盖在布局了，但是它会单独占据空间，设置的半透明的黑色背景也无作用了，另外界面会被压缩，然后屏幕会跳一下。<br>发个图感受一下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar2.gif\" alt=\"\"><br>可以看到界面会跳，而且视频这种具有一定长宽比的可能会自适应，导致黑边，所以这不是一个解决方案，所以我没有添加这个属性。<br>那么到底要怎么解决呢？<br>其实是一个很笨的方法，上面的代码已经写到了：<code>在状态栏显示的时候，直接将被挡住的View下移</code>。<br>即上面代码中的：<br><figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">top.setTranslationY(getStatusBarHeight())<span class=\"comment\">;</span></div><div class=\"line\">top.setTranslationY(<span class=\"number\">0</span>)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>在这里也可以添加动画，使效果更柔和一点。</p>\n<h2 id=\"疑问\"><a href=\"#疑问\" class=\"headerlink\" title=\"疑问\"></a>疑问</h2><p>在android4.4上达不到半透明这样的效果，设置的<code>colorPrimaryDark</code>是不起作用的，他会是一整个黑条（黑色和rom有关吧），看起来效果就会差一些了，不知道该要怎么解决，望了解的朋友可以指导一下~<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar3.gif\" alt=\"\"><br>Tip：找到很多修改颜色的文章，但是都是用到了<code>android:fitsSystemWindows=&quot;true&quot;</code>属性，故不是我的解决方案~</p>\n","excerpt":"<p>最近做了一个需求：在全屏看视频的时候，点击空白处，显示状态栏。距离最后一次点击5秒后，自动收起状态栏。<br>最后做出的效果如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar1.gif\" alt=\"\"></p>","more":"<h2 id=\"状态栏显示与隐藏\"><a href=\"#状态栏显示与隐藏\" class=\"headerlink\" title=\"状态栏显示与隐藏\"></a>状态栏显示与隐藏</h2><p>首先状态栏的显示与隐藏代码如下：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">showOperation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    isShowing = <span class=\"literal\">true</span>;</div><div class=\"line\">    handler.removeCallbacks(showOrHide);</div><div class=\"line\">    handler.postDelayed(showOrHide, <span class=\"number\">5000</span>);</div><div class=\"line\">    <span class=\"comment\">// 显示状态栏</span></div><div class=\"line\">    WindowManager.LayoutParams attr = getWindow().getAttributes();</div><div class=\"line\">    attr.flags &amp;= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);</div><div class=\"line\">    getWindow().setAttributes(attr);</div><div class=\"line\">    getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div><div class=\"line\"></div><div class=\"line\">    top.setTranslationY(getStatusBarHeight());</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 获取状态栏高度</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getStatusBarHeight</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">int</span> result = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">int</span> resourceId = getResources().getIdentifier(<span class=\"string\">\"status_bar_height\"</span>, <span class=\"string\">\"dimen\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (resourceId &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        result = getResources().getDimensionPixelSize(resourceId);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> result;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 隐藏状态栏</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">hideOperation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    isShowing = <span class=\"literal\">false</span>;</div><div class=\"line\">    <span class=\"comment\">// 隐藏状态栏</span></div><div class=\"line\">    WindowManager.LayoutParams lp = getWindow().getAttributes();</div><div class=\"line\">    lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;</div><div class=\"line\">    getWindow().setAttributes(lp);</div><div class=\"line\">    getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div><div class=\"line\"></div><div class=\"line\">    top.setTranslationY(<span class=\"number\">0</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>使用handler来进行自动收起，在每次有效操作时，刷新时间重新数5秒。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> Runnable showOrHide = <span class=\"keyword\">new</span> Runnable() &#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        hideOperation();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">handler</span>.removeCallbacks(showOrHide);</div><div class=\"line\"><span class=\"keyword\">handler</span>.postDelayed(showOrHide, <span class=\"number\">5000</span>);</div></pre></td></tr></table></figure></p>\n<h2 id=\"全屏透明状态栏\"><a href=\"#全屏透明状态栏\" class=\"headerlink\" title=\"全屏透明状态栏\"></a>全屏透明状态栏</h2><p>首先在Application的Theme里，我进行的如下配置：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">style</span> <span class=\"attr\">name</span>=<span class=\"string\">\"AppTheme\"</span> <span class=\"attr\">parent</span>=<span class=\"string\">\"Theme.AppCompat.Light.DarkActionBar\"</span>&gt;</span><span class=\"xml\"></div><div class=\"line\">    <span class=\"comment\">&lt;!-- Customize your theme here. --&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"colorPrimary\"</span>&gt;</span>@color/colorPrimary<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"colorPrimaryDark\"</span>&gt;</span>@color/live_gray_bg<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"colorAccent\"</span>&gt;</span>@color/colorAccent<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"windowNoTitle\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"android:windowNoTitle\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">item</span> <span class=\"attr\">name</span>=<span class=\"string\">\"android:windowFullscreen\"</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">item</span>&gt;</span></div><div class=\"line\"></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>整个App所有界面都是<code>FullScreen</code>的，<code>colorPrimaryDark</code>是状态栏的颜色，我这里设置的是<code>#4d000000</code>，一个带透明度的黑色,该属性只在<code>android5.0及以上</code>有效。<br>然后在activity的onCreate里，在setContentView()之前，调用如下代码：<br><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">if</span> (Build.<span class=\"keyword\">VERSION</span>.SDK_INT &gt; 16) &#123;</div><div class=\"line\">    getWindow().getDecorView().setSystemUiVisibility(<span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">            | <span class=\"keyword\">View</span>.SYSTEM_UI_LAYOUT_FLAGS | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class=\"line\">            | <span class=\"keyword\">View</span>.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>针对View的各种FLAG这里列一下说明：</p>\n<ol>\n<li>View.SYSTEM_UI_FLAG_VISIBLE：显示状态栏，Activity不全屏显示(恢复到有状态的正常情况)；</li>\n<li>View.INVISIBLE：隐藏状态栏，同时Activity会伸展全屏显示；</li>\n<li>View.SYSTEM_UI_FLAG_FULLSCREEN：Activity全屏显示，且状态栏被隐藏覆盖掉；</li>\n<li>View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN：Activity全屏显示，但状态栏不会被隐藏覆盖，状态栏依然可见，Activity顶端布局部分会被状态遮住；</li>\n<li>View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION：效果同View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN；</li>\n<li>View.SYSTEM_UI_LAYOUT_FLAGS：效果同View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN；</li>\n<li>View.SYSTEM_UI_FLAG_HIDE_NAVIGATION：隐藏虚拟按键(导航栏)。有些手机会用虚拟按键来代替物理按键；</li>\n<li>View.SYSTEM_UI_FLAG_LOW_PROFILE：状态栏显示处于低能显示状态(low profile模式)，状态栏上一些图标显示会被隐藏。</li>\n</ol>\n<h2 id=\"状态栏显示时布局调整\"><a href=\"#状态栏显示时布局调整\" class=\"headerlink\" title=\"状态栏显示时布局调整\"></a>状态栏显示时布局调整</h2><p>通过上面的代码，这样整个状态栏就是按照我设置的颜色来显示了，他会直接覆盖在我们的布局上。<br>那么问题来了，当状态栏显示的时候，他会盖在我们的布局上，那么如果布局顶部有View，那么就会被遮盖住，要如何解决呢？<br>网上查了很多，说是在activity的根布局设置属性<code>android:fitsSystemWindows=&quot;true&quot;</code>，确实，设置后就不会遮盖在布局了，但是它会单独占据空间，设置的半透明的黑色背景也无作用了，另外界面会被压缩，然后屏幕会跳一下。<br>发个图感受一下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar2.gif\" alt=\"\"><br>可以看到界面会跳，而且视频这种具有一定长宽比的可能会自适应，导致黑边，所以这不是一个解决方案，所以我没有添加这个属性。<br>那么到底要怎么解决呢？<br>其实是一个很笨的方法，上面的代码已经写到了：<code>在状态栏显示的时候，直接将被挡住的View下移</code>。<br>即上面代码中的：<br><figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">top.setTranslationY(getStatusBarHeight())<span class=\"comment\">;</span></div><div class=\"line\">top.setTranslationY(<span class=\"number\">0</span>)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>在这里也可以添加动画，使效果更柔和一点。</p>\n<h2 id=\"疑问\"><a href=\"#疑问\" class=\"headerlink\" title=\"疑问\"></a>疑问</h2><p>在android4.4上达不到半透明这样的效果，设置的<code>colorPrimaryDark</code>是不起作用的，他会是一整个黑条（黑色和rom有关吧），看起来效果就会差一些了，不知道该要怎么解决，望了解的朋友可以指导一下~<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/08/statusbar3.gif\" alt=\"\"><br>Tip：找到很多修改颜色的文章，但是都是用到了<code>android:fitsSystemWindows=&quot;true&quot;</code>属性，故不是我的解决方案~</p>"},{"title":"Android仿QQ实现ListView滑动删除","date":"2015-11-13T18:09:38.000Z","_content":"\n## 前言\n手机QQ应该是很普及的App了，看到QQ消息栏对话框列表的每个子项左滑的时候会弹出删除、置顶图标。like this：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/swipe-listview1.png)\n于是突发奇想：想要自己实现一个这样的效果。\n很显然的，这样的效果实现要依赖Android的事件分发机制，于是我先从Android事件分发入手。对于事件分发还不太熟悉的朋友可以参考[Android事件分发机制学习](http://lijia92.github.io/2015/11/14/touch-event/)。\n下面开工！\n\n<!--more-->\n\n## List Item\n首先，针对ListView的每个Item自定义一个MyItemLayout。代码如下：\n```\npublic class MyItemLayout extends LinearLayout {\n\n    // content View\n    private LinearLayout contentView;\n    // menu View\n    private LinearLayout menuView;\n    // content View的布局参数对象\n    private LayoutParams contentLayout;\n    // 菜单是否打开\n    private boolean isMenuOpen;\n    // contentView最小的leftMargin\n    private int minLeftMargin;\n    // contentView最大的leftMargin\n    private int maxLeftMargin = 0;\n    // 滑动类\n    private Scroller mScroller = null;\n\n    public MyItemLayout(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        contentLayout = new LayoutParams(getScreenWidth(), LayoutParams.WRAP_CONTENT);\n        mScroller = new Scroller(context);\n    }\n\n    @Override\n    public void computeScroll() {\n        if (mScroller.computeScrollOffset()) {\n            setLeftMargin(mScroller.getCurrX());\n            postInvalidate();\n        }\n    }\n\n    /**\n     * Scroller平滑打开Menu\n     */\n    public void smoothOpenMenu() {\n        isMenuOpen = true;\n        mScroller.startScroll(contentLayout.leftMargin, 0, minLeftMargin - contentLayout.leftMargin, 0, 350);\n        postInvalidate();\n    }\n\n    /**\n     * Scroller平滑关闭Menu\n     */\n    public void smoothCloseMenu() {\n        isMenuOpen = false;\n        mScroller.startScroll(contentLayout.leftMargin, 0, maxLeftMargin - contentLayout.leftMargin, 0, 350);\n        postInvalidate();\n    }\n\n    /**\n     * 在布局inflate完成后调用\n     */\n    @Override\n    protected void onFinishInflate() {\n        super.onFinishInflate();\n        // 第一个孩子是contentView\n        contentView = (LinearLayout) getChildAt(0);\n        // 第二个孩子是MenuView\n        menuView = (LinearLayout) getChildAt(1);\n        // 最小的leftMargin为负的menuView宽度\n        ViewGroup.LayoutParams lp = menuView.getLayoutParams();\n        minLeftMargin = -lp.width;\n    }\n\n    /**\n     * 获取屏幕宽度\n     * @return\n     */\n    private int getScreenWidth() {\n        DisplayMetrics dm = getResources().getDisplayMetrics();\n        return dm.widthPixels;\n    }\n\n    /**\n     * 给contentView设置leftMargin\n     * @param leftMargin\n     */\n    public void setLeftMargin(int leftMargin) {\n        // 控制leftMargin不越界\n        if (leftMargin > maxLeftMargin) {\n            leftMargin = maxLeftMargin;\n        }\n        if (leftMargin < minLeftMargin) {\n            leftMargin = minLeftMargin;\n        }\n        contentLayout.leftMargin = leftMargin;\n        // 通过设置leftMargin，达到menu显示的效果\n        contentView.setLayoutParams(contentLayout);\n    }\n\n    /**\n     * 获取menuView宽度\n     * @return\n     */\n    public int getMenuWidth() {\n        return -minLeftMargin;\n    }\n\n    /**\n     * Menu是否打开\n     * @return\n     */\n    public boolean isMenuOpen() {\n        return isMenuOpen;\n    }\n\n}\n```\n每个Item有2个直接子节点，第一个是contentView，第二个是menuView。通过设置contentView的leftMargin，达到显示Menu的效果。初始时，leftMargin为0，Menu完全隐藏。当滑动时，leftMargin逐渐缩小（因为是负数），当leftMargin等于minLeftMargin时，Menu完全显示。\n本来有种想法（参考[郭霖大神的博客](http://blog.csdn.net/guolin_blog/article/details/8714621)）是采用线程Sleep的方式来达到滑动效果的。代码如下：\n```\nprivate class ScrollTask extends AsyncTask<Integer, Integer, Integer> {\n\n        @Override\n        protected Integer doInBackground(Integer... speed) {\n            int leftMargin = contentLayout.leftMargin;\n            while (true) {\n                leftMargin = leftMargin - speed[0];\n                if (leftMargin > maxLeftMargin) {\n                    leftMargin = maxLeftMargin;\n                    break;\n                }\n                if (leftMargin < minLeftMargin) {\n                    leftMargin = minLeftMargin;\n                    break;\n                }\n                publishProgress(leftMargin);\n                try {\n                    Thread.sleep(20);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n            }\n            isMenuOpen = speed[0] > 0;\n            return leftMargin;\n        }\n\n        @Override\n        protected void onProgressUpdate(Integer... leftMargin) {\n            contentLayout.leftMargin = leftMargin[0];\n            contentView.setLayoutParams(contentLayout);\n        }\n\n        @Override\n        protected void onPostExecute(Integer leftMargin) {\n            contentLayout.leftMargin = leftMargin;\n            contentView.setLayoutParams(contentLayout);\n        }\n    }\n\npublic void toOpenMenu() {\n        new ScrollTask().execute(30);\n    }\n\n    public void toCloseMenu() {\n        new ScrollTask().execute(-30);\n    }\n```\n但是后面产生的实际效果不太好，滑动的时候总是有点卡顿的感觉，于是便弃用了，后面还是采用的Scroller类。\n\n下面贴上每个Item的布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<com.lastwarmth.mylistview.MyItemLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:orientation=\"horizontal\">\n\n    <LinearLayout\n        android:id=\"@+id/content\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:orientation=\"horizontal\"\n        android:paddingBottom=\"4dp\"\n        android:paddingLeft=\"8dp\"\n        android:paddingTop=\"4dp\">\n\n        <de.hdodenhof.circleimageview.CircleImageView\n            android:id=\"@+id/profile_image\"\n            android:layout_width=\"56dp\"\n            android:layout_height=\"56dp\"\n            app:civ_border_color=\"#FF000000\"\n            app:civ_border_width=\"1dp\" />\n\n        <LinearLayout\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"match_parent\"\n            android:layout_marginLeft=\"16dp\"\n            android:layout_marginTop=\"4dp\"\n            android:orientation=\"vertical\">\n\n            <TextView\n                android:id=\"@+id/group_name\"\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:text=\"群名称\" />\n\n            <TextView\n                android:id=\"@+id/qq_content\"\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:layout_marginTop=\"8dp\"\n                android:singleLine=\"true\"\n                android:text=\"聊天内容\" />\n\n        </LinearLayout>\n    </LinearLayout>\n\n\n    <LinearLayout\n        android:id=\"@+id/menu\"\n        android:layout_width=\"240dp\"\n        android:layout_height=\"match_parent\"\n        android:orientation=\"horizontal\">\n\n        <TextView\n            android:id=\"@+id/to_top\"\n            style=\"@style/menu_text_style\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"match_parent\"\n            android:background=\"@android:color/darker_gray\"\n            android:gravity=\"center\"\n            android:text=\"置顶\" />\n\n        <TextView\n            android:id=\"@+id/had_read\"\n            style=\"@style/menu_text_style\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"match_parent\"\n            android:background=\"@android:color/holo_orange_light\"\n            android:gravity=\"center\"\n            android:text=\"标为已读\" />\n\n        <TextView\n            android:id=\"@+id/delete\"\n            style=\"@style/menu_text_style\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"match_parent\"\n            android:background=\"@android:color/holo_red_light\"\n            android:gravity=\"center\"\n            android:text=\"删除\" />\n    </LinearLayout>\n\n</com.lastwarmth.mylistview.MyItemLayout>\n```\ncontent id即是第一个子节点，menu id为第二个子节点。\n\n## Adapter\n```\npublic class MyAdapter extends BaseAdapter {\n    private List<MyModel> data;\n    private Context mContext;\n\n    public MyAdapter(List<MyModel> data, Context mContext) {\n        this.data = data;\n        this.mContext = mContext;\n    }\n\n    @Override\n    public int getCount() {\n        if (data != null) {\n            return data.size();\n        }\n        return 0;\n    }\n\n    @Override\n    public Object getItem(int position) {\n        if (data != null) {\n            return data.get(position);\n        }\n        return null;\n    }\n\n    @Override\n    public long getItemId(int position) {\n        return 0;\n    }\n\n    @Override\n    public View getView(final int position, View contentView, ViewGroup parent) {\n        ViewHolder holder;\n        if (contentView == null) {\n            holder = new ViewHolder();\n            contentView = LayoutInflater.from(mContext).inflate(R.layout.list_item, parent, false);\n            holder.imageView = (CircleImageView) contentView.findViewById(R.id.profile_image);\n            holder.groupName = (TextView) contentView.findViewById(R.id.group_name);\n            holder.content = (TextView) contentView.findViewById(R.id.qq_content);\n            holder.toTop = (TextView) contentView.findViewById(R.id.to_top);\n            holder.hadRead = (TextView) contentView.findViewById(R.id.had_read);\n            holder.delete = (TextView) contentView.findViewById(R.id.delete);\n            contentView.setTag(holder);\n        } else {\n            holder = (ViewHolder) contentView.getTag();\n        }\n        MyModel myModel = (MyModel) getItem(position);\n        holder.groupName.setText(myModel.getGroupName());\n        holder.content.setText(myModel.getContent());\n        Picasso.with(mContext)\n                .load(myModel.getImageUrl())\n                .placeholder(R.mipmap.lb_zjtx)\n                .into(holder.imageView);\n        final MyItemLayout finalContentView = (MyItemLayout) contentView;\n        holder.toTop.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                Toast.makeText(mContext, \"已置顶\", Toast.LENGTH_SHORT).show();\n                finalContentView.smoothCloseMenu();\n            }\n        });\n        holder.hadRead.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                Toast.makeText(mContext, \"已阅读\", Toast.LENGTH_SHORT).show();\n                finalContentView.smoothCloseMenu();\n            }\n        });\n        holder.delete.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                data.remove(position);\n                finalContentView.smoothCloseMenu();\n                notifyDataSetChanged();\n                Toast.makeText(mContext, \"已删除\", Toast.LENGTH_SHORT).show();\n            }\n        });\n        return contentView;\n    }\n\n    private static class ViewHolder {\n        CircleImageView imageView;\n        TextView groupName;\n        TextView content;\n        TextView toTop;\n        TextView hadRead;\n        TextView delete;\n    }\n}\n```\nAdapter类比较简单，这里不做过多的赘述。\n\n## Model类\nMyModel类主要是为了模仿QQ会话写的一个类。\n```\npublic class MyModel {\n\n    String imageUrl; // 头像Url\n    String groupName; // 群名称\n    String content; // 聊天内容\n\n    public MyModel(String imageUrl, String groupName, String content) {\n        this.imageUrl = imageUrl;\n        this.groupName = groupName;\n        this.content = content;\n    }\n\n    public String getImageUrl() {\n        return imageUrl;\n    }\n\n    public String getGroupName() {\n        return groupName;\n    }\n\n    public String getContent() {\n        return content;\n    }\n\n}\n```\n## 自定义ListView\n下面便是最关键的一个：自定义ListView，覆写onTouchEvent方法，实现滑动删除。\n```\npublic class MyListView extends ListView {\n\n    // 滑动速度追踪类\n    private VelocityTracker mVelocityTracker;\n    // ACTION_DOWN的坐标\n    private float xDown;\n    private float yDown;\n    // 判断横滑、竖滑的最小值\n    private int MAX_Y = 5;\n    private int MAX_X = 3;\n    // 当前点击的position\n    private int mTouchPosition;\n    // 当前点击的item View\n    private MyItemLayout mTouchView;\n    // 当前触摸状态\n    private int mTouchState = TOUCH_STATE_NONE;\n    private static final int TOUCH_STATE_NONE = 0; //ACTION_DOWN时设置的状态\n    private static final int TOUCH_STATE_X = 1; //横滑\n    private static final int TOUCH_STATE_Y = 2; //竖滑\n\n\n    public MyListView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        MAX_X = dp2px(MAX_X);\n        MAX_Y = dp2px(MAX_Y);\n    }\n\n    /**\n     * 创建VelocityTracker对象，并将触摸事件加入到VelocityTracker当中\n     *\n     * @param event\n     */\n    private void createVelocityTracker(MotionEvent event) {\n        if (mVelocityTracker == null) {\n            mVelocityTracker = VelocityTracker.obtain();\n        }\n        mVelocityTracker.addMovement(event);\n    }\n\n    /**\n     * 获取手指在滑动的速度\n     *\n     * @return 滑动速度，以每秒钟移动了多少像素值为单位\n     */\n    private int getScrollVelocity() {\n        mVelocityTracker.computeCurrentVelocity(1000);\n        int velocity = (int) mVelocityTracker.getXVelocity();\n        return Math.abs(velocity);\n    }\n\n    /**\n     * 回收VelocityTracker对象\n     */\n    private void recycleVelocityTracker() {\n        mVelocityTracker.recycle();\n        mVelocityTracker = null;\n    }\n\n    @Override\n    public boolean onInterceptTouchEvent(MotionEvent ev) {\n        return super.onInterceptTouchEvent(ev);\n    }\n\n    /**\n     * 触摸事件的控制\n     *\n     * @param ev\n     * @return\n     */\n    @Override\n    public boolean onTouchEvent(MotionEvent ev) {\n        if (ev.getAction() != MotionEvent.ACTION_DOWN && mTouchView == null) {\n            return super.onTouchEvent(ev);\n        }\n        // 加入触摸跟踪类\n        createVelocityTracker(ev);\n        float moveX;\n        float moveY;\n        int action = ev.getAction();\n        switch (action) {\n            case MotionEvent.ACTION_DOWN:\n                int prevPosition = mTouchPosition;\n                xDown = ev.getX();\n                yDown = ev.getY();\n                mTouchState = TOUCH_STATE_NONE;\n                mTouchPosition = pointToPosition((int) xDown, (int) yDown);\n                // 当前点击的Item正好是已经显示Menu的Item\n                if (prevPosition == mTouchPosition && mTouchView != null && mTouchView.isMenuOpen()) {\n                    mTouchState = TOUCH_STATE_X;\n                    return true; // 返回true表示接受了ACTION_DOWN，那么后面的事件依然会分发给MyListView\n                }\n                View view = getChildAt(mTouchPosition - getFirstVisiblePosition());\n                // 点击的Item不是正在显示Menu的Item，则直接关闭Menu\n                if (mTouchView != null && mTouchView.isMenuOpen()) {\n                    mTouchView.smoothCloseMenu();\n                    mTouchView = null;\n                    return false; // 返回false，那么后面的事件全部会接收不到\n                }\n                if (view instanceof MyItemLayout) {\n                    mTouchView = (MyItemLayout) view;\n                }\n                break;\n            case MotionEvent.ACTION_MOVE:\n                moveX = ev.getX() - xDown;\n                moveY = ev.getY() - yDown;\n                if (mTouchState == TOUCH_STATE_X) {\n                    // 如果是横滑，则设置leftMargin\n                    if (!mTouchView.isMenuOpen()) {\n                        mTouchView.setLeftMargin((int) moveX);\n                    } else {\n                        mTouchView.setLeftMargin((int) (moveX - mTouchView.getMenuWidth()));\n                    }\n                    return true;\n                } else if (mTouchState == TOUCH_STATE_NONE) {\n                    // 设置横滑还是竖滑\n                    if (Math.abs(moveY) > MAX_Y) {\n                        mTouchState = TOUCH_STATE_Y;\n                    } else if (Math.abs(moveX) > MAX_X) {\n                        mTouchState = TOUCH_STATE_X;\n                    }\n                }\n                break;\n            case MotionEvent.ACTION_UP:\n                moveX = ev.getX() - xDown;\n                if (mTouchState == TOUCH_STATE_X) {\n                    // 若滑动的距离是Menu宽度的一半，或者左滑速度大于200,\n                    if (-moveX > mTouchView.getMenuWidth() / 2 || (moveX < 0 && getScrollVelocity() > 200)) {\n                        // 若Menu是关闭的\n                        if (!mTouchView.isMenuOpen()) {\n                            // 滑动打开Menu\n                            mTouchView.smoothOpenMenu();\n                        }\n                    } else {\n                        // 滑动关闭Menu\n                        mTouchView.smoothCloseMenu();\n                        mTouchView = null;\n                        mTouchPosition = -1;\n                    }\n                    recycleVelocityTracker();\n                    return true;\n                }\n                break;\n        }\n        return super.onTouchEvent(ev);\n    }\n\n    private int dp2px(int dp) {\n        return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,\n                getContext().getResources().getDisplayMetrics());\n    }\n}\n```\n在这个项目中，触摸事件分以下几种情况：\n1. 当前没有Menu正在显示\n\n - ACTION_DOWN记录相关信息，准备接收ACTION_MOVE、ACTION_UP事件。\n - ACTION_MOVE中，判断是横滑还是竖滑。若是横滑，则调用setLeftMargin()，这个时候若一直滑动，Menu会慢慢地显示出来。后面会返回true，主要是为了拦截最后的super.onTouchEvent(ev)不执行。若是竖滑，则直接调用super.onTouchEvent(ev)，这个时候若一直滑动，则是ListView的上下滑动了。\n - ACTION_UP中，我们只需要判断是否要显示，若显示则调用smoothOpenMenu()，并返回true（这里返回true或者false都没有实际的意义）。若是不需要，则直接super.onTouchEvent(ev)。\n\n2. 当前有Menu正在显示\n\n - ACTION_DOWN，若当前点击的Item不是Menu正在显示的Item，那么直接smoothCloseMenu()，并且返回false。返回false后MOVE、UP等事件会统统不接收。\n - 若是正在点击的Item，那么首先设置为横滑，并且返回true，等待后续的触摸事件。\n - ACTION_MOVE因为在DOWN的时候设置了mTouchState = TOUCH_STATE_X;那么会执行到if内部，因为Menu正在显示，所以不会调用setLeftMargin()，并且直接返回true，即后面的super.onTouchEvent(ev)也不会调用。\n - ACTION_UP中判断Menu是否要关闭，若关闭则调用smoothCloseMenu()，并且返回true。若是不需要，则直接返回super.onTouchEvent(ev)。\n\n这里是复杂的地方，需要对各种情况进行判断，然后执行相应的逻辑。我写了好多次，改过好多次QAQ...\n\n## Tips\n - 在ACTION_DOWN的分支中，返回false会直接截断后面MOVE、UP等事件的接收。\n - 在ACTION_MOVE与ACTION_UP的返回值，为true为false，并没有特别实际的效果，仅仅是为了返回，以此来截断super.onTouchEvent(ev)的执行。\n\n## 最后\n下面上效果图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/swipe-listview2.png)\n看起来效果也还不错，是吧？\n\n<font size=5>[源码下载](https://github.com/LiJia92/MyListView)</font>\n","source":"_posts/swipe-listview.md","raw":"---\ntitle: Android仿QQ实现ListView滑动删除\ndate: 2015-11-14 02:09:38\ntags:\n - 自定义View\n---\n\n## 前言\n手机QQ应该是很普及的App了，看到QQ消息栏对话框列表的每个子项左滑的时候会弹出删除、置顶图标。like this：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/swipe-listview1.png)\n于是突发奇想：想要自己实现一个这样的效果。\n很显然的，这样的效果实现要依赖Android的事件分发机制，于是我先从Android事件分发入手。对于事件分发还不太熟悉的朋友可以参考[Android事件分发机制学习](http://lijia92.github.io/2015/11/14/touch-event/)。\n下面开工！\n\n<!--more-->\n\n## List Item\n首先，针对ListView的每个Item自定义一个MyItemLayout。代码如下：\n```\npublic class MyItemLayout extends LinearLayout {\n\n    // content View\n    private LinearLayout contentView;\n    // menu View\n    private LinearLayout menuView;\n    // content View的布局参数对象\n    private LayoutParams contentLayout;\n    // 菜单是否打开\n    private boolean isMenuOpen;\n    // contentView最小的leftMargin\n    private int minLeftMargin;\n    // contentView最大的leftMargin\n    private int maxLeftMargin = 0;\n    // 滑动类\n    private Scroller mScroller = null;\n\n    public MyItemLayout(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        contentLayout = new LayoutParams(getScreenWidth(), LayoutParams.WRAP_CONTENT);\n        mScroller = new Scroller(context);\n    }\n\n    @Override\n    public void computeScroll() {\n        if (mScroller.computeScrollOffset()) {\n            setLeftMargin(mScroller.getCurrX());\n            postInvalidate();\n        }\n    }\n\n    /**\n     * Scroller平滑打开Menu\n     */\n    public void smoothOpenMenu() {\n        isMenuOpen = true;\n        mScroller.startScroll(contentLayout.leftMargin, 0, minLeftMargin - contentLayout.leftMargin, 0, 350);\n        postInvalidate();\n    }\n\n    /**\n     * Scroller平滑关闭Menu\n     */\n    public void smoothCloseMenu() {\n        isMenuOpen = false;\n        mScroller.startScroll(contentLayout.leftMargin, 0, maxLeftMargin - contentLayout.leftMargin, 0, 350);\n        postInvalidate();\n    }\n\n    /**\n     * 在布局inflate完成后调用\n     */\n    @Override\n    protected void onFinishInflate() {\n        super.onFinishInflate();\n        // 第一个孩子是contentView\n        contentView = (LinearLayout) getChildAt(0);\n        // 第二个孩子是MenuView\n        menuView = (LinearLayout) getChildAt(1);\n        // 最小的leftMargin为负的menuView宽度\n        ViewGroup.LayoutParams lp = menuView.getLayoutParams();\n        minLeftMargin = -lp.width;\n    }\n\n    /**\n     * 获取屏幕宽度\n     * @return\n     */\n    private int getScreenWidth() {\n        DisplayMetrics dm = getResources().getDisplayMetrics();\n        return dm.widthPixels;\n    }\n\n    /**\n     * 给contentView设置leftMargin\n     * @param leftMargin\n     */\n    public void setLeftMargin(int leftMargin) {\n        // 控制leftMargin不越界\n        if (leftMargin > maxLeftMargin) {\n            leftMargin = maxLeftMargin;\n        }\n        if (leftMargin < minLeftMargin) {\n            leftMargin = minLeftMargin;\n        }\n        contentLayout.leftMargin = leftMargin;\n        // 通过设置leftMargin，达到menu显示的效果\n        contentView.setLayoutParams(contentLayout);\n    }\n\n    /**\n     * 获取menuView宽度\n     * @return\n     */\n    public int getMenuWidth() {\n        return -minLeftMargin;\n    }\n\n    /**\n     * Menu是否打开\n     * @return\n     */\n    public boolean isMenuOpen() {\n        return isMenuOpen;\n    }\n\n}\n```\n每个Item有2个直接子节点，第一个是contentView，第二个是menuView。通过设置contentView的leftMargin，达到显示Menu的效果。初始时，leftMargin为0，Menu完全隐藏。当滑动时，leftMargin逐渐缩小（因为是负数），当leftMargin等于minLeftMargin时，Menu完全显示。\n本来有种想法（参考[郭霖大神的博客](http://blog.csdn.net/guolin_blog/article/details/8714621)）是采用线程Sleep的方式来达到滑动效果的。代码如下：\n```\nprivate class ScrollTask extends AsyncTask<Integer, Integer, Integer> {\n\n        @Override\n        protected Integer doInBackground(Integer... speed) {\n            int leftMargin = contentLayout.leftMargin;\n            while (true) {\n                leftMargin = leftMargin - speed[0];\n                if (leftMargin > maxLeftMargin) {\n                    leftMargin = maxLeftMargin;\n                    break;\n                }\n                if (leftMargin < minLeftMargin) {\n                    leftMargin = minLeftMargin;\n                    break;\n                }\n                publishProgress(leftMargin);\n                try {\n                    Thread.sleep(20);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n            }\n            isMenuOpen = speed[0] > 0;\n            return leftMargin;\n        }\n\n        @Override\n        protected void onProgressUpdate(Integer... leftMargin) {\n            contentLayout.leftMargin = leftMargin[0];\n            contentView.setLayoutParams(contentLayout);\n        }\n\n        @Override\n        protected void onPostExecute(Integer leftMargin) {\n            contentLayout.leftMargin = leftMargin;\n            contentView.setLayoutParams(contentLayout);\n        }\n    }\n\npublic void toOpenMenu() {\n        new ScrollTask().execute(30);\n    }\n\n    public void toCloseMenu() {\n        new ScrollTask().execute(-30);\n    }\n```\n但是后面产生的实际效果不太好，滑动的时候总是有点卡顿的感觉，于是便弃用了，后面还是采用的Scroller类。\n\n下面贴上每个Item的布局：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<com.lastwarmth.mylistview.MyItemLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    android:orientation=\"horizontal\">\n\n    <LinearLayout\n        android:id=\"@+id/content\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"wrap_content\"\n        android:orientation=\"horizontal\"\n        android:paddingBottom=\"4dp\"\n        android:paddingLeft=\"8dp\"\n        android:paddingTop=\"4dp\">\n\n        <de.hdodenhof.circleimageview.CircleImageView\n            android:id=\"@+id/profile_image\"\n            android:layout_width=\"56dp\"\n            android:layout_height=\"56dp\"\n            app:civ_border_color=\"#FF000000\"\n            app:civ_border_width=\"1dp\" />\n\n        <LinearLayout\n            android:layout_width=\"match_parent\"\n            android:layout_height=\"match_parent\"\n            android:layout_marginLeft=\"16dp\"\n            android:layout_marginTop=\"4dp\"\n            android:orientation=\"vertical\">\n\n            <TextView\n                android:id=\"@+id/group_name\"\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:text=\"群名称\" />\n\n            <TextView\n                android:id=\"@+id/qq_content\"\n                android:layout_width=\"wrap_content\"\n                android:layout_height=\"wrap_content\"\n                android:layout_marginTop=\"8dp\"\n                android:singleLine=\"true\"\n                android:text=\"聊天内容\" />\n\n        </LinearLayout>\n    </LinearLayout>\n\n\n    <LinearLayout\n        android:id=\"@+id/menu\"\n        android:layout_width=\"240dp\"\n        android:layout_height=\"match_parent\"\n        android:orientation=\"horizontal\">\n\n        <TextView\n            android:id=\"@+id/to_top\"\n            style=\"@style/menu_text_style\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"match_parent\"\n            android:background=\"@android:color/darker_gray\"\n            android:gravity=\"center\"\n            android:text=\"置顶\" />\n\n        <TextView\n            android:id=\"@+id/had_read\"\n            style=\"@style/menu_text_style\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"match_parent\"\n            android:background=\"@android:color/holo_orange_light\"\n            android:gravity=\"center\"\n            android:text=\"标为已读\" />\n\n        <TextView\n            android:id=\"@+id/delete\"\n            style=\"@style/menu_text_style\"\n            android:layout_width=\"80dp\"\n            android:layout_height=\"match_parent\"\n            android:background=\"@android:color/holo_red_light\"\n            android:gravity=\"center\"\n            android:text=\"删除\" />\n    </LinearLayout>\n\n</com.lastwarmth.mylistview.MyItemLayout>\n```\ncontent id即是第一个子节点，menu id为第二个子节点。\n\n## Adapter\n```\npublic class MyAdapter extends BaseAdapter {\n    private List<MyModel> data;\n    private Context mContext;\n\n    public MyAdapter(List<MyModel> data, Context mContext) {\n        this.data = data;\n        this.mContext = mContext;\n    }\n\n    @Override\n    public int getCount() {\n        if (data != null) {\n            return data.size();\n        }\n        return 0;\n    }\n\n    @Override\n    public Object getItem(int position) {\n        if (data != null) {\n            return data.get(position);\n        }\n        return null;\n    }\n\n    @Override\n    public long getItemId(int position) {\n        return 0;\n    }\n\n    @Override\n    public View getView(final int position, View contentView, ViewGroup parent) {\n        ViewHolder holder;\n        if (contentView == null) {\n            holder = new ViewHolder();\n            contentView = LayoutInflater.from(mContext).inflate(R.layout.list_item, parent, false);\n            holder.imageView = (CircleImageView) contentView.findViewById(R.id.profile_image);\n            holder.groupName = (TextView) contentView.findViewById(R.id.group_name);\n            holder.content = (TextView) contentView.findViewById(R.id.qq_content);\n            holder.toTop = (TextView) contentView.findViewById(R.id.to_top);\n            holder.hadRead = (TextView) contentView.findViewById(R.id.had_read);\n            holder.delete = (TextView) contentView.findViewById(R.id.delete);\n            contentView.setTag(holder);\n        } else {\n            holder = (ViewHolder) contentView.getTag();\n        }\n        MyModel myModel = (MyModel) getItem(position);\n        holder.groupName.setText(myModel.getGroupName());\n        holder.content.setText(myModel.getContent());\n        Picasso.with(mContext)\n                .load(myModel.getImageUrl())\n                .placeholder(R.mipmap.lb_zjtx)\n                .into(holder.imageView);\n        final MyItemLayout finalContentView = (MyItemLayout) contentView;\n        holder.toTop.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                Toast.makeText(mContext, \"已置顶\", Toast.LENGTH_SHORT).show();\n                finalContentView.smoothCloseMenu();\n            }\n        });\n        holder.hadRead.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                Toast.makeText(mContext, \"已阅读\", Toast.LENGTH_SHORT).show();\n                finalContentView.smoothCloseMenu();\n            }\n        });\n        holder.delete.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                data.remove(position);\n                finalContentView.smoothCloseMenu();\n                notifyDataSetChanged();\n                Toast.makeText(mContext, \"已删除\", Toast.LENGTH_SHORT).show();\n            }\n        });\n        return contentView;\n    }\n\n    private static class ViewHolder {\n        CircleImageView imageView;\n        TextView groupName;\n        TextView content;\n        TextView toTop;\n        TextView hadRead;\n        TextView delete;\n    }\n}\n```\nAdapter类比较简单，这里不做过多的赘述。\n\n## Model类\nMyModel类主要是为了模仿QQ会话写的一个类。\n```\npublic class MyModel {\n\n    String imageUrl; // 头像Url\n    String groupName; // 群名称\n    String content; // 聊天内容\n\n    public MyModel(String imageUrl, String groupName, String content) {\n        this.imageUrl = imageUrl;\n        this.groupName = groupName;\n        this.content = content;\n    }\n\n    public String getImageUrl() {\n        return imageUrl;\n    }\n\n    public String getGroupName() {\n        return groupName;\n    }\n\n    public String getContent() {\n        return content;\n    }\n\n}\n```\n## 自定义ListView\n下面便是最关键的一个：自定义ListView，覆写onTouchEvent方法，实现滑动删除。\n```\npublic class MyListView extends ListView {\n\n    // 滑动速度追踪类\n    private VelocityTracker mVelocityTracker;\n    // ACTION_DOWN的坐标\n    private float xDown;\n    private float yDown;\n    // 判断横滑、竖滑的最小值\n    private int MAX_Y = 5;\n    private int MAX_X = 3;\n    // 当前点击的position\n    private int mTouchPosition;\n    // 当前点击的item View\n    private MyItemLayout mTouchView;\n    // 当前触摸状态\n    private int mTouchState = TOUCH_STATE_NONE;\n    private static final int TOUCH_STATE_NONE = 0; //ACTION_DOWN时设置的状态\n    private static final int TOUCH_STATE_X = 1; //横滑\n    private static final int TOUCH_STATE_Y = 2; //竖滑\n\n\n    public MyListView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n        MAX_X = dp2px(MAX_X);\n        MAX_Y = dp2px(MAX_Y);\n    }\n\n    /**\n     * 创建VelocityTracker对象，并将触摸事件加入到VelocityTracker当中\n     *\n     * @param event\n     */\n    private void createVelocityTracker(MotionEvent event) {\n        if (mVelocityTracker == null) {\n            mVelocityTracker = VelocityTracker.obtain();\n        }\n        mVelocityTracker.addMovement(event);\n    }\n\n    /**\n     * 获取手指在滑动的速度\n     *\n     * @return 滑动速度，以每秒钟移动了多少像素值为单位\n     */\n    private int getScrollVelocity() {\n        mVelocityTracker.computeCurrentVelocity(1000);\n        int velocity = (int) mVelocityTracker.getXVelocity();\n        return Math.abs(velocity);\n    }\n\n    /**\n     * 回收VelocityTracker对象\n     */\n    private void recycleVelocityTracker() {\n        mVelocityTracker.recycle();\n        mVelocityTracker = null;\n    }\n\n    @Override\n    public boolean onInterceptTouchEvent(MotionEvent ev) {\n        return super.onInterceptTouchEvent(ev);\n    }\n\n    /**\n     * 触摸事件的控制\n     *\n     * @param ev\n     * @return\n     */\n    @Override\n    public boolean onTouchEvent(MotionEvent ev) {\n        if (ev.getAction() != MotionEvent.ACTION_DOWN && mTouchView == null) {\n            return super.onTouchEvent(ev);\n        }\n        // 加入触摸跟踪类\n        createVelocityTracker(ev);\n        float moveX;\n        float moveY;\n        int action = ev.getAction();\n        switch (action) {\n            case MotionEvent.ACTION_DOWN:\n                int prevPosition = mTouchPosition;\n                xDown = ev.getX();\n                yDown = ev.getY();\n                mTouchState = TOUCH_STATE_NONE;\n                mTouchPosition = pointToPosition((int) xDown, (int) yDown);\n                // 当前点击的Item正好是已经显示Menu的Item\n                if (prevPosition == mTouchPosition && mTouchView != null && mTouchView.isMenuOpen()) {\n                    mTouchState = TOUCH_STATE_X;\n                    return true; // 返回true表示接受了ACTION_DOWN，那么后面的事件依然会分发给MyListView\n                }\n                View view = getChildAt(mTouchPosition - getFirstVisiblePosition());\n                // 点击的Item不是正在显示Menu的Item，则直接关闭Menu\n                if (mTouchView != null && mTouchView.isMenuOpen()) {\n                    mTouchView.smoothCloseMenu();\n                    mTouchView = null;\n                    return false; // 返回false，那么后面的事件全部会接收不到\n                }\n                if (view instanceof MyItemLayout) {\n                    mTouchView = (MyItemLayout) view;\n                }\n                break;\n            case MotionEvent.ACTION_MOVE:\n                moveX = ev.getX() - xDown;\n                moveY = ev.getY() - yDown;\n                if (mTouchState == TOUCH_STATE_X) {\n                    // 如果是横滑，则设置leftMargin\n                    if (!mTouchView.isMenuOpen()) {\n                        mTouchView.setLeftMargin((int) moveX);\n                    } else {\n                        mTouchView.setLeftMargin((int) (moveX - mTouchView.getMenuWidth()));\n                    }\n                    return true;\n                } else if (mTouchState == TOUCH_STATE_NONE) {\n                    // 设置横滑还是竖滑\n                    if (Math.abs(moveY) > MAX_Y) {\n                        mTouchState = TOUCH_STATE_Y;\n                    } else if (Math.abs(moveX) > MAX_X) {\n                        mTouchState = TOUCH_STATE_X;\n                    }\n                }\n                break;\n            case MotionEvent.ACTION_UP:\n                moveX = ev.getX() - xDown;\n                if (mTouchState == TOUCH_STATE_X) {\n                    // 若滑动的距离是Menu宽度的一半，或者左滑速度大于200,\n                    if (-moveX > mTouchView.getMenuWidth() / 2 || (moveX < 0 && getScrollVelocity() > 200)) {\n                        // 若Menu是关闭的\n                        if (!mTouchView.isMenuOpen()) {\n                            // 滑动打开Menu\n                            mTouchView.smoothOpenMenu();\n                        }\n                    } else {\n                        // 滑动关闭Menu\n                        mTouchView.smoothCloseMenu();\n                        mTouchView = null;\n                        mTouchPosition = -1;\n                    }\n                    recycleVelocityTracker();\n                    return true;\n                }\n                break;\n        }\n        return super.onTouchEvent(ev);\n    }\n\n    private int dp2px(int dp) {\n        return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,\n                getContext().getResources().getDisplayMetrics());\n    }\n}\n```\n在这个项目中，触摸事件分以下几种情况：\n1. 当前没有Menu正在显示\n\n - ACTION_DOWN记录相关信息，准备接收ACTION_MOVE、ACTION_UP事件。\n - ACTION_MOVE中，判断是横滑还是竖滑。若是横滑，则调用setLeftMargin()，这个时候若一直滑动，Menu会慢慢地显示出来。后面会返回true，主要是为了拦截最后的super.onTouchEvent(ev)不执行。若是竖滑，则直接调用super.onTouchEvent(ev)，这个时候若一直滑动，则是ListView的上下滑动了。\n - ACTION_UP中，我们只需要判断是否要显示，若显示则调用smoothOpenMenu()，并返回true（这里返回true或者false都没有实际的意义）。若是不需要，则直接super.onTouchEvent(ev)。\n\n2. 当前有Menu正在显示\n\n - ACTION_DOWN，若当前点击的Item不是Menu正在显示的Item，那么直接smoothCloseMenu()，并且返回false。返回false后MOVE、UP等事件会统统不接收。\n - 若是正在点击的Item，那么首先设置为横滑，并且返回true，等待后续的触摸事件。\n - ACTION_MOVE因为在DOWN的时候设置了mTouchState = TOUCH_STATE_X;那么会执行到if内部，因为Menu正在显示，所以不会调用setLeftMargin()，并且直接返回true，即后面的super.onTouchEvent(ev)也不会调用。\n - ACTION_UP中判断Menu是否要关闭，若关闭则调用smoothCloseMenu()，并且返回true。若是不需要，则直接返回super.onTouchEvent(ev)。\n\n这里是复杂的地方，需要对各种情况进行判断，然后执行相应的逻辑。我写了好多次，改过好多次QAQ...\n\n## Tips\n - 在ACTION_DOWN的分支中，返回false会直接截断后面MOVE、UP等事件的接收。\n - 在ACTION_MOVE与ACTION_UP的返回值，为true为false，并没有特别实际的效果，仅仅是为了返回，以此来截断super.onTouchEvent(ev)的执行。\n\n## 最后\n下面上效果图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/swipe-listview2.png)\n看起来效果也还不错，是吧？\n\n<font size=5>[源码下载](https://github.com/LiJia92/MyListView)</font>\n","slug":"swipe-listview","published":1,"updated":"2016-11-21T10:03:30.785Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75ac002z1cb88qpsait2","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>手机QQ应该是很普及的App了，看到QQ消息栏对话框列表的每个子项左滑的时候会弹出删除、置顶图标。like this：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/swipe-listview1.png\" alt=\"这里写图片描述\"><br>于是突发奇想：想要自己实现一个这样的效果。<br>很显然的，这样的效果实现要依赖Android的事件分发机制，于是我先从Android事件分发入手。对于事件分发还不太熟悉的朋友可以参考<a href=\"http://lijia92.github.io/2015/11/14/touch-event/\">Android事件分发机制学习</a>。<br>下面开工！</p>\n<a id=\"more\"></a>\n<h2 id=\"List-Item\"><a href=\"#List-Item\" class=\"headerlink\" title=\"List Item\"></a>List Item</h2><p>首先，针对ListView的每个Item自定义一个MyItemLayout。代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyItemLayout</span> <span class=\"keyword\">extends</span> <span class=\"title\">LinearLayout</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// content View</span></div><div class=\"line\">    <span class=\"keyword\">private</span> LinearLayout contentView;</div><div class=\"line\">    <span class=\"comment\">// menu View</span></div><div class=\"line\">    <span class=\"keyword\">private</span> LinearLayout menuView;</div><div class=\"line\">    <span class=\"comment\">// content View的布局参数对象</span></div><div class=\"line\">    <span class=\"keyword\">private</span> LayoutParams contentLayout;</div><div class=\"line\">    <span class=\"comment\">// 菜单是否打开</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isMenuOpen;</div><div class=\"line\">    <span class=\"comment\">// contentView最小的leftMargin</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> minLeftMargin;</div><div class=\"line\">    <span class=\"comment\">// contentView最大的leftMargin</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> maxLeftMargin = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"comment\">// 滑动类</span></div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller mScroller = <span class=\"keyword\">null</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MyItemLayout</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        contentLayout = <span class=\"keyword\">new</span> LayoutParams(getScreenWidth(), LayoutParams.WRAP_CONTENT);</div><div class=\"line\">        mScroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (mScroller.computeScrollOffset()) &#123;</div><div class=\"line\">            setLeftMargin(mScroller.getCurrX());</div><div class=\"line\">            postInvalidate();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * Scroller平滑打开Menu</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">smoothOpenMenu</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        isMenuOpen = <span class=\"keyword\">true</span>;</div><div class=\"line\">        mScroller.startScroll(contentLayout.leftMargin, <span class=\"number\">0</span>, minLeftMargin - contentLayout.leftMargin, <span class=\"number\">0</span>, <span class=\"number\">350</span>);</div><div class=\"line\">        postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * Scroller平滑关闭Menu</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">smoothCloseMenu</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        isMenuOpen = <span class=\"keyword\">false</span>;</div><div class=\"line\">        mScroller.startScroll(contentLayout.leftMargin, <span class=\"number\">0</span>, maxLeftMargin - contentLayout.leftMargin, <span class=\"number\">0</span>, <span class=\"number\">350</span>);</div><div class=\"line\">        postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 在布局inflate完成后调用</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onFinishInflate</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onFinishInflate();</div><div class=\"line\">        <span class=\"comment\">// 第一个孩子是contentView</span></div><div class=\"line\">        contentView = (LinearLayout) getChildAt(<span class=\"number\">0</span>);</div><div class=\"line\">        <span class=\"comment\">// 第二个孩子是MenuView</span></div><div class=\"line\">        menuView = (LinearLayout) getChildAt(<span class=\"number\">1</span>);</div><div class=\"line\">        <span class=\"comment\">// 最小的leftMargin为负的menuView宽度</span></div><div class=\"line\">        ViewGroup.LayoutParams lp = menuView.getLayoutParams();</div><div class=\"line\">        minLeftMargin = -lp.width;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 获取屏幕宽度</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">getScreenWidth</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        DisplayMetrics dm = getResources().getDisplayMetrics();</div><div class=\"line\">        <span class=\"keyword\">return</span> dm.widthPixels;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 给contentView设置leftMargin</div><div class=\"line\">     * <span class=\"doctag\">@param</span> leftMargin</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setLeftMargin</span><span class=\"params\">(<span class=\"keyword\">int</span> leftMargin)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// 控制leftMargin不越界</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (leftMargin &gt; maxLeftMargin) &#123;</div><div class=\"line\">            leftMargin = maxLeftMargin;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span> (leftMargin &lt; minLeftMargin) &#123;</div><div class=\"line\">            leftMargin = minLeftMargin;</div><div class=\"line\">        &#125;</div><div class=\"line\">        contentLayout.leftMargin = leftMargin;</div><div class=\"line\">        <span class=\"comment\">// 通过设置leftMargin，达到menu显示的效果</span></div><div class=\"line\">        contentView.setLayoutParams(contentLayout);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 获取menuView宽度</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getMenuWidth</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> -minLeftMargin;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * Menu是否打开</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isMenuOpen</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> isMenuOpen;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>每个Item有2个直接子节点，第一个是contentView，第二个是menuView。通过设置contentView的leftMargin，达到显示Menu的效果。初始时，leftMargin为0，Menu完全隐藏。当滑动时，leftMargin逐渐缩小（因为是负数），当leftMargin等于minLeftMargin时，Menu完全显示。<br>本来有种想法（参考<a href=\"http://blog.csdn.net/guolin_blog/article/details/8714621\" target=\"_blank\" rel=\"external\">郭霖大神的博客</a>）是采用线程Sleep的方式来达到滑动效果的。代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ScrollTask</span> <span class=\"keyword\">extends</span> <span class=\"title\">AsyncTask</span>&lt;<span class=\"title\">Integer</span>, <span class=\"title\">Integer</span>, <span class=\"title\">Integer</span>&gt; </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> Integer <span class=\"title\">doInBackground</span><span class=\"params\">(Integer... speed)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">int</span> leftMargin = contentLayout.leftMargin;</div><div class=\"line\">            <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\">                leftMargin = leftMargin - speed[<span class=\"number\">0</span>];</div><div class=\"line\">                <span class=\"keyword\">if</span> (leftMargin &gt; maxLeftMargin) &#123;</div><div class=\"line\">                    leftMargin = maxLeftMargin;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">if</span> (leftMargin &lt; minLeftMargin) &#123;</div><div class=\"line\">                    leftMargin = minLeftMargin;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                publishProgress(leftMargin);</div><div class=\"line\">                <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                    Thread.sleep(<span class=\"number\">20</span>);</div><div class=\"line\">                &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\">                    e.printStackTrace();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            isMenuOpen = speed[<span class=\"number\">0</span>] &gt; <span class=\"number\">0</span>;</div><div class=\"line\">            <span class=\"keyword\">return</span> leftMargin;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onProgressUpdate</span><span class=\"params\">(Integer... leftMargin)</span> </span>&#123;</div><div class=\"line\">            contentLayout.leftMargin = leftMargin[<span class=\"number\">0</span>];</div><div class=\"line\">            contentView.setLayoutParams(contentLayout);</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onPostExecute</span><span class=\"params\">(Integer leftMargin)</span> </span>&#123;</div><div class=\"line\">            contentLayout.leftMargin = leftMargin;</div><div class=\"line\">            contentView.setLayoutParams(contentLayout);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">toOpenMenu</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">new</span> ScrollTask().execute(<span class=\"number\">30</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">toCloseMenu</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">new</span> ScrollTask().execute(-<span class=\"number\">30</span>);</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>但是后面产生的实际效果不太好，滑动的时候总是有点卡顿的感觉，于是便弃用了，后面还是采用的Scroller类。</p>\n<p>下面贴上每个Item的布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">com.lastwarmth.mylistview.MyItemLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingLeft</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"4dp\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">de.hdodenhof.circleimageview.CircleImageView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/profile_image\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"56dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"56dp\"</span></div><div class=\"line\">            <span class=\"attr\">app:civ_border_color</span>=<span class=\"string\">\"#FF000000\"</span></div><div class=\"line\">            <span class=\"attr\">app:civ_border_width</span>=<span class=\"string\">\"1dp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_marginTop</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/group_name\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"群名称\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/qq_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_marginTop</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:singleLine</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"聊天内容\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/menu\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"240dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/to_top\"</span></div><div class=\"line\">            <span class=\"attr\">style</span>=<span class=\"string\">\"@style/menu_text_style\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@android:color/darker_gray\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"置顶\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/had_read\"</span></div><div class=\"line\">            <span class=\"attr\">style</span>=<span class=\"string\">\"@style/menu_text_style\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@android:color/holo_orange_light\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"标为已读\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/delete\"</span></div><div class=\"line\">            <span class=\"attr\">style</span>=<span class=\"string\">\"@style/menu_text_style\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@android:color/holo_red_light\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"删除\"</span> /&gt;</div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">com.lastwarmth.mylistview.MyItemLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>content id即是第一个子节点，menu id为第二个子节点。</p>\n<h2 id=\"Adapter\"><a href=\"#Adapter\" class=\"headerlink\" title=\"Adapter\"></a>Adapter</h2><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyAdapter</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseAdapter</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">private</span> List&lt;MyModel&gt; data;</div><div class=\"line\">    <span class=\"keyword\">private</span> Context mContext;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MyAdapter</span><span class=\"params\">(List&lt;MyModel&gt; data, Context mContext)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.data = data;</div><div class=\"line\">        <span class=\"keyword\">this</span>.mContext = mContext;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getCount</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (data != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">return</span> data.<span class=\"title\">size</span><span class=\"params\">()</span></span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\">Object <span class=\"title\">getItem</span><span class=\"params\">(<span class=\"keyword\">int</span> position)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (data != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">return</span> data.<span class=\"title\">get</span><span class=\"params\">(position)</span></span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">getItemId</span><span class=\"params\">(<span class=\"keyword\">int</span> position)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\">View <span class=\"title\">getView</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> position, View contentView, ViewGroup parent)</span> </span>&#123;</div><div class=\"line\">        ViewHolder holder;</div><div class=\"line\">        <span class=\"keyword\">if</span> (contentView == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            holder = <span class=\"keyword\">new</span> ViewHolder();</div><div class=\"line\">            contentView = LayoutInflater.from(mContext).inflate(R.layout.list_item, parent, <span class=\"keyword\">false</span>);</div><div class=\"line\">            holder.imageView = (CircleImageView) contentView.findViewById(R.id.profile_image);</div><div class=\"line\">            holder.groupName = (TextView) contentView.findViewById(R.id.group_name);</div><div class=\"line\">            holder.content = (TextView) contentView.findViewById(R.id.qq_content);</div><div class=\"line\">            holder.toTop = (TextView) contentView.findViewById(R.id.to_top);</div><div class=\"line\">            holder.hadRead = (TextView) contentView.findViewById(R.id.had_read);</div><div class=\"line\">            holder.delete = (TextView) contentView.findViewById(R.id.delete);</div><div class=\"line\">            contentView.setTag(holder);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            holder = (ViewHolder) contentView.getTag();</div><div class=\"line\">        &#125;</div><div class=\"line\">        MyModel myModel = (MyModel) getItem(position);</div><div class=\"line\">        holder.groupName.setText(myModel.getGroupName());</div><div class=\"line\">        holder.content.setText(myModel.getContent());</div><div class=\"line\">        Picasso.with(mContext)</div><div class=\"line\">                .load(myModel.getImageUrl())</div><div class=\"line\">                .placeholder(R.mipmap.lb_zjtx)</div><div class=\"line\">                .into(holder.imageView);</div><div class=\"line\">        <span class=\"keyword\">final</span> MyItemLayout finalContentView = (MyItemLayout) contentView;</div><div class=\"line\">        holder.toTop.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                Toast.makeText(mContext, <span class=\"string\">\"已置顶\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                finalContentView.smoothCloseMenu();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">        holder.hadRead.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                Toast.makeText(mContext, <span class=\"string\">\"已阅读\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                finalContentView.smoothCloseMenu();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">        holder.delete.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                data.remove(position);</div><div class=\"line\">                finalContentView.smoothCloseMenu();</div><div class=\"line\">                notifyDataSetChanged();</div><div class=\"line\">                Toast.makeText(mContext, <span class=\"string\">\"已删除\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">        <span class=\"keyword\">return</span> contentView;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ViewHolder</span> </span>&#123;</div><div class=\"line\">        CircleImageView imageView;</div><div class=\"line\">        TextView groupName;</div><div class=\"line\">        TextView content;</div><div class=\"line\">        TextView toTop;</div><div class=\"line\">        TextView hadRead;</div><div class=\"line\">        TextView delete;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>Adapter类比较简单，这里不做过多的赘述。</p>\n<h2 id=\"Model类\"><a href=\"#Model类\" class=\"headerlink\" title=\"Model类\"></a>Model类</h2><p>MyModel类主要是为了模仿QQ会话写的一个类。<br><figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyModel</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">String</span> imageUrl; <span class=\"comment\">// 头像Url</span></div><div class=\"line\">    <span class=\"keyword\">String</span> groupName; <span class=\"comment\">// 群名称</span></div><div class=\"line\">    <span class=\"keyword\">String</span> content; <span class=\"comment\">// 聊天内容</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> MyModel(<span class=\"keyword\">String</span> imageUrl, <span class=\"keyword\">String</span> groupName, <span class=\"keyword\">String</span> content) &#123;</div><div class=\"line\">        <span class=\"built_in\">this</span>.imageUrl = imageUrl;</div><div class=\"line\">        <span class=\"built_in\">this</span>.groupName = groupName;</div><div class=\"line\">        <span class=\"built_in\">this</span>.content = content;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">String</span> getImageUrl() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> imageUrl;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">String</span> getGroupName() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> groupName;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">String</span> getContent() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> content;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"自定义ListView\"><a href=\"#自定义ListView\" class=\"headerlink\" title=\"自定义ListView\"></a>自定义ListView</h2><p>下面便是最关键的一个：自定义ListView，覆写onTouchEvent方法，实现滑动删除。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyListView</span> <span class=\"keyword\">extends</span> <span class=\"title\">ListView</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// 滑动速度追踪类</span></div><div class=\"line\">    <span class=\"keyword\">private</span> VelocityTracker mVelocityTracker;</div><div class=\"line\">    <span class=\"comment\">// ACTION_DOWN的坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> xDown;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> yDown;</div><div class=\"line\">    <span class=\"comment\">// 判断横滑、竖滑的最小值</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> MAX_Y = <span class=\"number\">5</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> MAX_X = <span class=\"number\">3</span>;</div><div class=\"line\">    <span class=\"comment\">// 当前点击的position</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mTouchPosition;</div><div class=\"line\">    <span class=\"comment\">// 当前点击的item View</span></div><div class=\"line\">    <span class=\"keyword\">private</span> MyItemLayout mTouchView;</div><div class=\"line\">    <span class=\"comment\">// 当前触摸状态</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mTouchState = TOUCH_STATE_NONE;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> TOUCH_STATE_NONE = <span class=\"number\">0</span>; <span class=\"comment\">//ACTION_DOWN时设置的状态</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> TOUCH_STATE_X = <span class=\"number\">1</span>; <span class=\"comment\">//横滑</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> TOUCH_STATE_Y = <span class=\"number\">2</span>; <span class=\"comment\">//竖滑</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MyListView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        MAX_X = dp2px(MAX_X);</div><div class=\"line\">        MAX_Y = dp2px(MAX_Y);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 创建VelocityTracker对象，并将触摸事件加入到VelocityTracker当中</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> event</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">createVelocityTracker</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (mVelocityTracker == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            mVelocityTracker = VelocityTracker.obtain();</div><div class=\"line\">        &#125;</div><div class=\"line\">        mVelocityTracker.addMovement(event);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 获取手指在滑动的速度</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span> 滑动速度，以每秒钟移动了多少像素值为单位</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getScrollVelocity</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        mVelocityTracker.computeCurrentVelocity(<span class=\"number\">1000</span>);</div><div class=\"line\">        <span class=\"keyword\">int</span> velocity = (<span class=\"keyword\">int</span>) mVelocityTracker.getXVelocity();</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> Math.<span class=\"title\">abs</span><span class=\"params\">(velocity)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 回收VelocityTracker对象</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">recycleVelocityTracker</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        mVelocityTracker.recycle();</div><div class=\"line\">        mVelocityTracker = <span class=\"keyword\">null</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 触摸事件的控制</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> ev</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (ev.getAction() != MotionEvent.ACTION_DOWN &amp;&amp; mTouchView == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"comment\">// 加入触摸跟踪类</span></div><div class=\"line\">        createVelocityTracker(ev);</div><div class=\"line\">        <span class=\"keyword\">float</span> moveX;</div><div class=\"line\">        <span class=\"keyword\">float</span> moveY;</div><div class=\"line\">        <span class=\"keyword\">int</span> action = ev.getAction();</div><div class=\"line\">        <span class=\"keyword\">switch</span> (action) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                <span class=\"keyword\">int</span> prevPosition = mTouchPosition;</div><div class=\"line\">                xDown = ev.getX();</div><div class=\"line\">                yDown = ev.getY();</div><div class=\"line\">                mTouchState = TOUCH_STATE_NONE;</div><div class=\"line\">                mTouchPosition = pointToPosition((<span class=\"keyword\">int</span>) xDown, (<span class=\"keyword\">int</span>) yDown);</div><div class=\"line\">                <span class=\"comment\">// 当前点击的Item正好是已经显示Menu的Item</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (prevPosition == mTouchPosition &amp;&amp; mTouchView != <span class=\"keyword\">null</span> &amp;&amp; mTouchView.isMenuOpen()) &#123;</div><div class=\"line\">                    mTouchState = TOUCH_STATE_X;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>; <span class=\"comment\">// 返回true表示接受了ACTION_DOWN，那么后面的事件依然会分发给MyListView</span></div><div class=\"line\">                &#125;</div><div class=\"line\">                View view = getChildAt(mTouchPosition - getFirstVisiblePosition());</div><div class=\"line\">                <span class=\"comment\">// 点击的Item不是正在显示Menu的Item，则直接关闭Menu</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (mTouchView != <span class=\"keyword\">null</span> &amp;&amp; mTouchView.isMenuOpen()) &#123;</div><div class=\"line\">                    mTouchView.smoothCloseMenu();</div><div class=\"line\">                    mTouchView = <span class=\"keyword\">null</span>;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>; <span class=\"comment\">// 返回false，那么后面的事件全部会接收不到</span></div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">if</span> (view <span class=\"keyword\">instanceof</span> MyItemLayout) &#123;</div><div class=\"line\">                    mTouchView = (MyItemLayout) view;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                moveX = ev.getX() - xDown;</div><div class=\"line\">                moveY = ev.getY() - yDown;</div><div class=\"line\">                <span class=\"keyword\">if</span> (mTouchState == TOUCH_STATE_X) &#123;</div><div class=\"line\">                    <span class=\"comment\">// 如果是横滑，则设置leftMargin</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (!mTouchView.isMenuOpen()) &#123;</div><div class=\"line\">                        mTouchView.setLeftMargin((<span class=\"keyword\">int</span>) moveX);</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                        mTouchView.setLeftMargin((<span class=\"keyword\">int</span>) (moveX - mTouchView.getMenuWidth()));</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">                &#125; <span class=\"function\"><span class=\"keyword\">else</span> <span class=\"title\">if</span> <span class=\"params\">(mTouchState == TOUCH_STATE_NONE)</span> </span>&#123;</div><div class=\"line\">                    <span class=\"comment\">// 设置横滑还是竖滑</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (Math.abs(moveY) &gt; MAX_Y) &#123;</div><div class=\"line\">                        mTouchState = TOUCH_STATE_Y;</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (Math.abs(moveX) &gt; MAX_X) &#123;</div><div class=\"line\">                        mTouchState = TOUCH_STATE_X;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">                moveX = ev.getX() - xDown;</div><div class=\"line\">                <span class=\"keyword\">if</span> (mTouchState == TOUCH_STATE_X) &#123;</div><div class=\"line\">                    <span class=\"comment\">// 若滑动的距离是Menu宽度的一半，或者左滑速度大于200,</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (-moveX &gt; mTouchView.getMenuWidth() / <span class=\"number\">2</span> || (moveX &lt; <span class=\"number\">0</span> &amp;&amp; getScrollVelocity() &gt; <span class=\"number\">200</span>)) &#123;</div><div class=\"line\">                        <span class=\"comment\">// 若Menu是关闭的</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (!mTouchView.isMenuOpen()) &#123;</div><div class=\"line\">                            <span class=\"comment\">// 滑动打开Menu</span></div><div class=\"line\">                            mTouchView.smoothOpenMenu();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                        <span class=\"comment\">// 滑动关闭Menu</span></div><div class=\"line\">                        mTouchView.smoothCloseMenu();</div><div class=\"line\">                        mTouchView = <span class=\"keyword\">null</span>;</div><div class=\"line\">                        mTouchPosition = <span class=\"number\">-1</span>;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    recycleVelocityTracker();</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">dp2px</span><span class=\"params\">(<span class=\"keyword\">int</span> dp)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> (<span class=\"keyword\">int</span>) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,</div><div class=\"line\">                getContext().getResources().getDisplayMetrics());</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>在这个项目中，触摸事件分以下几种情况：</p>\n<ol>\n<li><p>当前没有Menu正在显示</p>\n<ul>\n<li>ACTION_DOWN记录相关信息，准备接收ACTION_MOVE、ACTION_UP事件。</li>\n<li>ACTION_MOVE中，判断是横滑还是竖滑。若是横滑，则调用setLeftMargin()，这个时候若一直滑动，Menu会慢慢地显示出来。后面会返回true，主要是为了拦截最后的super.onTouchEvent(ev)不执行。若是竖滑，则直接调用super.onTouchEvent(ev)，这个时候若一直滑动，则是ListView的上下滑动了。</li>\n<li>ACTION_UP中，我们只需要判断是否要显示，若显示则调用smoothOpenMenu()，并返回true（这里返回true或者false都没有实际的意义）。若是不需要，则直接super.onTouchEvent(ev)。</li>\n</ul>\n</li>\n<li><p>当前有Menu正在显示</p>\n<ul>\n<li>ACTION_DOWN，若当前点击的Item不是Menu正在显示的Item，那么直接smoothCloseMenu()，并且返回false。返回false后MOVE、UP等事件会统统不接收。</li>\n<li>若是正在点击的Item，那么首先设置为横滑，并且返回true，等待后续的触摸事件。</li>\n<li>ACTION_MOVE因为在DOWN的时候设置了mTouchState = TOUCH_STATE_X;那么会执行到if内部，因为Menu正在显示，所以不会调用setLeftMargin()，并且直接返回true，即后面的super.onTouchEvent(ev)也不会调用。</li>\n<li>ACTION_UP中判断Menu是否要关闭，若关闭则调用smoothCloseMenu()，并且返回true。若是不需要，则直接返回super.onTouchEvent(ev)。</li>\n</ul>\n</li>\n</ol>\n<p>这里是复杂的地方，需要对各种情况进行判断，然后执行相应的逻辑。我写了好多次，改过好多次QAQ…</p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><ul>\n<li>在ACTION_DOWN的分支中，返回false会直接截断后面MOVE、UP等事件的接收。</li>\n<li>在ACTION_MOVE与ACTION_UP的返回值，为true为false，并没有特别实际的效果，仅仅是为了返回，以此来截断super.onTouchEvent(ev)的执行。</li>\n</ul>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>下面上效果图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/swipe-listview2.png\" alt=\"这里写图片描述\"><br>看起来效果也还不错，是吧？</p>\n<font size=\"5\"><a href=\"https://github.com/LiJia92/MyListView\" target=\"_blank\" rel=\"external\">源码下载</a></font>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>手机QQ应该是很普及的App了，看到QQ消息栏对话框列表的每个子项左滑的时候会弹出删除、置顶图标。like this：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/swipe-listview1.png\" alt=\"这里写图片描述\"><br>于是突发奇想：想要自己实现一个这样的效果。<br>很显然的，这样的效果实现要依赖Android的事件分发机制，于是我先从Android事件分发入手。对于事件分发还不太熟悉的朋友可以参考<a href=\"http://lijia92.github.io/2015/11/14/touch-event/\">Android事件分发机制学习</a>。<br>下面开工！</p>","more":"<h2 id=\"List-Item\"><a href=\"#List-Item\" class=\"headerlink\" title=\"List Item\"></a>List Item</h2><p>首先，针对ListView的每个Item自定义一个MyItemLayout。代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyItemLayout</span> <span class=\"keyword\">extends</span> <span class=\"title\">LinearLayout</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// content View</span></div><div class=\"line\">    <span class=\"keyword\">private</span> LinearLayout contentView;</div><div class=\"line\">    <span class=\"comment\">// menu View</span></div><div class=\"line\">    <span class=\"keyword\">private</span> LinearLayout menuView;</div><div class=\"line\">    <span class=\"comment\">// content View的布局参数对象</span></div><div class=\"line\">    <span class=\"keyword\">private</span> LayoutParams contentLayout;</div><div class=\"line\">    <span class=\"comment\">// 菜单是否打开</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isMenuOpen;</div><div class=\"line\">    <span class=\"comment\">// contentView最小的leftMargin</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> minLeftMargin;</div><div class=\"line\">    <span class=\"comment\">// contentView最大的leftMargin</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> maxLeftMargin = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"comment\">// 滑动类</span></div><div class=\"line\">    <span class=\"keyword\">private</span> Scroller mScroller = <span class=\"keyword\">null</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MyItemLayout</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        contentLayout = <span class=\"keyword\">new</span> LayoutParams(getScreenWidth(), LayoutParams.WRAP_CONTENT);</div><div class=\"line\">        mScroller = <span class=\"keyword\">new</span> Scroller(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">computeScroll</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (mScroller.computeScrollOffset()) &#123;</div><div class=\"line\">            setLeftMargin(mScroller.getCurrX());</div><div class=\"line\">            postInvalidate();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * Scroller平滑打开Menu</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">smoothOpenMenu</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        isMenuOpen = <span class=\"keyword\">true</span>;</div><div class=\"line\">        mScroller.startScroll(contentLayout.leftMargin, <span class=\"number\">0</span>, minLeftMargin - contentLayout.leftMargin, <span class=\"number\">0</span>, <span class=\"number\">350</span>);</div><div class=\"line\">        postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * Scroller平滑关闭Menu</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">smoothCloseMenu</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        isMenuOpen = <span class=\"keyword\">false</span>;</div><div class=\"line\">        mScroller.startScroll(contentLayout.leftMargin, <span class=\"number\">0</span>, maxLeftMargin - contentLayout.leftMargin, <span class=\"number\">0</span>, <span class=\"number\">350</span>);</div><div class=\"line\">        postInvalidate();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 在布局inflate完成后调用</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onFinishInflate</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onFinishInflate();</div><div class=\"line\">        <span class=\"comment\">// 第一个孩子是contentView</span></div><div class=\"line\">        contentView = (LinearLayout) getChildAt(<span class=\"number\">0</span>);</div><div class=\"line\">        <span class=\"comment\">// 第二个孩子是MenuView</span></div><div class=\"line\">        menuView = (LinearLayout) getChildAt(<span class=\"number\">1</span>);</div><div class=\"line\">        <span class=\"comment\">// 最小的leftMargin为负的menuView宽度</span></div><div class=\"line\">        ViewGroup.LayoutParams lp = menuView.getLayoutParams();</div><div class=\"line\">        minLeftMargin = -lp.width;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 获取屏幕宽度</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">getScreenWidth</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        DisplayMetrics dm = getResources().getDisplayMetrics();</div><div class=\"line\">        <span class=\"keyword\">return</span> dm.widthPixels;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 给contentView设置leftMargin</div><div class=\"line\">     * <span class=\"doctag\">@param</span> leftMargin</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setLeftMargin</span><span class=\"params\">(<span class=\"keyword\">int</span> leftMargin)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// 控制leftMargin不越界</span></div><div class=\"line\">        <span class=\"keyword\">if</span> (leftMargin &gt; maxLeftMargin) &#123;</div><div class=\"line\">            leftMargin = maxLeftMargin;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span> (leftMargin &lt; minLeftMargin) &#123;</div><div class=\"line\">            leftMargin = minLeftMargin;</div><div class=\"line\">        &#125;</div><div class=\"line\">        contentLayout.leftMargin = leftMargin;</div><div class=\"line\">        <span class=\"comment\">// 通过设置leftMargin，达到menu显示的效果</span></div><div class=\"line\">        contentView.setLayoutParams(contentLayout);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 获取menuView宽度</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getMenuWidth</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> -minLeftMargin;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * Menu是否打开</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isMenuOpen</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> isMenuOpen;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>每个Item有2个直接子节点，第一个是contentView，第二个是menuView。通过设置contentView的leftMargin，达到显示Menu的效果。初始时，leftMargin为0，Menu完全隐藏。当滑动时，leftMargin逐渐缩小（因为是负数），当leftMargin等于minLeftMargin时，Menu完全显示。<br>本来有种想法（参考<a href=\"http://blog.csdn.net/guolin_blog/article/details/8714621\">郭霖大神的博客</a>）是采用线程Sleep的方式来达到滑动效果的。代码如下：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ScrollTask</span> <span class=\"keyword\">extends</span> <span class=\"title\">AsyncTask</span>&lt;<span class=\"title\">Integer</span>, <span class=\"title\">Integer</span>, <span class=\"title\">Integer</span>&gt; </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> Integer <span class=\"title\">doInBackground</span><span class=\"params\">(Integer... speed)</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">int</span> leftMargin = contentLayout.leftMargin;</div><div class=\"line\">            <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\">                leftMargin = leftMargin - speed[<span class=\"number\">0</span>];</div><div class=\"line\">                <span class=\"keyword\">if</span> (leftMargin &gt; maxLeftMargin) &#123;</div><div class=\"line\">                    leftMargin = maxLeftMargin;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">if</span> (leftMargin &lt; minLeftMargin) &#123;</div><div class=\"line\">                    leftMargin = minLeftMargin;</div><div class=\"line\">                    <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                publishProgress(leftMargin);</div><div class=\"line\">                <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                    Thread.sleep(<span class=\"number\">20</span>);</div><div class=\"line\">                &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</div><div class=\"line\">                    e.printStackTrace();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            isMenuOpen = speed[<span class=\"number\">0</span>] &gt; <span class=\"number\">0</span>;</div><div class=\"line\">            <span class=\"keyword\">return</span> leftMargin;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onProgressUpdate</span><span class=\"params\">(Integer... leftMargin)</span> </span>&#123;</div><div class=\"line\">            contentLayout.leftMargin = leftMargin[<span class=\"number\">0</span>];</div><div class=\"line\">            contentView.setLayoutParams(contentLayout);</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onPostExecute</span><span class=\"params\">(Integer leftMargin)</span> </span>&#123;</div><div class=\"line\">            contentLayout.leftMargin = leftMargin;</div><div class=\"line\">            contentView.setLayoutParams(contentLayout);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">toOpenMenu</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">new</span> ScrollTask().execute(<span class=\"number\">30</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">toCloseMenu</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">new</span> ScrollTask().execute(-<span class=\"number\">30</span>);</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>但是后面产生的实际效果不太好，滑动的时候总是有点卡顿的感觉，于是便弃用了，后面还是采用的Scroller类。</p>\n<p>下面贴上每个Item的布局：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">com.lastwarmth.mylistview.MyItemLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">xmlns:app</span>=<span class=\"string\">\"http://schemas.android.com/apk/res-auto\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/content\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingBottom</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingLeft</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:paddingTop</span>=<span class=\"string\">\"4dp\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">de.hdodenhof.circleimageview.CircleImageView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/profile_image\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"56dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"56dp\"</span></div><div class=\"line\">            <span class=\"attr\">app:civ_border_color</span>=<span class=\"string\">\"#FF000000\"</span></div><div class=\"line\">            <span class=\"attr\">app:civ_border_width</span>=<span class=\"string\">\"1dp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_marginLeft</span>=<span class=\"string\">\"16dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_marginTop</span>=<span class=\"string\">\"4dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"vertical\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/group_name\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"群名称\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/qq_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_marginTop</span>=<span class=\"string\">\"8dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:singleLine</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">                <span class=\"attr\">android:text</span>=<span class=\"string\">\"聊天内容\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">LinearLayout</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/menu\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"240dp\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:orientation</span>=<span class=\"string\">\"horizontal\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/to_top\"</span></div><div class=\"line\">            <span class=\"attr\">style</span>=<span class=\"string\">\"@style/menu_text_style\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@android:color/darker_gray\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"置顶\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/had_read\"</span></div><div class=\"line\">            <span class=\"attr\">style</span>=<span class=\"string\">\"@style/menu_text_style\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@android:color/holo_orange_light\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"标为已读\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TextView</span></div><div class=\"line\">            <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/delete\"</span></div><div class=\"line\">            <span class=\"attr\">style</span>=<span class=\"string\">\"@style/menu_text_style\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"80dp\"</span></div><div class=\"line\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">            <span class=\"attr\">android:background</span>=<span class=\"string\">\"@android:color/holo_red_light\"</span></div><div class=\"line\">            <span class=\"attr\">android:gravity</span>=<span class=\"string\">\"center\"</span></div><div class=\"line\">            <span class=\"attr\">android:text</span>=<span class=\"string\">\"删除\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">LinearLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">com.lastwarmth.mylistview.MyItemLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>content id即是第一个子节点，menu id为第二个子节点。</p>\n<h2 id=\"Adapter\"><a href=\"#Adapter\" class=\"headerlink\" title=\"Adapter\"></a>Adapter</h2><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyAdapter</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseAdapter</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">private</span> List&lt;MyModel&gt; data;</div><div class=\"line\">    <span class=\"keyword\">private</span> Context mContext;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MyAdapter</span><span class=\"params\">(List&lt;MyModel&gt; data, Context mContext)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.data = data;</div><div class=\"line\">        <span class=\"keyword\">this</span>.mContext = mContext;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getCount</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (data != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">return</span> data.<span class=\"title\">size</span><span class=\"params\">()</span></span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\">Object <span class=\"title\">getItem</span><span class=\"params\">(<span class=\"keyword\">int</span> position)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (data != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">return</span> data.<span class=\"title\">get</span><span class=\"params\">(position)</span></span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">getItemId</span><span class=\"params\">(<span class=\"keyword\">int</span> position)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\">View <span class=\"title\">getView</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> position, View contentView, ViewGroup parent)</span> </span>&#123;</div><div class=\"line\">        ViewHolder holder;</div><div class=\"line\">        <span class=\"keyword\">if</span> (contentView == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            holder = <span class=\"keyword\">new</span> ViewHolder();</div><div class=\"line\">            contentView = LayoutInflater.from(mContext).inflate(R.layout.list_item, parent, <span class=\"keyword\">false</span>);</div><div class=\"line\">            holder.imageView = (CircleImageView) contentView.findViewById(R.id.profile_image);</div><div class=\"line\">            holder.groupName = (TextView) contentView.findViewById(R.id.group_name);</div><div class=\"line\">            holder.content = (TextView) contentView.findViewById(R.id.qq_content);</div><div class=\"line\">            holder.toTop = (TextView) contentView.findViewById(R.id.to_top);</div><div class=\"line\">            holder.hadRead = (TextView) contentView.findViewById(R.id.had_read);</div><div class=\"line\">            holder.delete = (TextView) contentView.findViewById(R.id.delete);</div><div class=\"line\">            contentView.setTag(holder);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            holder = (ViewHolder) contentView.getTag();</div><div class=\"line\">        &#125;</div><div class=\"line\">        MyModel myModel = (MyModel) getItem(position);</div><div class=\"line\">        holder.groupName.setText(myModel.getGroupName());</div><div class=\"line\">        holder.content.setText(myModel.getContent());</div><div class=\"line\">        Picasso.with(mContext)</div><div class=\"line\">                .load(myModel.getImageUrl())</div><div class=\"line\">                .placeholder(R.mipmap.lb_zjtx)</div><div class=\"line\">                .into(holder.imageView);</div><div class=\"line\">        <span class=\"keyword\">final</span> MyItemLayout finalContentView = (MyItemLayout) contentView;</div><div class=\"line\">        holder.toTop.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                Toast.makeText(mContext, <span class=\"string\">\"已置顶\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                finalContentView.smoothCloseMenu();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">        holder.hadRead.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                Toast.makeText(mContext, <span class=\"string\">\"已阅读\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">                finalContentView.smoothCloseMenu();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">        holder.delete.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                data.remove(position);</div><div class=\"line\">                finalContentView.smoothCloseMenu();</div><div class=\"line\">                notifyDataSetChanged();</div><div class=\"line\">                Toast.makeText(mContext, <span class=\"string\">\"已删除\"</span>, Toast.LENGTH_SHORT).show();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">        <span class=\"keyword\">return</span> contentView;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ViewHolder</span> </span>&#123;</div><div class=\"line\">        CircleImageView imageView;</div><div class=\"line\">        TextView groupName;</div><div class=\"line\">        TextView content;</div><div class=\"line\">        TextView toTop;</div><div class=\"line\">        TextView hadRead;</div><div class=\"line\">        TextView delete;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>Adapter类比较简单，这里不做过多的赘述。</p>\n<h2 id=\"Model类\"><a href=\"#Model类\" class=\"headerlink\" title=\"Model类\"></a>Model类</h2><p>MyModel类主要是为了模仿QQ会话写的一个类。<br><figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyModel</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">String</span> imageUrl; <span class=\"comment\">// 头像Url</span></div><div class=\"line\">    <span class=\"keyword\">String</span> groupName; <span class=\"comment\">// 群名称</span></div><div class=\"line\">    <span class=\"keyword\">String</span> content; <span class=\"comment\">// 聊天内容</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> MyModel(<span class=\"keyword\">String</span> imageUrl, <span class=\"keyword\">String</span> groupName, <span class=\"keyword\">String</span> content) &#123;</div><div class=\"line\">        <span class=\"built_in\">this</span>.imageUrl = imageUrl;</div><div class=\"line\">        <span class=\"built_in\">this</span>.groupName = groupName;</div><div class=\"line\">        <span class=\"built_in\">this</span>.content = content;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">String</span> getImageUrl() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> imageUrl;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">String</span> getGroupName() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> groupName;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">String</span> getContent() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> content;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"自定义ListView\"><a href=\"#自定义ListView\" class=\"headerlink\" title=\"自定义ListView\"></a>自定义ListView</h2><p>下面便是最关键的一个：自定义ListView，覆写onTouchEvent方法，实现滑动删除。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyListView</span> <span class=\"keyword\">extends</span> <span class=\"title\">ListView</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// 滑动速度追踪类</span></div><div class=\"line\">    <span class=\"keyword\">private</span> VelocityTracker mVelocityTracker;</div><div class=\"line\">    <span class=\"comment\">// ACTION_DOWN的坐标</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> xDown;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> yDown;</div><div class=\"line\">    <span class=\"comment\">// 判断横滑、竖滑的最小值</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> MAX_Y = <span class=\"number\">5</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> MAX_X = <span class=\"number\">3</span>;</div><div class=\"line\">    <span class=\"comment\">// 当前点击的position</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mTouchPosition;</div><div class=\"line\">    <span class=\"comment\">// 当前点击的item View</span></div><div class=\"line\">    <span class=\"keyword\">private</span> MyItemLayout mTouchView;</div><div class=\"line\">    <span class=\"comment\">// 当前触摸状态</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mTouchState = TOUCH_STATE_NONE;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> TOUCH_STATE_NONE = <span class=\"number\">0</span>; <span class=\"comment\">//ACTION_DOWN时设置的状态</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> TOUCH_STATE_X = <span class=\"number\">1</span>; <span class=\"comment\">//横滑</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> TOUCH_STATE_Y = <span class=\"number\">2</span>; <span class=\"comment\">//竖滑</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">MyListView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">        MAX_X = dp2px(MAX_X);</div><div class=\"line\">        MAX_Y = dp2px(MAX_Y);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 创建VelocityTracker对象，并将触摸事件加入到VelocityTracker当中</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> event</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">createVelocityTracker</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (mVelocityTracker == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            mVelocityTracker = VelocityTracker.obtain();</div><div class=\"line\">        &#125;</div><div class=\"line\">        mVelocityTracker.addMovement(event);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 获取手指在滑动的速度</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span> 滑动速度，以每秒钟移动了多少像素值为单位</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getScrollVelocity</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        mVelocityTracker.computeCurrentVelocity(<span class=\"number\">1000</span>);</div><div class=\"line\">        <span class=\"keyword\">int</span> velocity = (<span class=\"keyword\">int</span>) mVelocityTracker.getXVelocity();</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> Math.<span class=\"title\">abs</span><span class=\"params\">(velocity)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 回收VelocityTracker对象</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">recycleVelocityTracker</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        mVelocityTracker.recycle();</div><div class=\"line\">        mVelocityTracker = <span class=\"keyword\">null</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 触摸事件的控制</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> ev</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (ev.getAction() != MotionEvent.ACTION_DOWN &amp;&amp; mTouchView == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"comment\">// 加入触摸跟踪类</span></div><div class=\"line\">        createVelocityTracker(ev);</div><div class=\"line\">        <span class=\"keyword\">float</span> moveX;</div><div class=\"line\">        <span class=\"keyword\">float</span> moveY;</div><div class=\"line\">        <span class=\"keyword\">int</span> action = ev.getAction();</div><div class=\"line\">        <span class=\"keyword\">switch</span> (action) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                <span class=\"keyword\">int</span> prevPosition = mTouchPosition;</div><div class=\"line\">                xDown = ev.getX();</div><div class=\"line\">                yDown = ev.getY();</div><div class=\"line\">                mTouchState = TOUCH_STATE_NONE;</div><div class=\"line\">                mTouchPosition = pointToPosition((<span class=\"keyword\">int</span>) xDown, (<span class=\"keyword\">int</span>) yDown);</div><div class=\"line\">                <span class=\"comment\">// 当前点击的Item正好是已经显示Menu的Item</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (prevPosition == mTouchPosition &amp;&amp; mTouchView != <span class=\"keyword\">null</span> &amp;&amp; mTouchView.isMenuOpen()) &#123;</div><div class=\"line\">                    mTouchState = TOUCH_STATE_X;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>; <span class=\"comment\">// 返回true表示接受了ACTION_DOWN，那么后面的事件依然会分发给MyListView</span></div><div class=\"line\">                &#125;</div><div class=\"line\">                View view = getChildAt(mTouchPosition - getFirstVisiblePosition());</div><div class=\"line\">                <span class=\"comment\">// 点击的Item不是正在显示Menu的Item，则直接关闭Menu</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (mTouchView != <span class=\"keyword\">null</span> &amp;&amp; mTouchView.isMenuOpen()) &#123;</div><div class=\"line\">                    mTouchView.smoothCloseMenu();</div><div class=\"line\">                    mTouchView = <span class=\"keyword\">null</span>;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>; <span class=\"comment\">// 返回false，那么后面的事件全部会接收不到</span></div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">if</span> (view <span class=\"keyword\">instanceof</span> MyItemLayout) &#123;</div><div class=\"line\">                    mTouchView = (MyItemLayout) view;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                moveX = ev.getX() - xDown;</div><div class=\"line\">                moveY = ev.getY() - yDown;</div><div class=\"line\">                <span class=\"keyword\">if</span> (mTouchState == TOUCH_STATE_X) &#123;</div><div class=\"line\">                    <span class=\"comment\">// 如果是横滑，则设置leftMargin</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (!mTouchView.isMenuOpen()) &#123;</div><div class=\"line\">                        mTouchView.setLeftMargin((<span class=\"keyword\">int</span>) moveX);</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                        mTouchView.setLeftMargin((<span class=\"keyword\">int</span>) (moveX - mTouchView.getMenuWidth()));</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">                &#125; <span class=\"function\"><span class=\"keyword\">else</span> <span class=\"title\">if</span> <span class=\"params\">(mTouchState == TOUCH_STATE_NONE)</span> </span>&#123;</div><div class=\"line\">                    <span class=\"comment\">// 设置横滑还是竖滑</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (Math.abs(moveY) &gt; MAX_Y) &#123;</div><div class=\"line\">                        mTouchState = TOUCH_STATE_Y;</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (Math.abs(moveX) &gt; MAX_X) &#123;</div><div class=\"line\">                        mTouchState = TOUCH_STATE_X;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">                moveX = ev.getX() - xDown;</div><div class=\"line\">                <span class=\"keyword\">if</span> (mTouchState == TOUCH_STATE_X) &#123;</div><div class=\"line\">                    <span class=\"comment\">// 若滑动的距离是Menu宽度的一半，或者左滑速度大于200,</span></div><div class=\"line\">                    <span class=\"keyword\">if</span> (-moveX &gt; mTouchView.getMenuWidth() / <span class=\"number\">2</span> || (moveX &lt; <span class=\"number\">0</span> &amp;&amp; getScrollVelocity() &gt; <span class=\"number\">200</span>)) &#123;</div><div class=\"line\">                        <span class=\"comment\">// 若Menu是关闭的</span></div><div class=\"line\">                        <span class=\"keyword\">if</span> (!mTouchView.isMenuOpen()) &#123;</div><div class=\"line\">                            <span class=\"comment\">// 滑动打开Menu</span></div><div class=\"line\">                            mTouchView.smoothOpenMenu();</div><div class=\"line\">                        &#125;</div><div class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                        <span class=\"comment\">// 滑动关闭Menu</span></div><div class=\"line\">                        mTouchView.smoothCloseMenu();</div><div class=\"line\">                        mTouchView = <span class=\"keyword\">null</span>;</div><div class=\"line\">                        mTouchPosition = <span class=\"number\">-1</span>;</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    recycleVelocityTracker();</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">dp2px</span><span class=\"params\">(<span class=\"keyword\">int</span> dp)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> (<span class=\"keyword\">int</span>) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,</div><div class=\"line\">                getContext().getResources().getDisplayMetrics());</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>在这个项目中，触摸事件分以下几种情况：</p>\n<ol>\n<li><p>当前没有Menu正在显示</p>\n<ul>\n<li>ACTION_DOWN记录相关信息，准备接收ACTION_MOVE、ACTION_UP事件。</li>\n<li>ACTION_MOVE中，判断是横滑还是竖滑。若是横滑，则调用setLeftMargin()，这个时候若一直滑动，Menu会慢慢地显示出来。后面会返回true，主要是为了拦截最后的super.onTouchEvent(ev)不执行。若是竖滑，则直接调用super.onTouchEvent(ev)，这个时候若一直滑动，则是ListView的上下滑动了。</li>\n<li>ACTION_UP中，我们只需要判断是否要显示，若显示则调用smoothOpenMenu()，并返回true（这里返回true或者false都没有实际的意义）。若是不需要，则直接super.onTouchEvent(ev)。</li>\n</ul>\n</li>\n<li><p>当前有Menu正在显示</p>\n<ul>\n<li>ACTION_DOWN，若当前点击的Item不是Menu正在显示的Item，那么直接smoothCloseMenu()，并且返回false。返回false后MOVE、UP等事件会统统不接收。</li>\n<li>若是正在点击的Item，那么首先设置为横滑，并且返回true，等待后续的触摸事件。</li>\n<li>ACTION_MOVE因为在DOWN的时候设置了mTouchState = TOUCH_STATE_X;那么会执行到if内部，因为Menu正在显示，所以不会调用setLeftMargin()，并且直接返回true，即后面的super.onTouchEvent(ev)也不会调用。</li>\n<li>ACTION_UP中判断Menu是否要关闭，若关闭则调用smoothCloseMenu()，并且返回true。若是不需要，则直接返回super.onTouchEvent(ev)。</li>\n</ul>\n</li>\n</ol>\n<p>这里是复杂的地方，需要对各种情况进行判断，然后执行相应的逻辑。我写了好多次，改过好多次QAQ…</p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><ul>\n<li>在ACTION_DOWN的分支中，返回false会直接截断后面MOVE、UP等事件的接收。</li>\n<li>在ACTION_MOVE与ACTION_UP的返回值，为true为false，并没有特别实际的效果，仅仅是为了返回，以此来截断super.onTouchEvent(ev)的执行。</li>\n</ul>\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>下面上效果图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/swipe-listview2.png\" alt=\"这里写图片描述\"><br>看起来效果也还不错，是吧？</p>\n<font size=5><a href=\"https://github.com/LiJia92/MyListView\">源码下载</a></font>"},{"title":"Android状态栏、虚拟按键小记","date":"2016-09-20T08:05:23.000Z","_content":"\n之前写过一篇[状态栏小记](http://lastwarmth.site/2016/08/04/statusbar/)，这里加入虚拟按键重新做一下总结。\n\n<!-- more -->\n\n## 前言\nAndroid 4.0之后，我们可以通过``setSystemUiVisibility(int)``方法，结合各种flag来设置系统组件（状态栏、虚拟按键）的显示或隐藏。那么有哪些Flag呢？Android官方文档有以下flag：\n1. View.SYSTEM_UI_FLAG_FULLSCREEN\n> View has requested to go into the normal fullscreen mode so that its content can take over the screen while still allowing the user to interact with the application.\n\n2. View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\n> View has requested that the system navigation be temporarily hidden.\n\n3. View.SYSTEM_UI_FLAG_IMMERSIVE\n> View would like to remain interactive when hiding the navigation bar with SYSTEM_UI_FLAG_HIDE_NAVIGATION.\n\n4. View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY\n> View would like to remain interactive when hiding the status bar with SYSTEM_UI_FLAG_FULLSCREEN and/or hiding the navigation bar with SYSTEM_UI_FLAG_HIDE_NAVIGATION.\n\n5. View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n> View would like its window to be laid out as if it has requested SYSTEM_UI_FLAG_FULLSCREEN, even if it currently hasn't.\n\n6. View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n> View would like its window to be laid out as if it has requested SYSTEM_UI_FLAG_HIDE_NAVIGATION, even if it currently hasn't.\n\n7. View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n> When using other layout flags, we would like a stable view of the content insets given to fitSystemWindows(Rect).\n\n8. SYSTEM_UI_FLAG_LIGHT_STATUS_BAR\n> Requests the status bar to draw in a mode that is compatible with light status bar backgrounds.\n\n9. View.SYSTEM_UI_FLAG_LOW_PROFILE\n> View has requested the system UI to enter an unobtrusive \"low profile\" mode.\n\n10. SYSTEM_UI_FLAG_VISIBLE\n> View has requested the system UI (status bar) to be visible (the default).\n\n11. SYSTEM_UI_LAYOUT_FLAGS\n> Flags that can impact the layout in relation to system UI.\n\n## 实用代码\n在做与状态栏、虚拟按键相关的工作时，有些代码亲测比较实用。\n获取状态栏高度：\n```\n/**\n * 获取状态栏高度\n *\n * @return\n */\npublic int getStatusBarHeight() {\n    int result = 0;\n    int resourceId = getResources().getIdentifier(\"status_bar_height\", \"dimen\", \"android\");\n    if (resourceId > 0) {\n        result = getResources().getDimensionPixelSize(resourceId);\n    }\n    return result;\n}\n```\n判断是否有虚拟按键：\n```\n/**\n * 是否有虚拟按键\n *\n * @return\n */\npublic static boolean checkDeviceHasNavigationBar(Context context) {\n    boolean hasNavigationBar = false;\n    Resources rs = context.getResources();\n    int id = rs.getIdentifier(\"config_showNavigationBar\", \"bool\", \"android\");\n    if (id > 0) {\n        hasNavigationBar = rs.getBoolean(id);\n    }\n    try {\n        Class systemPropertiesClass = Class.forName(\"android.os.SystemProperties\");\n        Method m = systemPropertiesClass.getMethod(\"get\", String.class);\n        String navBarOverride = (String) m.invoke(systemPropertiesClass, \"qemu.hw.mainkeys\");\n        if (\"1\".equals(navBarOverride)) {\n            hasNavigationBar = false;\n        } else if (\"0\".equals(navBarOverride)) {\n            hasNavigationBar = true;\n        }\n    } catch (Exception e) {\n\n    }\n    return hasNavigationBar;\n}\n```\n获取虚拟按键的高度：\n```\n/**\n * 获取虚拟按键的高度\n *\n * @return\n */\npublic int getNavigationBarHeight() {\n    Resources resources = context.getResources();\n    int resourceId = resources.getIdentifier(\"navigation_bar_height\", \"dimen\", \"android\");\n    if (resourceId > 0) {\n        return resources.getDimensionPixelSize(resourceId);\n    }\n    return 0;\n}\n```\n显示状态栏：\n```\nWindowManager.LayoutParams attr = getWindow().getAttributes();\nattr.flags &= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);\ngetWindow().setAttributes(attr);\ngetWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n```\n隐藏状态栏：\n```\nWindowManager.LayoutParams lp = getWindow().getAttributes();\n lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;\n getWindow().setAttributes(lp);\n getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n```\n关于隐藏状态栏以及虚拟按键的显示、隐藏，目前知道的只有通过``setSystemUiVisibility``方法结合flag来实现。\n隐藏虚拟按键：\n```\ngetWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_HIDE_NAVIGATION);\n```\n下面来做一个示例。\n\n## 示例\n前言中11种flag，真正用到的也就几种，下面结合示例来说。\n新建一个应用，将Activity设置为全屏，并且横屏（模拟直播、播放视频类似的环境）。\n先贴一下示例代码：\n```\npublic class MainActivity extends AppCompatActivity {\n\n    private boolean isShowing;\n    private TextView hello;\n    private Button dialog;\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n\n        dialog = (Button) findViewById(R.id.dialog_button);\n        hello = (TextView) findViewById(R.id.hello_world);\n        hello.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                if (isShowing) {\n                    hideOperation();\n                } else {\n                    showOperation();\n                }\n            }\n        });\n        dialog.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                AlertDialog.Builder builder = new AlertDialog.Builder(MainActivity.this);\n                builder.setMessage(\"Hello World!\");\n                builder.setTitle(\"Title\");\n                builder.create().show();\n                hideOperation();\n            }\n        });\n    }\n\n    private void showOperation() {\n        isShowing = true;\n        WindowManager.LayoutParams attr = getWindow().getAttributes();\n        attr.flags &= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);\n        getWindow().setAttributes(attr);\n        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n\n        getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n                | View.SYSTEM_UI_LAYOUT_FLAGS\n                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN);\n    }\n\n    private void hideOperation() {\n        isShowing = false;\n        int options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n                | View.SYSTEM_UI_LAYOUT_FLAGS\n                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\n                | View.SYSTEM_UI_FLAG_FULLSCREEN;\n\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\n            options |= View.SYSTEM_UI_FLAG_IMMERSIVE;\n        }\n        getWindow().getDecorView().setSystemUiVisibility(options);\n    }\n\n    @Override\n    public void onWindowFocusChanged(boolean hasFocus) {\n        super.onWindowFocusChanged(hasFocus);\n//        int options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n//                | View.SYSTEM_UI_LAYOUT_FLAGS\n//                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n//                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n//                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\n//                | View.SYSTEM_UI_FLAG_FULLSCREEN;\n//        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\n//            options |= View.SYSTEM_UI_FLAG_IMMERSIVE;\n//        }\n//        getWindow().getDecorView().setSystemUiVisibility(options);\n    }\n}\n```\n运行效果如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/system1.gif)\n\n1. 可以看到，在我点击依次\"Hello World\"之后，button往下移了一点点，同时状态栏也显示了。（初始的时候虚拟按键就已经显示）\n2. 再点击一下，进行隐藏操作，状态栏、虚拟按键同时消失。当点击中间的button弹出dialog时，虚拟按键与状态栏会同时出来。然后关掉dialog后要连着点2次，状态栏、虚拟按键才会消失。\n\n针对第一点，是初始的时候，虚拟按键在App布局之外，当执行``SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN（根据说明：按全屏模式来表现，尽管当前没有设置全屏模式）``之后，App布局占据手机整个显示框，所以会“变高”了些，button会下移。\n针对第二点，目前也不知道是什么原因导致必须点2次才会执行消失操作。姑且以为是虚拟按键抢占焦点，第一次的点击被它消费了，第二次才是我们App进行消费。另外，当弹出dialog时，我们也可以控制状态栏不显示，将hideOperation改为如下：\n```\nprivate void hideOperation() {\n    isShowing = false;\n    WindowManager.LayoutParams lp = getWindow().getAttributes();\n    lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;\n    getWindow().setAttributes(lp);\n    getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n\n    int options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n            | View.SYSTEM_UI_LAYOUT_FLAGS\n            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION;\n//              | View.SYSTEM_UI_FLAG_FULLSCREEN;\n\n    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\n        options |= View.SYSTEM_UI_FLAG_IMMERSIVE;\n    }\n    getWindow().getDecorView().setSystemUiVisibility(options);\n}\n```\n如此，当弹出dialog时，状态栏便不会显示了，但是``虚拟按键是一定会显示的``。可以认为：``SYSTEM_UI_FLAG_FULLSCREEN flag的意思就是全屏显示，在此flag下，不会显示状态栏。``\n\n至于点击2次才消失的解决方案，便是取消``onWindowFocusChanged``中的注释，如此，1、2中描述的问题都不会出现了。\n\n通过``SYSTEM_UI_FLAG_HIDE_NAVIGATION``来隐藏虚拟按键，会导致一个问题：界面有交互时虚拟按键会自动显示。要解决这个问题，便要用到``SYSTEM_UI_FLAG_IMMERSIVE``了，它的意思是``当虚拟按键隐藏时仍然保留交互``，可以理解为虚拟按键只是隐藏，但仍然还在，所以发生交互的时候便不会再自动显示了。\n\n## 总结\n1. SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN：按照全屏模式来显示，尽管当前没有设置为全屏模式，设置此flag便会抢占虚拟按键的空间，使应用真正的全屏，虚拟按键若要显示，则只是覆盖在应用的View上了。\n2. SYSTEM_UI_FLAG_FULLSCREEN：全屏显示，此模式下不会显示状态栏。\n3. SYSTEM_UI_FLAG_HIDE_NAVIGATION：隐藏虚拟按键。\n4. SYSTEM_UI_FLAG_IMMERSIVE：当虚拟按键隐藏时，仍然保留交互。解决隐藏后界面发生交互又自动显示的问题。\n5. SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION：按照隐藏虚拟按键模式显示，尽管当前没有设置为隐藏虚拟按键模式。针对示例中的第一点，将SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN改为此flag或者SYSTEM_UI_FLAG_HIDE_NAVIGATION都会使App充满显示框，导致button下移。\n\n大致就说这些了，还有一些flag没弄明白，后面继续努力，写得有点乱~\n\n[示例代码](https://github.com/LiJia92/MyStudyProject/tree/master/systemuistudy)\n","source":"_posts/system-ui.md","raw":"---\ntitle: Android状态栏、虚拟按键小记\ndate: 2016-09-20 16:05:23\ntags:\n - 日常开发\n---\n\n之前写过一篇[状态栏小记](http://lastwarmth.site/2016/08/04/statusbar/)，这里加入虚拟按键重新做一下总结。\n\n<!-- more -->\n\n## 前言\nAndroid 4.0之后，我们可以通过``setSystemUiVisibility(int)``方法，结合各种flag来设置系统组件（状态栏、虚拟按键）的显示或隐藏。那么有哪些Flag呢？Android官方文档有以下flag：\n1. View.SYSTEM_UI_FLAG_FULLSCREEN\n> View has requested to go into the normal fullscreen mode so that its content can take over the screen while still allowing the user to interact with the application.\n\n2. View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\n> View has requested that the system navigation be temporarily hidden.\n\n3. View.SYSTEM_UI_FLAG_IMMERSIVE\n> View would like to remain interactive when hiding the navigation bar with SYSTEM_UI_FLAG_HIDE_NAVIGATION.\n\n4. View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY\n> View would like to remain interactive when hiding the status bar with SYSTEM_UI_FLAG_FULLSCREEN and/or hiding the navigation bar with SYSTEM_UI_FLAG_HIDE_NAVIGATION.\n\n5. View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n> View would like its window to be laid out as if it has requested SYSTEM_UI_FLAG_FULLSCREEN, even if it currently hasn't.\n\n6. View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n> View would like its window to be laid out as if it has requested SYSTEM_UI_FLAG_HIDE_NAVIGATION, even if it currently hasn't.\n\n7. View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n> When using other layout flags, we would like a stable view of the content insets given to fitSystemWindows(Rect).\n\n8. SYSTEM_UI_FLAG_LIGHT_STATUS_BAR\n> Requests the status bar to draw in a mode that is compatible with light status bar backgrounds.\n\n9. View.SYSTEM_UI_FLAG_LOW_PROFILE\n> View has requested the system UI to enter an unobtrusive \"low profile\" mode.\n\n10. SYSTEM_UI_FLAG_VISIBLE\n> View has requested the system UI (status bar) to be visible (the default).\n\n11. SYSTEM_UI_LAYOUT_FLAGS\n> Flags that can impact the layout in relation to system UI.\n\n## 实用代码\n在做与状态栏、虚拟按键相关的工作时，有些代码亲测比较实用。\n获取状态栏高度：\n```\n/**\n * 获取状态栏高度\n *\n * @return\n */\npublic int getStatusBarHeight() {\n    int result = 0;\n    int resourceId = getResources().getIdentifier(\"status_bar_height\", \"dimen\", \"android\");\n    if (resourceId > 0) {\n        result = getResources().getDimensionPixelSize(resourceId);\n    }\n    return result;\n}\n```\n判断是否有虚拟按键：\n```\n/**\n * 是否有虚拟按键\n *\n * @return\n */\npublic static boolean checkDeviceHasNavigationBar(Context context) {\n    boolean hasNavigationBar = false;\n    Resources rs = context.getResources();\n    int id = rs.getIdentifier(\"config_showNavigationBar\", \"bool\", \"android\");\n    if (id > 0) {\n        hasNavigationBar = rs.getBoolean(id);\n    }\n    try {\n        Class systemPropertiesClass = Class.forName(\"android.os.SystemProperties\");\n        Method m = systemPropertiesClass.getMethod(\"get\", String.class);\n        String navBarOverride = (String) m.invoke(systemPropertiesClass, \"qemu.hw.mainkeys\");\n        if (\"1\".equals(navBarOverride)) {\n            hasNavigationBar = false;\n        } else if (\"0\".equals(navBarOverride)) {\n            hasNavigationBar = true;\n        }\n    } catch (Exception e) {\n\n    }\n    return hasNavigationBar;\n}\n```\n获取虚拟按键的高度：\n```\n/**\n * 获取虚拟按键的高度\n *\n * @return\n */\npublic int getNavigationBarHeight() {\n    Resources resources = context.getResources();\n    int resourceId = resources.getIdentifier(\"navigation_bar_height\", \"dimen\", \"android\");\n    if (resourceId > 0) {\n        return resources.getDimensionPixelSize(resourceId);\n    }\n    return 0;\n}\n```\n显示状态栏：\n```\nWindowManager.LayoutParams attr = getWindow().getAttributes();\nattr.flags &= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);\ngetWindow().setAttributes(attr);\ngetWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n```\n隐藏状态栏：\n```\nWindowManager.LayoutParams lp = getWindow().getAttributes();\n lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;\n getWindow().setAttributes(lp);\n getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n```\n关于隐藏状态栏以及虚拟按键的显示、隐藏，目前知道的只有通过``setSystemUiVisibility``方法结合flag来实现。\n隐藏虚拟按键：\n```\ngetWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_HIDE_NAVIGATION);\n```\n下面来做一个示例。\n\n## 示例\n前言中11种flag，真正用到的也就几种，下面结合示例来说。\n新建一个应用，将Activity设置为全屏，并且横屏（模拟直播、播放视频类似的环境）。\n先贴一下示例代码：\n```\npublic class MainActivity extends AppCompatActivity {\n\n    private boolean isShowing;\n    private TextView hello;\n    private Button dialog;\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n\n        dialog = (Button) findViewById(R.id.dialog_button);\n        hello = (TextView) findViewById(R.id.hello_world);\n        hello.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                if (isShowing) {\n                    hideOperation();\n                } else {\n                    showOperation();\n                }\n            }\n        });\n        dialog.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                AlertDialog.Builder builder = new AlertDialog.Builder(MainActivity.this);\n                builder.setMessage(\"Hello World!\");\n                builder.setTitle(\"Title\");\n                builder.create().show();\n                hideOperation();\n            }\n        });\n    }\n\n    private void showOperation() {\n        isShowing = true;\n        WindowManager.LayoutParams attr = getWindow().getAttributes();\n        attr.flags &= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);\n        getWindow().setAttributes(attr);\n        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n\n        getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n                | View.SYSTEM_UI_LAYOUT_FLAGS\n                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN);\n    }\n\n    private void hideOperation() {\n        isShowing = false;\n        int options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n                | View.SYSTEM_UI_LAYOUT_FLAGS\n                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\n                | View.SYSTEM_UI_FLAG_FULLSCREEN;\n\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\n            options |= View.SYSTEM_UI_FLAG_IMMERSIVE;\n        }\n        getWindow().getDecorView().setSystemUiVisibility(options);\n    }\n\n    @Override\n    public void onWindowFocusChanged(boolean hasFocus) {\n        super.onWindowFocusChanged(hasFocus);\n//        int options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n//                | View.SYSTEM_UI_LAYOUT_FLAGS\n//                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n//                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n//                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION\n//                | View.SYSTEM_UI_FLAG_FULLSCREEN;\n//        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\n//            options |= View.SYSTEM_UI_FLAG_IMMERSIVE;\n//        }\n//        getWindow().getDecorView().setSystemUiVisibility(options);\n    }\n}\n```\n运行效果如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/09/system1.gif)\n\n1. 可以看到，在我点击依次\"Hello World\"之后，button往下移了一点点，同时状态栏也显示了。（初始的时候虚拟按键就已经显示）\n2. 再点击一下，进行隐藏操作，状态栏、虚拟按键同时消失。当点击中间的button弹出dialog时，虚拟按键与状态栏会同时出来。然后关掉dialog后要连着点2次，状态栏、虚拟按键才会消失。\n\n针对第一点，是初始的时候，虚拟按键在App布局之外，当执行``SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN（根据说明：按全屏模式来表现，尽管当前没有设置全屏模式）``之后，App布局占据手机整个显示框，所以会“变高”了些，button会下移。\n针对第二点，目前也不知道是什么原因导致必须点2次才会执行消失操作。姑且以为是虚拟按键抢占焦点，第一次的点击被它消费了，第二次才是我们App进行消费。另外，当弹出dialog时，我们也可以控制状态栏不显示，将hideOperation改为如下：\n```\nprivate void hideOperation() {\n    isShowing = false;\n    WindowManager.LayoutParams lp = getWindow().getAttributes();\n    lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;\n    getWindow().setAttributes(lp);\n    getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);\n\n    int options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE\n            | View.SYSTEM_UI_LAYOUT_FLAGS\n            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN\n            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION\n            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION;\n//              | View.SYSTEM_UI_FLAG_FULLSCREEN;\n\n    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\n        options |= View.SYSTEM_UI_FLAG_IMMERSIVE;\n    }\n    getWindow().getDecorView().setSystemUiVisibility(options);\n}\n```\n如此，当弹出dialog时，状态栏便不会显示了，但是``虚拟按键是一定会显示的``。可以认为：``SYSTEM_UI_FLAG_FULLSCREEN flag的意思就是全屏显示，在此flag下，不会显示状态栏。``\n\n至于点击2次才消失的解决方案，便是取消``onWindowFocusChanged``中的注释，如此，1、2中描述的问题都不会出现了。\n\n通过``SYSTEM_UI_FLAG_HIDE_NAVIGATION``来隐藏虚拟按键，会导致一个问题：界面有交互时虚拟按键会自动显示。要解决这个问题，便要用到``SYSTEM_UI_FLAG_IMMERSIVE``了，它的意思是``当虚拟按键隐藏时仍然保留交互``，可以理解为虚拟按键只是隐藏，但仍然还在，所以发生交互的时候便不会再自动显示了。\n\n## 总结\n1. SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN：按照全屏模式来显示，尽管当前没有设置为全屏模式，设置此flag便会抢占虚拟按键的空间，使应用真正的全屏，虚拟按键若要显示，则只是覆盖在应用的View上了。\n2. SYSTEM_UI_FLAG_FULLSCREEN：全屏显示，此模式下不会显示状态栏。\n3. SYSTEM_UI_FLAG_HIDE_NAVIGATION：隐藏虚拟按键。\n4. SYSTEM_UI_FLAG_IMMERSIVE：当虚拟按键隐藏时，仍然保留交互。解决隐藏后界面发生交互又自动显示的问题。\n5. SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION：按照隐藏虚拟按键模式显示，尽管当前没有设置为隐藏虚拟按键模式。针对示例中的第一点，将SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN改为此flag或者SYSTEM_UI_FLAG_HIDE_NAVIGATION都会使App充满显示框，导致button下移。\n\n大致就说这些了，还有一些flag没弄明白，后面继续努力，写得有点乱~\n\n[示例代码](https://github.com/LiJia92/MyStudyProject/tree/master/systemuistudy)\n","slug":"system-ui","published":1,"updated":"2016-11-21T10:03:36.225Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75ad00311cb8jgnqe3s6","content":"<p>之前写过一篇<a href=\"http://lastwarmth.site/2016/08/04/statusbar/\" target=\"_blank\" rel=\"external\">状态栏小记</a>，这里加入虚拟按键重新做一下总结。</p>\n<a id=\"more\"></a>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Android 4.0之后，我们可以通过<code>setSystemUiVisibility(int)</code>方法，结合各种flag来设置系统组件（状态栏、虚拟按键）的显示或隐藏。那么有哪些Flag呢？Android官方文档有以下flag：</p>\n<ol>\n<li><p>View.SYSTEM_UI_FLAG_FULLSCREEN</p>\n<blockquote>\n<p>View has requested to go into the normal fullscreen mode so that its content can take over the screen while still allowing the user to interact with the application.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</p>\n<blockquote>\n<p>View has requested that the system navigation be temporarily hidden.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_IMMERSIVE</p>\n<blockquote>\n<p>View would like to remain interactive when hiding the navigation bar with SYSTEM_UI_FLAG_HIDE_NAVIGATION.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY</p>\n<blockquote>\n<p>View would like to remain interactive when hiding the status bar with SYSTEM_UI_FLAG_FULLSCREEN and/or hiding the navigation bar with SYSTEM_UI_FLAG_HIDE_NAVIGATION.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</p>\n<blockquote>\n<p>View would like its window to be laid out as if it has requested SYSTEM_UI_FLAG_FULLSCREEN, even if it currently hasn’t.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</p>\n<blockquote>\n<p>View would like its window to be laid out as if it has requested SYSTEM_UI_FLAG_HIDE_NAVIGATION, even if it currently hasn’t.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_LAYOUT_STABLE</p>\n<blockquote>\n<p>When using other layout flags, we would like a stable view of the content insets given to fitSystemWindows(Rect).</p>\n</blockquote>\n</li>\n<li><p>SYSTEM_UI_FLAG_LIGHT_STATUS_BAR</p>\n<blockquote>\n<p>Requests the status bar to draw in a mode that is compatible with light status bar backgrounds.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_LOW_PROFILE</p>\n<blockquote>\n<p>View has requested the system UI to enter an unobtrusive “low profile” mode.</p>\n</blockquote>\n</li>\n<li><p>SYSTEM_UI_FLAG_VISIBLE</p>\n<blockquote>\n<p>View has requested the system UI (status bar) to be visible (the default).</p>\n</blockquote>\n</li>\n<li><p>SYSTEM_UI_LAYOUT_FLAGS</p>\n<blockquote>\n<p>Flags that can impact the layout in relation to system UI.</p>\n</blockquote>\n</li>\n</ol>\n<h2 id=\"实用代码\"><a href=\"#实用代码\" class=\"headerlink\" title=\"实用代码\"></a>实用代码</h2><p>在做与状态栏、虚拟按键相关的工作时，有些代码亲测比较实用。<br>获取状态栏高度：<br><figure class=\"highlight nimrod\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">/**</div><div class=\"line\"> * 获取状态栏高度</div><div class=\"line\"> *</div><div class=\"line\"> * @<span class=\"keyword\">return</span></div><div class=\"line\"> */</div><div class=\"line\">public <span class=\"built_in\">int</span> getStatusBarHeight() &#123;</div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"literal\">result</span> = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"built_in\">int</span> resourceId = getResources().getIdentifier(<span class=\"string\">\"status_bar_height\"</span>, <span class=\"string\">\"dimen\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (resourceId &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        <span class=\"literal\">result</span> = getResources().getDimensionPixelSize(resourceId);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">result</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>判断是否有虚拟按键：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 是否有虚拟按键</div><div class=\"line\"> *</div><div class=\"line\"> * @return</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> checkDeviceHasNavigationBar(Context context) &#123;</div><div class=\"line\">    <span class=\"keyword\">boolean</span> hasNavigationBar = <span class=\"keyword\">false</span>;</div><div class=\"line\">    Resources rs = context.getResources();</div><div class=\"line\">    <span class=\"keyword\">int</span> id = rs.getIdentifier(<span class=\"string\">\"config_showNavigationBar\"</span>, <span class=\"string\">\"bool\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (id &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        hasNavigationBar = rs.getBoolean(id);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">Class</span> systemPropertiesClass = <span class=\"keyword\">Class</span>.forName(<span class=\"string\">\"android.os.SystemProperties\"</span>);</div><div class=\"line\">        Method m = systemPropertiesClass.getMethod(<span class=\"string\">\"get\"</span>, String.<span class=\"keyword\">class</span>);</div><div class=\"line\">        String navBarOverride = (String) m.invoke(systemPropertiesClass, <span class=\"string\">\"qemu.hw.mainkeys\"</span>);</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"string\">\"1\"</span>.equals(navBarOverride)) &#123;</div><div class=\"line\">            hasNavigationBar = <span class=\"keyword\">false</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"string\">\"0\"</span>.equals(navBarOverride)) &#123;</div><div class=\"line\">            hasNavigationBar = <span class=\"keyword\">true</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> hasNavigationBar;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>获取虚拟按键的高度：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 获取虚拟按键的高度</div><div class=\"line\"> *</div><div class=\"line\"> * <span class=\"doctag\">@return</span></div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getNavigationBarHeight</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    Resources resources = context.getResources();</div><div class=\"line\">    <span class=\"keyword\">int</span> resourceId = resources.getIdentifier(<span class=\"string\">\"navigation_bar_height\"</span>, <span class=\"string\">\"dimen\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (resourceId &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> resources.<span class=\"title\">getDimensionPixelSize</span><span class=\"params\">(resourceId)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>显示状态栏：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">WindowManager.LayoutParams attr = getWindow().getAttributes()<span class=\"comment\">;</span></div><div class=\"line\">attr.flags &amp;= (~WindowManager.LayoutParams.FLAG_FULLSCREEN)<span class=\"comment\">;</span></div><div class=\"line\">getWindow().setAttributes(attr)<span class=\"comment\">;</span></div><div class=\"line\">getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>隐藏状态栏：<br><figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">WindowManager.LayoutParams lp = getWindow().getAttributes();</div><div class=\"line\"> lp.<span class=\"keyword\">flags</span> |= WindowManager.LayoutParams.FLAG_FULLSCREEN;</div><div class=\"line\"> getWindow().<span class=\"built_in\">set</span>Attributes(lp);</div><div class=\"line\"> getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div></pre></td></tr></table></figure></p>\n<p>关于隐藏状态栏以及虚拟按键的显示、隐藏，目前知道的只有通过<code>setSystemUiVisibility</code>方法结合flag来实现。<br>隐藏虚拟按键：<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">getWindow</span>()<span class=\"selector-class\">.getDecorView</span>()<span class=\"selector-class\">.setSystemUiVisibility</span>(<span class=\"selector-tag\">View</span><span class=\"selector-class\">.SYSTEM_UI_FLAG_HIDE_NAVIGATION</span>);</div></pre></td></tr></table></figure></p>\n<p>下面来做一个示例。</p>\n<h2 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h2><p>前言中11种flag，真正用到的也就几种，下面结合示例来说。<br>新建一个应用，将Activity设置为全屏，并且横屏（模拟直播、播放视频类似的环境）。<br>先贴一下示例代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isShowing;</div><div class=\"line\">    <span class=\"keyword\">private</span> TextView hello;</div><div class=\"line\">    <span class=\"keyword\">private</span> Button dialog;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(R.layout.activity_main);</div><div class=\"line\"></div><div class=\"line\">        dialog = (Button) findViewById(R.id.dialog_button);</div><div class=\"line\">        hello = (TextView) findViewById(R.id.hello_world);</div><div class=\"line\">        hello.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (isShowing) &#123;</div><div class=\"line\">                    hideOperation();</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    showOperation();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">        dialog.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                AlertDialog.Builder builder = <span class=\"keyword\">new</span> AlertDialog.Builder(MainActivity.<span class=\"keyword\">this</span>);</div><div class=\"line\">                builder.setMessage(<span class=\"string\">\"Hello World!\"</span>);</div><div class=\"line\">                builder.setTitle(<span class=\"string\">\"Title\"</span>);</div><div class=\"line\">                builder.create().show();</div><div class=\"line\">                hideOperation();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">showOperation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        isShowing = <span class=\"keyword\">true</span>;</div><div class=\"line\">        WindowManager.LayoutParams attr = getWindow().getAttributes();</div><div class=\"line\">        attr.flags &amp;= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);</div><div class=\"line\">        getWindow().setAttributes(attr);</div><div class=\"line\">        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div><div class=\"line\"></div><div class=\"line\">        getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">                | View.SYSTEM_UI_LAYOUT_FLAGS</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">hideOperation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        isShowing = <span class=\"keyword\">false</span>;</div><div class=\"line\">        <span class=\"keyword\">int</span> options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">                | View.SYSTEM_UI_LAYOUT_FLAGS</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_FULLSCREEN;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</div><div class=\"line\">            options |= View.SYSTEM_UI_FLAG_IMMERSIVE;</div><div class=\"line\">        &#125;</div><div class=\"line\">        getWindow().getDecorView().setSystemUiVisibility(options);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onWindowFocusChanged</span><span class=\"params\">(<span class=\"keyword\">boolean</span> hasFocus)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onWindowFocusChanged(hasFocus);</div><div class=\"line\"><span class=\"comment\">//        int options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_LAYOUT_FLAGS</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_FLAG_FULLSCREEN;</span></div><div class=\"line\"><span class=\"comment\">//        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span></div><div class=\"line\"><span class=\"comment\">//            options |= View.SYSTEM_UI_FLAG_IMMERSIVE;</span></div><div class=\"line\"><span class=\"comment\">//        &#125;</span></div><div class=\"line\"><span class=\"comment\">//        getWindow().getDecorView().setSystemUiVisibility(options);</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>运行效果如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/system1.gif\" alt=\"\"></p>\n<ol>\n<li>可以看到，在我点击依次”Hello World”之后，button往下移了一点点，同时状态栏也显示了。（初始的时候虚拟按键就已经显示）</li>\n<li>再点击一下，进行隐藏操作，状态栏、虚拟按键同时消失。当点击中间的button弹出dialog时，虚拟按键与状态栏会同时出来。然后关掉dialog后要连着点2次，状态栏、虚拟按键才会消失。</li>\n</ol>\n<p>针对第一点，是初始的时候，虚拟按键在App布局之外，当执行<code>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN（根据说明：按全屏模式来表现，尽管当前没有设置全屏模式）</code>之后，App布局占据手机整个显示框，所以会“变高”了些，button会下移。<br>针对第二点，目前也不知道是什么原因导致必须点2次才会执行消失操作。姑且以为是虚拟按键抢占焦点，第一次的点击被它消费了，第二次才是我们App进行消费。另外，当弹出dialog时，我们也可以控制状态栏不显示，将hideOperation改为如下：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> hideOperation() &#123;</div><div class=\"line\">    isShowing = <span class=\"keyword\">false</span>;</div><div class=\"line\">    WindowManager.LayoutParams lp = getWindow().getAttributes();</div><div class=\"line\">    lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;</div><div class=\"line\">    getWindow().setAttributes(lp);</div><div class=\"line\">    getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">int</span> <span class=\"keyword\">options</span> = View.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">            | View.SYSTEM_UI_LAYOUT_FLAGS</div><div class=\"line\">            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class=\"line\">            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</div><div class=\"line\">            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION;</div><div class=\"line\"><span class=\"comment\">//              | View.SYSTEM_UI_FLAG_FULLSCREEN;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</div><div class=\"line\">        <span class=\"keyword\">options</span> |= View.SYSTEM_UI_FLAG_IMMERSIVE;</div><div class=\"line\">    &#125;</div><div class=\"line\">    getWindow().getDecorView().setSystemUiVisibility(<span class=\"keyword\">options</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>如此，当弹出dialog时，状态栏便不会显示了，但是<code>虚拟按键是一定会显示的</code>。可以认为：<code>SYSTEM_UI_FLAG_FULLSCREEN flag的意思就是全屏显示，在此flag下，不会显示状态栏。</code></p>\n<p>至于点击2次才消失的解决方案，便是取消<code>onWindowFocusChanged</code>中的注释，如此，1、2中描述的问题都不会出现了。</p>\n<p>通过<code>SYSTEM_UI_FLAG_HIDE_NAVIGATION</code>来隐藏虚拟按键，会导致一个问题：界面有交互时虚拟按键会自动显示。要解决这个问题，便要用到<code>SYSTEM_UI_FLAG_IMMERSIVE</code>了，它的意思是<code>当虚拟按键隐藏时仍然保留交互</code>，可以理解为虚拟按键只是隐藏，但仍然还在，所以发生交互的时候便不会再自动显示了。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN：按照全屏模式来显示，尽管当前没有设置为全屏模式，设置此flag便会抢占虚拟按键的空间，使应用真正的全屏，虚拟按键若要显示，则只是覆盖在应用的View上了。</li>\n<li>SYSTEM_UI_FLAG_FULLSCREEN：全屏显示，此模式下不会显示状态栏。</li>\n<li>SYSTEM_UI_FLAG_HIDE_NAVIGATION：隐藏虚拟按键。</li>\n<li>SYSTEM_UI_FLAG_IMMERSIVE：当虚拟按键隐藏时，仍然保留交互。解决隐藏后界面发生交互又自动显示的问题。</li>\n<li>SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION：按照隐藏虚拟按键模式显示，尽管当前没有设置为隐藏虚拟按键模式。针对示例中的第一点，将SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN改为此flag或者SYSTEM_UI_FLAG_HIDE_NAVIGATION都会使App充满显示框，导致button下移。</li>\n</ol>\n<p>大致就说这些了，还有一些flag没弄明白，后面继续努力，写得有点乱~</p>\n<p><a href=\"https://github.com/LiJia92/MyStudyProject/tree/master/systemuistudy\" target=\"_blank\" rel=\"external\">示例代码</a></p>\n","excerpt":"<p>之前写过一篇<a href=\"http://lastwarmth.site/2016/08/04/statusbar/\">状态栏小记</a>，这里加入虚拟按键重新做一下总结。</p>","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Android 4.0之后，我们可以通过<code>setSystemUiVisibility(int)</code>方法，结合各种flag来设置系统组件（状态栏、虚拟按键）的显示或隐藏。那么有哪些Flag呢？Android官方文档有以下flag：</p>\n<ol>\n<li><p>View.SYSTEM_UI_FLAG_FULLSCREEN</p>\n<blockquote>\n<p>View has requested to go into the normal fullscreen mode so that its content can take over the screen while still allowing the user to interact with the application.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</p>\n<blockquote>\n<p>View has requested that the system navigation be temporarily hidden.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_IMMERSIVE</p>\n<blockquote>\n<p>View would like to remain interactive when hiding the navigation bar with SYSTEM_UI_FLAG_HIDE_NAVIGATION.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY</p>\n<blockquote>\n<p>View would like to remain interactive when hiding the status bar with SYSTEM_UI_FLAG_FULLSCREEN and/or hiding the navigation bar with SYSTEM_UI_FLAG_HIDE_NAVIGATION.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</p>\n<blockquote>\n<p>View would like its window to be laid out as if it has requested SYSTEM_UI_FLAG_FULLSCREEN, even if it currently hasn’t.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</p>\n<blockquote>\n<p>View would like its window to be laid out as if it has requested SYSTEM_UI_FLAG_HIDE_NAVIGATION, even if it currently hasn’t.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_LAYOUT_STABLE</p>\n<blockquote>\n<p>When using other layout flags, we would like a stable view of the content insets given to fitSystemWindows(Rect).</p>\n</blockquote>\n</li>\n<li><p>SYSTEM_UI_FLAG_LIGHT_STATUS_BAR</p>\n<blockquote>\n<p>Requests the status bar to draw in a mode that is compatible with light status bar backgrounds.</p>\n</blockquote>\n</li>\n<li><p>View.SYSTEM_UI_FLAG_LOW_PROFILE</p>\n<blockquote>\n<p>View has requested the system UI to enter an unobtrusive “low profile” mode.</p>\n</blockquote>\n</li>\n<li><p>SYSTEM_UI_FLAG_VISIBLE</p>\n<blockquote>\n<p>View has requested the system UI (status bar) to be visible (the default).</p>\n</blockquote>\n</li>\n<li><p>SYSTEM_UI_LAYOUT_FLAGS</p>\n<blockquote>\n<p>Flags that can impact the layout in relation to system UI.</p>\n</blockquote>\n</li>\n</ol>\n<h2 id=\"实用代码\"><a href=\"#实用代码\" class=\"headerlink\" title=\"实用代码\"></a>实用代码</h2><p>在做与状态栏、虚拟按键相关的工作时，有些代码亲测比较实用。<br>获取状态栏高度：<br><figure class=\"highlight nimrod\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">/**</div><div class=\"line\"> * 获取状态栏高度</div><div class=\"line\"> *</div><div class=\"line\"> * @<span class=\"keyword\">return</span></div><div class=\"line\"> */</div><div class=\"line\">public <span class=\"built_in\">int</span> getStatusBarHeight() &#123;</div><div class=\"line\">    <span class=\"built_in\">int</span> <span class=\"literal\">result</span> = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"built_in\">int</span> resourceId = getResources().getIdentifier(<span class=\"string\">\"status_bar_height\"</span>, <span class=\"string\">\"dimen\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (resourceId &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        <span class=\"literal\">result</span> = getResources().getDimensionPixelSize(resourceId);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">result</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>判断是否有虚拟按键：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 是否有虚拟按键</div><div class=\"line\"> *</div><div class=\"line\"> * @return</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">boolean</span> checkDeviceHasNavigationBar(Context context) &#123;</div><div class=\"line\">    <span class=\"keyword\">boolean</span> hasNavigationBar = <span class=\"keyword\">false</span>;</div><div class=\"line\">    Resources rs = context.getResources();</div><div class=\"line\">    <span class=\"keyword\">int</span> id = rs.getIdentifier(<span class=\"string\">\"config_showNavigationBar\"</span>, <span class=\"string\">\"bool\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (id &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        hasNavigationBar = rs.getBoolean(id);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">Class</span> systemPropertiesClass = <span class=\"keyword\">Class</span>.forName(<span class=\"string\">\"android.os.SystemProperties\"</span>);</div><div class=\"line\">        Method m = systemPropertiesClass.getMethod(<span class=\"string\">\"get\"</span>, String.<span class=\"keyword\">class</span>);</div><div class=\"line\">        String navBarOverride = (String) m.invoke(systemPropertiesClass, <span class=\"string\">\"qemu.hw.mainkeys\"</span>);</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"string\">\"1\"</span>.equals(navBarOverride)) &#123;</div><div class=\"line\">            hasNavigationBar = <span class=\"keyword\">false</span>;</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"string\">\"0\"</span>.equals(navBarOverride)) &#123;</div><div class=\"line\">            hasNavigationBar = <span class=\"keyword\">true</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> hasNavigationBar;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>获取虚拟按键的高度：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 获取虚拟按键的高度</div><div class=\"line\"> *</div><div class=\"line\"> * <span class=\"doctag\">@return</span></div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getNavigationBarHeight</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    Resources resources = context.getResources();</div><div class=\"line\">    <span class=\"keyword\">int</span> resourceId = resources.getIdentifier(<span class=\"string\">\"navigation_bar_height\"</span>, <span class=\"string\">\"dimen\"</span>, <span class=\"string\">\"android\"</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (resourceId &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> resources.<span class=\"title\">getDimensionPixelSize</span><span class=\"params\">(resourceId)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>显示状态栏：<br><figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">WindowManager.LayoutParams attr = getWindow().getAttributes()<span class=\"comment\">;</span></div><div class=\"line\">attr.flags &amp;= (~WindowManager.LayoutParams.FLAG_FULLSCREEN)<span class=\"comment\">;</span></div><div class=\"line\">getWindow().setAttributes(attr)<span class=\"comment\">;</span></div><div class=\"line\">getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS)<span class=\"comment\">;</span></div></pre></td></tr></table></figure></p>\n<p>隐藏状态栏：<br><figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">WindowManager.LayoutParams lp = getWindow().getAttributes();</div><div class=\"line\"> lp.<span class=\"keyword\">flags</span> |= WindowManager.LayoutParams.FLAG_FULLSCREEN;</div><div class=\"line\"> getWindow().<span class=\"built_in\">set</span>Attributes(lp);</div><div class=\"line\"> getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div></pre></td></tr></table></figure></p>\n<p>关于隐藏状态栏以及虚拟按键的显示、隐藏，目前知道的只有通过<code>setSystemUiVisibility</code>方法结合flag来实现。<br>隐藏虚拟按键：<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">getWindow</span>()<span class=\"selector-class\">.getDecorView</span>()<span class=\"selector-class\">.setSystemUiVisibility</span>(<span class=\"selector-tag\">View</span><span class=\"selector-class\">.SYSTEM_UI_FLAG_HIDE_NAVIGATION</span>);</div></pre></td></tr></table></figure></p>\n<p>下面来做一个示例。</p>\n<h2 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h2><p>前言中11种flag，真正用到的也就几种，下面结合示例来说。<br>新建一个应用，将Activity设置为全屏，并且横屏（模拟直播、播放视频类似的环境）。<br>先贴一下示例代码：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> isShowing;</div><div class=\"line\">    <span class=\"keyword\">private</span> TextView hello;</div><div class=\"line\">    <span class=\"keyword\">private</span> Button dialog;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(R.layout.activity_main);</div><div class=\"line\"></div><div class=\"line\">        dialog = (Button) findViewById(R.id.dialog_button);</div><div class=\"line\">        hello = (TextView) findViewById(R.id.hello_world);</div><div class=\"line\">        hello.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (isShowing) &#123;</div><div class=\"line\">                    hideOperation();</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    showOperation();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">        dialog.setOnClickListener(<span class=\"keyword\">new</span> View.OnClickListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClick</span><span class=\"params\">(View v)</span> </span>&#123;</div><div class=\"line\">                AlertDialog.Builder builder = <span class=\"keyword\">new</span> AlertDialog.Builder(MainActivity.<span class=\"keyword\">this</span>);</div><div class=\"line\">                builder.setMessage(<span class=\"string\">\"Hello World!\"</span>);</div><div class=\"line\">                builder.setTitle(<span class=\"string\">\"Title\"</span>);</div><div class=\"line\">                builder.create().show();</div><div class=\"line\">                hideOperation();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">showOperation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        isShowing = <span class=\"keyword\">true</span>;</div><div class=\"line\">        WindowManager.LayoutParams attr = getWindow().getAttributes();</div><div class=\"line\">        attr.flags &amp;= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);</div><div class=\"line\">        getWindow().setAttributes(attr);</div><div class=\"line\">        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div><div class=\"line\"></div><div class=\"line\">        getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">                | View.SYSTEM_UI_LAYOUT_FLAGS</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">hideOperation</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        isShowing = <span class=\"keyword\">false</span>;</div><div class=\"line\">        <span class=\"keyword\">int</span> options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">                | View.SYSTEM_UI_LAYOUT_FLAGS</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</div><div class=\"line\">                | View.SYSTEM_UI_FLAG_FULLSCREEN;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</div><div class=\"line\">            options |= View.SYSTEM_UI_FLAG_IMMERSIVE;</div><div class=\"line\">        &#125;</div><div class=\"line\">        getWindow().getDecorView().setSystemUiVisibility(options);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onWindowFocusChanged</span><span class=\"params\">(<span class=\"keyword\">boolean</span> hasFocus)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onWindowFocusChanged(hasFocus);</div><div class=\"line\"><span class=\"comment\">//        int options = View.SYSTEM_UI_FLAG_LAYOUT_STABLE</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_LAYOUT_FLAGS</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</span></div><div class=\"line\"><span class=\"comment\">//                | View.SYSTEM_UI_FLAG_FULLSCREEN;</span></div><div class=\"line\"><span class=\"comment\">//        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span></div><div class=\"line\"><span class=\"comment\">//            options |= View.SYSTEM_UI_FLAG_IMMERSIVE;</span></div><div class=\"line\"><span class=\"comment\">//        &#125;</span></div><div class=\"line\"><span class=\"comment\">//        getWindow().getDecorView().setSystemUiVisibility(options);</span></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>运行效果如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/09/system1.gif\" alt=\"\"></p>\n<ol>\n<li>可以看到，在我点击依次”Hello World”之后，button往下移了一点点，同时状态栏也显示了。（初始的时候虚拟按键就已经显示）</li>\n<li>再点击一下，进行隐藏操作，状态栏、虚拟按键同时消失。当点击中间的button弹出dialog时，虚拟按键与状态栏会同时出来。然后关掉dialog后要连着点2次，状态栏、虚拟按键才会消失。</li>\n</ol>\n<p>针对第一点，是初始的时候，虚拟按键在App布局之外，当执行<code>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN（根据说明：按全屏模式来表现，尽管当前没有设置全屏模式）</code>之后，App布局占据手机整个显示框，所以会“变高”了些，button会下移。<br>针对第二点，目前也不知道是什么原因导致必须点2次才会执行消失操作。姑且以为是虚拟按键抢占焦点，第一次的点击被它消费了，第二次才是我们App进行消费。另外，当弹出dialog时，我们也可以控制状态栏不显示，将hideOperation改为如下：<br><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> hideOperation() &#123;</div><div class=\"line\">    isShowing = <span class=\"keyword\">false</span>;</div><div class=\"line\">    WindowManager.LayoutParams lp = getWindow().getAttributes();</div><div class=\"line\">    lp.flags |= WindowManager.LayoutParams.FLAG_FULLSCREEN;</div><div class=\"line\">    getWindow().setAttributes(lp);</div><div class=\"line\">    getWindow().addFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">int</span> <span class=\"keyword\">options</span> = View.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class=\"line\">            | View.SYSTEM_UI_LAYOUT_FLAGS</div><div class=\"line\">            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class=\"line\">            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</div><div class=\"line\">            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION;</div><div class=\"line\"><span class=\"comment\">//              | View.SYSTEM_UI_FLAG_FULLSCREEN;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</div><div class=\"line\">        <span class=\"keyword\">options</span> |= View.SYSTEM_UI_FLAG_IMMERSIVE;</div><div class=\"line\">    &#125;</div><div class=\"line\">    getWindow().getDecorView().setSystemUiVisibility(<span class=\"keyword\">options</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>如此，当弹出dialog时，状态栏便不会显示了，但是<code>虚拟按键是一定会显示的</code>。可以认为：<code>SYSTEM_UI_FLAG_FULLSCREEN flag的意思就是全屏显示，在此flag下，不会显示状态栏。</code></p>\n<p>至于点击2次才消失的解决方案，便是取消<code>onWindowFocusChanged</code>中的注释，如此，1、2中描述的问题都不会出现了。</p>\n<p>通过<code>SYSTEM_UI_FLAG_HIDE_NAVIGATION</code>来隐藏虚拟按键，会导致一个问题：界面有交互时虚拟按键会自动显示。要解决这个问题，便要用到<code>SYSTEM_UI_FLAG_IMMERSIVE</code>了，它的意思是<code>当虚拟按键隐藏时仍然保留交互</code>，可以理解为虚拟按键只是隐藏，但仍然还在，所以发生交互的时候便不会再自动显示了。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN：按照全屏模式来显示，尽管当前没有设置为全屏模式，设置此flag便会抢占虚拟按键的空间，使应用真正的全屏，虚拟按键若要显示，则只是覆盖在应用的View上了。</li>\n<li>SYSTEM_UI_FLAG_FULLSCREEN：全屏显示，此模式下不会显示状态栏。</li>\n<li>SYSTEM_UI_FLAG_HIDE_NAVIGATION：隐藏虚拟按键。</li>\n<li>SYSTEM_UI_FLAG_IMMERSIVE：当虚拟按键隐藏时，仍然保留交互。解决隐藏后界面发生交互又自动显示的问题。</li>\n<li>SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION：按照隐藏虚拟按键模式显示，尽管当前没有设置为隐藏虚拟按键模式。针对示例中的第一点，将SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN改为此flag或者SYSTEM_UI_FLAG_HIDE_NAVIGATION都会使App充满显示框，导致button下移。</li>\n</ol>\n<p>大致就说这些了，还有一些flag没弄明白，后面继续努力，写得有点乱~</p>\n<p><a href=\"https://github.com/LiJia92/MyStudyProject/tree/master/systemuistudy\">示例代码</a></p>"},{"title":"TextView使用小记","date":"2016-07-26T02:46:16.000Z","_content":"\n相信TextView是Android最常见的控件了，在日常使用中也有一些“心得”，这里记录一下。\n\n## 格式化\n有些时候需要在一个TextView上显示不同字体格式的内容，比如说一段黑色，一段灰色的内容，又或者字体一大一小的内容，要实现这样的效果有2种方式：\n1. 使用SpannableString\n```\nSpannableString spanString = new SpannableString(\"Hello world!\");\nForegroundColorSpan span = new ForegroundColorSpan(getResources().getColor(R.color.black));\nspanString.setSpan(span, 0, 5, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);\n```\n2. 使用Html format\n```\nString text = \"<font color='black'>Hello:</font>\" + \"world!\";\ncontent.setText(Html.fromHtml(text), TextView.BufferType.SPANNABLE);\n```\n\n两种方式都是可以的，但是第2种方式会导致TextView设置``maxLines=\"3\"、ellipsize=\"end\"``的情况下，文本超过3行的时候不显示``...``提示符了。所以在有``...``的需求的时候建议还是使用第一种。\n\n<!-- more -->\n\n## 字的行间距\n如果内容过多是会换行的，要设置行间距可以如下设置：\n1. android:lineSpacingExtra\n设置行间距，如\"3dp\"。\n2. android:lineSpacingMultiplier\n设置行间距的倍数，如\"1.2\"。\n\n## 占位符\n有些时候一段字符大部分是固定的，只有一两位是变化的，那么可以在strings.xml中进行如下配置：\n```\n<string name=\"barrage_reward\">%1$s打赏了主播的专辑</string>\n<string name=\"living_view_count\">%1$d人观看</string>\n```\n1%代表第一个占位符，$s代表字符占位，$d代表数字占位。\n然后在设置的时候，用真实的数据替换掉占位符即可。\n```\ntextView.setText(getResources().getString(R.string.barrage_reward, \"Jay\"));\ntextView.setText(getResources().getString(R.string.living_view_count, 10));\n```\n\n## FontMetrics\nFontMetrics意为字体测量。\n```\npublic static class FontMetrics {\n        /**\n         * The maximum distance above the baseline for the tallest glyph in\n         * the font at a given text size.\n         */\n        public float   top;\n        /**\n         * The recommended distance above the baseline for singled spaced text.\n         */\n        public float   ascent;\n        /**\n         * The recommended distance below the baseline for singled spaced text.\n         */\n        public float   descent;\n        /**\n         * The maximum distance below the baseline for the lowest glyph in\n         * the font at a given text size.\n         */\n        public float   bottom;\n        /**\n         * The recommended additional space to add between lines of text.\n         */\n        public float   leading;\n    }\n```\n这五个属性分别是什么呢？看如下的图便能一目了然了：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/07/textview1.png)\n","source":"_posts/textview.md","raw":"---\ntitle: TextView使用小记\ndate: 2016-07-26 10:46:16\ntags:\n - 日常开发\n---\n\n相信TextView是Android最常见的控件了，在日常使用中也有一些“心得”，这里记录一下。\n\n## 格式化\n有些时候需要在一个TextView上显示不同字体格式的内容，比如说一段黑色，一段灰色的内容，又或者字体一大一小的内容，要实现这样的效果有2种方式：\n1. 使用SpannableString\n```\nSpannableString spanString = new SpannableString(\"Hello world!\");\nForegroundColorSpan span = new ForegroundColorSpan(getResources().getColor(R.color.black));\nspanString.setSpan(span, 0, 5, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);\n```\n2. 使用Html format\n```\nString text = \"<font color='black'>Hello:</font>\" + \"world!\";\ncontent.setText(Html.fromHtml(text), TextView.BufferType.SPANNABLE);\n```\n\n两种方式都是可以的，但是第2种方式会导致TextView设置``maxLines=\"3\"、ellipsize=\"end\"``的情况下，文本超过3行的时候不显示``...``提示符了。所以在有``...``的需求的时候建议还是使用第一种。\n\n<!-- more -->\n\n## 字的行间距\n如果内容过多是会换行的，要设置行间距可以如下设置：\n1. android:lineSpacingExtra\n设置行间距，如\"3dp\"。\n2. android:lineSpacingMultiplier\n设置行间距的倍数，如\"1.2\"。\n\n## 占位符\n有些时候一段字符大部分是固定的，只有一两位是变化的，那么可以在strings.xml中进行如下配置：\n```\n<string name=\"barrage_reward\">%1$s打赏了主播的专辑</string>\n<string name=\"living_view_count\">%1$d人观看</string>\n```\n1%代表第一个占位符，$s代表字符占位，$d代表数字占位。\n然后在设置的时候，用真实的数据替换掉占位符即可。\n```\ntextView.setText(getResources().getString(R.string.barrage_reward, \"Jay\"));\ntextView.setText(getResources().getString(R.string.living_view_count, 10));\n```\n\n## FontMetrics\nFontMetrics意为字体测量。\n```\npublic static class FontMetrics {\n        /**\n         * The maximum distance above the baseline for the tallest glyph in\n         * the font at a given text size.\n         */\n        public float   top;\n        /**\n         * The recommended distance above the baseline for singled spaced text.\n         */\n        public float   ascent;\n        /**\n         * The recommended distance below the baseline for singled spaced text.\n         */\n        public float   descent;\n        /**\n         * The maximum distance below the baseline for the lowest glyph in\n         * the font at a given text size.\n         */\n        public float   bottom;\n        /**\n         * The recommended additional space to add between lines of text.\n         */\n        public float   leading;\n    }\n```\n这五个属性分别是什么呢？看如下的图便能一目了然了：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/07/textview1.png)\n","slug":"textview","published":1,"updated":"2016-11-21T10:03:45.102Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75ae00331cb8xj22npli","content":"<p>相信TextView是Android最常见的控件了，在日常使用中也有一些“心得”，这里记录一下。</p>\n<h2 id=\"格式化\"><a href=\"#格式化\" class=\"headerlink\" title=\"格式化\"></a>格式化</h2><p>有些时候需要在一个TextView上显示不同字体格式的内容，比如说一段黑色，一段灰色的内容，又或者字体一大一小的内容，要实现这样的效果有2种方式：</p>\n<ol>\n<li><p>使用SpannableString</p>\n<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">SpannableString spanString = <span class=\"keyword\">new</span> <span class=\"type\">SpannableString</span>(<span class=\"string\">\"Hello world!\"</span>);</div><div class=\"line\">ForegroundColorSpan span = <span class=\"keyword\">new</span> <span class=\"type\">ForegroundColorSpan</span>(getResources().getColor(R.color.black));</div><div class=\"line\">spanString.setSpan(span, <span class=\"number\">0</span>, <span class=\"number\">5</span>, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</div></pre></td></tr></table></figure>\n</li>\n<li><p>使用Html format</p>\n<figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">String</span> <span class=\"built_in\">text</span> = <span class=\"string\">\"&lt;font color='black'&gt;Hello:&lt;/font&gt;\"</span> + <span class=\"string\">\"world!\"</span>;</div><div class=\"line\">content.setText(Html.fromHtml(<span class=\"built_in\">text</span>), TextView.BufferType.SPANNABLE);</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>两种方式都是可以的，但是第2种方式会导致TextView设置<code>maxLines=&quot;3&quot;、ellipsize=&quot;end&quot;</code>的情况下，文本超过3行的时候不显示<code>...</code>提示符了。所以在有<code>...</code>的需求的时候建议还是使用第一种。</p>\n<a id=\"more\"></a>\n<h2 id=\"字的行间距\"><a href=\"#字的行间距\" class=\"headerlink\" title=\"字的行间距\"></a>字的行间距</h2><p>如果内容过多是会换行的，要设置行间距可以如下设置：</p>\n<ol>\n<li>android:lineSpacingExtra<br>设置行间距，如”3dp”。</li>\n<li>android:lineSpacingMultiplier<br>设置行间距的倍数，如”1.2”。</li>\n</ol>\n<h2 id=\"占位符\"><a href=\"#占位符\" class=\"headerlink\" title=\"占位符\"></a>占位符</h2><p>有些时候一段字符大部分是固定的，只有一两位是变化的，那么可以在strings.xml中进行如下配置：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;<span class=\"built_in\">string</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"barrage_reward\"</span>&gt;%<span class=\"number\">1</span>$s打赏了主播的专辑&lt;/<span class=\"built_in\">string</span>&gt;</div><div class=\"line\">&lt;<span class=\"built_in\">string</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"living_view_count\"</span>&gt;%<span class=\"number\">1</span>$d人观看&lt;/<span class=\"built_in\">string</span>&gt;</div></pre></td></tr></table></figure></p>\n<p>1%代表第一个占位符，$s代表字符占位，$d代表数字占位。<br>然后在设置的时候，用真实的数据替换掉占位符即可。<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">textView</span><span class=\"selector-class\">.setText</span>(<span class=\"selector-tag\">getResources</span>()<span class=\"selector-class\">.getString</span>(<span class=\"selector-tag\">R</span><span class=\"selector-class\">.string</span><span class=\"selector-class\">.barrage_reward</span>, \"<span class=\"selector-tag\">Jay</span>\"));</div><div class=\"line\"><span class=\"selector-tag\">textView</span><span class=\"selector-class\">.setText</span>(<span class=\"selector-tag\">getResources</span>()<span class=\"selector-class\">.getString</span>(<span class=\"selector-tag\">R</span><span class=\"selector-class\">.string</span><span class=\"selector-class\">.living_view_count</span>, 10));</div></pre></td></tr></table></figure></p>\n<h2 id=\"FontMetrics\"><a href=\"#FontMetrics\" class=\"headerlink\" title=\"FontMetrics\"></a>FontMetrics</h2><p>FontMetrics意为字体测量。<br><figure class=\"highlight zephir\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FontMetrics</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * The maximum distance above the baseline for the tallest glyph in</div><div class=\"line\">         * the font at a given text size.</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   top;</div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * The recommended distance above the baseline for singled spaced text.</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   ascent;</div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * The recommended distance below the baseline for singled spaced text.</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   descent;</div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * The maximum distance below the baseline for the lowest glyph in</div><div class=\"line\">         * the font at a given text size.</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   bottom;</div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * The recommended additional space to add between lines of text.</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   leading;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>这五个属性分别是什么呢？看如下的图便能一目了然了：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/07/textview1.png\" alt=\"\"></p>\n","excerpt":"<p>相信TextView是Android最常见的控件了，在日常使用中也有一些“心得”，这里记录一下。</p>\n<h2 id=\"格式化\"><a href=\"#格式化\" class=\"headerlink\" title=\"格式化\"></a>格式化</h2><p>有些时候需要在一个TextView上显示不同字体格式的内容，比如说一段黑色，一段灰色的内容，又或者字体一大一小的内容，要实现这样的效果有2种方式：</p>\n<ol>\n<li><p>使用SpannableString</p>\n<figure class=\"highlight haxe\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">SpannableString spanString = <span class=\"keyword\">new</span> <span class=\"type\">SpannableString</span>(<span class=\"string\">\"Hello world!\"</span>);</div><div class=\"line\">ForegroundColorSpan span = <span class=\"keyword\">new</span> <span class=\"type\">ForegroundColorSpan</span>(getResources().getColor(R.color.black));</div><div class=\"line\">spanString.setSpan(span, <span class=\"number\">0</span>, <span class=\"number\">5</span>, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</div></pre></td></tr></table></figure>\n</li>\n<li><p>使用Html format</p>\n<figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">String</span> <span class=\"built_in\">text</span> = <span class=\"string\">\"&lt;font color='black'&gt;Hello:&lt;/font&gt;\"</span> + <span class=\"string\">\"world!\"</span>;</div><div class=\"line\">content.setText(Html.fromHtml(<span class=\"built_in\">text</span>), TextView.BufferType.SPANNABLE);</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>两种方式都是可以的，但是第2种方式会导致TextView设置<code>maxLines=&quot;3&quot;、ellipsize=&quot;end&quot;</code>的情况下，文本超过3行的时候不显示<code>...</code>提示符了。所以在有<code>...</code>的需求的时候建议还是使用第一种。</p>","more":"<h2 id=\"字的行间距\"><a href=\"#字的行间距\" class=\"headerlink\" title=\"字的行间距\"></a>字的行间距</h2><p>如果内容过多是会换行的，要设置行间距可以如下设置：</p>\n<ol>\n<li>android:lineSpacingExtra<br>设置行间距，如”3dp”。</li>\n<li>android:lineSpacingMultiplier<br>设置行间距的倍数，如”1.2”。</li>\n</ol>\n<h2 id=\"占位符\"><a href=\"#占位符\" class=\"headerlink\" title=\"占位符\"></a>占位符</h2><p>有些时候一段字符大部分是固定的，只有一两位是变化的，那么可以在strings.xml中进行如下配置：<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;<span class=\"built_in\">string</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"barrage_reward\"</span>&gt;%<span class=\"number\">1</span>$s打赏了主播的专辑&lt;/<span class=\"built_in\">string</span>&gt;</div><div class=\"line\">&lt;<span class=\"built_in\">string</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"living_view_count\"</span>&gt;%<span class=\"number\">1</span>$d人观看&lt;/<span class=\"built_in\">string</span>&gt;</div></pre></td></tr></table></figure></p>\n<p>1%代表第一个占位符，$s代表字符占位，$d代表数字占位。<br>然后在设置的时候，用真实的数据替换掉占位符即可。<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">textView</span><span class=\"selector-class\">.setText</span>(<span class=\"selector-tag\">getResources</span>()<span class=\"selector-class\">.getString</span>(<span class=\"selector-tag\">R</span><span class=\"selector-class\">.string</span><span class=\"selector-class\">.barrage_reward</span>, \"<span class=\"selector-tag\">Jay</span>\"));</div><div class=\"line\"><span class=\"selector-tag\">textView</span><span class=\"selector-class\">.setText</span>(<span class=\"selector-tag\">getResources</span>()<span class=\"selector-class\">.getString</span>(<span class=\"selector-tag\">R</span><span class=\"selector-class\">.string</span><span class=\"selector-class\">.living_view_count</span>, 10));</div></pre></td></tr></table></figure></p>\n<h2 id=\"FontMetrics\"><a href=\"#FontMetrics\" class=\"headerlink\" title=\"FontMetrics\"></a>FontMetrics</h2><p>FontMetrics意为字体测量。<br><figure class=\"highlight zephir\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FontMetrics</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * The maximum distance above the baseline for the tallest glyph in</div><div class=\"line\">         * the font at a given text size.</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   top;</div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * The recommended distance above the baseline for singled spaced text.</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   ascent;</div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * The recommended distance below the baseline for singled spaced text.</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   descent;</div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * The maximum distance below the baseline for the lowest glyph in</div><div class=\"line\">         * the font at a given text size.</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   bottom;</div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * The recommended additional space to add between lines of text.</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">float</span>   leading;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>这五个属性分别是什么呢？看如下的图便能一目了然了：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/07/textview1.png\" alt=\"\"></p>"},{"title":"Android事件分发机制学习小记","date":"2015-11-13T17:15:22.000Z","_content":"\nAndroid事件分发机制有三类：Activity、View、ViewGroup，其调用顺序是Activity->ViewGroup->View，考虑到实际开发中Activity的事件分发很少用到，这里便不作赘述。想要了解的可自行百度、谷歌。\n下面，我从View的事件分发开始。\n\n---\n## View的事件分发\n我们知道，任何触摸事件都是从dispatchTouchEvent函数开始。在View的dispatchTouchEvent函数中，会看到这样的代码块：\n```\n...\nif (onFilterTouchEventForSecurity(event)) {\n            //noinspection SimplifiableIfStatement\n            ListenerInfo li = mListenerInfo;\n            if (li != null && li.mOnTouchListener != null\n                    && (mViewFlags & ENABLED_MASK) == ENABLED\n                    && li.mOnTouchListener.onTouch(this, event)) {\n                result = true;\n            }\n\n            if (!result && onTouchEvent(event)) {\n                result = true;\n            }\n        }\n...\n```\n说明View若要进行事件分发，那么会优先分发给onTouch()，若onTouch()返回true，则直接返回true，不会进入到onTouchEvent()中。否则，进入到onTouchEvent()。\n\n<!--more-->\n\nonTouch()与onTouchEvent()都是View中用户处理触摸事件的方法。onTouch是OnTouchListener接口中的函数，OnTouchListener接口是暴露给用户，让用户自己处理触摸事件。onTouchEvent()是View自带的接口，Android系统提供了默认的实现，当然，也可以重载该方法。\n\n在onTouchEvent()函数中，会看到这样的代码块：\n```\n...\nif (((viewFlags & CLICKABLE) == CLICKABLE ||\n                (viewFlags & LONG_CLICKABLE) == LONG_CLICKABLE) ||\n                (viewFlags & CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) {\n                ...\n                return true;\n                ...\n}\nreturn false;\n...\n```\n即若View可点击，则返回true；若不可点击，则返回false。\n\n在if内部，若是ACTION_UP事件，条件符合的情况下会执行performClick()方法，该方法会执行mOnClickListener.onClick()，即View的onClick事件，是在onTouchEvent()方法的ACTION_UP分支中进行调用的。\n\n下面我做了一个测试：\n\n- 分别定义一个Button与TextView，设置OnTouchListener。\n```\nbutton.setOnTouchListener(new View.OnTouchListener() {\n            @Override\n            public boolean onTouch(View v, MotionEvent event) {\n                Log.d(\"TAG\", \"onTouch execute, action \" + event.getAction());\n                return false;\n            }\n        });\n\ntextView.setOnTouchListener(new View.OnTouchListener() {\n            @Override\n            public boolean onTouch(View v, MotionEvent event) {\n                Log.d(\"TAG\", \"onTouch execute, action \" + event.getAction());\n                return false;\n            }\n        });\n```\n点击Button，log如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event2.png)\n点击ImageView，log如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event3.png)\n可以看到Button的所有事件都执行了，而TextView只执行了ACTION_DOWN事件。针对ACTION_DOWN事件，Button的dispatchTouchEvent()返回的是true（onTouch返回false后会继续执行onTouchEvent，由于可点击，所以返回true），而TextView返回false。\n\n- 修改textView的onTouch如下：\n```\n@Override\n            public boolean onTouch(View v, MotionEvent event) {\n                switch (event.getAction()) {\n                    case MotionEvent.ACTION_DOWN:\n                        return true;\n                    case MotionEvent.ACTION_MOVE:\n                        return false;\n                    case MotionEvent.ACTION_UP:\n                        return false;\n                    default:\n                        break;\n                }\n                Log.d(\"TAG\", \"onTouch execute, action \" + event.getAction());\n                return false;\n            }\n```\n会发现ACTION_DOWN、ACTION_MOVE（手指点击不精确，会造成移动）、ACTION_UP都会执行。后面我对这三个事件的返回值进行组合，后面发现<font color=red>只有在ACTION_DOWN事件触发，dispatchTouchEvent返回true时，后面的ACTION_MOVE、ACTION_UP才会执行。</font>暂时还不知道原因，姑且理解为：ACTION_DOWN是触摸事件的起点，连消费开头的能力都不具备，那么后面的事件就免谈了？这里暂时留一个疑问。\n\n下面我们来看看ViewGroup。\n\n---\n## ViewGroup的事件分发\nViewGroup继承于View，它中对触摸事件的处理，很多都继承于View。但是，ViewGroup又有自己对触摸事件的特定处理：\n\n - ViewGroup重载了dispatchTouchEvent()方法。\n - ViewGroup新增了onInterceptTouchEvent()方法。\n\nonInterceptTouchEvent()是用来判断ViewGroup是否拦截事件。默认返回false，即不拦截。\n在dispatchTouchEvent()中，会通过onInterceptTouchEvent()判断ViewGroup是否拦截事件，若返回true，则没有后续。若返回false，则ViewGroup会尝试分发事件给自己的子View。在分发时，会有这么一个判断：\n```\nif (!canceled && !intercepted) {\n            if (actionMasked == MotionEvent.ACTION_DOWN\n                    || (split && actionMasked == MotionEvent.ACTION_POINTER_DOWN)\n                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) {\n                ...\n\n        }\n```\n即只有在ACTION_DOWN的时候，ViewGroup才会尝试着将事件分发给子View，这便是疑问的答案。在ACTION_DOWN之后，传递ACTION_MOVE或ACTION_UP时，ViewGroup不会再执行上面的if，而是直接遍历子View链表，查找之前接受ACTION_DOWN的子View，并将触摸事件分配给这些子View。\n\n---\n## 小结\n\n - View事件分发，会先将事件分配给onTouch()进行处理，然后才分配给onTouchEvent()进行处理。\n - onTouchEvent()的返回值与View是否可点击有关。\n -  ViewGroup中的dispatchTouchEvent()会将触摸事件进行递归遍历传递。ViewGroup会遍历它的所有孩子，对每个孩子都递归的调用dispatchTouchEvent()来分发触摸事件。\n -  若ViewGroup的某个孩子没有接受(消费或者拦截)ACTION_DOWN事件；那么，ACTION_MOVE和ACTION_UP等事件也一定不会分发给这个孩子。\n -  ViewGroup的onInterceptTouchEvent()默认返回false。\n\n下面贴一张总结图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event1.png)\n<font color=red>注：文中源码的if判断都是以一般情况为前提，提取我们比较关注的点进行判断来得出的结论。</font>\n\n---\n## 参考文章\nhttp://blog.csdn.net/guolin_blog/article/details/9097463\nhttp://blog.csdn.net/guolin_blog/article/details/9153747\nhttp://wangkuiwu.github.io/2015/01/03/TouchEvent-View/\nhttp://wangkuiwu.github.io/2015/01/04/TouchEvent-ViewGroup/\n","source":"_posts/touch-event.md","raw":"---\ntitle: Android事件分发机制学习小记\ndate: 2015-11-14 01:15:22\ntags:\n - 事件分发\n---\n\nAndroid事件分发机制有三类：Activity、View、ViewGroup，其调用顺序是Activity->ViewGroup->View，考虑到实际开发中Activity的事件分发很少用到，这里便不作赘述。想要了解的可自行百度、谷歌。\n下面，我从View的事件分发开始。\n\n---\n## View的事件分发\n我们知道，任何触摸事件都是从dispatchTouchEvent函数开始。在View的dispatchTouchEvent函数中，会看到这样的代码块：\n```\n...\nif (onFilterTouchEventForSecurity(event)) {\n            //noinspection SimplifiableIfStatement\n            ListenerInfo li = mListenerInfo;\n            if (li != null && li.mOnTouchListener != null\n                    && (mViewFlags & ENABLED_MASK) == ENABLED\n                    && li.mOnTouchListener.onTouch(this, event)) {\n                result = true;\n            }\n\n            if (!result && onTouchEvent(event)) {\n                result = true;\n            }\n        }\n...\n```\n说明View若要进行事件分发，那么会优先分发给onTouch()，若onTouch()返回true，则直接返回true，不会进入到onTouchEvent()中。否则，进入到onTouchEvent()。\n\n<!--more-->\n\nonTouch()与onTouchEvent()都是View中用户处理触摸事件的方法。onTouch是OnTouchListener接口中的函数，OnTouchListener接口是暴露给用户，让用户自己处理触摸事件。onTouchEvent()是View自带的接口，Android系统提供了默认的实现，当然，也可以重载该方法。\n\n在onTouchEvent()函数中，会看到这样的代码块：\n```\n...\nif (((viewFlags & CLICKABLE) == CLICKABLE ||\n                (viewFlags & LONG_CLICKABLE) == LONG_CLICKABLE) ||\n                (viewFlags & CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) {\n                ...\n                return true;\n                ...\n}\nreturn false;\n...\n```\n即若View可点击，则返回true；若不可点击，则返回false。\n\n在if内部，若是ACTION_UP事件，条件符合的情况下会执行performClick()方法，该方法会执行mOnClickListener.onClick()，即View的onClick事件，是在onTouchEvent()方法的ACTION_UP分支中进行调用的。\n\n下面我做了一个测试：\n\n- 分别定义一个Button与TextView，设置OnTouchListener。\n```\nbutton.setOnTouchListener(new View.OnTouchListener() {\n            @Override\n            public boolean onTouch(View v, MotionEvent event) {\n                Log.d(\"TAG\", \"onTouch execute, action \" + event.getAction());\n                return false;\n            }\n        });\n\ntextView.setOnTouchListener(new View.OnTouchListener() {\n            @Override\n            public boolean onTouch(View v, MotionEvent event) {\n                Log.d(\"TAG\", \"onTouch execute, action \" + event.getAction());\n                return false;\n            }\n        });\n```\n点击Button，log如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event2.png)\n点击ImageView，log如下：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event3.png)\n可以看到Button的所有事件都执行了，而TextView只执行了ACTION_DOWN事件。针对ACTION_DOWN事件，Button的dispatchTouchEvent()返回的是true（onTouch返回false后会继续执行onTouchEvent，由于可点击，所以返回true），而TextView返回false。\n\n- 修改textView的onTouch如下：\n```\n@Override\n            public boolean onTouch(View v, MotionEvent event) {\n                switch (event.getAction()) {\n                    case MotionEvent.ACTION_DOWN:\n                        return true;\n                    case MotionEvent.ACTION_MOVE:\n                        return false;\n                    case MotionEvent.ACTION_UP:\n                        return false;\n                    default:\n                        break;\n                }\n                Log.d(\"TAG\", \"onTouch execute, action \" + event.getAction());\n                return false;\n            }\n```\n会发现ACTION_DOWN、ACTION_MOVE（手指点击不精确，会造成移动）、ACTION_UP都会执行。后面我对这三个事件的返回值进行组合，后面发现<font color=red>只有在ACTION_DOWN事件触发，dispatchTouchEvent返回true时，后面的ACTION_MOVE、ACTION_UP才会执行。</font>暂时还不知道原因，姑且理解为：ACTION_DOWN是触摸事件的起点，连消费开头的能力都不具备，那么后面的事件就免谈了？这里暂时留一个疑问。\n\n下面我们来看看ViewGroup。\n\n---\n## ViewGroup的事件分发\nViewGroup继承于View，它中对触摸事件的处理，很多都继承于View。但是，ViewGroup又有自己对触摸事件的特定处理：\n\n - ViewGroup重载了dispatchTouchEvent()方法。\n - ViewGroup新增了onInterceptTouchEvent()方法。\n\nonInterceptTouchEvent()是用来判断ViewGroup是否拦截事件。默认返回false，即不拦截。\n在dispatchTouchEvent()中，会通过onInterceptTouchEvent()判断ViewGroup是否拦截事件，若返回true，则没有后续。若返回false，则ViewGroup会尝试分发事件给自己的子View。在分发时，会有这么一个判断：\n```\nif (!canceled && !intercepted) {\n            if (actionMasked == MotionEvent.ACTION_DOWN\n                    || (split && actionMasked == MotionEvent.ACTION_POINTER_DOWN)\n                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) {\n                ...\n\n        }\n```\n即只有在ACTION_DOWN的时候，ViewGroup才会尝试着将事件分发给子View，这便是疑问的答案。在ACTION_DOWN之后，传递ACTION_MOVE或ACTION_UP时，ViewGroup不会再执行上面的if，而是直接遍历子View链表，查找之前接受ACTION_DOWN的子View，并将触摸事件分配给这些子View。\n\n---\n## 小结\n\n - View事件分发，会先将事件分配给onTouch()进行处理，然后才分配给onTouchEvent()进行处理。\n - onTouchEvent()的返回值与View是否可点击有关。\n -  ViewGroup中的dispatchTouchEvent()会将触摸事件进行递归遍历传递。ViewGroup会遍历它的所有孩子，对每个孩子都递归的调用dispatchTouchEvent()来分发触摸事件。\n -  若ViewGroup的某个孩子没有接受(消费或者拦截)ACTION_DOWN事件；那么，ACTION_MOVE和ACTION_UP等事件也一定不会分发给这个孩子。\n -  ViewGroup的onInterceptTouchEvent()默认返回false。\n\n下面贴一张总结图：\n![这里写图片描述](http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event1.png)\n<font color=red>注：文中源码的if判断都是以一般情况为前提，提取我们比较关注的点进行判断来得出的结论。</font>\n\n---\n## 参考文章\nhttp://blog.csdn.net/guolin_blog/article/details/9097463\nhttp://blog.csdn.net/guolin_blog/article/details/9153747\nhttp://wangkuiwu.github.io/2015/01/03/TouchEvent-View/\nhttp://wangkuiwu.github.io/2015/01/04/TouchEvent-ViewGroup/\n","slug":"touch-event","published":1,"updated":"2016-11-21T10:03:48.677Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75ag00351cb82vwadvc7","content":"<p>Android事件分发机制有三类：Activity、View、ViewGroup，其调用顺序是Activity-&gt;ViewGroup-&gt;View，考虑到实际开发中Activity的事件分发很少用到，这里便不作赘述。想要了解的可自行百度、谷歌。<br>下面，我从View的事件分发开始。</p>\n<hr>\n<h2 id=\"View的事件分发\"><a href=\"#View的事件分发\" class=\"headerlink\" title=\"View的事件分发\"></a>View的事件分发</h2><p>我们知道，任何触摸事件都是从dispatchTouchEvent函数开始。在View的dispatchTouchEvent函数中，会看到这样的代码块：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">...</div><div class=\"line\"><span class=\"keyword\">if</span> (onFilterTouchEventForSecurity(<span class=\"keyword\">event</span>)) &#123;</div><div class=\"line\">            <span class=\"comment\">//noinspection SimplifiableIfStatement</span></div><div class=\"line\">            ListenerInfo li = mListenerInfo;</div><div class=\"line\">            <span class=\"keyword\">if</span> (li != <span class=\"literal\">null</span> &amp;&amp; li.mOnTouchListener != <span class=\"literal\">null</span></div><div class=\"line\">                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class=\"line\">                    &amp;&amp; li.mOnTouchListener.onTouch(<span class=\"keyword\">this</span>, <span class=\"keyword\">event</span>)) &#123;</div><div class=\"line\">                result = <span class=\"literal\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"keyword\">if</span> (!result &amp;&amp; onTouchEvent(<span class=\"keyword\">event</span>)) &#123;</div><div class=\"line\">                result = <span class=\"literal\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">...</div></pre></td></tr></table></figure></p>\n<p>说明View若要进行事件分发，那么会优先分发给onTouch()，若onTouch()返回true，则直接返回true，不会进入到onTouchEvent()中。否则，进入到onTouchEvent()。</p>\n<a id=\"more\"></a>\n<p>onTouch()与onTouchEvent()都是View中用户处理触摸事件的方法。onTouch是OnTouchListener接口中的函数，OnTouchListener接口是暴露给用户，让用户自己处理触摸事件。onTouchEvent()是View自带的接口，Android系统提供了默认的实现，当然，也可以重载该方法。</p>\n<p>在onTouchEvent()函数中，会看到这样的代码块：<br><figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"params\">...</span></div><div class=\"line\"><span class=\"keyword\">if</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class=\"line\">                (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) ||</div><div class=\"line\">                (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123;</div><div class=\"line\">                <span class=\"params\">...</span></div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">                <span class=\"params\">...</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\"><span class=\"params\">...</span></div></pre></td></tr></table></figure></p>\n<p>即若View可点击，则返回true；若不可点击，则返回false。</p>\n<p>在if内部，若是ACTION_UP事件，条件符合的情况下会执行performClick()方法，该方法会执行mOnClickListener.onClick()，即View的onClick事件，是在onTouchEvent()方法的ACTION_UP分支中进行调用的。</p>\n<p>下面我做了一个测试：</p>\n<ul>\n<li>分别定义一个Button与TextView，设置OnTouchListener。<figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">button.setOnTouchListener(<span class=\"keyword\">new</span> View.OnTouchListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouch</span><span class=\"params\">(View v, MotionEvent event)</span> </span>&#123;</div><div class=\"line\">                Log.d(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"onTouch execute, action \"</span> + event.getAction());</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\"></div><div class=\"line\">textView.setOnTouchListener(<span class=\"keyword\">new</span> View.OnTouchListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouch</span><span class=\"params\">(View v, MotionEvent event)</span> </span>&#123;</div><div class=\"line\">                Log.d(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"onTouch execute, action \"</span> + event.getAction());</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>点击Button，log如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event2.png\" alt=\"这里写图片描述\"><br>点击ImageView，log如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event3.png\" alt=\"这里写图片描述\"><br>可以看到Button的所有事件都执行了，而TextView只执行了ACTION_DOWN事件。针对ACTION_DOWN事件，Button的dispatchTouchEvent()返回的是true（onTouch返回false后会继续执行onTouchEvent，由于可点击，所以返回true），而TextView返回false。</p>\n<ul>\n<li>修改textView的onTouch如下：<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">@<span class=\"function\">Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> boolean <span class=\"title\">onTouch</span>(<span class=\"params\">View v, MotionEvent <span class=\"keyword\">event</span></span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">switch</span> (<span class=\"keyword\">event</span>.getAction()) &#123;</div><div class=\"line\">                    <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">                    <span class=\"keyword\">default</span>:</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                Log.d(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"onTouch execute, action \"</span> + <span class=\"keyword\">event</span>.getAction());</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">            &#125;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>会发现ACTION_DOWN、ACTION_MOVE（手指点击不精确，会造成移动）、ACTION_UP都会执行。后面我对这三个事件的返回值进行组合，后面发现<font color=\"red\">只有在ACTION_DOWN事件触发，dispatchTouchEvent返回true时，后面的ACTION_MOVE、ACTION_UP才会执行。</font>暂时还不知道原因，姑且理解为：ACTION_DOWN是触摸事件的起点，连消费开头的能力都不具备，那么后面的事件就免谈了？这里暂时留一个疑问。</p>\n<p>下面我们来看看ViewGroup。</p>\n<hr>\n<h2 id=\"ViewGroup的事件分发\"><a href=\"#ViewGroup的事件分发\" class=\"headerlink\" title=\"ViewGroup的事件分发\"></a>ViewGroup的事件分发</h2><p>ViewGroup继承于View，它中对触摸事件的处理，很多都继承于View。但是，ViewGroup又有自己对触摸事件的特定处理：</p>\n<ul>\n<li>ViewGroup重载了dispatchTouchEvent()方法。</li>\n<li>ViewGroup新增了onInterceptTouchEvent()方法。</li>\n</ul>\n<p>onInterceptTouchEvent()是用来判断ViewGroup是否拦截事件。默认返回false，即不拦截。<br>在dispatchTouchEvent()中，会通过onInterceptTouchEvent()判断ViewGroup是否拦截事件，若返回true，则没有后续。若返回false，则ViewGroup会尝试分发事件给自己的子View。在分发时，会有这么一个判断：<br><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">if</span> (!canceled &amp;&amp; !intercepted) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"attr\">actionMasked</span> == MotionEvent.ACTION_DOWN</div><div class=\"line\">                    || (split &amp;&amp; <span class=\"attr\">actionMasked</span> == MotionEvent.ACTION_POINTER_DOWN)</div><div class=\"line\">                    || <span class=\"attr\">actionMasked</span> == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class=\"line\">                ...</div><div class=\"line\"></div><div class=\"line\">        &#125;</div></pre></td></tr></table></figure></p>\n<p>即只有在ACTION_DOWN的时候，ViewGroup才会尝试着将事件分发给子View，这便是疑问的答案。在ACTION_DOWN之后，传递ACTION_MOVE或ACTION_UP时，ViewGroup不会再执行上面的if，而是直接遍历子View链表，查找之前接受ACTION_DOWN的子View，并将触摸事件分配给这些子View。</p>\n<hr>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ul>\n<li>View事件分发，会先将事件分配给onTouch()进行处理，然后才分配给onTouchEvent()进行处理。</li>\n<li>onTouchEvent()的返回值与View是否可点击有关。</li>\n<li>ViewGroup中的dispatchTouchEvent()会将触摸事件进行递归遍历传递。ViewGroup会遍历它的所有孩子，对每个孩子都递归的调用dispatchTouchEvent()来分发触摸事件。</li>\n<li>若ViewGroup的某个孩子没有接受(消费或者拦截)ACTION_DOWN事件；那么，ACTION_MOVE和ACTION_UP等事件也一定不会分发给这个孩子。</li>\n<li>ViewGroup的onInterceptTouchEvent()默认返回false。</li>\n</ul>\n<p>下面贴一张总结图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event1.png\" alt=\"这里写图片描述\"></p>\n<font color=\"red\">注：文中源码的if判断都是以一般情况为前提，提取我们比较关注的点进行判断来得出的结论。</font>\n\n<hr>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"http://blog.csdn.net/guolin_blog/article/details/9097463\" target=\"_blank\" rel=\"external\">http://blog.csdn.net/guolin_blog/article/details/9097463</a><br><a href=\"http://blog.csdn.net/guolin_blog/article/details/9153747\" target=\"_blank\" rel=\"external\">http://blog.csdn.net/guolin_blog/article/details/9153747</a><br><a href=\"http://wangkuiwu.github.io/2015/01/03/TouchEvent-View/\" target=\"_blank\" rel=\"external\">http://wangkuiwu.github.io/2015/01/03/TouchEvent-View/</a><br><a href=\"http://wangkuiwu.github.io/2015/01/04/TouchEvent-ViewGroup/\" target=\"_blank\" rel=\"external\">http://wangkuiwu.github.io/2015/01/04/TouchEvent-ViewGroup/</a></p>\n","excerpt":"<p>Android事件分发机制有三类：Activity、View、ViewGroup，其调用顺序是Activity-&gt;ViewGroup-&gt;View，考虑到实际开发中Activity的事件分发很少用到，这里便不作赘述。想要了解的可自行百度、谷歌。<br>下面，我从View的事件分发开始。</p>\n<hr>\n<h2 id=\"View的事件分发\"><a href=\"#View的事件分发\" class=\"headerlink\" title=\"View的事件分发\"></a>View的事件分发</h2><p>我们知道，任何触摸事件都是从dispatchTouchEvent函数开始。在View的dispatchTouchEvent函数中，会看到这样的代码块：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">...</div><div class=\"line\"><span class=\"keyword\">if</span> (onFilterTouchEventForSecurity(<span class=\"keyword\">event</span>)) &#123;</div><div class=\"line\">            <span class=\"comment\">//noinspection SimplifiableIfStatement</span></div><div class=\"line\">            ListenerInfo li = mListenerInfo;</div><div class=\"line\">            <span class=\"keyword\">if</span> (li != <span class=\"literal\">null</span> &amp;&amp; li.mOnTouchListener != <span class=\"literal\">null</span></div><div class=\"line\">                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class=\"line\">                    &amp;&amp; li.mOnTouchListener.onTouch(<span class=\"keyword\">this</span>, <span class=\"keyword\">event</span>)) &#123;</div><div class=\"line\">                result = <span class=\"literal\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"keyword\">if</span> (!result &amp;&amp; onTouchEvent(<span class=\"keyword\">event</span>)) &#123;</div><div class=\"line\">                result = <span class=\"literal\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">...</div></pre></td></tr></table></figure></p>\n<p>说明View若要进行事件分发，那么会优先分发给onTouch()，若onTouch()返回true，则直接返回true，不会进入到onTouchEvent()中。否则，进入到onTouchEvent()。</p>","more":"<p>onTouch()与onTouchEvent()都是View中用户处理触摸事件的方法。onTouch是OnTouchListener接口中的函数，OnTouchListener接口是暴露给用户，让用户自己处理触摸事件。onTouchEvent()是View自带的接口，Android系统提供了默认的实现，当然，也可以重载该方法。</p>\n<p>在onTouchEvent()函数中，会看到这样的代码块：<br><figure class=\"highlight lasso\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"params\">...</span></div><div class=\"line\"><span class=\"keyword\">if</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class=\"line\">                (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) ||</div><div class=\"line\">                (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123;</div><div class=\"line\">                <span class=\"params\">...</span></div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">                <span class=\"params\">...</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\"><span class=\"params\">...</span></div></pre></td></tr></table></figure></p>\n<p>即若View可点击，则返回true；若不可点击，则返回false。</p>\n<p>在if内部，若是ACTION_UP事件，条件符合的情况下会执行performClick()方法，该方法会执行mOnClickListener.onClick()，即View的onClick事件，是在onTouchEvent()方法的ACTION_UP分支中进行调用的。</p>\n<p>下面我做了一个测试：</p>\n<ul>\n<li>分别定义一个Button与TextView，设置OnTouchListener。<figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">button.setOnTouchListener(<span class=\"keyword\">new</span> View.OnTouchListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouch</span><span class=\"params\">(View v, MotionEvent event)</span> </span>&#123;</div><div class=\"line\">                Log.d(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"onTouch execute, action \"</span> + event.getAction());</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\"></div><div class=\"line\">textView.setOnTouchListener(<span class=\"keyword\">new</span> View.OnTouchListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouch</span><span class=\"params\">(View v, MotionEvent event)</span> </span>&#123;</div><div class=\"line\">                Log.d(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"onTouch execute, action \"</span> + event.getAction());</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>点击Button，log如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event2.png\" alt=\"这里写图片描述\"><br>点击ImageView，log如下：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event3.png\" alt=\"这里写图片描述\"><br>可以看到Button的所有事件都执行了，而TextView只执行了ACTION_DOWN事件。针对ACTION_DOWN事件，Button的dispatchTouchEvent()返回的是true（onTouch返回false后会继续执行onTouchEvent，由于可点击，所以返回true），而TextView返回false。</p>\n<ul>\n<li>修改textView的onTouch如下：<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">@<span class=\"function\">Override</div><div class=\"line\">            <span class=\"keyword\">public</span> boolean <span class=\"title\">onTouch</span>(<span class=\"params\">View v, MotionEvent <span class=\"keyword\">event</span></span>) </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">switch</span> (<span class=\"keyword\">event</span>.getAction()) &#123;</div><div class=\"line\">                    <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">                    <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">                    <span class=\"keyword\">default</span>:</div><div class=\"line\">                        <span class=\"keyword\">break</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                Log.d(<span class=\"string\">\"TAG\"</span>, <span class=\"string\">\"onTouch execute, action \"</span> + <span class=\"keyword\">event</span>.getAction());</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">            &#125;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>会发现ACTION_DOWN、ACTION_MOVE（手指点击不精确，会造成移动）、ACTION_UP都会执行。后面我对这三个事件的返回值进行组合，后面发现<font color=red>只有在ACTION_DOWN事件触发，dispatchTouchEvent返回true时，后面的ACTION_MOVE、ACTION_UP才会执行。</font>暂时还不知道原因，姑且理解为：ACTION_DOWN是触摸事件的起点，连消费开头的能力都不具备，那么后面的事件就免谈了？这里暂时留一个疑问。</p>\n<p>下面我们来看看ViewGroup。</p>\n<hr>\n<h2 id=\"ViewGroup的事件分发\"><a href=\"#ViewGroup的事件分发\" class=\"headerlink\" title=\"ViewGroup的事件分发\"></a>ViewGroup的事件分发</h2><p>ViewGroup继承于View，它中对触摸事件的处理，很多都继承于View。但是，ViewGroup又有自己对触摸事件的特定处理：</p>\n<ul>\n<li>ViewGroup重载了dispatchTouchEvent()方法。</li>\n<li>ViewGroup新增了onInterceptTouchEvent()方法。</li>\n</ul>\n<p>onInterceptTouchEvent()是用来判断ViewGroup是否拦截事件。默认返回false，即不拦截。<br>在dispatchTouchEvent()中，会通过onInterceptTouchEvent()判断ViewGroup是否拦截事件，若返回true，则没有后续。若返回false，则ViewGroup会尝试分发事件给自己的子View。在分发时，会有这么一个判断：<br><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">if</span> (!canceled &amp;&amp; !intercepted) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"attr\">actionMasked</span> == MotionEvent.ACTION_DOWN</div><div class=\"line\">                    || (split &amp;&amp; <span class=\"attr\">actionMasked</span> == MotionEvent.ACTION_POINTER_DOWN)</div><div class=\"line\">                    || <span class=\"attr\">actionMasked</span> == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class=\"line\">                ...</div><div class=\"line\"></div><div class=\"line\">        &#125;</div></pre></td></tr></table></figure></p>\n<p>即只有在ACTION_DOWN的时候，ViewGroup才会尝试着将事件分发给子View，这便是疑问的答案。在ACTION_DOWN之后，传递ACTION_MOVE或ACTION_UP时，ViewGroup不会再执行上面的if，而是直接遍历子View链表，查找之前接受ACTION_DOWN的子View，并将触摸事件分配给这些子View。</p>\n<hr>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ul>\n<li>View事件分发，会先将事件分配给onTouch()进行处理，然后才分配给onTouchEvent()进行处理。</li>\n<li>onTouchEvent()的返回值与View是否可点击有关。</li>\n<li>ViewGroup中的dispatchTouchEvent()会将触摸事件进行递归遍历传递。ViewGroup会遍历它的所有孩子，对每个孩子都递归的调用dispatchTouchEvent()来分发触摸事件。</li>\n<li>若ViewGroup的某个孩子没有接受(消费或者拦截)ACTION_DOWN事件；那么，ACTION_MOVE和ACTION_UP等事件也一定不会分发给这个孩子。</li>\n<li>ViewGroup的onInterceptTouchEvent()默认返回false。</li>\n</ul>\n<p>下面贴一张总结图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2015/11/touch-event1.png\" alt=\"这里写图片描述\"></p>\n<font color=red>注：文中源码的if判断都是以一般情况为前提，提取我们比较关注的点进行判断来得出的结论。</font>\n\n<hr>\n<h2 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h2><p><a href=\"http://blog.csdn.net/guolin_blog/article/details/9097463\">http://blog.csdn.net/guolin_blog/article/details/9097463</a><br><a href=\"http://blog.csdn.net/guolin_blog/article/details/9153747\">http://blog.csdn.net/guolin_blog/article/details/9153747</a><br><a href=\"http://wangkuiwu.github.io/2015/01/03/TouchEvent-View/\">http://wangkuiwu.github.io/2015/01/03/TouchEvent-View/</a><br><a href=\"http://wangkuiwu.github.io/2015/01/04/TouchEvent-ViewGroup/\">http://wangkuiwu.github.io/2015/01/04/TouchEvent-ViewGroup/</a></p>"},{"title":"Android开发事件分发小记","date":"2016-08-05T07:39:32.000Z","_content":"\n项目开发中，碰到这样一个情形：在点击页面空白处时会弹出状态栏，效果就如我[上一篇博客](http://lastwarmth.site/2016/08/04/statusbar/)一样。\n那么何为空白处呢？\n我的理解是：若是你这个点击事件没有其他View消费，那么便算是点击空白处了。\n大致画一下页面布局：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/08/touchevent1.png)\n那么在点击图中画框的其他地方，应该都能算上是空白处了，也就是在点击这些地方的时候，需要执行状态栏弹出的操作。\n\n<!-- more -->\n\n大致说一下页面布局的层次结构：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:tools=\"http://schemas.android.com/tools\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    tools:context=\"com.miamusic.android.live.ui.RoomActivity\">\n\n    <!-- 最底层的摄像画面 -->\n    <SurfaceView\n        android:id=\"@+id/surfaceview\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\" />\n\n    <HorizontalFrameLayout\n        android:id=\"@+id/parent_layout\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\">\n\n            <!-- 弹幕 -->\n            <android.support.v7.widget.RecyclerView\n                android:id=\"@+id/barrage_layout\"\n                android:layout_width=\"match_parent\"\n                android:layout_height=\"140dp\"\n                android:layout_alignParentBottom=\"true\"\n                android:layout_marginBottom=\"40dp\" />\n\n            <RelativeLayout\n                android:id=\"@+id/bottom_layout\"\n                android:layout_width=\"match_parent\"\n                android:layout_height=\"wrap_content\"\n                android:layout_alignParentBottom=\"true\">\n\n                <!-- 底部操作栏 -->\n\n            </RelativeLayout>\n\n    </HorizontalFrameLayout>\n\n    <RelativeLayout\n        android:id=\"@+id/top_layout\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\">\n\n        <!--顶部主播信息与删除的布局-->\n\n    </RelativeLayout>\n\n</FrameLayout>\n```\n下面便来逐渐分析事件的分发。\n\n## 清屏操作与RecyclerView的滑动冲突\n需求中有``向右滑动清屏``的操作，向左滑动的时候恢复。\n我给整个布局``parent_layout``设置了OnTouchListener，图中弹幕是使用的RecyclerView，RecyclerView本身就会处理滑动，那么就只能滑动RecyclerView之外的地方才能进行清屏。但是这样的体验不好，因为清屏必须要滑动空白地方，因为弹幕的原因可能导致空白地方很小。如何处理好与RecyclerView的滑动冲突呢？项目中，弹幕只具有上下滑动的功能，是不具备左右滑动的，所以事件分发给RecyclerView实际上是没有任何作用的，那么便可以在左右滑动的时候拦截掉事件，从而不分发给RecyclerView，拦截掉之后，若便会执行``parent_layout``自身的OnTouchListener中的onTouch事件，在这个事件中做清屏的功能。\n拦截横滑代码：\n```\n@Override\npublic boolean onInterceptTouchEvent(MotionEvent ev) {\n    switch (ev.getAction()) {\n        case MotionEvent.ACTION_DOWN:\n            downX = ev.getRawX();\n            downY = ev.getRawY();\n            break;\n        case MotionEvent.ACTION_MOVE:\n            float moveX = ev.getRawX();\n            float moveY = ev.getRawY();\n            /**\n             * 如果是横滑，则拦截，用于清屏\n             * 如果不是则直接将事件传递\n             */\n            if (Math.abs(moveX - downX) > Math.abs(moveY - downY)) {\n                return true;\n            }\n            break;\n    }\n    return super.onInterceptTouchEvent(ev);\n}\n```\n设置的OnTouchListener：\n```\nclass LiveGestureListener extends GestureDetector.SimpleOnGestureListener implements View.OnTouchListener {\n\n    Context context;\n    GestureDetector gestureDetector;\n\n    public LiveGestureListener(Context context) {\n        this(context, null);\n    }\n\n    public LiveGestureListener(Context context, GestureDetector detector) {\n        if (detector == null) {\n            detector = new GestureDetector(context, this);\n        }\n\n        this.context = context;\n        this.gestureDetector = detector;\n    }\n\n    @Override\n    public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {\n\n        if (velocityX >= 0) {\n            hideInteractLayout();\n        } else if (velocityX < 0) {\n            showInteractLayout();\n        }\n\n        return super.onFling(e1, e2, velocityX, velocityY);\n    }\n\n    @Override\n    public boolean onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY) {\n\n\n        return super.onScroll(e1, e2, distanceX, distanceY);\n    }\n\n    @Override\n    public boolean onSingleTapConfirmed(MotionEvent e) {\n        return super.onSingleTapConfirmed(e);\n    }\n\n    @Override\n    public boolean onTouch(View v, MotionEvent event) {\n        // Within the MyGestureListener class you can now manage the event.getAction() codes.\n\n        // Note that we are now calling the gesture Detectors onTouchEvent. And given we've set this class as the GestureDetectors listener\n        // the onFling, onSingleTap etc methods will be executed.\n        return gestureDetector.onTouchEvent(event);\n    }\n\n    public GestureDetector getGestureDetector() {\n        return gestureDetector;\n    }\n}\n```\n结合手势在``onFling``中做了清屏与恢复的功能。\n\n## 整个页面的空白处\n布局层次中可以看到``top_layout``是单独出来的，并且在FrameLayout的顶层。\n详细说明一下：\n1、清屏只清屏``parent_layout``中的内容，``top_layout``是不需要隐藏的，所以单独提了出来。\n2、在顶层是为了提前消费事件，FrameLayout接到事件后会优先分发给顶层的孩子，即``top_layout``，若``top_layout``消费了，即点击了关闭或者主播信息等有消费事件的View，那么就不算是点击``空白处``了，事件便不会分发给``parent_layout``；若``top_layout``没消费，即点击了``空白处``，则会将事件分发给``parent_layout``，``parent_layout``便是我们自定义的FrameLayout，重写onTouchEvent，执行弹出状态栏的操作便可实现需求。\n```\n@Override\npublic boolean onTouchEvent(MotionEvent event) {\n    /**\n     * 若是单纯的点击，并且没有其他View消费事件，则调用onClickEvent（用于显示或隐藏状态栏）\n     */\n    switch (event.getAction()) {\n        case MotionEvent.ACTION_DOWN:\n            interceptX = event.getRawX();\n            interceptY = event.getRawY();\n            return true;\n        case MotionEvent.ACTION_UP:\n            float moveX = event.getRawX();\n            float moveY = event.getRawY();\n            if ((Math.abs(moveX - interceptX) < 20) && (Math.abs(moveY - interceptY) < 20)) {\n                if (listener != null) {\n                    listener.onClickEvent(event);\n                }\n            }\n            break;\n    }\n    return super.onTouchEvent(event);\n}\n\npublic interface DealClickEventListener {\n    void onClickEvent(MotionEvent event);\n}\n```\n我们必须在ACTION_DOWN的时候返回true，才会继续收到ACTION_MOVE、ACTION_UP等事件，否则是收不到的。至于为什么，可以参考我之前的一篇博客[Android事件分发机制学习小记](http://lastwarmth.site/2015/11/14/touch-event/)。\n我们再ACTION_UP的时候执行我们弹出状态栏的操作即可。\n```\nholder.interactLayout.setListener(new HorizontalFrameLayout.DealClickEventListener() {\n    @Override\n    public void onClickEvent(MotionEvent event) {\n        if (!isShowing) {\n            showOperation();\n        } else {\n            handler.removeCallbacks(showOrHide);\n            handler.postDelayed(showOrHide, 5000);\n        }\n    }\n});\n```\n\n最后上一下``HorizontalFrameLayout``的完整代码:\n```\npublic class HorizontalFrameLayout extends FrameLayout {\n\n    private float downX;\n    private float downY;\n    private float interceptX;\n    private float interceptY;\n    private DealClickEventListener listener;\n\n    public HorizontalFrameLayout(Context context) {\n        super(context);\n    }\n\n    public HorizontalFrameLayout(Context context, AttributeSet attrs) {\n        super(context, attrs);\n    }\n\n    public HorizontalFrameLayout(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n    }\n\n    public void setListener(DealClickEventListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    public boolean onInterceptTouchEvent(MotionEvent ev) {\n        switch (ev.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                downX = ev.getRawX();\n                downY = ev.getRawY();\n                break;\n            case MotionEvent.ACTION_MOVE:\n                float moveX = ev.getRawX();\n                float moveY = ev.getRawY();\n                /**\n                 * 如果是横滑，则拦截，用于清屏\n                 * 如果不是则直接将事件传递\n                 */\n                if (Math.abs(moveX - downX) > Math.abs(moveY - downY)) {\n                    return true;\n                }\n                break;\n        }\n        return super.onInterceptTouchEvent(ev);\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent event) {\n        /**\n         * 若是单纯的点击，并且没有其他View消费事件，则调用onClickEvent（用于显示或隐藏状态栏）\n         */\n        switch (event.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                interceptX = event.getRawX();\n                interceptY = event.getRawY();\n                return true;\n            case MotionEvent.ACTION_UP:\n                float moveX = event.getRawX();\n                float moveY = event.getRawY();\n                if ((Math.abs(moveX - interceptX) < 20) && (Math.abs(moveY - interceptY) < 20)) {\n                    if (listener != null) {\n                        listener.onClickEvent(event);\n                    }\n                }\n                break;\n        }\n        return super.onTouchEvent(event);\n    }\n\n    public interface DealClickEventListener {\n        void onClickEvent(MotionEvent event);\n    }\n}\n```\n\n## 题外话\n在我的另一篇博客[一个关于Android滑动“因缺斯厅”的想法](http://lastwarmth.site/2016/04/22/android-scroll/)中说到一个点，顶部布局采用透明的，那么便会引发一个问题：需要透传``关注``按钮的点击事件，因为透明布局是在顶部，会拦截掉点击事件，需要透传才能执行关注的响应事件。\n```\npublic class CustomRecyclerView extends RecyclerView {\n\n    private View view;\n\n    public CustomRecyclerView(Context context) {\n        super(context);\n    }\n\n    public CustomRecyclerView(Context context, @Nullable AttributeSet attrs) {\n        super(context, attrs);\n    }\n\n    public void setView(View view) {\n        this.view = view;\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent e) {\n        if (view != null) {\n            final float downX = e.getX();\n            final float downY = e.getY();\n            int firstVisiblePosition = ((LinearLayoutManager) getLayoutManager()).findFirstVisibleItemPosition();\n            if (firstVisiblePosition > 0) {\n                return super.onTouchEvent(e);\n            } else {\n                View c = getLayoutManager().findViewByPosition(0);\n                int top = c.getTop();\n                float scrollY = -top;\n                if (downX >= view.getLeft() && downX <= view.getRight() && downY <= view.getBottom() && downY >= view.getTop() && scrollY < view.getHeight()) {\n                    return false;\n                } else {\n                    return super.onTouchEvent(e);\n                }\n            }\n\n        }\n        return super.onTouchEvent(e);\n    }\n}\n```\n通过调用``setView``设置需要透传的View，通过判断点击的位置是否在View的范围内，以及RecyclerView滑动的高度是否已经高过``关注按钮的高度``，通过返回false，便可以将事件透传下去了。\n","source":"_posts/touchevent.md","raw":"---\ntitle: Android开发事件分发小记\ndate: 2016-08-05 15:39:32\ntags:\n - 事件分发\n---\n\n项目开发中，碰到这样一个情形：在点击页面空白处时会弹出状态栏，效果就如我[上一篇博客](http://lastwarmth.site/2016/08/04/statusbar/)一样。\n那么何为空白处呢？\n我的理解是：若是你这个点击事件没有其他View消费，那么便算是点击空白处了。\n大致画一下页面布局：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/08/touchevent1.png)\n那么在点击图中画框的其他地方，应该都能算上是空白处了，也就是在点击这些地方的时候，需要执行状态栏弹出的操作。\n\n<!-- more -->\n\n大致说一下页面布局的层次结构：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    xmlns:tools=\"http://schemas.android.com/tools\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\"\n    tools:context=\"com.miamusic.android.live.ui.RoomActivity\">\n\n    <!-- 最底层的摄像画面 -->\n    <SurfaceView\n        android:id=\"@+id/surfaceview\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\" />\n\n    <HorizontalFrameLayout\n        android:id=\"@+id/parent_layout\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\">\n\n            <!-- 弹幕 -->\n            <android.support.v7.widget.RecyclerView\n                android:id=\"@+id/barrage_layout\"\n                android:layout_width=\"match_parent\"\n                android:layout_height=\"140dp\"\n                android:layout_alignParentBottom=\"true\"\n                android:layout_marginBottom=\"40dp\" />\n\n            <RelativeLayout\n                android:id=\"@+id/bottom_layout\"\n                android:layout_width=\"match_parent\"\n                android:layout_height=\"wrap_content\"\n                android:layout_alignParentBottom=\"true\">\n\n                <!-- 底部操作栏 -->\n\n            </RelativeLayout>\n\n    </HorizontalFrameLayout>\n\n    <RelativeLayout\n        android:id=\"@+id/top_layout\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\">\n\n        <!--顶部主播信息与删除的布局-->\n\n    </RelativeLayout>\n\n</FrameLayout>\n```\n下面便来逐渐分析事件的分发。\n\n## 清屏操作与RecyclerView的滑动冲突\n需求中有``向右滑动清屏``的操作，向左滑动的时候恢复。\n我给整个布局``parent_layout``设置了OnTouchListener，图中弹幕是使用的RecyclerView，RecyclerView本身就会处理滑动，那么就只能滑动RecyclerView之外的地方才能进行清屏。但是这样的体验不好，因为清屏必须要滑动空白地方，因为弹幕的原因可能导致空白地方很小。如何处理好与RecyclerView的滑动冲突呢？项目中，弹幕只具有上下滑动的功能，是不具备左右滑动的，所以事件分发给RecyclerView实际上是没有任何作用的，那么便可以在左右滑动的时候拦截掉事件，从而不分发给RecyclerView，拦截掉之后，若便会执行``parent_layout``自身的OnTouchListener中的onTouch事件，在这个事件中做清屏的功能。\n拦截横滑代码：\n```\n@Override\npublic boolean onInterceptTouchEvent(MotionEvent ev) {\n    switch (ev.getAction()) {\n        case MotionEvent.ACTION_DOWN:\n            downX = ev.getRawX();\n            downY = ev.getRawY();\n            break;\n        case MotionEvent.ACTION_MOVE:\n            float moveX = ev.getRawX();\n            float moveY = ev.getRawY();\n            /**\n             * 如果是横滑，则拦截，用于清屏\n             * 如果不是则直接将事件传递\n             */\n            if (Math.abs(moveX - downX) > Math.abs(moveY - downY)) {\n                return true;\n            }\n            break;\n    }\n    return super.onInterceptTouchEvent(ev);\n}\n```\n设置的OnTouchListener：\n```\nclass LiveGestureListener extends GestureDetector.SimpleOnGestureListener implements View.OnTouchListener {\n\n    Context context;\n    GestureDetector gestureDetector;\n\n    public LiveGestureListener(Context context) {\n        this(context, null);\n    }\n\n    public LiveGestureListener(Context context, GestureDetector detector) {\n        if (detector == null) {\n            detector = new GestureDetector(context, this);\n        }\n\n        this.context = context;\n        this.gestureDetector = detector;\n    }\n\n    @Override\n    public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {\n\n        if (velocityX >= 0) {\n            hideInteractLayout();\n        } else if (velocityX < 0) {\n            showInteractLayout();\n        }\n\n        return super.onFling(e1, e2, velocityX, velocityY);\n    }\n\n    @Override\n    public boolean onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY) {\n\n\n        return super.onScroll(e1, e2, distanceX, distanceY);\n    }\n\n    @Override\n    public boolean onSingleTapConfirmed(MotionEvent e) {\n        return super.onSingleTapConfirmed(e);\n    }\n\n    @Override\n    public boolean onTouch(View v, MotionEvent event) {\n        // Within the MyGestureListener class you can now manage the event.getAction() codes.\n\n        // Note that we are now calling the gesture Detectors onTouchEvent. And given we've set this class as the GestureDetectors listener\n        // the onFling, onSingleTap etc methods will be executed.\n        return gestureDetector.onTouchEvent(event);\n    }\n\n    public GestureDetector getGestureDetector() {\n        return gestureDetector;\n    }\n}\n```\n结合手势在``onFling``中做了清屏与恢复的功能。\n\n## 整个页面的空白处\n布局层次中可以看到``top_layout``是单独出来的，并且在FrameLayout的顶层。\n详细说明一下：\n1、清屏只清屏``parent_layout``中的内容，``top_layout``是不需要隐藏的，所以单独提了出来。\n2、在顶层是为了提前消费事件，FrameLayout接到事件后会优先分发给顶层的孩子，即``top_layout``，若``top_layout``消费了，即点击了关闭或者主播信息等有消费事件的View，那么就不算是点击``空白处``了，事件便不会分发给``parent_layout``；若``top_layout``没消费，即点击了``空白处``，则会将事件分发给``parent_layout``，``parent_layout``便是我们自定义的FrameLayout，重写onTouchEvent，执行弹出状态栏的操作便可实现需求。\n```\n@Override\npublic boolean onTouchEvent(MotionEvent event) {\n    /**\n     * 若是单纯的点击，并且没有其他View消费事件，则调用onClickEvent（用于显示或隐藏状态栏）\n     */\n    switch (event.getAction()) {\n        case MotionEvent.ACTION_DOWN:\n            interceptX = event.getRawX();\n            interceptY = event.getRawY();\n            return true;\n        case MotionEvent.ACTION_UP:\n            float moveX = event.getRawX();\n            float moveY = event.getRawY();\n            if ((Math.abs(moveX - interceptX) < 20) && (Math.abs(moveY - interceptY) < 20)) {\n                if (listener != null) {\n                    listener.onClickEvent(event);\n                }\n            }\n            break;\n    }\n    return super.onTouchEvent(event);\n}\n\npublic interface DealClickEventListener {\n    void onClickEvent(MotionEvent event);\n}\n```\n我们必须在ACTION_DOWN的时候返回true，才会继续收到ACTION_MOVE、ACTION_UP等事件，否则是收不到的。至于为什么，可以参考我之前的一篇博客[Android事件分发机制学习小记](http://lastwarmth.site/2015/11/14/touch-event/)。\n我们再ACTION_UP的时候执行我们弹出状态栏的操作即可。\n```\nholder.interactLayout.setListener(new HorizontalFrameLayout.DealClickEventListener() {\n    @Override\n    public void onClickEvent(MotionEvent event) {\n        if (!isShowing) {\n            showOperation();\n        } else {\n            handler.removeCallbacks(showOrHide);\n            handler.postDelayed(showOrHide, 5000);\n        }\n    }\n});\n```\n\n最后上一下``HorizontalFrameLayout``的完整代码:\n```\npublic class HorizontalFrameLayout extends FrameLayout {\n\n    private float downX;\n    private float downY;\n    private float interceptX;\n    private float interceptY;\n    private DealClickEventListener listener;\n\n    public HorizontalFrameLayout(Context context) {\n        super(context);\n    }\n\n    public HorizontalFrameLayout(Context context, AttributeSet attrs) {\n        super(context, attrs);\n    }\n\n    public HorizontalFrameLayout(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n    }\n\n    public void setListener(DealClickEventListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    public boolean onInterceptTouchEvent(MotionEvent ev) {\n        switch (ev.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                downX = ev.getRawX();\n                downY = ev.getRawY();\n                break;\n            case MotionEvent.ACTION_MOVE:\n                float moveX = ev.getRawX();\n                float moveY = ev.getRawY();\n                /**\n                 * 如果是横滑，则拦截，用于清屏\n                 * 如果不是则直接将事件传递\n                 */\n                if (Math.abs(moveX - downX) > Math.abs(moveY - downY)) {\n                    return true;\n                }\n                break;\n        }\n        return super.onInterceptTouchEvent(ev);\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent event) {\n        /**\n         * 若是单纯的点击，并且没有其他View消费事件，则调用onClickEvent（用于显示或隐藏状态栏）\n         */\n        switch (event.getAction()) {\n            case MotionEvent.ACTION_DOWN:\n                interceptX = event.getRawX();\n                interceptY = event.getRawY();\n                return true;\n            case MotionEvent.ACTION_UP:\n                float moveX = event.getRawX();\n                float moveY = event.getRawY();\n                if ((Math.abs(moveX - interceptX) < 20) && (Math.abs(moveY - interceptY) < 20)) {\n                    if (listener != null) {\n                        listener.onClickEvent(event);\n                    }\n                }\n                break;\n        }\n        return super.onTouchEvent(event);\n    }\n\n    public interface DealClickEventListener {\n        void onClickEvent(MotionEvent event);\n    }\n}\n```\n\n## 题外话\n在我的另一篇博客[一个关于Android滑动“因缺斯厅”的想法](http://lastwarmth.site/2016/04/22/android-scroll/)中说到一个点，顶部布局采用透明的，那么便会引发一个问题：需要透传``关注``按钮的点击事件，因为透明布局是在顶部，会拦截掉点击事件，需要透传才能执行关注的响应事件。\n```\npublic class CustomRecyclerView extends RecyclerView {\n\n    private View view;\n\n    public CustomRecyclerView(Context context) {\n        super(context);\n    }\n\n    public CustomRecyclerView(Context context, @Nullable AttributeSet attrs) {\n        super(context, attrs);\n    }\n\n    public void setView(View view) {\n        this.view = view;\n    }\n\n    @Override\n    public boolean onTouchEvent(MotionEvent e) {\n        if (view != null) {\n            final float downX = e.getX();\n            final float downY = e.getY();\n            int firstVisiblePosition = ((LinearLayoutManager) getLayoutManager()).findFirstVisibleItemPosition();\n            if (firstVisiblePosition > 0) {\n                return super.onTouchEvent(e);\n            } else {\n                View c = getLayoutManager().findViewByPosition(0);\n                int top = c.getTop();\n                float scrollY = -top;\n                if (downX >= view.getLeft() && downX <= view.getRight() && downY <= view.getBottom() && downY >= view.getTop() && scrollY < view.getHeight()) {\n                    return false;\n                } else {\n                    return super.onTouchEvent(e);\n                }\n            }\n\n        }\n        return super.onTouchEvent(e);\n    }\n}\n```\n通过调用``setView``设置需要透传的View，通过判断点击的位置是否在View的范围内，以及RecyclerView滑动的高度是否已经高过``关注按钮的高度``，通过返回false，便可以将事件透传下去了。\n","slug":"touchevent","published":1,"updated":"2016-11-21T10:03:53.303Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75ah00371cb8uoky4izi","content":"<p>项目开发中，碰到这样一个情形：在点击页面空白处时会弹出状态栏，效果就如我<a href=\"http://lastwarmth.site/2016/08/04/statusbar/\" target=\"_blank\" rel=\"external\">上一篇博客</a>一样。<br>那么何为空白处呢？<br>我的理解是：若是你这个点击事件没有其他View消费，那么便算是点击空白处了。<br>大致画一下页面布局：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/08/touchevent1.png\" alt=\"\"><br>那么在点击图中画框的其他地方，应该都能算上是空白处了，也就是在点击这些地方的时候，需要执行状态栏弹出的操作。</p>\n<a id=\"more\"></a>\n<p>大致说一下页面布局的层次结构：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">xmlns:tools</span>=<span class=\"string\">\"http://schemas.android.com/tools\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">tools:context</span>=<span class=\"string\">\"com.miamusic.android.live.ui.RoomActivity\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">&lt;!-- 最底层的摄像画面 --&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">SurfaceView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/surfaceview\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">HorizontalFrameLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/parent_layout\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">&lt;!-- 弹幕 --&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">android.support.v7.widget.RecyclerView</span></span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/barrage_layout\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"140dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_alignParentBottom</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_marginBottom</span>=<span class=\"string\">\"40dp\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">RelativeLayout</span></span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/bottom_layout\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_alignParentBottom</span>=<span class=\"string\">\"true\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">&lt;!-- 底部操作栏 --&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">RelativeLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">HorizontalFrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">RelativeLayout</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/top_layout\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">&lt;!--顶部主播信息与删除的布局--&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">RelativeLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>下面便来逐渐分析事件的分发。</p>\n<h2 id=\"清屏操作与RecyclerView的滑动冲突\"><a href=\"#清屏操作与RecyclerView的滑动冲突\" class=\"headerlink\" title=\"清屏操作与RecyclerView的滑动冲突\"></a>清屏操作与RecyclerView的滑动冲突</h2><p>需求中有<code>向右滑动清屏</code>的操作，向左滑动的时候恢复。<br>我给整个布局<code>parent_layout</code>设置了OnTouchListener，图中弹幕是使用的RecyclerView，RecyclerView本身就会处理滑动，那么就只能滑动RecyclerView之外的地方才能进行清屏。但是这样的体验不好，因为清屏必须要滑动空白地方，因为弹幕的原因可能导致空白地方很小。如何处理好与RecyclerView的滑动冲突呢？项目中，弹幕只具有上下滑动的功能，是不具备左右滑动的，所以事件分发给RecyclerView实际上是没有任何作用的，那么便可以在左右滑动的时候拦截掉事件，从而不分发给RecyclerView，拦截掉之后，若便会执行<code>parent_layout</code>自身的OnTouchListener中的onTouch事件，在这个事件中做清屏的功能。<br>拦截横滑代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">switch</span> (ev.getAction()) &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">            downX = ev.getRawX();</div><div class=\"line\">            downY = ev.getRawY();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">            <span class=\"keyword\">float</span> moveX = ev.getRawX();</div><div class=\"line\">            <span class=\"keyword\">float</span> moveY = ev.getRawY();</div><div class=\"line\">            <span class=\"comment\">/**</span></div><div class=\"line\">             * 如果是横滑，则拦截，用于清屏</div><div class=\"line\">             * 如果不是则直接将事件传递</div><div class=\"line\">             */</div><div class=\"line\">            <span class=\"keyword\">if</span> (Math.abs(moveX - downX) &gt; Math.abs(moveY - downY)) &#123;</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>设置的OnTouchListener：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LiveGestureListener</span> <span class=\"keyword\">extends</span> <span class=\"title\">GestureDetector</span>.<span class=\"title\">SimpleOnGestureListener</span> <span class=\"keyword\">implements</span> <span class=\"title\">View</span>.<span class=\"title\">OnTouchListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    Context context;</div><div class=\"line\">    GestureDetector gestureDetector;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LiveGestureListener</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>(context, <span class=\"keyword\">null</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LiveGestureListener</span><span class=\"params\">(Context context, GestureDetector detector)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (detector == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            detector = <span class=\"keyword\">new</span> GestureDetector(context, <span class=\"keyword\">this</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">this</span>.context = context;</div><div class=\"line\">        <span class=\"keyword\">this</span>.gestureDetector = detector;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onFling</span><span class=\"params\">(MotionEvent e1, MotionEvent e2, <span class=\"keyword\">float</span> velocityX, <span class=\"keyword\">float</span> velocityY)</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (velocityX &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            hideInteractLayout();</div><div class=\"line\">        &#125; <span class=\"function\"><span class=\"keyword\">else</span> <span class=\"title\">if</span> <span class=\"params\">(velocityX &lt; <span class=\"number\">0</span>)</span> </span>&#123;</div><div class=\"line\">            showInteractLayout();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onFling</span><span class=\"params\">(e1, e2, velocityX, velocityY)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onScroll</span><span class=\"params\">(MotionEvent e1, MotionEvent e2, <span class=\"keyword\">float</span> distanceX, <span class=\"keyword\">float</span> distanceY)</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onScroll</span><span class=\"params\">(e1, e2, distanceX, distanceY)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onSingleTapConfirmed</span><span class=\"params\">(MotionEvent e)</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onSingleTapConfirmed</span><span class=\"params\">(e)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouch</span><span class=\"params\">(View v, MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Within the MyGestureListener class you can now manage the event.getAction() codes.</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Note that we are now calling the gesture Detectors onTouchEvent. And given we've set this class as the GestureDetectors listener</span></div><div class=\"line\">        <span class=\"comment\">// the onFling, onSingleTap etc methods will be executed.</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> gestureDetector.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\">GestureDetector <span class=\"title\">getGestureDetector</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> gestureDetector;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>结合手势在<code>onFling</code>中做了清屏与恢复的功能。</p>\n<h2 id=\"整个页面的空白处\"><a href=\"#整个页面的空白处\" class=\"headerlink\" title=\"整个页面的空白处\"></a>整个页面的空白处</h2><p>布局层次中可以看到<code>top_layout</code>是单独出来的，并且在FrameLayout的顶层。<br>详细说明一下：<br>1、清屏只清屏<code>parent_layout</code>中的内容，<code>top_layout</code>是不需要隐藏的，所以单独提了出来。<br>2、在顶层是为了提前消费事件，FrameLayout接到事件后会优先分发给顶层的孩子，即<code>top_layout</code>，若<code>top_layout</code>消费了，即点击了关闭或者主播信息等有消费事件的View，那么就不算是点击<code>空白处</code>了，事件便不会分发给<code>parent_layout</code>；若<code>top_layout</code>没消费，即点击了<code>空白处</code>，则会将事件分发给<code>parent_layout</code>，<code>parent_layout</code>便是我们自定义的FrameLayout，重写onTouchEvent，执行弹出状态栏的操作便可实现需求。<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">@<span class=\"function\">Override</span></div><div class=\"line\"><span class=\"keyword\">public</span> boolean <span class=\"title\">onTouchEvent</span>(<span class=\"params\">MotionEvent <span class=\"keyword\">event</span></span>) &#123;</div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 若是单纯的点击，并且没有其他View消费事件，则调用onClickEvent（用于显示或隐藏状态栏）</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"keyword\">switch</span> (<span class=\"keyword\">event</span>.getAction()) &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">            interceptX = <span class=\"keyword\">event</span>.getRawX();</div><div class=\"line\">            interceptY = <span class=\"keyword\">event</span>.getRawY();</div><div class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">            <span class=\"keyword\">float</span> moveX = <span class=\"keyword\">event</span>.getRawX();</div><div class=\"line\">            <span class=\"keyword\">float</span> moveY = <span class=\"keyword\">event</span>.getRawY();</div><div class=\"line\">            <span class=\"keyword\">if</span> ((Math.abs(moveX - interceptX) &lt; <span class=\"number\">20</span>) &amp;&amp; (Math.abs(moveY - interceptY) &lt; <span class=\"number\">20</span>)) &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (listener != <span class=\"literal\">null</span>) &#123;</div><div class=\"line\">                    listener.onClickEvent(<span class=\"keyword\">event</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> super.onTouchEvent(<span class=\"keyword\">event</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">DealClickEventListener</span> &#123;</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClickEvent</span>(<span class=\"params\">MotionEvent <span class=\"keyword\">event</span></span>)</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>我们必须在ACTION_DOWN的时候返回true，才会继续收到ACTION_MOVE、ACTION_UP等事件，否则是收不到的。至于为什么，可以参考我之前的一篇博客<a href=\"http://lastwarmth.site/2015/11/14/touch-event/\" target=\"_blank\" rel=\"external\">Android事件分发机制学习小记</a>。<br>我们再ACTION_UP的时候执行我们弹出状态栏的操作即可。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">holder.interactLayout.setListener(<span class=\"keyword\">new</span> HorizontalFrameLayout.DealClickEventListener() &#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClickEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (!isShowing) &#123;</div><div class=\"line\">            showOperation();</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">handler</span>.removeCallbacks(showOrHide);</div><div class=\"line\">            <span class=\"keyword\">handler</span>.postDelayed(showOrHide, <span class=\"number\">5000</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>最后上一下<code>HorizontalFrameLayout</code>的完整代码:<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HorizontalFrameLayout</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrameLayout</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> downX;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> downY;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> interceptX;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> interceptY;</div><div class=\"line\">    <span class=\"keyword\">private</span> DealClickEventListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HorizontalFrameLayout</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HorizontalFrameLayout</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HorizontalFrameLayout</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(DealClickEventListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (ev.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                downX = ev.getRawX();</div><div class=\"line\">                downY = ev.getRawY();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = ev.getRawX();</div><div class=\"line\">                <span class=\"keyword\">float</span> moveY = ev.getRawY();</div><div class=\"line\">                <span class=\"comment\">/**</span></div><div class=\"line\">                 * 如果是横滑，则拦截，用于清屏</div><div class=\"line\">                 * 如果不是则直接将事件传递</div><div class=\"line\">                 */</div><div class=\"line\">                <span class=\"keyword\">if</span> (Math.abs(moveX - downX) &gt; Math.abs(moveY - downY)) &#123;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">/**</span></div><div class=\"line\">         * 若是单纯的点击，并且没有其他View消费事件，则调用onClickEvent（用于显示或隐藏状态栏）</div><div class=\"line\">         */</div><div class=\"line\">        <span class=\"keyword\">switch</span> (event.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                interceptX = event.getRawX();</div><div class=\"line\">                interceptY = event.getRawY();</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = event.getRawX();</div><div class=\"line\">                <span class=\"keyword\">float</span> moveY = event.getRawY();</div><div class=\"line\">                <span class=\"keyword\">if</span> ((Math.abs(moveX - interceptX) &lt; <span class=\"number\">20</span>) &amp;&amp; (Math.abs(moveY - interceptY) &lt; <span class=\"number\">20</span>)) &#123;</div><div class=\"line\">                    <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        listener.onClickEvent(event);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">DealClickEventListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClickEvent</span><span class=\"params\">(MotionEvent event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"题外话\"><a href=\"#题外话\" class=\"headerlink\" title=\"题外话\"></a>题外话</h2><p>在我的另一篇博客<a href=\"http://lastwarmth.site/2016/04/22/android-scroll/\" target=\"_blank\" rel=\"external\">一个关于Android滑动“因缺斯厅”的想法</a>中说到一个点，顶部布局采用透明的，那么便会引发一个问题：需要透传<code>关注</code>按钮的点击事件，因为透明布局是在顶部，会拦截掉点击事件，需要透传才能执行关注的响应事件。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomRecyclerView</span> <span class=\"keyword\">extends</span> <span class=\"title\">RecyclerView</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> View view;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomRecyclerView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomRecyclerView</span><span class=\"params\">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setView</span><span class=\"params\">(View view)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.view = view;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent e)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (view != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">float</span> downX = e.getX();</div><div class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">float</span> downY = e.getY();</div><div class=\"line\">            <span class=\"keyword\">int</span> firstVisiblePosition = ((LinearLayoutManager) getLayoutManager()).findFirstVisibleItemPosition();</div><div class=\"line\">            <span class=\"keyword\">if</span> (firstVisiblePosition &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(e)</span></span>;</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                View c = getLayoutManager().findViewByPosition(<span class=\"number\">0</span>);</div><div class=\"line\">                <span class=\"keyword\">int</span> top = c.getTop();</div><div class=\"line\">                <span class=\"keyword\">float</span> scrollY = -top;</div><div class=\"line\">                <span class=\"keyword\">if</span> (downX &gt;= view.getLeft() &amp;&amp; downX &lt;= view.getRight() &amp;&amp; downY &lt;= view.getBottom() &amp;&amp; downY &gt;= view.getTop() &amp;&amp; scrollY &lt; view.getHeight()) &#123;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(e)</span></span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(e)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过调用<code>setView</code>设置需要透传的View，通过判断点击的位置是否在View的范围内，以及RecyclerView滑动的高度是否已经高过<code>关注按钮的高度</code>，通过返回false，便可以将事件透传下去了。</p>\n","excerpt":"<p>项目开发中，碰到这样一个情形：在点击页面空白处时会弹出状态栏，效果就如我<a href=\"http://lastwarmth.site/2016/08/04/statusbar/\">上一篇博客</a>一样。<br>那么何为空白处呢？<br>我的理解是：若是你这个点击事件没有其他View消费，那么便算是点击空白处了。<br>大致画一下页面布局：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/08/touchevent1.png\" alt=\"\"><br>那么在点击图中画框的其他地方，应该都能算上是空白处了，也就是在点击这些地方的时候，需要执行状态栏弹出的操作。</p>","more":"<p>大致说一下页面布局的层次结构：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">xmlns:tools</span>=<span class=\"string\">\"http://schemas.android.com/tools\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">tools:context</span>=<span class=\"string\">\"com.miamusic.android.live.ui.RoomActivity\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">&lt;!-- 最底层的摄像画面 --&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">SurfaceView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/surfaceview\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">HorizontalFrameLayout</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/parent_layout\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"comment\">&lt;!-- 弹幕 --&gt;</span></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">android.support.v7.widget.RecyclerView</span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/barrage_layout\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"140dp\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_alignParentBottom</span>=<span class=\"string\">\"true\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_marginBottom</span>=<span class=\"string\">\"40dp\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">RelativeLayout</span></div><div class=\"line\">                <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/bottom_layout\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"wrap_content\"</span></div><div class=\"line\">                <span class=\"attr\">android:layout_alignParentBottom</span>=<span class=\"string\">\"true\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">                <span class=\"comment\">&lt;!-- 底部操作栏 --&gt;</span></div><div class=\"line\"></div><div class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">RelativeLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">HorizontalFrameLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">RelativeLayout</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/top_layout\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">&lt;!--顶部主播信息与删除的布局--&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">RelativeLayout</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>下面便来逐渐分析事件的分发。</p>\n<h2 id=\"清屏操作与RecyclerView的滑动冲突\"><a href=\"#清屏操作与RecyclerView的滑动冲突\" class=\"headerlink\" title=\"清屏操作与RecyclerView的滑动冲突\"></a>清屏操作与RecyclerView的滑动冲突</h2><p>需求中有<code>向右滑动清屏</code>的操作，向左滑动的时候恢复。<br>我给整个布局<code>parent_layout</code>设置了OnTouchListener，图中弹幕是使用的RecyclerView，RecyclerView本身就会处理滑动，那么就只能滑动RecyclerView之外的地方才能进行清屏。但是这样的体验不好，因为清屏必须要滑动空白地方，因为弹幕的原因可能导致空白地方很小。如何处理好与RecyclerView的滑动冲突呢？项目中，弹幕只具有上下滑动的功能，是不具备左右滑动的，所以事件分发给RecyclerView实际上是没有任何作用的，那么便可以在左右滑动的时候拦截掉事件，从而不分发给RecyclerView，拦截掉之后，若便会执行<code>parent_layout</code>自身的OnTouchListener中的onTouch事件，在这个事件中做清屏的功能。<br>拦截横滑代码：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">switch</span> (ev.getAction()) &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">            downX = ev.getRawX();</div><div class=\"line\">            downY = ev.getRawY();</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">            <span class=\"keyword\">float</span> moveX = ev.getRawX();</div><div class=\"line\">            <span class=\"keyword\">float</span> moveY = ev.getRawY();</div><div class=\"line\">            <span class=\"comment\">/**</div><div class=\"line\">             * 如果是横滑，则拦截，用于清屏</div><div class=\"line\">             * 如果不是则直接将事件传递</div><div class=\"line\">             */</span></div><div class=\"line\">            <span class=\"keyword\">if</span> (Math.abs(moveX - downX) &gt; Math.abs(moveY - downY)) &#123;</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>设置的OnTouchListener：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LiveGestureListener</span> <span class=\"keyword\">extends</span> <span class=\"title\">GestureDetector</span>.<span class=\"title\">SimpleOnGestureListener</span> <span class=\"keyword\">implements</span> <span class=\"title\">View</span>.<span class=\"title\">OnTouchListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    Context context;</div><div class=\"line\">    GestureDetector gestureDetector;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LiveGestureListener</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>(context, <span class=\"keyword\">null</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LiveGestureListener</span><span class=\"params\">(Context context, GestureDetector detector)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (detector == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            detector = <span class=\"keyword\">new</span> GestureDetector(context, <span class=\"keyword\">this</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">this</span>.context = context;</div><div class=\"line\">        <span class=\"keyword\">this</span>.gestureDetector = detector;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onFling</span><span class=\"params\">(MotionEvent e1, MotionEvent e2, <span class=\"keyword\">float</span> velocityX, <span class=\"keyword\">float</span> velocityY)</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (velocityX &gt;= <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            hideInteractLayout();</div><div class=\"line\">        &#125; <span class=\"function\"><span class=\"keyword\">else</span> <span class=\"title\">if</span> <span class=\"params\">(velocityX &lt; <span class=\"number\">0</span>)</span> </span>&#123;</div><div class=\"line\">            showInteractLayout();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onFling</span><span class=\"params\">(e1, e2, velocityX, velocityY)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onScroll</span><span class=\"params\">(MotionEvent e1, MotionEvent e2, <span class=\"keyword\">float</span> distanceX, <span class=\"keyword\">float</span> distanceY)</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onScroll</span><span class=\"params\">(e1, e2, distanceX, distanceY)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onSingleTapConfirmed</span><span class=\"params\">(MotionEvent e)</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onSingleTapConfirmed</span><span class=\"params\">(e)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouch</span><span class=\"params\">(View v, MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Within the MyGestureListener class you can now manage the event.getAction() codes.</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Note that we are now calling the gesture Detectors onTouchEvent. And given we've set this class as the GestureDetectors listener</span></div><div class=\"line\">        <span class=\"comment\">// the onFling, onSingleTap etc methods will be executed.</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> gestureDetector.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\">GestureDetector <span class=\"title\">getGestureDetector</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> gestureDetector;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>结合手势在<code>onFling</code>中做了清屏与恢复的功能。</p>\n<h2 id=\"整个页面的空白处\"><a href=\"#整个页面的空白处\" class=\"headerlink\" title=\"整个页面的空白处\"></a>整个页面的空白处</h2><p>布局层次中可以看到<code>top_layout</code>是单独出来的，并且在FrameLayout的顶层。<br>详细说明一下：<br>1、清屏只清屏<code>parent_layout</code>中的内容，<code>top_layout</code>是不需要隐藏的，所以单独提了出来。<br>2、在顶层是为了提前消费事件，FrameLayout接到事件后会优先分发给顶层的孩子，即<code>top_layout</code>，若<code>top_layout</code>消费了，即点击了关闭或者主播信息等有消费事件的View，那么就不算是点击<code>空白处</code>了，事件便不会分发给<code>parent_layout</code>；若<code>top_layout</code>没消费，即点击了<code>空白处</code>，则会将事件分发给<code>parent_layout</code>，<code>parent_layout</code>便是我们自定义的FrameLayout，重写onTouchEvent，执行弹出状态栏的操作便可实现需求。<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">@<span class=\"function\">Override</div><div class=\"line\"><span class=\"keyword\">public</span> boolean <span class=\"title\">onTouchEvent</span>(<span class=\"params\">MotionEvent <span class=\"keyword\">event</span></span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 若是单纯的点击，并且没有其他View消费事件，则调用onClickEvent（用于显示或隐藏状态栏）</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"keyword\">switch</span> (<span class=\"keyword\">event</span>.getAction()) &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">            interceptX = <span class=\"keyword\">event</span>.getRawX();</div><div class=\"line\">            interceptY = <span class=\"keyword\">event</span>.getRawY();</div><div class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">        <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">            <span class=\"keyword\">float</span> moveX = <span class=\"keyword\">event</span>.getRawX();</div><div class=\"line\">            <span class=\"keyword\">float</span> moveY = <span class=\"keyword\">event</span>.getRawY();</div><div class=\"line\">            <span class=\"keyword\">if</span> ((Math.abs(moveX - interceptX) &lt; <span class=\"number\">20</span>) &amp;&amp; (Math.abs(moveY - interceptY) &lt; <span class=\"number\">20</span>)) &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (listener != <span class=\"literal\">null</span>) &#123;</div><div class=\"line\">                    listener.onClickEvent(<span class=\"keyword\">event</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> super.onTouchEvent(<span class=\"keyword\">event</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">DealClickEventListener</span> &#123;</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClickEvent</span>(<span class=\"params\">MotionEvent <span class=\"keyword\">event</span></span>)</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>我们必须在ACTION_DOWN的时候返回true，才会继续收到ACTION_MOVE、ACTION_UP等事件，否则是收不到的。至于为什么，可以参考我之前的一篇博客<a href=\"http://lastwarmth.site/2015/11/14/touch-event/\">Android事件分发机制学习小记</a>。<br>我们再ACTION_UP的时候执行我们弹出状态栏的操作即可。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">holder.interactLayout.setListener(<span class=\"keyword\">new</span> HorizontalFrameLayout.DealClickEventListener() &#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClickEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (!isShowing) &#123;</div><div class=\"line\">            showOperation();</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">handler</span>.removeCallbacks(showOrHide);</div><div class=\"line\">            <span class=\"keyword\">handler</span>.postDelayed(showOrHide, <span class=\"number\">5000</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>最后上一下<code>HorizontalFrameLayout</code>的完整代码:<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HorizontalFrameLayout</span> <span class=\"keyword\">extends</span> <span class=\"title\">FrameLayout</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> downX;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> downY;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> interceptX;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">float</span> interceptY;</div><div class=\"line\">    <span class=\"keyword\">private</span> DealClickEventListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HorizontalFrameLayout</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HorizontalFrameLayout</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HorizontalFrameLayout</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(DealClickEventListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">switch</span> (ev.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                downX = ev.getRawX();</div><div class=\"line\">                downY = ev.getRawY();</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_MOVE:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = ev.getRawX();</div><div class=\"line\">                <span class=\"keyword\">float</span> moveY = ev.getRawY();</div><div class=\"line\">                <span class=\"comment\">/**</div><div class=\"line\">                 * 如果是横滑，则拦截，用于清屏</div><div class=\"line\">                 * 如果不是则直接将事件传递</div><div class=\"line\">                 */</span></div><div class=\"line\">                <span class=\"keyword\">if</span> (Math.abs(moveX - downX) &gt; Math.abs(moveY - downY)) &#123;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onInterceptTouchEvent</span><span class=\"params\">(ev)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent event)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">/**</div><div class=\"line\">         * 若是单纯的点击，并且没有其他View消费事件，则调用onClickEvent（用于显示或隐藏状态栏）</div><div class=\"line\">         */</span></div><div class=\"line\">        <span class=\"keyword\">switch</span> (event.getAction()) &#123;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_DOWN:</div><div class=\"line\">                interceptX = event.getRawX();</div><div class=\"line\">                interceptY = event.getRawY();</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">            <span class=\"keyword\">case</span> MotionEvent.ACTION_UP:</div><div class=\"line\">                <span class=\"keyword\">float</span> moveX = event.getRawX();</div><div class=\"line\">                <span class=\"keyword\">float</span> moveY = event.getRawY();</div><div class=\"line\">                <span class=\"keyword\">if</span> ((Math.abs(moveX - interceptX) &lt; <span class=\"number\">20</span>) &amp;&amp; (Math.abs(moveY - interceptY) &lt; <span class=\"number\">20</span>)) &#123;</div><div class=\"line\">                    <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        listener.onClickEvent(event);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">DealClickEventListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onClickEvent</span><span class=\"params\">(MotionEvent event)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"题外话\"><a href=\"#题外话\" class=\"headerlink\" title=\"题外话\"></a>题外话</h2><p>在我的另一篇博客<a href=\"http://lastwarmth.site/2016/04/22/android-scroll/\">一个关于Android滑动“因缺斯厅”的想法</a>中说到一个点，顶部布局采用透明的，那么便会引发一个问题：需要透传<code>关注</code>按钮的点击事件，因为透明布局是在顶部，会拦截掉点击事件，需要透传才能执行关注的响应事件。<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomRecyclerView</span> <span class=\"keyword\">extends</span> <span class=\"title\">RecyclerView</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> View view;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomRecyclerView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomRecyclerView</span><span class=\"params\">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setView</span><span class=\"params\">(View view)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.view = view;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">onTouchEvent</span><span class=\"params\">(MotionEvent e)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (view != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">float</span> downX = e.getX();</div><div class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">float</span> downY = e.getY();</div><div class=\"line\">            <span class=\"keyword\">int</span> firstVisiblePosition = ((LinearLayoutManager) getLayoutManager()).findFirstVisibleItemPosition();</div><div class=\"line\">            <span class=\"keyword\">if</span> (firstVisiblePosition &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">                <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(e)</span></span>;</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                View c = getLayoutManager().findViewByPosition(<span class=\"number\">0</span>);</div><div class=\"line\">                <span class=\"keyword\">int</span> top = c.getTop();</div><div class=\"line\">                <span class=\"keyword\">float</span> scrollY = -top;</div><div class=\"line\">                <span class=\"keyword\">if</span> (downX &gt;= view.getLeft() &amp;&amp; downX &lt;= view.getRight() &amp;&amp; downY &lt;= view.getBottom() &amp;&amp; downY &gt;= view.getTop() &amp;&amp; scrollY &lt; view.getHeight()) &#123;</div><div class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                    <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(e)</span></span>;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.<span class=\"title\">onTouchEvent</span><span class=\"params\">(e)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>通过调用<code>setView</code>设置需要透传的View，通过判断点击的位置是否在View的范围内，以及RecyclerView滑动的高度是否已经高过<code>关注按钮的高度</code>，通过返回false，便可以将事件透传下去了。</p>"},{"title":"Android实现任务队列：一个入口一个出口、一个入口两个出口","date":"2016-05-27T07:11:25.000Z","_content":"\n## 前言\n在我的[Android实现简易轻量下载器：单线程任务队列](http://lastwarmth.site/2016/02/23/single-thread-queue/)文章中，有提到过任务队列。当时是需要下载，实现一个简单的单线程任务队列即可。\n最近项目中也需要用到任务队列，并且有2种需求：\n1. 动态礼物动画：在用户送完动态礼物之后，会在界面上展现一个动画。界面上一次最多能执行1个动画，动画按顺序执行。即：``一个入口一个出口``。\n2. 静态礼物动画：在用户送完静态礼物之后，会在界面上展现一个动画。界面上一次最多能并列执行2个动画，动画按顺序执行。即：``一个入口两个出口``。\n同样都是任务队列，只不过一个是只有一个出口，另一个有两个出口。\n\n<!-- more -->\n\n## 动态礼物动画\n参照着之前那篇文章，很快就写出来了。\n动态礼物单体类``DynamicGiftModel``：\n```\npublic class DynamicGiftModel implements GiftModel {\n\n    private GifImageView gifImageView;\n    private GifDrawable gifDrawable;\n    private DynamicGiftListener listener;\n\n    public DynamicGiftModel(GifDrawable gifDrawable, GifImageView gifImageView, DynamicGiftListener listener) {\n        this.gifDrawable = gifDrawable;\n        this.gifImageView = gifImageView;\n        this.listener = listener;\n    }\n\n\n    @Override\n    public void startAnimation(final GiftAnimationEndListener nextListener) {\n        if (listener != null) {\n            listener.beforeDynamicAnimation();\n        }\n        gifImageView.setImageDrawable(gifDrawable);\n        gifDrawable.addAnimationListener(new AnimationListener() {\n            @Override\n            public void onAnimationCompleted(int loopNumber) {\n                if (loopNumber == (gifDrawable.getLoopCount() - 1)) {\n                    if (listener != null) {\n                        listener.afterDynamicAnimation();\n                    }\n                    gifDrawable.recycle();\n                    if (nextListener != null) {\n                        nextListener.onGiftAnimationEnd();\n                    }\n                }\n\n            }\n        });\n    }\n\n    public interface DynamicGiftListener {\n        void beforeDynamicAnimation();\n\n        void afterDynamicAnimation();\n    }\n}\n```\n动态礼物队列类``DynamicGift``:\n```\npublic class DynamicGift {\n\n    private static DynamicGift instance = new DynamicGift();\n    private DynamicGiftExecutor executor;\n\n    public static DynamicGift getInstance() {\n        if (instance == null) {\n            instance = new DynamicGift();\n        }\n\n        return instance;\n    }\n\n    private DynamicGift() {\n        executor = new DynamicGiftExecutor();\n    }\n\n    /**\n     * 动画队列，顺序执行\n     */\n    class DynamicGiftExecutor implements GiftAnimationEndListener {\n\n        final ArrayDeque<DynamicGiftModel> mTasks = new ArrayDeque<>();\n        DynamicGiftModel mActive;\n\n        public void execute(final DynamicGiftModel model) {\n            mTasks.offer(model);\n            if (mActive == null) {\n                scheduleNext();\n            }\n        }\n\n        protected synchronized void scheduleNext() {\n            if ((mActive = mTasks.poll()) != null) {\n                mActive.startAnimation(this);\n            }\n        }\n\n        @Override\n        public void onGiftAnimationEnd() {\n            scheduleNext();\n        }\n    }\n\n    /**\n     * 往队列中添加动画对象\n     *\n     * @param gifImageView imageView\n     * @param gifDrawable  gif图\n     * @param listener     监听\n     */\n    public void addGifAnimation(GifImageView gifImageView, GifDrawable gifDrawable, DynamicGiftModel.DynamicGiftListener listener) {\n        executor.execute(new DynamicGiftModel(gifDrawable, gifImageView, listener));\n    }\n}\n```\n说明一下：``GifImageView``就是用来播放gif的ImageView，``GifDrawable``就是gif对应的drawable，``DynamicGiftListener``就是动画执行前后的回调。\n可以看到，我们通过``execute()``将一个``DynamicGiftModel``任务放入到队列中，``DynamicGiftModel``调用``startAnimation()``便能开始动画了。``DynamicGiftExecutor``与那篇博客中的类似。只不过我这里做了一些修改：下载中使用的Runnable，他是同步的，在执行完之后会自动去取一下。但是在这里，动画执行是异步的，我在调用完``startAnimation()``之后就会立即返回，所以需要一个监听（GiftAnimationEndListener）在动画执行完毕之后才去执行``scheduleNext()``操作，即取下一个任务。\nGiftAnimationEndListener代码很简单：\n```\npublic interface GiftAnimationEndListener {\n    void onGiftAnimationEnd();\n}\n```\n\n调用如下代码将任务添加到队列便能顺序播放动画了。\n```\nDynamicGift.getInstance().addGifAnimation(gifImageView, gifDrawable, listener);\n```\n\n## 静态礼物动画\n静态礼物因为有两个出口，之前没思考过，所以花了一些时间。\n静态礼物单体类``DynamicGiftModel``:\n```\npublic class StaticGiftModel implements GiftModel {\n\n    private StaticGiftListener listener;\n    private PushGift gift;\n    private boolean over;\n\n    public StaticGiftModel(PushGift gift, StaticGiftListener listener) {\n        this.gift = gift;\n        this.listener = listener;\n    }\n\n    public boolean isOver() {\n        return over;\n    }\n\n    public void setOver(boolean over) {\n        this.over = over;\n    }\n\n    @Override\n    public void startAnimation(final GiftAnimationEndListener nextListener) {\n        if (listener != null) {\n            listener.startStaticAnimation(this, gift, nextListener);\n        }\n    }\n\n    public interface StaticGiftListener {\n        void startStaticAnimation(StaticGiftModel giftModel, PushGift gift, GiftAnimationEndListener nextListener);\n    }\n}\n```\n静态礼物队列类``StaticGift``：\n```\npublic class StaticGift {\n\n    private static StaticGift instance = new StaticGift();\n    private StaticGiftExecutor executor;\n\n    public static StaticGift getInstance() {\n        if (instance == null) {\n            instance = new StaticGift();\n        }\n\n        return instance;\n    }\n\n    private StaticGift() {\n        executor = new StaticGiftExecutor();\n    }\n\n    /**\n     * 动画队列，2个出口，顺序执行\n     */\n    class StaticGiftExecutor implements GiftAnimationEndListener {\n\n        final ArrayDeque<StaticGiftModel> mTasks = new ArrayDeque<>();\n        StaticGiftModel mActive1;\n        StaticGiftModel mActive2;\n\n        public void execute(final StaticGiftModel model) {\n            mTasks.offer(model);\n            if (mActive1 == null) {\n                mActive1 = mTasks.poll();\n                if (mActive1 != null) {\n                    mActive1.startAnimation(this);\n                }\n            } else if (mActive2 == null) {\n                mActive2 = mTasks.poll();\n                if (mActive2 != null) {\n                    mActive2.startAnimation(this);\n                }\n            }\n        }\n\n        @Override\n        public void onGiftAnimationEnd() {\n            if (mActive1 != null && mActive1.isOver()) {\n                mActive1 = mTasks.poll();\n                if (mActive1 != null) {\n                    mActive1.startAnimation(this);\n                }\n            }\n            if (mActive2 != null && mActive2.isOver()) {\n                mActive2 = mTasks.poll();\n                if (mActive2 != null) {\n                    mActive2.startAnimation(this);\n                }\n            }\n        }\n\n    }\n\n    /**\n     * 添加任务\n     *\n     * @param gift     推送的Gift内容\n     * @param listener 回调\n     */\n    public void addNumAnimation(PushGift gift, StaticGiftModel.StaticGiftListener listener) {\n        executor.execute(new StaticGiftModel(gift, listener));\n    }\n}\n```\n可以看到，我在``StaticGiftExecutor``中定义了2个变量``mActive1``、``mActive2``，他们即代表两个出口。在``execute``中先判断``mActive1``是否为空，是则取出元素给它，让它执行动画。否则判断``mActive2``是否为空，是则取出元素给它，让它执行动画。\n因为有两个出口，队列并不知道我的下一个任务要在哪个出口执行，所以具体的播放逻辑不能写在其中，所以我将具体的播放逻辑设计在``StaticGiftListener.startStaticAnimation()``的中，由调用的用户自行实现，并且在动画结束时，我需要回调队列的接口，来通知队列某某出口的动画执行完毕了。\n实现片段代码如下：\n```\n/**\n     * 执行静态礼物动画\n     *\n     * @param gift\n     * @param nextListener\n     */\n    @Override\n    public void startStaticAnimation(final StaticGiftModel giftModel, PushGift gift, final GiftAnimationEndListener nextListener) {\n        if (holder.staticLayout1.getVisibility() == View.GONE) {\n            holder.staticLayout1.setVisibility(View.VISIBLE);\n            holder.staticGiftUserNick1.setText(gift.getUserNick());\n            holder.staticGiftDesc1.setText(gift.getDescription());\n            showIcon(gift.getUserIcon(), holder.staticGiftUserIcon1);\n            // 获取对应礼物的本地下载路径\n            String fileName = CommonUtils.MD5(gift.getGiftIcon());\n            File savePath = new File(GiftManager.getInstance().getDownloadDir(), fileName);\n            String path = \"file://\" + savePath.getAbsolutePath();\n            ImageLoader.getInstance().displayImage(path, holder.staticGiftIcon1);\n            holder.staticGiftView1.setListener(new StaticGiftView.StaticGiftAnimationListener() {\n                @Override\n                public void onAnimationEnd() {\n                    holder.staticLayout1.setVisibility(View.GONE);\n                    giftModel.setOver(true);\n                    nextListener.onGiftAnimationEnd();\n                }\n            });\n            holder.staticGiftView1.setNum(Integer.valueOf(gift.getNum()));\n        } else if (holder.staticLayout2.getVisibility() == View.GONE) {\n            holder.staticLayout2.setVisibility(View.VISIBLE);\n            holder.staticGiftUserNick2.setText(gift.getUserNick());\n            holder.staticGiftDesc2.setText(gift.getDescription());\n            showIcon(gift.getUserIcon(), holder.staticGiftUserIcon2);\n            // 获取对应礼物的本地下载路径\n            String fileName = CommonUtils.MD5(gift.getGiftIcon());\n            File savePath = new File(GiftManager.getInstance().getDownloadDir(), fileName);\n            String path = \"file://\" + savePath.getAbsolutePath();\n            ImageLoader.getInstance().displayImage(path, holder.staticGiftIcon2);\n            holder.staticGiftView2.setListener(new StaticGiftView.StaticGiftAnimationListener() {\n                @Override\n                public void onAnimationEnd() {\n                    holder.staticLayout2.setVisibility(View.GONE);\n                    giftModel.setOver(true);\n                    nextListener.onGiftAnimationEnd();\n                }\n            });\n            holder.staticGiftView2.setNum(Integer.valueOf(gift.getNum()));\n        }\n    }\n```\n静态礼物动画实现类StaticGiftView：\n```\npublic class StaticGiftView extends TextView {\n\n    private int current = 1;\n    private int num;\n    private StaticGiftAnimationListener listener;\n    private Animation scaleAnimation = AnimationUtils.loadAnimation(getContext(), R.anim.gift_scale);\n\n    public StaticGiftView(Context context) {\n        super(context);\n    }\n\n    public StaticGiftView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n    }\n\n    public StaticGiftView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n    }\n\n    public void setListener(StaticGiftAnimationListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n    }\n\n    public void setNum(int num) {\n        this.num = num;\n        startAnimation(scaleAnimation);\n    }\n\n    @Override\n    protected void onAnimationEnd() {\n        super.onAnimationEnd();\n        current++;\n        if (current <= num) {\n            setText(\"X \" + current);\n            startAnimation(scaleAnimation);\n        } else {\n            current = 1;\n            if (listener != null) {\n                listener.onAnimationEnd();\n            }\n        }\n    }\n\n    public interface StaticGiftAnimationListener {\n        void onAnimationEnd();\n    }\n}\n```\n\n静态礼物是通过``StaticGiftView``的``setNum()``方法来显示动画的，就是显示一个数量递增，同时伴随着缩放的动画。\n页面布局中有``staticLayout1``和``staticLayout2``，分别代表两个执行动画的布局，通过判断``getVisibility()``是否为``GONE``来决定是否将动画分发给这个布局。在动画开始时，将布局设置成VISIBLE，在动画结束后，再将布局设置成GONE。\n我通过``setOver(true)``来告知队列某某出口的动画执行完毕，然后队列回调到``onGiftAnimationEnd()``中，继续取出任务分配给有空的出口。\n\n调用如下代码将任务添加到队列便能顺序播放动画了。\n```\nStaticGift.getInstance().addNumAnimation(pushGift, listener);\n```\n\n## 待优化\n1. 代码之间的依赖很重，任务队列直接依赖到了前端的UI组件，需要解耦。\n2. 若是增加至三个、四个或是更多个出口，代码就得一直添加``mActive``了，不利于拓展。\n","source":"_posts/task-queue.md","raw":"---\ntitle: Android实现任务队列：一个入口一个出口、一个入口两个出口\ndate: 2016-05-27 15:11:25\ntags:\n - java\n---\n\n## 前言\n在我的[Android实现简易轻量下载器：单线程任务队列](http://lastwarmth.site/2016/02/23/single-thread-queue/)文章中，有提到过任务队列。当时是需要下载，实现一个简单的单线程任务队列即可。\n最近项目中也需要用到任务队列，并且有2种需求：\n1. 动态礼物动画：在用户送完动态礼物之后，会在界面上展现一个动画。界面上一次最多能执行1个动画，动画按顺序执行。即：``一个入口一个出口``。\n2. 静态礼物动画：在用户送完静态礼物之后，会在界面上展现一个动画。界面上一次最多能并列执行2个动画，动画按顺序执行。即：``一个入口两个出口``。\n同样都是任务队列，只不过一个是只有一个出口，另一个有两个出口。\n\n<!-- more -->\n\n## 动态礼物动画\n参照着之前那篇文章，很快就写出来了。\n动态礼物单体类``DynamicGiftModel``：\n```\npublic class DynamicGiftModel implements GiftModel {\n\n    private GifImageView gifImageView;\n    private GifDrawable gifDrawable;\n    private DynamicGiftListener listener;\n\n    public DynamicGiftModel(GifDrawable gifDrawable, GifImageView gifImageView, DynamicGiftListener listener) {\n        this.gifDrawable = gifDrawable;\n        this.gifImageView = gifImageView;\n        this.listener = listener;\n    }\n\n\n    @Override\n    public void startAnimation(final GiftAnimationEndListener nextListener) {\n        if (listener != null) {\n            listener.beforeDynamicAnimation();\n        }\n        gifImageView.setImageDrawable(gifDrawable);\n        gifDrawable.addAnimationListener(new AnimationListener() {\n            @Override\n            public void onAnimationCompleted(int loopNumber) {\n                if (loopNumber == (gifDrawable.getLoopCount() - 1)) {\n                    if (listener != null) {\n                        listener.afterDynamicAnimation();\n                    }\n                    gifDrawable.recycle();\n                    if (nextListener != null) {\n                        nextListener.onGiftAnimationEnd();\n                    }\n                }\n\n            }\n        });\n    }\n\n    public interface DynamicGiftListener {\n        void beforeDynamicAnimation();\n\n        void afterDynamicAnimation();\n    }\n}\n```\n动态礼物队列类``DynamicGift``:\n```\npublic class DynamicGift {\n\n    private static DynamicGift instance = new DynamicGift();\n    private DynamicGiftExecutor executor;\n\n    public static DynamicGift getInstance() {\n        if (instance == null) {\n            instance = new DynamicGift();\n        }\n\n        return instance;\n    }\n\n    private DynamicGift() {\n        executor = new DynamicGiftExecutor();\n    }\n\n    /**\n     * 动画队列，顺序执行\n     */\n    class DynamicGiftExecutor implements GiftAnimationEndListener {\n\n        final ArrayDeque<DynamicGiftModel> mTasks = new ArrayDeque<>();\n        DynamicGiftModel mActive;\n\n        public void execute(final DynamicGiftModel model) {\n            mTasks.offer(model);\n            if (mActive == null) {\n                scheduleNext();\n            }\n        }\n\n        protected synchronized void scheduleNext() {\n            if ((mActive = mTasks.poll()) != null) {\n                mActive.startAnimation(this);\n            }\n        }\n\n        @Override\n        public void onGiftAnimationEnd() {\n            scheduleNext();\n        }\n    }\n\n    /**\n     * 往队列中添加动画对象\n     *\n     * @param gifImageView imageView\n     * @param gifDrawable  gif图\n     * @param listener     监听\n     */\n    public void addGifAnimation(GifImageView gifImageView, GifDrawable gifDrawable, DynamicGiftModel.DynamicGiftListener listener) {\n        executor.execute(new DynamicGiftModel(gifDrawable, gifImageView, listener));\n    }\n}\n```\n说明一下：``GifImageView``就是用来播放gif的ImageView，``GifDrawable``就是gif对应的drawable，``DynamicGiftListener``就是动画执行前后的回调。\n可以看到，我们通过``execute()``将一个``DynamicGiftModel``任务放入到队列中，``DynamicGiftModel``调用``startAnimation()``便能开始动画了。``DynamicGiftExecutor``与那篇博客中的类似。只不过我这里做了一些修改：下载中使用的Runnable，他是同步的，在执行完之后会自动去取一下。但是在这里，动画执行是异步的，我在调用完``startAnimation()``之后就会立即返回，所以需要一个监听（GiftAnimationEndListener）在动画执行完毕之后才去执行``scheduleNext()``操作，即取下一个任务。\nGiftAnimationEndListener代码很简单：\n```\npublic interface GiftAnimationEndListener {\n    void onGiftAnimationEnd();\n}\n```\n\n调用如下代码将任务添加到队列便能顺序播放动画了。\n```\nDynamicGift.getInstance().addGifAnimation(gifImageView, gifDrawable, listener);\n```\n\n## 静态礼物动画\n静态礼物因为有两个出口，之前没思考过，所以花了一些时间。\n静态礼物单体类``DynamicGiftModel``:\n```\npublic class StaticGiftModel implements GiftModel {\n\n    private StaticGiftListener listener;\n    private PushGift gift;\n    private boolean over;\n\n    public StaticGiftModel(PushGift gift, StaticGiftListener listener) {\n        this.gift = gift;\n        this.listener = listener;\n    }\n\n    public boolean isOver() {\n        return over;\n    }\n\n    public void setOver(boolean over) {\n        this.over = over;\n    }\n\n    @Override\n    public void startAnimation(final GiftAnimationEndListener nextListener) {\n        if (listener != null) {\n            listener.startStaticAnimation(this, gift, nextListener);\n        }\n    }\n\n    public interface StaticGiftListener {\n        void startStaticAnimation(StaticGiftModel giftModel, PushGift gift, GiftAnimationEndListener nextListener);\n    }\n}\n```\n静态礼物队列类``StaticGift``：\n```\npublic class StaticGift {\n\n    private static StaticGift instance = new StaticGift();\n    private StaticGiftExecutor executor;\n\n    public static StaticGift getInstance() {\n        if (instance == null) {\n            instance = new StaticGift();\n        }\n\n        return instance;\n    }\n\n    private StaticGift() {\n        executor = new StaticGiftExecutor();\n    }\n\n    /**\n     * 动画队列，2个出口，顺序执行\n     */\n    class StaticGiftExecutor implements GiftAnimationEndListener {\n\n        final ArrayDeque<StaticGiftModel> mTasks = new ArrayDeque<>();\n        StaticGiftModel mActive1;\n        StaticGiftModel mActive2;\n\n        public void execute(final StaticGiftModel model) {\n            mTasks.offer(model);\n            if (mActive1 == null) {\n                mActive1 = mTasks.poll();\n                if (mActive1 != null) {\n                    mActive1.startAnimation(this);\n                }\n            } else if (mActive2 == null) {\n                mActive2 = mTasks.poll();\n                if (mActive2 != null) {\n                    mActive2.startAnimation(this);\n                }\n            }\n        }\n\n        @Override\n        public void onGiftAnimationEnd() {\n            if (mActive1 != null && mActive1.isOver()) {\n                mActive1 = mTasks.poll();\n                if (mActive1 != null) {\n                    mActive1.startAnimation(this);\n                }\n            }\n            if (mActive2 != null && mActive2.isOver()) {\n                mActive2 = mTasks.poll();\n                if (mActive2 != null) {\n                    mActive2.startAnimation(this);\n                }\n            }\n        }\n\n    }\n\n    /**\n     * 添加任务\n     *\n     * @param gift     推送的Gift内容\n     * @param listener 回调\n     */\n    public void addNumAnimation(PushGift gift, StaticGiftModel.StaticGiftListener listener) {\n        executor.execute(new StaticGiftModel(gift, listener));\n    }\n}\n```\n可以看到，我在``StaticGiftExecutor``中定义了2个变量``mActive1``、``mActive2``，他们即代表两个出口。在``execute``中先判断``mActive1``是否为空，是则取出元素给它，让它执行动画。否则判断``mActive2``是否为空，是则取出元素给它，让它执行动画。\n因为有两个出口，队列并不知道我的下一个任务要在哪个出口执行，所以具体的播放逻辑不能写在其中，所以我将具体的播放逻辑设计在``StaticGiftListener.startStaticAnimation()``的中，由调用的用户自行实现，并且在动画结束时，我需要回调队列的接口，来通知队列某某出口的动画执行完毕了。\n实现片段代码如下：\n```\n/**\n     * 执行静态礼物动画\n     *\n     * @param gift\n     * @param nextListener\n     */\n    @Override\n    public void startStaticAnimation(final StaticGiftModel giftModel, PushGift gift, final GiftAnimationEndListener nextListener) {\n        if (holder.staticLayout1.getVisibility() == View.GONE) {\n            holder.staticLayout1.setVisibility(View.VISIBLE);\n            holder.staticGiftUserNick1.setText(gift.getUserNick());\n            holder.staticGiftDesc1.setText(gift.getDescription());\n            showIcon(gift.getUserIcon(), holder.staticGiftUserIcon1);\n            // 获取对应礼物的本地下载路径\n            String fileName = CommonUtils.MD5(gift.getGiftIcon());\n            File savePath = new File(GiftManager.getInstance().getDownloadDir(), fileName);\n            String path = \"file://\" + savePath.getAbsolutePath();\n            ImageLoader.getInstance().displayImage(path, holder.staticGiftIcon1);\n            holder.staticGiftView1.setListener(new StaticGiftView.StaticGiftAnimationListener() {\n                @Override\n                public void onAnimationEnd() {\n                    holder.staticLayout1.setVisibility(View.GONE);\n                    giftModel.setOver(true);\n                    nextListener.onGiftAnimationEnd();\n                }\n            });\n            holder.staticGiftView1.setNum(Integer.valueOf(gift.getNum()));\n        } else if (holder.staticLayout2.getVisibility() == View.GONE) {\n            holder.staticLayout2.setVisibility(View.VISIBLE);\n            holder.staticGiftUserNick2.setText(gift.getUserNick());\n            holder.staticGiftDesc2.setText(gift.getDescription());\n            showIcon(gift.getUserIcon(), holder.staticGiftUserIcon2);\n            // 获取对应礼物的本地下载路径\n            String fileName = CommonUtils.MD5(gift.getGiftIcon());\n            File savePath = new File(GiftManager.getInstance().getDownloadDir(), fileName);\n            String path = \"file://\" + savePath.getAbsolutePath();\n            ImageLoader.getInstance().displayImage(path, holder.staticGiftIcon2);\n            holder.staticGiftView2.setListener(new StaticGiftView.StaticGiftAnimationListener() {\n                @Override\n                public void onAnimationEnd() {\n                    holder.staticLayout2.setVisibility(View.GONE);\n                    giftModel.setOver(true);\n                    nextListener.onGiftAnimationEnd();\n                }\n            });\n            holder.staticGiftView2.setNum(Integer.valueOf(gift.getNum()));\n        }\n    }\n```\n静态礼物动画实现类StaticGiftView：\n```\npublic class StaticGiftView extends TextView {\n\n    private int current = 1;\n    private int num;\n    private StaticGiftAnimationListener listener;\n    private Animation scaleAnimation = AnimationUtils.loadAnimation(getContext(), R.anim.gift_scale);\n\n    public StaticGiftView(Context context) {\n        super(context);\n    }\n\n    public StaticGiftView(Context context, AttributeSet attrs) {\n        super(context, attrs);\n    }\n\n    public StaticGiftView(Context context, AttributeSet attrs, int defStyleAttr) {\n        super(context, attrs, defStyleAttr);\n    }\n\n    public void setListener(StaticGiftAnimationListener listener) {\n        this.listener = listener;\n    }\n\n    @Override\n    protected void onDraw(Canvas canvas) {\n        super.onDraw(canvas);\n    }\n\n    public void setNum(int num) {\n        this.num = num;\n        startAnimation(scaleAnimation);\n    }\n\n    @Override\n    protected void onAnimationEnd() {\n        super.onAnimationEnd();\n        current++;\n        if (current <= num) {\n            setText(\"X \" + current);\n            startAnimation(scaleAnimation);\n        } else {\n            current = 1;\n            if (listener != null) {\n                listener.onAnimationEnd();\n            }\n        }\n    }\n\n    public interface StaticGiftAnimationListener {\n        void onAnimationEnd();\n    }\n}\n```\n\n静态礼物是通过``StaticGiftView``的``setNum()``方法来显示动画的，就是显示一个数量递增，同时伴随着缩放的动画。\n页面布局中有``staticLayout1``和``staticLayout2``，分别代表两个执行动画的布局，通过判断``getVisibility()``是否为``GONE``来决定是否将动画分发给这个布局。在动画开始时，将布局设置成VISIBLE，在动画结束后，再将布局设置成GONE。\n我通过``setOver(true)``来告知队列某某出口的动画执行完毕，然后队列回调到``onGiftAnimationEnd()``中，继续取出任务分配给有空的出口。\n\n调用如下代码将任务添加到队列便能顺序播放动画了。\n```\nStaticGift.getInstance().addNumAnimation(pushGift, listener);\n```\n\n## 待优化\n1. 代码之间的依赖很重，任务队列直接依赖到了前端的UI组件，需要解耦。\n2. 若是增加至三个、四个或是更多个出口，代码就得一直添加``mActive``了，不利于拓展。\n","slug":"task-queue","published":1,"updated":"2016-11-21T10:03:41.202Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75ai003a1cb8in8qacyg","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在我的<a href=\"http://lastwarmth.site/2016/02/23/single-thread-queue/\" target=\"_blank\" rel=\"external\">Android实现简易轻量下载器：单线程任务队列</a>文章中，有提到过任务队列。当时是需要下载，实现一个简单的单线程任务队列即可。<br>最近项目中也需要用到任务队列，并且有2种需求：</p>\n<ol>\n<li>动态礼物动画：在用户送完动态礼物之后，会在界面上展现一个动画。界面上一次最多能执行1个动画，动画按顺序执行。即：<code>一个入口一个出口</code>。</li>\n<li>静态礼物动画：在用户送完静态礼物之后，会在界面上展现一个动画。界面上一次最多能并列执行2个动画，动画按顺序执行。即：<code>一个入口两个出口</code>。<br>同样都是任务队列，只不过一个是只有一个出口，另一个有两个出口。</li>\n</ol>\n<a id=\"more\"></a>\n<h2 id=\"动态礼物动画\"><a href=\"#动态礼物动画\" class=\"headerlink\" title=\"动态礼物动画\"></a>动态礼物动画</h2><p>参照着之前那篇文章，很快就写出来了。<br>动态礼物单体类<code>DynamicGiftModel</code>：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DynamicGiftModel</span> <span class=\"keyword\">implements</span> <span class=\"title\">GiftModel</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> GifImageView gifImageView;</div><div class=\"line\">    <span class=\"keyword\">private</span> GifDrawable gifDrawable;</div><div class=\"line\">    <span class=\"keyword\">private</span> DynamicGiftListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DynamicGiftModel</span><span class=\"params\">(GifDrawable gifDrawable, GifImageView gifImageView, DynamicGiftListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.gifDrawable = gifDrawable;</div><div class=\"line\">        <span class=\"keyword\">this</span>.gifImageView = gifImageView;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">startAnimation</span><span class=\"params\">(<span class=\"keyword\">final</span> GiftAnimationEndListener nextListener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            listener.beforeDynamicAnimation();</div><div class=\"line\">        &#125;</div><div class=\"line\">        gifImageView.setImageDrawable(gifDrawable);</div><div class=\"line\">        gifDrawable.addAnimationListener(<span class=\"keyword\">new</span> AnimationListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onAnimationCompleted</span><span class=\"params\">(<span class=\"keyword\">int</span> loopNumber)</span> </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (loopNumber == (gifDrawable.getLoopCount() - <span class=\"number\">1</span>)) &#123;</div><div class=\"line\">                    <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        listener.afterDynamicAnimation();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    gifDrawable.recycle();</div><div class=\"line\">                    <span class=\"keyword\">if</span> (nextListener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        nextListener.onGiftAnimationEnd();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">DynamicGiftListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">beforeDynamicAnimation</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">afterDynamicAnimation</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>动态礼物队列类<code>DynamicGift</code>:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DynamicGift</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> DynamicGift instance = <span class=\"keyword\">new</span> DynamicGift();</div><div class=\"line\">    <span class=\"keyword\">private</span> DynamicGiftExecutor executor;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> DynamicGift <span class=\"title\">getInstance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (instance == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            instance = <span class=\"keyword\">new</span> DynamicGift();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">return</span> instance;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">DynamicGift</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        executor = <span class=\"keyword\">new</span> DynamicGiftExecutor();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 动画队列，顺序执行</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DynamicGiftExecutor</span> <span class=\"keyword\">implements</span> <span class=\"title\">GiftAnimationEndListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">final</span> ArrayDeque&lt;DynamicGiftModel&gt; mTasks = <span class=\"keyword\">new</span> ArrayDeque&lt;&gt;();</div><div class=\"line\">        DynamicGiftModel mActive;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(<span class=\"keyword\">final</span> DynamicGiftModel model)</span> </span>&#123;</div><div class=\"line\">            mTasks.offer(model);</div><div class=\"line\">            <span class=\"keyword\">if</span> (mActive == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                scheduleNext();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">scheduleNext</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> ((mActive = mTasks.poll()) != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                mActive.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onGiftAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            scheduleNext();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 往队列中添加动画对象</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> gifImageView imageView</div><div class=\"line\">     * <span class=\"doctag\">@param</span> gifDrawable  gif图</div><div class=\"line\">     * <span class=\"doctag\">@param</span> listener     监听</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addGifAnimation</span><span class=\"params\">(GifImageView gifImageView, GifDrawable gifDrawable, DynamicGiftModel.DynamicGiftListener listener)</span> </span>&#123;</div><div class=\"line\">        executor.execute(<span class=\"keyword\">new</span> DynamicGiftModel(gifDrawable, gifImageView, listener));</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>说明一下：<code>GifImageView</code>就是用来播放gif的ImageView，<code>GifDrawable</code>就是gif对应的drawable，<code>DynamicGiftListener</code>就是动画执行前后的回调。<br>可以看到，我们通过<code>execute()</code>将一个<code>DynamicGiftModel</code>任务放入到队列中，<code>DynamicGiftModel</code>调用<code>startAnimation()</code>便能开始动画了。<code>DynamicGiftExecutor</code>与那篇博客中的类似。只不过我这里做了一些修改：下载中使用的Runnable，他是同步的，在执行完之后会自动去取一下。但是在这里，动画执行是异步的，我在调用完<code>startAnimation()</code>之后就会立即返回，所以需要一个监听（GiftAnimationEndListener）在动画执行完毕之后才去执行<code>scheduleNext()</code>操作，即取下一个任务。<br>GiftAnimationEndListener代码很简单：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">GiftAnimationEndListener</span> &#123;</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onGiftAnimationEnd</span>(<span class=\"params\"></span>)</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>调用如下代码将任务添加到队列便能顺序播放动画了。<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">DynamicGift</span><span class=\"selector-class\">.getInstance</span>()<span class=\"selector-class\">.addGifAnimation</span>(<span class=\"selector-tag\">gifImageView</span>, <span class=\"selector-tag\">gifDrawable</span>, <span class=\"selector-tag\">listener</span>);</div></pre></td></tr></table></figure></p>\n<h2 id=\"静态礼物动画\"><a href=\"#静态礼物动画\" class=\"headerlink\" title=\"静态礼物动画\"></a>静态礼物动画</h2><p>静态礼物因为有两个出口，之前没思考过，所以花了一些时间。<br>静态礼物单体类<code>DynamicGiftModel</code>:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticGiftModel</span> <span class=\"keyword\">implements</span> <span class=\"title\">GiftModel</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> StaticGiftListener listener;</div><div class=\"line\">    <span class=\"keyword\">private</span> PushGift gift;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> over;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">StaticGiftModel</span><span class=\"params\">(PushGift gift, StaticGiftListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.gift = gift;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isOver</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> over;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setOver</span><span class=\"params\">(<span class=\"keyword\">boolean</span> over)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.over = over;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">startAnimation</span><span class=\"params\">(<span class=\"keyword\">final</span> GiftAnimationEndListener nextListener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            listener.startStaticAnimation(<span class=\"keyword\">this</span>, gift, nextListener);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">StaticGiftListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">startStaticAnimation</span><span class=\"params\">(StaticGiftModel giftModel, PushGift gift, GiftAnimationEndListener nextListener)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>静态礼物队列类<code>StaticGift</code>：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticGift</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> StaticGift instance = <span class=\"keyword\">new</span> StaticGift();</div><div class=\"line\">    <span class=\"keyword\">private</span> StaticGiftExecutor executor;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> StaticGift <span class=\"title\">getInstance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (instance == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            instance = <span class=\"keyword\">new</span> StaticGift();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">return</span> instance;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">StaticGift</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        executor = <span class=\"keyword\">new</span> StaticGiftExecutor();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 动画队列，2个出口，顺序执行</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticGiftExecutor</span> <span class=\"keyword\">implements</span> <span class=\"title\">GiftAnimationEndListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">final</span> ArrayDeque&lt;StaticGiftModel&gt; mTasks = <span class=\"keyword\">new</span> ArrayDeque&lt;&gt;();</div><div class=\"line\">        StaticGiftModel mActive1;</div><div class=\"line\">        StaticGiftModel mActive2;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(<span class=\"keyword\">final</span> StaticGiftModel model)</span> </span>&#123;</div><div class=\"line\">            mTasks.offer(model);</div><div class=\"line\">            <span class=\"keyword\">if</span> (mActive1 == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                mActive1 = mTasks.poll();</div><div class=\"line\">                <span class=\"keyword\">if</span> (mActive1 != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    mActive1.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mActive2 == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                mActive2 = mTasks.poll();</div><div class=\"line\">                <span class=\"keyword\">if</span> (mActive2 != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    mActive2.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onGiftAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (mActive1 != <span class=\"keyword\">null</span> &amp;&amp; mActive1.isOver()) &#123;</div><div class=\"line\">                mActive1 = mTasks.poll();</div><div class=\"line\">                <span class=\"keyword\">if</span> (mActive1 != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    mActive1.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span> (mActive2 != <span class=\"keyword\">null</span> &amp;&amp; mActive2.isOver()) &#123;</div><div class=\"line\">                mActive2 = mTasks.poll();</div><div class=\"line\">                <span class=\"keyword\">if</span> (mActive2 != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    mActive2.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 添加任务</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> gift     推送的Gift内容</div><div class=\"line\">     * <span class=\"doctag\">@param</span> listener 回调</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addNumAnimation</span><span class=\"params\">(PushGift gift, StaticGiftModel.StaticGiftListener listener)</span> </span>&#123;</div><div class=\"line\">        executor.execute(<span class=\"keyword\">new</span> StaticGiftModel(gift, listener));</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到，我在<code>StaticGiftExecutor</code>中定义了2个变量<code>mActive1</code>、<code>mActive2</code>，他们即代表两个出口。在<code>execute</code>中先判断<code>mActive1</code>是否为空，是则取出元素给它，让它执行动画。否则判断<code>mActive2</code>是否为空，是则取出元素给它，让它执行动画。<br>因为有两个出口，队列并不知道我的下一个任务要在哪个出口执行，所以具体的播放逻辑不能写在其中，所以我将具体的播放逻辑设计在<code>StaticGiftListener.startStaticAnimation()</code>的中，由调用的用户自行实现，并且在动画结束时，我需要回调队列的接口，来通知队列某某出口的动画执行完毕了。<br>实现片段代码如下：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\">     * 执行静态礼物动画</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> gift</div><div class=\"line\">     * <span class=\"doctag\">@param</span> nextListener</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">startStaticAnimation</span><span class=\"params\">(<span class=\"keyword\">final</span> StaticGiftModel giftModel, PushGift gift, <span class=\"keyword\">final</span> GiftAnimationEndListener nextListener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (holder.staticLayout1.getVisibility() == View.GONE) &#123;</div><div class=\"line\">            holder.staticLayout1.setVisibility(View.VISIBLE);</div><div class=\"line\">            holder.staticGiftUserNick1.setText(gift.getUserNick());</div><div class=\"line\">            holder.staticGiftDesc1.setText(gift.getDescription());</div><div class=\"line\">            showIcon(gift.getUserIcon(), holder.staticGiftUserIcon1);</div><div class=\"line\">            <span class=\"comment\">// 获取对应礼物的本地下载路径</span></div><div class=\"line\">            String fileName = CommonUtils.MD5(gift.getGiftIcon());</div><div class=\"line\">            File savePath = <span class=\"keyword\">new</span> File(GiftManager.getInstance().getDownloadDir(), fileName);</div><div class=\"line\">            String path = <span class=\"string\">\"file://\"</span> + savePath.getAbsolutePath();</div><div class=\"line\">            ImageLoader.getInstance().displayImage(path, holder.staticGiftIcon1);</div><div class=\"line\">            holder.staticGiftView1.setListener(<span class=\"keyword\">new</span> StaticGiftView.StaticGiftAnimationListener() &#123;</div><div class=\"line\">                <span class=\"meta\">@Override</span></div><div class=\"line\">                <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">                    holder.staticLayout1.setVisibility(View.GONE);</div><div class=\"line\">                    giftModel.setOver(<span class=\"keyword\">true</span>);</div><div class=\"line\">                    nextListener.onGiftAnimationEnd();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;);</div><div class=\"line\">            holder.staticGiftView1.setNum(Integer.valueOf(gift.getNum()));</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (holder.staticLayout2.getVisibility() == View.GONE) &#123;</div><div class=\"line\">            holder.staticLayout2.setVisibility(View.VISIBLE);</div><div class=\"line\">            holder.staticGiftUserNick2.setText(gift.getUserNick());</div><div class=\"line\">            holder.staticGiftDesc2.setText(gift.getDescription());</div><div class=\"line\">            showIcon(gift.getUserIcon(), holder.staticGiftUserIcon2);</div><div class=\"line\">            <span class=\"comment\">// 获取对应礼物的本地下载路径</span></div><div class=\"line\">            String fileName = CommonUtils.MD5(gift.getGiftIcon());</div><div class=\"line\">            File savePath = <span class=\"keyword\">new</span> File(GiftManager.getInstance().getDownloadDir(), fileName);</div><div class=\"line\">            String path = <span class=\"string\">\"file://\"</span> + savePath.getAbsolutePath();</div><div class=\"line\">            ImageLoader.getInstance().displayImage(path, holder.staticGiftIcon2);</div><div class=\"line\">            holder.staticGiftView2.setListener(<span class=\"keyword\">new</span> StaticGiftView.StaticGiftAnimationListener() &#123;</div><div class=\"line\">                <span class=\"meta\">@Override</span></div><div class=\"line\">                <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">                    holder.staticLayout2.setVisibility(View.GONE);</div><div class=\"line\">                    giftModel.setOver(<span class=\"keyword\">true</span>);</div><div class=\"line\">                    nextListener.onGiftAnimationEnd();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;);</div><div class=\"line\">            holder.staticGiftView2.setNum(Integer.valueOf(gift.getNum()));</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>静态礼物动画实现类StaticGiftView：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticGiftView</span> <span class=\"keyword\">extends</span> <span class=\"title\">TextView</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> current = <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> num;</div><div class=\"line\">    <span class=\"keyword\">private</span> StaticGiftAnimationListener listener;</div><div class=\"line\">    <span class=\"keyword\">private</span> Animation scaleAnimation = AnimationUtils.loadAnimation(getContext(), R.anim.gift_scale);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">StaticGiftView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">StaticGiftView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">StaticGiftView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(StaticGiftAnimationListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setNum</span><span class=\"params\">(<span class=\"keyword\">int</span> num)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.num = num;</div><div class=\"line\">        startAnimation(scaleAnimation);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onAnimationEnd();</div><div class=\"line\">        current++;</div><div class=\"line\">        <span class=\"keyword\">if</span> (current &lt;= num) &#123;</div><div class=\"line\">            setText(<span class=\"string\">\"X \"</span> + current);</div><div class=\"line\">            startAnimation(scaleAnimation);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            current = <span class=\"number\">1</span>;</div><div class=\"line\">            <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                listener.onAnimationEnd();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">StaticGiftAnimationListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onAnimationEnd</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>静态礼物是通过<code>StaticGiftView</code>的<code>setNum()</code>方法来显示动画的，就是显示一个数量递增，同时伴随着缩放的动画。<br>页面布局中有<code>staticLayout1</code>和<code>staticLayout2</code>，分别代表两个执行动画的布局，通过判断<code>getVisibility()</code>是否为<code>GONE</code>来决定是否将动画分发给这个布局。在动画开始时，将布局设置成VISIBLE，在动画结束后，再将布局设置成GONE。<br>我通过<code>setOver(true)</code>来告知队列某某出口的动画执行完毕，然后队列回调到<code>onGiftAnimationEnd()</code>中，继续取出任务分配给有空的出口。</p>\n<p>调用如下代码将任务添加到队列便能顺序播放动画了。<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">StaticGift</span><span class=\"selector-class\">.getInstance</span>()<span class=\"selector-class\">.addNumAnimation</span>(<span class=\"selector-tag\">pushGift</span>, <span class=\"selector-tag\">listener</span>);</div></pre></td></tr></table></figure></p>\n<h2 id=\"待优化\"><a href=\"#待优化\" class=\"headerlink\" title=\"待优化\"></a>待优化</h2><ol>\n<li>代码之间的依赖很重，任务队列直接依赖到了前端的UI组件，需要解耦。</li>\n<li>若是增加至三个、四个或是更多个出口，代码就得一直添加<code>mActive</code>了，不利于拓展。</li>\n</ol>\n","excerpt":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在我的<a href=\"http://lastwarmth.site/2016/02/23/single-thread-queue/\">Android实现简易轻量下载器：单线程任务队列</a>文章中，有提到过任务队列。当时是需要下载，实现一个简单的单线程任务队列即可。<br>最近项目中也需要用到任务队列，并且有2种需求：</p>\n<ol>\n<li>动态礼物动画：在用户送完动态礼物之后，会在界面上展现一个动画。界面上一次最多能执行1个动画，动画按顺序执行。即：<code>一个入口一个出口</code>。</li>\n<li>静态礼物动画：在用户送完静态礼物之后，会在界面上展现一个动画。界面上一次最多能并列执行2个动画，动画按顺序执行。即：<code>一个入口两个出口</code>。<br>同样都是任务队列，只不过一个是只有一个出口，另一个有两个出口。</li>\n</ol>","more":"<h2 id=\"动态礼物动画\"><a href=\"#动态礼物动画\" class=\"headerlink\" title=\"动态礼物动画\"></a>动态礼物动画</h2><p>参照着之前那篇文章，很快就写出来了。<br>动态礼物单体类<code>DynamicGiftModel</code>：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DynamicGiftModel</span> <span class=\"keyword\">implements</span> <span class=\"title\">GiftModel</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> GifImageView gifImageView;</div><div class=\"line\">    <span class=\"keyword\">private</span> GifDrawable gifDrawable;</div><div class=\"line\">    <span class=\"keyword\">private</span> DynamicGiftListener listener;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DynamicGiftModel</span><span class=\"params\">(GifDrawable gifDrawable, GifImageView gifImageView, DynamicGiftListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.gifDrawable = gifDrawable;</div><div class=\"line\">        <span class=\"keyword\">this</span>.gifImageView = gifImageView;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">startAnimation</span><span class=\"params\">(<span class=\"keyword\">final</span> GiftAnimationEndListener nextListener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            listener.beforeDynamicAnimation();</div><div class=\"line\">        &#125;</div><div class=\"line\">        gifImageView.setImageDrawable(gifDrawable);</div><div class=\"line\">        gifDrawable.addAnimationListener(<span class=\"keyword\">new</span> AnimationListener() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onAnimationCompleted</span><span class=\"params\">(<span class=\"keyword\">int</span> loopNumber)</span> </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (loopNumber == (gifDrawable.getLoopCount() - <span class=\"number\">1</span>)) &#123;</div><div class=\"line\">                    <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        listener.afterDynamicAnimation();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    gifDrawable.recycle();</div><div class=\"line\">                    <span class=\"keyword\">if</span> (nextListener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        nextListener.onGiftAnimationEnd();</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">DynamicGiftListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">beforeDynamicAnimation</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">afterDynamicAnimation</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>动态礼物队列类<code>DynamicGift</code>:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DynamicGift</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> DynamicGift instance = <span class=\"keyword\">new</span> DynamicGift();</div><div class=\"line\">    <span class=\"keyword\">private</span> DynamicGiftExecutor executor;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> DynamicGift <span class=\"title\">getInstance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (instance == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            instance = <span class=\"keyword\">new</span> DynamicGift();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">return</span> instance;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">DynamicGift</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        executor = <span class=\"keyword\">new</span> DynamicGiftExecutor();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 动画队列，顺序执行</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DynamicGiftExecutor</span> <span class=\"keyword\">implements</span> <span class=\"title\">GiftAnimationEndListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">final</span> ArrayDeque&lt;DynamicGiftModel&gt; mTasks = <span class=\"keyword\">new</span> ArrayDeque&lt;&gt;();</div><div class=\"line\">        DynamicGiftModel mActive;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(<span class=\"keyword\">final</span> DynamicGiftModel model)</span> </span>&#123;</div><div class=\"line\">            mTasks.offer(model);</div><div class=\"line\">            <span class=\"keyword\">if</span> (mActive == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                scheduleNext();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">scheduleNext</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> ((mActive = mTasks.poll()) != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                mActive.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onGiftAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            scheduleNext();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 往队列中添加动画对象</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> gifImageView imageView</div><div class=\"line\">     * <span class=\"doctag\">@param</span> gifDrawable  gif图</div><div class=\"line\">     * <span class=\"doctag\">@param</span> listener     监听</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addGifAnimation</span><span class=\"params\">(GifImageView gifImageView, GifDrawable gifDrawable, DynamicGiftModel.DynamicGiftListener listener)</span> </span>&#123;</div><div class=\"line\">        executor.execute(<span class=\"keyword\">new</span> DynamicGiftModel(gifDrawable, gifImageView, listener));</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>说明一下：<code>GifImageView</code>就是用来播放gif的ImageView，<code>GifDrawable</code>就是gif对应的drawable，<code>DynamicGiftListener</code>就是动画执行前后的回调。<br>可以看到，我们通过<code>execute()</code>将一个<code>DynamicGiftModel</code>任务放入到队列中，<code>DynamicGiftModel</code>调用<code>startAnimation()</code>便能开始动画了。<code>DynamicGiftExecutor</code>与那篇博客中的类似。只不过我这里做了一些修改：下载中使用的Runnable，他是同步的，在执行完之后会自动去取一下。但是在这里，动画执行是异步的，我在调用完<code>startAnimation()</code>之后就会立即返回，所以需要一个监听（GiftAnimationEndListener）在动画执行完毕之后才去执行<code>scheduleNext()</code>操作，即取下一个任务。<br>GiftAnimationEndListener代码很简单：<br><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">GiftAnimationEndListener</span> &#123;</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onGiftAnimationEnd</span>(<span class=\"params\"></span>)</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>调用如下代码将任务添加到队列便能顺序播放动画了。<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">DynamicGift</span><span class=\"selector-class\">.getInstance</span>()<span class=\"selector-class\">.addGifAnimation</span>(<span class=\"selector-tag\">gifImageView</span>, <span class=\"selector-tag\">gifDrawable</span>, <span class=\"selector-tag\">listener</span>);</div></pre></td></tr></table></figure></p>\n<h2 id=\"静态礼物动画\"><a href=\"#静态礼物动画\" class=\"headerlink\" title=\"静态礼物动画\"></a>静态礼物动画</h2><p>静态礼物因为有两个出口，之前没思考过，所以花了一些时间。<br>静态礼物单体类<code>DynamicGiftModel</code>:<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticGiftModel</span> <span class=\"keyword\">implements</span> <span class=\"title\">GiftModel</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> StaticGiftListener listener;</div><div class=\"line\">    <span class=\"keyword\">private</span> PushGift gift;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> over;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">StaticGiftModel</span><span class=\"params\">(PushGift gift, StaticGiftListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.gift = gift;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isOver</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> over;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setOver</span><span class=\"params\">(<span class=\"keyword\">boolean</span> over)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.over = over;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">startAnimation</span><span class=\"params\">(<span class=\"keyword\">final</span> GiftAnimationEndListener nextListener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            listener.startStaticAnimation(<span class=\"keyword\">this</span>, gift, nextListener);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">StaticGiftListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">startStaticAnimation</span><span class=\"params\">(StaticGiftModel giftModel, PushGift gift, GiftAnimationEndListener nextListener)</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>静态礼物队列类<code>StaticGift</code>：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticGift</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> StaticGift instance = <span class=\"keyword\">new</span> StaticGift();</div><div class=\"line\">    <span class=\"keyword\">private</span> StaticGiftExecutor executor;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> StaticGift <span class=\"title\">getInstance</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (instance == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">            instance = <span class=\"keyword\">new</span> StaticGift();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">return</span> instance;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">StaticGift</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        executor = <span class=\"keyword\">new</span> StaticGiftExecutor();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 动画队列，2个出口，顺序执行</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticGiftExecutor</span> <span class=\"keyword\">implements</span> <span class=\"title\">GiftAnimationEndListener</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">final</span> ArrayDeque&lt;StaticGiftModel&gt; mTasks = <span class=\"keyword\">new</span> ArrayDeque&lt;&gt;();</div><div class=\"line\">        StaticGiftModel mActive1;</div><div class=\"line\">        StaticGiftModel mActive2;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(<span class=\"keyword\">final</span> StaticGiftModel model)</span> </span>&#123;</div><div class=\"line\">            mTasks.offer(model);</div><div class=\"line\">            <span class=\"keyword\">if</span> (mActive1 == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                mActive1 = mTasks.poll();</div><div class=\"line\">                <span class=\"keyword\">if</span> (mActive1 != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    mActive1.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mActive2 == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                mActive2 = mTasks.poll();</div><div class=\"line\">                <span class=\"keyword\">if</span> (mActive2 != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    mActive2.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"meta\">@Override</span></div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onGiftAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (mActive1 != <span class=\"keyword\">null</span> &amp;&amp; mActive1.isOver()) &#123;</div><div class=\"line\">                mActive1 = mTasks.poll();</div><div class=\"line\">                <span class=\"keyword\">if</span> (mActive1 != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    mActive1.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span> (mActive2 != <span class=\"keyword\">null</span> &amp;&amp; mActive2.isOver()) &#123;</div><div class=\"line\">                mActive2 = mTasks.poll();</div><div class=\"line\">                <span class=\"keyword\">if</span> (mActive2 != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                    mActive2.startAnimation(<span class=\"keyword\">this</span>);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 添加任务</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> gift     推送的Gift内容</div><div class=\"line\">     * <span class=\"doctag\">@param</span> listener 回调</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addNumAnimation</span><span class=\"params\">(PushGift gift, StaticGiftModel.StaticGiftListener listener)</span> </span>&#123;</div><div class=\"line\">        executor.execute(<span class=\"keyword\">new</span> StaticGiftModel(gift, listener));</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>可以看到，我在<code>StaticGiftExecutor</code>中定义了2个变量<code>mActive1</code>、<code>mActive2</code>，他们即代表两个出口。在<code>execute</code>中先判断<code>mActive1</code>是否为空，是则取出元素给它，让它执行动画。否则判断<code>mActive2</code>是否为空，是则取出元素给它，让它执行动画。<br>因为有两个出口，队列并不知道我的下一个任务要在哪个出口执行，所以具体的播放逻辑不能写在其中，所以我将具体的播放逻辑设计在<code>StaticGiftListener.startStaticAnimation()</code>的中，由调用的用户自行实现，并且在动画结束时，我需要回调队列的接口，来通知队列某某出口的动画执行完毕了。<br>实现片段代码如下：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\">     * 执行静态礼物动画</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> gift</div><div class=\"line\">     * <span class=\"doctag\">@param</span> nextListener</div><div class=\"line\">     */</span></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">startStaticAnimation</span><span class=\"params\">(<span class=\"keyword\">final</span> StaticGiftModel giftModel, PushGift gift, <span class=\"keyword\">final</span> GiftAnimationEndListener nextListener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (holder.staticLayout1.getVisibility() == View.GONE) &#123;</div><div class=\"line\">            holder.staticLayout1.setVisibility(View.VISIBLE);</div><div class=\"line\">            holder.staticGiftUserNick1.setText(gift.getUserNick());</div><div class=\"line\">            holder.staticGiftDesc1.setText(gift.getDescription());</div><div class=\"line\">            showIcon(gift.getUserIcon(), holder.staticGiftUserIcon1);</div><div class=\"line\">            <span class=\"comment\">// 获取对应礼物的本地下载路径</span></div><div class=\"line\">            String fileName = CommonUtils.MD5(gift.getGiftIcon());</div><div class=\"line\">            File savePath = <span class=\"keyword\">new</span> File(GiftManager.getInstance().getDownloadDir(), fileName);</div><div class=\"line\">            String path = <span class=\"string\">\"file://\"</span> + savePath.getAbsolutePath();</div><div class=\"line\">            ImageLoader.getInstance().displayImage(path, holder.staticGiftIcon1);</div><div class=\"line\">            holder.staticGiftView1.setListener(<span class=\"keyword\">new</span> StaticGiftView.StaticGiftAnimationListener() &#123;</div><div class=\"line\">                <span class=\"meta\">@Override</span></div><div class=\"line\">                <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">                    holder.staticLayout1.setVisibility(View.GONE);</div><div class=\"line\">                    giftModel.setOver(<span class=\"keyword\">true</span>);</div><div class=\"line\">                    nextListener.onGiftAnimationEnd();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;);</div><div class=\"line\">            holder.staticGiftView1.setNum(Integer.valueOf(gift.getNum()));</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (holder.staticLayout2.getVisibility() == View.GONE) &#123;</div><div class=\"line\">            holder.staticLayout2.setVisibility(View.VISIBLE);</div><div class=\"line\">            holder.staticGiftUserNick2.setText(gift.getUserNick());</div><div class=\"line\">            holder.staticGiftDesc2.setText(gift.getDescription());</div><div class=\"line\">            showIcon(gift.getUserIcon(), holder.staticGiftUserIcon2);</div><div class=\"line\">            <span class=\"comment\">// 获取对应礼物的本地下载路径</span></div><div class=\"line\">            String fileName = CommonUtils.MD5(gift.getGiftIcon());</div><div class=\"line\">            File savePath = <span class=\"keyword\">new</span> File(GiftManager.getInstance().getDownloadDir(), fileName);</div><div class=\"line\">            String path = <span class=\"string\">\"file://\"</span> + savePath.getAbsolutePath();</div><div class=\"line\">            ImageLoader.getInstance().displayImage(path, holder.staticGiftIcon2);</div><div class=\"line\">            holder.staticGiftView2.setListener(<span class=\"keyword\">new</span> StaticGiftView.StaticGiftAnimationListener() &#123;</div><div class=\"line\">                <span class=\"meta\">@Override</span></div><div class=\"line\">                <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">                    holder.staticLayout2.setVisibility(View.GONE);</div><div class=\"line\">                    giftModel.setOver(<span class=\"keyword\">true</span>);</div><div class=\"line\">                    nextListener.onGiftAnimationEnd();</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;);</div><div class=\"line\">            holder.staticGiftView2.setNum(Integer.valueOf(gift.getNum()));</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure></p>\n<p>静态礼物动画实现类StaticGiftView：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticGiftView</span> <span class=\"keyword\">extends</span> <span class=\"title\">TextView</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> current = <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> num;</div><div class=\"line\">    <span class=\"keyword\">private</span> StaticGiftAnimationListener listener;</div><div class=\"line\">    <span class=\"keyword\">private</span> Animation scaleAnimation = AnimationUtils.loadAnimation(getContext(), R.anim.gift_scale);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">StaticGiftView</span><span class=\"params\">(Context context)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">StaticGiftView</span><span class=\"params\">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">StaticGiftView</span><span class=\"params\">(Context context, AttributeSet attrs, <span class=\"keyword\">int</span> defStyleAttr)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(context, attrs, defStyleAttr);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setListener</span><span class=\"params\">(StaticGiftAnimationListener listener)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.listener = listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onDraw</span><span class=\"params\">(Canvas canvas)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onDraw(canvas);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setNum</span><span class=\"params\">(<span class=\"keyword\">int</span> num)</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.num = num;</div><div class=\"line\">        startAnimation(scaleAnimation);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">onAnimationEnd</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onAnimationEnd();</div><div class=\"line\">        current++;</div><div class=\"line\">        <span class=\"keyword\">if</span> (current &lt;= num) &#123;</div><div class=\"line\">            setText(<span class=\"string\">\"X \"</span> + current);</div><div class=\"line\">            startAnimation(scaleAnimation);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            current = <span class=\"number\">1</span>;</div><div class=\"line\">            <span class=\"keyword\">if</span> (listener != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                listener.onAnimationEnd();</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">StaticGiftAnimationListener</span> </span>&#123;</div><div class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onAnimationEnd</span><span class=\"params\">()</span></span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>静态礼物是通过<code>StaticGiftView</code>的<code>setNum()</code>方法来显示动画的，就是显示一个数量递增，同时伴随着缩放的动画。<br>页面布局中有<code>staticLayout1</code>和<code>staticLayout2</code>，分别代表两个执行动画的布局，通过判断<code>getVisibility()</code>是否为<code>GONE</code>来决定是否将动画分发给这个布局。在动画开始时，将布局设置成VISIBLE，在动画结束后，再将布局设置成GONE。<br>我通过<code>setOver(true)</code>来告知队列某某出口的动画执行完毕，然后队列回调到<code>onGiftAnimationEnd()</code>中，继续取出任务分配给有空的出口。</p>\n<p>调用如下代码将任务添加到队列便能顺序播放动画了。<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">StaticGift</span><span class=\"selector-class\">.getInstance</span>()<span class=\"selector-class\">.addNumAnimation</span>(<span class=\"selector-tag\">pushGift</span>, <span class=\"selector-tag\">listener</span>);</div></pre></td></tr></table></figure></p>\n<h2 id=\"待优化\"><a href=\"#待优化\" class=\"headerlink\" title=\"待优化\"></a>待优化</h2><ol>\n<li>代码之间的依赖很重，任务队列直接依赖到了前端的UI组件，需要解耦。</li>\n<li>若是增加至三个、四个或是更多个出口，代码就得一直添加<code>mActive</code>了，不利于拓展。</li>\n</ol>"},{"title":"Android使用VideoView进行视频播放","date":"2016-04-01T07:07:19.000Z","_content":"\n最近在做一个主播类的App，里面涉及到视频播放，之前没有接触过，在探索一阵后能够播放基本视频了。特此写下小记，方便日后查看。\n\n首先，确定使用``VideoView``进行视频播放。\n\n步骤：\n1. 在界面布局文件中定义VideoView组件，或在程序中创建VideoView组件。\n2. 调用VideoView的如下两个方法来加载指定的视频:\n - setVidePath(String path)：加载path文件代表的视频\n - setVideoURI(Uri uri)：加载uri所对应的视频\n3. 调用VideoView的start()、stop()、psuse()等方法来控制视频的播放。\n\n若要显示进度条，可结合``MediaController``一起使用。\n\n<!--more -->\n\n下面代码进行说明。\n\n布局文件：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<RelativeLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\">\n\n    <VideoView\n        android:id=\"@+id/video_view\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\" />\n\n</RelativeLayout>\n```\nActivity：\n```\npublic class VideoPlayActivity extends AppCompatActivity {\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_video_play);\n\n        VideoView videoView = (VideoView) this.findViewById(R.id.video_view);\n        videoView.setMediaController(new MediaController(this)); // 添加MediaController\n        videoView.setVideoPath(\"你的视频路径\"); // 设置路径\n        videoView.requestFocus(); // 获取焦点\n        videoView.start(); // 播放\n        videoView.setOnCompletionListener(new MediaPlayer.OnCompletionListener() {\n            @Override\n            public void onCompletion(MediaPlayer mp) {\n                finish(); // 播放结束回调\n            }\n        });\n    }\n}\n```\n因为视频播放一般是全屏，直接使用系统的FullScreen会提示需要使用AppCompat主题，所以我给Activity设置了一个style。\n```\n<style name=\"NoTitleFullscreen\" parent=\"AppTheme\">\n    <item name=\"android:windowNoTitle\">true</item>\n    <item name=\"windowActionBar\">false</item>\n    <item name=\"android:windowFullscreen\">true</item>\n    <item name=\"android:windowContentOverlay\">@null</item>\n</style>\n```\n```\n<activity\n    android:name=\".ui.VideoPlayActivity\"\n    android:screenOrientation=\"portrait\"\n    android:theme=\"@style/NoTitleFullscreen\">\n</activity>\n```\n\n实际效果：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/video_vieweffect.gif)\n\n因为是虚拟机，效果看起来可能不太满意，但是至少视频是能播放了。\n后续可能还有屏幕视频适配的问题，现在就不多说了，后面解决了再来更新。\n\n问题：VideoView加载资源需要一定的耗时, 会造成短暂的黑屏现象。\n如何避免播放前的黑屏现象呢？可以给videoview设置加载的监听，在加载前给一个遮罩，等资源加载完成后隐藏遮罩。\n```\n<FrameLayout  \n  android:id=\"@+id/frameLayout1\"  \n  android:layout_width=\"fill_parent\"  \n  android:layout_height=\"fill_parent\"  \n  android:layout_gravity=\"center\"  \n  android:layout_marginTop=\"50dip\" >  \n\n  <VideoView  \n    android:id=\"@+id/geoloc_anim\"  \n    android:layout_width=\"fill_parent\"  \n    android:layout_height=\"172dip\" android:layout_gravity=\"top|center\" android:visibility=\"visible\"/>  \n\n  <FrameLayout  \n      android:id=\"@+id/placeholder\"  \n      android:layout_width=\"fill_parent\"  \n      android:layout_height=\"fill_parent\" android:background=\"@drawable/fondvert_anim\">  \n  </FrameLayout>\n</FrameLayout>\n```\n设置监听：\n```\nvideoView.setOnPreparedListener(new MediaPlayer.OnPreparedListener() {  \n    @Override  \n    public void onPrepared(MediaPlayer mediaPlayer) {  \n        //Called when the video is ready to play  \n        View placeholder = findViewById(R.id.placeholder);  \n\n        placeholder.setVisibility(View.GONE);  \n    }  \n});  \n```\n\n今天是愚人节，节日快乐哦~\n","source":"_posts/video-view.md","raw":"---\ntitle: Android使用VideoView进行视频播放\ndate: 2016-04-01 15:07:19\ntags:\n - 日常开发\n---\n\n最近在做一个主播类的App，里面涉及到视频播放，之前没有接触过，在探索一阵后能够播放基本视频了。特此写下小记，方便日后查看。\n\n首先，确定使用``VideoView``进行视频播放。\n\n步骤：\n1. 在界面布局文件中定义VideoView组件，或在程序中创建VideoView组件。\n2. 调用VideoView的如下两个方法来加载指定的视频:\n - setVidePath(String path)：加载path文件代表的视频\n - setVideoURI(Uri uri)：加载uri所对应的视频\n3. 调用VideoView的start()、stop()、psuse()等方法来控制视频的播放。\n\n若要显示进度条，可结合``MediaController``一起使用。\n\n<!--more -->\n\n下面代码进行说明。\n\n布局文件：\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<RelativeLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n    android:layout_width=\"match_parent\"\n    android:layout_height=\"match_parent\">\n\n    <VideoView\n        android:id=\"@+id/video_view\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\" />\n\n</RelativeLayout>\n```\nActivity：\n```\npublic class VideoPlayActivity extends AppCompatActivity {\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_video_play);\n\n        VideoView videoView = (VideoView) this.findViewById(R.id.video_view);\n        videoView.setMediaController(new MediaController(this)); // 添加MediaController\n        videoView.setVideoPath(\"你的视频路径\"); // 设置路径\n        videoView.requestFocus(); // 获取焦点\n        videoView.start(); // 播放\n        videoView.setOnCompletionListener(new MediaPlayer.OnCompletionListener() {\n            @Override\n            public void onCompletion(MediaPlayer mp) {\n                finish(); // 播放结束回调\n            }\n        });\n    }\n}\n```\n因为视频播放一般是全屏，直接使用系统的FullScreen会提示需要使用AppCompat主题，所以我给Activity设置了一个style。\n```\n<style name=\"NoTitleFullscreen\" parent=\"AppTheme\">\n    <item name=\"android:windowNoTitle\">true</item>\n    <item name=\"windowActionBar\">false</item>\n    <item name=\"android:windowFullscreen\">true</item>\n    <item name=\"android:windowContentOverlay\">@null</item>\n</style>\n```\n```\n<activity\n    android:name=\".ui.VideoPlayActivity\"\n    android:screenOrientation=\"portrait\"\n    android:theme=\"@style/NoTitleFullscreen\">\n</activity>\n```\n\n实际效果：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/04/video_vieweffect.gif)\n\n因为是虚拟机，效果看起来可能不太满意，但是至少视频是能播放了。\n后续可能还有屏幕视频适配的问题，现在就不多说了，后面解决了再来更新。\n\n问题：VideoView加载资源需要一定的耗时, 会造成短暂的黑屏现象。\n如何避免播放前的黑屏现象呢？可以给videoview设置加载的监听，在加载前给一个遮罩，等资源加载完成后隐藏遮罩。\n```\n<FrameLayout  \n  android:id=\"@+id/frameLayout1\"  \n  android:layout_width=\"fill_parent\"  \n  android:layout_height=\"fill_parent\"  \n  android:layout_gravity=\"center\"  \n  android:layout_marginTop=\"50dip\" >  \n\n  <VideoView  \n    android:id=\"@+id/geoloc_anim\"  \n    android:layout_width=\"fill_parent\"  \n    android:layout_height=\"172dip\" android:layout_gravity=\"top|center\" android:visibility=\"visible\"/>  \n\n  <FrameLayout  \n      android:id=\"@+id/placeholder\"  \n      android:layout_width=\"fill_parent\"  \n      android:layout_height=\"fill_parent\" android:background=\"@drawable/fondvert_anim\">  \n  </FrameLayout>\n</FrameLayout>\n```\n设置监听：\n```\nvideoView.setOnPreparedListener(new MediaPlayer.OnPreparedListener() {  \n    @Override  \n    public void onPrepared(MediaPlayer mediaPlayer) {  \n        //Called when the video is ready to play  \n        View placeholder = findViewById(R.id.placeholder);  \n\n        placeholder.setVisibility(View.GONE);  \n    }  \n});  \n```\n\n今天是愚人节，节日快乐哦~\n","slug":"video-view","published":1,"updated":"2016-11-21T10:03:58.079Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75aj003c1cb82yql0otw","content":"<p>最近在做一个主播类的App，里面涉及到视频播放，之前没有接触过，在探索一阵后能够播放基本视频了。特此写下小记，方便日后查看。</p>\n<p>首先，确定使用<code>VideoView</code>进行视频播放。</p>\n<p>步骤：</p>\n<ol>\n<li>在界面布局文件中定义VideoView组件，或在程序中创建VideoView组件。</li>\n<li>调用VideoView的如下两个方法来加载指定的视频:<ul>\n<li>setVidePath(String path)：加载path文件代表的视频</li>\n<li>setVideoURI(Uri uri)：加载uri所对应的视频</li>\n</ul>\n</li>\n<li>调用VideoView的start()、stop()、psuse()等方法来控制视频的播放。</li>\n</ol>\n<p>若要显示进度条，可结合<code>MediaController</code>一起使用。</p>\n<a id=\"more\"></a>\n<p>下面代码进行说明。</p>\n<p>布局文件：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">RelativeLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">VideoView</span></span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/video_view\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span> /&gt;</div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>Activity：<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">VideoPlayActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onCreate(<span class=\"type\">Bundle</span> savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(<span class=\"type\">R</span>.layout.activity_video_play);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"type\">VideoView</span> videoView = (<span class=\"type\">VideoView</span>) <span class=\"keyword\">this</span>.findViewById(<span class=\"type\">R</span>.id.video_view);</div><div class=\"line\">        videoView.setMediaController(<span class=\"keyword\">new</span> <span class=\"type\">MediaController</span>(<span class=\"keyword\">this</span>)); <span class=\"comment\">// 添加MediaController</span></div><div class=\"line\">        videoView.setVideoPath(<span class=\"string\">\"你的视频路径\"</span>); <span class=\"comment\">// 设置路径</span></div><div class=\"line\">        videoView.requestFocus(); <span class=\"comment\">// 获取焦点</span></div><div class=\"line\">        videoView.start(); <span class=\"comment\">// 播放</span></div><div class=\"line\">        videoView.setOnCompletionListener(<span class=\"keyword\">new</span> <span class=\"type\">MediaPlayer</span>.<span class=\"type\">OnCompletionListener</span>() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            public void onCompletion(<span class=\"type\">MediaPlayer</span> mp) &#123;</div><div class=\"line\">                finish(); <span class=\"comment\">// 播放结束回调</span></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>因为视频播放一般是全屏，直接使用系统的FullScreen会提示需要使用AppCompat主题，所以我给Activity设置了一个style。<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;style <span class=\"built_in\">name</span>=<span class=\"string\">\"NoTitleFullscreen\"</span> parent=<span class=\"string\">\"AppTheme\"</span>&gt;</div><div class=\"line\">    &lt;<span class=\"built_in\">item</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"android:windowNoTitle\"</span>&gt;<span class=\"literal\">true</span>&lt;/<span class=\"built_in\">item</span>&gt;</div><div class=\"line\">    &lt;<span class=\"built_in\">item</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"windowActionBar\"</span>&gt;<span class=\"literal\">false</span>&lt;/<span class=\"built_in\">item</span>&gt;</div><div class=\"line\">    &lt;<span class=\"built_in\">item</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"android:windowFullscreen\"</span>&gt;<span class=\"literal\">true</span>&lt;/<span class=\"built_in\">item</span>&gt;</div><div class=\"line\">    &lt;<span class=\"built_in\">item</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"android:windowContentOverlay\"</span>&gt;@null&lt;/<span class=\"built_in\">item</span>&gt;</div><div class=\"line\">&lt;/style&gt;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span></span></div><div class=\"line\">    <span class=\"attr\">android:name</span>=<span class=\"string\">\".ui.VideoPlayActivity\"</span></div><div class=\"line\">    <span class=\"attr\">android:screenOrientation</span>=<span class=\"string\">\"portrait\"</span></div><div class=\"line\">    <span class=\"attr\">android:theme</span>=<span class=\"string\">\"@style/NoTitleFullscreen\"</span>&gt;</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>实际效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/video_vieweffect.gif\" alt=\"\"></p>\n<p>因为是虚拟机，效果看起来可能不太满意，但是至少视频是能播放了。<br>后续可能还有屏幕视频适配的问题，现在就不多说了，后面解决了再来更新。</p>\n<p>问题：VideoView加载资源需要一定的耗时, 会造成短暂的黑屏现象。<br>如何避免播放前的黑屏现象呢？可以给videoview设置加载的监听，在加载前给一个遮罩，等资源加载完成后隐藏遮罩。<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span>  </span></div><div class=\"line\">  <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/frameLayout1\"</span>  </div><div class=\"line\">  <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"fill_parent\"</span>  </div><div class=\"line\">  <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"fill_parent\"</span>  </div><div class=\"line\">  <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center\"</span>  </div><div class=\"line\">  <span class=\"attr\">android:layout_marginTop</span>=<span class=\"string\">\"50dip\"</span> &gt;  </div><div class=\"line\"></div><div class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">VideoView</span>  </span></div><div class=\"line\">    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/geoloc_anim\"</span>  </div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"fill_parent\"</span>  </div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"172dip\"</span> <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"top|center\"</span> <span class=\"attr\">android:visibility</span>=<span class=\"string\">\"visible\"</span>/&gt;  </div><div class=\"line\"></div><div class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span>  </span></div><div class=\"line\">      <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/placeholder\"</span>  </div><div class=\"line\">      <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"fill_parent\"</span>  </div><div class=\"line\">      <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"fill_parent\"</span> <span class=\"attr\">android:background</span>=<span class=\"string\">\"@drawable/fondvert_anim\"</span>&gt;  </div><div class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>设置监听：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">videoView.setOnPreparedListener(<span class=\"keyword\">new</span> MediaPlayer.OnPreparedListener() &#123;  </div><div class=\"line\">    <span class=\"meta\">@Override</span>  </div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onPrepared</span><span class=\"params\">(MediaPlayer mediaPlayer)</span> </span>&#123;  </div><div class=\"line\">        <span class=\"comment\">//Called when the video is ready to play  </span></div><div class=\"line\">        View placeholder = findViewById(R.id.placeholder);  </div><div class=\"line\"></div><div class=\"line\">        placeholder.setVisibility(View.GONE);  </div><div class=\"line\">    &#125;  </div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>今天是愚人节，节日快乐哦~</p>\n","excerpt":"<p>最近在做一个主播类的App，里面涉及到视频播放，之前没有接触过，在探索一阵后能够播放基本视频了。特此写下小记，方便日后查看。</p>\n<p>首先，确定使用<code>VideoView</code>进行视频播放。</p>\n<p>步骤：</p>\n<ol>\n<li>在界面布局文件中定义VideoView组件，或在程序中创建VideoView组件。</li>\n<li>调用VideoView的如下两个方法来加载指定的视频:<ul>\n<li>setVidePath(String path)：加载path文件代表的视频</li>\n<li>setVideoURI(Uri uri)：加载uri所对应的视频</li>\n</ul>\n</li>\n<li>调用VideoView的start()、stop()、psuse()等方法来控制视频的播放。</li>\n</ol>\n<p>若要显示进度条，可结合<code>MediaController</code>一起使用。</p>","more":"<p>下面代码进行说明。</p>\n<p>布局文件：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"utf-8\"</span><span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">RelativeLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">VideoView</span></div><div class=\"line\">        <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/video_view\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"match_parent\"</span></div><div class=\"line\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"match_parent\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>Activity：<br><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\">public <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">VideoPlayActivity</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppCompatActivity</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> void onCreate(<span class=\"type\">Bundle</span> savedInstanceState) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</div><div class=\"line\">        setContentView(<span class=\"type\">R</span>.layout.activity_video_play);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"type\">VideoView</span> videoView = (<span class=\"type\">VideoView</span>) <span class=\"keyword\">this</span>.findViewById(<span class=\"type\">R</span>.id.video_view);</div><div class=\"line\">        videoView.setMediaController(<span class=\"keyword\">new</span> <span class=\"type\">MediaController</span>(<span class=\"keyword\">this</span>)); <span class=\"comment\">// 添加MediaController</span></div><div class=\"line\">        videoView.setVideoPath(<span class=\"string\">\"你的视频路径\"</span>); <span class=\"comment\">// 设置路径</span></div><div class=\"line\">        videoView.requestFocus(); <span class=\"comment\">// 获取焦点</span></div><div class=\"line\">        videoView.start(); <span class=\"comment\">// 播放</span></div><div class=\"line\">        videoView.setOnCompletionListener(<span class=\"keyword\">new</span> <span class=\"type\">MediaPlayer</span>.<span class=\"type\">OnCompletionListener</span>() &#123;</div><div class=\"line\">            <span class=\"meta\">@Override</span></div><div class=\"line\">            public void onCompletion(<span class=\"type\">MediaPlayer</span> mp) &#123;</div><div class=\"line\">                finish(); <span class=\"comment\">// 播放结束回调</span></div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>因为视频播放一般是全屏，直接使用系统的FullScreen会提示需要使用AppCompat主题，所以我给Activity设置了一个style。<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;style <span class=\"built_in\">name</span>=<span class=\"string\">\"NoTitleFullscreen\"</span> parent=<span class=\"string\">\"AppTheme\"</span>&gt;</div><div class=\"line\">    &lt;<span class=\"built_in\">item</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"android:windowNoTitle\"</span>&gt;<span class=\"literal\">true</span>&lt;/<span class=\"built_in\">item</span>&gt;</div><div class=\"line\">    &lt;<span class=\"built_in\">item</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"windowActionBar\"</span>&gt;<span class=\"literal\">false</span>&lt;/<span class=\"built_in\">item</span>&gt;</div><div class=\"line\">    &lt;<span class=\"built_in\">item</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"android:windowFullscreen\"</span>&gt;<span class=\"literal\">true</span>&lt;/<span class=\"built_in\">item</span>&gt;</div><div class=\"line\">    &lt;<span class=\"built_in\">item</span> <span class=\"built_in\">name</span>=<span class=\"string\">\"android:windowContentOverlay\"</span>&gt;@null&lt;/<span class=\"built_in\">item</span>&gt;</div><div class=\"line\">&lt;/style&gt;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span></div><div class=\"line\">    <span class=\"attr\">android:name</span>=<span class=\"string\">\".ui.VideoPlayActivity\"</span></div><div class=\"line\">    <span class=\"attr\">android:screenOrientation</span>=<span class=\"string\">\"portrait\"</span></div><div class=\"line\">    <span class=\"attr\">android:theme</span>=<span class=\"string\">\"@style/NoTitleFullscreen\"</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>实际效果：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/04/video_vieweffect.gif\" alt=\"\"></p>\n<p>因为是虚拟机，效果看起来可能不太满意，但是至少视频是能播放了。<br>后续可能还有屏幕视频适配的问题，现在就不多说了，后面解决了再来更新。</p>\n<p>问题：VideoView加载资源需要一定的耗时, 会造成短暂的黑屏现象。<br>如何避免播放前的黑屏现象呢？可以给videoview设置加载的监听，在加载前给一个遮罩，等资源加载完成后隐藏遮罩。<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span>  </div><div class=\"line\">  <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/frameLayout1\"</span>  </div><div class=\"line\">  <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"fill_parent\"</span>  </div><div class=\"line\">  <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"fill_parent\"</span>  </div><div class=\"line\">  <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"center\"</span>  </div><div class=\"line\">  <span class=\"attr\">android:layout_marginTop</span>=<span class=\"string\">\"50dip\"</span> &gt;</span>  </div><div class=\"line\"></div><div class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">VideoView</span>  </div><div class=\"line\">    <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/geoloc_anim\"</span>  </div><div class=\"line\">    <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"fill_parent\"</span>  </div><div class=\"line\">    <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"172dip\"</span> <span class=\"attr\">android:layout_gravity</span>=<span class=\"string\">\"top|center\"</span> <span class=\"attr\">android:visibility</span>=<span class=\"string\">\"visible\"</span>/&gt;</span>  </div><div class=\"line\"></div><div class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span>  </div><div class=\"line\">      <span class=\"attr\">android:id</span>=<span class=\"string\">\"@+id/placeholder\"</span>  </div><div class=\"line\">      <span class=\"attr\">android:layout_width</span>=<span class=\"string\">\"fill_parent\"</span>  </div><div class=\"line\">      <span class=\"attr\">android:layout_height</span>=<span class=\"string\">\"fill_parent\"</span> <span class=\"attr\">android:background</span>=<span class=\"string\">\"@drawable/fondvert_anim\"</span>&gt;</span>  </div><div class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<p>设置监听：<br><figure class=\"highlight aspectj\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">videoView.setOnPreparedListener(<span class=\"keyword\">new</span> MediaPlayer.OnPreparedListener() &#123;  </div><div class=\"line\">    <span class=\"meta\">@Override</span>  </div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onPrepared</span><span class=\"params\">(MediaPlayer mediaPlayer)</span> </span>&#123;  </div><div class=\"line\">        <span class=\"comment\">//Called when the video is ready to play  </span></div><div class=\"line\">        View placeholder = findViewById(R.id.placeholder);  </div><div class=\"line\"></div><div class=\"line\">        placeholder.setVisibility(View.GONE);  </div><div class=\"line\">    &#125;  </div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure></p>\n<p>今天是愚人节，节日快乐哦~</p>"},{"title":"android接入微信支付SDK","date":"2016-03-18T07:04:30.000Z","_content":"\n本文主要讲述一下android接入微信支付SDK的步骤以及需要注意的一些Tips。\n\n## 前期准备\n接入微信支付SDK前期需要许多前期准备。\n### 微信开放平台\n1. 注册[微信开放平台](https://open.weixin.qq.com/)账号。\n2. 登录账号，进入管理中心，创建你的App应用，创建应用的包名与签名要与你实际的应用一致。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk1.png)\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk5.png)\n3. 进入应用详情，获取``AppID``，以及申请开通微信支付能力。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk2.png)\n4. 等待审核通过。\n\n<!--more-->\n\n### 微信商户平台\n1. 注册[微信商户平台](https://pay.weixin.qq.com)账号。\n2. 登录账号，在基本信息中获得``微信支付商户号``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk3.png)\n3. 安装操作证书，然后进入API安全设置``秘钥``，最好使用UUID自动生成的，记住这个``秘钥``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk4.png)\nOK，前期准备做完，下面进行代码接入。\n\n## 工程接入SDK\n### 新建应用工程\n以AS为例，新建工程，注意包名与使用的签名要与微信开放平台申请应用时填写的一致。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk8.png)\n### 引入libs\n将``libammsdk.jar``放到libs文件夹下。\n### 配置debug、release的签名文件\n```\nsigningConfigs {\n        debug {\n            storeFile file(\"你的keystore路径\")\n            storePassword \"xxx\"\n            keyAlias \"xxx\"\n            keyPassword \"xxx\"\n        }\n\n        release {\n            storeFile file(\"你的keystore路径\")\n            storePassword \"xxx\"\n            keyAlias \"xxx\"\n            keyPassword \"xxx\"\n        }\n    }\n```\n这里debug、realse我采用的是一样的签名。不论是debug，还是release都能对应上。\n### AndroidManifest.xml中配置\n```\n<activity android:name=\".MainActivity\">\n    <intent-filter>\n        <action android:name=\"android.intent.action.MAIN\" />\n\n        <category android:name=\"android.intent.category.LAUNCHER\" />\n    </intent-filter>\n\n    <intent-filter>\n        <action android:name=\"android.intent.action.VIEW\" />\n        <category android:name=\"android.intent.category.DEFAULT\" />\n        <data android:scheme=\"你的AppID\" />\n    </intent-filter>\n</activity>\n```\n也别忘记加入网络权限。\n### 获取prepay_id\n在支付之前，都需要调用微信的接口``https://api.mch.weixin.qq.com/pay/unifiedorder``来获得prepay_id。\n### 支付\n获取到prepay_id之后，调用``IWXAPI``的``sendReq``方法即可完成支付。\n### 添加支付成功回调Activity\n添加``wxapi``的包名，在这个包名下必须要有``WXPayEntryActivity``这个Activity，支付成功后会显示此界面。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk6.png)\n\n调用接口相关参数以及返回值参考[开发者手册](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_1)。\n\n\n## Tips\n下面说一下接入过程中需要注意的点。\n1. 官网下的demo，第一次支付时，能成功。之后就会一直支付失败。原因是：支付的时候商户唯一订单ID是唯一的，测试的时候请不断的更换订单ID参数支付。若要继续使用demo支付，可以微信清除数据、或者退出登录重新登录。\n2. 微信支付返回-1，一般是``签名``错误。这个签名有2种意思：1、Apk签名文件，debug与release最好使用同样的keystore；2、参数MD5签名生成的sign。要仔细检查是否正确。\n3. 签名、包名必须跟微信开放平台申请的一致.\n4. 获取prepay_id最好是在服务器完成，由服务器去跟微信服务器交互，客户端不需要参与，以免泄露重要信息。\n5. 与微信接口交互时，参数都需要签名。签名方法如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk7.png)\n这里重点说一下。\n - 参数名ASCII码从小到大排序（字典序）\n - 参数名区分大小写，包括sign。\n - 需要添加商户key值，这个key即是在前期准备中，我所说的微信商户的那个``秘钥``。\n\n若接入过程中注意到这些Tips，一步一步来，那么应该是能支付成功了。\n","source":"_posts/wechat-sdk.md","raw":"---\ntitle: android接入微信支付SDK\ndate: 2016-03-18 15:04:30\ntags:\n - sdk\n---\n\n本文主要讲述一下android接入微信支付SDK的步骤以及需要注意的一些Tips。\n\n## 前期准备\n接入微信支付SDK前期需要许多前期准备。\n### 微信开放平台\n1. 注册[微信开放平台](https://open.weixin.qq.com/)账号。\n2. 登录账号，进入管理中心，创建你的App应用，创建应用的包名与签名要与你实际的应用一致。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk1.png)\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk5.png)\n3. 进入应用详情，获取``AppID``，以及申请开通微信支付能力。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk2.png)\n4. 等待审核通过。\n\n<!--more-->\n\n### 微信商户平台\n1. 注册[微信商户平台](https://pay.weixin.qq.com)账号。\n2. 登录账号，在基本信息中获得``微信支付商户号``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk3.png)\n3. 安装操作证书，然后进入API安全设置``秘钥``，最好使用UUID自动生成的，记住这个``秘钥``。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk4.png)\nOK，前期准备做完，下面进行代码接入。\n\n## 工程接入SDK\n### 新建应用工程\n以AS为例，新建工程，注意包名与使用的签名要与微信开放平台申请应用时填写的一致。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk8.png)\n### 引入libs\n将``libammsdk.jar``放到libs文件夹下。\n### 配置debug、release的签名文件\n```\nsigningConfigs {\n        debug {\n            storeFile file(\"你的keystore路径\")\n            storePassword \"xxx\"\n            keyAlias \"xxx\"\n            keyPassword \"xxx\"\n        }\n\n        release {\n            storeFile file(\"你的keystore路径\")\n            storePassword \"xxx\"\n            keyAlias \"xxx\"\n            keyPassword \"xxx\"\n        }\n    }\n```\n这里debug、realse我采用的是一样的签名。不论是debug，还是release都能对应上。\n### AndroidManifest.xml中配置\n```\n<activity android:name=\".MainActivity\">\n    <intent-filter>\n        <action android:name=\"android.intent.action.MAIN\" />\n\n        <category android:name=\"android.intent.category.LAUNCHER\" />\n    </intent-filter>\n\n    <intent-filter>\n        <action android:name=\"android.intent.action.VIEW\" />\n        <category android:name=\"android.intent.category.DEFAULT\" />\n        <data android:scheme=\"你的AppID\" />\n    </intent-filter>\n</activity>\n```\n也别忘记加入网络权限。\n### 获取prepay_id\n在支付之前，都需要调用微信的接口``https://api.mch.weixin.qq.com/pay/unifiedorder``来获得prepay_id。\n### 支付\n获取到prepay_id之后，调用``IWXAPI``的``sendReq``方法即可完成支付。\n### 添加支付成功回调Activity\n添加``wxapi``的包名，在这个包名下必须要有``WXPayEntryActivity``这个Activity，支付成功后会显示此界面。\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk6.png)\n\n调用接口相关参数以及返回值参考[开发者手册](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_1)。\n\n\n## Tips\n下面说一下接入过程中需要注意的点。\n1. 官网下的demo，第一次支付时，能成功。之后就会一直支付失败。原因是：支付的时候商户唯一订单ID是唯一的，测试的时候请不断的更换订单ID参数支付。若要继续使用demo支付，可以微信清除数据、或者退出登录重新登录。\n2. 微信支付返回-1，一般是``签名``错误。这个签名有2种意思：1、Apk签名文件，debug与release最好使用同样的keystore；2、参数MD5签名生成的sign。要仔细检查是否正确。\n3. 签名、包名必须跟微信开放平台申请的一致.\n4. 获取prepay_id最好是在服务器完成，由服务器去跟微信服务器交互，客户端不需要参与，以免泄露重要信息。\n5. 与微信接口交互时，参数都需要签名。签名方法如下图：\n![](http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk7.png)\n这里重点说一下。\n - 参数名ASCII码从小到大排序（字典序）\n - 参数名区分大小写，包括sign。\n - 需要添加商户key值，这个key即是在前期准备中，我所说的微信商户的那个``秘钥``。\n\n若接入过程中注意到这些Tips，一步一步来，那么应该是能支付成功了。\n","slug":"wechat-sdk","published":1,"updated":"2016-11-21T10:04:02.702Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciw3e75ak003e1cb813vgqd8l","content":"<p>本文主要讲述一下android接入微信支付SDK的步骤以及需要注意的一些Tips。</p>\n<h2 id=\"前期准备\"><a href=\"#前期准备\" class=\"headerlink\" title=\"前期准备\"></a>前期准备</h2><p>接入微信支付SDK前期需要许多前期准备。</p>\n<h3 id=\"微信开放平台\"><a href=\"#微信开放平台\" class=\"headerlink\" title=\"微信开放平台\"></a>微信开放平台</h3><ol>\n<li>注册<a href=\"https://open.weixin.qq.com/\" target=\"_blank\" rel=\"external\">微信开放平台</a>账号。</li>\n<li>登录账号，进入管理中心，创建你的App应用，创建应用的包名与签名要与你实际的应用一致。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk1.png\" alt=\"\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk5.png\" alt=\"\"></li>\n<li>进入应用详情，获取<code>AppID</code>，以及申请开通微信支付能力。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk2.png\" alt=\"\"></li>\n<li>等待审核通过。</li>\n</ol>\n<a id=\"more\"></a>\n<h3 id=\"微信商户平台\"><a href=\"#微信商户平台\" class=\"headerlink\" title=\"微信商户平台\"></a>微信商户平台</h3><ol>\n<li>注册<a href=\"https://pay.weixin.qq.com\" target=\"_blank\" rel=\"external\">微信商户平台</a>账号。</li>\n<li>登录账号，在基本信息中获得<code>微信支付商户号</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk3.png\" alt=\"\"></li>\n<li>安装操作证书，然后进入API安全设置<code>秘钥</code>，最好使用UUID自动生成的，记住这个<code>秘钥</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk4.png\" alt=\"\"><br>OK，前期准备做完，下面进行代码接入。</li>\n</ol>\n<h2 id=\"工程接入SDK\"><a href=\"#工程接入SDK\" class=\"headerlink\" title=\"工程接入SDK\"></a>工程接入SDK</h2><h3 id=\"新建应用工程\"><a href=\"#新建应用工程\" class=\"headerlink\" title=\"新建应用工程\"></a>新建应用工程</h3><p>以AS为例，新建工程，注意包名与使用的签名要与微信开放平台申请应用时填写的一致。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk8.png\" alt=\"\"></p>\n<h3 id=\"引入libs\"><a href=\"#引入libs\" class=\"headerlink\" title=\"引入libs\"></a>引入libs</h3><p>将<code>libammsdk.jar</code>放到libs文件夹下。</p>\n<h3 id=\"配置debug、release的签名文件\"><a href=\"#配置debug、release的签名文件\" class=\"headerlink\" title=\"配置debug、release的签名文件\"></a>配置debug、release的签名文件</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">signingConfigs</span> &#123;</div><div class=\"line\">        <span class=\"section\">debug</span> &#123;</div><div class=\"line\">            <span class=\"attribute\">storeFile</span> file(<span class=\"string\">\"你的keystore路径\"</span>)</div><div class=\"line\">            storePassword <span class=\"string\">\"xxx\"</span></div><div class=\"line\">            keyAlias <span class=\"string\">\"xxx\"</span></div><div class=\"line\">            keyPassword <span class=\"string\">\"xxx\"</span></div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        release &#123;</div><div class=\"line\">            <span class=\"attribute\">storeFile</span> file(<span class=\"string\">\"你的keystore路径\"</span>)</div><div class=\"line\">            storePassword <span class=\"string\">\"xxx\"</span></div><div class=\"line\">            keyAlias <span class=\"string\">\"xxx\"</span></div><div class=\"line\">            keyPassword <span class=\"string\">\"xxx\"</span></div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure>\n<p>这里debug、realse我采用的是一样的签名。不论是debug，还是release都能对应上。</p>\n<h3 id=\"AndroidManifest-xml中配置\"><a href=\"#AndroidManifest-xml中配置\" class=\"headerlink\" title=\"AndroidManifest.xml中配置\"></a>AndroidManifest.xml中配置</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\".MainActivity\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.action.MAIN\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.LAUNCHER\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.action.VIEW\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.DEFAULT\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">data</span> <span class=\"attr\">android:scheme</span>=<span class=\"string\">\"你的AppID\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>也别忘记加入网络权限。</p>\n<h3 id=\"获取prepay-id\"><a href=\"#获取prepay-id\" class=\"headerlink\" title=\"获取prepay_id\"></a>获取prepay_id</h3><p>在支付之前，都需要调用微信的接口<code>https://api.mch.weixin.qq.com/pay/unifiedorder</code>来获得prepay_id。</p>\n<h3 id=\"支付\"><a href=\"#支付\" class=\"headerlink\" title=\"支付\"></a>支付</h3><p>获取到prepay_id之后，调用<code>IWXAPI</code>的<code>sendReq</code>方法即可完成支付。</p>\n<h3 id=\"添加支付成功回调Activity\"><a href=\"#添加支付成功回调Activity\" class=\"headerlink\" title=\"添加支付成功回调Activity\"></a>添加支付成功回调Activity</h3><p>添加<code>wxapi</code>的包名，在这个包名下必须要有<code>WXPayEntryActivity</code>这个Activity，支付成功后会显示此界面。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk6.png\" alt=\"\"></p>\n<p>调用接口相关参数以及返回值参考<a href=\"https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_1\" target=\"_blank\" rel=\"external\">开发者手册</a>。</p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><p>下面说一下接入过程中需要注意的点。</p>\n<ol>\n<li>官网下的demo，第一次支付时，能成功。之后就会一直支付失败。原因是：支付的时候商户唯一订单ID是唯一的，测试的时候请不断的更换订单ID参数支付。若要继续使用demo支付，可以微信清除数据、或者退出登录重新登录。</li>\n<li>微信支付返回-1，一般是<code>签名</code>错误。这个签名有2种意思：1、Apk签名文件，debug与release最好使用同样的keystore；2、参数MD5签名生成的sign。要仔细检查是否正确。</li>\n<li>签名、包名必须跟微信开放平台申请的一致.</li>\n<li>获取prepay_id最好是在服务器完成，由服务器去跟微信服务器交互，客户端不需要参与，以免泄露重要信息。</li>\n<li>与微信接口交互时，参数都需要签名。签名方法如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk7.png\" alt=\"\"><br>这里重点说一下。<ul>\n<li>参数名ASCII码从小到大排序（字典序）</li>\n<li>参数名区分大小写，包括sign。</li>\n<li>需要添加商户key值，这个key即是在前期准备中，我所说的微信商户的那个<code>秘钥</code>。</li>\n</ul>\n</li>\n</ol>\n<p>若接入过程中注意到这些Tips，一步一步来，那么应该是能支付成功了。</p>\n","excerpt":"<p>本文主要讲述一下android接入微信支付SDK的步骤以及需要注意的一些Tips。</p>\n<h2 id=\"前期准备\"><a href=\"#前期准备\" class=\"headerlink\" title=\"前期准备\"></a>前期准备</h2><p>接入微信支付SDK前期需要许多前期准备。</p>\n<h3 id=\"微信开放平台\"><a href=\"#微信开放平台\" class=\"headerlink\" title=\"微信开放平台\"></a>微信开放平台</h3><ol>\n<li>注册<a href=\"https://open.weixin.qq.com/\">微信开放平台</a>账号。</li>\n<li>登录账号，进入管理中心，创建你的App应用，创建应用的包名与签名要与你实际的应用一致。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk1.png\" alt=\"\"><br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk5.png\" alt=\"\"></li>\n<li>进入应用详情，获取<code>AppID</code>，以及申请开通微信支付能力。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk2.png\" alt=\"\"></li>\n<li>等待审核通过。</li>\n</ol>","more":"<h3 id=\"微信商户平台\"><a href=\"#微信商户平台\" class=\"headerlink\" title=\"微信商户平台\"></a>微信商户平台</h3><ol>\n<li>注册<a href=\"https://pay.weixin.qq.com\">微信商户平台</a>账号。</li>\n<li>登录账号，在基本信息中获得<code>微信支付商户号</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk3.png\" alt=\"\"></li>\n<li>安装操作证书，然后进入API安全设置<code>秘钥</code>，最好使用UUID自动生成的，记住这个<code>秘钥</code>。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk4.png\" alt=\"\"><br>OK，前期准备做完，下面进行代码接入。</li>\n</ol>\n<h2 id=\"工程接入SDK\"><a href=\"#工程接入SDK\" class=\"headerlink\" title=\"工程接入SDK\"></a>工程接入SDK</h2><h3 id=\"新建应用工程\"><a href=\"#新建应用工程\" class=\"headerlink\" title=\"新建应用工程\"></a>新建应用工程</h3><p>以AS为例，新建工程，注意包名与使用的签名要与微信开放平台申请应用时填写的一致。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk8.png\" alt=\"\"></p>\n<h3 id=\"引入libs\"><a href=\"#引入libs\" class=\"headerlink\" title=\"引入libs\"></a>引入libs</h3><p>将<code>libammsdk.jar</code>放到libs文件夹下。</p>\n<h3 id=\"配置debug、release的签名文件\"><a href=\"#配置debug、release的签名文件\" class=\"headerlink\" title=\"配置debug、release的签名文件\"></a>配置debug、release的签名文件</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">signingConfigs</span> &#123;</div><div class=\"line\">        <span class=\"section\">debug</span> &#123;</div><div class=\"line\">            <span class=\"attribute\">storeFile</span> file(<span class=\"string\">\"你的keystore路径\"</span>)</div><div class=\"line\">            storePassword <span class=\"string\">\"xxx\"</span></div><div class=\"line\">            keyAlias <span class=\"string\">\"xxx\"</span></div><div class=\"line\">            keyPassword <span class=\"string\">\"xxx\"</span></div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        release &#123;</div><div class=\"line\">            <span class=\"attribute\">storeFile</span> file(<span class=\"string\">\"你的keystore路径\"</span>)</div><div class=\"line\">            storePassword <span class=\"string\">\"xxx\"</span></div><div class=\"line\">            keyAlias <span class=\"string\">\"xxx\"</span></div><div class=\"line\">            keyPassword <span class=\"string\">\"xxx\"</span></div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure>\n<p>这里debug、realse我采用的是一样的签名。不论是debug，还是release都能对应上。</p>\n<h3 id=\"AndroidManifest-xml中配置\"><a href=\"#AndroidManifest-xml中配置\" class=\"headerlink\" title=\"AndroidManifest.xml中配置\"></a>AndroidManifest.xml中配置</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">activity</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\".MainActivity\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.action.MAIN\"</span> /&gt;</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.LAUNCHER\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.action.VIEW\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.DEFAULT\"</span> /&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">data</span> <span class=\"attr\">android:scheme</span>=<span class=\"string\">\"你的AppID\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>也别忘记加入网络权限。</p>\n<h3 id=\"获取prepay-id\"><a href=\"#获取prepay-id\" class=\"headerlink\" title=\"获取prepay_id\"></a>获取prepay_id</h3><p>在支付之前，都需要调用微信的接口<code>https://api.mch.weixin.qq.com/pay/unifiedorder</code>来获得prepay_id。</p>\n<h3 id=\"支付\"><a href=\"#支付\" class=\"headerlink\" title=\"支付\"></a>支付</h3><p>获取到prepay_id之后，调用<code>IWXAPI</code>的<code>sendReq</code>方法即可完成支付。</p>\n<h3 id=\"添加支付成功回调Activity\"><a href=\"#添加支付成功回调Activity\" class=\"headerlink\" title=\"添加支付成功回调Activity\"></a>添加支付成功回调Activity</h3><p>添加<code>wxapi</code>的包名，在这个包名下必须要有<code>WXPayEntryActivity</code>这个Activity，支付成功后会显示此界面。<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk6.png\" alt=\"\"></p>\n<p>调用接口相关参数以及返回值参考<a href=\"https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_1\">开发者手册</a>。</p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><p>下面说一下接入过程中需要注意的点。</p>\n<ol>\n<li>官网下的demo，第一次支付时，能成功。之后就会一直支付失败。原因是：支付的时候商户唯一订单ID是唯一的，测试的时候请不断的更换订单ID参数支付。若要继续使用demo支付，可以微信清除数据、或者退出登录重新登录。</li>\n<li>微信支付返回-1，一般是<code>签名</code>错误。这个签名有2种意思：1、Apk签名文件，debug与release最好使用同样的keystore；2、参数MD5签名生成的sign。要仔细检查是否正确。</li>\n<li>签名、包名必须跟微信开放平台申请的一致.</li>\n<li>获取prepay_id最好是在服务器完成，由服务器去跟微信服务器交互，客户端不需要参与，以免泄露重要信息。</li>\n<li>与微信接口交互时，参数都需要签名。签名方法如下图：<br><img src=\"http://7xryow.com1.z0.glb.clouddn.com/2016/03/wechat-sdk7.png\" alt=\"\"><br>这里重点说一下。<ul>\n<li>参数名ASCII码从小到大排序（字典序）</li>\n<li>参数名区分大小写，包括sign。</li>\n<li>需要添加商户key值，这个key即是在前期准备中，我所说的微信商户的那个<code>秘钥</code>。</li>\n</ul>\n</li>\n</ol>\n<p>若接入过程中注意到这些Tips，一步一步来，那么应该是能支付成功了。</p>"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"ciw3e757l00001cb8qntg5ypa","tag_id":"ciw3e757t00041cb8hno6d6mp","_id":"ciw3e7585000a1cb8igfpswyz"},{"post_id":"ciw3e7585000b1cb8yxnzrrd3","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e7588000e1cb8e9twckpy"},{"post_id":"ciw3e757q00021cb8b458v6xj","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e7589000g1cb8qxu1cptj"},{"post_id":"ciw3e757w00051cb86ygeg01w","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e758d000k1cb80ewwp9jd"},{"post_id":"ciw3e7589000h1cb8eynapeu2","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e758f000m1cb87a7euejx"},{"post_id":"ciw3e758c000j1cb8hi12ylbw","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e758j000p1cb89znzsfyp"},{"post_id":"ciw3e758100071cb8bzwrkr44","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e758k000r1cb8sz16h23t"},{"post_id":"ciw3e758g000o1cb8kd69xhyg","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e758n000u1cb8kb9oh2vi"},{"post_id":"ciw3e758300081cb8z0w0jw7u","tag_id":"ciw3e758f000n1cb8g6ae0si1","_id":"ciw3e758o000w1cb84u7hni3u"},{"post_id":"ciw3e758j000q1cb8b0k448qj","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e758q000z1cb82ey4iik4"},{"post_id":"ciw3e7586000c1cb8931q2vot","tag_id":"ciw3e758l000s1cb8o7qwsiz3","_id":"ciw3e758r00111cb8de8s46xc"},{"post_id":"ciw3e758n000v1cb826w7kgai","tag_id":"ciw3e758l000s1cb8o7qwsiz3","_id":"ciw3e758s00141cb8jlexwy64"},{"post_id":"ciw3e7588000f1cb8c77wf6kg","tag_id":"ciw3e758f000n1cb8g6ae0si1","_id":"ciw3e758v00161cb8c4x9lv8t"},{"post_id":"ciw3e758r00131cb8v7mwx6ol","tag_id":"ciw3e758l000s1cb8o7qwsiz3","_id":"ciw3e759000191cb8iqp6l976"},{"post_id":"ciw3e758s00151cb85lqdpjvl","tag_id":"ciw3e758l000s1cb8o7qwsiz3","_id":"ciw3e7592001b1cb8qccxl778"},{"post_id":"ciw3e758e000l1cb8etqgaq2y","tag_id":"ciw3e758r00121cb8sciwe3ea","_id":"ciw3e7593001d1cb8oelu8jvd"},{"post_id":"ciw3e758y00171cb86mtqgtx9","tag_id":"ciw3e758l000s1cb8o7qwsiz3","_id":"ciw3e7594001g1cb82ib79q8g"},{"post_id":"ciw3e758m000t1cb88d3cuwrd","tag_id":"ciw3e759000181cb8lqoro26n","_id":"ciw3e7596001i1cb8v77c7joe"},{"post_id":"ciw3e758p000y1cb8u29kdodb","tag_id":"ciw3e7593001e1cb86wogncnd","_id":"ciw3e7599001l1cb81ukda78b"},{"post_id":"ciw3e7595001h1cb8bmjgmmrj","tag_id":"ciw3e758f000n1cb8g6ae0si1","_id":"ciw3e759a001n1cb8gtmnfdfb"},{"post_id":"ciw3e7597001k1cb8i3fyvsro","tag_id":"ciw3e7593001e1cb86wogncnd","_id":"ciw3e759f001q1cb8lmdmog4t"},{"post_id":"ciw3e758q00101cb82s3fi4fa","tag_id":"ciw3e7593001e1cb86wogncnd","_id":"ciw3e759g001s1cb8bvx12kmw"},{"post_id":"ciw3e7599001m1cb8x19r02j4","tag_id":"ciw3e758r00121cb8sciwe3ea","_id":"ciw3e759j001v1cb8lujm7tnw"},{"post_id":"ciw3e759a001p1cb8avc9f05c","tag_id":"ciw3e758r00121cb8sciwe3ea","_id":"ciw3e759k001x1cb8tizugklw"},{"post_id":"ciw3e7591001a1cb8hanwgp1o","tag_id":"ciw3e759a001o1cb88ykpj832","_id":"ciw3e759m00201cb8aqaj4gtd"},{"post_id":"ciw3e759f001r1cb8h5haeohv","tag_id":"ciw3e759000181cb8lqoro26n","_id":"ciw3e759o00221cb8z7wcxr5s"},{"post_id":"ciw3e759h001u1cb8nci53xai","tag_id":"ciw3e758r00121cb8sciwe3ea","_id":"ciw3e759q00241cb8ou5jfjng"},{"post_id":"ciw3e759j001w1cb8n67hjv1g","tag_id":"ciw3e758r00121cb8sciwe3ea","_id":"ciw3e759r00271cb8ycnlf3ib"},{"post_id":"ciw3e7592001c1cb8r2d1efg6","tag_id":"ciw3e759g001t1cb8qfawh1br","_id":"ciw3e759u00291cb8kqu4100l"},{"post_id":"ciw3e759l001y1cb8768il9v8","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e759w002b1cb8shxrsqml"},{"post_id":"ciw3e7594001f1cb8ygthbve4","tag_id":"ciw3e759a001o1cb88ykpj832","_id":"ciw3e759x002d1cb85lkh8bar"},{"post_id":"ciw3e759p00231cb8lf7c8an9","tag_id":"ciw3e759000181cb8lqoro26n","_id":"ciw3e759z002f1cb8y02h8g0f"},{"post_id":"ciw3e759q00261cb810vu5jri","tag_id":"ciw3e7593001e1cb86wogncnd","_id":"ciw3e75a0002h1cb8t30t4bxb"},{"post_id":"ciw3e759q00261cb810vu5jri","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75a1002j1cb84tzopnjq"},{"post_id":"ciw3e759s00281cb8jshjzrhi","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75a2002l1cb8dtqgiw8e"},{"post_id":"ciw3e759n00211cb8bp9jjyl9","tag_id":"ciw3e759q00251cb8yzae882j","_id":"ciw3e75a4002n1cb8i8d26yju"},{"post_id":"ciw3e759v002a1cb857ju7gw3","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75a6002q1cb8mw2zumht"},{"post_id":"ciw3e759w002c1cb8qgh1wky3","tag_id":"ciw3e759000181cb8lqoro26n","_id":"ciw3e75a7002s1cb8zm1euly8"},{"post_id":"ciw3e759x002e1cb8nbl6dxkl","tag_id":"ciw3e759a001o1cb88ykpj832","_id":"ciw3e75a9002u1cb8a11y10sw"},{"post_id":"ciw3e759z002g1cb8m8fddsqw","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75aa002w1cb8wx0t4p47"},{"post_id":"ciw3e75a0002i1cb88ikjvpjx","tag_id":"ciw3e759a001o1cb88ykpj832","_id":"ciw3e75ab002y1cb8m4lccnyf"},{"post_id":"ciw3e75a2002m1cb89pcwccm3","tag_id":"ciw3e759000181cb8lqoro26n","_id":"ciw3e75ac00301cb8wvfv4bxj"},{"post_id":"ciw3e75a5002p1cb8kzxvsjhz","tag_id":"ciw3e759000181cb8lqoro26n","_id":"ciw3e75ad00321cb8aumoh1mu"},{"post_id":"ciw3e75a6002r1cb8w1jtar04","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75af00341cb8d0xkqbe3"},{"post_id":"ciw3e75a6002r1cb8w1jtar04","tag_id":"ciw3e75a5002o1cb8l08yrgoq","_id":"ciw3e75ah00361cb8p7h7whrb"},{"post_id":"ciw3e75a1002k1cb8873oh5jv","tag_id":"ciw3e75a5002o1cb8l08yrgoq","_id":"ciw3e75ai00381cb8gqv3y0ih"},{"post_id":"ciw3e75a8002t1cb8k4oeuwno","tag_id":"ciw3e758f000n1cb8g6ae0si1","_id":"ciw3e75aj003b1cb8jynask8p"},{"post_id":"ciw3e75a9002v1cb82ffhamz0","tag_id":"ciw3e758r00121cb8sciwe3ea","_id":"ciw3e75ak003d1cb8ajzscwpo"},{"post_id":"ciw3e75a9002v1cb82ffhamz0","tag_id":"ciw3e75a5002o1cb8l08yrgoq","_id":"ciw3e75am003g1cb8leu4tf1c"},{"post_id":"ciw3e75aa002x1cb8rnkwh2gp","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75am003h1cb8g5wjifql"},{"post_id":"ciw3e75ac002z1cb88qpsait2","tag_id":"ciw3e759000181cb8lqoro26n","_id":"ciw3e75an003i1cb8u9kp7e2t"},{"post_id":"ciw3e75ad00311cb8jgnqe3s6","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75an003j1cb8wzygtme9"},{"post_id":"ciw3e75ae00331cb8xj22npli","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75an003k1cb8vpdcti3b"},{"post_id":"ciw3e75ai003a1cb8in8qacyg","tag_id":"ciw3e75a5002o1cb8l08yrgoq","_id":"ciw3e75an003l1cb8w8kv8bs1"},{"post_id":"ciw3e75aj003c1cb82yql0otw","tag_id":"ciw3e758400091cb854uhnsnb","_id":"ciw3e75an003m1cb8q974i8a4"},{"post_id":"ciw3e75ag00351cb82vwadvc7","tag_id":"ciw3e75ai00391cb8l0ja3gwf","_id":"ciw3e75ao003n1cb8761z4lc8"},{"post_id":"ciw3e75ak003e1cb813vgqd8l","tag_id":"ciw3e758f000n1cb8g6ae0si1","_id":"ciw3e75ap003o1cb80vgngwgf"},{"post_id":"ciw3e75ah00371cb8uoky4izi","tag_id":"ciw3e75ai00391cb8l0ja3gwf","_id":"ciw3e75ap003p1cb8rw24lbep"}],"Tag":[{"name":"iOS","_id":"ciw3e757t00041cb8hno6d6mp"},{"name":"日常开发","_id":"ciw3e758400091cb854uhnsnb"},{"name":"sdk","_id":"ciw3e758f000n1cb8g6ae0si1"},{"name":"blog","_id":"ciw3e758l000s1cb8o7qwsiz3"},{"name":"直播","_id":"ciw3e758r00121cb8sciwe3ea"},{"name":"自定义View","_id":"ciw3e759000181cb8lqoro26n"},{"name":"android studio","_id":"ciw3e7593001e1cb86wogncnd"},{"name":"hybrid开发","_id":"ciw3e759a001o1cb88ykpj832"},{"name":"杂谈","_id":"ciw3e759g001t1cb8qfawh1br"},{"name":"设计模式","_id":"ciw3e759q00251cb8yzae882j"},{"name":"java","_id":"ciw3e75a5002o1cb8l08yrgoq"},{"name":"事件分发","_id":"ciw3e75ai00391cb8l0ja3gwf"}]}}